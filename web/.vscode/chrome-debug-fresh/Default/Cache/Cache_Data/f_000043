export class PanelManagementService {
  panels = /* @__PURE__ */ new Map();
  configurations = /* @__PURE__ */ new Map();
  currentResize = null;
  stateChangeCallbacks = [];
  constructor() {
    this.loadPanelStates();
  }
  // Panel registration
  registerPanel(config) {
    this.configurations.set(config.id, config);
    if (!this.panels.has(config.id)) {
      const savedWidth = this.loadPanelWidth(
        config.persistKey,
        config.defaultWidth
      );
      const initialState = {
        id: config.id,
        width: savedWidth,
        isCollapsed: false,
        isVisible: true,
        minWidth: config.minWidth,
        maxWidth: config.maxWidth,
        defaultWidth: config.defaultWidth,
        collapsedWidth: config.collapsedWidth,
        isResizing: false
      };
      this.panels.set(config.id, initialState);
    }
  }
  unregisterPanel(panelId) {
    this.panels.delete(panelId);
    this.configurations.delete(panelId);
  }
  // Panel state management
  getPanelState(panelId) {
    const state = this.panels.get(panelId);
    if (!state) {
      console.warn(`Panel not registered: ${panelId}, returning default state`);
      return {
        id: panelId,
        width: 300,
        isCollapsed: false,
        isVisible: true,
        minWidth: 200,
        maxWidth: 600,
        defaultWidth: 300,
        collapsedWidth: 60,
        isResizing: false
      };
    }
    return { ...state };
  }
  togglePanelCollapse(panelId) {
    const state = this.panels.get(panelId);
    if (!state) return;
    this.setPanelCollapsed(panelId, !state.isCollapsed);
  }
  setPanelCollapsed(panelId, isCollapsed) {
    const state = this.panels.get(panelId);
    if (!state) return;
    const updatedState = {
      ...state,
      isCollapsed
      // Don't change width when collapsing - layout handles this with CSS
    };
    this.panels.set(panelId, updatedState);
    this.notifyStateChange(panelId, updatedState);
    this.savePanelStates();
  }
  setPanelVisible(panelId, isVisible) {
    const state = this.panels.get(panelId);
    if (!state) return;
    const updatedState = {
      ...state,
      isVisible
    };
    this.panels.set(panelId, updatedState);
    this.notifyStateChange(panelId, updatedState);
  }
  setPanelWidth(panelId, width) {
    const state = this.panels.get(panelId);
    if (!state) return;
    const validatedWidth = this.validateWidth(panelId, width);
    const updatedState = {
      ...state,
      width: validatedWidth
    };
    this.panels.set(panelId, updatedState);
    this.notifyStateChange(panelId, updatedState);
    this.savePanelStates();
  }
  // Resize operations
  startResize(panelId, startX) {
    const state = this.panels.get(panelId);
    if (!state || !this.canResize(panelId)) {
      return null;
    }
    const operation = {
      panelId,
      startWidth: state.width,
      startX,
      currentX: startX
    };
    this.currentResize = operation;
    const updatedState = { ...state, isResizing: true };
    this.panels.set(panelId, updatedState);
    this.notifyStateChange(panelId, updatedState);
    return operation;
  }
  updateResize(operation, currentX) {
    const state = this.panels.get(operation.panelId);
    if (!state) {
      throw new Error(`Panel not found during resize: ${operation.panelId}`);
    }
    operation.currentX = currentX;
    const deltaX = currentX - operation.startX;
    const newWidth = operation.startWidth + deltaX;
    const validatedWidth = this.validateWidth(operation.panelId, newWidth);
    const updatedState = {
      ...state,
      width: validatedWidth
    };
    this.panels.set(operation.panelId, updatedState);
    this.notifyStateChange(operation.panelId, updatedState);
    return updatedState;
  }
  endResize(operation) {
    const state = this.panels.get(operation.panelId);
    if (!state) return;
    const updatedState = { ...state, isResizing: false };
    this.panels.set(operation.panelId, updatedState);
    this.notifyStateChange(operation.panelId, updatedState);
    this.currentResize = null;
    this.savePanelStates();
  }
  // Validation
  validateWidth(panelId, width) {
    const state = this.panels.get(panelId);
    if (!state) return width;
    return Math.max(state.minWidth, Math.min(state.maxWidth, width));
  }
  canResize(panelId) {
    const state = this.panels.get(panelId);
    return !!(state && state.isVisible && !state.isCollapsed);
  }
  // Persistence
  savePanelStates() {
    try {
      const states = {};
      for (const [panelId, state] of this.panels) {
        const config = this.configurations.get(panelId);
        if (config) {
          states[config.persistKey] = {
            width: state.width,
            isCollapsed: state.isCollapsed
          };
        }
      }
      localStorage.setItem("tka-panel-states", JSON.stringify(states));
    } catch (error) {
      console.warn("Failed to save panel states:", error);
    }
  }
  loadPanelStates() {
    try {
      const saved = localStorage.getItem("tka-panel-states");
      if (!saved) return;
      const states = JSON.parse(saved);
      this.savedStates = states;
    } catch (error) {
      console.warn("Failed to load panel states:", error);
    }
  }
  savedStates = {};
  loadPanelWidth(persistKey, defaultWidth) {
    const saved = this.savedStates[persistKey];
    return saved?.width ?? defaultWidth;
  }
  loadPanelCollapsed(persistKey) {
    const saved = this.savedStates[persistKey];
    return saved?.isCollapsed ?? false;
  }
  // Event handling
  onPanelStateChanged(callback) {
    this.stateChangeCallbacks.push(callback);
  }
  offPanelStateChanged(callback) {
    const index = this.stateChangeCallbacks.indexOf(callback);
    if (index > -1) {
      this.stateChangeCallbacks.splice(index, 1);
    }
  }
  notifyStateChange(panelId, state) {
    this.stateChangeCallbacks.forEach((callback) => {
      try {
        callback(panelId, { ...state });
      } catch (error) {
        console.error("Error in panel state change callback:", error);
      }
    });
  }
  // Utility methods
  getAllPanelStates() {
    const states = {};
    for (const [panelId, state] of this.panels) {
      states[panelId] = { ...state };
    }
    return states;
  }
  resetPanel(panelId) {
    const config = this.configurations.get(panelId);
    if (!config) return;
    const resetState = {
      id: panelId,
      width: config.defaultWidth,
      isCollapsed: false,
      isVisible: true,
      minWidth: config.minWidth,
      maxWidth: config.maxWidth,
      defaultWidth: config.defaultWidth,
      collapsedWidth: config.collapsedWidth,
      isResizing: false
    };
    this.panels.set(panelId, resetState);
    this.notifyStateChange(panelId, resetState);
    this.savePanelStates();
  }
  resetAllPanels() {
    for (const panelId of this.panels.keys()) {
      this.resetPanel(panelId);
    }
  }
}
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiQzovVEtBL3dlYi9zcmMvbGliL3NlcnZpY2VzL2ltcGxlbWVudGF0aW9ucy9uYXZpZ2F0aW9uL1BhbmVsTWFuYWdlbWVudFNlcnZpY2UudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbIi8qKlxuICogUGFuZWwgTWFuYWdlbWVudCBTZXJ2aWNlIEltcGxlbWVudGF0aW9uXG4gKlxuICogUHJvdmlkZXMgdW5pZmllZCBwYW5lbCBzdGF0ZSBtYW5hZ2VtZW50IHdpdGggY29sbGFwc2UvZXhwYW5kLCByZXNpemluZywgYW5kIHBlcnNpc3RlbmNlLlxuICogRm9sbG93cyBtaWNyb3NlcnZpY2VzIGFyY2hpdGVjdHVyZSB3aXRoIGNsZWFuIGJ1c2luZXNzIGxvZ2ljIHNlcGFyYXRpb24uXG4gKi9cblxuaW1wb3J0IHR5cGUge1xuICBJUGFuZWxNYW5hZ2VtZW50U2VydmljZSxcbiAgUGFuZWxTdGF0ZSxcbiAgUGFuZWxDb25maWd1cmF0aW9uLFxuICBSZXNpemVPcGVyYXRpb24sXG59IGZyb20gXCIuLi8uLi9kaS9pbnRlcmZhY2VzL3BhbmVsLWludGVyZmFjZXNcIjtcblxuZXhwb3J0IGNsYXNzIFBhbmVsTWFuYWdlbWVudFNlcnZpY2UgaW1wbGVtZW50cyBJUGFuZWxNYW5hZ2VtZW50U2VydmljZSB7XG4gIHByaXZhdGUgcGFuZWxzID0gbmV3IE1hcDxzdHJpbmcsIFBhbmVsU3RhdGU+KCk7XG4gIHByaXZhdGUgY29uZmlndXJhdGlvbnMgPSBuZXcgTWFwPHN0cmluZywgUGFuZWxDb25maWd1cmF0aW9uPigpO1xuICBwcml2YXRlIGN1cnJlbnRSZXNpemU6IFJlc2l6ZU9wZXJhdGlvbiB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHN0YXRlQ2hhbmdlQ2FsbGJhY2tzOiBBcnJheTxcbiAgICAocGFuZWxJZDogc3RyaW5nLCBzdGF0ZTogUGFuZWxTdGF0ZSkgPT4gdm9pZFxuICA+ID0gW107XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5sb2FkUGFuZWxTdGF0ZXMoKTtcbiAgfVxuXG4gIC8vIFBhbmVsIHJlZ2lzdHJhdGlvblxuICByZWdpc3RlclBhbmVsKGNvbmZpZzogUGFuZWxDb25maWd1cmF0aW9uKTogdm9pZCB7XG4gICAgdGhpcy5jb25maWd1cmF0aW9ucy5zZXQoY29uZmlnLmlkLCBjb25maWcpO1xuXG4gICAgLy8gQ3JlYXRlIGluaXRpYWwgc3RhdGUgaWYgbm90IGV4aXN0c1xuICAgIGlmICghdGhpcy5wYW5lbHMuaGFzKGNvbmZpZy5pZCkpIHtcbiAgICAgIGNvbnN0IHNhdmVkV2lkdGggPSB0aGlzLmxvYWRQYW5lbFdpZHRoKFxuICAgICAgICBjb25maWcucGVyc2lzdEtleSxcbiAgICAgICAgY29uZmlnLmRlZmF1bHRXaWR0aFxuICAgICAgKTtcbiAgICAgIGNvbnN0IGluaXRpYWxTdGF0ZTogUGFuZWxTdGF0ZSA9IHtcbiAgICAgICAgaWQ6IGNvbmZpZy5pZCxcbiAgICAgICAgd2lkdGg6IHNhdmVkV2lkdGgsXG4gICAgICAgIGlzQ29sbGFwc2VkOiBmYWxzZSxcbiAgICAgICAgaXNWaXNpYmxlOiB0cnVlLFxuICAgICAgICBtaW5XaWR0aDogY29uZmlnLm1pbldpZHRoLFxuICAgICAgICBtYXhXaWR0aDogY29uZmlnLm1heFdpZHRoLFxuICAgICAgICBkZWZhdWx0V2lkdGg6IGNvbmZpZy5kZWZhdWx0V2lkdGgsXG4gICAgICAgIGNvbGxhcHNlZFdpZHRoOiBjb25maWcuY29sbGFwc2VkV2lkdGgsXG4gICAgICAgIGlzUmVzaXppbmc6IGZhbHNlLFxuICAgICAgfTtcblxuICAgICAgdGhpcy5wYW5lbHMuc2V0KGNvbmZpZy5pZCwgaW5pdGlhbFN0YXRlKTtcbiAgICB9XG4gIH1cblxuICB1bnJlZ2lzdGVyUGFuZWwocGFuZWxJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5wYW5lbHMuZGVsZXRlKHBhbmVsSWQpO1xuICAgIHRoaXMuY29uZmlndXJhdGlvbnMuZGVsZXRlKHBhbmVsSWQpO1xuICB9XG5cbiAgLy8gUGFuZWwgc3RhdGUgbWFuYWdlbWVudFxuICBnZXRQYW5lbFN0YXRlKHBhbmVsSWQ6IHN0cmluZyk6IFBhbmVsU3RhdGUge1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5wYW5lbHMuZ2V0KHBhbmVsSWQpO1xuICAgIGlmICghc3RhdGUpIHtcbiAgICAgIC8vIFJldHVybiBhIGRlZmF1bHQgc3RhdGUgZm9yIHVucmVnaXN0ZXJlZCBwYW5lbHMgaW5zdGVhZCBvZiB0aHJvd2luZ1xuICAgICAgY29uc29sZS53YXJuKGBQYW5lbCBub3QgcmVnaXN0ZXJlZDogJHtwYW5lbElkfSwgcmV0dXJuaW5nIGRlZmF1bHQgc3RhdGVgKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkOiBwYW5lbElkLFxuICAgICAgICB3aWR0aDogMzAwLFxuICAgICAgICBpc0NvbGxhcHNlZDogZmFsc2UsXG4gICAgICAgIGlzVmlzaWJsZTogdHJ1ZSxcbiAgICAgICAgbWluV2lkdGg6IDIwMCxcbiAgICAgICAgbWF4V2lkdGg6IDYwMCxcbiAgICAgICAgZGVmYXVsdFdpZHRoOiAzMDAsXG4gICAgICAgIGNvbGxhcHNlZFdpZHRoOiA2MCxcbiAgICAgICAgaXNSZXNpemluZzogZmFsc2UsXG4gICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4geyAuLi5zdGF0ZSB9OyAvLyBSZXR1cm4gY29weSB0byBwcmV2ZW50IGRpcmVjdCBtdXRhdGlvblxuICB9XG5cbiAgdG9nZ2xlUGFuZWxDb2xsYXBzZShwYW5lbElkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMucGFuZWxzLmdldChwYW5lbElkKTtcbiAgICBpZiAoIXN0YXRlKSByZXR1cm47XG5cbiAgICB0aGlzLnNldFBhbmVsQ29sbGFwc2VkKHBhbmVsSWQsICFzdGF0ZS5pc0NvbGxhcHNlZCk7XG4gIH1cblxuICBzZXRQYW5lbENvbGxhcHNlZChwYW5lbElkOiBzdHJpbmcsIGlzQ29sbGFwc2VkOiBib29sZWFuKTogdm9pZCB7XG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLnBhbmVscy5nZXQocGFuZWxJZCk7XG4gICAgaWYgKCFzdGF0ZSkgcmV0dXJuO1xuXG4gICAgY29uc3QgdXBkYXRlZFN0YXRlID0ge1xuICAgICAgLi4uc3RhdGUsXG4gICAgICBpc0NvbGxhcHNlZCxcbiAgICAgIC8vIERvbid0IGNoYW5nZSB3aWR0aCB3aGVuIGNvbGxhcHNpbmcgLSBsYXlvdXQgaGFuZGxlcyB0aGlzIHdpdGggQ1NTXG4gICAgfTtcblxuICAgIHRoaXMucGFuZWxzLnNldChwYW5lbElkLCB1cGRhdGVkU3RhdGUpO1xuICAgIHRoaXMubm90aWZ5U3RhdGVDaGFuZ2UocGFuZWxJZCwgdXBkYXRlZFN0YXRlKTtcbiAgICB0aGlzLnNhdmVQYW5lbFN0YXRlcygpO1xuICB9XG5cbiAgc2V0UGFuZWxWaXNpYmxlKHBhbmVsSWQ6IHN0cmluZywgaXNWaXNpYmxlOiBib29sZWFuKTogdm9pZCB7XG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLnBhbmVscy5nZXQocGFuZWxJZCk7XG4gICAgaWYgKCFzdGF0ZSkgcmV0dXJuO1xuXG4gICAgY29uc3QgdXBkYXRlZFN0YXRlID0ge1xuICAgICAgLi4uc3RhdGUsXG4gICAgICBpc1Zpc2libGUsXG4gICAgfTtcblxuICAgIHRoaXMucGFuZWxzLnNldChwYW5lbElkLCB1cGRhdGVkU3RhdGUpO1xuICAgIHRoaXMubm90aWZ5U3RhdGVDaGFuZ2UocGFuZWxJZCwgdXBkYXRlZFN0YXRlKTtcbiAgfVxuXG4gIHNldFBhbmVsV2lkdGgocGFuZWxJZDogc3RyaW5nLCB3aWR0aDogbnVtYmVyKTogdm9pZCB7XG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLnBhbmVscy5nZXQocGFuZWxJZCk7XG4gICAgaWYgKCFzdGF0ZSkgcmV0dXJuO1xuXG4gICAgY29uc3QgdmFsaWRhdGVkV2lkdGggPSB0aGlzLnZhbGlkYXRlV2lkdGgocGFuZWxJZCwgd2lkdGgpO1xuICAgIGNvbnN0IHVwZGF0ZWRTdGF0ZSA9IHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgd2lkdGg6IHZhbGlkYXRlZFdpZHRoLFxuICAgIH07XG5cbiAgICB0aGlzLnBhbmVscy5zZXQocGFuZWxJZCwgdXBkYXRlZFN0YXRlKTtcbiAgICB0aGlzLm5vdGlmeVN0YXRlQ2hhbmdlKHBhbmVsSWQsIHVwZGF0ZWRTdGF0ZSk7XG4gICAgdGhpcy5zYXZlUGFuZWxTdGF0ZXMoKTtcbiAgfVxuXG4gIC8vIFJlc2l6ZSBvcGVyYXRpb25zXG4gIHN0YXJ0UmVzaXplKHBhbmVsSWQ6IHN0cmluZywgc3RhcnRYOiBudW1iZXIpOiBSZXNpemVPcGVyYXRpb24gfCBudWxsIHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMucGFuZWxzLmdldChwYW5lbElkKTtcbiAgICBpZiAoIXN0YXRlIHx8ICF0aGlzLmNhblJlc2l6ZShwYW5lbElkKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3Qgb3BlcmF0aW9uOiBSZXNpemVPcGVyYXRpb24gPSB7XG4gICAgICBwYW5lbElkLFxuICAgICAgc3RhcnRXaWR0aDogc3RhdGUud2lkdGgsXG4gICAgICBzdGFydFgsXG4gICAgICBjdXJyZW50WDogc3RhcnRYLFxuICAgIH07XG5cbiAgICB0aGlzLmN1cnJlbnRSZXNpemUgPSBvcGVyYXRpb247XG5cbiAgICAvLyBNYXJrIHBhbmVsIGFzIHJlc2l6aW5nXG4gICAgY29uc3QgdXBkYXRlZFN0YXRlID0geyAuLi5zdGF0ZSwgaXNSZXNpemluZzogdHJ1ZSB9O1xuICAgIHRoaXMucGFuZWxzLnNldChwYW5lbElkLCB1cGRhdGVkU3RhdGUpO1xuICAgIHRoaXMubm90aWZ5U3RhdGVDaGFuZ2UocGFuZWxJZCwgdXBkYXRlZFN0YXRlKTtcblxuICAgIHJldHVybiBvcGVyYXRpb247XG4gIH1cblxuICB1cGRhdGVSZXNpemUob3BlcmF0aW9uOiBSZXNpemVPcGVyYXRpb24sIGN1cnJlbnRYOiBudW1iZXIpOiBQYW5lbFN0YXRlIHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMucGFuZWxzLmdldChvcGVyYXRpb24ucGFuZWxJZCk7XG4gICAgaWYgKCFzdGF0ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBQYW5lbCBub3QgZm91bmQgZHVyaW5nIHJlc2l6ZTogJHtvcGVyYXRpb24ucGFuZWxJZH1gKTtcbiAgICB9XG5cbiAgICBvcGVyYXRpb24uY3VycmVudFggPSBjdXJyZW50WDtcbiAgICBjb25zdCBkZWx0YVggPSBjdXJyZW50WCAtIG9wZXJhdGlvbi5zdGFydFg7XG4gICAgY29uc3QgbmV3V2lkdGggPSBvcGVyYXRpb24uc3RhcnRXaWR0aCArIGRlbHRhWDtcbiAgICBjb25zdCB2YWxpZGF0ZWRXaWR0aCA9IHRoaXMudmFsaWRhdGVXaWR0aChvcGVyYXRpb24ucGFuZWxJZCwgbmV3V2lkdGgpO1xuXG4gICAgY29uc3QgdXBkYXRlZFN0YXRlID0ge1xuICAgICAgLi4uc3RhdGUsXG4gICAgICB3aWR0aDogdmFsaWRhdGVkV2lkdGgsXG4gICAgfTtcblxuICAgIHRoaXMucGFuZWxzLnNldChvcGVyYXRpb24ucGFuZWxJZCwgdXBkYXRlZFN0YXRlKTtcbiAgICB0aGlzLm5vdGlmeVN0YXRlQ2hhbmdlKG9wZXJhdGlvbi5wYW5lbElkLCB1cGRhdGVkU3RhdGUpO1xuXG4gICAgcmV0dXJuIHVwZGF0ZWRTdGF0ZTtcbiAgfVxuXG4gIGVuZFJlc2l6ZShvcGVyYXRpb246IFJlc2l6ZU9wZXJhdGlvbik6IHZvaWQge1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5wYW5lbHMuZ2V0KG9wZXJhdGlvbi5wYW5lbElkKTtcbiAgICBpZiAoIXN0YXRlKSByZXR1cm47XG5cbiAgICBjb25zdCB1cGRhdGVkU3RhdGUgPSB7IC4uLnN0YXRlLCBpc1Jlc2l6aW5nOiBmYWxzZSB9O1xuICAgIHRoaXMucGFuZWxzLnNldChvcGVyYXRpb24ucGFuZWxJZCwgdXBkYXRlZFN0YXRlKTtcbiAgICB0aGlzLm5vdGlmeVN0YXRlQ2hhbmdlKG9wZXJhdGlvbi5wYW5lbElkLCB1cGRhdGVkU3RhdGUpO1xuXG4gICAgdGhpcy5jdXJyZW50UmVzaXplID0gbnVsbDtcbiAgICB0aGlzLnNhdmVQYW5lbFN0YXRlcygpO1xuICB9XG5cbiAgLy8gVmFsaWRhdGlvblxuICB2YWxpZGF0ZVdpZHRoKHBhbmVsSWQ6IHN0cmluZywgd2lkdGg6IG51bWJlcik6IG51bWJlciB7XG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLnBhbmVscy5nZXQocGFuZWxJZCk7XG4gICAgaWYgKCFzdGF0ZSkgcmV0dXJuIHdpZHRoO1xuXG4gICAgcmV0dXJuIE1hdGgubWF4KHN0YXRlLm1pbldpZHRoLCBNYXRoLm1pbihzdGF0ZS5tYXhXaWR0aCwgd2lkdGgpKTtcbiAgfVxuXG4gIGNhblJlc2l6ZShwYW5lbElkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMucGFuZWxzLmdldChwYW5lbElkKTtcbiAgICByZXR1cm4gISEoc3RhdGUgJiYgc3RhdGUuaXNWaXNpYmxlICYmICFzdGF0ZS5pc0NvbGxhcHNlZCk7XG4gIH1cblxuICAvLyBQZXJzaXN0ZW5jZVxuICBzYXZlUGFuZWxTdGF0ZXMoKTogdm9pZCB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHN0YXRlczogUmVjb3JkPHN0cmluZywgeyB3aWR0aDogbnVtYmVyOyBpc0NvbGxhcHNlZDogYm9vbGVhbiB9PiA9XG4gICAgICAgIHt9O1xuXG4gICAgICBmb3IgKGNvbnN0IFtwYW5lbElkLCBzdGF0ZV0gb2YgdGhpcy5wYW5lbHMpIHtcbiAgICAgICAgY29uc3QgY29uZmlnID0gdGhpcy5jb25maWd1cmF0aW9ucy5nZXQocGFuZWxJZCk7XG4gICAgICAgIGlmIChjb25maWcpIHtcbiAgICAgICAgICBzdGF0ZXNbY29uZmlnLnBlcnNpc3RLZXldID0ge1xuICAgICAgICAgICAgd2lkdGg6IHN0YXRlLndpZHRoLFxuICAgICAgICAgICAgaXNDb2xsYXBzZWQ6IHN0YXRlLmlzQ29sbGFwc2VkLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJ0a2EtcGFuZWwtc3RhdGVzXCIsIEpTT04uc3RyaW5naWZ5KHN0YXRlcykpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJGYWlsZWQgdG8gc2F2ZSBwYW5lbCBzdGF0ZXM6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBsb2FkUGFuZWxTdGF0ZXMoKTogdm9pZCB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNhdmVkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJ0a2EtcGFuZWwtc3RhdGVzXCIpO1xuICAgICAgaWYgKCFzYXZlZCkgcmV0dXJuO1xuXG4gICAgICBjb25zdCBzdGF0ZXMgPSBKU09OLnBhcnNlKHNhdmVkKTtcblxuICAgICAgLy8gV2lsbCBhcHBseSB0byBwYW5lbHMgd2hlbiB0aGV5IGFyZSByZWdpc3RlcmVkXG4gICAgICB0aGlzLnNhdmVkU3RhdGVzID0gc3RhdGVzO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJGYWlsZWQgdG8gbG9hZCBwYW5lbCBzdGF0ZXM6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNhdmVkU3RhdGVzOiBSZWNvcmQ8c3RyaW5nLCB7IHdpZHRoOiBudW1iZXI7IGlzQ29sbGFwc2VkOiBib29sZWFuIH0+ID1cbiAgICB7fTtcblxuICBwcml2YXRlIGxvYWRQYW5lbFdpZHRoKHBlcnNpc3RLZXk6IHN0cmluZywgZGVmYXVsdFdpZHRoOiBudW1iZXIpOiBudW1iZXIge1xuICAgIGNvbnN0IHNhdmVkID0gdGhpcy5zYXZlZFN0YXRlc1twZXJzaXN0S2V5XTtcbiAgICByZXR1cm4gc2F2ZWQ/LndpZHRoID8/IGRlZmF1bHRXaWR0aDtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZFBhbmVsQ29sbGFwc2VkKHBlcnNpc3RLZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHNhdmVkID0gdGhpcy5zYXZlZFN0YXRlc1twZXJzaXN0S2V5XTtcbiAgICByZXR1cm4gc2F2ZWQ/LmlzQ29sbGFwc2VkID8/IGZhbHNlO1xuICB9XG5cbiAgLy8gRXZlbnQgaGFuZGxpbmdcbiAgb25QYW5lbFN0YXRlQ2hhbmdlZChcbiAgICBjYWxsYmFjazogKHBhbmVsSWQ6IHN0cmluZywgc3RhdGU6IFBhbmVsU3RhdGUpID0+IHZvaWRcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5zdGF0ZUNoYW5nZUNhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKTtcbiAgfVxuXG4gIG9mZlBhbmVsU3RhdGVDaGFuZ2VkKFxuICAgIGNhbGxiYWNrOiAocGFuZWxJZDogc3RyaW5nLCBzdGF0ZTogUGFuZWxTdGF0ZSkgPT4gdm9pZFxuICApOiB2b2lkIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuc3RhdGVDaGFuZ2VDYWxsYmFja3MuaW5kZXhPZihjYWxsYmFjayk7XG4gICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgIHRoaXMuc3RhdGVDaGFuZ2VDYWxsYmFja3Muc3BsaWNlKGluZGV4LCAxKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG5vdGlmeVN0YXRlQ2hhbmdlKHBhbmVsSWQ6IHN0cmluZywgc3RhdGU6IFBhbmVsU3RhdGUpOiB2b2lkIHtcbiAgICB0aGlzLnN0YXRlQ2hhbmdlQ2FsbGJhY2tzLmZvckVhY2goKGNhbGxiYWNrKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjYWxsYmFjayhwYW5lbElkLCB7IC4uLnN0YXRlIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGluIHBhbmVsIHN0YXRlIGNoYW5nZSBjYWxsYmFjazpcIiwgZXJyb3IpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLy8gVXRpbGl0eSBtZXRob2RzXG4gIGdldEFsbFBhbmVsU3RhdGVzKCk6IFJlY29yZDxzdHJpbmcsIFBhbmVsU3RhdGU+IHtcbiAgICBjb25zdCBzdGF0ZXM6IFJlY29yZDxzdHJpbmcsIFBhbmVsU3RhdGU+ID0ge307XG4gICAgZm9yIChjb25zdCBbcGFuZWxJZCwgc3RhdGVdIG9mIHRoaXMucGFuZWxzKSB7XG4gICAgICBzdGF0ZXNbcGFuZWxJZF0gPSB7IC4uLnN0YXRlIH07XG4gICAgfVxuICAgIHJldHVybiBzdGF0ZXM7XG4gIH1cblxuICByZXNldFBhbmVsKHBhbmVsSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IGNvbmZpZyA9IHRoaXMuY29uZmlndXJhdGlvbnMuZ2V0KHBhbmVsSWQpO1xuICAgIGlmICghY29uZmlnKSByZXR1cm47XG5cbiAgICBjb25zdCByZXNldFN0YXRlOiBQYW5lbFN0YXRlID0ge1xuICAgICAgaWQ6IHBhbmVsSWQsXG4gICAgICB3aWR0aDogY29uZmlnLmRlZmF1bHRXaWR0aCxcbiAgICAgIGlzQ29sbGFwc2VkOiBmYWxzZSxcbiAgICAgIGlzVmlzaWJsZTogdHJ1ZSxcbiAgICAgIG1pbldpZHRoOiBjb25maWcubWluV2lkdGgsXG4gICAgICBtYXhXaWR0aDogY29uZmlnLm1heFdpZHRoLFxuICAgICAgZGVmYXVsdFdpZHRoOiBjb25maWcuZGVmYXVsdFdpZHRoLFxuICAgICAgY29sbGFwc2VkV2lkdGg6IGNvbmZpZy5jb2xsYXBzZWRXaWR0aCxcbiAgICAgIGlzUmVzaXppbmc6IGZhbHNlLFxuICAgIH07XG5cbiAgICB0aGlzLnBhbmVscy5zZXQocGFuZWxJZCwgcmVzZXRTdGF0ZSk7XG4gICAgdGhpcy5ub3RpZnlTdGF0ZUNoYW5nZShwYW5lbElkLCByZXNldFN0YXRlKTtcbiAgICB0aGlzLnNhdmVQYW5lbFN0YXRlcygpO1xuICB9XG5cbiAgcmVzZXRBbGxQYW5lbHMoKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBwYW5lbElkIG9mIHRoaXMucGFuZWxzLmtleXMoKSkge1xuICAgICAgdGhpcy5yZXNldFBhbmVsKHBhbmVsSWQpO1xuICAgIH1cbiAgfVxufVxuIl0sCiAgIm1hcHBpbmdzIjogIkFBY08sYUFBTSx1QkFBMEQ7QUFBQSxFQUM3RCxTQUFTLG9CQUFJ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
