export class TKAImageExportOrchestrator {
  constructor(compositionService, fileService, layoutService, dimensionService, configManager, validator, previewGenerator, filenameGenerator) {
    this.compositionService = compositionService;
    this.fileService = fileService;
    this.layoutService = layoutService;
    this.dimensionService = dimensionService;
    this.configManager = configManager;
    this.validator = validator;
    this.previewGenerator = previewGenerator;
    this.filenameGenerator = filenameGenerator;
  }
  /**
   * Export a complete sequence as an image blob
   * Main entry point for image export functionality
   */
  async exportSequenceImage(sequence, options = {}) {
    if (!sequence) {
      throw new Error("Sequence data is required for export");
    }
    const fullOptions = this.configManager.mergeWithDefaults(options);
    const validation = this.validator.validateExport(sequence, fullOptions);
    if (!validation.valid) {
      throw new Error(
        `Export validation failed: ${validation.errors.join(", ")}`
      );
    }
    try {
      const canvas = await this.compositionService.composeSequenceImage(
        sequence,
        fullOptions
      );
      const blob = await this.fileService.canvasToBlob(
        canvas,
        fullOptions.format,
        fullOptions.quality
      );
      return blob;
    } catch (error) {
      throw new Error(
        `Image export failed: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Generate a preview image (smaller scale for UI)
   * Returns data URL for immediate display
   */
  async generatePreview(sequence, options = {}) {
    return this.previewGenerator.generatePreview(sequence, options);
  }
  /**
   * Export and download image file directly
   */
  async exportAndDownload(sequence, filename, options = {}) {
    const blob = await this.exportSequenceImage(sequence, options);
    const finalFilename = filename || this.filenameGenerator.generateDefaultFilename(sequence, options);
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = finalFilename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }
  /**
   * Export multiple sequences as a batch
   */
  async batchExport(sequences, options = {}, progressCallback) {
    for (let i = 0; i < sequences.length; i++) {
      const sequence = sequences[i];
      progressCallback?.(i, sequences.length);
      await this.exportAndDownload(sequence, void 0, options);
      await new Promise((resolve) => setTimeout(resolve, 100));
    }
    progressCallback?.(sequences.length, sequences.length);
  }
  /**
   * Validate sequence and options before export
   */
  validateExport(sequence, options) {
    return this.validator.validateExport(sequence, options);
  }
  /**
   * Export with default filename
   */
  async exportSequenceImageWithFilename(sequence, options = {}) {
    const blob = await this.exportSequenceImage(sequence, options);
    const filename = this.filenameGenerator.generateDefaultFilename(
      sequence,
      options
    );
    return { blob, filename };
  }
  /**
   * Export with custom canvas size (for special use cases)
   */
  async exportWithCustomSize(sequence, targetWidth, targetHeight, options = {}) {
    const beatCount = sequence.beats.length;
    const [columns, rows] = this.layoutService.calculateLayout(
      beatCount,
      options.includeStartPosition ?? true
    );
    const baseOptions = this.configManager.mergeWithDefaults(options);
    const [additionalTop, additionalBottom] = this.dimensionService.determineAdditionalHeights(
      baseOptions,
      beatCount,
      1
      // Use scale 1.0 for calculation
    );
    const [baseWidth, baseHeight] = this.layoutService.calculateImageDimensions(
      [columns, rows],
      additionalTop + additionalBottom,
      1
      // Use scale 1.0 for calculation
    );
    const scaleX = targetWidth / baseWidth;
    const scaleY = targetHeight / baseHeight;
    const scale = Math.min(scaleX, scaleY);
    const customOptions = {
      ...baseOptions,
      beatScale: scale
    };
    return await this.exportSequenceImage(sequence, customOptions);
  }
  /**
   * Get default export options
   */
  getDefaultOptions() {
    return this.configManager.getDefaultOptions();
  }
  /**
   * Debug method to test export pipeline
   */
  async debugExport() {
    let defaultOptionsTest = false;
    let validationTest = false;
    let previewTest = false;
    let exportTest = false;
    try {
      const defaults = this.getDefaultOptions();
      defaultOptionsTest = defaults.beatScale === 1 && defaults.format === "PNG";
      const testSequence = {
        id: "test",
        name: "Test",
        word: "TEST",
        beats: [],
        thumbnails: [],
        isFavorite: false,
        isCircular: false,
        tags: [],
        metadata: {}
      };
      const validation = this.validator.validateExport(testSequence, defaults);
      validationTest = validation.valid;
      const preview = await this.generatePreview(testSequence);
      previewTest = preview.startsWith("data:image/");
      const blob = await this.exportSequenceImage(testSequence);
      exportTest = blob.size > 0;
    } catch (error) {
      console.error("Export debug failed:", error);
    }
    return {
      defaultOptionsTest,
      validationTest,
      previewTest,
      exportTest
    };
  }
}
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiQzovVEtBL3dlYi9zcmMvbGliL3NlcnZpY2VzL2ltcGxlbWVudGF0aW9ucy9pbWFnZS1leHBvcnQvVEtBSW1hZ2VFeHBvcnRPcmNoZXN0cmF0b3IudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbIi8qKlxuICogVEtBIEltYWdlIEV4cG9ydCBPcmNoZXN0cmF0b3JcbiAqXG4gKiBNYWluIG9yY2hlc3RyYXRvciBmb3IgVEtBIHNlcXVlbmNlIGltYWdlIGV4cG9ydC4gVGhpcyBzZXJ2aWNlIHByb3ZpZGVzIHRoZVxuICogdG9wLWxldmVsIEFQSSBmb3IgZXhwb3J0aW5nIHNlcXVlbmNlcyBhcyBpbWFnZXMsIGNvb3JkaW5hdGluZyBhbGwgdGhlXG4gKiBzcGVjaWFsaXplZCBzZXJ2aWNlcyB0byBjcmVhdGUgcGl4ZWwtcGVyZmVjdCBpbWFnZXMuXG4gKlxuICogUmVmYWN0b3JlZCBmcm9tIHRoZSBtb25vbGl0aGljIFRLQUltYWdlRXhwb3J0U2VydmljZSB0byBmb2N1cyBzb2xlbHkgb24gb3JjaGVzdHJhdGlvbi5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7IFNlcXVlbmNlRGF0YSB9IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL2RvbWFpbi10eXBlc1wiO1xuaW1wb3J0IHR5cGUge1xuICBJRGltZW5zaW9uQ2FsY3VsYXRpb25TZXJ2aWNlLFxuICBJRXhwb3J0Q29uZmlndXJhdGlvbk1hbmFnZXIsXG4gIElFeHBvcnRPcHRpb25zVmFsaWRhdG9yLFxuICBJRmlsZUV4cG9ydFNlcnZpY2UsXG4gIElGaWxlbmFtZUdlbmVyYXRvclNlcnZpY2UsXG4gIElJbWFnZUNvbXBvc2l0aW9uU2VydmljZSxcbiAgSUltYWdlUHJldmlld0dlbmVyYXRvcixcbiAgSUxheW91dENhbGN1bGF0aW9uU2VydmljZSxcbiAgSVRLQUltYWdlRXhwb3J0U2VydmljZSxcbiAgVEtBSW1hZ2VFeHBvcnRPcHRpb25zLFxufSBmcm9tIFwiLi4vLi4vaW50ZXJmYWNlcy9pbWFnZS1leHBvcnQtaW50ZXJmYWNlc1wiO1xuXG5leHBvcnQgY2xhc3MgVEtBSW1hZ2VFeHBvcnRPcmNoZXN0cmF0b3IgaW1wbGVtZW50cyBJVEtBSW1hZ2VFeHBvcnRTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjb21wb3NpdGlvblNlcnZpY2U6IElJbWFnZUNvbXBvc2l0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGZpbGVTZXJ2aWNlOiBJRmlsZUV4cG9ydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBsYXlvdXRTZXJ2aWNlOiBJTGF5b3V0Q2FsY3VsYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgZGltZW5zaW9uU2VydmljZTogSURpbWVuc2lvbkNhbGN1bGF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGNvbmZpZ01hbmFnZXI6IElFeHBvcnRDb25maWd1cmF0aW9uTWFuYWdlcixcbiAgICBwcml2YXRlIHZhbGlkYXRvcjogSUV4cG9ydE9wdGlvbnNWYWxpZGF0b3IsXG4gICAgcHJpdmF0ZSBwcmV2aWV3R2VuZXJhdG9yOiBJSW1hZ2VQcmV2aWV3R2VuZXJhdG9yLFxuICAgIHByaXZhdGUgZmlsZW5hbWVHZW5lcmF0b3I6IElGaWxlbmFtZUdlbmVyYXRvclNlcnZpY2VcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBFeHBvcnQgYSBjb21wbGV0ZSBzZXF1ZW5jZSBhcyBhbiBpbWFnZSBibG9iXG4gICAqIE1haW4gZW50cnkgcG9pbnQgZm9yIGltYWdlIGV4cG9ydCBmdW5jdGlvbmFsaXR5XG4gICAqL1xuICBhc3luYyBleHBvcnRTZXF1ZW5jZUltYWdlKFxuICAgIHNlcXVlbmNlOiBTZXF1ZW5jZURhdGEsXG4gICAgb3B0aW9uczogUGFydGlhbDxUS0FJbWFnZUV4cG9ydE9wdGlvbnM+ID0ge31cbiAgKTogUHJvbWlzZTxCbG9iPiB7XG4gICAgaWYgKCFzZXF1ZW5jZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiU2VxdWVuY2UgZGF0YSBpcyByZXF1aXJlZCBmb3IgZXhwb3J0XCIpO1xuICAgIH1cblxuICAgIC8vIE1lcmdlIHdpdGggZGVmYXVsdHMgdG8gZ2V0IGNvbXBsZXRlIG9wdGlvbnNcbiAgICBjb25zdCBmdWxsT3B0aW9ucyA9IHRoaXMuY29uZmlnTWFuYWdlci5tZXJnZVdpdGhEZWZhdWx0cyhvcHRpb25zKTtcblxuICAgIC8vIFZhbGlkYXRlIGV4cG9ydCBwYXJhbWV0ZXJzXG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IHRoaXMudmFsaWRhdG9yLnZhbGlkYXRlRXhwb3J0KHNlcXVlbmNlLCBmdWxsT3B0aW9ucyk7XG4gICAgaWYgKCF2YWxpZGF0aW9uLnZhbGlkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBFeHBvcnQgdmFsaWRhdGlvbiBmYWlsZWQ6ICR7dmFsaWRhdGlvbi5lcnJvcnMuam9pbihcIiwgXCIpfWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENvbXBvc2UgdGhlIGltYWdlXG4gICAgICBjb25zdCBjYW52YXMgPSBhd2FpdCB0aGlzLmNvbXBvc2l0aW9uU2VydmljZS5jb21wb3NlU2VxdWVuY2VJbWFnZShcbiAgICAgICAgc2VxdWVuY2UsXG4gICAgICAgIGZ1bGxPcHRpb25zXG4gICAgICApO1xuXG4gICAgICAvLyBDb252ZXJ0IHRvIGJsb2JcbiAgICAgIGNvbnN0IGJsb2IgPSBhd2FpdCB0aGlzLmZpbGVTZXJ2aWNlLmNhbnZhc1RvQmxvYihcbiAgICAgICAgY2FudmFzLFxuICAgICAgICBmdWxsT3B0aW9ucy5mb3JtYXQsXG4gICAgICAgIGZ1bGxPcHRpb25zLnF1YWxpdHlcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiBibG9iO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBJbWFnZSBleHBvcnQgZmFpbGVkOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCJ9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgYSBwcmV2aWV3IGltYWdlIChzbWFsbGVyIHNjYWxlIGZvciBVSSlcbiAgICogUmV0dXJucyBkYXRhIFVSTCBmb3IgaW1tZWRpYXRlIGRpc3BsYXlcbiAgICovXG4gIGFzeW5jIGdlbmVyYXRlUHJldmlldyhcbiAgICBzZXF1ZW5jZTogU2VxdWVuY2VEYXRhLFxuICAgIG9wdGlvbnM6IFBhcnRpYWw8VEtBSW1hZ2VFeHBvcnRPcHRpb25zPiA9IHt9XG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMucHJldmlld0dlbmVyYXRvci5nZW5lcmF0ZVByZXZpZXcoc2VxdWVuY2UsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4cG9ydCBhbmQgZG93bmxvYWQgaW1hZ2UgZmlsZSBkaXJlY3RseVxuICAgKi9cbiAgYXN5bmMgZXhwb3J0QW5kRG93bmxvYWQoXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBmaWxlbmFtZT86IHN0cmluZyxcbiAgICBvcHRpb25zOiBQYXJ0aWFsPFRLQUltYWdlRXhwb3J0T3B0aW9ucz4gPSB7fVxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBibG9iID0gYXdhaXQgdGhpcy5leHBvcnRTZXF1ZW5jZUltYWdlKHNlcXVlbmNlLCBvcHRpb25zKTtcbiAgICBjb25zdCBmaW5hbEZpbGVuYW1lID1cbiAgICAgIGZpbGVuYW1lIHx8XG4gICAgICB0aGlzLmZpbGVuYW1lR2VuZXJhdG9yLmdlbmVyYXRlRGVmYXVsdEZpbGVuYW1lKHNlcXVlbmNlLCBvcHRpb25zKTtcblxuICAgIC8vIENyZWF0ZSBkb3dubG9hZCBsaW5rXG4gICAgY29uc3QgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTtcbiAgICBjb25zdCBsaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFcIik7XG4gICAgbGluay5ocmVmID0gdXJsO1xuICAgIGxpbmsuZG93bmxvYWQgPSBmaW5hbEZpbGVuYW1lO1xuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobGluayk7XG4gICAgbGluay5jbGljaygpO1xuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQobGluayk7XG4gICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4cG9ydCBtdWx0aXBsZSBzZXF1ZW5jZXMgYXMgYSBiYXRjaFxuICAgKi9cbiAgYXN5bmMgYmF0Y2hFeHBvcnQoXG4gICAgc2VxdWVuY2VzOiBTZXF1ZW5jZURhdGFbXSxcbiAgICBvcHRpb25zOiBQYXJ0aWFsPFRLQUltYWdlRXhwb3J0T3B0aW9ucz4gPSB7fSxcbiAgICBwcm9ncmVzc0NhbGxiYWNrPzogKGN1cnJlbnQ6IG51bWJlciwgdG90YWw6IG51bWJlcikgPT4gdm9pZFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlcXVlbmNlcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3Qgc2VxdWVuY2UgPSBzZXF1ZW5jZXNbaV07XG4gICAgICBwcm9ncmVzc0NhbGxiYWNrPy4oaSwgc2VxdWVuY2VzLmxlbmd0aCk7XG5cbiAgICAgIGF3YWl0IHRoaXMuZXhwb3J0QW5kRG93bmxvYWQoc2VxdWVuY2UsIHVuZGVmaW5lZCwgb3B0aW9ucyk7XG5cbiAgICAgIC8vIFNtYWxsIGRlbGF5IHRvIHByZXZlbnQgb3ZlcndoZWxtaW5nIHRoZSBicm93c2VyXG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDApKTtcbiAgICB9XG5cbiAgICBwcm9ncmVzc0NhbGxiYWNrPy4oc2VxdWVuY2VzLmxlbmd0aCwgc2VxdWVuY2VzLmxlbmd0aCk7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgc2VxdWVuY2UgYW5kIG9wdGlvbnMgYmVmb3JlIGV4cG9ydFxuICAgKi9cbiAgdmFsaWRhdGVFeHBvcnQoXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBvcHRpb25zOiBUS0FJbWFnZUV4cG9ydE9wdGlvbnNcbiAgKTogeyB2YWxpZDogYm9vbGVhbjsgZXJyb3JzOiBzdHJpbmdbXSB9IHtcbiAgICByZXR1cm4gdGhpcy52YWxpZGF0b3IudmFsaWRhdGVFeHBvcnQoc2VxdWVuY2UsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4cG9ydCB3aXRoIGRlZmF1bHQgZmlsZW5hbWVcbiAgICovXG4gIGFzeW5jIGV4cG9ydFNlcXVlbmNlSW1hZ2VXaXRoRmlsZW5hbWUoXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBvcHRpb25zOiBQYXJ0aWFsPFRLQUltYWdlRXhwb3J0T3B0aW9ucz4gPSB7fVxuICApOiBQcm9taXNlPHsgYmxvYjogQmxvYjsgZmlsZW5hbWU6IHN0cmluZyB9PiB7XG4gICAgY29uc3QgYmxvYiA9IGF3YWl0IHRoaXMuZXhwb3J0U2VxdWVuY2VJbWFnZShzZXF1ZW5jZSwgb3B0aW9ucyk7XG4gICAgY29uc3QgZmlsZW5hbWUgPSB0aGlzLmZpbGVuYW1lR2VuZXJhdG9yLmdlbmVyYXRlRGVmYXVsdEZpbGVuYW1lKFxuICAgICAgc2VxdWVuY2UsXG4gICAgICBvcHRpb25zXG4gICAgKTtcblxuICAgIHJldHVybiB7IGJsb2IsIGZpbGVuYW1lIH07XG4gIH1cblxuICAvKipcbiAgICogRXhwb3J0IHdpdGggY3VzdG9tIGNhbnZhcyBzaXplIChmb3Igc3BlY2lhbCB1c2UgY2FzZXMpXG4gICAqL1xuICBhc3luYyBleHBvcnRXaXRoQ3VzdG9tU2l6ZShcbiAgICBzZXF1ZW5jZTogU2VxdWVuY2VEYXRhLFxuICAgIHRhcmdldFdpZHRoOiBudW1iZXIsXG4gICAgdGFyZ2V0SGVpZ2h0OiBudW1iZXIsXG4gICAgb3B0aW9uczogUGFydGlhbDxUS0FJbWFnZUV4cG9ydE9wdGlvbnM+ID0ge31cbiAgKTogUHJvbWlzZTxCbG9iPiB7XG4gICAgLy8gQ2FsY3VsYXRlIHJlcXVpcmVkIHNjYWxlIHRvIGZpdCB0YXJnZXQgZGltZW5zaW9uc1xuICAgIGNvbnN0IGJlYXRDb3VudCA9IHNlcXVlbmNlLmJlYXRzLmxlbmd0aDtcbiAgICBjb25zdCBbY29sdW1ucywgcm93c10gPSB0aGlzLmxheW91dFNlcnZpY2UuY2FsY3VsYXRlTGF5b3V0KFxuICAgICAgYmVhdENvdW50LFxuICAgICAgb3B0aW9ucy5pbmNsdWRlU3RhcnRQb3NpdGlvbiA/PyB0cnVlXG4gICAgKTtcblxuICAgIGNvbnN0IGJhc2VPcHRpb25zID0gdGhpcy5jb25maWdNYW5hZ2VyLm1lcmdlV2l0aERlZmF1bHRzKG9wdGlvbnMpO1xuICAgIGNvbnN0IFthZGRpdGlvbmFsVG9wLCBhZGRpdGlvbmFsQm90dG9tXSA9XG4gICAgICB0aGlzLmRpbWVuc2lvblNlcnZpY2UuZGV0ZXJtaW5lQWRkaXRpb25hbEhlaWdodHMoXG4gICAgICAgIGJhc2VPcHRpb25zLFxuICAgICAgICBiZWF0Q291bnQsXG4gICAgICAgIDEuMCAvLyBVc2Ugc2NhbGUgMS4wIGZvciBjYWxjdWxhdGlvblxuICAgICAgKTtcblxuICAgIGNvbnN0IFtiYXNlV2lkdGgsIGJhc2VIZWlnaHRdID0gdGhpcy5sYXlvdXRTZXJ2aWNlLmNhbGN1bGF0ZUltYWdlRGltZW5zaW9ucyhcbiAgICAgIFtjb2x1bW5zLCByb3dzXSxcbiAgICAgIGFkZGl0aW9uYWxUb3AgKyBhZGRpdGlvbmFsQm90dG9tLFxuICAgICAgMS4wIC8vIFVzZSBzY2FsZSAxLjAgZm9yIGNhbGN1bGF0aW9uXG4gICAgKTtcblxuICAgIC8vIENhbGN1bGF0ZSBzY2FsZSB0byBmaXQgdGFyZ2V0IGRpbWVuc2lvbnNcbiAgICBjb25zdCBzY2FsZVggPSB0YXJnZXRXaWR0aCAvIGJhc2VXaWR0aDtcbiAgICBjb25zdCBzY2FsZVkgPSB0YXJnZXRIZWlnaHQgLyBiYXNlSGVpZ2h0O1xuICAgIGNvbnN0IHNjYWxlID0gTWF0aC5taW4oc2NhbGVYLCBzY2FsZVkpO1xuXG4gICAgLy8gRXhwb3J0IHdpdGggY2FsY3VsYXRlZCBzY2FsZVxuICAgIGNvbnN0IGN1c3RvbU9wdGlvbnMgPSB7XG4gICAgICAuLi5iYXNlT3B0aW9ucyxcbiAgICAgIGJlYXRTY2FsZTogc2NhbGUsXG4gICAgfTtcblxuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4cG9ydFNlcXVlbmNlSW1hZ2Uoc2VxdWVuY2UsIGN1c3RvbU9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBkZWZhdWx0IGV4cG9ydCBvcHRpb25zXG4gICAqL1xuICBnZXREZWZhdWx0T3B0aW9ucygpOiBUS0FJbWFnZUV4cG9ydE9wdGlvbnMge1xuICAgIHJldHVybiB0aGlzLmNvbmZpZ01hbmFnZXIuZ2V0RGVmYXVsdE9wdGlvbnMoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWJ1ZyBtZXRob2QgdG8gdGVzdCBleHBvcnQgcGlwZWxpbmVcbiAgICovXG4gIGFzeW5jIGRlYnVnRXhwb3J0KCk6IFByb21pc2U8e1xuICAgIGRlZmF1bHRPcHRpb25zVGVzdDogYm9vbGVhbjtcbiAgICB2YWxpZGF0aW9uVGVzdDogYm9vbGVhbjtcbiAgICBwcmV2aWV3VGVzdDogYm9vbGVhbjtcbiAgICBleHBvcnRUZXN0OiBib29sZWFuO1xuICB9PiB7XG4gICAgbGV0IGRlZmF1bHRPcHRpb25zVGVzdCA9IGZhbHNlO1xuICAgIGxldCB2YWxpZGF0aW9uVGVzdCA9IGZhbHNlO1xuICAgIGxldCBwcmV2aWV3VGVzdCA9IGZhbHNlO1xuICAgIGxldCBleHBvcnRUZXN0ID0gZmFsc2U7XG5cbiAgICB0cnkge1xuICAgICAgLy8gVGVzdCBkZWZhdWx0IG9wdGlvbnNcbiAgICAgIGNvbnN0IGRlZmF1bHRzID0gdGhpcy5nZXREZWZhdWx0T3B0aW9ucygpO1xuICAgICAgZGVmYXVsdE9wdGlvbnNUZXN0ID1cbiAgICAgICAgZGVmYXVsdHMuYmVhdFNjYWxlID09PSAxLjAgJiYgZGVmYXVsdHMuZm9ybWF0ID09PSBcIlBOR1wiO1xuXG4gICAgICAvLyBUZXN0IHZhbGlkYXRpb25cbiAgICAgIGNvbnN0IHRlc3RTZXF1ZW5jZTogU2VxdWVuY2VEYXRhID0ge1xuICAgICAgICBpZDogXCJ0ZXN0XCIsXG4gICAgICAgIG5hbWU6IFwiVGVzdFwiLFxuICAgICAgICB3b3JkOiBcIlRFU1RcIixcbiAgICAgICAgYmVhdHM6IFtdLFxuICAgICAgICB0aHVtYm5haWxzOiBbXSxcbiAgICAgICAgaXNGYXZvcml0ZTogZmFsc2UsXG4gICAgICAgIGlzQ2lyY3VsYXI6IGZhbHNlLFxuICAgICAgICB0YWdzOiBbXSxcbiAgICAgICAgbWV0YWRhdGE6IHt9LFxuICAgICAgfTtcblxuICAgICAgY29uc3QgdmFsaWRhdGlvbiA9IHRoaXMudmFsaWRhdG9yLnZhbGlkYXRlRXhwb3J0KHRlc3RTZXF1ZW5jZSwgZGVmYXVsdHMpO1xuICAgICAgdmFsaWRhdGlvblRlc3QgPSB2YWxpZGF0aW9uLnZhbGlkO1xuXG4gICAgICAvLyBUZXN0IHByZXZpZXcgZ2VuZXJhdGlvblxuICAgICAgY29uc3QgcHJldmlldyA9IGF3YWl0IHRoaXMuZ2VuZXJhdGVQcmV2aWV3KHRlc3RTZXF1ZW5jZSk7XG4gICAgICBwcmV2aWV3VGVzdCA9IHByZXZpZXcuc3RhcnRzV2l0aChcImRhdGE6aW1hZ2UvXCIpO1xuXG4gICAgICAvLyBUZXN0IGV4cG9ydFxuICAgICAgY29uc3QgYmxvYiA9IGF3YWl0IHRoaXMuZXhwb3J0U2VxdWVuY2VJbWFnZSh0ZXN0U2VxdWVuY2UpO1xuICAgICAgZXhwb3J0VGVzdCA9IGJsb2Iuc2l6ZSA+IDA7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJFeHBvcnQgZGVidWcgZmFpbGVkOlwiLCBlcnJvcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRlZmF1bHRPcHRpb25zVGVzdCxcbiAgICAgIHZhbGlkYXRpb25UZXN0LFxuICAgICAgcHJldmlld1Rlc3QsXG4gICAgICBleHBvcnRUZXN0LFxuICAgIH07XG4gIH1cbn1cbiJdLAogICJtYXBwaW5ncyI6ICJB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
