import { GridMode, MotionType } from "/src/lib/domain/enums.ts";
import { jsonCache } from "/src/lib/services/positioning/cache/SimpleJsonCache.ts";
export class ArrowPlacementService {
  allPlacements = {
    [GridMode.DIAMOND]: {},
    [GridMode.BOX]: {}
  };
  isDataLoaded = false;
  // File mapping for placement data
  placementFiles = {
    [GridMode.DIAMOND]: {
      pro: "/data/arrow_placement/diamond/default/default_diamond_pro_placements.json",
      anti: "/data/arrow_placement/diamond/default/default_diamond_anti_placements.json",
      float: "/data/arrow_placement/diamond/default/default_diamond_float_placements.json",
      dash: "/data/arrow_placement/diamond/default/default_diamond_dash_placements.json",
      static: "/data/arrow_placement/diamond/default/default_diamond_static_placements.json"
    },
    [GridMode.BOX]: {
      pro: "/data/arrow_placement/box/default/default_box_pro_placements.json",
      anti: "/data/arrow_placement/box/default/default_box_anti_placements.json",
      float: "/data/arrow_placement/box/default/default_box_float_placements.json",
      dash: "/data/arrow_placement/box/default/default_box_dash_placements.json",
      static: "/data/arrow_placement/box/default/default_box_static_placements.json"
    }
    // SKEWED mode doesn't have separate files - it uses both diamond and box
  };
  /**
   * Load all placement data from JSON files
   */
  async loadPlacementData() {
    if (this.isDataLoaded) {
      return;
    }
    try {
      await this.loadGridPlacements(GridMode.DIAMOND);
      await this.loadGridPlacements(GridMode.BOX);
      this.isDataLoaded = true;
    } catch (error) {
      console.error("❌ Failed to load arrow placement data:", error);
      throw new Error(
        `Placement data loading failed: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Load placements for a specific grid mode
   */
  async loadGridPlacements(gridMode) {
    const actualGridMode = gridMode === GridMode.SKEWED ? GridMode.DIAMOND : gridMode;
    const files = this.placementFiles[actualGridMode];
    this.allPlacements[gridMode] = {};
    for (const [motionType, filePath] of Object.entries(files)) {
      try {
        const placementData = await this.loadJsonFile(filePath);
        this.allPlacements[gridMode][motionType] = placementData;
      } catch (error) {
        console.warn(
          `Could not load ${motionType} placements for ${gridMode}: ${error}`
        );
        this.allPlacements[gridMode][motionType] = {};
      }
    }
  }
  /**
   * Load JSON file with caching
   */
  async loadJsonFile(path) {
    try {
      const data = await jsonCache.get(path);
      return data;
    } catch (error) {
      console.warn(`Failed to load placement data from ${path}:`, error);
      return {};
    }
  }
  /**
   * Get default adjustment using placement key and turns
   */
  async getDefaultAdjustment(motionType, placementKey, turns, gridMode = GridMode.DIAMOND) {
    await this.ensureDataLoaded();
    const gridPlacements = this.allPlacements[gridMode];
    if (!gridPlacements) {
      console.warn(`No placement data for grid mode: ${gridMode}`);
      return { x: 0, y: 0 };
    }
    const motionPlacements = gridPlacements[motionType];
    if (!motionPlacements) {
      console.warn(`No placement data for motion type: ${motionType}`);
      return { x: 0, y: 0 };
    }
    const placementData = motionPlacements[placementKey];
    if (!placementData) {
      console.warn(`No placement data for key: ${placementKey}`);
      return { x: 0, y: 0 };
    }
    const turnsStr = this.formatTurnsForLookup(turns);
    const adjustment = placementData[turnsStr];
    if (!adjustment) {
      console.warn(
        `No adjustment for turns: ${turnsStr} in placement: ${placementKey}`
      );
      return { x: 0, y: 0 };
    }
    const [x, y] = adjustment;
    return { x, y };
  }
  /**
   * Get available placement keys for a motion type
   */
  async getAvailablePlacementKeys(motionType, gridMode = GridMode.DIAMOND) {
    await this.ensureDataLoaded();
    const motionPlacements = this.allPlacements[gridMode]?.[motionType];
    if (!motionPlacements) {
      return [];
    }
    return Object.keys(motionPlacements);
  }
  /**
   * Check if data is loaded
   */
  isLoaded() {
    return this.isDataLoaded;
  }
  /**
   * Ensure data is loaded before operations
   */
  async ensureDataLoaded() {
    if (!this.isDataLoaded) {
      await this.loadPlacementData();
    }
  }
  /**
   * Format turns value for JSON lookup
   * Converts: 1.0 → "1", 0.5 → "0.5", etc.
   */
  formatTurnsForLookup(turns) {
    if (typeof turns === "string") {
      return turns;
    }
    if (turns === Math.floor(turns)) {
      return Math.floor(turns).toString();
    }
    return turns.toString();
  }
  /**
   * Debug method to log available keys
   */
  async debugAvailableKeys(motionType, gridMode = GridMode.DIAMOND) {
    const keys = await this.getAvailablePlacementKeys(motionType, gridMode);
    console.log(
      `Available placement keys for ${motionType} (${gridMode}):`,
      keys
    );
  }
  /**
   * Get raw placement data for debugging
   */
  async getPlacementData(motionType, placementKey, gridMode = GridMode.DIAMOND) {
    await this.ensureDataLoaded();
    const motionPlacements = this.allPlacements[gridMode]?.[motionType];
    return motionPlacements?.[placementKey] || {};
  }
}
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiQzovVEtBL3dlYi9zcmMvbGliL3NlcnZpY2VzL2ltcGxlbWVudGF0aW9ucy9kYXRhL0Fycm93UGxhY2VtZW50U2VydmljZS50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiLyoqXG4gKiBBcnJvdyBQbGFjZW1lbnQgRGF0YSBTZXJ2aWNlXG4gKlxuICogTG9hZHMgYW5kIG1hbmFnZXMgYXJyb3cgcGxhY2VtZW50IEpTT04gZGF0YSBmb3IgcG9zaXRpb25pbmcgY2FsY3VsYXRpb25zLlxuICogUG9ydHMgdGhlIGV4YWN0IGZ1bmN0aW9uYWxpdHkgZnJvbSBkZXNrdG9wIERlZmF1bHRQbGFjZW1lbnRTZXJ2aWNlLlxuICovXG5cbmltcG9ydCB7IEdyaWRNb2RlLCBNb3Rpb25UeXBlIH0gZnJvbSBcIiRsaWIvZG9tYWluL2VudW1zXCI7IC8vIOKchSBJbXBvcnQgZnJvbSBjZW50cmFsaXplZCBlbnVtc1xuaW1wb3J0IHsganNvbkNhY2hlIH0gZnJvbSBcIi4uLy4uL3Bvc2l0aW9uaW5nL2NhY2hlL1NpbXBsZUpzb25DYWNoZVwiO1xuXG4vLyBQbGFjZW1lbnQgZGF0YSBzdHJ1Y3R1cmUgZnJvbSBKU09OIGZpbGVzXG5leHBvcnQgaW50ZXJmYWNlIEpzb25QbGFjZW1lbnREYXRhIHtcbiAgW3BsYWNlbWVudEtleTogc3RyaW5nXToge1xuICAgIFt0dXJuczogc3RyaW5nXTogW251bWJlciwgbnVtYmVyXTsgLy8gW3gsIHldIGFkanVzdG1lbnRcbiAgfTtcbn1cblxuLy8gQ29tcGxldGUgcGxhY2VtZW50IGRhdGEgZm9yIGFsbCBtb3Rpb24gdHlwZXNcbmV4cG9ydCBpbnRlcmZhY2UgR3JpZFBsYWNlbWVudERhdGEge1xuICBbbW90aW9uVHlwZTogc3RyaW5nXTogSnNvblBsYWNlbWVudERhdGE7XG59XG5cbi8vIEFsbCBwbGFjZW1lbnQgZGF0YSBmb3IgYWxsIGdyaWQgbW9kZXNcbmV4cG9ydCBpbnRlcmZhY2UgQWxsUGxhY2VtZW50RGF0YSB7XG4gIFtncmlkTW9kZTogc3RyaW5nXTogR3JpZFBsYWNlbWVudERhdGE7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUFycm93UGxhY2VtZW50U2VydmljZSB7XG4gIGdldERlZmF1bHRBZGp1c3RtZW50KFxuICAgIG1vdGlvblR5cGU6IE1vdGlvblR5cGUsXG4gICAgcGxhY2VtZW50S2V5OiBzdHJpbmcsXG4gICAgdHVybnM6IG51bWJlciB8IHN0cmluZyxcbiAgICBncmlkTW9kZTogR3JpZE1vZGVcbiAgKTogUHJvbWlzZTx7IHg6IG51bWJlcjsgeTogbnVtYmVyIH0+O1xuXG4gIGdldEF2YWlsYWJsZVBsYWNlbWVudEtleXMoXG4gICAgbW90aW9uVHlwZTogTW90aW9uVHlwZSxcbiAgICBncmlkTW9kZTogR3JpZE1vZGVcbiAgKTogUHJvbWlzZTxzdHJpbmdbXT47XG5cbiAgaXNMb2FkZWQoKTogYm9vbGVhbjtcbiAgbG9hZFBsYWNlbWVudERhdGEoKTogUHJvbWlzZTx2b2lkPjtcbn1cblxuZXhwb3J0IGNsYXNzIEFycm93UGxhY2VtZW50U2VydmljZSBpbXBsZW1lbnRzIElBcnJvd1BsYWNlbWVudFNlcnZpY2Uge1xuICBwcml2YXRlIGFsbFBsYWNlbWVudHM6IEFsbFBsYWNlbWVudERhdGEgPSB7XG4gICAgW0dyaWRNb2RlLkRJQU1PTkRdOiB7fSxcbiAgICBbR3JpZE1vZGUuQk9YXToge30sXG4gIH07XG5cbiAgcHJpdmF0ZSBpc0RhdGFMb2FkZWQgPSBmYWxzZTtcblxuICAvLyBGaWxlIG1hcHBpbmcgZm9yIHBsYWNlbWVudCBkYXRhXG4gIHByaXZhdGUgcmVhZG9ubHkgcGxhY2VtZW50RmlsZXM6IFJlY29yZDxzdHJpbmcsIFJlY29yZDxzdHJpbmcsIHN0cmluZz4+ID0ge1xuICAgIFtHcmlkTW9kZS5ESUFNT05EXToge1xuICAgICAgcHJvOiBcIi9kYXRhL2Fycm93X3BsYWNlbWVudC9kaWFtb25kL2RlZmF1bHQvZGVmYXVsdF9kaWFtb25kX3Byb19wbGFjZW1lbnRzLmpzb25cIixcbiAgICAgIGFudGk6IFwiL2RhdGEvYXJyb3dfcGxhY2VtZW50L2RpYW1vbmQvZGVmYXVsdC9kZWZhdWx0X2RpYW1vbmRfYW50aV9wbGFjZW1lbnRzLmpzb25cIixcbiAgICAgIGZsb2F0OlxuICAgICAgICBcIi9kYXRhL2Fycm93X3BsYWNlbWVudC9kaWFtb25kL2RlZmF1bHQvZGVmYXVsdF9kaWFtb25kX2Zsb2F0X3BsYWNlbWVudHMuanNvblwiLFxuICAgICAgZGFzaDogXCIvZGF0YS9hcnJvd19wbGFjZW1lbnQvZGlhbW9uZC9kZWZhdWx0L2RlZmF1bHRfZGlhbW9uZF9kYXNoX3BsYWNlbWVudHMuanNvblwiLFxuICAgICAgc3RhdGljOlxuICAgICAgICBcIi9kYXRhL2Fycm93X3BsYWNlbWVudC9kaWFtb25kL2RlZmF1bHQvZGVmYXVsdF9kaWFtb25kX3N0YXRpY19wbGFjZW1lbnRzLmpzb25cIixcbiAgICB9LFxuICAgIFtHcmlkTW9kZS5CT1hdOiB7XG4gICAgICBwcm86IFwiL2RhdGEvYXJyb3dfcGxhY2VtZW50L2JveC9kZWZhdWx0L2RlZmF1bHRfYm94X3Byb19wbGFjZW1lbnRzLmpzb25cIixcbiAgICAgIGFudGk6IFwiL2RhdGEvYXJyb3dfcGxhY2VtZW50L2JveC9kZWZhdWx0L2RlZmF1bHRfYm94X2FudGlfcGxhY2VtZW50cy5qc29uXCIsXG4gICAgICBmbG9hdDpcbiAgICAgICAgXCIvZGF0YS9hcnJvd19wbGFjZW1lbnQvYm94L2RlZmF1bHQvZGVmYXVsdF9ib3hfZmxvYXRfcGxhY2VtZW50cy5qc29uXCIsXG4gICAgICBkYXNoOiBcIi9kYXRhL2Fycm93X3BsYWNlbWVudC9ib3gvZGVmYXVsdC9kZWZhdWx0X2JveF9kYXNoX3BsYWNlbWVudHMuanNvblwiLFxuICAgICAgc3RhdGljOlxuICAgICAgICBcIi9kYXRhL2Fycm93X3BsYWNlbWVudC9ib3gvZGVmYXVsdC9kZWZhdWx0X2JveF9zdGF0aWNfcGxhY2VtZW50cy5qc29uXCIsXG4gICAgfSxcbiAgICAvLyBTS0VXRUQgbW9kZSBkb2Vzbid0IGhhdmUgc2VwYXJhdGUgZmlsZXMgLSBpdCB1c2VzIGJvdGggZGlhbW9uZCBhbmQgYm94XG4gIH07XG5cbiAgLyoqXG4gICAqIExvYWQgYWxsIHBsYWNlbWVudCBkYXRhIGZyb20gSlNPTiBmaWxlc1xuICAgKi9cbiAgYXN5bmMgbG9hZFBsYWNlbWVudERhdGEoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHRoaXMuaXNEYXRhTG9hZGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIExvYWQgZGlhbW9uZCBwbGFjZW1lbnRzXG4gICAgICBhd2FpdCB0aGlzLmxvYWRHcmlkUGxhY2VtZW50cyhHcmlkTW9kZS5ESUFNT05EKTtcblxuICAgICAgLy8gTG9hZCBib3ggcGxhY2VtZW50cyAobWF5IG5vdCBleGlzdCB5ZXQpXG4gICAgICBhd2FpdCB0aGlzLmxvYWRHcmlkUGxhY2VtZW50cyhHcmlkTW9kZS5CT1gpO1xuXG4gICAgICB0aGlzLmlzRGF0YUxvYWRlZCA9IHRydWU7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCLinYwgRmFpbGVkIHRvIGxvYWQgYXJyb3cgcGxhY2VtZW50IGRhdGE6XCIsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFBsYWNlbWVudCBkYXRhIGxvYWRpbmcgZmFpbGVkOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCJ9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTG9hZCBwbGFjZW1lbnRzIGZvciBhIHNwZWNpZmljIGdyaWQgbW9kZVxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBsb2FkR3JpZFBsYWNlbWVudHMoZ3JpZE1vZGU6IEdyaWRNb2RlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gRm9yIFNLRVdFRCBtb2RlLCBkZWZhdWx0IHRvIGRpYW1vbmQgZmlsZXNcbiAgICBjb25zdCBhY3R1YWxHcmlkTW9kZSA9XG4gICAgICBncmlkTW9kZSA9PT0gR3JpZE1vZGUuU0tFV0VEID8gR3JpZE1vZGUuRElBTU9ORCA6IGdyaWRNb2RlO1xuICAgIGNvbnN0IGZpbGVzID0gdGhpcy5wbGFjZW1lbnRGaWxlc1thY3R1YWxHcmlkTW9kZV07XG4gICAgdGhpcy5hbGxQbGFjZW1lbnRzW2dyaWRNb2RlXSA9IHt9O1xuXG4gICAgZm9yIChjb25zdCBbbW90aW9uVHlwZSwgZmlsZVBhdGhdIG9mIE9iamVjdC5lbnRyaWVzKGZpbGVzKSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcGxhY2VtZW50RGF0YSA9IGF3YWl0IHRoaXMubG9hZEpzb25GaWxlKGZpbGVQYXRoKTtcbiAgICAgICAgdGhpcy5hbGxQbGFjZW1lbnRzW2dyaWRNb2RlXVttb3Rpb25UeXBlXSA9IHBsYWNlbWVudERhdGE7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgYENvdWxkIG5vdCBsb2FkICR7bW90aW9uVHlwZX0gcGxhY2VtZW50cyBmb3IgJHtncmlkTW9kZX06ICR7ZXJyb3J9YFxuICAgICAgICApO1xuICAgICAgICB0aGlzLmFsbFBsYWNlbWVudHNbZ3JpZE1vZGVdW21vdGlvblR5cGVdID0ge307XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExvYWQgSlNPTiBmaWxlIHdpdGggY2FjaGluZ1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBsb2FkSnNvbkZpbGUocGF0aDogc3RyaW5nKTogUHJvbWlzZTxKc29uUGxhY2VtZW50RGF0YT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQganNvbkNhY2hlLmdldChwYXRoKTtcbiAgICAgIHJldHVybiBkYXRhIGFzIEpzb25QbGFjZW1lbnREYXRhO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oYEZhaWxlZCB0byBsb2FkIHBsYWNlbWVudCBkYXRhIGZyb20gJHtwYXRofTpgLCBlcnJvcik7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBkZWZhdWx0IGFkanVzdG1lbnQgdXNpbmcgcGxhY2VtZW50IGtleSBhbmQgdHVybnNcbiAgICovXG4gIGFzeW5jIGdldERlZmF1bHRBZGp1c3RtZW50KFxuICAgIG1vdGlvblR5cGU6IE1vdGlvblR5cGUsXG4gICAgcGxhY2VtZW50S2V5OiBzdHJpbmcsXG4gICAgdHVybnM6IG51bWJlciB8IHN0cmluZyxcbiAgICBncmlkTW9kZTogR3JpZE1vZGUgPSBHcmlkTW9kZS5ESUFNT05EXG4gICk6IFByb21pc2U8eyB4OiBudW1iZXI7IHk6IG51bWJlciB9PiB7XG4gICAgYXdhaXQgdGhpcy5lbnN1cmVEYXRhTG9hZGVkKCk7XG5cbiAgICBjb25zdCBncmlkUGxhY2VtZW50cyA9IHRoaXMuYWxsUGxhY2VtZW50c1tncmlkTW9kZV07XG4gICAgaWYgKCFncmlkUGxhY2VtZW50cykge1xuICAgICAgY29uc29sZS53YXJuKGBObyBwbGFjZW1lbnQgZGF0YSBmb3IgZ3JpZCBtb2RlOiAke2dyaWRNb2RlfWApO1xuICAgICAgcmV0dXJuIHsgeDogMCwgeTogMCB9O1xuICAgIH1cblxuICAgIGNvbnN0IG1vdGlvblBsYWNlbWVudHMgPSBncmlkUGxhY2VtZW50c1ttb3Rpb25UeXBlXTtcbiAgICBpZiAoIW1vdGlvblBsYWNlbWVudHMpIHtcbiAgICAgIGNvbnNvbGUud2FybihgTm8gcGxhY2VtZW50IGRhdGEgZm9yIG1vdGlvbiB0eXBlOiAke21vdGlvblR5cGV9YCk7XG4gICAgICByZXR1cm4geyB4OiAwLCB5OiAwIH07XG4gICAgfVxuXG4gICAgY29uc3QgcGxhY2VtZW50RGF0YSA9IG1vdGlvblBsYWNlbWVudHNbcGxhY2VtZW50S2V5XTtcbiAgICBpZiAoIXBsYWNlbWVudERhdGEpIHtcbiAgICAgIGNvbnNvbGUud2FybihgTm8gcGxhY2VtZW50IGRhdGEgZm9yIGtleTogJHtwbGFjZW1lbnRLZXl9YCk7XG4gICAgICByZXR1cm4geyB4OiAwLCB5OiAwIH07XG4gICAgfVxuXG4gICAgLy8gQ29udmVydCB0dXJucyB0byBzdHJpbmcgZm9ybWF0IHVzZWQgaW4gSlNPTlxuICAgIGNvbnN0IHR1cm5zU3RyID0gdGhpcy5mb3JtYXRUdXJuc0Zvckxvb2t1cCh0dXJucyk7XG4gICAgY29uc3QgYWRqdXN0bWVudCA9IHBsYWNlbWVudERhdGFbdHVybnNTdHJdO1xuXG4gICAgaWYgKCFhZGp1c3RtZW50KSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIGBObyBhZGp1c3RtZW50IGZvciB0dXJuczogJHt0dXJuc1N0cn0gaW4gcGxhY2VtZW50OiAke3BsYWNlbWVudEtleX1gXG4gICAgICApO1xuICAgICAgcmV0dXJuIHsgeDogMCwgeTogMCB9O1xuICAgIH1cblxuICAgIGNvbnN0IFt4LCB5XSA9IGFkanVzdG1lbnQ7XG4gICAgcmV0dXJuIHsgeCwgeSB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhdmFpbGFibGUgcGxhY2VtZW50IGtleXMgZm9yIGEgbW90aW9uIHR5cGVcbiAgICovXG4gIGFzeW5jIGdldEF2YWlsYWJsZVBsYWNlbWVudEtleXMoXG4gICAgbW90aW9uVHlwZTogTW90aW9uVHlwZSxcbiAgICBncmlkTW9kZTogR3JpZE1vZGUgPSBHcmlkTW9kZS5ESUFNT05EXG4gICk6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBhd2FpdCB0aGlzLmVuc3VyZURhdGFMb2FkZWQoKTtcblxuICAgIGNvbnN0IG1vdGlvblBsYWNlbWVudHMgPSB0aGlzLmFsbFBsYWNlbWVudHNbZ3JpZE1vZGVdPy5bbW90aW9uVHlwZV07XG4gICAgaWYgKCFtb3Rpb25QbGFjZW1lbnRzKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKG1vdGlvblBsYWNlbWVudHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGRhdGEgaXMgbG9hZGVkXG4gICAqL1xuICBpc0xvYWRlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5pc0RhdGFMb2FkZWQ7XG4gIH1cblxuICAvKipcbiAgICogRW5zdXJlIGRhdGEgaXMgbG9hZGVkIGJlZm9yZSBvcGVyYXRpb25zXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGVuc3VyZURhdGFMb2FkZWQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmlzRGF0YUxvYWRlZCkge1xuICAgICAgYXdhaXQgdGhpcy5sb2FkUGxhY2VtZW50RGF0YSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBGb3JtYXQgdHVybnMgdmFsdWUgZm9yIEpTT04gbG9va3VwXG4gICAqIENvbnZlcnRzOiAxLjAg4oaSIFwiMVwiLCAwLjUg4oaSIFwiMC41XCIsIGV0Yy5cbiAgICovXG4gIHByaXZhdGUgZm9ybWF0VHVybnNGb3JMb29rdXAodHVybnM6IG51bWJlciB8IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKHR5cGVvZiB0dXJucyA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIHR1cm5zOyAvLyBBbHJlYWR5IGZvcm1hdHRlZCAoZS5nLiwgXCJmbFwiIGZvciBmbG9hdClcbiAgICB9XG5cbiAgICAvLyBDb252ZXJ0IG51bWJlcnM6IHJlbW92ZSAuMCBmb3Igd2hvbGUgbnVtYmVyc1xuICAgIGlmICh0dXJucyA9PT0gTWF0aC5mbG9vcih0dXJucykpIHtcbiAgICAgIHJldHVybiBNYXRoLmZsb29yKHR1cm5zKS50b1N0cmluZygpO1xuICAgIH1cblxuICAgIHJldHVybiB0dXJucy50b1N0cmluZygpO1xuICB9XG5cbiAgLyoqXG4gICAqIERlYnVnIG1ldGhvZCB0byBsb2cgYXZhaWxhYmxlIGtleXNcbiAgICovXG4gIGFzeW5jIGRlYnVnQXZhaWxhYmxlS2V5cyhcbiAgICBtb3Rpb25UeXBlOiBNb3Rpb25UeXBlLFxuICAgIGdyaWRNb2RlOiBHcmlkTW9kZSA9IEdyaWRNb2RlLkRJQU1PTkRcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qga2V5cyA9IGF3YWl0IHRoaXMuZ2V0QXZhaWxhYmxlUGxhY2VtZW50S2V5cyhtb3Rpb25UeXBlLCBncmlkTW9kZSk7XG4gICAgY29uc29sZS5sb2coXG4gICAgICBgQXZhaWxhYmxlIHBsYWNlbWVudCBrZXlzIGZvciAke21vdGlvblR5cGV9ICgke2dyaWRNb2RlfSk6YCxcbiAgICAgIGtleXNcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCByYXcgcGxhY2VtZW50IGRhdGEgZm9yIGRlYnVnZ2luZ1xuICAgKi9cbiAgYXN5bmMgZ2V0UGxhY2VtZW50RGF0YShcbiAgICBtb3Rpb25UeXBlOiBNb3Rpb25UeXBlLFxuICAgIHBsYWNlbWVudEtleTogc3RyaW5nLFxuICAgIGdyaWRNb2RlOiBHcmlkTW9kZSA9IEdyaWRNb2RlLkRJQU1PTkRcbiAgKTogUHJvbWlzZTx7IFt0dXJuczogc3RyaW5nXTogW251bWJlciwgbnVtYmVyXSB9PiB7XG4gICAgYXdhaXQgdGhpcy5lbnN1cmVEYXRhTG9hZGVkKCk7XG5cbiAgICBjb25zdCBtb3Rpb25QbGFjZW1lbnRzID0gdGhpcy5hbGxQbGFjZW1lbnRzW2dyaWRNb2RlXT8uW21vdGlvblR5cGVdO1xuICAgIHJldHVybiBtb3Rpb25QbGFjZW1lbnRzPy5bcGxhY2VtZW50S2V5XSB8fCB7fTtcbiAgfVxufVxuIl0sCiAgIm1hcHBpbmdzIjogIkFBT0EsU0FBUyxVQUFVLGtCQUFrQjtBQUNyQyxTQUFTLGlCQUFpQjtBQW9DbkIsYUFBTSxzQkFBd0Q7QUFBQSxFQUMzRCxnQkFBa0M7QUFBQSxJQUN4QyxDQUFDLFNBQVMsT0FBTyxHQUFHLENBQUM7QUFBQSxJQUNyQixDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUM7QUFBQSxFQUNuQjtBQUFBLEVBRVEsZUFBZTtBQUFBO0FBQUEsRUFHTixpQkFBeUQ7QUFBQSxJQUN4RSxDQUFDLFNBQVMsT0FBTyxHQUFHO0FBQUEsTUFDbEIs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
