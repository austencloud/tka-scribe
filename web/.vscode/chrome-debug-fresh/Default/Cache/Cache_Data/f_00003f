export class DeleteService {
  async prepareDeleteConfirmation(sequence, allSequences) {
    const relatedSequences = this.findRelatedSequences(sequence, allSequences);
    const hasVariations = relatedSequences.length > 0;
    const willFixVariationNumbers = hasVariations && this.needsVariationNumberFix(sequence, relatedSequences);
    return {
      sequence,
      relatedSequences,
      hasVariations,
      willFixVariationNumbers
    };
  }
  async deleteSequence(sequenceOrId, allSequences) {
    try {
      const sequence = typeof sequenceOrId === "string" ? allSequences.find((seq) => seq.id === sequenceOrId) : sequenceOrId;
      if (!sequence) {
        return {
          success: false,
          deletedSequence: null,
          affectedSequences: [],
          error: "Sequence not found"
        };
      }
      const canDelete = await this.canDeleteSequence(sequence, allSequences);
      if (!canDelete) {
        return {
          success: false,
          deletedSequence: null,
          affectedSequences: [],
          error: "Sequence cannot be deleted"
        };
      }
      const affectedSequences = await this.getAffectedSequences(
        sequence,
        allSequences
      );
      const updatedSequences = await this.fixVariationNumbers(
        sequence,
        allSequences
      );
      console.log(`Deleting sequence: ${sequence.word} (${sequence.id})`);
      const remainingSequences = updatedSequences.filter(
        (seq) => seq.id !== sequence.id
      );
      return {
        success: true,
        deletedSequence: sequence,
        affectedSequences: remainingSequences.filter(
          (seq) => affectedSequences.some((affected) => affected.id === seq.id)
        )
      };
    } catch (error) {
      return {
        success: false,
        deletedSequence: null,
        affectedSequences: [],
        error: error instanceof Error ? error.message : "Unknown error occurred"
      };
    }
  }
  async fixVariationNumbers(deletedSequence, allSequences) {
    const baseWord = this.extractBaseWord(deletedSequence.word);
    const deletedVariation = this.extractVariationNumber(deletedSequence.word);
    if (!deletedVariation) {
      return allSequences;
    }
    const updatedSequences = allSequences.map((sequence) => {
      if (sequence.id === deletedSequence.id) {
        return sequence;
      }
      const sequenceBaseWord = this.extractBaseWord(sequence.word);
      const sequenceVariation = this.extractVariationNumber(sequence.word);
      if (sequenceBaseWord === baseWord && sequenceVariation && sequenceVariation > deletedVariation) {
        const newVariationNumber = sequenceVariation - 1;
        const newWord = this.createWordWithVariation(
          baseWord,
          newVariationNumber
        );
        return {
          ...sequence,
          word: newWord,
          name: sequence.name.replace(sequence.word, newWord)
        };
      }
      return sequence;
    });
    return updatedSequences;
  }
  async canDeleteSequence(sequence, _allSequences) {
    const isProtected = sequence.metadata?.isProtected;
    const isSystem = sequence.metadata?.isSystem;
    if (isProtected || isSystem) {
      return false;
    }
    if (sequence.author && sequence.author !== "current-user") {
      return true;
    }
    return true;
  }
  async getAffectedSequences(sequence, allSequences) {
    const affected = [];
    const baseWord = this.extractBaseWord(sequence.word);
    const deletedVariation = this.extractVariationNumber(sequence.word);
    if (!deletedVariation) {
      return affected;
    }
    allSequences.forEach((seq) => {
      if (seq.id === sequence.id) return;
      const seqBaseWord = this.extractBaseWord(seq.word);
      const seqVariation = this.extractVariationNumber(seq.word);
      if (seqBaseWord === baseWord && seqVariation && seqVariation > deletedVariation) {
        affected.push(seq);
      }
    });
    return affected;
  }
  // Private helper methods
  findRelatedSequences(sequence, allSequences) {
    const baseWord = this.extractBaseWord(sequence.word);
    return allSequences.filter((seq) => {
      if (seq.id === sequence.id) return false;
      const seqBaseWord = this.extractBaseWord(seq.word);
      return seqBaseWord === baseWord;
    });
  }
  needsVariationNumberFix(deletedSequence, relatedSequences) {
    const deletedVariation = this.extractVariationNumber(deletedSequence.word);
    if (!deletedVariation) return false;
    return relatedSequences.some((seq) => {
      const variation = this.extractVariationNumber(seq.word);
      return variation && variation > deletedVariation;
    });
  }
  extractBaseWord(word) {
    const match = word.match(/^([A-Z]+)(?:[_-]v?(\d+))?$/i);
    return match && match[1] ? match[1] : word;
  }
  extractVariationNumber(word) {
    const match = word.match(/[_-]v?(\d+)$/i);
    return match && match[1] ? parseInt(match[1]) : null;
  }
  createWordWithVariation(baseWord, variation) {
    if (variation <= 1) {
      return baseWord;
    }
    return `${baseWord}_v${variation}`;
  }
  // Utility methods for UI components
  async formatDeleteConfirmationMessage(data) {
    const {
      sequence,
      relatedSequences,
      hasVariations,
      willFixVariationNumbers
    } = data;
    let message = `Are you sure you want to delete "${sequence.word}"?`;
    if (hasVariations) {
      message += `

This sequence has ${relatedSequences.length} related variation(s).`;
      if (willFixVariationNumbers) {
        message += "\nVariation numbers will be automatically updated to maintain sequence.";
      }
    }
    message += "\n\nThis action cannot be undone.";
    return message;
  }
  async getDeleteButtonText(data) {
    if (data.willFixVariationNumbers) {
      return "Delete & Fix Variations";
    }
    return "Delete Sequence";
  }
}
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiQzovVEtBL3dlYi9zcmMvbGliL3NlcnZpY2VzL2ltcGxlbWVudGF0aW9ucy9zZXF1ZW5jZS9EZWxldGVTZXJ2aWNlLnRzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWyIvKipcbiAqIERlbGV0ZSBTZXJ2aWNlIC0gTWFuYWdlcyBzZXF1ZW5jZSBkZWxldGlvbiBvcGVyYXRpb25zXG4gKlxuICogSGFuZGxlcyBzZXF1ZW5jZSBkZWxldGlvbiB3aXRoIGNvbmZpcm1hdGlvbiwgdmFyaWF0aW9uIG51bWJlciBmaXhpbmcsXG4gKiBhbmQgY2xlYW51cCBvcGVyYXRpb25zIGZvbGxvd2luZyB0aGUgbWljcm9zZXJ2aWNlcyBhcmNoaXRlY3R1cmUgcGF0dGVybi5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7IFNlcXVlbmNlRGF0YSB9IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL2RvbWFpbi10eXBlc1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIERlbGV0ZVJlc3VsdCB7XG4gIHN1Y2Nlc3M6IGJvb2xlYW47XG4gIGRlbGV0ZWRTZXF1ZW5jZTogU2VxdWVuY2VEYXRhIHwgbnVsbDtcbiAgYWZmZWN0ZWRTZXF1ZW5jZXM6IFNlcXVlbmNlRGF0YVtdO1xuICBlcnJvcj86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEZWxldGVDb25maXJtYXRpb25EYXRhIHtcbiAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YTtcbiAgcmVsYXRlZFNlcXVlbmNlczogU2VxdWVuY2VEYXRhW107XG4gIGhhc1ZhcmlhdGlvbnM6IGJvb2xlYW47XG4gIHdpbGxGaXhWYXJpYXRpb25OdW1iZXJzOiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElEZWxldGVTZXJ2aWNlIHtcbiAgLyoqIFByZXBhcmUgZGVsZXRpb24gZGF0YSBmb3IgY29uZmlybWF0aW9uIGRpYWxvZyAqL1xuICBwcmVwYXJlRGVsZXRlQ29uZmlybWF0aW9uKFxuICAgIHNlcXVlbmNlOiBTZXF1ZW5jZURhdGEsXG4gICAgYWxsU2VxdWVuY2VzOiBTZXF1ZW5jZURhdGFbXVxuICApOiBQcm9taXNlPERlbGV0ZUNvbmZpcm1hdGlvbkRhdGE+O1xuXG4gIC8qKiBEZWxldGUgc2VxdWVuY2UgYW5kIGhhbmRsZSBjbGVhbnVwICovXG4gIGRlbGV0ZVNlcXVlbmNlKFxuICAgIHNlcXVlbmNlSWQ6IHN0cmluZyxcbiAgICBhbGxTZXF1ZW5jZXM6IFNlcXVlbmNlRGF0YVtdXG4gICk6IFByb21pc2U8RGVsZXRlUmVzdWx0PjtcblxuICAvKiogRml4IHZhcmlhdGlvbiBudW1iZXJzIGFmdGVyIGRlbGV0aW9uICovXG4gIGZpeFZhcmlhdGlvbk51bWJlcnMoXG4gICAgZGVsZXRlZFNlcXVlbmNlOiBTZXF1ZW5jZURhdGEsXG4gICAgYWxsU2VxdWVuY2VzOiBTZXF1ZW5jZURhdGFbXVxuICApOiBQcm9taXNlPFNlcXVlbmNlRGF0YVtdPjtcblxuICAvKiogQ2hlY2sgaWYgc2VxdWVuY2UgY2FuIGJlIHNhZmVseSBkZWxldGVkICovXG4gIGNhbkRlbGV0ZVNlcXVlbmNlKFxuICAgIHNlcXVlbmNlOiBTZXF1ZW5jZURhdGEsXG4gICAgYWxsU2VxdWVuY2VzOiBTZXF1ZW5jZURhdGFbXVxuICApOiBQcm9taXNlPGJvb2xlYW4+O1xuXG4gIC8qKiBHZXQgc2VxdWVuY2VzIHRoYXQgd291bGQgYmUgYWZmZWN0ZWQgYnkgZGVsZXRpb24gKi9cbiAgZ2V0QWZmZWN0ZWRTZXF1ZW5jZXMoXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBhbGxTZXF1ZW5jZXM6IFNlcXVlbmNlRGF0YVtdXG4gICk6IFByb21pc2U8U2VxdWVuY2VEYXRhW10+O1xufVxuXG5leHBvcnQgY2xhc3MgRGVsZXRlU2VydmljZSBpbXBsZW1lbnRzIElEZWxldGVTZXJ2aWNlIHtcbiAgYXN5bmMgcHJlcGFyZURlbGV0ZUNvbmZpcm1hdGlvbihcbiAgICBzZXF1ZW5jZTogU2VxdWVuY2VEYXRhLFxuICAgIGFsbFNlcXVlbmNlczogU2VxdWVuY2VEYXRhW11cbiAgKTogUHJvbWlzZTxEZWxldGVDb25maXJtYXRpb25EYXRhPiB7XG4gICAgY29uc3QgcmVsYXRlZFNlcXVlbmNlcyA9IHRoaXMuZmluZFJlbGF0ZWRTZXF1ZW5jZXMoc2VxdWVuY2UsIGFsbFNlcXVlbmNlcyk7XG4gICAgY29uc3QgaGFzVmFyaWF0aW9ucyA9IHJlbGF0ZWRTZXF1ZW5jZXMubGVuZ3RoID4gMDtcbiAgICBjb25zdCB3aWxsRml4VmFyaWF0aW9uTnVtYmVycyA9XG4gICAgICBoYXNWYXJpYXRpb25zICYmIHRoaXMubmVlZHNWYXJpYXRpb25OdW1iZXJGaXgoc2VxdWVuY2UsIHJlbGF0ZWRTZXF1ZW5jZXMpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHNlcXVlbmNlLFxuICAgICAgcmVsYXRlZFNlcXVlbmNlcyxcbiAgICAgIGhhc1ZhcmlhdGlvbnMsXG4gICAgICB3aWxsRml4VmFyaWF0aW9uTnVtYmVycyxcbiAgICB9O1xuICB9XG5cbiAgLy8gT3ZlcmxvYWQgdG8gbWF0Y2ggaW50ZXJmYWNlIHNpZ25hdHVyZVxuICBhc3luYyBkZWxldGVTZXF1ZW5jZShcbiAgICBzZXF1ZW5jZTogU2VxdWVuY2VEYXRhLFxuICAgIGFsbFNlcXVlbmNlczogU2VxdWVuY2VEYXRhW11cbiAgKTogUHJvbWlzZTxEZWxldGVSZXN1bHQ+O1xuICBhc3luYyBkZWxldGVTZXF1ZW5jZShcbiAgICBzZXF1ZW5jZUlkOiBzdHJpbmcsXG4gICAgYWxsU2VxdWVuY2VzOiBTZXF1ZW5jZURhdGFbXVxuICApOiBQcm9taXNlPERlbGV0ZVJlc3VsdD47XG4gIGFzeW5jIGRlbGV0ZVNlcXVlbmNlKFxuICAgIHNlcXVlbmNlT3JJZDogc3RyaW5nIHwgU2VxdWVuY2VEYXRhLFxuICAgIGFsbFNlcXVlbmNlczogU2VxdWVuY2VEYXRhW11cbiAgKTogUHJvbWlzZTxEZWxldGVSZXN1bHQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2VxdWVuY2UgPVxuICAgICAgICB0eXBlb2Ygc2VxdWVuY2VPcklkID09PSBcInN0cmluZ1wiXG4gICAgICAgICAgPyBhbGxTZXF1ZW5jZXMuZmluZCgoc2VxKSA9PiBzZXEuaWQgPT09IHNlcXVlbmNlT3JJZClcbiAgICAgICAgICA6IHNlcXVlbmNlT3JJZDtcbiAgICAgIGlmICghc2VxdWVuY2UpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBkZWxldGVkU2VxdWVuY2U6IG51bGwsXG4gICAgICAgICAgYWZmZWN0ZWRTZXF1ZW5jZXM6IFtdLFxuICAgICAgICAgIGVycm9yOiBcIlNlcXVlbmNlIG5vdCBmb3VuZFwiLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiBkZWxldGlvbiBpcyBhbGxvd2VkXG4gICAgICBjb25zdCBjYW5EZWxldGUgPSBhd2FpdCB0aGlzLmNhbkRlbGV0ZVNlcXVlbmNlKHNlcXVlbmNlLCBhbGxTZXF1ZW5jZXMpO1xuICAgICAgaWYgKCFjYW5EZWxldGUpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBkZWxldGVkU2VxdWVuY2U6IG51bGwsXG4gICAgICAgICAgYWZmZWN0ZWRTZXF1ZW5jZXM6IFtdLFxuICAgICAgICAgIGVycm9yOiBcIlNlcXVlbmNlIGNhbm5vdCBiZSBkZWxldGVkXCIsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCBhZmZlY3RlZCBzZXF1ZW5jZXMgYmVmb3JlIGRlbGV0aW9uXG4gICAgICBjb25zdCBhZmZlY3RlZFNlcXVlbmNlcyA9IGF3YWl0IHRoaXMuZ2V0QWZmZWN0ZWRTZXF1ZW5jZXMoXG4gICAgICAgIHNlcXVlbmNlLFxuICAgICAgICBhbGxTZXF1ZW5jZXNcbiAgICAgICk7XG5cbiAgICAgIC8vIEZpeCB2YXJpYXRpb24gbnVtYmVycyBpZiBuZWVkZWRcbiAgICAgIGNvbnN0IHVwZGF0ZWRTZXF1ZW5jZXMgPSBhd2FpdCB0aGlzLmZpeFZhcmlhdGlvbk51bWJlcnMoXG4gICAgICAgIHNlcXVlbmNlLFxuICAgICAgICBhbGxTZXF1ZW5jZXNcbiAgICAgICk7XG5cbiAgICAgIC8vIEluIGEgcmVhbCBpbXBsZW1lbnRhdGlvbiwgdGhpcyB3b3VsZCBjYWxsIHRoZSBwZXJzaXN0ZW5jZSBzZXJ2aWNlXG4gICAgICAvLyBGb3Igbm93LCB3ZSdsbCBzaW11bGF0ZSB0aGUgZGVsZXRpb25cbiAgICAgIGNvbnNvbGUubG9nKGBEZWxldGluZyBzZXF1ZW5jZTogJHtzZXF1ZW5jZS53b3JkfSAoJHtzZXF1ZW5jZS5pZH0pYCk7XG5cbiAgICAgIC8vIFJlbW92ZSB0aGUgc2VxdWVuY2UgZnJvbSB0aGUgbGlzdFxuICAgICAgY29uc3QgcmVtYWluaW5nU2VxdWVuY2VzID0gdXBkYXRlZFNlcXVlbmNlcy5maWx0ZXIoXG4gICAgICAgIChzZXEpID0+IHNlcS5pZCAhPT0gc2VxdWVuY2UuaWRcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRlbGV0ZWRTZXF1ZW5jZTogc2VxdWVuY2UsXG4gICAgICAgIGFmZmVjdGVkU2VxdWVuY2VzOiByZW1haW5pbmdTZXF1ZW5jZXMuZmlsdGVyKChzZXEpID0+XG4gICAgICAgICAgYWZmZWN0ZWRTZXF1ZW5jZXMuc29tZSgoYWZmZWN0ZWQpID0+IGFmZmVjdGVkLmlkID09PSBzZXEuaWQpXG4gICAgICAgICksXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZGVsZXRlZFNlcXVlbmNlOiBudWxsLFxuICAgICAgICBhZmZlY3RlZFNlcXVlbmNlczogW10sXG4gICAgICAgIGVycm9yOlxuICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yIG9jY3VycmVkXCIsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZpeFZhcmlhdGlvbk51bWJlcnMoXG4gICAgZGVsZXRlZFNlcXVlbmNlOiBTZXF1ZW5jZURhdGEsXG4gICAgYWxsU2VxdWVuY2VzOiBTZXF1ZW5jZURhdGFbXVxuICApOiBQcm9taXNlPFNlcXVlbmNlRGF0YVtdPiB7XG4gICAgY29uc3QgYmFzZVdvcmQgPSB0aGlzLmV4dHJhY3RCYXNlV29yZChkZWxldGVkU2VxdWVuY2Uud29yZCk7XG4gICAgY29uc3QgZGVsZXRlZFZhcmlhdGlvbiA9IHRoaXMuZXh0cmFjdFZhcmlhdGlvbk51bWJlcihkZWxldGVkU2VxdWVuY2Uud29yZCk7XG5cbiAgICBpZiAoIWRlbGV0ZWRWYXJpYXRpb24pIHtcbiAgICAgIHJldHVybiBhbGxTZXF1ZW5jZXM7IC8vIE5vIHZhcmlhdGlvbiBudW1iZXIgdG8gZml4XG4gICAgfVxuXG4gICAgY29uc3QgdXBkYXRlZFNlcXVlbmNlcyA9IGFsbFNlcXVlbmNlcy5tYXAoKHNlcXVlbmNlKSA9PiB7XG4gICAgICAvLyBTa2lwIHRoZSBzZXF1ZW5jZSBiZWluZyBkZWxldGVkXG4gICAgICBpZiAoc2VxdWVuY2UuaWQgPT09IGRlbGV0ZWRTZXF1ZW5jZS5pZCkge1xuICAgICAgICByZXR1cm4gc2VxdWVuY2U7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNlcXVlbmNlQmFzZVdvcmQgPSB0aGlzLmV4dHJhY3RCYXNlV29yZChzZXF1ZW5jZS53b3JkKTtcbiAgICAgIGNvbnN0IHNlcXVlbmNlVmFyaWF0aW9uID0gdGhpcy5leHRyYWN0VmFyaWF0aW9uTnVtYmVyKHNlcXVlbmNlLndvcmQpO1xuXG4gICAgICAvLyBPbmx5IGZpeCBzZXF1ZW5jZXMgd2l0aCB0aGUgc2FtZSBiYXNlIHdvcmQgYW5kIGhpZ2hlciB2YXJpYXRpb24gbnVtYmVyc1xuICAgICAgaWYgKFxuICAgICAgICBzZXF1ZW5jZUJhc2VXb3JkID09PSBiYXNlV29yZCAmJlxuICAgICAgICBzZXF1ZW5jZVZhcmlhdGlvbiAmJlxuICAgICAgICBzZXF1ZW5jZVZhcmlhdGlvbiA+IGRlbGV0ZWRWYXJpYXRpb25cbiAgICAgICkge1xuICAgICAgICBjb25zdCBuZXdWYXJpYXRpb25OdW1iZXIgPSBzZXF1ZW5jZVZhcmlhdGlvbiAtIDE7XG4gICAgICAgIGNvbnN0IG5ld1dvcmQgPSB0aGlzLmNyZWF0ZVdvcmRXaXRoVmFyaWF0aW9uKFxuICAgICAgICAgIGJhc2VXb3JkLFxuICAgICAgICAgIG5ld1ZhcmlhdGlvbk51bWJlclxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgLi4uc2VxdWVuY2UsXG4gICAgICAgICAgd29yZDogbmV3V29yZCxcbiAgICAgICAgICBuYW1lOiBzZXF1ZW5jZS5uYW1lLnJlcGxhY2Uoc2VxdWVuY2Uud29yZCwgbmV3V29yZCksXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBzZXF1ZW5jZTtcbiAgICB9KTtcblxuICAgIHJldHVybiB1cGRhdGVkU2VxdWVuY2VzO1xuICB9XG5cbiAgYXN5bmMgY2FuRGVsZXRlU2VxdWVuY2UoXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBfYWxsU2VxdWVuY2VzOiBTZXF1ZW5jZURhdGFbXVxuICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAvLyBDaGVjayBpZiB0aGlzIGlzIGEgc3lzdGVtIG9yIHByb3RlY3RlZCBzZXF1ZW5jZSAoY2hlY2sgbWV0YWRhdGEpXG4gICAgY29uc3QgaXNQcm90ZWN0ZWQgPSBzZXF1ZW5jZS5tZXRhZGF0YT8uaXNQcm90ZWN0ZWQgYXMgYm9vbGVhbjtcbiAgICBjb25zdCBpc1N5c3RlbSA9IHNlcXVlbmNlLm1ldGFkYXRhPy5pc1N5c3RlbSBhcyBib29sZWFuO1xuXG4gICAgaWYgKGlzUHJvdGVjdGVkIHx8IGlzU3lzdGVtKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBoYXMgcGVybWlzc2lvbiB0byBkZWxldGUgKHdvdWxkIGJlIGJhc2VkIG9uIGF1dGhvcnNoaXAgaW4gcmVhbCBhcHApXG4gICAgaWYgKHNlcXVlbmNlLmF1dGhvciAmJiBzZXF1ZW5jZS5hdXRob3IgIT09IFwiY3VycmVudC11c2VyXCIpIHtcbiAgICAgIC8vIEluIGEgcmVhbCBhcHAsIHRoaXMgd291bGQgY2hlY2sgdXNlciBwZXJtaXNzaW9uc1xuICAgICAgLy8gRm9yIG5vdywgYWxsb3cgZGVsZXRpb24gb2YgZGVtbyBzZXF1ZW5jZXNcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgZ2V0QWZmZWN0ZWRTZXF1ZW5jZXMoXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBhbGxTZXF1ZW5jZXM6IFNlcXVlbmNlRGF0YVtdXG4gICk6IFByb21pc2U8U2VxdWVuY2VEYXRhW10+IHtcbiAgICBjb25zdCBhZmZlY3RlZDogU2VxdWVuY2VEYXRhW10gPSBbXTtcbiAgICBjb25zdCBiYXNlV29yZCA9IHRoaXMuZXh0cmFjdEJhc2VXb3JkKHNlcXVlbmNlLndvcmQpO1xuICAgIGNvbnN0IGRlbGV0ZWRWYXJpYXRpb24gPSB0aGlzLmV4dHJhY3RWYXJpYXRpb25OdW1iZXIoc2VxdWVuY2Uud29yZCk7XG5cbiAgICBpZiAoIWRlbGV0ZWRWYXJpYXRpb24pIHtcbiAgICAgIHJldHVybiBhZmZlY3RlZDtcbiAgICB9XG5cbiAgICAvLyBGaW5kIHNlcXVlbmNlcyB0aGF0IHdpbGwgaGF2ZSB0aGVpciB2YXJpYXRpb24gbnVtYmVycyBhZGp1c3RlZFxuICAgIGFsbFNlcXVlbmNlcy5mb3JFYWNoKChzZXEpID0+IHtcbiAgICAgIGlmIChzZXEuaWQgPT09IHNlcXVlbmNlLmlkKSByZXR1cm47XG5cbiAgICAgIGNvbnN0IHNlcUJhc2VXb3JkID0gdGhpcy5leHRyYWN0QmFzZVdvcmQoc2VxLndvcmQpO1xuICAgICAgY29uc3Qgc2VxVmFyaWF0aW9uID0gdGhpcy5leHRyYWN0VmFyaWF0aW9uTnVtYmVyKHNlcS53b3JkKTtcblxuICAgICAgaWYgKFxuICAgICAgICBzZXFCYXNlV29yZCA9PT0gYmFzZVdvcmQgJiZcbiAgICAgICAgc2VxVmFyaWF0aW9uICYmXG4gICAgICAgIHNlcVZhcmlhdGlvbiA+IGRlbGV0ZWRWYXJpYXRpb25cbiAgICAgICkge1xuICAgICAgICBhZmZlY3RlZC5wdXNoKHNlcSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gYWZmZWN0ZWQ7XG4gIH1cblxuICAvLyBQcml2YXRlIGhlbHBlciBtZXRob2RzXG4gIHByaXZhdGUgZmluZFJlbGF0ZWRTZXF1ZW5jZXMoXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBhbGxTZXF1ZW5jZXM6IFNlcXVlbmNlRGF0YVtdXG4gICk6IFNlcXVlbmNlRGF0YVtdIHtcbiAgICBjb25zdCBiYXNlV29yZCA9IHRoaXMuZXh0cmFjdEJhc2VXb3JkKHNlcXVlbmNlLndvcmQpO1xuXG4gICAgcmV0dXJuIGFsbFNlcXVlbmNlcy5maWx0ZXIoKHNlcSkgPT4ge1xuICAgICAgaWYgKHNlcS5pZCA9PT0gc2VxdWVuY2UuaWQpIHJldHVybiBmYWxzZTtcbiAgICAgIGNvbnN0IHNlcUJhc2VXb3JkID0gdGhpcy5leHRyYWN0QmFzZVdvcmQoc2VxLndvcmQpO1xuICAgICAgcmV0dXJuIHNlcUJhc2VXb3JkID09PSBiYXNlV29yZDtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgbmVlZHNWYXJpYXRpb25OdW1iZXJGaXgoXG4gICAgZGVsZXRlZFNlcXVlbmNlOiBTZXF1ZW5jZURhdGEsXG4gICAgcmVsYXRlZFNlcXVlbmNlczogU2VxdWVuY2VEYXRhW11cbiAgKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZGVsZXRlZFZhcmlhdGlvbiA9IHRoaXMuZXh0cmFjdFZhcmlhdGlvbk51bWJlcihkZWxldGVkU2VxdWVuY2Uud29yZCk7XG4gICAgaWYgKCFkZWxldGVkVmFyaWF0aW9uKSByZXR1cm4gZmFsc2U7XG5cbiAgICAvLyBDaGVjayBpZiB0aGVyZSBhcmUgc2VxdWVuY2VzIHdpdGggaGlnaGVyIHZhcmlhdGlvbiBudW1iZXJzXG4gICAgcmV0dXJuIHJlbGF0ZWRTZXF1ZW5jZXMuc29tZSgoc2VxKSA9PiB7XG4gICAgICBjb25zdCB2YXJpYXRpb24gPSB0aGlzLmV4dHJhY3RWYXJpYXRpb25OdW1iZXIoc2VxLndvcmQpO1xuICAgICAgcmV0dXJuIHZhcmlhdGlvbiAmJiB2YXJpYXRpb24gPiBkZWxldGVkVmFyaWF0aW9uO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBleHRyYWN0QmFzZVdvcmQod29yZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBFeHRyYWN0IGJhc2Ugd29yZCBmcm9tIHZhcmlhdGlvbnMgbGlrZSBcIkNBS0VfdjJcIiBvciBcIkFCQy0yXCJcbiAgICBjb25zdCBtYXRjaCA9IHdvcmQubWF0Y2goL14oW0EtWl0rKSg/OltfLV12PyhcXGQrKSk/JC9pKTtcbiAgICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2hbMV0gPyBtYXRjaFsxXSA6IHdvcmQ7XG4gIH1cblxuICBwcml2YXRlIGV4dHJhY3RWYXJpYXRpb25OdW1iZXIod29yZDogc3RyaW5nKTogbnVtYmVyIHwgbnVsbCB7XG4gICAgLy8gRXh0cmFjdCB2YXJpYXRpb24gbnVtYmVyIGZyb20gd29yZHMgbGlrZSBcIkNBS0VfdjJcIiBvciBcIkFCQy0yXCJcbiAgICBjb25zdCBtYXRjaCA9IHdvcmQubWF0Y2goL1tfLV12PyhcXGQrKSQvaSk7XG4gICAgcmV0dXJuIG1hdGNoICYmIG1hdGNoWzFdID8gcGFyc2VJbnQobWF0Y2hbMV0pIDogbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlV29yZFdpdGhWYXJpYXRpb24oYmFzZVdvcmQ6IHN0cmluZywgdmFyaWF0aW9uOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGlmICh2YXJpYXRpb24gPD0gMSkge1xuICAgICAgcmV0dXJuIGJhc2VXb3JkO1xuICAgIH1cbiAgICByZXR1cm4gYCR7YmFzZVdvcmR9X3Yke3ZhcmlhdGlvbn1gO1xuICB9XG5cbiAgLy8gVXRpbGl0eSBtZXRob2RzIGZvciBVSSBjb21wb25lbnRzXG4gIGFzeW5jIGZvcm1hdERlbGV0ZUNvbmZpcm1hdGlvbk1lc3NhZ2UoXG4gICAgZGF0YTogRGVsZXRlQ29uZmlybWF0aW9uRGF0YVxuICApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IHtcbiAgICAgIHNlcXVlbmNlLFxuICAgICAgcmVsYXRlZFNlcXVlbmNlcyxcbiAgICAgIGhhc1ZhcmlhdGlvbnMsXG4gICAgICB3aWxsRml4VmFyaWF0aW9uTnVtYmVycyxcbiAgICB9ID0gZGF0YTtcblxuICAgIGxldCBtZXNzYWdlID0gYEFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkZWxldGUgXCIke3NlcXVlbmNlLndvcmR9XCI/YDtcblxuICAgIGlmIChoYXNWYXJpYXRpb25zKSB7XG4gICAgICBtZXNzYWdlICs9IGBcXG5cXG5UaGlzIHNlcXVlbmNlIGhhcyAke3JlbGF0ZWRTZXF1ZW5jZXMubGVuZ3RofSByZWxhdGVkIHZhcmlhdGlvbihzKS5gO1xuXG4gICAgICBpZiAod2lsbEZpeFZhcmlhdGlvbk51bWJlcnMpIHtcbiAgICAgICAgbWVzc2FnZSArPVxuICAgICAgICAgIFwiXFxuVmFyaWF0aW9uIG51bWJlcnMgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IHVwZGF0ZWQgdG8gbWFpbnRhaW4gc2VxdWVuY2UuXCI7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbWVzc2FnZSArPSBcIlxcblxcblRoaXMgYWN0aW9uIGNhbm5vdCBiZSB1bmRvbmUuXCI7XG5cbiAgICByZXR1cm4gbWVzc2FnZTtcbiAgfVxuXG4gIGFzeW5jIGdldERlbGV0ZUJ1dHRvblRleHQoZGF0YTogRGVsZXRlQ29uZmlybWF0aW9uRGF0YSk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgaWYgKGRhdGEud2lsbEZpeFZhcmlhdGlvbk51bWJlcnMpIHtcbiAgICAgIHJldHVybiBcIkRlbGV0ZSAmIEZpeCBWYXJpYXRpb25zXCI7XG4gICAgfVxu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
