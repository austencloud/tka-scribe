import {
  addBeatToSequence,
  createSequenceData,
  removeBeatFromSequence,
  updateSequenceData
} from "/src/lib/domain/SequenceData.ts";
export class SequenceStateService {
  // ============================================================================
  // SEQUENCE MANAGEMENT
  // ============================================================================
  createNewSequence(name, length = 16) {
    if (!name.trim()) {
      throw new Error("Sequence name is required");
    }
    if (length < 1 || length > 64) {
      throw new Error("Sequence length must be between 1 and 64 beats");
    }
    const beats = Array.from({ length }, (_, i) => ({
      id: crypto.randomUUID(),
      beatNumber: i + 1,
      duration: 1,
      blueReversal: false,
      redReversal: false,
      isBlank: true,
      pictographData: null
    }));
    return createSequenceData({
      name: name.trim(),
      beats
    });
  }
  validateSequence(sequence) {
    const errors = [];
    const warnings = [];
    if (!sequence.name.trim()) {
      errors.push("Sequence name is required");
    }
    if (sequence.beats.length === 0) {
      warnings.push("Sequence has no beats");
    }
    if (sequence.beats.length > 64) {
      errors.push("Sequence cannot have more than 64 beats");
    }
    sequence.beats.forEach((beat, index) => {
      if (beat.beatNumber !== index + 1) {
        errors.push(
          `Beat ${index + 1} has incorrect beat number: ${beat.beatNumber}`
        );
      }
      if (beat.duration <= 0) {
        errors.push(`Beat ${index + 1} has invalid duration: ${beat.duration}`);
      }
    });
    return {
      isValid: errors.length === 0,
      errors,
      warnings
    };
  }
  // ============================================================================
  // BEAT OPERATIONS
  // ============================================================================
  addBeat(sequence, beatData) {
    const nextBeatNumber = sequence.beats.length + 1;
    const newBeat = {
      id: crypto.randomUUID(),
      beatNumber: nextBeatNumber,
      duration: 1,
      blueReversal: false,
      redReversal: false,
      isBlank: true,
      pictographData: null,
      ...beatData
    };
    return addBeatToSequence(sequence, newBeat);
  }
  removeBeat(sequence, beatIndex) {
    if (!this.isValidBeatIndex(sequence, beatIndex)) {
      return sequence;
    }
    const updatedSequence = removeBeatFromSequence(sequence, beatIndex);
    const renumberedBeats = updatedSequence.beats.map((beat, index) => ({
      ...beat,
      beatNumber: index + 1
    }));
    return updateSequenceData(updatedSequence, {
      beats: renumberedBeats
    });
  }
  updateBeat(sequence, beatIndex, beatData) {
    if (!this.isValidBeatIndex(sequence, beatIndex)) {
      return sequence;
    }
    const updatedBeats = sequence.beats.map(
      (beat, index) => index === beatIndex ? { ...beat, ...beatData } : beat
    );
    return updateSequenceData(sequence, {
      beats: updatedBeats
    });
  }
  insertBeat(sequence, beatIndex, beatData) {
    if (beatIndex < 0 || beatIndex > sequence.beats.length) {
      return sequence;
    }
    const newBeat = {
      id: crypto.randomUUID(),
      beatNumber: beatIndex + 1,
      duration: 1,
      blueReversal: false,
      redReversal: false,
      isBlank: true,
      pictographData: null,
      ...beatData
    };
    const newBeats = [
      ...sequence.beats.slice(0, beatIndex),
      newBeat,
      ...sequence.beats.slice(beatIndex)
    ];
    const renumberedBeats = newBeats.map((beat, index) => ({
      ...beat,
      beatNumber: index + 1
    }));
    return updateSequenceData(sequence, {
      beats: renumberedBeats
    });
  }
  // ============================================================================
  // BEAT SELECTION HELPERS
  // ============================================================================
  isValidBeatIndex(sequence, beatIndex) {
    if (!sequence) return false;
    return beatIndex >= 0 && beatIndex < sequence.beats.length;
  }
  getSelectedBeat(sequence, beatIndex) {
    if (!this.isValidBeatIndex(sequence, beatIndex) || !sequence) {
      return null;
    }
    return sequence.beats[beatIndex];
  }
  // ============================================================================
  // SEQUENCE TRANSFORMATIONS
  // ============================================================================
  clearSequence(sequence) {
    const clearedBeats = sequence.beats.map((beat) => ({
      ...beat,
      isBlank: true,
      pictographData: null,
      blueReversal: false,
      redReversal: false
    }));
    return updateSequenceData(sequence, {
      beats: clearedBeats,
      startingPositionBeat: void 0
    });
  }
  duplicateSequence(sequence, newName) {
    return createSequenceData({
      ...sequence,
      id: crypto.randomUUID(),
      name: newName || `${sequence.name} (Copy)`,
      beats: sequence.beats.map((beat) => ({
        ...beat,
        id: crypto.randomUUID()
      }))
    });
  }
  setStartPosition(sequence, startPosition) {
    return updateSequenceData(sequence, {
      startingPositionBeat: startPosition
    });
  }
  // ============================================================================
  // SEQUENCE OPERATIONS (Placeholder implementations)
  // ============================================================================
  mirrorSequence(sequence) {
    console.warn("mirrorSequence not yet implemented");
    return sequence;
  }
  swapColors(sequence) {
    const swappedBeats = sequence.beats.map((beat) => ({
      ...beat,
      blueReversal: beat.redReversal,
      redReversal: beat.blueReversal
    }));
    return updateSequenceData(sequence, {
      beats: swappedBeats
    });
  }
  rotateSequence(sequence, _direction) {
    console.warn("rotateSequence not yet implemented");
    return sequence;
  }
  // ============================================================================
  // VALIDATION AND UTILITIES
  // ============================================================================
  generateSequenceWord(sequence) {
    const letters = sequence.beats.filter((beat) => beat.pictographData?.letter).map((beat) => beat.pictographData?.letter).filter((letter) => letter !== void 0).join("");
    return letters || sequence.name;
  }
  calculateSequenceDuration(sequence) {
    return sequence.beats.reduce((total, beat) => total + beat.duration, 0);
  }
  getSequenceStatistics(sequence) {
    const totalBeats = sequence.beats.length;
    const blankBeats = sequence.beats.filter((beat) => beat.isBlank).length;
    const filledBeats = totalBeats - blankBeats;
    const totalDuration = this.calculateSequenceDuration(sequence);
    const averageBeatDuration = totalBeats > 0 ? totalDuration / totalBeats : 0;
    const reversalCount = sequence.beats.reduce(
      (acc, beat) => ({
        blue: acc.blue + (beat.blueReversal ? 1 : 0),
        red: acc.red + (beat.redReversal ? 1 : 0)
      }),
      { blue: 0, red: 0 }
    );
    return {
      totalBeats,
      blankBeats,
      filledBeats,
      totalDuration,
      averageBeatDuration,
      hasStartPosition: !!sequence.startingPositionBeat,
      reversalCount
    };
  }
}
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiQzovVEtBL3dlYi9zcmMvbGliL3NlcnZpY2VzL2ltcGxlbWVudGF0aW9ucy9zZXF1ZW5jZS9TZXF1ZW5jZVN0YXRlU2VydmljZS50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiLyoqXG4gKiBQdXJlIFNlcXVlbmNlIFN0YXRlIFNlcnZpY2UgSW1wbGVtZW50YXRpb25cbiAqXG4gKiBFeHRyYWN0ZWQgYnVzaW5lc3MgbG9naWMgZnJvbSBTZXF1ZW5jZVN0YXRlU2VydmljZS5zdmVsdGUudHNcbiAqIENvbnRhaW5zIG9ubHkgcHVyZSBmdW5jdGlvbnMgd2l0aCBubyByZWFjdGl2ZSBzdGF0ZS5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7IEJlYXREYXRhLCBMZXR0ZXIsIFNlcXVlbmNlRGF0YSB9IGZyb20gXCIkbGliL2RvbWFpblwiO1xuaW1wb3J0IHtcbiAgYWRkQmVhdFRvU2VxdWVuY2UsXG4gIGNyZWF0ZVNlcXVlbmNlRGF0YSxcbiAgcmVtb3ZlQmVhdEZyb21TZXF1ZW5jZSxcbiAgdXBkYXRlU2VxdWVuY2VEYXRhLFxufSBmcm9tIFwiJGxpYi9kb21haW4vU2VxdWVuY2VEYXRhXCI7XG5pbXBvcnQgdHlwZSB7XG4gIElTZXF1ZW5jZVN0YXRlU2VydmljZSxcbiAgU2VxdWVuY2VTdGF0aXN0aWNzLFxuICBWYWxpZGF0aW9uUmVzdWx0LFxufSBmcm9tIFwiJGxpYi9zZXJ2aWNlcy9pbnRlcmZhY2VzL3NlcXVlbmNlLXN0YXRlLWludGVyZmFjZXNcIjtcblxuZXhwb3J0IGNsYXNzIFNlcXVlbmNlU3RhdGVTZXJ2aWNlIGltcGxlbWVudHMgSVNlcXVlbmNlU3RhdGVTZXJ2aWNlIHtcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBTRVFVRU5DRSBNQU5BR0VNRU5UXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICBjcmVhdGVOZXdTZXF1ZW5jZShuYW1lOiBzdHJpbmcsIGxlbmd0aDogbnVtYmVyID0gMTYpOiBTZXF1ZW5jZURhdGEge1xuICAgIGlmICghbmFtZS50cmltKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlNlcXVlbmNlIG5hbWUgaXMgcmVxdWlyZWRcIik7XG4gICAgfVxuXG4gICAgaWYgKGxlbmd0aCA8IDEgfHwgbGVuZ3RoID4gNjQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlNlcXVlbmNlIGxlbmd0aCBtdXN0IGJlIGJldHdlZW4gMSBhbmQgNjQgYmVhdHNcIik7XG4gICAgfVxuXG4gICAgY29uc3QgYmVhdHM6IEJlYXREYXRhW10gPSBBcnJheS5mcm9tKHsgbGVuZ3RoIH0sIChfLCBpKSA9PiAoe1xuICAgICAgaWQ6IGNyeXB0by5yYW5kb21VVUlEKCksXG4gICAgICBiZWF0TnVtYmVyOiBpICsgMSxcbiAgICAgIGR1cmF0aW9uOiAxLjAsXG4gICAgICBibHVlUmV2ZXJzYWw6IGZhbHNlLFxuICAgICAgcmVkUmV2ZXJzYWw6IGZhbHNlLFxuICAgICAgaXNCbGFuazogdHJ1ZSxcbiAgICAgIHBpY3RvZ3JhcGhEYXRhOiBudWxsLFxuICAgIH0pKTtcblxuICAgIHJldHVybiBjcmVhdGVTZXF1ZW5jZURhdGEoe1xuICAgICAgbmFtZTogbmFtZS50cmltKCksXG4gICAgICBiZWF0cyxcbiAgICB9KTtcbiAgfVxuXG4gIHZhbGlkYXRlU2VxdWVuY2Uoc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSk6IFZhbGlkYXRpb25SZXN1bHQge1xuICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCB3YXJuaW5nczogc3RyaW5nW10gPSBbXTtcblxuICAgIC8vIEJhc2ljIHZhbGlkYXRpb25cbiAgICBpZiAoIXNlcXVlbmNlLm5hbWUudHJpbSgpKSB7XG4gICAgICBlcnJvcnMucHVzaChcIlNlcXVlbmNlIG5hbWUgaXMgcmVxdWlyZWRcIik7XG4gICAgfVxuXG4gICAgaWYgKHNlcXVlbmNlLmJlYXRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgd2FybmluZ3MucHVzaChcIlNlcXVlbmNlIGhhcyBubyBiZWF0c1wiKTtcbiAgICB9XG5cbiAgICBpZiAoc2VxdWVuY2UuYmVhdHMubGVuZ3RoID4gNjQpIHtcbiAgICAgIGVycm9ycy5wdXNoKFwiU2VxdWVuY2UgY2Fubm90IGhhdmUgbW9yZSB0aGFuIDY0IGJlYXRzXCIpO1xuICAgIH1cblxuICAgIC8vIEJlYXQgdmFsaWRhdGlvblxuICAgIHNlcXVlbmNlLmJlYXRzLmZvckVhY2goKGJlYXQsIGluZGV4KSA9PiB7XG4gICAgICBpZiAoYmVhdC5iZWF0TnVtYmVyICE9PSBpbmRleCArIDEpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgICAgYEJlYXQgJHtpbmRleCArIDF9IGhhcyBpbmNvcnJlY3QgYmVhdCBudW1iZXI6ICR7YmVhdC5iZWF0TnVtYmVyfWBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGJlYXQuZHVyYXRpb24gPD0gMCkge1xuICAgICAgICBlcnJvcnMucHVzaChgQmVhdCAke2luZGV4ICsgMX0gaGFzIGludmFsaWQgZHVyYXRpb246ICR7YmVhdC5kdXJhdGlvbn1gKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBpc1ZhbGlkOiBlcnJvcnMubGVuZ3RoID09PSAwLFxuICAgICAgZXJyb3JzLFxuICAgICAgd2FybmluZ3MsXG4gICAgfTtcbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gQkVBVCBPUEVSQVRJT05TXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICBhZGRCZWF0KHNlcXVlbmNlOiBTZXF1ZW5jZURhdGEsIGJlYXREYXRhPzogUGFydGlhbDxCZWF0RGF0YT4pOiBTZXF1ZW5jZURhdGEge1xuICAgIGNvbnN0IG5leHRCZWF0TnVtYmVyID0gc2VxdWVuY2UuYmVhdHMubGVuZ3RoICsgMTtcblxuICAgIGNvbnN0IG5ld0JlYXQ6IEJlYXREYXRhID0ge1xuICAgICAgaWQ6IGNyeXB0by5yYW5kb21VVUlEKCksXG4gICAgICBiZWF0TnVtYmVyOiBuZXh0QmVhdE51bWJlcixcbiAgICAgIGR1cmF0aW9uOiAxLjAsXG4gICAgICBibHVlUmV2ZXJzYWw6IGZhbHNlLFxuICAgICAgcmVkUmV2ZXJzYWw6IGZhbHNlLFxuICAgICAgaXNCbGFuazogdHJ1ZSxcbiAgICAgIHBpY3RvZ3JhcGhEYXRhOiBudWxsLFxuICAgICAgLi4uYmVhdERhdGEsXG4gICAgfTtcblxuICAgIHJldHVybiBhZGRCZWF0VG9TZXF1ZW5jZShzZXF1ZW5jZSwgbmV3QmVhdCk7XG4gIH1cblxuICByZW1vdmVCZWF0KHNlcXVlbmNlOiBTZXF1ZW5jZURhdGEsIGJlYXRJbmRleDogbnVtYmVyKTogU2VxdWVuY2VEYXRhIHtcbiAgICBpZiAoIXRoaXMuaXNWYWxpZEJlYXRJbmRleChzZXF1ZW5jZSwgYmVhdEluZGV4KSkge1xuICAgICAgcmV0dXJuIHNlcXVlbmNlO1xuICAgIH1cblxuICAgIGNvbnN0IHVwZGF0ZWRTZXF1ZW5jZSA9IHJlbW92ZUJlYXRGcm9tU2VxdWVuY2Uoc2VxdWVuY2UsIGJlYXRJbmRleCk7XG5cbiAgICAvLyBSZW51bWJlciByZW1haW5pbmcgYmVhdHNcbiAgICBjb25zdCByZW51bWJlcmVkQmVhdHMgPSB1cGRhdGVkU2VxdWVuY2UuYmVhdHMubWFwKChiZWF0LCBpbmRleCkgPT4gKHtcbiAgICAgIC4uLmJlYXQsXG4gICAgICBiZWF0TnVtYmVyOiBpbmRleCArIDEsXG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIHVwZGF0ZVNlcXVlbmNlRGF0YSh1cGRhdGVkU2VxdWVuY2UsIHtcbiAgICAgIGJlYXRzOiByZW51bWJlcmVkQmVhdHMsXG4gICAgfSk7XG4gIH1cblxuICB1cGRhdGVCZWF0KFxuICAgIHNlcXVlbmNlOiBTZXF1ZW5jZURhdGEsXG4gICAgYmVhdEluZGV4OiBudW1iZXIsXG4gICAgYmVhdERhdGE6IFBhcnRpYWw8QmVhdERhdGE+XG4gICk6IFNlcXVlbmNlRGF0YSB7XG4gICAgaWYgKCF0aGlzLmlzVmFsaWRCZWF0SW5kZXgoc2VxdWVuY2UsIGJlYXRJbmRleCkpIHtcbiAgICAgIHJldHVybiBzZXF1ZW5jZTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGRhdGVkQmVhdHMgPSBzZXF1ZW5jZS5iZWF0cy5tYXAoKGJlYXQsIGluZGV4KSA9PlxuICAgICAgaW5kZXggPT09IGJlYXRJbmRleCA/IHsgLi4uYmVhdCwgLi4uYmVhdERhdGEgfSA6IGJlYXRcbiAgICApO1xuXG4gICAgcmV0dXJuIHVwZGF0ZVNlcXVlbmNlRGF0YShzZXF1ZW5jZSwge1xuICAgICAgYmVhdHM6IHVwZGF0ZWRCZWF0cyxcbiAgICB9KTtcbiAgfVxuXG4gIGluc2VydEJlYXQoXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBiZWF0SW5kZXg6IG51bWJlcixcbiAgICBiZWF0RGF0YT86IFBhcnRpYWw8QmVhdERhdGE+XG4gICk6IFNlcXVlbmNlRGF0YSB7XG4gICAgaWYgKGJlYXRJbmRleCA8IDAgfHwgYmVhdEluZGV4ID4gc2VxdWVuY2UuYmVhdHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gc2VxdWVuY2U7XG4gICAgfVxuXG4gICAgY29uc3QgbmV3QmVhdDogQmVhdERhdGEgPSB7XG4gICAgICBpZDogY3J5cHRvLnJhbmRvbVVVSUQoKSxcbiAgICAgIGJlYXROdW1iZXI6IGJlYXRJbmRleCArIDEsXG4gICAgICBkdXJhdGlvbjogMS4wLFxuICAgICAgYmx1ZVJldmVyc2FsOiBmYWxzZSxcbiAgICAgIHJlZFJldmVyc2FsOiBmYWxzZSxcbiAgICAgIGlzQmxhbms6IHRydWUsXG4gICAgICBwaWN0b2dyYXBoRGF0YTogbnVsbCxcbiAgICAgIC4uLmJlYXREYXRhLFxuICAgIH07XG5cbiAgICBjb25zdCBuZXdCZWF0cyA9IFtcbiAgICAgIC4uLnNlcXVlbmNlLmJlYXRzLnNsaWNlKDAsIGJlYXRJbmRleCksXG4gICAgICBuZXdCZWF0LFxuICAgICAgLi4uc2VxdWVuY2UuYmVhdHMuc2xpY2UoYmVhdEluZGV4KSxcbiAgICBdO1xuXG4gICAgLy8gUmVudW1iZXIgYWxsIGJlYXRzXG4gICAgY29uc3QgcmVudW1iZXJlZEJlYXRzID0gbmV3QmVhdHMubWFwKChiZWF0LCBpbmRleCkgPT4gKHtcbiAgICAgIC4uLmJlYXQsXG4gICAgICBiZWF0TnVtYmVyOiBpbmRleCArIDEsXG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIHVwZGF0ZVNlcXVlbmNlRGF0YShzZXF1ZW5jZSwge1xuICAgICAgYmVhdHM6IHJlbnVtYmVyZWRCZWF0cyxcbiAgICB9KTtcbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gQkVBVCBTRUxFQ1RJT04gSEVMUEVSU1xuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgaXNWYWxpZEJlYXRJbmRleChzZXF1ZW5jZTogU2VxdWVuY2VEYXRhIHwgbnVsbCwgYmVhdEluZGV4OiBudW1iZXIpOiBib29sZWFuIHtcbiAgICBpZiAoIXNlcXVlbmNlKSByZXR1cm4gZmFsc2U7XG4gICAgcmV0dXJuIGJlYXRJbmRleCA+PSAwICYmIGJlYXRJbmRleCA8IHNlcXVlbmNlLmJlYXRzLmxlbmd0aDtcbiAgfVxuXG4gIGdldFNlbGVjdGVkQmVhdChcbiAgICBzZXF1ZW5jZTogU2VxdWVuY2VEYXRhIHwgbnVsbCxcbiAgICBiZWF0SW5kZXg6IG51bWJlclxuICApOiBCZWF0RGF0YSB8IG51bGwge1xuICAgIGlmICghdGhpcy5pc1ZhbGlkQmVhdEluZGV4KHNlcXVlbmNlLCBiZWF0SW5kZXgpIHx8ICFzZXF1ZW5jZSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiBzZXF1ZW5jZS5iZWF0c1tiZWF0SW5kZXhdO1xuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBTRVFVRU5DRSBUUkFOU0ZPUk1BVElPTlNcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIGNsZWFyU2VxdWVuY2Uoc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSk6IFNlcXVlbmNlRGF0YSB7XG4gICAgY29uc3QgY2xlYXJlZEJlYXRzID0gc2VxdWVuY2UuYmVhdHMubWFwKChiZWF0KSA9PiAoe1xuICAgICAgLi4uYmVhdCxcbiAgICAgIGlzQmxhbms6IHRydWUsXG4gICAgICBwaWN0b2dyYXBoRGF0YTogbnVsbCxcbiAgICAgIGJsdWVSZXZlcnNhbDogZmFsc2UsXG4gICAgICByZWRSZXZlcnNhbDogZmFsc2UsXG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIHVwZGF0ZVNlcXVlbmNlRGF0YShzZXF1ZW5jZSwge1xuICAgICAgYmVhdHM6IGNsZWFyZWRCZWF0cyxcbiAgICAgIHN0YXJ0aW5nUG9zaXRpb25CZWF0OiB1bmRlZmluZWQsXG4gICAgfSk7XG4gIH1cblxuICBkdXBsaWNhdGVTZXF1ZW5jZShzZXF1ZW5jZTogU2VxdWVuY2VEYXRhLCBuZXdOYW1lPzogc3RyaW5nKTogU2VxdWVuY2VEYXRhIHtcbiAgICByZXR1cm4gY3JlYXRlU2VxdWVuY2VEYXRhKHtcbiAgICAgIC4uLnNlcXVlbmNlLFxuICAgICAgaWQ6IGNyeXB0by5yYW5kb21VVUlEKCksXG4gICAgICBuYW1lOiBuZXdOYW1lIHx8IGAke3NlcXVlbmNlLm5hbWV9IChDb3B5KWAsXG4gICAgICBiZWF0czogc2VxdWVuY2UuYmVhdHMubWFwKChiZWF0KSA9PiAoe1xuICAgICAgICAuLi5iZWF0LFxuICAgICAgICBpZDogY3J5cHRvLnJhbmRvbVVVSUQoKSxcbiAgICAgIH0pKSxcbiAgICB9KTtcbiAgfVxuXG4gIHNldFN0YXJ0UG9zaXRpb24oXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBzdGFydFBvc2l0aW9uOiBCZWF0RGF0YVxuICApOiBTZXF1ZW5jZURhdGEge1xuICAgIHJldHVybiB1cGRhdGVTZXF1ZW5jZURhdGEoc2VxdWVuY2UsIHtcbiAgICAgIHN0YXJ0aW5nUG9zaXRpb25CZWF0OiBzdGFydFBvc2l0aW9uLFxuICAgIH0pO1xuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBTRVFVRU5DRSBPUEVSQVRJT05TIChQbGFjZWhvbGRlciBpbXBsZW1lbnRhdGlvbnMpXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICBtaXJyb3JTZXF1ZW5jZShzZXF1ZW5jZTogU2VxdWVuY2VEYXRhKTogU2VxdWVuY2VEYXRhIHtcbiAgICAvLyBUT0RPOiBJbXBsZW1lbnQgbWlycm9yaW5nIGxvZ2ljIGJhc2VkIG9uIHBpY3RvZ3JhcGggZGF0YVxuICAgIGNvbnNvbGUud2FybihcIm1pcnJvclNlcXVlbmNlIG5vdCB5ZXQgaW1wbGVtZW50ZWRcIik7XG4gICAgcmV0dXJuIHNlcXVlbmNlO1xuICB9XG5cbiAgc3dhcENvbG9ycyhzZXF1ZW5jZTogU2VxdWVuY2VEYXRhKTogU2VxdWVuY2VEYXRhIHtcbiAgICBjb25zdCBzd2FwcGVkQmVhdHMgPSBzZXF1ZW5jZS5iZWF0cy5tYXAoKGJlYXQpID0+ICh7XG4gICAgICAuLi5iZWF0LFxuICAgICAgYmx1ZVJldmVyc2FsOiBiZWF0LnJlZFJldmVyc2FsLFxuICAgICAgcmVkUmV2ZXJzYWw6IGJlYXQuYmx1ZVJldmVyc2FsLFxuICAgIH0pKTtcblxuICAgIHJldHVybiB1cGRhdGVTZXF1ZW5jZURhdGEoc2VxdWVuY2UsIHtcbiAgICAgIGJlYXRzOiBzd2FwcGVkQmVhdHMsXG4gICAgfSk7XG4gIH1cblxuICByb3RhdGVTZXF1ZW5jZShcbiAgICBzZXF1ZW5jZTogU2VxdWVuY2VEYXRhLFxuICAgIF9kaXJlY3Rpb246IFwiY2xvY2t3aXNlXCIgfCBcImNvdW50ZXJjbG9ja3dpc2VcIlxuICApOiBTZXF1ZW5jZURhdGEge1xuICAgIC8vIFRPRE86IEltcGxlbWVudCByb3RhdGlvbiBsb2dpYyBiYXNlZCBvbiBwaWN0b2dyYXBoIGRhdGFcbiAgICBjb25zb2xlLndhcm4oXCJyb3RhdGVTZXF1ZW5jZSBub3QgeWV0IGltcGxlbWVudGVkXCIpO1xuICAgIHJldHVybiBzZXF1ZW5jZTtcbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gVkFMSURBVElPTiBBTkQgVVRJTElUSUVTXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICBnZW5lcmF0ZVNlcXVlbmNlV29yZChzZXF1ZW5jZTogU2VxdWVuY2VEYXRhKTogc3RyaW5nIHtcbiAgICAvLyBFeHRyYWN0IGxldHRlcnMgZnJvbSBwaWN0b2dyYXBoIGRhdGFcbiAgICBjb25zdCBsZXR0ZXJzID0gc2VxdWVuY2UuYmVhdHNcbiAgICAgIC5maWx0ZXIoKGJlYXQpID0+IGJlYXQucGljdG9ncmFwaERhdGE/LmxldHRlcilcbiAgICAgIC5tYXAoKGJlYXQpID0+IGJlYXQucGljdG9ncmFwaERhdGE/LmxldHRlcilcbiAgICAgIC5maWx0ZXIoKGxldHRlcik6IGxldHRlciBpcyBMZXR0ZXIgPT4gbGV0dGVyICE9PSB1bmRlZmluZWQpXG4gICAgICAuam9pbihcIlwiKTtcblxuICAgIHJldHVybiBsZXR0ZXJzIHx8IHNlcXVlbmNlLm5hbWU7XG4gIH1cblxuICBjYWxjdWxhdGVTZXF1ZW5jZUR1cmF0aW9uKHNlcXVlbmNlOiBTZXF1ZW5jZURhdGEpOiBudW1iZXIge1xuICAgIHJldHVybiBzZXF1ZW5jZS5iZWF0cy5yZWR1Y2UoKHRvdGFsLCBiZWF0KSA9PiB0b3RhbCArIGJlYXQuZHVyYXRpb24sIDApO1xuICB9XG5cbiAgZ2V0U2VxdWVuY2VTdGF0aXN0aWNzKHNlcXVlbmNlOiBTZXF1ZW5jZURhdGEpOiBTZXF1ZW5jZVN0YXRpc3RpY3Mge1xuICAgIGNvbnN0IHRvdGFsQmVhdHMgPSBzZXF1ZW5jZS5iZWF0cy5sZW5ndGg7XG4gICAgY29uc3QgYmxhbmtCZWF0cyA9IHNlcXVlbmNlLmJlYXRzLmZpbHRlcigoYmVhdCkgPT4gYmVhdC5pc0JsYW5rKS5sZW5ndGg7XG4gICAgY29uc3QgZmlsbGVkQmVhdHMgPSB0b3RhbEJlYXRzIC0gYmxhbmtCZWF0cztcbiAgICBjb25zdCB0b3RhbER1cmF0aW9uID0gdGhpcy5jYWxjdWxhdGVTZXF1ZW5jZUR1cmF0aW9uKHNlcXVlbmNlKTtcbiAgICBjb25zdCBhdmVyYWdlQmVhdER1cmF0aW9uID0gdG90YWxCZWF0cyA+IDAgPyB0b3RhbER1cmF0aW9uIC8gdG90YWxCZWF0cyA6IDA7XG5cbiAgICBjb25zdCByZXZlcnNhbENvdW50ID0gc2VxdWVuY2UuYmVhdHMucmVkdWNlKFxuICAgICAgKGFjYywgYmVhdCkgPT4gKHtcbiAgICAgICAgYmx1ZTogYWNjLmJsdWUgKyAoYmVhdC5ibHVlUmV2ZXJzYWwgPyAxIDogMCksXG4gICAgICAgIHJlZDogYWNjLnJlZCArIChiZWF0LnJlZFJldmVyc2FsID8gMSA6IDApLFxuICAgICAgfSksXG4gICAgICB7IGJsdWU6IDAsIHJlZDogMCB9XG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICB0b3RhbEJlYXRzLFxuICAgICAgYmxhbmtCZWF0cyxcbiAgICAgIGZpbGxlZEJlYXRzLFxuICAgICAgdG90YWxEdXJhdGlvbixcbiAgICAgIGF2ZXJhZ2VCZWF0RHVyYXRpb24sXG4gICAgICBoYXNTdGFydFBvc2l0aW9uOiAhIXNlcXVlbmNlLnN0YXJ0aW5nUG9zaXRpb25CZWF0LFxuICAgICAgcmV2ZXJzYWxDb3VudCxcbiAgICB9O1xuICB9XG59XG4iXSwKICAibWFwcGluZ3MiOiAiQUFRQTtBQUFBLEVBQ0U7QUFBQSxFQUNBO0FBQUEsRUFDQTtBQUFBLEVBQ0E7QUFBQSxPQUNLO0FBT0EsYUFBTSxxQkFBc0Q7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQUtqRSxrQkFBa0IsTUFBYyxTQUFpQixJQUFrQjtBQUNqRSxRQUFJLENBQUMsS0FBSyxLQUFLLEdBQUc7QUFDaEIsWUFBTSxJQUFJLE1BQU0sMkJBQTJCO0FBQUEsSUFDN0M7QUFFQSxRQUFJLFNBQVMsS0FBSyxTQUFTLElBQUk7QUFDN0IsWUFBTSxJQUFJLE1BQU0sZ0RBQWdEO0FBQUEsSUFDbEU7QUFFQSxVQUFNLFFBQW9CLE1BQU0sS0FBSyxFQUFFLE9BQU8sR0FBRyxDQUFDLEdBQUcsT0FBTztBQUFBLE1BQzFELElBQUksT0FBTyxXQUFXO0FBQUEsTUFDdEIsWUFBWSxJQUFJO0FBQUEsTUFDaEIsVUFBVTtBQUFBLE1BQ1YsY0FBYztBQUFBLE1BQ2QsYUFBYTtBQUFBLE1BQ2IsU0FBUztBQUFBLE1BQ1QsZ0JBQWdCO0FBQUEsSUFDbEIsRUFBRTtBQUVGLFdBQU8sbUJBQW1CO0FBQUEsTUFDeEIsTUFBTSxLQUFLLEtBQUs7QUFBQSxNQUNoQjtBQUFBLElBQ0YsQ0FBQztBQUFBLEVBQ0g7QUFBQSxFQUVBLGlCQUFpQixVQUEwQztBQUN6RCxVQUFNLFNBQW1CLENBQUM7QUFDMUIsVUFBTSxXQUFx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
