export class OptionFilteringService {
  constructor(enumMappingService) {
    this.enumMappingService = enumMappingService;
  }
  /**
   * Filter options by start position
   */
  filterByStartPosition(options, startPosition) {
    if (!startPosition) return options;
    return options.filter((option) => {
      const optionStartPos = option.startPosition?.toString().toLowerCase();
      const targetStartPos = startPosition.toLowerCase();
      return optionStartPos === targetStartPos;
    });
  }
  /**
   * Filter options by end position
   */
  filterByEndPosition(options, endPosition) {
    if (!endPosition) return options;
    return options.filter((option) => {
      const optionEndPos = option.endPosition?.toString().toLowerCase();
      const targetEndPos = endPosition.toLowerCase();
      return optionEndPos === targetEndPos;
    });
  }
  /**
   * Filter options by letter types
   */
  filterByLetterTypes(options, letterTypes) {
    if (!letterTypes || letterTypes.length === 0) return options;
    return options.filter((option) => {
      if (!option.letter) return false;
      const letterType = this.enumMappingService.getLetterType(option.letter);
      return letterTypes.includes(letterType);
    });
  }
  /**
   * Filter options by rotation directions
   */
  filterByRotation(options, blueRotationDirection, redRotationDirection) {
    return options.filter((option) => {
      let matches = true;
      if (blueRotationDirection && blueRotationDirection !== "any") {
        const blueRotation = option.motions?.blue?.rotationDirection?.toString().toLowerCase();
        const targetBlueRotation = blueRotationDirection.toLowerCase();
        matches = matches && blueRotation === targetBlueRotation;
      }
      if (redRotationDirection && redRotationDirection !== "any") {
        const redRotation = option.motions?.red?.rotationDirection?.toString().toLowerCase();
        const targetRedRotation = redRotationDirection.toLowerCase();
        matches = matches && redRotation === targetRedRotation;
      }
      return matches;
    });
  }
  /**
   * Filter options by multiple criteria with detailed result
   */
  filterByCriteria(options, criteria) {
    let filtered = [...options];
    const appliedFilters = [];
    const totalOriginal = options.length;
    if (criteria.startPosition) {
      filtered = this.filterByStartPosition(filtered, criteria.startPosition);
      appliedFilters.push(`startPosition: ${criteria.startPosition}`);
    }
    if (criteria.endPosition) {
      filtered = this.filterByEndPosition(filtered, criteria.endPosition);
      appliedFilters.push(`endPosition: ${criteria.endPosition}`);
    }
    if (criteria.letterTypes && criteria.letterTypes.length > 0) {
      filtered = this.filterByLetterTypes(filtered, criteria.letterTypes);
      appliedFilters.push(`letterTypes: ${criteria.letterTypes.join(", ")}`);
    }
    if (criteria.blueRotationDirection || criteria.redRotationDirection) {
      filtered = this.filterByRotation(
        filtered,
        criteria.blueRotationDirection || "",
        criteria.redRotationDirection || ""
      );
      appliedFilters.push(
        `rotation: blue=${criteria.blueRotationDirection || "any"}, red=${criteria.redRotationDirection || "any"}`
      );
    }
    if (criteria.motionTypes && criteria.motionTypes.length > 0) {
      filtered = this.filterByMotionTypes(filtered, criteria.motionTypes);
      appliedFilters.push(`motionTypes: ${criteria.motionTypes.join(", ")}`);
    }
    if (criteria.excludeLetters && criteria.excludeLetters.length > 0) {
      filtered = this.filterExcludeLetters(filtered, criteria.excludeLetters);
      appliedFilters.push(`excludeLetters: ${criteria.excludeLetters.join(", ")}`);
    }
    return {
      filtered,
      totalOriginal,
      totalFiltered: filtered.length,
      appliedFilters
    };
  }
  /**
   * Extract end position from the last beat in a sequence
   */
  extractEndPosition(lastBeat) {
    try {
      if (!lastBeat || !lastBeat.pictographData) {
        return null;
      }
      const endPosition = lastBeat.pictographData.endPosition;
      return endPosition ? endPosition.toString() : null;
    } catch (error) {
      console.warn("⚠️ Failed to extract end position from beat:", error);
      return null;
    }
  }
  /**
   * Filter by motion types
   */
  filterByMotionTypes(options, motionTypes) {
    return options.filter((option) => {
      const blueMotionType = option.motions?.blue?.motionType?.toString().toLowerCase();
      const redMotionType = option.motions?.red?.motionType?.toString().toLowerCase();
      const normalizedMotionTypes = motionTypes.map((mt) => mt.toLowerCase());
      return normalizedMotionTypes.includes(blueMotionType || "") || normalizedMotionTypes.includes(redMotionType || "");
    });
  }
  /**
   * Filter to exclude specific letters
   */
  filterExcludeLetters(options, excludeLetters) {
    return options.filter((option) => {
      return !excludeLetters.includes(option.letter || "");
    });
  }
  /**
   * Get filtering statistics for debugging
   */
  getFilteringStats(originalOptions, criteria) {
    let current = [...originalOptions];
    const afterEachFilter = [];
    if (criteria.startPosition) {
      current = this.filterByStartPosition(current, criteria.startPosition);
      afterEachFilter.push({
        filterName: "startPosition",
        count: current.length,
        criteria: criteria.startPosition
      });
    }
    if (criteria.endPosition) {
      current = this.filterByEndPosition(current, criteria.endPosition);
      afterEachFilter.push({
        filterName: "endPosition",
        count: current.length,
        criteria: criteria.endPosition
      });
    }
    if (criteria.letterTypes && criteria.letterTypes.length > 0) {
      current = this.filterByLetterTypes(current, criteria.letterTypes);
      afterEachFilter.push({
        filterName: "letterTypes",
        count: current.length,
        criteria: criteria.letterTypes.join(", ")
      });
    }
    return {
      originalCount: originalOptions.length,
      afterEachFilter,
      finalCount: current.length
    };
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk9wdGlvbkZpbHRlcmluZ1NlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBPcHRpb25GaWx0ZXJpbmdTZXJ2aWNlIC0gQ2VudHJhbGl6ZWQgb3B0aW9uIGZpbHRlcmluZyB1dGlsaXRpZXNcbiAqIFxuICogSGFuZGxlcyBmaWx0ZXJpbmcgb2YgcGljdG9ncmFwaCBvcHRpb25zIGJ5IHZhcmlvdXMgY3JpdGVyaWEgaW5jbHVkaW5nXG4gKiBwb3NpdGlvbiwgbGV0dGVyIHR5cGVzLCByb3RhdGlvbiwgYW5kIG90aGVyIG1vdGlvbiBwYXJhbWV0ZXJzLlxuICovXG5cbmltcG9ydCB0eXBlIHsgUGljdG9ncmFwaERhdGEgfSBmcm9tIFwiJGxpYi9kb21haW4vUGljdG9ncmFwaERhdGFcIjtcbmltcG9ydCB0eXBlIHsgQmVhdERhdGEgfSBmcm9tIFwiJGxpYi9kb21haW4vQmVhdERhdGFcIjtcbmltcG9ydCB0eXBlIHsgSUVudW1NYXBwaW5nU2VydmljZSB9IGZyb20gXCIuLi8uLi8uLi9pbnRlcmZhY2VzL2FwcGxpY2F0aW9uLWludGVyZmFjZXNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBGaWx0ZXJDcml0ZXJpYSB7XG4gIHN0YXJ0UG9zaXRpb24/OiBzdHJpbmc7XG4gIGVuZFBvc2l0aW9uPzogc3RyaW5nO1xuICBsZXR0ZXJUeXBlcz86IHN0cmluZ1tdO1xuICBibHVlUm90YXRpb25EaXJlY3Rpb24/OiBzdHJpbmc7XG4gIHJlZFJvdGF0aW9uRGlyZWN0aW9uPzogc3RyaW5nO1xuICBtb3Rpb25UeXBlcz86IHN0cmluZ1tdO1xuICBkaWZmaWN1bHR5Pzogc3RyaW5nO1xuICBleGNsdWRlTGV0dGVycz86IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZpbHRlclJlc3VsdCB7XG4gIGZpbHRlcmVkOiBQaWN0b2dyYXBoRGF0YVtdO1xuICB0b3RhbE9yaWdpbmFsOiBudW1iZXI7XG4gIHRvdGFsRmlsdGVyZWQ6IG51bWJlcjtcbiAgYXBwbGllZEZpbHRlcnM6IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElPcHRpb25GaWx0ZXJpbmdTZXJ2aWNlIHtcbiAgZmlsdGVyQnlTdGFydFBvc2l0aW9uKG9wdGlvbnM6IFBpY3RvZ3JhcGhEYXRhW10sIHN0YXJ0UG9zaXRpb246IHN0cmluZyk6IFBpY3RvZ3JhcGhEYXRhW107XG4gIGZpbHRlckJ5RW5kUG9zaXRpb24ob3B0aW9uczogUGljdG9ncmFwaERhdGFbXSwgZW5kUG9zaXRpb246IHN0cmluZyk6IFBpY3RvZ3JhcGhEYXRhW107XG4gIGZpbHRlckJ5TGV0dGVyVHlwZXMob3B0aW9uczogUGljdG9ncmFwaERhdGFbXSwgbGV0dGVyVHlwZXM6IHN0cmluZ1tdKTogUGljdG9ncmFwaERhdGFbXTtcbiAgZmlsdGVyQnlSb3RhdGlvbihcbiAgICBvcHRpb25zOiBQaWN0b2dyYXBoRGF0YVtdLFxuICAgIGJsdWVSb3RhdGlvbkRpcmVjdGlvbjogc3RyaW5nLFxuICAgIHJlZFJvdGF0aW9uRGlyZWN0aW9uOiBzdHJpbmdcbiAgKTogUGljdG9ncmFwaERhdGFbXTtcbiAgZmlsdGVyQnlDcml0ZXJpYShvcHRpb25zOiBQaWN0b2dyYXBoRGF0YVtdLCBjcml0ZXJpYTogRmlsdGVyQ3JpdGVyaWEpOiBGaWx0ZXJSZXN1bHQ7XG4gIGV4dHJhY3RFbmRQb3NpdGlvbihsYXN0QmVhdDogQmVhdERhdGEpOiBzdHJpbmcgfCBudWxsO1xufVxuXG5leHBvcnQgY2xhc3MgT3B0aW9uRmlsdGVyaW5nU2VydmljZSBpbXBsZW1lbnRzIElPcHRpb25GaWx0ZXJpbmdTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbnVtTWFwcGluZ1NlcnZpY2U6IElFbnVtTWFwcGluZ1NlcnZpY2UpIHt9XG5cbiAgLyoqXG4gICAqIEZpbHRlciBvcHRpb25zIGJ5IHN0YXJ0IHBvc2l0aW9uXG4gICAqL1xuICBmaWx0ZXJCeVN0YXJ0UG9zaXRpb24ob3B0aW9uczogUGljdG9ncmFwaERhdGFbXSwgc3RhcnRQb3NpdGlvbjogc3RyaW5nKTogUGljdG9ncmFwaERhdGFbXSB7XG4gICAgaWYgKCFzdGFydFBvc2l0aW9uKSByZXR1cm4gb3B0aW9ucztcblxuICAgIHJldHVybiBvcHRpb25zLmZpbHRlcihvcHRpb24gPT4ge1xuICAgICAgY29uc3Qgb3B0aW9uU3RhcnRQb3MgPSBvcHRpb24uc3RhcnRQb3NpdGlvbj8udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgY29uc3QgdGFyZ2V0U3RhcnRQb3MgPSBzdGFydFBvc2l0aW9uLnRvTG93ZXJDYXNlKCk7XG4gICAgICByZXR1cm4gb3B0aW9uU3RhcnRQb3MgPT09IHRhcmdldFN0YXJ0UG9zO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZpbHRlciBvcHRpb25zIGJ5IGVuZCBwb3NpdGlvblxuICAgKi9cbiAgZmlsdGVyQnlFbmRQb3NpdGlvbihvcHRpb25zOiBQaWN0b2dyYXBoRGF0YVtdLCBlbmRQb3NpdGlvbjogc3RyaW5nKTogUGljdG9ncmFwaERhdGFbXSB7XG4gICAgaWYgKCFlbmRQb3NpdGlvbikgcmV0dXJuIG9wdGlvbnM7XG5cbiAgICByZXR1cm4gb3B0aW9ucy5maWx0ZXIob3B0aW9uID0+IHtcbiAgICAgIGNvbnN0IG9wdGlvbkVuZFBvcyA9IG9wdGlvbi5lbmRQb3NpdGlvbj8udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgY29uc3QgdGFyZ2V0RW5kUG9zID0gZW5kUG9zaXRpb24udG9Mb3dlckNhc2UoKTtcbiAgICAgIHJldHVybiBvcHRpb25FbmRQb3MgPT09IHRhcmdldEVuZFBvcztcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGaWx0ZXIgb3B0aW9ucyBieSBsZXR0ZXIgdHlwZXNcbiAgICovXG4gIGZpbHRlckJ5TGV0dGVyVHlwZXMob3B0aW9uczogUGljdG9ncmFwaERhdGFbXSwgbGV0dGVyVHlwZXM6IHN0cmluZ1tdKTogUGljdG9ncmFwaERhdGFbXSB7XG4gICAgaWYgKCFsZXR0ZXJUeXBlcyB8fCBsZXR0ZXJUeXBlcy5sZW5ndGggPT09IDApIHJldHVybiBvcHRpb25zO1xuXG4gICAgcmV0dXJuIG9wdGlvbnMuZmlsdGVyKG9wdGlvbiA9PiB7XG4gICAgICBpZiAoIW9wdGlvbi5sZXR0ZXIpIHJldHVybiBmYWxzZTtcbiAgICAgIFxuICAgICAgY29uc3QgbGV0dGVyVHlwZSA9IHRoaXMuZW51bU1hcHBpbmdTZXJ2aWNlLmdldExldHRlclR5cGUob3B0aW9uLmxldHRlcik7XG4gICAgICByZXR1cm4gbGV0dGVyVHlwZXMuaW5jbHVkZXMobGV0dGVyVHlwZSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRmlsdGVyIG9wdGlvbnMgYnkgcm90YXRpb24gZGlyZWN0aW9uc1xuICAgKi9cbiAgZmlsdGVyQnlSb3RhdGlvbihcbiAgICBvcHRpb25zOiBQaWN0b2dyYXBoRGF0YVtdLFxuICAgIGJsdWVSb3RhdGlvbkRpcmVjdGlvbjogc3RyaW5nLFxuICAgIHJlZFJvdGF0aW9uRGlyZWN0aW9uOiBzdHJpbmdcbiAgKTogUGljdG9ncmFwaERhdGFbXSB7XG4gICAgcmV0dXJuIG9wdGlvbnMuZmlsdGVyKG9wdGlvbiA9PiB7XG4gICAgICBsZXQgbWF0Y2hlcyA9IHRydWU7XG5cbiAgICAgIC8vIENoZWNrIGJsdWUgcm90YXRpb24gaWYgc3BlY2lmaWVkXG4gICAgICBpZiAoYmx1ZVJvdGF0aW9uRGlyZWN0aW9uICYmIGJsdWVSb3RhdGlvbkRpcmVjdGlvbiAhPT0gXCJhbnlcIikge1xuICAgICAgICBjb25zdCBibHVlUm90YXRpb24gPSBvcHRpb24ubW90aW9ucz8uYmx1ZT8ucm90YXRpb25EaXJlY3Rpb24/LnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgY29uc3QgdGFyZ2V0Qmx1ZVJvdGF0aW9uID0gYmx1ZVJvdGF0aW9uRGlyZWN0aW9uLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIG1hdGNoZXMgPSBtYXRjaGVzICYmIChibHVlUm90YXRpb24gPT09IHRhcmdldEJsdWVSb3RhdGlvbik7XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIHJlZCByb3RhdGlvbiBpZiBzcGVjaWZpZWRcbiAgICAgIGlmIChyZWRSb3RhdGlvbkRpcmVjdGlvbiAmJiByZWRSb3RhdGlvbkRpcmVjdGlvbiAhPT0gXCJhbnlcIikge1xuICAgICAgICBjb25zdCByZWRSb3RhdGlvbiA9IG9wdGlvbi5tb3Rpb25zPy5yZWQ/LnJvdGF0aW9uRGlyZWN0aW9uPy50b1N0cmluZygpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGNvbnN0IHRhcmdldFJlZFJvdGF0aW9uID0gcmVkUm90YXRpb25EaXJlY3Rpb24udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgbWF0Y2hlcyA9IG1hdGNoZXMgJiYgKHJlZFJvdGF0aW9uID09PSB0YXJnZXRSZWRSb3RhdGlvbik7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBtYXRjaGVzO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZpbHRlciBvcHRpb25zIGJ5IG11bHRpcGxlIGNyaXRlcmlhIHdpdGggZGV0YWlsZWQgcmVzdWx0XG4gICAqL1xuICBmaWx0ZXJCeUNyaXRlcmlhKG9wdGlvbnM6IFBpY3RvZ3JhcGhEYXRhW10sIGNyaXRlcmlhOiBGaWx0ZXJDcml0ZXJpYSk6IEZpbHRlclJlc3VsdCB7XG4gICAgbGV0IGZpbHRlcmVkID0gWy4uLm9wdGlvbnNdO1xuICAgIGNvbnN0IGFwcGxpZWRGaWx0ZXJzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IHRvdGFsT3JpZ2luYWwgPSBvcHRpb25zLmxlbmd0aDtcblxuICAgIC8vIEFwcGx5IHN0YXJ0IHBvc2l0aW9uIGZpbHRlclxuICAgIGlmIChjcml0ZXJpYS5zdGFydFBvc2l0aW9uKSB7XG4gICAgICBmaWx0ZXJlZCA9IHRoaXMuZmlsdGVyQnlTdGFydFBvc2l0aW9uKGZpbHRlcmVkLCBjcml0ZXJpYS5zdGFydFBvc2l0aW9uKTtcbiAgICAgIGFwcGxpZWRGaWx0ZXJzLnB1c2goYHN0YXJ0UG9zaXRpb246ICR7Y3JpdGVyaWEuc3RhcnRQb3NpdGlvbn1gKTtcbiAgICB9XG5cbiAgICAvLyBBcHBseSBlbmQgcG9zaXRpb24gZmlsdGVyXG4gICAgaWYgKGNyaXRlcmlhLmVuZFBvc2l0aW9uKSB7XG4gICAgICBmaWx0ZXJlZCA9IHRoaXMuZmlsdGVyQnlFbmRQb3NpdGlvbihmaWx0ZXJlZCwgY3JpdGVyaWEuZW5kUG9zaXRpb24pO1xuICAgICAgYXBwbGllZEZpbHRlcnMucHVzaChgZW5kUG9zaXRpb246ICR7Y3JpdGVyaWEuZW5kUG9zaXRpb259YCk7XG4gICAgfVxuXG4gICAgLy8gQXBwbHkgbGV0dGVyIHR5cGVzIGZpbHRlclxuICAgIGlmIChjcml0ZXJpYS5sZXR0ZXJUeXBlcyAmJiBjcml0ZXJpYS5sZXR0ZXJUeXBlcy5sZW5ndGggPiAwKSB7XG4gICAgICBmaWx0ZXJlZCA9IHRoaXMuZmlsdGVyQnlMZXR0ZXJUeXBlcyhmaWx0ZXJlZCwgY3JpdGVyaWEubGV0dGVyVHlwZXMpO1xuICAgICAgYXBwbGllZEZpbHRlcnMucHVzaChgbGV0dGVyVHlwZXM6ICR7Y3JpdGVyaWEubGV0dGVyVHlwZXMuam9pbignLCAnKX1gKTtcbiAgICB9XG5cbiAgICAvLyBBcHBseSByb3RhdGlvbiBmaWx0ZXJcbiAgICBpZiAoY3JpdGVyaWEuYmx1ZVJvdGF0aW9uRGlyZWN0aW9uIHx8IGNyaXRlcmlhLnJlZFJvdGF0aW9uRGlyZWN0aW9uKSB7XG4gICAgICBmaWx0ZXJlZCA9IHRoaXMuZmlsdGVyQnlSb3RhdGlvbihcbiAgICAgICAgZmlsdGVyZWQsXG4gICAgICAgIGNyaXRlcmlhLmJsdWVSb3RhdGlvbkRpcmVjdGlvbiB8fCBcIlwiLFxuICAgICAgICBjcml0ZXJpYS5yZWRSb3RhdGlvbkRpcmVjdGlvbiB8fCBcIlwiXG4gICAgICApO1xuICAgICAgYXBwbGllZEZpbHRlcnMucHVzaChcbiAgICAgICAgYHJvdGF0aW9uOiBibHVlPSR7Y3JpdGVyaWEuYmx1ZVJvdGF0aW9uRGlyZWN0aW9uIHx8ICdhbnknfSwgcmVkPSR7Y3JpdGVyaWEucmVkUm90YXRpb25EaXJlY3Rpb24gfHwgJ2FueSd9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBBcHBseSBtb3Rpb24gdHlwZXMgZmlsdGVyXG4gICAgaWYgKGNyaXRlcmlhLm1vdGlvblR5cGVzICYmIGNyaXRlcmlhLm1vdGlvblR5cGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGZpbHRlcmVkID0gdGhpcy5maWx0ZXJCeU1vdGlvblR5cGVzKGZpbHRlcmVkLCBjcml0ZXJpYS5tb3Rpb25UeXBlcyk7XG4gICAgICBhcHBsaWVkRmlsdGVycy5wdXNoKGBtb3Rpb25UeXBlczogJHtjcml0ZXJpYS5tb3Rpb25UeXBlcy5qb2luKCcsICcpfWApO1xuICAgIH1cblxuICAgIC8vIEFwcGx5IGV4Y2x1ZGUgbGV0dGVycyBmaWx0ZXJcbiAgICBpZiAoY3JpdGVyaWEuZXhjbHVkZUxldHRlcnMgJiYgY3JpdGVyaWEuZXhjbHVkZUxldHRlcnMubGVuZ3RoID4gMCkge1xuICAgICAgZmlsdGVyZWQgPSB0aGlzLmZpbHRlckV4Y2x1ZGVMZXR0ZXJzKGZpbHRlcmVkLCBjcml0ZXJpYS5leGNsdWRlTGV0dGVycyk7XG4gICAgICBhcHBsaWVkRmlsdGVycy5wdXNoKGBleGNsdWRlTGV0dGVyczogJHtjcml0ZXJpYS5leGNsdWRlTGV0dGVycy5qb2luKCcsICcpfWApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBmaWx0ZXJlZCxcbiAgICAgIHRvdGFsT3JpZ2luYWwsXG4gICAgICB0b3RhbEZpbHRlcmVkOiBmaWx0ZXJlZC5sZW5ndGgsXG4gICAgICBhcHBsaWVkRmlsdGVyc1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogRXh0cmFjdCBlbmQgcG9zaXRpb24gZnJvbSB0aGUgbGFzdCBiZWF0IGluIGEgc2VxdWVuY2VcbiAgICovXG4gIGV4dHJhY3RFbmRQb3NpdGlvbihsYXN0QmVhdDogQmVhdERhdGEpOiBzdHJpbmcgfCBudWxsIHtcbiAgICB0cnkge1xuICAgICAgaWYgKCFsYXN0QmVhdCB8fCAhbGFzdEJlYXQucGljdG9ncmFwaERhdGEpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGVuZFBvc2l0aW9uID0gbGFzdEJlYXQucGljdG9ncmFwaERhdGEuZW5kUG9zaXRpb247XG4gICAgICByZXR1cm4gZW5kUG9zaXRpb24gPyBlbmRQb3NpdGlvbi50b1N0cmluZygpIDogbnVsbDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKFwi4pqg77iPIEZhaWxlZCB0byBleHRyYWN0IGVuZCBwb3NpdGlvbiBmcm9tIGJlYXQ6XCIsIGVycm9yKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBGaWx0ZXIgYnkgbW90aW9uIHR5cGVzXG4gICAqL1xuICBwcml2YXRlIGZpbHRlckJ5TW90aW9uVHlwZXMob3B0aW9uczogUGljdG9ncmFwaERhdGFbXSwgbW90aW9uVHlwZXM6IHN0cmluZ1tdKTogUGljdG9ncmFwaERhdGFbXSB7XG4gICAgcmV0dXJuIG9wdGlvbnMuZmlsdGVyKG9wdGlvbiA9PiB7XG4gICAgICBjb25zdCBibHVlTW90aW9uVHlwZSA9IG9wdGlvbi5tb3Rpb25zPy5ibHVlPy5tb3Rpb25UeXBlPy50b1N0cmluZygpLnRvTG93ZXJDYXNlKCk7XG4gICAgICBjb25zdCByZWRNb3Rpb25UeXBlID0gb3B0aW9uLm1vdGlvbnM/LnJlZD8ubW90aW9uVHlwZT8udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgXG4gICAgICBjb25zdCBub3JtYWxpemVkTW90aW9uVHlwZXMgPSBtb3Rpb25UeXBlcy5tYXAobXQgPT4gbXQudG9Mb3dlckNhc2UoKSk7XG4gICAgICBcbiAgICAgIHJldHVybiBub3JtYWxpemVkTW90aW9uVHlwZXMuaW5jbHVkZXMoYmx1ZU1vdGlvblR5cGUgfHwgJycpIHx8XG4gICAgICAgICAgICAgbm9ybWFsaXplZE1vdGlvblR5cGVzLmluY2x1ZGVzKHJlZE1vdGlvblR5cGUgfHwgJycpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZpbHRlciB0byBleGNsdWRlIHNwZWNpZmljIGxldHRlcnNcbiAgICovXG4gIHByaXZhdGUgZmlsdGVyRXhjbHVkZUxldHRlcnMob3B0aW9uczogUGljdG9ncmFwaERhdGFbXSwgZXhjbHVkZUxldHRlcnM6IHN0cmluZ1tdKTogUGljdG9ncmFwaERhdGFbXSB7XG4gICAgcmV0dXJuIG9wdGlvbnMuZmlsdGVyKG9wdGlvbiA9PiB7XG4gICAgICByZXR1cm4gIWV4Y2x1ZGVMZXR0ZXJzLmluY2x1ZGVzKG9wdGlvbi5sZXR0ZXIgfHwgJycpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBmaWx0ZXJpbmcgc3RhdGlzdGljcyBmb3IgZGVidWdnaW5nXG4gICAqL1xuICBnZXRGaWx0ZXJpbmdTdGF0cyhcbiAgICBvcmlnaW5hbE9wdGlvbnM6IFBpY3RvZ3JhcGhEYXRhW10sXG4gICAgY3JpdGVyaWE6IEZpbHRlckNyaXRlcmlhXG4gICk6IHtcbiAgICBvcmlnaW5hbENvdW50OiBudW1iZXI7XG4gICAgYWZ0ZXJFYWNoRmlsdGVyOiBBcnJheTx7IGZpbHRlck5hbWU6IHN0cmluZzsgY291bnQ6IG51bWJlcjsgY3JpdGVyaWE6IHN0cmluZyB9PjtcbiAgICBmaW5hbENvdW50OiBudW1iZXI7XG4gIH0ge1xuICAgIGxldCBjdXJyZW50ID0gWy4uLm9yaWdpbmFsT3B0aW9uc107XG4gICAgY29uc3QgYWZ0ZXJFYWNoRmlsdGVyOiBBcnJheTx7IGZpbHRlck5hbWU6IHN0cmluZzsgY291bnQ6IG51bWJlcjsgY3JpdGVyaWE6IHN0cmluZyB9PiA9IFtdO1xuXG4gICAgLy8gVHJhY2sgZWFjaCBmaWx0ZXIgc3RlcFxuICAgIGlmIChjcml0ZXJpYS5zdGFydFBvc2l0aW9uKSB7XG4gICAgICBjdXJyZW50ID0gdGhpcy5maWx0ZXJCeVN0YXJ0UG9zaXRpb24oY3VycmVudCwgY3JpdGVyaWEuc3RhcnRQb3NpdGlvbik7XG4gICAgICBhZnRlckVhY2hGaWx0ZXIucHVzaCh7XG4gICAgICAgIGZpbHRlck5hbWU6ICdzdGFydFBvc2l0aW9uJyxcbiAgICAgICAgY291bnQ6IGN1cnJlbnQubGVuZ3RoLFxuICAgICAgICBjcml0ZXJpYTogY3JpdGVyaWEuc3RhcnRQb3NpdGlvblxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGNyaXRlcmlhLmVuZFBvc2l0aW9uKSB7XG4gICAgICBjdXJyZW50ID0gdGhpcy5maWx0ZXJCeUVuZFBvc2l0aW9uKGN1cnJlbnQsIGNyaXRlcmlhLmVuZFBvc2l0aW9uKTtcbiAgICAgIGFmdGVyRWFjaEZpbHRlci5wdXNoKHtcbiAgICAgICAgZmlsdGVyTmFtZTogJ2VuZFBvc2l0aW9uJyxcbiAgICAgICAgY291bnQ6IGN1cnJlbnQubGVuZ3RoLFxuICAgICAgICBjcml0ZXJpYTogY3JpdGVyaWEuZW5kUG9zaXRpb25cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChjcml0ZXJpYS5sZXR0ZXJUeXBlcyAmJiBjcml0ZXJpYS5sZXR0ZXJUeXBlcy5sZW5ndGggPiAwKSB7XG4gICAgICBjdXJyZW50ID0gdGhpcy5maWx0ZXJCeUxldHRlclR5cGVzKGN1cnJlbnQsIGNyaXRlcmlhLmxldHRlclR5cGVzKTtcbiAgICAgIGFmdGVyRWFjaEZpbHRlci5wdXNoKHtcbiAgICAgICAgZmlsdGVyTmFtZTogJ2xldHRlclR5cGVzJyxcbiAgICAgICAgY291bnQ6IGN1cnJlbnQubGVuZ3RoLFxuICAgICAgICBjcml0ZXJpYTogY3JpdGVyaWEubGV0dGVyVHlwZXMuam9pbignLCAnKVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIG9yaWdpbmFsQ291bnQ6IG9yaWdpbmFsT3B0aW9ucy5sZW5ndGgsXG4gICAgICBhZnRlckVhY2hGaWx0ZXIsXG4gICAgICBmaW5hbENvdW50OiBjdXJyZW50Lmxlbmd0aFxuICAgIH07XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6IkFBMENPLGFB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