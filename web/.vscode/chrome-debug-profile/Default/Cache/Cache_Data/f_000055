import { Location, MotionType } from "/src/lib/domain/index.ts";
import { DashLocationCalculator } from "/src/lib/services/positioning/arrows/calculation/DashLocationCalculator.ts";
export class ArrowLocationCalculator {
  /**
   * Pure algorithmic service for calculating arrow locations.
   *
   * Implements location calculation algorithms without any UI dependencies.
   * Each motion type has its own calculation strategy.
   */
  dashLocationService;
  // Direction pairs mapping for shift arrows (PRO/ANTI/FLOAT)
  // Maps start/end location pairs to their calculated arrow location
  shiftDirectionPairs = {
    // Cardinal + Diagonal combinations
    [this.createLocationPairKey([Location.NORTH, Location.EAST])]: Location.NORTHEAST,
    [this.createLocationPairKey([Location.EAST, Location.SOUTH])]: Location.SOUTHEAST,
    [this.createLocationPairKey([Location.SOUTH, Location.WEST])]: Location.SOUTHWEST,
    [this.createLocationPairKey([Location.WEST, Location.NORTH])]: Location.NORTHWEST,
    // Diagonal + Cardinal combinations
    [this.createLocationPairKey([Location.NORTHEAST, Location.NORTHWEST])]: Location.NORTH,
    [this.createLocationPairKey([Location.NORTHEAST, Location.SOUTHEAST])]: Location.EAST,
    [this.createLocationPairKey([Location.SOUTHWEST, Location.SOUTHEAST])]: Location.SOUTH,
    [this.createLocationPairKey([Location.NORTHWEST, Location.SOUTHWEST])]: Location.WEST
  };
  constructor(dashLocationService) {
    this.dashLocationService = dashLocationService || new DashLocationCalculator();
  }
  calculateLocation(motion, pictographData) {
    const motionType = motion.motionType?.toLowerCase();
    switch (motionType) {
      case "static":
        return this.calculateStaticLocation(motion);
      case "pro":
      case "anti":
      case "float":
        return this.calculateShiftLocation(motion);
      case "dash":
        return this.calculateDashLocation(motion, pictographData);
      default:
        console.warn(
          `Unknown motion type: ${motionType}, using start location`
        );
        return motion.startLocation || Location.NORTH;
    }
  }
  calculateStaticLocation(motion) {
    return motion.startLocation || Location.NORTH;
  }
  calculateShiftLocation(motion) {
    if (!motion.startLocation || !motion.endLocation) {
      console.warn(
        "Shift motion missing startLocation or endLocation, using startLocation"
      );
      return motion.startLocation || Location.NORTH;
    }
    const locationPairKey = this.createLocationPairKey([
      motion.startLocation,
      motion.endLocation
    ]);
    const calculatedLocation = this.shiftDirectionPairs[locationPairKey] || motion.startLocation;
    return calculatedLocation;
  }
  calculateDashLocation(motion, pictographData) {
    if (!pictographData) {
      console.warn(
        "No pictograph data provided for dash location calculation, using start location"
      );
      return motion.startLocation || Location.NORTH;
    }
    const isBlueArrow = this.isBlueArrowMotion(motion, pictographData);
    return this.dashLocationService.calculateDashLocationFromPictographData(
      pictographData,
      isBlueArrow
    );
  }
  getSupportedMotionTypes() {
    return [
      MotionType.STATIC,
      MotionType.PRO,
      MotionType.ANTI,
      MotionType.FLOAT,
      MotionType.DASH
    ];
  }
  validateMotionData(motion) {
    if (!motion) {
      return false;
    }
    const motionType = motion.motionType?.toLowerCase();
    if (!this.getSupportedMotionTypes().includes(motionType)) {
      return false;
    }
    if (["pro", "anti", "float"].includes(motionType || "")) {
      return motion.startLocation != null && motion.endLocation != null;
    }
    if (["static", "dash"].includes(motionType || "")) {
      return motion.startLocation != null;
    }
    return true;
  }
  extractBeatDataFromPictograph(pictograph) {
    if (!pictograph.arrows) {
      return null;
    }
    const blueMotion = pictograph.motions?.blue;
    const redMotion = pictograph.motions?.red;
    return {
      beatNumber: pictograph.metadata?.created_from_beat || 1,
      letter: pictograph.letter,
      pictographData: {
        motions: {
          blue: blueMotion,
          red: redMotion
        }
      }
    };
  }
  isBlueArrowMotion(motion, pictographData) {
    if (pictographData.motions?.blue === motion) {
      return true;
    }
    if (pictographData.motions?.red === motion) {
      return false;
    }
    console.warn("Could not determine arrow color for motion, assuming blue");
    return true;
  }
  /**
   * Create a normalized key for location pairs to enable bidirectional lookup.
   * This ensures that [A, B] and [B, A] produce the same key.
   */
  createLocationPairKey(locations) {
    const sortedLocations = [...locations].sort();
    return sortedLocations.join(",");
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFycm93TG9jYXRpb25DYWxjdWxhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQXJyb3cgTG9jYXRpb24gQ2FsY3VsYXRvciBTZXJ2aWNlXG4gKlxuICogUHVyZSBhbGdvcml0aG1pYyBzZXJ2aWNlIGZvciBjYWxjdWxhdGluZyBhcnJvdyBsb2NhdGlvbnMgYmFzZWQgb24gbW90aW9uIGRhdGEuXG4gKiBEaXJlY3QgVHlwZVNjcmlwdCBwb3J0IG9mIHRoZSBQeXRob24gQXJyb3dMb2NhdGlvbkNhbGN1bGF0b3JTZXJ2aWNlLlxuICpcbiAqIFRoaXMgc2VydmljZSBoYW5kbGVzOlxuICogLSBTdGF0aWMgbW90aW9uIGxvY2F0aW9uIGNhbGN1bGF0aW9uICh1c2VzIHN0YXJ0IGxvY2F0aW9uKVxuICogLSBTaGlmdCBtb3Rpb24gbG9jYXRpb24gY2FsY3VsYXRpb24gKFBSTy9BTlRJL0ZMT0FUIHVzaW5nIHN0YXJ0L2VuZCBwYWlyIG1hcHBpbmcpXG4gKiAtIERhc2ggbW90aW9uIGxvY2F0aW9uIGNhbGN1bGF0aW9uICh3aXRoIFR5cGUgMyBkZXRlY3Rpb24gc3VwcG9ydClcbiAqXG4gKiBObyBVSSBkZXBlbmRlbmNpZXMsIGNvbXBsZXRlbHkgdGVzdGFibGUgaW4gaXNvbGF0aW9uLlxuICovXG5cbmltcG9ydCB0eXBlIHsgTW90aW9uRGF0YSwgUGljdG9ncmFwaERhdGEgfSBmcm9tIFwiJGxpYi9kb21haW5cIjtcbmltcG9ydCB7IExvY2F0aW9uLCBNb3Rpb25UeXBlIH0gZnJvbSBcIiRsaWIvZG9tYWluXCI7XG5pbXBvcnQgdHlwZSB7IElBcnJvd0xvY2F0aW9uQ2FsY3VsYXRvciB9IGZyb20gXCIuLi8uLi9jb3JlLXNlcnZpY2VzXCI7XG5pbXBvcnQgdHlwZSB7IEJlYXREYXRhIH0gZnJvbSBcIi4uLy4uL3R5cGVzXCI7XG5pbXBvcnQgeyBEYXNoTG9jYXRpb25DYWxjdWxhdG9yIH0gZnJvbSBcIi4vRGFzaExvY2F0aW9uQ2FsY3VsYXRvclwiO1xuXG5leHBvcnQgY2xhc3MgQXJyb3dMb2NhdGlvbkNhbGN1bGF0b3IgaW1wbGVtZW50cyBJQXJyb3dMb2NhdGlvbkNhbGN1bGF0b3Ige1xuICAvKipcbiAgICogUHVyZSBhbGdvcml0aG1pYyBzZXJ2aWNlIGZvciBjYWxjdWxhdGluZyBhcnJvdyBsb2NhdGlvbnMuXG4gICAqXG4gICAqIEltcGxlbWVudHMgbG9jYXRpb24gY2FsY3VsYXRpb24gYWxnb3JpdGhtcyB3aXRob3V0IGFueSBVSSBkZXBlbmRlbmNpZXMuXG4gICAqIEVhY2ggbW90aW9uIHR5cGUgaGFzIGl0cyBvd24gY2FsY3VsYXRpb24gc3RyYXRlZ3kuXG4gICAqL1xuXG4gIHByaXZhdGUgZGFzaExvY2F0aW9uU2VydmljZTogRGFzaExvY2F0aW9uQ2FsY3VsYXRvcjtcblxuICAvLyBEaXJlY3Rpb24gcGFpcnMgbWFwcGluZyBmb3Igc2hpZnQgYXJyb3dzIChQUk8vQU5USS9GTE9BVClcbiAgLy8gTWFwcyBzdGFydC9lbmQgbG9jYXRpb24gcGFpcnMgdG8gdGhlaXIgY2FsY3VsYXRlZCBhcnJvdyBsb2NhdGlvblxuICBwcml2YXRlIHJlYWRvbmx5IHNoaWZ0RGlyZWN0aW9uUGFpcnM6IFJlY29yZDxzdHJpbmcsIExvY2F0aW9uPiA9IHtcbiAgICAvLyBDYXJkaW5hbCArIERpYWdvbmFsIGNvbWJpbmF0aW9uc1xuICAgIFt0aGlzLmNyZWF0ZUxvY2F0aW9uUGFpcktleShbTG9jYXRpb24uTk9SVEgsIExvY2F0aW9uLkVBU1RdKV06XG4gICAgICBMb2NhdGlvbi5OT1JUSEVBU1QsXG4gICAgW3RoaXMuY3JlYXRlTG9jYXRpb25QYWlyS2V5KFtMb2NhdGlvbi5FQVNULCBMb2NhdGlvbi5TT1VUSF0pXTpcbiAgICAgIExvY2F0aW9uLlNPVVRIRUFTVCxcbiAgICBbdGhpcy5jcmVhdGVMb2NhdGlvblBhaXJLZXkoW0xvY2F0aW9uLlNPVVRILCBMb2NhdGlvbi5XRVNUXSldOlxuICAgICAgTG9jYXRpb24uU09VVEhXRVNULFxuICAgIFt0aGlzLmNyZWF0ZUxvY2F0aW9uUGFpcktleShbTG9jYXRpb24uV0VTVCwgTG9jYXRpb24uTk9SVEhdKV06XG4gICAgICBMb2NhdGlvbi5OT1JUSFdFU1QsXG4gICAgLy8gRGlhZ29uYWwgKyBDYXJkaW5hbCBjb21iaW5hdGlvbnNcbiAgICBbdGhpcy5jcmVhdGVMb2NhdGlvblBhaXJLZXkoW0xvY2F0aW9uLk5PUlRIRUFTVCwgTG9jYXRpb24uTk9SVEhXRVNUXSldOlxuICAgICAgTG9jYXRpb24uTk9SVEgsXG4gICAgW3RoaXMuY3JlYXRlTG9jYXRpb25QYWlyS2V5KFtMb2NhdGlvbi5OT1JUSEVBU1QsIExvY2F0aW9uLlNPVVRIRUFTVF0pXTpcbiAgICAgIExvY2F0aW9uLkVBU1QsXG4gICAgW3RoaXMuY3JlYXRlTG9jYXRpb25QYWlyS2V5KFtMb2NhdGlvbi5TT1VUSFdFU1QsIExvY2F0aW9uLlNPVVRIRUFTVF0pXTpcbiAgICAgIExvY2F0aW9uLlNPVVRILFxuICAgIFt0aGlzLmNyZWF0ZUxvY2F0aW9uUGFpcktleShbTG9jYXRpb24uTk9SVEhXRVNULCBMb2NhdGlvbi5TT1VUSFdFU1RdKV06XG4gICAgICBMb2NhdGlvbi5XRVNULFxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKGRhc2hMb2NhdGlvblNlcnZpY2U/OiBEYXNoTG9jYXRpb25DYWxjdWxhdG9yKSB7XG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZSB0aGUgbG9jYXRpb24gY2FsY3VsYXRvci5cbiAgICAgKlxuICAgICAqIEFyZ3M6XG4gICAgICogICAgIGRhc2hMb2NhdGlvblNlcnZpY2U6IFNlcnZpY2UgZm9yIGRhc2ggbG9jYXRpb24gY2FsY3VsYXRpb25zXG4gICAgICovXG4gICAgdGhpcy5kYXNoTG9jYXRpb25TZXJ2aWNlID1cbiAgICAgIGRhc2hMb2NhdGlvblNlcnZpY2UgfHwgbmV3IERhc2hMb2NhdGlvbkNhbGN1bGF0b3IoKTtcbiAgfVxuXG4gIGNhbGN1bGF0ZUxvY2F0aW9uKFxuICAgIG1vdGlvbjogTW90aW9uRGF0YSxcbiAgICBwaWN0b2dyYXBoRGF0YT86IFBpY3RvZ3JhcGhEYXRhXG4gICk6IExvY2F0aW9uIHtcbiAgICAvKipcbiAgICAgKiBDYWxjdWxhdGUgYXJyb3cgbG9jYXRpb24gYmFzZWQgb24gbW90aW9uIHR5cGUgYW5kIGRhdGEuXG4gICAgICpcbiAgICAgKiBBcmdzOlxuICAgICAqICAgICBtb3Rpb246IE1vdGlvbiBkYXRhIGNvbnRhaW5pbmcgdHlwZSwgc3RhcnQvZW5kIGxvY2F0aW9ucywgcm90YXRpb24gZGlyZWN0aW9uXG4gICAgICogICAgIHBpY3RvZ3JhcGhEYXRhOiBPcHRpb25hbCBwaWN0b2dyYXBoIGRhdGEgZm9yIERBU0ggbW90aW9uIFR5cGUgMyBkZXRlY3Rpb25cbiAgICAgKlxuICAgICAqIFJldHVybnM6XG4gICAgICogICAgIExvY2F0aW9uIGVudW0gdmFsdWUgcmVwcmVzZW50aW5nIHRoZSBjYWxjdWxhdGVkIGFycm93IGxvY2F0aW9uXG4gICAgICpcbiAgICAgKiBUaHJvd3M6XG4gICAgICogICAgIEVycm9yOiBJZiBkYXNoIG1vdGlvbiByZXF1aXJlcyBwaWN0b2dyYXBoIGRhdGEgYnV0IG5vbmUgcHJvdmlkZWRcbiAgICAgKi9cbiAgICBjb25zdCBtb3Rpb25UeXBlID0gbW90aW9uLm1vdGlvblR5cGU/LnRvTG93ZXJDYXNlKCk7XG5cbiAgICBzd2l0Y2ggKG1vdGlvblR5cGUpIHtcbiAgICAgIGNhc2UgXCJzdGF0aWNcIjpcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FsY3VsYXRlU3RhdGljTG9jYXRpb24obW90aW9uKTtcbiAgICAgIGNhc2UgXCJwcm9cIjpcbiAgICAgIGNhc2UgXCJhbnRpXCI6XG4gICAgICBjYXNlIFwiZmxvYXRcIjpcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FsY3VsYXRlU2hpZnRMb2NhdGlvbihtb3Rpb24pO1xuICAgICAgY2FzZSBcImRhc2hcIjpcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FsY3VsYXRlRGFzaExvY2F0aW9uKG1vdGlvbiwgcGljdG9ncmFwaERhdGEpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgIGBVbmtub3duIG1vdGlvbiB0eXBlOiAke21vdGlvblR5cGV9LCB1c2luZyBzdGFydCBsb2NhdGlvbmBcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIG1vdGlvbi5zdGFydExvY2F0aW9uIHx8IExvY2F0aW9uLk5PUlRIO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2FsY3VsYXRlU3RhdGljTG9jYXRpb24obW90aW9uOiBNb3Rpb25EYXRhKTogTG9jYXRpb24ge1xuICAgIC8qKlxuICAgICAqIENhbGN1bGF0ZSBsb2NhdGlvbiBmb3Igc3RhdGljIGFycm93cy5cbiAgICAgKlxuICAgICAqIFN0YXRpYyBhcnJvd3MgdXNlIHRoZWlyIHN0YXJ0IGxvY2F0aW9uIGRpcmVjdGx5LlxuICAgICAqXG4gICAgICogQXJnczpcbiAgICAgKiAgICAgbW90aW9uOiBNb3Rpb24gZGF0YSB3aXRoIFNUQVRJQyB0eXBlXG4gICAgICpcbiAgICAgKiBSZXR1cm5zOlxuICAgICAqICAgICBUaGUgc3RhcnQgbG9jYXRpb24gb2YgdGhlIG1vdGlvblxuICAgICAqL1xuICAgIHJldHVybiBtb3Rpb24uc3RhcnRMb2NhdGlvbiB8fCBMb2NhdGlvbi5OT1JUSDtcbiAgfVxuXG4gIHByaXZhdGUgY2FsY3VsYXRlU2hpZnRMb2NhdGlvbihtb3Rpb246IE1vdGlvbkRhdGEpOiBMb2NhdGlvbiB7XG4gICAgLyoqXG4gICAgICogQ2FsY3VsYXRlIGxvY2F0aW9uIGZvciBzaGlmdCBhcnJvd3MgKFBSTy9BTlRJL0ZMT0FUKS5cbiAgICAgKlxuICAgICAqIFNoaWZ0IGFycm93cyB1c2UgYSBtYXBwaW5nIGZyb20gc3RhcnQvZW5kIGxvY2F0aW9uIHBhaXJzIHRvIGRldGVybWluZVxuICAgICAqIHRoZWlyIGFycm93IGxvY2F0aW9uLiBUaGlzIGltcGxlbWVudHMgdGhlIHByb3ZlbiBzaGlmdCBsb2NhdGlvbiBhbGdvcml0aG0uXG4gICAgICpcbiAgICAgKiBBcmdzOlxuICAgICAqICAgICBtb3Rpb246IE1vdGlvbiBkYXRhIHdpdGggUFJPLCBBTlRJLCBvciBGTE9BVCB0eXBlXG4gICAgICpcbiAgICAgKiBSZXR1cm5zOlxuICAgICAqICAgICBDYWxjdWxhdGVkIGxvY2F0aW9uIGJhc2VkIG9uIHN0YXJ0L2VuZCBwYWlyIG1hcHBpbmdcbiAgICAgKi9cbiAgICBpZiAoIW1vdGlvbi5zdGFydExvY2F0aW9uIHx8ICFtb3Rpb24uZW5kTG9jYXRpb24pIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgXCJTaGlmdCBtb3Rpb24gbWlzc2luZyBzdGFydExvY2F0aW9uIG9yIGVuZExvY2F0aW9uLCB1c2luZyBzdGFydExvY2F0aW9uXCJcbiAgICAgICk7XG4gICAgICByZXR1cm4gbW90aW9uLnN0YXJ0TG9jYXRpb24gfHwgTG9jYXRpb24uTk9SVEg7XG4gICAgfVxuXG4gICAgY29uc3QgbG9jYXRpb25QYWlyS2V5ID0gdGhpcy5jcmVhdGVMb2NhdGlvblBhaXJLZXkoW1xuICAgICAgbW90aW9uLnN0YXJ0TG9jYXRpb24sXG4gICAgICBtb3Rpb24uZW5kTG9jYXRpb24sXG4gICAgXSk7XG4gICAgY29uc3QgY2FsY3VsYXRlZExvY2F0aW9uID1cbiAgICAgIHRoaXMuc2hpZnREaXJlY3Rpb25QYWlyc1tsb2NhdGlvblBhaXJLZXldIHx8IG1vdGlvbi5zdGFydExvY2F0aW9uO1xuXG4gICAgcmV0dXJuIGNhbGN1bGF0ZWRMb2NhdGlvbjtcbiAgfVxuXG4gIHByaXZhdGUgY2FsY3VsYXRlRGFzaExvY2F0aW9uKFxuICAgIG1vdGlvbjogTW90aW9uRGF0YSxcbiAgICBwaWN0b2dyYXBoRGF0YT86IFBpY3RvZ3JhcGhEYXRhXG4gICk6IExvY2F0aW9uIHtcbiAgICAvKipcbiAgICAgKiBDYWxjdWxhdGUgbG9jYXRpb24gZm9yIGRhc2ggYXJyb3dzLlxuICAgICAqXG4gICAgICogRGFzaCBhcnJvd3MgdXNlIHNwZWNpYWxpemVkIGxvZ2ljIHRoYXQgbWF5IHJlcXVpcmUgcGljdG9ncmFwaCBkYXRhXG4gICAgICogZm9yIFR5cGUgMyBkZXRlY3Rpb24gYW5kIG90aGVyIHNwZWNpYWwgY2FzZXMuXG4gICAgICpcbiAgICAgKiBBcmdzOlxuICAgICAqICAgICBtb3Rpb246IE1vdGlvbiBkYXRhIHdpdGggREFTSCB0eXBlXG4gICAgICogICAgIHBpY3RvZ3JhcGhEYXRhOiBQaWN0b2dyYXBoIGRhdGEgZm9yIFR5cGUgMyBkZXRlY3Rpb25cbiAgICAgKlxuICAgICAqIFJldHVybnM6XG4gICAgICogICAgIENhbGN1bGF0ZWQgZGFzaCBsb2NhdGlvblxuICAgICAqXG4gICAgICogVGhyb3dzOlxuICAgICAqICAgICBFcnJvcjogSWYgcGljdG9ncmFwaCBkYXRhIGlzIHJlcXVpcmVkIGJ1dCBub3QgcHJvdmlkZWRcbiAgICAgKi9cbiAgICBpZiAoIXBpY3RvZ3JhcGhEYXRhKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIFwiTm8gcGljdG9ncmFwaCBkYXRhIHByb3ZpZGVkIGZvciBkYXNoIGxvY2F0aW9uIGNhbGN1bGF0aW9uLCB1c2luZyBzdGFydCBsb2NhdGlvblwiXG4gICAgICApO1xuICAgICAgcmV0dXJuIG1vdGlvbi5zdGFydExvY2F0aW9uIHx8IExvY2F0aW9uLk5PUlRIO1xuICAgIH1cblxuICAgIGNvbnN0IGlzQmx1ZUFycm93ID0gdGhpcy5pc0JsdWVBcnJvd01vdGlvbihtb3Rpb24sIHBpY3RvZ3JhcGhEYXRhKTtcblxuICAgIHJldHVybiB0aGlzLmRhc2hMb2NhdGlvblNlcnZpY2UuY2FsY3VsYXRlRGFzaExvY2F0aW9uRnJvbVBpY3RvZ3JhcGhEYXRhKFxuICAgICAgcGljdG9ncmFwaERhdGEsXG4gICAgICBpc0JsdWVBcnJvd1xuICAgICk7XG4gIH1cblxuICBnZXRTdXBwb3J0ZWRNb3Rpb25UeXBlcygpOiBNb3Rpb25UeXBlW10ge1xuICAgIC8qKlxuICAgICAqIEdldCBsaXN0IG9mIG1vdGlvbiB0eXBlcyBzdXBwb3J0ZWQgYnkgdGhpcyBjYWxjdWxhdG9yLlxuICAgICAqXG4gICAgICogUmV0dXJuczpcbiAgICAgKiAgICAgTGlzdCBvZiBzdXBwb3J0ZWQgTW90aW9uVHlwZSBlbnVtIHZhbHVlc1xuICAgICAqL1xuICAgIHJldHVybiBbXG4gICAgICBNb3Rpb25UeXBlLlNUQVRJQyxcbiAgICAgIE1vdGlvblR5cGUuUFJPLFxuICAgICAgTW90aW9uVHlwZS5BTlRJLFxuICAgICAgTW90aW9uVHlwZS5GTE9BVCxcbiAgICAgIE1vdGlvblR5cGUuREFTSCxcbiAgICBdO1xuICB9XG5cbiAgdmFsaWRhdGVNb3Rpb25EYXRhKG1vdGlvbjogTW90aW9uRGF0YSk6IGJvb2xlYW4ge1xuICAgIC8qKlxuICAgICAqIFZhbGlkYXRlIHRoYXQgbW90aW9uIGRhdGEgaXMgc3VpdGFibGUgZm9yIGxvY2F0aW9uIGNhbGN1bGF0aW9uLlxuICAgICAqXG4gICAgICogQXJnczpcbiAgICAgKiAgICAgbW90aW9uOiBNb3Rpb24gZGF0YSB0byB2YWxpZGF0ZVxuICAgICAqXG4gICAgICogUmV0dXJuczpcbiAgICAgKiAgICAgVHJ1ZSBpZiBtb3Rpb24gZGF0YSBpcyB2YWxpZCBmb3IgbG9jYXRpb24gY2FsY3VsYXRpb25cbiAgICAgKi9cbiAgICBpZiAoIW1vdGlvbikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IG1vdGlvblR5cGUgPSBtb3Rpb24ubW90aW9uVHlwZT8udG9Mb3dlckNhc2UoKTtcbiAgICBpZiAoIXRoaXMuZ2V0U3VwcG9ydGVkTW90aW9uVHlwZXMoKS5pbmNsdWRlcyhtb3Rpb25UeXBlIGFzIE1vdGlvblR5cGUpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgcmVxdWlyZWQgZmllbGRzIGJhc2VkIG9uIG1vdGlvbiB0eXBlXG4gICAgaWYgKFtcInByb1wiLCBcImFudGlcIiwgXCJmbG9hdFwiXS5pbmNsdWRlcyhtb3Rpb25UeXBlIHx8IFwiXCIpKSB7XG4gICAgICAvLyBTaGlmdCBtb3Rpb25zIHJlcXVpcmUgYm90aCBzdGFydCBhbmQgZW5kIGxvY2F0aW9uc1xuICAgICAgcmV0dXJuIG1vdGlvbi5zdGFydExvY2F0aW9uICE9IG51bGwgJiYgbW90aW9uLmVuZExvY2F0aW9uICE9IG51bGw7XG4gICAgfVxuICAgIGlmIChbXCJzdGF0aWNcIiwgXCJkYXNoXCJdLmluY2x1ZGVzKG1vdGlvblR5cGUgfHwgXCJcIikpIHtcbiAgICAgIC8vIFN0YXRpYyBhbmQgZGFzaCBtb3Rpb25zIHJlcXVpcmUgYXQgbGVhc3Qgc3RhcnQgbG9jYXRpb25cbiAgICAgIHJldHVybiBtb3Rpb24uc3RhcnRMb2NhdGlvbiAhPSBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgZXh0cmFjdEJlYXREYXRhRnJvbVBpY3RvZ3JhcGgocGljdG9ncmFwaDogUGljdG9ncmFwaERhdGEpOiBCZWF0RGF0YSB8IG51bGwge1xuICAgIC8qKkV4dHJhY3QgYmVhdCBkYXRhIGZyb20gcGljdG9ncmFwaCBmb3IgZGFzaCBsb2NhdGlvbiBjYWxjdWxhdGlvbi4qL1xuICAgIGlmICghcGljdG9ncmFwaC5hcnJvd3MpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8vIEV4dHJhY3QgbW90aW9uIGRhdGEgZnJvbSBtb3Rpb25zIGRpY3Rpb25hcnlcbiAgICBjb25zdCBibHVlTW90aW9uID0gcGljdG9ncmFwaC5tb3Rpb25zPy5ibHVlO1xuICAgIGNvbnN0IHJlZE1vdGlvbiA9IHBpY3RvZ3JhcGgubW90aW9ucz8ucmVkO1xuXG4gICAgLy8gQ3JlYXRlIGJlYXQgZGF0YVxuICAgIHJldHVybiB7XG4gICAgICBiZWF0TnVtYmVyOiBwaWN0b2dyYXBoLm1ldGFkYXRhPy5jcmVhdGVkX2Zyb21fYmVhdCB8fCAxLFxuICAgICAgbGV0dGVyOiBwaWN0b2dyYXBoLmxldHRlcixcbiAgICAgIHBpY3RvZ3JhcGhEYXRhOiB7XG4gICAgICAgIG1vdGlvbnM6IHtcbiAgICAgICAgICBibHVlOiBibHVlTW90aW9uLFxuICAgICAgICAgIHJlZDogcmVkTW90aW9uLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9IGFzIEJlYXREYXRhO1xuICB9XG5cbiAgaXNCbHVlQXJyb3dNb3Rpb24oXG4gICAgbW90aW9uOiBNb3Rpb25EYXRhLFxuICAgIHBpY3RvZ3JhcGhEYXRhOiBQaWN0b2dyYXBoRGF0YVxuICApOiBib29sZWFuIHtcbiAgICAvKipEZXRlcm1pbmUgaWYgdGhlIGdpdmVuIG1vdGlvbiBiZWxvbmdzIHRvIHRoZSBibHVlIGFycm93LiovXG4gICAgLy8gQ29tcGFyZSB0aGUgbW90aW9uIHdpdGggYmx1ZSBhbmQgcmVkIG1vdGlvbnMgaW4gcGljdG9ncmFwaCBkYXRhXG4gICAgaWYgKHBpY3RvZ3JhcGhEYXRhLm1vdGlvbnM/LmJsdWUgPT09IG1vdGlvbikge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGlmIChwaWN0b2dyYXBoRGF0YS5tb3Rpb25zPy5yZWQgPT09IG1vdGlvbikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICAvLyBGYWxsYmFjazogaWYgd2UgY2FuJ3QgZGV0ZXJtaW5lLCBhc3N1bWUgYmx1ZVxuICAgIGNvbnNvbGUud2FybihcIkNvdWxkIG5vdCBkZXRlcm1pbmUgYXJyb3cgY29sb3IgZm9yIG1vdGlvbiwgYXNzdW1pbmcgYmx1ZVwiKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBub3JtYWxpemVkIGtleSBmb3IgbG9jYXRpb24gcGFpcnMgdG8gZW5hYmxlIGJpZGlyZWN0aW9uYWwgbG9va3VwLlxuICAgKiBUaGlzIGVuc3VyZXMgdGhhdCBbQSwgQl0gYW5kIFtCLCBBXSBwcm9kdWNlIHRoZSBzYW1lIGtleS5cbiAgICovXG4gIHByaXZhdGUgY3JlYXRlTG9jYXRpb25QYWlyS2V5KGxvY2F0aW9uczogTG9jYXRpb25bXSk6IHN0cmluZyB7XG4gICAgLy8gU29ydCBsb2NhdGlvbnMgdG8gZW5zdXJlIGNvbnNpc3RlbnQga2V5IHJlZ2FyZGxlc3Mgb2Ygb3JkZXJcbiAgICBjb25zdCBzb3J0ZWRMb2NhdGlvbnMgPSBbLi4ubG9jYXRpb25zXS5zb3J0KCk7XG4gICAgcmV0dXJuIHNvcnRlZExvY2F0aW9ucy5qb2luKFwiLFwiKTtcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiQUFlQSxTQUFTLFVBQVUsa0JBQWtCO0FBR3JDLFNBQVMsOEJBQThCO0FBRWhDLGFBQU0sd0JBQTREO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFRL0Q7QUFBQTtBQUFBO0FBQUEsRUFJUyxzQkFBZ0Q7QUFBQTtBQUFBLElBRS9ELENBQUMsS0FBSyxzQkFBc0IsQ0FBQyxTQUFTLE9BQU8sU0FBUyxJQUFJLENBQUMsQ0FBQyxHQUMxRCxTQUFTO0FBQUEsSUFDWCxDQUFDLEtBQUssc0JBQXNCLENBQUMsU0FBUyxNQUFNLFNBQVMsS0FBSyxDQUFDLENBQUMsR0FDMUQsU0FBUztBQUFBLElBQ1gsQ0FBQyxLQUFLLHNCQUFzQixDQUFDLFNBQVMsT0FBTyxTQUFTLElBQUksQ0FBQyxDQUFDLEdBQzFELFNBQVM7QUFBQSxJQUNYLENBQUMsS0FBSyxzQkFBc0IsQ0FBQyxTQUFTLE1BQU0sU0FBUyxLQUFLLENBQUMsQ0FBQyxHQUMxRCxTQUFTO0FBQUE7QUFBQSxJQUVYLENBQUMsS0FBSyxzQkFBc0IsQ0FBQyxTQUFTLFdBQVcsU0FBUyxTQUFTLENBQUMsQ0FBQyxHQUNuRSxTQUFTO0FBQUEsSUFDWCxDQUFDLEtBQUssc0JBQXNCLENBQUMsU0FBUyxXQUFXLFNBQVMsU0FBUyxDQUFDLENBQUMsR0FDbkUsU0FBUztBQUFBLElBQ1gsQ0FBQyxLQUFLLHNCQUFzQixDQUFDLFNBQVMsV0FBVyxTQUFTLFNBQVMsQ0FBQyxDQUFDLEdBQ25FLFNBQVM7QUFBQSxJQUNYLENBQUMsS0FBSyxzQkFBc0IsQ0FBQyxTQUFTLFdBQVcsU0FBUyxTQUFTLENBQUMsQ0FBQyxHQUNuRSxTQUFT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