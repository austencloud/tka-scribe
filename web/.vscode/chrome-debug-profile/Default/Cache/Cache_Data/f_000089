import { SpecialPlacementOriKeyGenerator } from "/src/lib/services/positioning/arrows/key_generators/SpecialPlacementOriKeyGenerator.ts";
import { jsonCache } from "/src/lib/services/positioning/cache/SimpleJsonCache.ts";
export class SpecialPlacementService {
  // Structure: [gridMode][oriKey][letter] -> Record<string, unknown>
  specialPlacements = {};
  loadingCache = /* @__PURE__ */ new Set();
  oriKeyGenerator;
  constructor() {
    this.specialPlacements = { diamond: {}, box: {} };
    this.oriKeyGenerator = new SpecialPlacementOriKeyGenerator();
  }
  /**
   * Get special adjustment for arrow based on special placement logic.
   *
   * @param motionData Motion data containing motion information
   * @param pictographData Pictograph data containing letter and context
   * @param arrowColor Color of the arrow ('red' or 'blue') - if not provided, will try to determine from motion
   * @returns Point with special adjustment or null if no special placement found
   */
  async getSpecialAdjustment(motionData, pictographData, arrowColor) {
    if (!motionData || !pictographData.letter) {
      return null;
    }
    const motion = motionData;
    const letter = pictographData.letter;
    const oriKey = this.oriKeyGenerator.generateOrientationKey(
      motion,
      pictographData
    );
    const gridMode = pictographData.gridData?.gridMode || pictographData.gridMode || "diamond";
    const turnsTuple = this.generateTurnsTuple(pictographData);
    await this.ensureLetterPlacementsLoaded(gridMode, oriKey, letter);
    const letterData = this.specialPlacements[gridMode]?.[oriKey]?.[letter];
    if (!letterData) {
      return null;
    }
    const turnData = letterData?.[turnsTuple];
    if (!turnData) {
      return null;
    }
    let colorKey = "";
    if (arrowColor) {
      colorKey = arrowColor;
    } else if (pictographData.motions?.blue && pictographData.motions.blue === motion) {
      colorKey = "blue";
    } else if (pictographData.motions?.red && pictographData.motions.red === motion) {
      colorKey = "red";
    } else {
      colorKey = "blue";
    }
    if (colorKey in turnData) {
      const adjustmentValues = turnData[colorKey];
      if (Array.isArray(adjustmentValues) && adjustmentValues.length === 2) {
        return { x: adjustmentValues[0], y: adjustmentValues[1] };
      }
    }
    const motionTypeKey = motionData.motionType?.toLowerCase() || "";
    if (motionTypeKey in turnData) {
      const adjustmentValues = turnData[motionTypeKey];
      if (Array.isArray(adjustmentValues) && adjustmentValues.length === 2) {
        return { x: adjustmentValues[0], y: adjustmentValues[1] };
      }
    }
    return null;
  }
  /**
   * Load special placement data from JSON configuration files.
   */
  async ensureLetterPlacementsLoaded(gridMode, oriKey, letter) {
    try {
      if (!this.specialPlacements[gridMode]) {
        this.specialPlacements[gridMode] = {};
      }
      if (!this.specialPlacements[gridMode][oriKey]) {
        this.specialPlacements[gridMode][oriKey] = {};
      }
      if (this.specialPlacements[gridMode][oriKey][letter]) {
        return;
      }
      const cacheKey = `${gridMode}:${oriKey}:${letter}`;
      if (this.loadingCache.has(cacheKey)) {
        return;
      }
      this.loadingCache.add(cacheKey);
      const encodedLetter = encodeURIComponent(letter);
      const basePath = `/data/arrow_placement/${gridMode}/special/${oriKey}/${encodedLetter}_placements.json`;
      try {
        const data = await jsonCache.get(basePath);
        this.specialPlacements[gridMode][oriKey][letter] = data;
      } catch (error) {
        this.specialPlacements[gridMode][oriKey][letter] = {};
      }
    } catch (error) {
      console.error("Error ensuring special placement data:", error);
    }
  }
  /**
   * Generate turns tuple string matching the turns_tuple_generator logic.
   *
   * This creates a string representation of the turn values for lookup in JSON data.
   * Format: "(blue_turns, red_turns)" e.g., "(0, 1.5)", "(1, 0.5)"
   */
  generateTurnsTuple(pictographData) {
    try {
      const blueMotion = pictographData.motions?.blue;
      const redMotion = pictographData.motions?.red;
      if (blueMotion && redMotion) {
        const blueTurns = typeof blueMotion.turns === "number" ? blueMotion.turns : 0;
        const redTurns = typeof redMotion.turns === "number" ? redMotion.turns : 0;
        const blueStr = blueTurns === Math.floor(blueTurns) ? Math.floor(blueTurns).toString() : blueTurns.toString();
        const redStr = redTurns === Math.floor(redTurns) ? Math.floor(redTurns).toString() : redTurns.toString();
        return `(${blueStr}, ${redStr})`;
      }
      return "(0, 0)";
    } catch (error) {
      return "(0, 0)";
    }
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNwZWNpYWxQbGFjZW1lbnRTZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogU3BlY2lhbCBQbGFjZW1lbnQgU2VydmljZSBmb3IgTW9kZXJuIEFycm93IFBvc2l0aW9uaW5nXG4gKlxuICogVGhpcyBzZXJ2aWNlIGltcGxlbWVudHMgc3BlY2lhbCBwbGFjZW1lbnQgbG9naWMgdXNpbmcgdGhlIHNhbWUgSlNPTiBjb25maWd1cmF0aW9uIGRhdGEuXG4gKiBJdCBwcm92aWRlcyBwaXhlbC1wZXJmZWN0IHNwZWNpYWwgcGxhY2VtZW50IGFkanVzdG1lbnRzIGZvciBzcGVjaWZpYyBwaWN0b2dyYXBoIGNvbmZpZ3VyYXRpb25zLlxuICpcbiAqIElNUExFTUVOVFMgU1BFQ0lBTCBQTEFDRU1FTlQgUElQRUxJTkU6XG4gKiAtIExvYWRzIHNwZWNpYWwgcGxhY2VtZW50IEpTT04gZmlsZXMgZnJvbSBzdGF0aWMvZGF0YS9hcnJvd19wbGFjZW1lbnQgZGlyZWN0b3J5XG4gKiAtIEdlbmVyYXRlcyBvcmllbnRhdGlvbiBrZXlzIChvcmlfa2V5KSBmb3IgbW90aW9uIGNsYXNzaWZpY2F0aW9uXG4gKiAtIEFwcGxpZXMgbGV0dGVyLXNwZWNpZmljLCB0dXJuLXNwZWNpZmljLCBhbmQgbW90aW9uLXR5cGUtc3BlY2lmaWMgYWRqdXN0bWVudHNcbiAqIC0gSGFuZGxlcyBjb21wbGV4IHBsYWNlbWVudCBydWxlcyBmb3Igc3BlY2lmaWMgcGljdG9ncmFwaCBwYXR0ZXJuc1xuICpcbiAqIERpcmVjdCBUeXBlU2NyaXB0IG1pcnJvciBvZiByZWZlcmVuY2UvbW9kZXJuL2FwcGxpY2F0aW9uL3NlcnZpY2VzL3Bvc2l0aW9uaW5nL2Fycm93cy9wbGFjZW1lbnQvc3BlY2lhbF9wbGFjZW1lbnRfc2VydmljZS5weVxuICovXG5cbmltcG9ydCB0eXBlIHsgTW90aW9uRGF0YSwgUGljdG9ncmFwaERhdGEgfSBmcm9tIFwiJGxpYi9kb21haW5cIjtcbmltcG9ydCB0eXBlIHsgSVNwZWNpYWxQbGFjZW1lbnRTZXJ2aWNlIH0gZnJvbSBcIi4uLy4uL3BsYWNlbWVudC1zZXJ2aWNlc1wiO1xuaW1wb3J0IHsgU3BlY2lhbFBsYWNlbWVudE9yaUtleUdlbmVyYXRvciB9IGZyb20gXCIuLi9rZXlfZ2VuZXJhdG9ycy9TcGVjaWFsUGxhY2VtZW50T3JpS2V5R2VuZXJhdG9yXCI7XG5pbXBvcnQgeyBqc29uQ2FjaGUgfSBmcm9tIFwiLi4vLi4vY2FjaGUvU2ltcGxlSnNvbkNhY2hlXCI7XG5cbi8vIERlZmluZSBQb2ludCBpbnRlcmZhY2UgbG9jYWxseSBzaW5jZSBpdCBtaWdodCBub3QgYmUgaW4gZG9tYWluXG5pbnRlcmZhY2UgUG9pbnQge1xuICB4OiBudW1iZXI7XG4gIHk6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIFNwZWNpYWxQbGFjZW1lbnRTZXJ2aWNlIGltcGxlbWVudHMgSVNwZWNpYWxQbGFjZW1lbnRTZXJ2aWNlIHtcbiAgLy8gU3RydWN0dXJlOiBbZ3JpZE1vZGVdW29yaUtleV1bbGV0dGVyXSAtPiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPlxuICBwcml2YXRlIHNwZWNpYWxQbGFjZW1lbnRzOiBSZWNvcmQ8XG4gICAgc3RyaW5nLFxuICAgIFJlY29yZDxzdHJpbmcsIFJlY29yZDxzdHJpbmcsIFJlY29yZDxzdHJpbmcsIHVua25vd24+Pj5cbiAgPiA9IHt9O1xuICBwcml2YXRlIGxvYWRpbmdDYWNoZTogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XG4gIHByaXZhdGUgb3JpS2V5R2VuZXJhdG9yOiBTcGVjaWFsUGxhY2VtZW50T3JpS2V5R2VuZXJhdG9yO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIC8vIERlZmVyIGxvYWRpbmc7IHdlJ2xsIGxhemlseSBsb2FkIHBlci1sZXR0ZXIgb24gZGVtYW5kXG4gICAgdGhpcy5zcGVjaWFsUGxhY2VtZW50cyA9IHsgZGlhbW9uZDoge30sIGJveDoge30gfSBhcyBSZWNvcmQ8XG4gICAgICBzdHJpbmcsXG4gICAgICBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPj4+XG4gICAgPjtcbiAgICB0aGlzLm9yaUtleUdlbmVyYXRvciA9IG5ldyBTcGVjaWFsUGxhY2VtZW50T3JpS2V5R2VuZXJhdG9yKCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHNwZWNpYWwgYWRqdXN0bWVudCBmb3IgYXJyb3cgYmFzZWQgb24gc3BlY2lhbCBwbGFjZW1lbnQgbG9naWMuXG4gICAqXG4gICAqIEBwYXJhbSBtb3Rpb25EYXRhIE1vdGlvbiBkYXRhIGNvbnRhaW5pbmcgbW90aW9uIGluZm9ybWF0aW9uXG4gICAqIEBwYXJhbSBwaWN0b2dyYXBoRGF0YSBQaWN0b2dyYXBoIGRhdGEgY29udGFpbmluZyBsZXR0ZXIgYW5kIGNvbnRleHRcbiAgICogQHBhcmFtIGFycm93Q29sb3IgQ29sb3Igb2YgdGhlIGFycm93ICgncmVkJyBvciAnYmx1ZScpIC0gaWYgbm90IHByb3ZpZGVkLCB3aWxsIHRyeSB0byBkZXRlcm1pbmUgZnJvbSBtb3Rpb25cbiAgICogQHJldHVybnMgUG9pbnQgd2l0aCBzcGVjaWFsIGFkanVzdG1lbnQgb3IgbnVsbCBpZiBubyBzcGVjaWFsIHBsYWNlbWVudCBmb3VuZFxuICAgKi9cbiAgYXN5bmMgZ2V0U3BlY2lhbEFkanVzdG1lbnQoXG4gICAgbW90aW9uRGF0YTogTW90aW9uRGF0YSxcbiAgICBwaWN0b2dyYXBoRGF0YTogUGljdG9ncmFwaERhdGEsXG4gICAgYXJyb3dDb2xvcj86IHN0cmluZ1xuICApOiBQcm9taXNlPFBvaW50IHwgbnVsbD4ge1xuICAgIGlmICghbW90aW9uRGF0YSB8fCAhcGljdG9ncmFwaERhdGEubGV0dGVyKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBtb3Rpb24gPSBtb3Rpb25EYXRhO1xuICAgIGNvbnN0IGxldHRlciA9IHBpY3RvZ3JhcGhEYXRhLmxldHRlcjtcblxuICAgIC8vIEdlbmVyYXRlIG9yaWVudGF0aW9uIGtleSB1c2luZyB2YWxpZGF0ZWQgbG9naWNcbiAgICBjb25zdCBvcmlLZXkgPSB0aGlzLm9yaUtleUdlbmVyYXRvci5nZW5lcmF0ZU9yaWVudGF0aW9uS2V5KFxuICAgICAgbW90aW9uLFxuICAgICAgcGljdG9ncmFwaERhdGFcbiAgICApO1xuXG4gICAgLy8gR2V0IGdyaWQgbW9kZSAoZGVmYXVsdCB0byBkaWFtb25kKVxuICAgIGNvbnN0IGdyaWRNb2RlID1cbiAgICAgIHBpY3RvZ3JhcGhEYXRhLmdyaWREYXRhPy5ncmlkTW9kZSB8fCBwaWN0b2dyYXBoRGF0YS5ncmlkTW9kZSB8fCBcImRpYW1vbmRcIjtcblxuICAgIC8vIEdlbmVyYXRlIHR1cm5zIHR1cGxlIGZvciBsb29rdXBcbiAgICBjb25zdCB0dXJuc1R1cGxlID0gdGhpcy5nZW5lcmF0ZVR1cm5zVHVwbGUocGljdG9ncmFwaERhdGEpO1xuXG4gICAgLy8gRW5zdXJlIHRoZSBsZXR0ZXItc3BlY2lmaWMgc3BlY2lhbCBwbGFjZW1lbnQgZGF0YSBpcyBsb2FkZWQgbGF6aWx5XG4gICAgYXdhaXQgdGhpcy5lbnN1cmVMZXR0ZXJQbGFjZW1lbnRzTG9hZGVkKGdyaWRNb2RlLCBvcmlLZXksIGxldHRlcik7XG5cbiAgICAvLyBMb29rIHVwIHNwZWNpYWwgcGxhY2VtZW50IGRhdGFcbiAgICBjb25zdCBsZXR0ZXJEYXRhID0gdGhpcy5zcGVjaWFsUGxhY2VtZW50c1tncmlkTW9kZV0/LltvcmlLZXldPy5bbGV0dGVyXSBhc1xuICAgICAgfCBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPlxuICAgICAgfCB1bmRlZmluZWQ7XG5cbiAgICBpZiAoIWxldHRlckRhdGEpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8vIEdldCB0dXJuLXNwZWNpZmljIGRhdGFcbiAgICBjb25zdCB0dXJuRGF0YSA9IGxldHRlckRhdGE/Llt0dXJuc1R1cGxlXSBhc1xuICAgICAgfCBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPlxuICAgICAgfCB1bmRlZmluZWQ7XG5cbiAgICBpZiAoIXR1cm5EYXRhKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBGaXJzdCwgdHJ5IGRpcmVjdCBjb2xvci1iYXNlZCBjb29yZGluYXRlIGxvb2t1cCAobW9zdCBjb21tb24gY2FzZSlcbiAgICBsZXQgY29sb3JLZXkgPSBcIlwiO1xuICAgIGlmIChhcnJvd0NvbG9yKSB7XG4gICAgICAvLyBVc2UgcHJvdmlkZWQgYXJyb3cgY29sb3IgZGlyZWN0bHlcbiAgICAgIGNvbG9yS2V5ID0gYXJyb3dDb2xvcjtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgcGljdG9ncmFwaERhdGEubW90aW9ucz8uYmx1ZSAmJlxuICAgICAgcGljdG9ncmFwaERhdGEubW90aW9ucy5ibHVlID09PSBtb3Rpb25cbiAgICApIHtcbiAgICAgIGNvbG9yS2V5ID0gXCJibHVlXCI7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIHBpY3RvZ3JhcGhEYXRhLm1vdGlvbnM/LnJlZCAmJlxuICAgICAgcGljdG9ncmFwaERhdGEubW90aW9ucy5yZWQgPT09IG1vdGlvblxuICAgICkge1xuICAgICAgY29sb3JLZXkgPSBcInJlZFwiO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBGYWxsYmFjazogdHJ5IHRvIGRldGVybWluZSBmcm9tIG1vdGlvbiBkYXRhXG4gICAgICBjb2xvcktleSA9IFwiYmx1ZVwiOyAvLyBEZWZhdWx0IGZhbGxiYWNrXG4gICAgfVxuXG4gICAgaWYgKGNvbG9yS2V5IGluIHR1cm5EYXRhKSB7XG4gICAgICBjb25zdCBhZGp1c3RtZW50VmFsdWVzID0gdHVybkRhdGFbY29sb3JLZXldO1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYWRqdXN0bWVudFZhbHVlcykgJiYgYWRqdXN0bWVudFZhbHVlcy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgcmV0dXJuIHsgeDogYWRqdXN0bWVudFZhbHVlc1swXSwgeTogYWRqdXN0bWVudFZhbHVlc1sxXSB9O1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFNlY29uZCwgdHJ5IG1vdGlvbi10eXBlLXNwZWNpZmljIGFkanVzdG1lbnQgKGZvciBsZXR0ZXJzIGxpa2UgSSlcbiAgICBjb25zdCBtb3Rpb25UeXBlS2V5ID0gbW90aW9uRGF0YS5tb3Rpb25UeXBlPy50b0xvd2VyQ2FzZSgpIHx8IFwiXCI7XG5cbiAgICBpZiAobW90aW9uVHlwZUtleSBpbiB0dXJuRGF0YSkge1xuICAgICAgY29uc3QgYWRqdXN0bWVudFZhbHVlcyA9IHR1cm5EYXRhW21vdGlvblR5cGVLZXldO1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYWRqdXN0bWVudFZhbHVlcykgJiYgYWRqdXN0bWVudFZhbHVlcy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgcmV0dXJuIHsgeDogYWRqdXN0bWVudFZhbHVlc1swXSwgeTogYWRqdXN0bWVudFZhbHVlc1sxXSB9O1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIExvYWQgc3BlY2lhbCBwbGFjZW1lbnQgZGF0YSBmcm9tIEpTT04gY29uZmlndXJhdGlvbiBmaWxlcy5cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZW5zdXJlTGV0dGVyUGxhY2VtZW50c0xvYWRlZChcbiAgICBncmlkTW9kZTogc3RyaW5nLFxuICAgIG9yaUtleTogc3RyaW5nLFxuICAgIGxldHRlcjogc3RyaW5nXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBpZiAoIXRoaXMuc3BlY2lhbFBsYWNlbWVudHNbZ3JpZE1vZGVdKSB7XG4gICAgICAgIHRoaXMuc3BlY2lhbFBsYWNlbWVudHNbZ3JpZE1vZGVdID0ge30gYXMgUmVjb3JkPFxuICAgICAgICAgIHN0cmluZyxcbiAgICAgICAgICBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPj5cbiAgICAgICAgPjtcbiAgICAgIH1cbiAgICAgIGlmICghdGhpcy5zcGVjaWFsUGxhY2VtZW50c1tncmlkTW9kZV1bb3JpS2V5XSkge1xuICAgICAgICB0aGlzLnNwZWNpYWxQbGFjZW1lbnRzW2dyaWRNb2RlXVtvcmlLZXldID0ge30gYXMgUmVjb3JkPFxuICAgICAgICAgIHN0cmluZyxcbiAgICAgICAgICBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPlxuICAgICAgICA+O1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuc3BlY2lhbFBsYWNlbWVudHNbZ3JpZE1vZGVdW29yaUtleV1bbGV0dGVyXSkge1xuICAgICAgICByZXR1cm47IC8vIGFscmVhZHkgbG9hZGVkXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNhY2hlS2V5ID0gYCR7Z3JpZE1vZGV9OiR7b3JpS2V5fToke2xldHRlcn1gO1xuICAgICAgaWYgKHRoaXMubG9hZGluZ0NhY2hlLmhhcyhjYWNoZUtleSkpIHtcbiAgICAgICAgcmV0dXJuOyAvLyBsb2FkaW5nIGluIHByb2dyZXNzIG9yIGFscmVhZHkgYXR0ZW1wdGVkXG4gICAgICB9XG4gICAgICB0aGlzLmxvYWRpbmdDYWNoZS5hZGQoY2FjaGVLZXkpO1xuXG4gICAgICAvLyBGaWxlcyBhcmUgc2VydmVkIHVuZGVyIC9kYXRhLy4uLiBpbiB0aGUgd2ViIGFwcFxuICAgICAgLy8gRXhhbXBsZSBwYXRoOiAvZGF0YS9hcnJvd19wbGFjZW1lbnQvZGlhbW9uZC9zcGVjaWFsL2Zyb21fbGF5ZXIxL0FfcGxhY2VtZW50cy5qc29uXG4gICAgICBjb25zdCBlbmNvZGVkTGV0dGVyID0gZW5jb2RlVVJJQ29tcG9uZW50KGxldHRlcik7XG4gICAgICBjb25zdCBiYXNlUGF0aCA9IGAvZGF0YS9hcnJvd19wbGFjZW1lbnQvJHtncmlkTW9kZX0vc3BlY2lhbC8ke29yaUtleX0vJHtlbmNvZGVkTGV0dGVyfV9wbGFjZW1lbnRzLmpzb25gO1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZGF0YSA9IChhd2FpdCBqc29uQ2FjaGUuZ2V0KGJhc2VQYXRoKSkgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG4gICAgICAgIHRoaXMuc3BlY2lhbFBsYWNlbWVudHNbZ3JpZE1vZGVdW29yaUtleV1bbGV0dGVyXSA9IGRhdGE7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLnNwZWNpYWxQbGFjZW1lbnRzW2dyaWRNb2RlXVtvcmlLZXldW2xldHRlcl0gPSB7fTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGVuc3VyaW5nIHNwZWNpYWwgcGxhY2VtZW50IGRhdGE6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgdHVybnMgdHVwbGUgc3RyaW5nIG1hdGNoaW5nIHRoZSB0dXJuc190dXBsZV9nZW5lcmF0b3IgbG9naWMuXG4gICAqXG4gICAqIFRoaXMgY3JlYXRlcyBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgdHVybiB2YWx1ZXMgZm9yIGxvb2t1cCBpbiBKU09OIGRhdGEuXG4gICAqIEZvcm1hdDogXCIoYmx1ZV90dXJucywgcmVkX3R1cm5zKVwiIGUuZy4sIFwiKDAsIDEuNSlcIiwgXCIoMSwgMC41KVwiXG4gICAqL1xuICBwcml2YXRlIGdlbmVyYXRlVHVybnNUdXBsZShwaWN0b2dyYXBoRGF0YTogUGljdG9ncmFwaERhdGEpOiBzdHJpbmcge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBibHVlTW90aW9uID0gcGljdG9ncmFwaERhdGEubW90aW9ucz8uYmx1ZTtcbiAgICAgIGNvbnN0IHJlZE1vdGlvbiA9IHBpY3RvZ3JhcGhEYXRhLm1vdGlvbnM/LnJlZDtcblxuICAgICAgaWYgKGJsdWVNb3Rpb24gJiYgcmVkTW90aW9uKSB7XG4gICAgICAgIGNvbnN0IGJsdWVUdXJucyA9XG4gICAgICAgICAgdHlwZW9mIGJsdWVNb3Rpb24udHVybnMgPT09IFwibnVtYmVyXCIgPyBibHVlTW90aW9uLnR1cm5zIDogMDtcbiAgICAgICAgY29uc3QgcmVkVHVybnMgPVxuICAgICAgICAgIHR5cGVvZiByZWRNb3Rpb24udHVybnMgPT09IFwibnVtYmVyXCIgPyByZWRNb3Rpb24udHVybnMgOiAwO1xuXG4gICAgICAgIGNvbnN0IGJsdWVTdHIgPVxuICAgICAgICAgIGJsdWVUdXJucyA9PT0gTWF0aC5mbG9vcihibHVlVHVybnMpXG4gICAgICAgICAgICA/IE1hdGguZmxvb3IoYmx1ZVR1cm5zKS50b1N0cmluZygpXG4gICAgICAgICAgICA6IGJsdWVUdXJucy50b1N0cmluZygpO1xuICAgICAgICBjb25zdCByZWRTdHIgPVxuICAgICAgICAgIHJlZFR1cm5zID09PSBNYXRoLmZsb29yKHJlZFR1cm5zKVxuICAgICAgICAgICAgPyBNYXRoLmZsb29yKHJlZFR1cm5zKS50b1N0cmluZygpXG4gICAgICAgICAgICA6IHJlZFR1cm5zLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgcmV0dXJuIGAoJHtibHVlU3RyfSwgJHtyZWRTdHJ9KWA7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBcIigwLCAwKVwiO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gXCIoMCwgMClcIjtcbiAgICB9XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6IkFBaUJBLFNBQVMsdUNBQXVDO0FBQ2hELFNBQVMsaUJBQWlCO0FBUW5CLGFBQU0sd0JBQTREO0FBQUE7QUFBQSxFQUUvRCxvQkFHSixDQUFDO0FBQUEsRUFDRyxlQUE0QixvQkFBSSxJQUFJO0FBQUEsRUFDcEM7QUFBQSxFQUVSLGNBQWM7QUFFWixTQUFLLG9CQUFvQixFQUFFLFNBQVMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxFQUFFO0FBSWhELFNBQUssa0JBQWtCLElBQUksZ0NBQWdDO0FBQUEsRUFDN0Q7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFVQSxNQUFNLHFCQUNKLFlBQ0EsZ0JBQ0EsWUFDdUI7QUFDdkIsUUFBSSxDQUFDLGNBQWMsQ0FBQyxlQUFlLFFBQVE7QUFDekMsYUFBTztBQUFB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