/* BeatFrameService.svelte.ts generated by Svelte v5.38.1 */
import * as $ from "/node_modules/.vite/deps/svelte_internal_client.js?v=cc8aba6c";
import { GridMode } from "/src/lib/domain/index.ts";

class BeatFrameService {
	// Configuration state
	#config = $.tag(
		$.state($.proxy({
			columns: 4,

			// columns for beats only
			beatSize: 160,

			// Increased default fallback size from 120 to 160
			gap: 0,

			// Desktop parity: zero spacing between cells
			gridMode: GridMode.DIAMOND,

			hasStartTile: true
		})),
		'BeatFrameService.#config'
	);

	// Container dimensions state
	#containerDimensions = $.tag($.state($.proxy({ width: 0, height: 0, isFullscreen: false })), 'BeatFrameService.#containerDimensions');

	// Interaction state
	#hoveredBeatIndex = $.tag($.state(-1), 'BeatFrameService.#hoveredBeatIndex');

	#draggedBeatIndex = $.tag($.state(-1), 'BeatFrameService.#draggedBeatIndex');

	// Beat count grid mapping from legacy (optimal layouts)
	beatCountGridMap = {
		1: [1, 1],

		// One beat + start position
		2: [1, 2],

		3: [1, 3],
		4: [1, 4],
		5: [2, 4],
		6: [2, 4],
		7: [2, 4],
		8: [2, 4],
		9: [3, 4],
		10: [3, 4],
		11: [3, 4],
		12: [3, 4],
		13: [4, 4],
		14: [4, 4],
		15: [4, 4],
		16: [4, 4],
		17: [5, 4],
		18: [5, 4],
		19: [5, 4],
		20: [5, 4],
		21: [6, 4],
		22: [6, 4],
		23: [6, 4],
		24: [6, 4],
		25: [7, 4],
		26: [7, 4],
		27: [7, 4],
		28: [7, 4],
		29: [8, 4],
		30: [8, 4],
		31: [8, 4],
		32: [8, 4]
	};

	#_config = $.tag(
		$.derived(() => $.get(
			// Derived state
			this.#config
		)),
		'BeatFrameService.config'
	);

	get config() {
		return $.get(this.#_config);
	}

	set config(value) {
		$.set(this.#_config, value);
	}

	#_hoveredBeatIndex = $.tag($.derived(() => $.get(this.#hoveredBeatIndex)), 'BeatFrameService.hoveredBeatIndex');

	get hoveredBeatIndex() {
		return $.get(this.#_hoveredBeatIndex);
	}

	set hoveredBeatIndex(value) {
		$.set(this.#_hoveredBeatIndex, value);
	}

	#_draggedBeatIndex = $.tag($.derived(() => $.get(this.#draggedBeatIndex)), 'BeatFrameService.draggedBeatIndex');

	get draggedBeatIndex() {
		return $.get(this.#_draggedBeatIndex);
	}

	set draggedBeatIndex(value) {
		$.set(this.#_draggedBeatIndex, value);
	}

	#_containerDimensions = $.tag($.derived(() => $.get(this.#containerDimensions)), 'BeatFrameService.containerDimensions');

	get containerDimensions() {
		return $.get(this.#_containerDimensions);
	}

	set containerDimensions(value) {
		$.set(this.#_containerDimensions, value);
	}

	setConfig(updates) {
		$.set(this.#config, { ...$.get(this.#config), ...updates }, true);
	}

	setContainerDimensions(width, height, isFullscreen = false) {
		if ($.strict_equals($.get(this.#containerDimensions).width, width) && $.strict_equals($.get(this.#containerDimensions).height, height) && $.strict_equals($.get(this.#containerDimensions).isFullscreen, isFullscreen)) {
			return;
		}

		$.set(this.#containerDimensions, { width, height, isFullscreen }, true);
	}

	setHoveredBeat(index) {
		$.set(this.#hoveredBeatIndex, index, true);
	}

	clearHoveredBeat() {
		$.set(this.#hoveredBeatIndex, -1);
	}

	setDraggedBeat(index) {
		$.set(this.#draggedBeatIndex, index, true);
	}

	clearDraggedBeat() {
		$.set(this.#draggedBeatIndex, -1);
	}

	// Layout calculations with legacy logic
	autoAdjustLayout(beatCount) {
		if (beatCount <= 0) return [1, 0];
		if ($.strict_equals(beatCount, 1)) return [1, 1];

		if (beatCount <= 32 && this.beatCountGridMap[beatCount]) {
			return this.beatCountGridMap[beatCount];
		}

		const cols = 4;
		const rows = Math.ceil(beatCount / cols);

		return [rows, cols];
	}

	/**
	 * Calculate the optimal cell size for the beat frame grid (from legacy)
	 */
	calculateCellSize(
		beatCount,
		containerWidth,
		containerHeight,
		totalRows,
		totalCols,
		gap
	) {
		const MIN_CELL_SIZE_FULLSCREEN = 140;
		const MIN_CELL_SIZE_NORMAL = 120;

		if (containerWidth <= 0 || containerHeight <= 0 || totalRows <= 0 || totalCols <= 0) {
			return 140;
		}

		const isLikelyFullscreen = $.get(this.#containerDimensions).isFullscreen || containerWidth > 800 && containerHeight > 600;
		const minCellSize = isLikelyFullscreen ? MIN_CELL_SIZE_FULLSCREEN : MIN_CELL_SIZE_NORMAL;
		const totalGapWidth = gap * (totalCols - 1);
		const totalGapHeight = gap * (totalRows - 1);
		const horizontalPadding = $.strict_equals(beatCount, 0) ? containerWidth * 0.02 : 8;
		const verticalPadding = 16;
		const availableWidth = Math.max(0, containerWidth - totalGapWidth - horizontalPadding * 2);
		const availableHeight = Math.max(0, containerHeight - totalGapHeight - verticalPadding * 2);
		const cellWidthByContainer = Math.floor(availableWidth / totalCols);
		const cellHeightByContainer = Math.floor(availableHeight / totalRows);
		const baseSize = Math.min(cellWidthByContainer, cellHeightByContainer);
		const scalingFactor = 0.98;
		const scaledBaseSize = Math.floor(baseSize * scalingFactor);
		const cellSize = $.strict_equals(beatCount, 0) ? scaledBaseSize * 1.1 : scaledBaseSize;

		if (cellSize < minCellSize) {
			if (isLikelyFullscreen) {
				return Math.min(Math.max(minCellSize, MIN_CELL_SIZE_FULLSCREEN), 300);
			} else {
				return Math.min(Math.max(minCellSize, MIN_CELL_SIZE_NORMAL), 250);
			}
		}

		if (isLikelyFullscreen) {
			return Math.min(Math.max(cellSize, MIN_CELL_SIZE_FULLSCREEN), 300);
		} else {
			return Math.min(Math.max(cellSize, MIN_CELL_SIZE_NORMAL), 250);
		}
	}

	/**
	 * Update beat size based on current container dimensions
	 */
	updateBeatSizeFromContainer(beatCount = 0) {
		if ($.get(this.#containerDimensions).width <= 0 || $.get(this.#containerDimensions).height <= 0) {
			return;
		}

		const [rows, cols] = this.autoAdjustLayout(beatCount);
		const totalCols = cols + ($.get(this.#config).hasStartTile ? 1 : 0);
		const newCellSize = this.calculateCellSize(beatCount, $.get(this.#containerDimensions).width, $.get(this.#containerDimensions).height, rows, totalCols, $.get(this.#config).gap);

		$.set(this.#config, { ...$.get(this.#config), beatSize: newCellSize, columns: cols }, true);
	}

	totalColumns() {
		return $.get(this.#config).columns + ($.get(this.#config).hasStartTile ? 1 : 0);
	}

	calculateBeatPosition(index, beatCount) {
		const [, cols] = this.autoAdjustLayout(beatCount ?? index + 1);
		const columnsForBeats = Math.max(1, cols);
		const row = Math.floor(index / columnsForBeats);
		const col = index % columnsForBeats + ($.get(this.#config).hasStartTile ? 1 : 0);
		const step = $.get(this.#config).beatSize + $.get(this.#config).gap;

		return { x: col * step, y: row * step };
	}

	calculateStartPosition(beatCount) {
		if (beatCount <= 0) {
			const layoutInfo = this.calculateLayoutInfo(beatCount);
			const frameWidth = layoutInfo.totalWidth;
			const frameHeight = layoutInfo.totalHeight;
			const beatSize = $.get(this.#config).beatSize;
			const x = (frameWidth - beatSize) / 2;
			const y = (frameHeight - beatSize) / 2;

			return { x, y };
		}

		return { x: 0, y: 0 };
	}

	calculateFrameDimensions(beatCount) {
		const step = $.get(this.#config).beatSize + $.get(this.#config).gap;

		if (beatCount <= 0) {
			const width = $.get(this.#config).hasStartTile ? $.get(this.#config).beatSize : 0;
			const height = $.get(this.#config).beatSize;

			return { width, height };
		}

		const [rows, cols] = this.autoAdjustLayout(beatCount);
		const totalCols = cols + ($.get(this.#config).hasStartTile ? 1 : 0);

		return {
			width: totalCols * step - $.get(this.#config).gap,
			height: rows * step - $.get(this.#config).gap
		};
	}

	/**
	 * Calculate comprehensive layout information including overflow detection (PURE)
	 */
	calculateLayoutInfo(beatCount) {
		const [rows, cols] = this.autoAdjustLayout(beatCount);
		const totalCols = cols + ($.get(this.#config).hasStartTile ? 1 : 0);
		const optimalCellSize = this.calculateOptimalCellSize(beatCount, rows, totalCols);
		const step = optimalCellSize + $.get(this.#config).gap;
		const totalWidth = totalCols * step - $.get(this.#config).gap;
		const totalHeight = rows * step - $.get(this.#config).gap;
		const containerWidth = $.get(this.#containerDimensions).width;
		const containerHeight = $.get(this.#containerDimensions).height;
		const shouldScroll = containerWidth > 0 && totalWidth > containerWidth || containerHeight > 0 && totalHeight > containerHeight || optimalCellSize <= ($.get(this.#containerDimensions).isFullscreen ? 140 : 120) * 1.1;

		return {
			rows,
			columns: cols,
			cellSize: optimalCellSize,
			totalWidth,
			totalHeight,
			shouldScroll
		};
	}

	/**
	 * Calculate optimal cell size without mutating state (PURE)
	 */
	calculateOptimalCellSize(beatCount, rows, totalCols) {
		try {
			if ($.get(this.#containerDimensions).width <= 0 || $.get(this.#containerDimensions).height <= 0) {
				return $.get(this.#config).beatSize;
			}

			const result = this.calculateCellSize(beatCount, $.get(this.#containerDimensions).width, $.get(this.#containerDimensions).height, rows, totalCols, $.get(this.#config).gap);

			return isNaN(result) || result <= 0 ? $.get(this.#config).beatSize : result;
		} catch(error) {
			console.warn(...$.log_if_contains_state('warn', "Error calculating optimal cell size:", error));

			return $.get(this.#config).beatSize;
		}
	}

	// Beat interaction helpers
	getBeatAtPosition(x, y, beatCount) {
		const step = $.get(this.#config).beatSize + $.get(this.#config).gap;
		const colRaw = Math.floor(x / step);
		const row = Math.floor(y / step);
		const startOffset = $.get(this.#config).hasStartTile ? 1 : 0;

		if (colRaw < startOffset) return -1;

		const col = colRaw - startOffset;
		const index = row * Math.max(1, $.get(this.#config).columns) + col;

		return index >= 0 && index < beatCount ? index : -1;
	}

	isBeatVisible(beat) {
		return !beat.isBlank || $.equals(beat.pictographData, null, false);
	}

	getBeatDisplayText(beat) {
		if (beat.isBlank && !beat.pictographData) {
			return (beat.beatNumber ?? beat.metadata?.beatNumber ?? "").toString();
		}

		const metadataLetter = beat.metadata?.letter;

		return beat.pictographData?.letter ?? ($.strict_equals(typeof metadataLetter, "string") ? metadataLetter : "") ?? "";
	}
}

export const beatFrameService = new BeatFrameService();
//# sourceMappingURL=data:application/json;base64,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akQsU0FBUyxLQUFLLFFBQVEsWUFBWSxTQUFRO0NBQ25EOztDQUVBLGNBQWMsTUFBeUI7VUFDN0IsS0FBSyxvQkFBVyxLQUFLLGdCQUFrQjtDQUNqRDs7Q0FFQSxtQkFBbUIsTUFBd0I7TUFDckMsS0FBSyxZQUFZLEtBQUssZ0JBQWdCO1dBR3RDLEtBQUssY0FDSixLQUFLLFVBQXNDLGNBQzVDLElBQ0E7RUFDSjs7UUFDTSxpQkFBa0IsS0FBSyxVQUFzQzs7U0FFakUsS0FBSyxnQkFBZ0Isa0NBQ2IsZ0JBQW1CLFlBQVcsaUJBQWlCLE9BQ3ZEO0NBRUo7QUFDRjs7YUFHYSx1QkFBdUIiLCJuYW1lcyI6W10sImlnbm9yZUxpc3QiOltdLCJzb3VyY2VzIjpbIkJlYXRGcmFtZVNlcnZpY2Uuc3ZlbHRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQmVhdCBGcmFtZSBTZXJ2aWNlIChSdW5lcy1iYXNlZCkgLSBFbmhhbmNlZCB3aXRoIExlZ2FjeSBTaXppbmcgTG9naWNcbiAqXG4gKiBNYW5hZ2VzIGJlYXQgZnJhbWUgbGF5b3V0IGFuZCBpbnRlcmFjdGlvbnMgZm9yIHRoZSBXb3JrYmVuY2guXG4gKiBOb3cgc3VwcG9ydHMgcmVzcG9uc2l2ZSBzaXppbmcgYmFzZWQgb24gY29udGFpbmVyIGRpbWVuc2lvbnMgbGlrZSB0aGUgbGVnYWN5IGFwcC5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7IEJlYXREYXRhIH0gZnJvbSBcIi4uL2RvbWFpblwiO1xuaW1wb3J0IHsgR3JpZE1vZGUgfSBmcm9tIFwiLi4vZG9tYWluXCI7XG5cbmludGVyZmFjZSBCZWF0RnJhbWVDb25maWcge1xuICAvKiogTnVtYmVyIG9mIGNvbHVtbnMgYWxsb2NhdGVkIGZvciBCRUFUUyAoZXhjbHVkZXMgdGhlIFN0YXJ0IHRpbGUgY29sdW1uKSAqL1xuICBjb2x1bW5zOiBudW1iZXI7XG4gIGJlYXRTaXplOiBudW1iZXI7XG4gIGdhcDogbnVtYmVyO1xuICBncmlkTW9kZTogR3JpZE1vZGU7XG4gIC8qKiBXaGV0aGVyIHRvIHJlc2VydmUgdGhlIGZpcnN0IGNvbHVtbiBmb3IgdGhlIFN0YXJ0IFBvc2l0aW9uIHRpbGUgKi9cbiAgaGFzU3RhcnRUaWxlOiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgQ29udGFpbmVyRGltZW5zaW9ucyB7XG4gIHdpZHRoOiBudW1iZXI7XG4gIGhlaWdodDogbnVtYmVyO1xuICBpc0Z1bGxzY3JlZW46IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBMYXlvdXRJbmZvIHtcbiAgcm93czogbnVtYmVyO1xuICBjb2x1bW5zOiBudW1iZXI7XG4gIGNlbGxTaXplOiBudW1iZXI7XG4gIHRvdGFsV2lkdGg6IG51bWJlcjtcbiAgdG90YWxIZWlnaHQ6IG51bWJlcjtcbiAgc2hvdWxkU2Nyb2xsOiBib29sZWFuO1xufVxuXG5jbGFzcyBCZWF0RnJhbWVTZXJ2aWNlIHtcbiAgLy8gQ29uZmlndXJhdGlvbiBzdGF0ZVxuICAjY29uZmlnID0gJHN0YXRlPEJlYXRGcmFtZUNvbmZpZz4oe1xuICAgIGNvbHVtbnM6IDQsIC8vIGNvbHVtbnMgZm9yIGJlYXRzIG9ubHlcbiAgICBiZWF0U2l6ZTogMTYwLCAvLyBJbmNyZWFzZWQgZGVmYXVsdCBmYWxsYmFjayBzaXplIGZyb20gMTIwIHRvIDE2MFxuICAgIGdhcDogMCwgLy8gRGVza3RvcCBwYXJpdHk6IHplcm8gc3BhY2luZyBiZXR3ZWVuIGNlbGxzXG4gICAgZ3JpZE1vZGU6IEdyaWRNb2RlLkRJQU1PTkQsXG4gICAgaGFzU3RhcnRUaWxlOiB0cnVlLFxuICB9KTtcblxuICAvLyBDb250YWluZXIgZGltZW5zaW9ucyBzdGF0ZVxuICAjY29udGFpbmVyRGltZW5zaW9ucyA9ICRzdGF0ZTxDb250YWluZXJEaW1lbnNpb25zPih7XG4gICAgd2lkdGg6IDAsXG4gICAgaGVpZ2h0OiAwLFxuICAgIGlzRnVsbHNjcmVlbjogZmFsc2UsXG4gIH0pO1xuXG4gIC8vIEludGVyYWN0aW9uIHN0YXRlXG4gICNob3ZlcmVkQmVhdEluZGV4ID0gJHN0YXRlPG51bWJlcj4oLTEpO1xuICAjZHJhZ2dlZEJlYXRJbmRleCA9ICRzdGF0ZTxudW1iZXI+KC0xKTtcblxuICAvLyBCZWF0IGNvdW50IGdyaWQgbWFwcGluZyBmcm9tIGxlZ2FjeSAob3B0aW1hbCBsYXlvdXRzKVxuICBwcml2YXRlIHJlYWRvbmx5IGJlYXRDb3VudEdyaWRNYXA6IFJlY29yZDxudW1iZXIsIFtudW1iZXIsIG51bWJlcl0+ID0ge1xuICAgIDE6IFsxLCAxXSwgLy8gT25lIGJlYXQgKyBzdGFydCBwb3NpdGlvblxuICAgIDI6IFsxLCAyXSxcbiAgICAzOiBbMSwgM10sXG4gICAgNDogWzEsIDRdLFxuICAgIDU6IFsyLCA0XSxcbiAgICA2OiBbMiwgNF0sXG4gICAgNzogWzIsIDRdLFxuICAgIDg6IFsyLCA0XSxcbiAgICA5OiBbMywgNF0sXG4gICAgMTA6IFszLCA0XSxcbiAgICAxMTogWzMsIDRdLFxuICAgIDEyOiBbMywgNF0sXG4gICAgMTM6IFs0LCA0XSxcbiAgICAxNDogWzQsIDRdLFxuICAgIDE1OiBbNCwgNF0sXG4gICAgMTY6IFs0LCA0XSxcbiAgICAxNzogWzUsIDRdLFxuICAgIDE4OiBbNSwgNF0sXG4gICAgMTk6IFs1LCA0XSxcbiAgICAyMDogWzUsIDRdLFxuICAgIDIxOiBbNiwgNF0sXG4gICAgMjI6IFs2LCA0XSxcbiAgICAyMzogWzYsIDRdLFxuICAgIDI0OiBbNiwgNF0sXG4gICAgMjU6IFs3LCA0XSxcbiAgICAyNjogWzcsIDRdLFxuICAgIDI3OiBbNywgNF0sXG4gICAgMjg6IFs3LCA0XSxcbiAgICAyOTogWzgsIDRdLFxuICAgIDMwOiBbOCwgNF0sXG4gICAgMzE6IFs4LCA0XSxcbiAgICAzMjogWzgsIDRdLFxuICB9O1xuXG4gIC8vIERlcml2ZWQgc3RhdGVcbiAgcmVhZG9ubHkgY29uZmlnID0gJGRlcml2ZWQodGhpcy4jY29uZmlnKTtcbiAgcmVhZG9ubHkgaG92ZXJlZEJlYXRJbmRleCA9ICRkZXJpdmVkKHRoaXMuI2hvdmVyZWRCZWF0SW5kZXgpO1xuICByZWFkb25seSBkcmFnZ2VkQmVhdEluZGV4ID0gJGRlcml2ZWQodGhpcy4jZHJhZ2dlZEJlYXRJbmRleCk7XG4gIHJlYWRvbmx5IGNvbnRhaW5lckRpbWVuc2lvbnMgPSAkZGVyaXZlZCh0aGlzLiNjb250YWluZXJEaW1lbnNpb25zKTtcblxuICAvLyBBY3Rpb25zXG4gIHNldENvbmZpZyh1cGRhdGVzOiBQYXJ0aWFsPEJlYXRGcmFtZUNvbmZpZz4pOiB2b2lkIHtcbiAgICB0aGlzLiNjb25maWcgPSB7IC4uLnRoaXMuI2NvbmZpZywgLi4udXBkYXRlcyB9O1xuICB9XG5cbiAgc2V0Q29udGFpbmVyRGltZW5zaW9ucyhcbiAgICB3aWR0aDogbnVtYmVyLFxuICAgIGhlaWdodDogbnVtYmVyLFxuICAgIGlzRnVsbHNjcmVlbiA9IGZhbHNlXG4gICk6IHZvaWQge1xuICAgIC8vIE9ubHkgdXBkYXRlIGlmIGRpbWVuc2lvbnMgYWN0dWFsbHkgY2hhbmdlZCB0byBwcmV2ZW50IGxvb3BzXG4gICAgaWYgKFxuICAgICAgdGhpcy4jY29udGFpbmVyRGltZW5zaW9ucy53aWR0aCA9PT0gd2lkdGggJiZcbiAgICAgIHRoaXMuI2NvbnRhaW5lckRpbWVuc2lvbnMuaGVpZ2h0ID09PSBoZWlnaHQgJiZcbiAgICAgIHRoaXMuI2NvbnRhaW5lckRpbWVuc2lvbnMuaXNGdWxsc2NyZWVuID09PSBpc0Z1bGxzY3JlZW5cbiAgICApIHtcbiAgICAgIHJldHVybjsgLy8gTm8gY2hhbmdlLCBza2lwIHVwZGF0ZVxuICAgIH1cblxuICAgIHRoaXMuI2NvbnRhaW5lckRpbWVuc2lvbnMgPSB7XG4gICAgICB3aWR0aCxcbiAgICAgIGhlaWdodCxcbiAgICAgIGlzRnVsbHNjcmVlbixcbiAgICB9O1xuXG4gICAgLy8gRG9uJ3QgYXV0b21hdGljYWxseSByZWNhbGN1bGF0ZSBoZXJlIC0gbGV0IGNvbXBvbmVudHMgdHJpZ2dlciB3aGVuIG5lZWRlZFxuICB9XG5cbiAgc2V0SG92ZXJlZEJlYXQoaW5kZXg6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuI2hvdmVyZWRCZWF0SW5kZXggPSBpbmRleDtcbiAgfVxuXG4gIGNsZWFySG92ZXJlZEJlYXQoKTogdm9pZCB7XG4gICAgdGhpcy4jaG92ZXJlZEJlYXRJbmRleCA9IC0xO1xuICB9XG5cbiAgc2V0RHJhZ2dlZEJlYXQoaW5kZXg6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuI2RyYWdnZWRCZWF0SW5kZXggPSBpbmRleDtcbiAgfVxuXG4gIGNsZWFyRHJhZ2dlZEJlYXQoKTogdm9pZCB7XG4gICAgdGhpcy4jZHJhZ2dlZEJlYXRJbmRleCA9IC0xO1xuICB9XG5cbiAgLy8gTGF5b3V0IGNhbGN1bGF0aW9ucyB3aXRoIGxlZ2FjeSBsb2dpY1xuICBwcml2YXRlIGF1dG9BZGp1c3RMYXlvdXQoYmVhdENvdW50OiBudW1iZXIpOiBbbnVtYmVyLCBudW1iZXJdIHtcbiAgICAvLyBGb3IgZW1wdHkgc2VxdWVuY2UgKG5vIGJlYXRzKSwgdXNlIHplcm8gY29sdW1ucyBmb3IgYmVhdHMgc2luY2Ugc3RhcnQgdGlsZSBpcyBhZGRlZCBzZXBhcmF0ZWx5XG4gICAgaWYgKGJlYXRDb3VudCA8PSAwKSByZXR1cm4gWzEsIDBdO1xuICAgIGlmIChiZWF0Q291bnQgPT09IDEpIHJldHVybiBbMSwgMV07IC8vIFNpbmdsZSBiZWF0ICsgc3RhcnQgcG9zaXRpb25cblxuICAgIC8vIFVzZSBwcmVkZWZpbmVkIGxheW91dHMgZm9yIGNvbW1vbiBiZWF0IGNvdW50c1xuICAgIGlmIChiZWF0Q291bnQgPD0gMzIgJiYgdGhpcy5iZWF0Q291bnRHcmlkTWFwW2JlYXRDb3VudF0pIHtcbiAgICAgIHJldHVybiB0aGlzLmJlYXRDb3VudEdyaWRNYXBbYmVhdENvdW50XTtcbiAgICB9XG5cbiAgICAvLyBEZWZhdWx0IGxheW91dCBmb3IgbGFyZ2VyIHNlcXVlbmNlc1xuICAgIGNvbnN0IGNvbHMgPSA0O1xuICAgIGNvbnN0IHJvd3MgPSBNYXRoLmNlaWwoYmVhdENvdW50IC8gY29scyk7XG4gICAgcmV0dXJuIFtyb3dzLCBjb2xzXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgdGhlIG9wdGltYWwgY2VsbCBzaXplIGZvciB0aGUgYmVhdCBmcmFtZSBncmlkIChmcm9tIGxlZ2FjeSlcbiAgICovXG4gIHByaXZhdGUgY2FsY3VsYXRlQ2VsbFNpemUoXG4gICAgYmVhdENvdW50OiBudW1iZXIsXG4gICAgY29udGFpbmVyV2lkdGg6IG51bWJlcixcbiAgICBjb250YWluZXJIZWlnaHQ6IG51bWJlcixcbiAgICB0b3RhbFJvd3M6IG51bWJlcixcbiAgICB0b3RhbENvbHM6IG51bWJlcixcbiAgICBnYXA6IG51bWJlclxuICApOiBudW1iZXIge1xuICAgIC8vIEluY3JlYXNlZCBtaW5pbXVtIGNlbGwgc2l6ZSB0aHJlc2hvbGRzIGZvciBiZXR0ZXIgdmlzaWJpbGl0eVxuICAgIGNvbnN0IE1JTl9DRUxMX1NJWkVfRlVMTFNDUkVFTiA9IDE0MDsgLy8gSW5jcmVhc2VkIGZyb20gMTAwcHhcbiAgICBjb25zdCBNSU5fQ0VMTF9TSVpFX05PUk1BTCA9IDEyMDsgLy8gSW5jcmVhc2VkIGZyb20gNzBweFxuXG4gICAgLy8gRW5zdXJlIHdlIGhhdmUgdmFsaWQgZGltZW5zaW9uc1xuICAgIGlmIChcbiAgICAgIGNvbnRhaW5lcldpZHRoIDw9IDAgfHxcbiAgICAgIGNvbnRhaW5lckhlaWdodCA8PSAwIHx8XG4gICAgICB0b3RhbFJvd3MgPD0gMCB8fFxuICAgICAgdG90YWxDb2xzIDw9IDBcbiAgICApIHtcbiAgICAgIHJldHVybiAxNDA7IC8vIEluY3JlYXNlZCBkZWZhdWx0IGZhbGxiYWNrIHNpemVcbiAgICB9XG5cbiAgICAvLyBEZXRlY3QgaWYgd2UncmUgaW4gZnVsbHNjcmVlbiBtb2RlIGJ5IGNoZWNraW5nIGNvbnRhaW5lciBkaW1lbnNpb25zXG4gICAgY29uc3QgaXNMaWtlbHlGdWxsc2NyZWVuID1cbiAgICAgIHRoaXMuI2NvbnRhaW5lckRpbWVuc2lvbnMuaXNGdWxsc2NyZWVuIHx8XG4gICAgICAoY29udGFpbmVyV2lkdGggPiA4MDAgJiYgY29udGFpbmVySGVpZ2h0ID4gNjAwKTtcblxuICAgIC8vIFNldCB0aGUgbWluaW11bSBjZWxsIHNpemUgYmFzZWQgb24gbW9kZVxuICAgIGNvbnN0IG1pbkNlbGxTaXplID0gaXNMaWtlbHlGdWxsc2NyZWVuXG4gICAgICA/IE1JTl9DRUxMX1NJWkVfRlVMTFNDUkVFTlxuICAgICAgOiBNSU5fQ0VMTF9TSVpFX05PUk1BTDtcblxuICAgIC8vIENhbGN1bGF0ZSB0b3RhbCBzcGFjZSBuZWVkZWQgZm9yIGdhcHNcbiAgICBjb25zdCB0b3RhbEdhcFdpZHRoID0gZ2FwICogKHRvdGFsQ29scyAtIDEpO1xuICAgIGNvbnN0IHRvdGFsR2FwSGVpZ2h0ID0gZ2FwICogKHRvdGFsUm93cyAtIDEpO1xuXG4gICAgLy8gUmVkdWNlZCBwYWRkaW5nIGZvciBtb3JlIHNwYWNlIHV0aWxpemF0aW9uXG4gICAgY29uc3QgaG9yaXpvbnRhbFBhZGRpbmcgPSBiZWF0Q291bnQgPT09IDAgPyBjb250YWluZXJXaWR0aCAqIDAuMDIgOiA4OyAvLyBSZWR1Y2VkIGZyb20gMC4wNSBhbmQgMTBcbiAgICBjb25zdCB2ZXJ0aWNhbFBhZGRpbmcgPSAxNjsgLy8gUmVkdWNlZCBmcm9tIDI0XG4gICAgY29uc3QgYXZhaWxhYmxlV2lkdGggPSBNYXRoLm1heChcbiAgICAgIDAsXG4gICAgICBjb250YWluZXJXaWR0aCAtIHRvdGFsR2FwV2lkdGggLSBob3Jpem9udGFsUGFkZGluZyAqIDJcbiAgICApO1xuICAgIGNvbnN0IGF2YWlsYWJsZUhlaWdodCA9IE1hdGgubWF4KFxuICAgICAgMCxcbiAgICAgIGNvbnRhaW5lckhlaWdodCAtIHRvdGFsR2FwSGVpZ2h0IC0gdmVydGljYWxQYWRkaW5nICogMlxuICAgICk7XG5cbiAgICAvLyBDYWxjdWxhdGUgY2VsbCBzaXplIGJhc2VkIG9uIGF2YWlsYWJsZSBzcGFjZSBpbiBib3RoIGRpbWVuc2lvbnNcbiAgICBjb25zdCBjZWxsV2lkdGhCeUNvbnRhaW5lciA9IE1hdGguZmxvb3IoYXZhaWxhYmxlV2lkdGggLyB0b3RhbENvbHMpO1xuICAgIGNvbnN0IGNlbGxIZWlnaHRCeUNvbnRhaW5lciA9IE1hdGguZmxvb3IoYXZhaWxhYmxlSGVpZ2h0IC8gdG90YWxSb3dzKTtcblxuICAgIC8vIFVzZSB0aGUgc21hbGxlciBkaW1lbnNpb24gdG8gbWFpbnRhaW4gc3F1YXJlIGNlbGxzIGFuZCBwcmVzZXJ2ZSBhc3BlY3QgcmF0aW9cbiAgICBjb25zdCBiYXNlU2l6ZSA9IE1hdGgubWluKGNlbGxXaWR0aEJ5Q29udGFpbmVyLCBjZWxsSGVpZ2h0QnlDb250YWluZXIpO1xuXG4gICAgLy8gUmVkdWNlZCBzY2FsaW5nIGZhY3RvciB0byBwcmVzZXJ2ZSBtb3JlIHNpemVcbiAgICBjb25zdCBzY2FsaW5nRmFjdG9yID0gMC45ODsgLy8gUmVkdWNlZCBzY2FsaW5nIGZyb20gMC45MiB0byAwLjk4IChvbmx5IDIlIHJlZHVjdGlvbilcbiAgICBjb25zdCBzY2FsZWRCYXNlU2l6ZSA9IE1hdGguZmxvb3IoYmFzZVNpemUgKiBzY2FsaW5nRmFjdG9yKTtcblxuICAgIC8vIEZvciBzdGFydCBwb3NpdGlvbiBvbmx5LCBtYWtlIGl0IHByb3BvcnRpb25hbGx5IGxhcmdlclxuICAgIGNvbnN0IGNlbGxTaXplID0gYmVhdENvdW50ID09PSAwID8gc2NhbGVkQmFzZVNpemUgKiAxLjEgOiBzY2FsZWRCYXNlU2l6ZTtcblxuICAgIC8vIENoZWNrIGlmIHRoZSBjYWxjdWxhdGVkIGNlbGwgc2l6ZSBpcyBiZWxvdyB0aGUgbWluaW11bSB0aHJlc2hvbGRcbiAgICBpZiAoY2VsbFNpemUgPCBtaW5DZWxsU2l6ZSkge1xuICAgICAgLy8gQXBwbHkgZGlmZmVyZW50IGNvbnN0cmFpbnRzIGJhc2VkIG9uIG1vZGVcbiAgICAgIGlmIChpc0xpa2VseUZ1bGxzY3JlZW4pIHtcbiAgICAgICAgcmV0dXJuIE1hdGgubWluKE1hdGgubWF4KG1pbkNlbGxTaXplLCBNSU5fQ0VMTF9TSVpFX0ZVTExTQ1JFRU4pLCAzMDApOyAvLyBJbmNyZWFzZWQgbWF4IGZyb20gMjAwcHggdG8gMzAwcHhcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBNYXRoLm1pbihNYXRoLm1heChtaW5DZWxsU2l6ZSwgTUlOX0NFTExfU0laRV9OT1JNQUwpLCAyNTApOyAvLyBJbmNyZWFzZWQgbWF4IGZyb20gMTYwcHggdG8gMjUwcHhcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBBcHBseSBkaWZmZXJlbnQgY29uc3RyYWludHMgYmFzZWQgb24gbW9kZSB3aXRoIGluY3JlYXNlZCBtYXhpbXVtc1xuICAgIGlmIChpc0xpa2VseUZ1bGxzY3JlZW4pIHtcbiAgICAgIC8vIEluIGZ1bGxzY3JlZW4sIGFsbG93IGxhcmdlciBjZWxsc1xuICAgICAgcmV0dXJuIE1hdGgubWluKE1hdGgubWF4KGNlbGxTaXplLCBNSU5fQ0VMTF9TSVpFX0ZVTExTQ1JFRU4pLCAzMDApOyAvLyBJbmNyZWFzZWQgbWF4IGZyb20gMjAwcHggdG8gMzAwcHhcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gSW4gbm9ybWFsIG1vZGUsIGFsbG93IGxhcmdlciBjZWxsc1xuICAgICAgcmV0dXJuIE1hdGgubWluKE1hdGgubWF4KGNlbGxTaXplLCBNSU5fQ0VMTF9TSVpFX05PUk1BTCksIDI1MCk7IC8vIEluY3JlYXNlZCBtYXggZnJvbSAxNjBweCB0byAyNTBweFxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgYmVhdCBzaXplIGJhc2VkIG9uIGN1cnJlbnQgY29udGFpbmVyIGRpbWVuc2lvbnNcbiAgICovXG4gIHByaXZhdGUgdXBkYXRlQmVhdFNpemVGcm9tQ29udGFpbmVyKGJlYXRDb3VudCA9IDApOiB2b2lkIHtcbiAgICBpZiAoXG4gICAgICB0aGlzLiNjb250YWluZXJEaW1lbnNpb25zLndpZHRoIDw9IDAgfHxcbiAgICAgIHRoaXMuI2NvbnRhaW5lckRpbWVuc2lvbnMuaGVpZ2h0IDw9IDBcbiAgICApIHtcbiAgICAgIHJldHVybjsgLy8gV2FpdCBmb3IgdmFsaWQgZGltZW5zaW9uc1xuICAgIH1cblxuICAgIGNvbnN0IFtyb3dzLCBjb2xzXSA9IHRoaXMuYXV0b0FkanVzdExheW91dChiZWF0Q291bnQpO1xuICAgIGNvbnN0IHRvdGFsQ29scyA9IGNvbHMgKyAodGhpcy4jY29uZmlnLmhhc1N0YXJ0VGlsZSA/IDEgOiAwKTtcblxuICAgIGNvbnN0IG5ld0NlbGxTaXplID0gdGhpcy5jYWxjdWxhdGVDZWxsU2l6ZShcbiAgICAgIGJlYXRDb3VudCxcbiAgICAgIHRoaXMuI2NvbnRhaW5lckRpbWVuc2lvbnMud2lkdGgsXG4gICAgICB0aGlzLiNjb250YWluZXJEaW1lbnNpb25zLmhlaWdodCxcbiAgICAgIHJvd3MsXG4gICAgICB0b3RhbENvbHMsXG4gICAgICB0aGlzLiNjb25maWcuZ2FwXG4gICAgKTtcblxuICAgIC8vIFVwZGF0ZSBjb25maWd1cmF0aW9uIHdpdGggbmV3IHNpemUgYW5kIGxheW91dFxuICAgIHRoaXMuI2NvbmZpZyA9IHtcbiAgICAgIC4uLnRoaXMuI2NvbmZpZyxcbiAgICAgIGJlYXRTaXplOiBuZXdDZWxsU2l6ZSxcbiAgICAgIGNvbHVtbnM6IGNvbHMsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgdG90YWxDb2x1bW5zKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuI2NvbmZpZy5jb2x1bW5zICsgKHRoaXMuI2NvbmZpZy5oYXNTdGFydFRpbGUgPyAxIDogMCk7XG4gIH1cblxuICBjYWxjdWxhdGVCZWF0UG9zaXRpb24oXG4gICAgaW5kZXg6IG51bWJlcixcbiAgICBiZWF0Q291bnQ/OiBudW1iZXJcbiAgKTogeyB4OiBudW1iZXI7IHk6IG51bWJlciB9IHtcbiAgICAvLyBVc2UgdGhlIG9wdGltYWwgbGF5b3V0IGZvciB0aGlzIGJlYXQgY291bnRcbiAgICBjb25zdCBbLCBjb2xzXSA9IHRoaXMuYXV0b0FkanVzdExheW91dChiZWF0Q291bnQgPz8gaW5kZXggKyAxKTtcbiAgICBjb25zdCBjb2x1bW5zRm9yQmVhdHMgPSBNYXRoLm1heCgxLCBjb2xzKTtcbiAgICBjb25zdCByb3cgPSBNYXRoLmZsb29yKGluZGV4IC8gY29sdW1uc0ZvckJlYXRzKTtcbiAgICBjb25zdCBjb2wgPSAoaW5kZXggJSBjb2x1bW5zRm9yQmVhdHMpICsgKHRoaXMuI2NvbmZpZy5oYXNTdGFydFRpbGUgPyAxIDogMCk7XG5cbiAgICBjb25zdCBzdGVwID0gdGhpcy4jY29uZmlnLmJlYXRTaXplICsgdGhpcy4jY29uZmlnLmdhcDtcbiAgICByZXR1cm4geyB4OiBjb2wgKiBzdGVwLCB5OiByb3cgKiBzdGVwIH07XG4gIH1cblxuICBjYWxjdWxhdGVTdGFydFBvc2l0aW9uKGJlYXRDb3VudDogbnVtYmVyKTogeyB4OiBudW1iZXI7IHk6IG51bWJlciB9IHtcbiAgICAvLyBXaGVuIHRoZXJlIGFyZSBubyBiZWF0cywgY2VudGVyIHRoZSBzdGFydCBwb3NpdGlvbiB3aXRoaW4gdGhlIGZyYW1lXG4gICAgaWYgKGJlYXRDb3VudCA8PSAwKSB7XG4gICAgICBjb25zdCBsYXlvdXRJbmZvID0gdGhpcy5jYWxjdWxhdGVMYXlvdXRJbmZvKGJlYXRDb3VudCk7XG4gICAgICBjb25zdCBmcmFtZVdpZHRoID0gbGF5b3V0SW5mby50b3RhbFdpZHRoO1xuICAgICAgY29uc3QgZnJhbWVIZWlnaHQgPSBsYXlvdXRJbmZvLnRvdGFsSGVpZ2h0O1xuICAgICAgY29uc3QgYmVhdFNpemUgPSB0aGlzLiNjb25maWcuYmVhdFNpemU7XG5cbiAgICAgIGNvbnN0IHggPSAoZnJhbWVXaWR0aCAtIGJlYXRTaXplKSAvIDI7XG4gICAgICBjb25zdCB5ID0gKGZyYW1lSGVpZ2h0IC0gYmVhdFNpemUpIC8gMjtcblxuICAgICAgcmV0dXJuIHsgeCwgeSB9O1xuICAgIH1cblxuICAgIC8vIEZvciBub24tZW1wdHkgc2VxdWVuY2VzLCBzdGFydCBwb3NpdGlvbiBpcyBhdCBncmlkIHBvc2l0aW9uICgwLDApXG4gICAgcmV0dXJuIHsgeDogMCwgeTogMCB9O1xuICB9XG5cbiAgY2FsY3VsYXRlRnJhbWVEaW1lbnNpb25zKGJlYXRDb3VudDogbnVtYmVyKToge1xuICAgIHdpZHRoOiBudW1iZXI7XG4gICAgaGVpZ2h0OiBudW1iZXI7XG4gIH0ge1xuICAgIGNvbnN0IHN0ZXAgPSB0aGlzLiNjb25maWcuYmVhdFNpemUgKyB0aGlzLiNjb25maWcuZ2FwO1xuXG4gICAgLy8gSWYgbm8gYmVhdHMsIHNpemUgdG8ganVzdCB0aGUgU3RhcnQgdGlsZSAoZGVza3RvcCBzaG93cyBTVEFSVCBvbmx5KVxuICAgIGlmIChiZWF0Q291bnQgPD0gMCkge1xuICAgICAgY29uc3Qgd2lkdGggPSB0aGlzLiNjb25maWcuaGFzU3RhcnRUaWxlID8gdGhpcy4jY29uZmlnLmJlYXRTaXplIDogMDtcbiAgICAgIGNvbnN0IGhlaWdodCA9IHRoaXMuI2NvbmZpZy5iZWF0U2l6ZTtcbiAgICAgIHJldHVybiB7IHdpZHRoLCBoZWlnaHQgfTtcbiAgICB9XG5cbiAgICBjb25zdCBbcm93cywgY29sc10gPSB0aGlzLmF1dG9BZGp1c3RMYXlvdXQoYmVhdENvdW50KTtcbiAgICBjb25zdCB0b3RhbENvbHMgPSBjb2xzICsgKHRoaXMuI2NvbmZpZy5oYXNTdGFydFRpbGUgPyAxIDogMCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgd2lkdGg6IHRvdGFsQ29scyAqIHN0ZXAgLSB0aGlzLiNjb25maWcuZ2FwLFxuICAgICAgaGVpZ2h0OiByb3dzICogc3RlcCAtIHRoaXMuI2NvbmZpZy5nYXAsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgY29tcHJlaGVuc2l2ZSBsYXlvdXQgaW5mb3JtYXRpb24gaW5jbHVkaW5nIG92ZXJmbG93IGRldGVjdGlvbiAoUFVSRSlcbiAgICovXG4gIGNhbGN1bGF0ZUxheW91dEluZm8oYmVhdENvdW50OiBudW1iZXIpOiBMYXlvdXRJbmZvIHtcbiAgICAvLyBHZXQgb3B0aW1hbCBsYXlvdXQgd2l0aG91dCBtdXRhdGluZyBzdGF0ZVxuICAgIGNvbnN0IFtyb3dzLCBjb2xzXSA9IHRoaXMuYXV0b0FkanVzdExheW91dChiZWF0Q291bnQpO1xuICAgIGNvbnN0IHRvdGFsQ29scyA9IGNvbHMgKyAodGhpcy4jY29uZmlnLmhhc1N0YXJ0VGlsZSA/IDEgOiAwKTtcblxuICAgIC8vIENhbGN1bGF0ZSBvcHRpbWFsIGNlbGwgc2l6ZSB3aXRob3V0IG11dGF0aW5nIHN0YXRlXG4gICAgY29uc3Qgb3B0aW1hbENlbGxTaXplID0gdGhpcy5jYWxjdWxhdGVPcHRpbWFsQ2VsbFNpemUoXG4gICAgICBiZWF0Q291bnQsXG4gICAgICByb3dzLFxuICAgICAgdG90YWxDb2xzXG4gICAgKTtcblxuICAgIGNvbnN0IHN0ZXAgPSBvcHRpbWFsQ2VsbFNpemUgKyB0aGlzLiNjb25maWcuZ2FwO1xuICAgIGNvbnN0IHRvdGFsV2lkdGggPSB0b3RhbENvbHMgKiBzdGVwIC0gdGhpcy4jY29uZmlnLmdhcDtcbiAgICBjb25zdCB0b3RhbEhlaWdodCA9IHJvd3MgKiBzdGVwIC0gdGhpcy4jY29uZmlnLmdhcDtcblxuICAgIC8vIENoZWNrIGlmIGNvbnRlbnQgd291bGQgb3ZlcmZsb3cgY29udGFpbmVyXG4gICAgY29uc3QgY29udGFpbmVyV2lkdGggPSB0aGlzLiNjb250YWluZXJEaW1lbnNpb25zLndpZHRoO1xuICAgIGNvbnN0IGNvbnRhaW5lckhlaWdodCA9IHRoaXMuI2NvbnRhaW5lckRpbWVuc2lvbnMuaGVpZ2h0O1xuXG4gICAgY29uc3Qgc2hvdWxkU2Nyb2xsID1cbiAgICAgIChjb250YWluZXJXaWR0aCA+IDAgJiYgdG90YWxXaWR0aCA+IGNvbnRhaW5lcldpZHRoKSB8fFxuICAgICAgKGNvbnRhaW5lckhlaWdodCA+IDAgJiYgdG90YWxIZWlnaHQgPiBjb250YWluZXJIZWlnaHQpIHx8XG4gICAgICBvcHRpbWFsQ2VsbFNpemUgPD1cbiAgICAgICAgKHRoaXMuI2NvbnRhaW5lckRpbWVuc2lvbnMuaXNGdWxsc2NyZWVuID8gMTQwIDogMTIwKSAqIDEuMTsgLy8gVXBkYXRlZCB0aHJlc2hvbGRzIHRvIG1hdGNoIG5ldyBtaW5pbXVtc1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJvd3MsXG4gICAgICBjb2x1bW5zOiBjb2xzLFxuICAgICAgY2VsbFNpemU6IG9wdGltYWxDZWxsU2l6ZSxcbiAgICAgIHRvdGFsV2lkdGgsXG4gICAgICB0b3RhbEhlaWdodCxcbiAgICAgIHNob3VsZFNjcm9sbCxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSBvcHRpbWFsIGNlbGwgc2l6ZSB3aXRob3V0IG11dGF0aW5nIHN0YXRlIChQVVJFKVxuICAgKi9cbiAgcHJpdmF0ZSBjYWxjdWxhdGVPcHRpbWFsQ2VsbFNpemUoXG4gICAgYmVhdENvdW50OiBudW1iZXIsXG4gICAgcm93czogbnVtYmVyLFxuICAgIHRvdGFsQ29sczogbnVtYmVyXG4gICk6IG51bWJlciB7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChcbiAgICAgICAgdGhpcy4jY29udGFpbmVyRGltZW5zaW9ucy53aWR0aCA8PSAwIHx8XG4gICAgICAgIHRoaXMuI2NvbnRhaW5lckRpbWVuc2lvbnMuaGVpZ2h0IDw9IDBcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gdGhpcy4jY29uZmlnLmJlYXRTaXplOyAvLyBSZXR1cm4gY3VycmVudCBzaXplIGlmIG5vIGNvbnRhaW5lciBkaW1lbnNpb25zXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuY2FsY3VsYXRlQ2VsbFNpemUoXG4gICAgICAgIGJlYXRDb3VudCxcbiAgICAgICAgdGhpcy4jY29udGFpbmVyRGltZW5zaW9ucy53aWR0aCxcbiAgICAgICAgdGhpcy4jY29udGFpbmVyRGltZW5zaW9ucy5oZWlnaHQsXG4gICAgICAgIHJvd3MsXG4gICAgICAgIHRvdGFsQ29scyxcbiAgICAgICAgdGhpcy4jY29uZmlnLmdhcFxuICAgICAgKTtcblxuICAgICAgLy8gRW5zdXJlIHJlc3VsdCBpcyBhIHZhbGlkIG51bWJlclxuICAgICAgcmV0dXJuIGlzTmFOKHJlc3VsdCkgfHwgcmVzdWx0IDw9IDAgPyB0aGlzLiNjb25maWcuYmVhdFNpemUgOiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIkVycm9yIGNhbGN1bGF0aW5nIG9wdGltYWwgY2VsbCBzaXplOlwiLCBlcnJvcik7XG4gICAgICByZXR1cm4gdGhpcy4jY29uZmlnLmJlYXRTaXplO1xuICAgIH1cbiAgfVxuXG4gIC8vIEJlYXQgaW50ZXJhY3Rpb24gaGVscGVyc1xuICBnZXRCZWF0QXRQb3NpdGlvbih4OiBudW1iZXIsIHk6IG51bWJlciwgYmVhdENvdW50OiBudW1iZXIpOiBudW1iZXIge1xuICAgIGNvbnN0IHN0ZXAgPSB0aGlzLiNjb25maWcuYmVhdFNpemUgKyB0aGlzLiNjb25maWcuZ2FwO1xuICAgIGNvbnN0IGNvbFJhdyA9IE1hdGguZmxvb3IoeCAvIHN0ZXApO1xuICAgIGNvbnN0IHJvdyA9IE1hdGguZmxvb3IoeSAvIHN0ZXApO1xuXG4gICAgLy8gSWdub3JlIGNsaWNrcyBvbiB0aGUgU3RhcnQgdGlsZSBjb2x1bW5cbiAgICBjb25zdCBzdGFydE9mZnNldCA9IHRoaXMuI2NvbmZpZy5oYXNTdGFydFRpbGUgPyAxIDogMDtcbiAgICBpZiAoY29sUmF3IDwgc3RhcnRPZmZzZXQpIHJldHVybiAtMTtcblxuICAgIGNvbnN0IGNvbCA9IGNvbFJhdyAtIHN0YXJ0T2Zmc2V0O1xuICAgIGNvbnN0IGluZGV4ID0gcm93ICogTWF0aC5tYXgoMSwgdGhpcy4jY29uZmlnLmNvbHVtbnMpICsgY29sO1xuICAgIHJldHVybiBpbmRleCA+PSAwICYmIGluZGV4IDwgYmVhdENvdW50ID8gaW5kZXggOiAtMTtcbiAgfVxuXG4gIGlzQmVhdFZpc2libGUoYmVhdDogQmVhdERhdGEpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIWJlYXQuaXNCbGFuayB8fCBiZWF0LnBpY3RvZ3JhcGhEYXRhICE9IG51bGw7XG4gIH1cblxuICBnZXRCZWF0RGlzcGxheVRleHQoYmVhdDogQmVhdERhdGEpOiBzdHJpbmcge1xuICAgIGlmIChiZWF0LmlzQmxhbmsgJiYgIWJlYXQucGljdG9ncmFwaERhdGEpIHtcbiAgICAgIC8vIGZhbGxiYWNrOiBzaG93IGJlYXQgbnVtYmVyIGlmIGF2YWlsYWJsZSBvbiBtZXRhZGF0YSBvciBkb21haW4gdHlwZVxuICAgICAgcmV0dXJuIChcbiAgICAgICAgYmVhdC5iZWF0TnVtYmVyID8/XG4gICAgICAgIChiZWF0Lm1ldGFkYXRhIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KT8uYmVhdE51bWJlciA/P1xuICAgICAgICBcIlwiXG4gICAgICApLnRvU3RyaW5nKCk7XG4gICAgfVxuICAgIGNvbnN0IG1ldGFkYXRhTGV0dGVyID0gKGJlYXQubWV0YWRhdGEgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pPy5sZXR0ZXI7XG4gICAgcmV0dXJuIChcbiAgICAgIGJlYXQucGljdG9ncmFwaERhdGE/LmxldHRlciA/P1xuICAgICAgKHR5cGVvZiBtZXRhZGF0YUxldHRlciA9PT0gXCJzdHJpbmdcIiA/IG1ldGFkYXRhTGV0dGVyIDogXCJcIikgPz9cbiAgICAgIFwiXCJcbiAgICApO1xuICB9XG59XG5cbi8vIFNpbmdsZXRvbiBpbnN0YW5jZVxuZXhwb3J0IGNvbnN0IGJlYXRGcmFtZVNlcnZpY2UgPSBuZXcgQmVhdEZyYW1lU2VydmljZSgpO1xuIl0sImZpbGUiOiJGOi9DT0RFL1RLQS93ZWIvc3JjL2xpYi9zZXJ2aWNlcy9CZWF0RnJhbWVTZXJ2aWNlLnN2ZWx0ZS50cyJ9