/* browse-state.svelte.ts generated by Svelte v5.38.1 */
import * as $ from "/node_modules/.vite/deps/svelte_internal_client.js?v=de368f3a";

import {
	NavigationMode,
	SortMethod as SortMethodEnum,
	createDefaultDisplayState,
	createDefaultLoadingState
} from "/src/lib/domain/browse/index.ts";

import { getBrowseStatePersistence } from "/src/lib/state/appState.svelte.ts";
import { getBrowseTabStateManager } from "/src/lib/state/browse-tab-state-manager.svelte.ts";

export function createBrowseState(
	browseService,
	thumbnailService,
	sequenceIndexService,
	favoritesService,
	navigationService,
	_filterPersistenceService,
	sectionService,
	deleteService
) {
	const stateManager = getBrowseTabStateManager();
	let allSequences = $.tag($.state($.proxy([])), 'allSequences');
	let filteredSequences = $.tag($.state($.proxy([])), 'filteredSequences');
	let displayedSequences = $.tag($.state($.proxy([])), 'displayedSequences');
	let selectedSequence = $.tag($.state(null), 'selectedSequence');
	let favorites = $.tag($.state($.proxy(/* @__PURE__ */ new Set())), 'favorites');
	let navigationSections = $.tag($.state($.proxy([])), 'navigationSections');
	let sequenceSections = $.tag($.state($.proxy([])), 'sequenceSections');

	let sectionConfiguration = $.tag(
		$.state($.proxy({
			groupBy: "letter",
			sortMethod: SortMethodEnum.ALPHABETICAL,
			showEmptySections: false,
			expandedSections: /* @__PURE__ */ new Set(["A", "B", "C"])
		})),
		'sectionConfiguration'
	);

	let deleteConfirmation = $.tag($.state(null), 'deleteConfirmation');
	let showDeleteDialog = $.tag($.state(false), 'showDeleteDialog');
	let currentFilter = $.tag($.state(null), 'currentFilter');
	let currentSort = $.tag($.state($.proxy(SortMethodEnum.ALPHABETICAL)), 'currentSort');
	let navigationMode = $.tag($.state($.proxy(NavigationMode.FILTER_SELECTION)), 'navigationMode');
	const loadingState = $.tag_proxy($.proxy(createDefaultLoadingState()), 'loadingState');
	let displayState = $.tag($.state($.proxy(createDefaultDisplayState())), 'displayState');
	let searchQuery = $.tag($.state(""), 'searchQuery');
	const isLoading = $.tag($.derived(() => loadingState.isLoading), 'isLoading');
	const hasSequences = $.tag($.derived(() => $.get(displayedSequences).length > 0), 'hasSequences');
	const hasError = $.tag($.derived(() => $.strict_equals(loadingState.error, null, false)), 'hasError');
	const sequenceCount = $.tag($.derived(() => $.get(displayedSequences).length), 'sequenceCount');

	const sortedSections = $.tag(
		$.derived(() => () => {
			if ($.strict_equals($.get(displayedSequences).length, 0)) return {};

			return groupSequencesBySection($.get(displayedSequences), $.get(currentSort));
		}),
		'sortedSections'
	);

	const favoritesCount = $.tag($.derived(() => $.get(favorites).size), 'favoritesCount');
	const hasNavigationSections = $.tag($.derived(() => $.get(navigationSections).length > 0), 'hasNavigationSections');
	const hasSequenceSections = $.tag($.derived(() => $.get(sequenceSections).length > 0), 'hasSequenceSections');

	const sectionStatistics = $.tag(
		$.derived(() => () => {
			if ($.strict_equals($.get(sequenceSections).length, 0)) return null;

			return {
				totalSections: $.get(sequenceSections).length,
				totalSequences: $.get(sequenceSections).reduce((sum, section) => sum + section.count, 0),
				expandedSections: $.get(sequenceSections).filter((section) => section.isExpanded).length
			};
		}),
		'sectionStatistics'
	);

	async function loadAllSequences() {
		try {
			loadingState.isLoading = true;
			loadingState.currentOperation = "Loading sequences...";
			loadingState.error = null;

			const sequences = (await $.track_reactivity_loss(browseService.loadSequenceMetadata()))();

			$.set(allSequences, sequences, true);
			$.set(filteredSequences, sequences, true);
			$.set(displayedSequences, sequences, true);
			(await $.track_reactivity_loss(loadFavorites()))();
			(await $.track_reactivity_loss(generateNavigationSections()))();
			(await $.track_reactivity_loss(generateSequenceSections()))();
			(await $.track_reactivity_loss(restoreFilterState()))();
			loadingState.isLoading = false;
			loadingState.loadedCount = sequences.length;
			loadingState.totalCount = sequences.length;
		} catch(error) {
			loadingState.isLoading = false;
			loadingState.error = error instanceof Error ? error.message : "Failed to load sequences";
		}
	}

	async function restoreFilterState() {
		try {
			const savedFilterState = (await $.track_reactivity_loss(getBrowseStatePersistence().loadFilterState()))();

			if (savedFilterState && savedFilterState.type && $.strict_equals(savedFilterState.value, null, false)) {
				console.log(...$.log_if_contains_state('log', "ðŸ“– Restoring filter state:", savedFilterState));

				const filterType = savedFilterState.type;
				const filterValue = savedFilterState.value;

				if (filterType.startsWith("navigation_")) {
					const sectionType = filterType.replace("navigation_", "");

					const matchingItem = {
						id: `${sectionType}_${filterValue}`,
						label: String(filterValue),
						value: filterValue,
						count: 0,

						// Will be updated when navigation sections are generated
						isActive: true,

						sequences: []

						// Will be populated by getSequencesForNavigationItem
					};

					const filtered = navigationService.getSequencesForNavigationItem(matchingItem, sectionType, $.get(allSequences));
					const sorted = (await $.track_reactivity_loss(browseService.sortSequences(filtered, $.get(currentSort))))();

					$.set(currentFilter, { type: filterType, value: filterValue }, true);
					$.set(filteredSequences, filtered, true);
					$.set(displayedSequences, sorted, true);
					$.set(navigationMode, NavigationMode.SEQUENCE_BROWSER, true);
					console.log("âœ… Navigation filter state restored successfully");
				} else {
					const filterTypeEnum = filterType;
					const filterValueEnum = filterValue;

					$.set(currentFilter, { type: filterTypeEnum, value: filterValueEnum }, true);

					const filtered = (await $.track_reactivity_loss(browseService.applyFilter($.get(allSequences), filterTypeEnum, filterValueEnum)))();
					const sorted = (await $.track_reactivity_loss(browseService.sortSequences(filtered, $.get(currentSort))))();

					$.set(filteredSequences, filtered, true);
					$.set(displayedSequences, sorted, true);
					$.set(navigationMode, NavigationMode.SEQUENCE_BROWSER, true);
					console.log("âœ… Regular filter state restored successfully");
				}
			} else {
				console.log("ðŸ“– No saved filter state to restore");
			}
		} catch(error) {
			console.warn(...$.log_if_contains_state('warn', "âš ï¸ Failed to restore filter state:", error));
		}
	}

	async function applyFilter(filterType, filterValue) {
		try {
			console.log(...$.log_if_contains_state('log', "ðŸŽ¯ browse-state.applyFilter() called with:", filterType, filterValue));
			loadingState.isLoading = true;
			loadingState.currentOperation = "Applying filter...";
			$.set(currentFilter, { type: filterType, value: filterValue }, true);
			console.log(...$.log_if_contains_state('log', "ðŸ“ Updated currentFilter:", $.get(currentFilter)));
			(await $.track_reactivity_loss(stateManager.saveFilterState(filterType, filterValue)))();
			console.log(...$.log_if_contains_state('log', "ðŸ’¾ Filter state saved:", { type: filterType, value: filterValue }));
			console.log(...$.log_if_contains_state('log', "ðŸ“Š allSequences available:", $.get(allSequences).length, "items"));

			const filtered = (await $.track_reactivity_loss(browseService.applyFilter($.get(allSequences), filterType, filterValue)))();

			console.log(...$.log_if_contains_state('log', "ðŸ” Filtered sequences received:", filtered.length, "items"));

			const sorted = (await $.track_reactivity_loss(browseService.sortSequences(filtered, $.get(currentSort))))();

			console.log(...$.log_if_contains_state('log', "ðŸ“ˆ Sorted sequences:", sorted.length, "items"));
			$.set(filteredSequences, filtered, true);
			$.set(displayedSequences, sorted, true);
			$.set(navigationMode, NavigationMode.SEQUENCE_BROWSER, true);
			loadingState.isLoading = false;
		} catch(error) {
			loadingState.isLoading = false;
			loadingState.error = error instanceof Error ? error.message : "Failed to apply filter";
		}
	}

	async function updateSort(sortMethod) {
		try {
			$.set(currentSort, sortMethod, true);

			const sorted = (await $.track_reactivity_loss(browseService.sortSequences($.get(filteredSequences), sortMethod)))();

			$.set(displayedSequences, sorted, true);
		} catch(error) {
			loadingState.error = error instanceof Error ? error.message : "Failed to sort sequences";
		}
	}

	async function searchSequences(query) {
		try {
			$.set(searchQuery, query, true);

			if (!query.trim()) {
				$.set(displayedSequences, $.get(filteredSequences), true);

				return;
			}

			loadingState.isLoading = true;
			loadingState.currentOperation = "Searching...";

			const searchResults = (await $.track_reactivity_loss(sequenceIndexService.searchSequences(query)))();
			let results = searchResults;

			if ($.get(currentFilter)) {
				results = (await $.track_reactivity_loss(browseService.applyFilter(searchResults, $.get(currentFilter).type, $.get(currentFilter).value)))();
			}

			const sorted = (await $.track_reactivity_loss(browseService.sortSequences(results, $.get(currentSort))))();

			$.set(displayedSequences, sorted, true);
			loadingState.isLoading = false;
		} catch(error) {
			loadingState.isLoading = false;
			loadingState.error = error instanceof Error ? error.message : "Search failed";
		}
	}

	async function selectSequence(sequence) {
		$.set(selectedSequence, sequence, true);
		(await $.track_reactivity_loss(stateManager.saveSelectionState(sequence.id, null)))();
		console.log(...$.log_if_contains_state('log', "ðŸ’¾ Selection state saved:", sequence.id));
	}

	async function clearSelection() {
		$.set(selectedSequence, null);
		(await $.track_reactivity_loss(stateManager.saveSelectionState(null, null)))();
		console.log("ðŸ—‘ï¸ Selection state cleared");
	}

	async function backToFilters() {
		$.set(navigationMode, NavigationMode.FILTER_SELECTION, true);
		$.set(currentFilter, null);
		$.set(searchQuery, "");
		$.set(displayedSequences, $.get(allSequences), true);
		(await $.track_reactivity_loss(stateManager.saveFilterState(null, null)))();
		console.log("ðŸ—‘ï¸ Filter state cleared");
	}

	async function preloadThumbnails(sequences) {
		try {
			const thumbnailsToPreload = sequences.slice(0, 20).flatMap((seq) => seq.thumbnails.map((thumb) => ({ sequenceId: seq.id, thumbnailPath: thumb })));

			for (const thumbnail of thumbnailsToPreload) {
				(await $.track_reactivity_loss(thumbnailService.preloadThumbnail(thumbnail.sequenceId, thumbnail.thumbnailPath)))();
			}
		} catch(error) {
			console.warn(...$.log_if_contains_state('warn', "Failed to preload thumbnails:", error));
		}
	}

	function getThumbnailUrl(sequenceId, thumbnailPath) {
		return thumbnailService.getThumbnailUrl(sequenceId, thumbnailPath);
	}

	function updateDisplaySettings(settings) {
		$.set(displayState, { ...$.get(displayState), ...settings }, true);
	}

	function clearError() {
		loadingState.error = null;
	}

	$.user_effect(() => {
		if ($.get(displayedSequences).length > 0) {
			preloadThumbnails($.get(displayedSequences));
		}
	});

	function groupSequencesBySection(sequences, sortMethod) {
		const sections = {};

		for (const sequence of sequences) {
			const sectionKey = getSectionKey(sequence, sortMethod);

			if (!sections[sectionKey]) {
				sections[sectionKey] = [];
			}

			sections[sectionKey].push(sequence);
		}

		return sections;
	}

	function getSectionKey(sequence, sortMethod) {
		switch (sortMethod) {
			case SortMethodEnum.ALPHABETICAL:
				return sequence.word[0]?.toUpperCase() || "#";

			case SortMethodEnum.DIFFICULTY_LEVEL:
				return sequence.difficultyLevel || "Unknown";

			case SortMethodEnum.AUTHOR:
				return sequence.author || "Unknown";

			case SortMethodEnum.SEQUENCE_LENGTH:
				{
					const length = sequence.sequenceLength || 0;

					if (length <= 4) return "3-4 beats";
					if (length <= 6) return "5-6 beats";
					if (length <= 8) return "7-8 beats";

					return "9+ beats";
				}

			default:
				return "All";
		}
	}

	async function loadFavorites() {
		try {
			const favoriteIds = (await $.track_reactivity_loss(favoritesService.getFavorites()))();

			$.set(favorites, new Set(favoriteIds), true);
		} catch(error) {
			console.warn(...$.log_if_contains_state('warn', "Failed to load favorites:", error));
		}
	}

	async function toggleFavorite(sequenceId) {
		try {
			(await $.track_reactivity_loss(favoritesService.toggleFavorite(sequenceId)))();

			if ($.get(favorites).has(sequenceId)) {
				$.get(favorites).delete(sequenceId);
			} else {
				$.get(favorites).add(sequenceId);
			}

			(await $.track_reactivity_loss(generateNavigationSections()))();
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "Failed to toggle favorite:", error));
		}
	}

	async function generateNavigationSections() {
		try {
			const sections = (await $.track_reactivity_loss(navigationService.generateNavigationSections($.get(allSequences), Array.from($.get(favorites)))))();

			$.set(navigationSections, sections, true);
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "Failed to generate navigation sections:", error));
		}
	}

	async function generateSequenceSections() {
		try {
			const sections = (await $.track_reactivity_loss(sectionService.organizeSections($.get(displayedSequences), $.get(sectionConfiguration))))();

			$.set(sequenceSections, sections, true);
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "Failed to generate sequence sections:", error));
		}
	}

	function toggleNavigationSection(sectionId) {
		$.set(navigationSections, navigationService.toggleSectionExpansion(sectionId, $.get(navigationSections)), true);
	}

	function setActiveNavigationItem(sectionId, itemId) {
		$.set(navigationSections, navigationService.setActiveItem(sectionId, itemId, $.get(navigationSections)), true);
	}

	async function filterSequencesByNavigation(sectionType, item) {
		try {
			const filtered = navigationService.getSequencesForNavigationItem(item, sectionType, $.get(allSequences));

			$.set(displayedSequences, filtered, true);
			$.set(filteredSequences, filtered, true);

			const filterType = `navigation_${sectionType}`;
			const filterValue = item.value;

			$.set(currentFilter, { type: filterType, value: filterValue }, true);
			(await $.track_reactivity_loss(stateManager.saveFilterState(filterType, filterValue)))();
			console.log(...$.log_if_contains_state('log', "ðŸ’¾ Navigation filter state saved:", { type: filterType, value: filterValue }));

			return filtered;
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "Failed to filter sequences by navigation:", error));

			return [];
		}
	}

	function toggleSequenceSection(sectionId) {
		$.set(sequenceSections, sectionService.toggleSectionExpansion(sectionId, $.get(sequenceSections)), true);
	}

	async function updateSectionConfiguration(updates) {
		$.set(sectionConfiguration, sectionService.updateSectionConfiguration($.get(sectionConfiguration), updates), true);
		(await $.track_reactivity_loss(generateSequenceSections()))();
	}

	async function prepareDeleteSequence(sequence) {
		try {
			const confirmationData = (await $.track_reactivity_loss(deleteService.prepareDeleteConfirmation(sequence, $.get(allSequences))))();

			$.set(deleteConfirmation, confirmationData, true);
			$.set(showDeleteDialog, true);
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "Failed to prepare delete confirmation:", error));
		}
	}

	async function confirmDeleteSequence() {
		if (!$.get(deleteConfirmation)) return;

		try {
			const result = (await $.track_reactivity_loss(deleteService.deleteSequence($.get(deleteConfirmation).sequence, $.get(allSequences))))();

			if (result.success && $.get(deleteConfirmation)) {
				const deletedSequenceId = $.get(deleteConfirmation).sequence.id;

				$.set(allSequences, $.get(allSequences).filter((seq) => $.strict_equals(seq.id, deletedSequenceId, false)), true);
				$.set(filteredSequences, $.get(filteredSequences).filter((seq) => $.strict_equals(seq.id, deletedSequenceId, false)), true);
				$.set(displayedSequences, $.get(displayedSequences).filter((seq) => $.strict_equals(seq.id, deletedSequenceId, false)), true);

				if ($.strict_equals($.get(selectedSequence)?.id, deletedSequenceId)) {
					$.set(selectedSequence, null);
				}

				(await $.track_reactivity_loss(generateNavigationSections()))();
				(await $.track_reactivity_loss(generateSequenceSections()))();
			}

			$.set(deleteConfirmation, null);
			$.set(showDeleteDialog, false);
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "Failed to delete sequence:", error));
		}
	}

	function cancelDeleteSequence() {
		$.set(deleteConfirmation, null);
		$.set(showDeleteDialog, false);
	}

	return {
		// âœ… REACTIVE STATE GETTERS
		get allSequences() {
			return $.get(allSequences);
		},

		get displayedSequences() {
			return $.get(displayedSequences);
		},

		get selectedSequence() {
			return $.get(selectedSequence);
		},

		get currentFilter() {
			return $.get(currentFilter);
		},

		get currentSort() {
			return $.get(currentSort);
		},

		get navigationMode() {
			return $.get(navigationMode);
		},

		get searchQuery() {
			return $.get(searchQuery);
		},

		// Advanced state getters
		get favorites() {
			return $.get(favorites);
		},

		get navigationSections() {
			return $.get(navigationSections);
		},

		get sequenceSections() {
			return $.get(sequenceSections);
		},

		get sectionConfiguration() {
			return $.get(sectionConfiguration);
		},

		get deleteConfirmation() {
			return $.get(deleteConfirmation);
		},

		get showDeleteDialog() {
			return $.get(showDeleteDialog);
		},

		// âœ… DERIVED STATE GETTERS
		get isLoading() {
			return $.get(isLoading);
		},

		get hasSequences() {
			return $.get(hasSequences);
		},

		get hasError() {
			return $.get(hasError);
		},

		get sequenceCount() {
			return $.get(sequenceCount);
		},

		get sortedSections() {
			return $.get(sortedSections);
		},

		get loadingState() {
			return loadingState;
		},

		get displayState() {
			return $.get(displayState);
		},

		// Advanced derived getters
		get favoritesCount() {
			return $.get(favoritesCount);
		},

		get hasNavigationSections() {
			return $.get(hasNavigationSections);
		},

		get hasSequenceSections() {
			return $.get(hasSequenceSections);
		},

		get sectionStatistics() {
			return $.get(sectionStatistics);
		},

		// âœ… ACTION METHODS
		loadAllSequences,

		applyFilter,
		updateSort,
		searchSequences,
		selectSequence,
		clearSelection,
		backToFilters,
		getThumbnailUrl,
		updateDisplaySettings,
		clearError,

		// Advanced action methods
		loadFavorites,

		toggleFavorite,
		generateNavigationSections,
		generateSequenceSections,
		toggleNavigationSection,
		setActiveNavigationItem,
		filterSequencesByNavigation,
		toggleSequenceSection,
		updateSectionConfiguration,
		prepareDeleteSequence,
		confirmDeleteSequence,
		cancelDeleteSequence
	};
}
//# sourceMappingURL=data:application/json;base64,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RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7OztFQUdBOztFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7O0FBRUoiLCJuYW1lcyI6W10sImlnbm9yZUxpc3QiOltdLCJzb3VyY2VzIjpbImJyb3dzZS1zdGF0ZS5zdmVsdGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBCcm93c2UgU3RhdGUgLSBSdW5lcyBJbXBsZW1lbnRhdGlvblxuICpcbiAqIFJlYWN0aXZlIHN0YXRlIG1hbmFnZW1lbnQgZm9yIGJyb3dzZSBmdW5jdGlvbmFsaXR5IHVzaW5nIFN2ZWx0ZSA1IHJ1bmVzLlxuICogV3JhcHMgYnJvd3NlIHNlcnZpY2VzIGZvciBVSSByZWFjdGl2aXR5IHdoaWxlIGtlZXBpbmcgYnVzaW5lc3MgbG9naWMgaW4gc2VydmljZXMuXG4gKi9cblxuaW1wb3J0IHtcbiAgTmF2aWdhdGlvbk1vZGUsXG4gIFNvcnRNZXRob2QgYXMgU29ydE1ldGhvZEVudW0sXG4gIGNyZWF0ZURlZmF1bHREaXNwbGF5U3RhdGUsXG4gIGNyZWF0ZURlZmF1bHRMb2FkaW5nU3RhdGUsXG59IGZyb20gXCIkbGliL2RvbWFpbi9icm93c2VcIjtcbmltcG9ydCB0eXBlIHtcbiAgQnJvd3NlRGlzcGxheVN0YXRlLFxuICBCcm93c2VMb2FkaW5nU3RhdGUsXG4gIEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEsXG4gIEZpbHRlclR5cGUsXG4gIEZpbHRlclZhbHVlLFxuICBTb3J0TWV0aG9kLFxufSBmcm9tIFwiJGxpYi9zZXJ2aWNlcy9pbnRlcmZhY2VzL2RvbWFpbi10eXBlc1wiO1xuaW1wb3J0IHR5cGUge1xuICBEZWxldGVDb25maXJtYXRpb25EYXRhLFxuICBOYXZpZ2F0aW9uSXRlbSxcbiAgTmF2aWdhdGlvblNlY3Rpb24sXG4gIFNlY3Rpb25Db25maWd1cmF0aW9uLFxuICBTZXF1ZW5jZVNlY3Rpb24sXG59IGZyb20gXCIkbGliL3NlcnZpY2VzL2ludGVyZmFjZXMvYnJvd3NlLWludGVyZmFjZXNcIjtcbmltcG9ydCB0eXBlIHtcbiAgSUJyb3dzZVNlcnZpY2UsXG4gIElEZWxldGVTZXJ2aWNlLFxuICBJRmF2b3JpdGVzU2VydmljZSxcbiAgSUZpbHRlclBlcnNpc3RlbmNlU2VydmljZSxcbiAgSU5hdmlnYXRpb25TZXJ2aWNlLFxuICBJU2VjdGlvblNlcnZpY2UsXG4gIElTZXF1ZW5jZUluZGV4U2VydmljZSxcbiAgSVRodW1ibmFpbFNlcnZpY2UsXG59IGZyb20gXCIkbGliL3NlcnZpY2VzL2ludGVyZmFjZXMvYnJvd3NlLWludGVyZmFjZXNcIjtcbmltcG9ydCB7IGdldEJyb3dzZVN0YXRlUGVyc2lzdGVuY2UgfSBmcm9tIFwiLi9hcHBTdGF0ZS5zdmVsdGVcIjtcbmltcG9ydCB7IGdldEJyb3dzZVRhYlN0YXRlTWFuYWdlciB9IGZyb20gXCIuL2Jyb3dzZS10YWItc3RhdGUtbWFuYWdlci5zdmVsdGVcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUJyb3dzZVN0YXRlKFxuICBicm93c2VTZXJ2aWNlOiBJQnJvd3NlU2VydmljZSxcbiAgdGh1bWJuYWlsU2VydmljZTogSVRodW1ibmFpbFNlcnZpY2UsXG4gIHNlcXVlbmNlSW5kZXhTZXJ2aWNlOiBJU2VxdWVuY2VJbmRleFNlcnZpY2UsXG4gIGZhdm9yaXRlc1NlcnZpY2U6IElGYXZvcml0ZXNTZXJ2aWNlLFxuICBuYXZpZ2F0aW9uU2VydmljZTogSU5hdmlnYXRpb25TZXJ2aWNlLFxuICBfZmlsdGVyUGVyc2lzdGVuY2VTZXJ2aWNlOiBJRmlsdGVyUGVyc2lzdGVuY2VTZXJ2aWNlLFxuICBzZWN0aW9uU2VydmljZTogSVNlY3Rpb25TZXJ2aWNlLFxuICBkZWxldGVTZXJ2aWNlOiBJRGVsZXRlU2VydmljZVxuKSB7XG4gIC8vIOKchSBTVEFURSBQRVJTSVNURU5DRTogSW5pdGlhbGl6ZSBzdGF0ZSBtYW5hZ2VyXG4gIGNvbnN0IHN0YXRlTWFuYWdlciA9IGdldEJyb3dzZVRhYlN0YXRlTWFuYWdlcigpO1xuXG4gIC8vIOKchSBQVVJFIFJVTkVTOiBSZWFjdGl2ZSBzdGF0ZSBmb3IgVUlcbiAgbGV0IGFsbFNlcXVlbmNlcyA9ICRzdGF0ZTxCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW10+KFtdKTtcbiAgbGV0IGZpbHRlcmVkU2VxdWVuY2VzID0gJHN0YXRlPEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXT4oW10pO1xuICBsZXQgZGlzcGxheWVkU2VxdWVuY2VzID0gJHN0YXRlPEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXT4oW10pO1xuICBsZXQgc2VsZWN0ZWRTZXF1ZW5jZSA9ICRzdGF0ZTxCcm93c2VTZXF1ZW5jZU1ldGFkYXRhIHwgbnVsbD4obnVsbCk7XG5cbiAgLy8gQWR2YW5jZWQgYnJvd3NlIHN0YXRlXG4gIGxldCBmYXZvcml0ZXMgPSAkc3RhdGU8U2V0PHN0cmluZz4+KG5ldyBTZXQoKSk7XG4gIGxldCBuYXZpZ2F0aW9uU2VjdGlvbnMgPSAkc3RhdGU8TmF2aWdhdGlvblNlY3Rpb25bXT4oW10pO1xuICBsZXQgc2VxdWVuY2VTZWN0aW9ucyA9ICRzdGF0ZTxTZXF1ZW5jZVNlY3Rpb25bXT4oW10pO1xuICBsZXQgc2VjdGlvbkNvbmZpZ3VyYXRpb24gPSAkc3RhdGU8U2VjdGlvbkNvbmZpZ3VyYXRpb24+KHtcbiAgICBncm91cEJ5OiBcImxldHRlclwiLFxuICAgIHNvcnRNZXRob2Q6IFNvcnRNZXRob2RFbnVtLkFMUEhBQkVUSUNBTCxcbiAgICBzaG93RW1wdHlTZWN0aW9uczogZmFsc2UsXG4gICAgZXhwYW5kZWRTZWN0aW9uczogbmV3IFNldChbXCJBXCIsIFwiQlwiLCBcIkNcIl0pLFxuICB9KTtcbiAgbGV0IGRlbGV0ZUNvbmZpcm1hdGlvbiA9ICRzdGF0ZTxEZWxldGVDb25maXJtYXRpb25EYXRhIHwgbnVsbD4obnVsbCk7XG4gIGxldCBzaG93RGVsZXRlRGlhbG9nID0gJHN0YXRlPGJvb2xlYW4+KGZhbHNlKTtcblxuICAvLyBOYXZpZ2F0aW9uIGFuZCBmaWx0ZXJpbmcgc3RhdGVcbiAgbGV0IGN1cnJlbnRGaWx0ZXIgPSAkc3RhdGU8eyB0eXBlOiBGaWx0ZXJUeXBlOyB2YWx1ZTogRmlsdGVyVmFsdWUgfSB8IG51bGw+KFxuICAgIG51bGxcbiAgKTtcbiAgbGV0IGN1cnJlbnRTb3J0ID0gJHN0YXRlPFNvcnRNZXRob2Q+KFNvcnRNZXRob2RFbnVtLkFMUEhBQkVUSUNBTCk7XG4gIGxldCBuYXZpZ2F0aW9uTW9kZSA9ICRzdGF0ZTxOYXZpZ2F0aW9uTW9kZT4oTmF2aWdhdGlvbk1vZGUuRklMVEVSX1NFTEVDVElPTik7XG5cbiAgLy8gVUkgc3RhdGVcbiAgY29uc3QgbG9hZGluZ1N0YXRlID0gJHN0YXRlPEJyb3dzZUxvYWRpbmdTdGF0ZT4oY3JlYXRlRGVmYXVsdExvYWRpbmdTdGF0ZSgpKTtcbiAgbGV0IGRpc3BsYXlTdGF0ZSA9ICRzdGF0ZTxCcm93c2VEaXNwbGF5U3RhdGU+KGNyZWF0ZURlZmF1bHREaXNwbGF5U3RhdGUoKSk7XG4gIGxldCBzZWFyY2hRdWVyeSA9ICRzdGF0ZTxzdHJpbmc+KFwiXCIpO1xuXG4gIC8vIOKchSBERVJJVkVEIFJVTkVTOiBDb21wdXRlZCB2YWx1ZXNcbiAgY29uc3QgaXNMb2FkaW5nID0gJGRlcml2ZWQobG9hZGluZ1N0YXRlLmlzTG9hZGluZyk7XG4gIGNvbnN0IGhhc1NlcXVlbmNlcyA9ICRkZXJpdmVkKGRpc3BsYXllZFNlcXVlbmNlcy5sZW5ndGggPiAwKTtcbiAgY29uc3QgaGFzRXJyb3IgPSAkZGVyaXZlZChsb2FkaW5nU3RhdGUuZXJyb3IgIT09IG51bGwpO1xuICBjb25zdCBzZXF1ZW5jZUNvdW50ID0gJGRlcml2ZWQoZGlzcGxheWVkU2VxdWVuY2VzLmxlbmd0aCk7XG4gIGNvbnN0IHNvcnRlZFNlY3Rpb25zID0gJGRlcml2ZWQoKCkgPT4ge1xuICAgIGlmIChkaXNwbGF5ZWRTZXF1ZW5jZXMubGVuZ3RoID09PSAwKSByZXR1cm4ge307XG4gICAgLy8gVGhpcyB3aWxsIGJlIGNvbXB1dGVkIGJ5IGdyb3VwaW5nIHNlcXVlbmNlc1xuICAgIHJldHVybiBncm91cFNlcXVlbmNlc0J5U2VjdGlvbihkaXNwbGF5ZWRTZXF1ZW5jZXMsIGN1cnJlbnRTb3J0KTtcbiAgfSk7XG5cbiAgLy8gQWR2YW5jZWQgZGVyaXZlZCB2YWx1ZXNcbiAgY29uc3QgZmF2b3JpdGVzQ291bnQgPSAkZGVyaXZlZChmYXZvcml0ZXMuc2l6ZSk7XG4gIGNvbnN0IGhhc05hdmlnYXRpb25TZWN0aW9ucyA9ICRkZXJpdmVkKG5hdmlnYXRpb25TZWN0aW9ucy5sZW5ndGggPiAwKTtcbiAgY29uc3QgaGFzU2VxdWVuY2VTZWN0aW9ucyA9ICRkZXJpdmVkKHNlcXVlbmNlU2VjdGlvbnMubGVuZ3RoID4gMCk7XG4gIGNvbnN0IHNlY3Rpb25TdGF0aXN0aWNzID0gJGRlcml2ZWQoKCkgPT4ge1xuICAgIGlmIChzZXF1ZW5jZVNlY3Rpb25zLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsU2VjdGlvbnM6IHNlcXVlbmNlU2VjdGlvbnMubGVuZ3RoLFxuICAgICAgdG90YWxTZXF1ZW5jZXM6IHNlcXVlbmNlU2VjdGlvbnMucmVkdWNlKFxuICAgICAgICAoc3VtLCBzZWN0aW9uKSA9PiBzdW0gKyBzZWN0aW9uLmNvdW50LFxuICAgICAgICAwXG4gICAgICApLFxuICAgICAgZXhwYW5kZWRTZWN0aW9uczogc2VxdWVuY2VTZWN0aW9ucy5maWx0ZXIoKHNlY3Rpb24pID0+IHNlY3Rpb24uaXNFeHBhbmRlZClcbiAgICAgICAgLmxlbmd0aCxcbiAgICB9O1xuICB9KTtcblxuICAvLyDinIUgUlVORVMgTUVUSE9EUzogVUkgc3RhdGUgbWFuYWdlbWVudCB0aGF0IGRlbGVnYXRlcyB0byBzZXJ2aWNlc1xuICBhc3luYyBmdW5jdGlvbiBsb2FkQWxsU2VxdWVuY2VzKCkge1xuICAgIHRyeSB7XG4gICAgICBsb2FkaW5nU3RhdGUuaXNMb2FkaW5nID0gdHJ1ZTtcbiAgICAgIGxvYWRpbmdTdGF0ZS5jdXJyZW50T3BlcmF0aW9uID0gXCJMb2FkaW5nIHNlcXVlbmNlcy4uLlwiO1xuICAgICAgbG9hZGluZ1N0YXRlLmVycm9yID0gbnVsbDtcblxuICAgICAgLy8gRGVsZWdhdGUgdG8gc2VydmljZSBmb3IgYnVzaW5lc3MgbG9naWNcbiAgICAgIGNvbnN0IHNlcXVlbmNlcyA9IGF3YWl0IGJyb3dzZVNlcnZpY2UubG9hZFNlcXVlbmNlTWV0YWRhdGEoKTtcblxuICAgICAgLy8gVXBkYXRlIHJlYWN0aXZlIHN0YXRlXG4gICAgICBhbGxTZXF1ZW5jZXMgPSBzZXF1ZW5jZXM7XG4gICAgICBmaWx0ZXJlZFNlcXVlbmNlcyA9IHNlcXVlbmNlcztcbiAgICAgIGRpc3BsYXllZFNlcXVlbmNlcyA9IHNlcXVlbmNlcztcblxuICAgICAgLy8gTG9hZCBmYXZvcml0ZXMgYW5kIGdlbmVyYXRlIG5hdmlnYXRpb24gc2VjdGlvbnNcbiAgICAgIGF3YWl0IGxvYWRGYXZvcml0ZXMoKTtcbiAgICAgIGF3YWl0IGdlbmVyYXRlTmF2aWdhdGlvblNlY3Rpb25zKCk7XG4gICAgICBhd2FpdCBnZW5lcmF0ZVNlcXVlbmNlU2VjdGlvbnMoKTtcblxuICAgICAgLy8g8J+TliBSRVNUT1JFIFNUQVRFOiBSZXN0b3JlIHNhdmVkIGZpbHRlciBzdGF0ZSBhZnRlciBsb2FkaW5nIHNlcXVlbmNlc1xuICAgICAgYXdhaXQgcmVzdG9yZUZpbHRlclN0YXRlKCk7XG5cbiAgICAgIGxvYWRpbmdTdGF0ZS5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICAgIGxvYWRpbmdTdGF0ZS5sb2FkZWRDb3VudCA9IHNlcXVlbmNlcy5sZW5ndGg7XG4gICAgICBsb2FkaW5nU3RhdGUudG90YWxDb3VudCA9IHNlcXVlbmNlcy5sZW5ndGg7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvYWRpbmdTdGF0ZS5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICAgIGxvYWRpbmdTdGF0ZS5lcnJvciA9XG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJGYWlsZWQgdG8gbG9hZCBzZXF1ZW5jZXNcIjtcbiAgICB9XG4gIH1cblxuICAvLyDwn5OWIFJFU1RPUkUgRklMVEVSIFNUQVRFOiBSZXN0b3JlIHNhdmVkIGZpbHRlciBzdGF0ZSB3aGVuIEJyb3dzZSB0YWIgbG9hZHNcbiAgYXN5bmMgZnVuY3Rpb24gcmVzdG9yZUZpbHRlclN0YXRlKCkge1xuICAgIHRyeSB7XG4gICAgICAvLyBUcnkgdG8gbG9hZCBpbmRpdmlkdWFsIGZpbHRlciBzdGF0ZSBmaXJzdFxuICAgICAgY29uc3Qgc2F2ZWRGaWx0ZXJTdGF0ZSA9XG4gICAgICAgIGF3YWl0IGdldEJyb3dzZVN0YXRlUGVyc2lzdGVuY2UoKS5sb2FkRmlsdGVyU3RhdGUoKTtcbiAgICAgIGlmIChcbiAgICAgICAgc2F2ZWRGaWx0ZXJTdGF0ZSAmJlxuICAgICAgICBzYXZlZEZpbHRlclN0YXRlLnR5cGUgJiZcbiAgICAgICAgc2F2ZWRGaWx0ZXJTdGF0ZS52YWx1ZSAhPT0gbnVsbFxuICAgICAgKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwi8J+TliBSZXN0b3JpbmcgZmlsdGVyIHN0YXRlOlwiLCBzYXZlZEZpbHRlclN0YXRlKTtcblxuICAgICAgICBjb25zdCBmaWx0ZXJUeXBlID0gc2F2ZWRGaWx0ZXJTdGF0ZS50eXBlIGFzIHN0cmluZztcbiAgICAgICAgY29uc3QgZmlsdGVyVmFsdWUgPSBzYXZlZEZpbHRlclN0YXRlLnZhbHVlO1xuXG4gICAgICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSBuYXZpZ2F0aW9uIGZpbHRlclxuICAgICAgICBpZiAoZmlsdGVyVHlwZS5zdGFydHNXaXRoKFwibmF2aWdhdGlvbl9cIikpIHtcbiAgICAgICAgICBjb25zdCBzZWN0aW9uVHlwZSA9IGZpbHRlclR5cGUucmVwbGFjZShcbiAgICAgICAgICAgIFwibmF2aWdhdGlvbl9cIixcbiAgICAgICAgICAgIFwiXCJcbiAgICAgICAgICApIGFzIE5hdmlnYXRpb25TZWN0aW9uW1widHlwZVwiXTtcblxuICAgICAgICAgIC8vIEZpbmQgdGhlIG5hdmlnYXRpb24gaXRlbSB0aGF0IG1hdGNoZXMgdGhlIHNhdmVkIGZpbHRlclxuICAgICAgICAgIGNvbnN0IG1hdGNoaW5nSXRlbTogTmF2aWdhdGlvbkl0ZW0gPSB7XG4gICAgICAgICAgICBpZDogYCR7c2VjdGlvblR5cGV9XyR7ZmlsdGVyVmFsdWV9YCxcbiAgICAgICAgICAgIGxhYmVsOiBTdHJpbmcoZmlsdGVyVmFsdWUpLFxuICAgICAgICAgICAgdmFsdWU6IGZpbHRlclZhbHVlIGFzIHN0cmluZyB8IG51bWJlcixcbiAgICAgICAgICAgIGNvdW50OiAwLCAvLyBXaWxsIGJlIHVwZGF0ZWQgd2hlbiBuYXZpZ2F0aW9uIHNlY3Rpb25zIGFyZSBnZW5lcmF0ZWRcbiAgICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgICAgICAgc2VxdWVuY2VzOiBbXSwgLy8gV2lsbCBiZSBwb3B1bGF0ZWQgYnkgZ2V0U2VxdWVuY2VzRm9yTmF2aWdhdGlvbkl0ZW1cbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgLy8gQXBwbHkgdGhlIG5hdmlnYXRpb24gZmlsdGVyXG4gICAgICAgICAgY29uc3QgZmlsdGVyZWQgPSBuYXZpZ2F0aW9uU2VydmljZS5nZXRTZXF1ZW5jZXNGb3JOYXZpZ2F0aW9uSXRlbShcbiAgICAgICAgICAgIG1hdGNoaW5nSXRlbSxcbiAgICAgICAgICAgIHNlY3Rpb25UeXBlLFxuICAgICAgICAgICAgYWxsU2VxdWVuY2VzXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIC8vIEFwcGx5IGN1cnJlbnQgc29ydFxuICAgICAgICAgIGNvbnN0IHNvcnRlZCA9IGF3YWl0IGJyb3dzZVNlcnZpY2Uuc29ydFNlcXVlbmNlcyhcbiAgICAgICAgICAgIGZpbHRlcmVkLFxuICAgICAgICAgICAgY3VycmVudFNvcnRcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgLy8gVXBkYXRlIHJlYWN0aXZlIHN0YXRlXG4gICAgICAgICAgY3VycmVudEZpbHRlciA9IHtcbiAgICAgICAgICAgIHR5cGU6IGZpbHRlclR5cGUgYXMgRmlsdGVyVHlwZSxcbiAgICAgICAgICAgIHZhbHVlOiBmaWx0ZXJWYWx1ZSBhcyBGaWx0ZXJWYWx1ZSxcbiAgICAgICAgICB9O1xuICAgICAgICAgIGZpbHRlcmVkU2VxdWVuY2VzID0gZmlsdGVyZWQ7XG4gICAgICAgICAgZGlzcGxheWVkU2VxdWVuY2VzID0gc29ydGVkO1xuICAgICAgICAgIG5hdmlnYXRpb25Nb2RlID0gTmF2aWdhdGlvbk1vZGUuU0VRVUVOQ0VfQlJPV1NFUjtcblxuICAgICAgICAgIGNvbnNvbGUubG9nKFwi4pyFIE5hdmlnYXRpb24gZmlsdGVyIHN0YXRlIHJlc3RvcmVkIHN1Y2Nlc3NmdWxseVwiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBIYW5kbGUgcmVndWxhciBmaWx0ZXJzXG4gICAgICAgICAgY29uc3QgZmlsdGVyVHlwZUVudW0gPSBmaWx0ZXJUeXBlIGFzIEZpbHRlclR5cGU7XG4gICAgICAgICAgY29uc3QgZmlsdGVyVmFsdWVFbnVtID0gZmlsdGVyVmFsdWUgYXMgRmlsdGVyVmFsdWU7XG5cbiAgICAgICAgICAvLyBBcHBseSB0aGUgc2F2ZWQgZmlsdGVyXG4gICAgICAgICAgY3VycmVudEZpbHRlciA9IHtcbiAgICAgICAgICAgIHR5cGU6IGZpbHRlclR5cGVFbnVtLFxuICAgICAgICAgICAgdmFsdWU6IGZpbHRlclZhbHVlRW51bSxcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgLy8gQXBwbHkgdGhlIGZpbHRlciB0byBzZXF1ZW5jZXNcbiAgICAgICAgICBjb25zdCBmaWx0ZXJlZCA9IGF3YWl0IGJyb3dzZVNlcnZpY2UuYXBwbHlGaWx0ZXIoXG4gICAgICAgICAgICBhbGxTZXF1ZW5jZXMsXG4gICAgICAgICAgICBmaWx0ZXJUeXBlRW51bSxcbiAgICAgICAgICAgIGZpbHRlclZhbHVlRW51bVxuICAgICAgICAgICk7XG5cbiAgICAgICAgICAvLyBBcHBseSBjdXJyZW50IHNvcnRcbiAgICAgICAgICBjb25zdCBzb3J0ZWQgPSBhd2FpdCBicm93c2VTZXJ2aWNlLnNvcnRTZXF1ZW5jZXMoXG4gICAgICAgICAgICBmaWx0ZXJlZCxcbiAgICAgICAgICAgIGN1cnJlbnRTb3J0XG4gICAgICAgICAgKTtcblxuICAgICAgICAgIC8vIFVwZGF0ZSByZWFjdGl2ZSBzdGF0ZVxuICAgICAgICAgIGZpbHRlcmVkU2VxdWVuY2VzID0gZmlsdGVyZWQ7XG4gICAgICAgICAgZGlzcGxheWVkU2VxdWVuY2VzID0gc29ydGVkO1xuICAgICAgICAgIG5hdmlnYXRpb25Nb2RlID0gTmF2aWdhdGlvbk1vZGUuU0VRVUVOQ0VfQlJPV1NFUjtcblxuICAgICAgICAgIGNvbnNvbGUubG9nKFwi4pyFIFJlZ3VsYXIgZmlsdGVyIHN0YXRlIHJlc3RvcmVkIHN1Y2Nlc3NmdWxseVwiKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2coXCLwn5OWIE5vIHNhdmVkIGZpbHRlciBzdGF0ZSB0byByZXN0b3JlXCIpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCLimqDvuI8gRmFpbGVkIHRvIHJlc3RvcmUgZmlsdGVyIHN0YXRlOlwiLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZnVuY3Rpb24gYXBwbHlGaWx0ZXIoZmlsdGVyVHlwZTogRmlsdGVyVHlwZSwgZmlsdGVyVmFsdWU6IEZpbHRlclZhbHVlKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBcIvCfjq8gYnJvd3NlLXN0YXRlLmFwcGx5RmlsdGVyKCkgY2FsbGVkIHdpdGg6XCIsXG4gICAgICAgIGZpbHRlclR5cGUsXG4gICAgICAgIGZpbHRlclZhbHVlXG4gICAgICApO1xuICAgICAgbG9hZGluZ1N0YXRlLmlzTG9hZGluZyA9IHRydWU7XG4gICAgICBsb2FkaW5nU3RhdGUuY3VycmVudE9wZXJhdGlvbiA9IFwiQXBwbHlpbmcgZmlsdGVyLi4uXCI7XG5cbiAgICAgIC8vIFVwZGF0ZSBjdXJyZW50IGZpbHRlciBzdGF0ZVxuICAgICAgY3VycmVudEZpbHRlciA9IHsgdHlwZTogZmlsdGVyVHlwZSwgdmFsdWU6IGZpbHRlclZhbHVlIH07XG4gICAgICBjb25zb2xlLmxvZyhcIvCfk50gVXBkYXRlZCBjdXJyZW50RmlsdGVyOlwiLCBjdXJyZW50RmlsdGVyKTtcblxuICAgICAgLy8g8J+SviBTQVZFIEZJTFRFUiBTVEFURTogUGVyc2lzdCBmaWx0ZXIgc3RhdGUgZm9yIGNyb3NzLXNlc3Npb24gbWVtb3J5XG4gICAgICBhd2FpdCBzdGF0ZU1hbmFnZXIuc2F2ZUZpbHRlclN0YXRlKGZpbHRlclR5cGUsIGZpbHRlclZhbHVlKTtcbiAgICAgIGNvbnNvbGUubG9nKFwi8J+SviBGaWx0ZXIgc3RhdGUgc2F2ZWQ6XCIsIHtcbiAgICAgICAgdHlwZTogZmlsdGVyVHlwZSxcbiAgICAgICAgdmFsdWU6IGZpbHRlclZhbHVlLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnNvbGUubG9nKFwi8J+TiiBhbGxTZXF1ZW5jZXMgYXZhaWxhYmxlOlwiLCBhbGxTZXF1ZW5jZXMubGVuZ3RoLCBcIml0ZW1zXCIpO1xuXG4gICAgICAvLyBEZWxlZ2F0ZSBmaWx0ZXJpbmcgdG8gc2VydmljZVxuICAgICAgY29uc3QgZmlsdGVyZWQgPSBhd2FpdCBicm93c2VTZXJ2aWNlLmFwcGx5RmlsdGVyKFxuICAgICAgICBhbGxTZXF1ZW5jZXMsXG4gICAgICAgIGZpbHRlclR5cGUsXG4gICAgICAgIGZpbHRlclZhbHVlXG4gICAgICApO1xuICAgICAgY29uc29sZS5sb2coXCLwn5SNIEZpbHRlcmVkIHNlcXVlbmNlcyByZWNlaXZlZDpcIiwgZmlsdGVyZWQubGVuZ3RoLCBcIml0ZW1zXCIpO1xuXG4gICAgICAvLyBBcHBseSBjdXJyZW50IHNvcnRcbiAgICAgIGNvbnN0IHNvcnRlZCA9IGF3YWl0IGJyb3dzZVNlcnZpY2Uuc29ydFNlcXVlbmNlcyhmaWx0ZXJlZCwgY3VycmVudFNvcnQpO1xuICAgICAgY29uc29sZS5sb2coXCLwn5OIIFNvcnRlZCBzZXF1ZW5jZXM6XCIsIHNvcnRlZC5sZW5ndGgsIFwiaXRlbXNcIik7XG5cbiAgICAgIC8vIFVwZGF0ZSByZWFjdGl2ZSBzdGF0ZVxuICAgICAgZmlsdGVyZWRTZXF1ZW5jZXMgPSBmaWx0ZXJlZDtcbiAgICAgIGRpc3BsYXllZFNlcXVlbmNlcyA9IHNvcnRlZDtcbiAgICAgIG5hdmlnYXRpb25Nb2RlID0gTmF2aWdhdGlvbk1vZGUuU0VRVUVOQ0VfQlJPV1NFUjtcblxuICAgICAgbG9hZGluZ1N0YXRlLmlzTG9hZGluZyA9IGZhbHNlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsb2FkaW5nU3RhdGUuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICBsb2FkaW5nU3RhdGUuZXJyb3IgPVxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFwiRmFpbGVkIHRvIGFwcGx5IGZpbHRlclwiO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVNvcnQoc29ydE1ldGhvZDogU29ydE1ldGhvZCkge1xuICAgIHRyeSB7XG4gICAgICBjdXJyZW50U29ydCA9IHNvcnRNZXRob2Q7XG5cbiAgICAgIC8vIERlbGVnYXRlIHNvcnRpbmcgdG8gc2VydmljZVxuICAgICAgY29uc3Qgc29ydGVkID0gYXdhaXQgYnJvd3NlU2VydmljZS5zb3J0U2VxdWVuY2VzKFxuICAgICAgICBmaWx0ZXJlZFNlcXVlbmNlcyxcbiAgICAgICAgc29ydE1ldGhvZFxuICAgICAgKTtcblxuICAgICAgLy8gVXBkYXRlIHJlYWN0aXZlIHN0YXRlXG4gICAgICBkaXNwbGF5ZWRTZXF1ZW5jZXMgPSBzb3J0ZWQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxvYWRpbmdTdGF0ZS5lcnJvciA9XG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJGYWlsZWQgdG8gc29ydCBzZXF1ZW5jZXNcIjtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBzZWFyY2hTZXF1ZW5jZXMocXVlcnk6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICBzZWFyY2hRdWVyeSA9IHF1ZXJ5O1xuXG4gICAgICBpZiAoIXF1ZXJ5LnRyaW0oKSkge1xuICAgICAgICAvLyBSZXNldCB0byBmaWx0ZXJlZCBzZXF1ZW5jZXMgaWYgbm8gc2VhcmNoIHF1ZXJ5XG4gICAgICAgIGRpc3BsYXllZFNlcXVlbmNlcyA9IGZpbHRlcmVkU2VxdWVuY2VzO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGxvYWRpbmdTdGF0ZS5pc0xvYWRpbmcgPSB0cnVlO1xuICAgICAgbG9hZGluZ1N0YXRlLmN1cnJlbnRPcGVyYXRpb24gPSBcIlNlYXJjaGluZy4uLlwiO1xuXG4gICAgICAvLyBEZWxlZ2F0ZSBzZWFyY2ggdG8gc2VydmljZVxuICAgICAgY29uc3Qgc2VhcmNoUmVzdWx0cyA9IGF3YWl0IHNlcXVlbmNlSW5kZXhTZXJ2aWNlLnNlYXJjaFNlcXVlbmNlcyhxdWVyeSk7XG5cbiAgICAgIC8vIEZpbHRlciBzZWFyY2ggcmVzdWx0cyBieSBjdXJyZW50IGZpbHRlciBpZiBvbmUgaXMgYXBwbGllZFxuICAgICAgbGV0IHJlc3VsdHMgPSBzZWFyY2hSZXN1bHRzO1xuICAgICAgaWYgKGN1cnJlbnRGaWx0ZXIpIHtcbiAgICAgICAgcmVzdWx0cyA9IGF3YWl0IGJyb3dzZVNlcnZpY2UuYXBwbHlGaWx0ZXIoXG4gICAgICAgICAgc2VhcmNoUmVzdWx0cyxcbiAgICAgICAgICBjdXJyZW50RmlsdGVyLnR5cGUsXG4gICAgICAgICAgY3VycmVudEZpbHRlci52YWx1ZVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBBcHBseSBjdXJyZW50IHNvcnRcbiAgICAgIGNvbnN0IHNvcnRlZCA9IGF3YWl0IGJyb3dzZVNlcnZpY2Uuc29ydFNlcXVlbmNlcyhyZXN1bHRzLCBjdXJyZW50U29ydCk7XG5cbiAgICAgIGRpc3BsYXllZFNlcXVlbmNlcyA9IHNvcnRlZDtcbiAgICAgIGxvYWRpbmdTdGF0ZS5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9hZGluZ1N0YXRlLmlzTG9hZGluZyA9IGZhbHNlO1xuICAgICAgbG9hZGluZ1N0YXRlLmVycm9yID1cbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBcIlNlYXJjaCBmYWlsZWRcIjtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBzZWxlY3RTZXF1ZW5jZShzZXF1ZW5jZTogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YSkge1xuICAgIHNlbGVjdGVkU2VxdWVuY2UgPSBzZXF1ZW5jZTtcblxuICAgIC8vIPCfkr4gU0FWRSBTRUxFQ1RJT04gU1RBVEU6IFBlcnNpc3Qgc2VsZWN0ZWQgc2VxdWVuY2UgZm9yIGNyb3NzLXNlc3Npb24gbWVtb3J5XG4gICAgYXdhaXQgc3RhdGVNYW5hZ2VyLnNhdmVTZWxlY3Rpb25TdGF0ZShzZXF1ZW5jZS5pZCwgbnVsbCk7XG4gICAgY29uc29sZS5sb2coXCLwn5K+IFNlbGVjdGlvbiBzdGF0ZSBzYXZlZDpcIiwgc2VxdWVuY2UuaWQpO1xuICB9XG5cbiAgYXN5bmMgZnVuY3Rpb24gY2xlYXJTZWxlY3Rpb24oKSB7XG4gICAgc2VsZWN0ZWRTZXF1ZW5jZSA9IG51bGw7XG5cbiAgICAvLyDwn5K+IENMRUFSIFNFTEVDVElPTiBTVEFURTogUmVtb3ZlIHNhdmVkIHNlbGVjdGlvbiBzdGF0ZVxuICAgIGF3YWl0IHN0YXRlTWFuYWdlci5zYXZlU2VsZWN0aW9uU3RhdGUobnVsbCwgbnVsbCk7XG4gICAgY29uc29sZS5sb2coXCLwn5eR77iPIFNlbGVjdGlvbiBzdGF0ZSBjbGVhcmVkXCIpO1xuICB9XG5cbiAgYXN5bmMgZnVuY3Rpb24gYmFja1RvRmlsdGVycygpIHtcbiAgICBuYXZpZ2F0aW9uTW9kZSA9IE5hdmlnYXRpb25Nb2RlLkZJTFRFUl9TRUxFQ1RJT047XG4gICAgY3VycmVudEZpbHRlciA9IG51bGw7XG4gICAgc2VhcmNoUXVlcnkgPSBcIlwiO1xuICAgIGRpc3BsYXllZFNlcXVlbmNlcyA9IGFsbFNlcXVlbmNlcztcblxuICAgIC8vIPCfkr4gQ0xFQVIgRklMVEVSIFNUQVRFOiBSZW1vdmUgc2F2ZWQgZmlsdGVyIHN0YXRlIHdoZW4gZ29pbmcgYmFjayB0byBmaWx0ZXJzXG4gICAgYXdhaXQgc3RhdGVNYW5hZ2VyLnNhdmVGaWx0ZXJTdGF0ZShudWxsLCBudWxsKTtcbiAgICBjb25zb2xlLmxvZyhcIvCfl5HvuI8gRmlsdGVyIHN0YXRlIGNsZWFyZWRcIik7XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBwcmVsb2FkVGh1bWJuYWlscyhzZXF1ZW5jZXM6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB0aHVtYm5haWxzVG9QcmVsb2FkID0gc2VxdWVuY2VzXG4gICAgICAgIC5zbGljZSgwLCAyMCkgLy8gUHJlbG9hZCBmaXJzdCAyMCB0aHVtYm5haWxzXG4gICAgICAgIC5mbGF0TWFwKChzZXEpID0+XG4gICAgICAgICAgc2VxLnRodW1ibmFpbHMubWFwKCh0aHVtYikgPT4gKHtcbiAgICAgICAgICAgIHNlcXVlbmNlSWQ6IHNlcS5pZCxcbiAgICAgICAgICAgIHRodW1ibmFpbFBhdGg6IHRodW1iLFxuICAgICAgICAgIH0pKVxuICAgICAgICApO1xuXG4gICAgICAvLyBQcmVsb2FkIHRodW1ibmFpbHMgaW5kaXZpZHVhbGx5XG4gICAgICBmb3IgKGNvbnN0IHRodW1ibmFpbCBvZiB0aHVtYm5haWxzVG9QcmVsb2FkKSB7XG4gICAgICAgIGF3YWl0IHRodW1ibmFpbFNlcnZpY2UucHJlbG9hZFRodW1ibmFpbChcbiAgICAgICAgICB0aHVtYm5haWwuc2VxdWVuY2VJZCxcbiAgICAgICAgICB0aHVtYm5haWwudGh1bWJuYWlsUGF0aFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJGYWlsZWQgdG8gcHJlbG9hZCB0aHVtYm5haWxzOlwiLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gZ2V0VGh1bWJuYWlsVXJsKHNlcXVlbmNlSWQ6IHN0cmluZywgdGh1bWJuYWlsUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGh1bWJuYWlsU2VydmljZS5nZXRUaHVtYm5haWxVcmwoc2VxdWVuY2VJZCwgdGh1bWJuYWlsUGF0aCk7XG4gIH1cblxuICBmdW5jdGlvbiB1cGRhdGVEaXNwbGF5U2V0dGluZ3Moc2V0dGluZ3M6IFBhcnRpYWw8QnJvd3NlRGlzcGxheVN0YXRlPikge1xuICAgIGRpc3BsYXlTdGF0ZSA9IHsgLi4uZGlzcGxheVN0YXRlLCAuLi5zZXR0aW5ncyB9O1xuICB9XG5cbiAgZnVuY3Rpb24gY2xlYXJFcnJvcigpIHtcbiAgICBsb2FkaW5nU3RhdGUuZXJyb3IgPSBudWxsO1xuICB9XG5cbiAgLy8g4pyFIFJVTkVTIEVGRkVDVDogQXV0by1wcmVsb2FkIHRodW1ibmFpbHMgd2hlbiBzZXF1ZW5jZXMgY2hhbmdlXG4gICRlZmZlY3QoKCkgPT4ge1xuICAgIGlmIChkaXNwbGF5ZWRTZXF1ZW5jZXMubGVuZ3RoID4gMCkge1xuICAgICAgcHJlbG9hZFRodW1ibmFpbHMoZGlzcGxheWVkU2VxdWVuY2VzKTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIEhlbHBlciBmdW5jdGlvbiBmb3IgZGVyaXZlZCBzZWN0aW9uc1xuICBmdW5jdGlvbiBncm91cFNlcXVlbmNlc0J5U2VjdGlvbihcbiAgICBzZXF1ZW5jZXM6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXSxcbiAgICBzb3J0TWV0aG9kOiBTb3J0TWV0aG9kXG4gICk6IFJlY29yZDxzdHJpbmcsIEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXT4ge1xuICAgIGNvbnN0IHNlY3Rpb25zOiBSZWNvcmQ8c3RyaW5nLCBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW10+ID0ge307XG5cbiAgICBmb3IgKGNvbnN0IHNlcXVlbmNlIG9mIHNlcXVlbmNlcykge1xuICAgICAgY29uc3Qgc2VjdGlvbktleSA9IGdldFNlY3Rpb25LZXkoc2VxdWVuY2UsIHNvcnRNZXRob2QpO1xuICAgICAgaWYgKCFzZWN0aW9uc1tzZWN0aW9uS2V5XSkge1xuICAgICAgICBzZWN0aW9uc1tzZWN0aW9uS2V5XSA9IFtdO1xuICAgICAgfVxuICAgICAgc2VjdGlvbnNbc2VjdGlvbktleV0ucHVzaChzZXF1ZW5jZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNlY3Rpb25zO1xuICB9XG5cbiAgZnVuY3Rpb24gZ2V0U2VjdGlvbktleShcbiAgICBzZXF1ZW5jZTogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YSxcbiAgICBzb3J0TWV0aG9kOiBTb3J0TWV0aG9kXG4gICk6IHN0cmluZyB7XG4gICAgc3dpdGNoIChzb3J0TWV0aG9kKSB7XG4gICAgICBjYXNlIFNvcnRNZXRob2RFbnVtLkFMUEhBQkVUSUNBTDpcbiAgICAgICAgcmV0dXJuIHNlcXVlbmNlLndvcmRbMF0/LnRvVXBwZXJDYXNlKCkgfHwgXCIjXCI7XG4gICAgICBjYXNlIFNvcnRNZXRob2RFbnVtLkRJRkZJQ1VMVFlfTEVWRUw6XG4gICAgICAgIHJldHVybiBzZXF1ZW5jZS5kaWZmaWN1bHR5TGV2ZWwgfHwgXCJVbmtub3duXCI7XG4gICAgICBjYXNlIFNvcnRNZXRob2RFbnVtLkFVVEhPUjpcbiAgICAgICAgcmV0dXJuIHNlcXVlbmNlLmF1dGhvciB8fCBcIlVua25vd25cIjtcbiAgICAgIGNhc2UgU29ydE1ldGhvZEVudW0uU0VRVUVOQ0VfTEVOR1RIOiB7XG4gICAgICAgIGNvbnN0IGxlbmd0aCA9IHNlcXVlbmNlLnNlcXVlbmNlTGVuZ3RoIHx8IDA7XG4gICAgICAgIGlmIChsZW5ndGggPD0gNCkgcmV0dXJuIFwiMy00IGJlYXRzXCI7XG4gICAgICAgIGlmIChsZW5ndGggPD0gNikgcmV0dXJuIFwiNS02IGJlYXRzXCI7XG4gICAgICAgIGlmIChsZW5ndGggPD0gOCkgcmV0dXJuIFwiNy04IGJlYXRzXCI7XG4gICAgICAgIHJldHVybiBcIjkrIGJlYXRzXCI7XG4gICAgICB9XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gXCJBbGxcIjtcbiAgICB9XG4gIH1cblxuICAvLyBBZHZhbmNlZCBicm93c2UgbWV0aG9kc1xuICBhc3luYyBmdW5jdGlvbiBsb2FkRmF2b3JpdGVzKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmYXZvcml0ZUlkcyA9IGF3YWl0IGZhdm9yaXRlc1NlcnZpY2UuZ2V0RmF2b3JpdGVzKCk7XG4gICAgICBmYXZvcml0ZXMgPSBuZXcgU2V0KGZhdm9yaXRlSWRzKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKFwiRmFpbGVkIHRvIGxvYWQgZmF2b3JpdGVzOlwiLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZnVuY3Rpb24gdG9nZ2xlRmF2b3JpdGUoc2VxdWVuY2VJZDogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZhdm9yaXRlc1NlcnZpY2UudG9nZ2xlRmF2b3JpdGUoc2VxdWVuY2VJZCk7XG4gICAgICBpZiAoZmF2b3JpdGVzLmhhcyhzZXF1ZW5jZUlkKSkge1xuICAgICAgICBmYXZvcml0ZXMuZGVsZXRlKHNlcXVlbmNlSWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmF2b3JpdGVzLmFkZChzZXF1ZW5jZUlkKTtcbiAgICAgIH1cbiAgICAgIC8vIFVwZGF0ZSBuYXZpZ2F0aW9uIHNlY3Rpb25zXG4gICAgICBhd2FpdCBnZW5lcmF0ZU5hdmlnYXRpb25TZWN0aW9ucygpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIHRvZ2dsZSBmYXZvcml0ZTpcIiwgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlTmF2aWdhdGlvblNlY3Rpb25zKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZWN0aW9ucyA9IGF3YWl0IG5hdmlnYXRpb25TZXJ2aWNlLmdlbmVyYXRlTmF2aWdhdGlvblNlY3Rpb25zKFxuICAgICAgICBhbGxTZXF1ZW5jZXMsXG4gICAgICAgIEFycmF5LmZyb20oZmF2b3JpdGVzKVxuICAgICAgKTtcbiAgICAgIG5hdmlnYXRpb25TZWN0aW9ucyA9IHNlY3Rpb25zO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIGdlbmVyYXRlIG5hdmlnYXRpb24gc2VjdGlvbnM6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBnZW5lcmF0ZVNlcXVlbmNlU2VjdGlvbnMoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNlY3Rpb25zID0gYXdhaXQgc2VjdGlvblNlcnZpY2Uub3JnYW5pemVTZWN0aW9ucyhcbiAgICAgICAgZGlzcGxheWVkU2VxdWVuY2VzLFxuICAgICAgICBzZWN0aW9uQ29uZmlndXJhdGlvblxuICAgICAgKTtcbiAgICAgIHNlcXVlbmNlU2VjdGlvbnMgPSBzZWN0aW9ucztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBnZW5lcmF0ZSBzZXF1ZW5jZSBzZWN0aW9uczpcIiwgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIHRvZ2dsZU5hdmlnYXRpb25TZWN0aW9uKHNlY3Rpb25JZDogc3RyaW5nKSB7XG4gICAgbmF2aWdhdGlvblNlY3Rpb25zID0gbmF2aWdhdGlvblNlcnZpY2UudG9nZ2xlU2VjdGlvbkV4cGFuc2lvbihcbiAgICAgIHNlY3Rpb25JZCxcbiAgICAgIG5hdmlnYXRpb25TZWN0aW9uc1xuICAgICk7XG4gIH1cblxuICBmdW5jdGlvbiBzZXRBY3RpdmVOYXZpZ2F0aW9uSXRlbShzZWN0aW9uSWQ6IHN0cmluZywgaXRlbUlkOiBzdHJpbmcpIHtcbiAgICBuYXZpZ2F0aW9uU2VjdGlvbnMgPSBuYXZpZ2F0aW9uU2VydmljZS5zZXRBY3RpdmVJdGVtKFxuICAgICAgc2VjdGlvbklkLFxuICAgICAgaXRlbUlkLFxuICAgICAgbmF2aWdhdGlvblNlY3Rpb25zXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIGZpbHRlclNlcXVlbmNlc0J5TmF2aWdhdGlvbihcbiAgICBzZWN0aW9uVHlwZTogTmF2aWdhdGlvblNlY3Rpb25bXCJ0eXBlXCJdLFxuICAgIGl0ZW06IE5hdmlnYXRpb25JdGVtXG4gICk6IFByb21pc2U8QnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbHRlcmVkID0gbmF2aWdhdGlvblNlcnZpY2UuZ2V0U2VxdWVuY2VzRm9yTmF2aWdhdGlvbkl0ZW0oXG4gICAgICAgIGl0ZW0sXG4gICAgICAgIHNlY3Rpb25UeXBlLFxuICAgICAgICBhbGxTZXF1ZW5jZXNcbiAgICAgICk7XG5cbiAgICAgIC8vIFVwZGF0ZSBkaXNwbGF5ZWQgc2VxdWVuY2VzXG4gICAgICBkaXNwbGF5ZWRTZXF1ZW5jZXMgPSBmaWx0ZXJlZDtcbiAgICAgIGZpbHRlcmVkU2VxdWVuY2VzID0gZmlsdGVyZWQ7XG5cbiAgICAgIC8vIPCfkr4gU0FWRSBOQVZJR0FUSU9OIEZJTFRFUiBTVEFURTogUGVyc2lzdCBuYXZpZ2F0aW9uIGZpbHRlciBmb3IgY3Jvc3Mtc2Vzc2lvbiBtZW1vcnlcbiAgICAgIGNvbnN0IGZpbHRlclR5cGUgPSBgbmF2aWdhdGlvbl8ke3NlY3Rpb25UeXBlfWA7XG4gICAgICBjb25zdCBmaWx0ZXJWYWx1ZSA9IGl0ZW0udmFsdWU7XG4gICAgICBjdXJyZW50RmlsdGVyID0ge1xuICAgICAgICB0eXBlOiBmaWx0ZXJUeXBlIGFzIEZpbHRlclR5cGUsXG4gICAgICAgIHZhbHVlOiBmaWx0ZXJWYWx1ZSBhcyBGaWx0ZXJWYWx1ZSxcbiAgICAgIH07XG4gICAgICBhd2FpdCBzdGF0ZU1hbmFnZXIuc2F2ZUZpbHRlclN0YXRlKGZpbHRlclR5cGUsIGZpbHRlclZhbHVlKTtcbiAgICAgIGNvbnNvbGUubG9nKFwi8J+SviBOYXZpZ2F0aW9uIGZpbHRlciBzdGF0ZSBzYXZlZDpcIiwge1xuICAgICAgICB0eXBlOiBmaWx0ZXJUeXBlLFxuICAgICAgICB2YWx1ZTogZmlsdGVyVmFsdWUsXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIGZpbHRlcmVkO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIGZpbHRlciBzZXF1ZW5jZXMgYnkgbmF2aWdhdGlvbjpcIiwgZXJyb3IpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIHRvZ2dsZVNlcXVlbmNlU2VjdGlvbihzZWN0aW9uSWQ6IHN0cmluZykge1xuICAgIHNlcXVlbmNlU2VjdGlvbnMgPSBzZWN0aW9uU2VydmljZS50b2dnbGVTZWN0aW9uRXhwYW5zaW9uKFxuICAgICAgc2VjdGlvbklkLFxuICAgICAgc2VxdWVuY2VTZWN0aW9uc1xuICAgICk7XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiB1cGRhdGVTZWN0aW9uQ29uZmlndXJhdGlvbihcbiAgICB1cGRhdGVzOiBQYXJ0aWFsPFNlY3Rpb25Db25maWd1cmF0aW9uPlxuICApIHtcbiAgICBzZWN0aW9uQ29uZmlndXJhdGlvbiA9IHNlY3Rpb25TZXJ2aWNlLnVwZGF0ZVNlY3Rpb25Db25maWd1cmF0aW9uKFxuICAgICAgc2VjdGlvbkNvbmZpZ3VyYXRpb24sXG4gICAgICB1cGRhdGVzXG4gICAgKTtcbiAgICBhd2FpdCBnZW5lcmF0ZVNlcXVlbmNlU2VjdGlvbnMoKTtcbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIHByZXBhcmVEZWxldGVTZXF1ZW5jZShzZXF1ZW5jZTogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjb25maXJtYXRpb25EYXRhID0gYXdhaXQgZGVsZXRlU2VydmljZS5wcmVwYXJlRGVsZXRlQ29uZmlybWF0aW9uKFxuICAgICAgICBzZXF1ZW5jZSxcbiAgICAgICAgYWxsU2VxdWVuY2VzXG4gICAgICApO1xuICAgICAgZGVsZXRlQ29uZmlybWF0aW9uID0gY29uZmlybWF0aW9uRGF0YTtcbiAgICAgIHNob3dEZWxldGVEaWFsb2cgPSB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIHByZXBhcmUgZGVsZXRlIGNvbmZpcm1hdGlvbjpcIiwgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIGNvbmZpcm1EZWxldGVTZXF1ZW5jZSgpIHtcbiAgICBpZiAoIWRlbGV0ZUNvbmZpcm1hdGlvbikgcmV0dXJuO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRlbGV0ZVNlcnZpY2UuZGVsZXRlU2VxdWVuY2UoXG4gICAgICAgIGRlbGV0ZUNvbmZpcm1hdGlvbi5zZXF1ZW5jZSxcbiAgICAgICAgYWxsU2VxdWVuY2VzXG4gICAgICApO1xuXG4gICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MgJiYgZGVsZXRlQ29uZmlybWF0aW9uKSB7XG4gICAgICAgIGNvbnN0IGRlbGV0ZWRTZXF1ZW5jZUlkID0gZGVsZXRlQ29uZmlybWF0aW9uLnNlcXVlbmNlLmlkO1xuICAgICAgICAvLyBSZW1vdmUgZnJvbSBzZXF1ZW5jZXNcbiAgICAgICAgYWxsU2VxdWVuY2VzID0gYWxsU2VxdWVuY2VzLmZpbHRlcihcbiAgICAgICAgICAoc2VxKSA9PiBzZXEuaWQgIT09IGRlbGV0ZWRTZXF1ZW5jZUlkXG4gICAgICAgICk7XG4gICAgICAgIGZpbHRlcmVkU2VxdWVuY2VzID0gZmlsdGVyZWRTZXF1ZW5jZXMuZmlsdGVyKFxuICAgICAgICAgIChzZXEpID0+IHNlcS5pZCAhPT0gZGVsZXRlZFNlcXVlbmNlSWRcbiAgICAgICAgKTtcbiAgICAgICAgZGlzcGxheWVkU2VxdWVuY2VzID0gZGlzcGxheWVkU2VxdWVuY2VzLmZpbHRlcihcbiAgICAgICAgICAoc2VxKSA9PiBzZXEuaWQgIT09IGRlbGV0ZWRTZXF1ZW5jZUlkXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gQ2xlYXIgc2VsZWN0aW9uIGlmIGRlbGV0ZWQgc2VxdWVuY2Ugd2FzIHNlbGVjdGVkXG4gICAgICAgIGlmIChzZWxlY3RlZFNlcXVlbmNlPy5pZCA9PT0gZGVsZXRlZFNlcXVlbmNlSWQpIHtcbiAgICAgICAgICBzZWxlY3RlZFNlcXVlbmNlID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFVwZGF0ZSBuYXZpZ2F0aW9uIGFuZCBzZWN0aW9uc1xuICAgICAgICBhd2FpdCBnZW5lcmF0ZU5hdmlnYXRpb25TZWN0aW9ucygpO1xuICAgICAgICBhd2FpdCBnZW5lcmF0ZVNlcXVlbmNlU2VjdGlvbnMoKTtcbiAgICAgIH1cblxuICAgICAgZGVsZXRlQ29uZmlybWF0aW9uID0gbnVsbDtcbiAgICAgIHNob3dEZWxldGVEaWFsb2cgPSBmYWxzZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBkZWxldGUgc2VxdWVuY2U6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBjYW5jZWxEZWxldGVTZXF1ZW5jZSgpIHtcbiAgICBkZWxldGVDb25maXJtYXRpb24gPSBudWxsO1xuICAgIHNob3dEZWxldGVEaWFsb2cgPSBmYWxzZTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgLy8g4pyFIFJFQUNUSVZFIFNUQVRFIEdFVFRFUlNcbiAgICBnZXQgYWxsU2VxdWVuY2VzKCkge1xuICAgICAgcmV0dXJuIGFsbFNlcXVlbmNlcztcbiAgICB9LFxuICAgIGdldCBkaXNwbGF5ZWRTZXF1ZW5jZXMoKSB7XG4gICAgICByZXR1cm4gZGlzcGxheWVkU2VxdWVuY2VzO1xuICAgIH0sXG4gICAgZ2V0IHNlbGVjdGVkU2VxdWVuY2UoKSB7XG4gICAgICByZXR1cm4gc2VsZWN0ZWRTZXF1ZW5jZTtcbiAgICB9LFxuICAgIGdldCBjdXJyZW50RmlsdGVyKCkge1xuICAgICAgcmV0dXJuIGN1cnJlbnRGaWx0ZXI7XG4gICAgfSxcbiAgICBnZXQgY3VycmVudFNvcnQoKSB7XG4gICAgICByZXR1cm4gY3VycmVudFNvcnQ7XG4gICAgfSxcbiAgICBnZXQgbmF2aWdhdGlvbk1vZGUoKSB7XG4gICAgICByZXR1cm4gbmF2aWdhdGlvbk1vZGU7XG4gICAgfSxcbiAgICBnZXQgc2VhcmNoUXVlcnkoKSB7XG4gICAgICByZXR1cm4gc2VhcmNoUXVlcnk7XG4gICAgfSxcblxuICAgIC8vIEFkdmFuY2VkIHN0YXRlIGdldHRlcnNcbiAgICBnZXQgZmF2b3JpdGVzKCkge1xuICAgICAgcmV0dXJuIGZhdm9yaXRlcztcbiAgICB9LFxuICAgIGdldCBuYXZpZ2F0aW9uU2VjdGlvbnMoKSB7XG4gICAgICByZXR1cm4gbmF2aWdhdGlvblNlY3Rpb25zO1xuICAgIH0sXG4gICAgZ2V0IHNlcXVlbmNlU2VjdGlvbnMoKSB7XG4gICAgICByZXR1cm4gc2VxdWVuY2VTZWN0aW9ucztcbiAgICB9LFxuICAgIGdldCBzZWN0aW9uQ29uZmlndXJhdGlvbigpIHtcbiAgICAgIHJldHVybiBzZWN0aW9uQ29uZmlndXJhdGlvbjtcbiAgICB9LFxuICAgIGdldCBkZWxldGVDb25maXJtYXRpb24oKSB7XG4gICAgICByZXR1cm4gZGVsZXRlQ29uZmlybWF0aW9uO1xuICAgIH0sXG4gICAgZ2V0IHNob3dEZWxldGVEaWFsb2coKSB7XG4gICAgICByZXR1cm4gc2hvd0RlbGV0ZURpYWxvZztcbiAgICB9LFxuXG4gICAgLy8g4pyFIERFUklWRUQgU1RBVEUgR0VUVEVSU1xuICAgIGdldCBpc0xvYWRpbmcoKSB7XG4gICAgICByZXR1cm4gaXNMb2FkaW5nO1xuICAgIH0sXG4gICAgZ2V0IGhhc1NlcXVlbmNlcygpIHtcbiAgICAgIHJldHVybiBoYXNTZXF1ZW5jZXM7XG4gICAgfSxcbiAgICBnZXQgaGFzRXJyb3IoKSB7XG4gICAgICByZXR1cm4gaGFzRXJyb3I7XG4gICAgfSxcbiAgICBnZXQgc2VxdWVuY2VDb3VudCgpIHtcbiAgICAgIHJldHVybiBzZXF1ZW5jZUNvdW50O1xuICAgIH0sXG4gICAgZ2V0IHNvcnRlZFNlY3Rpb25zKCkge1xuICAgICAgcmV0dXJuIHNvcnRlZFNlY3Rpb25zO1xuICAgIH0sXG4gICAgZ2V0IGxvYWRpbmdTdGF0ZSgpIHtcbiAgICAgIHJldHVybiBsb2FkaW5nU3RhdGU7XG4gICAgfSxcbiAgICBnZXQgZGlzcGxheVN0YXRlKCkge1xuICAgICAgcmV0dXJuIGRpc3BsYXlTdGF0ZTtcbiAgICB9LFxuXG4gICAgLy8gQWR2YW5jZWQgZGVyaXZlZCBnZXR0ZXJzXG4gICAgZ2V0IGZhdm9yaXRlc0NvdW50KCkge1xuICAgICAgcmV0dXJuIGZhdm9yaXRlc0NvdW50O1xuICAgIH0sXG4gICAgZ2V0IGhhc05hdmlnYXRpb25TZWN0aW9ucygpIHtcbiAgICAgIHJldHVybiBoYXNOYXZpZ2F0aW9uU2VjdGlvbnM7XG4gICAgfSxcbiAgICBnZXQgaGFzU2VxdWVuY2VTZWN0aW9ucygpIHtcbiAgICAgIHJldHVybiBoYXNTZXF1ZW5jZVNlY3Rpb25zO1xuICAgIH0sXG4gICAgZ2V0IHNlY3Rpb25TdGF0aXN0aWNzKCkge1xuICAgICAgcmV0dXJuIHNlY3Rpb25TdGF0aXN0aWNzO1xuICAgIH0sXG5cbiAgICAvLyDinIUgQUNUSU9OIE1FVEhPRFNcbiAgICBsb2FkQWxsU2VxdWVuY2VzLFxuICAgIGFwcGx5RmlsdGVyLFxuICAgIHVwZGF0ZVNvcnQsXG4gICAgc2VhcmNoU2VxdWVuY2VzLFxuICAgIHNlbGVjdFNlcXVlbmNlLFxuICAgIGNsZWFyU2VsZWN0aW9uLFxuICAgIGJhY2tUb0ZpbHRlcnMsXG4gICAgZ2V0VGh1bWJuYWlsVXJsLFxuICAgIHVwZGF0ZURpc3BsYXlTZXR0aW5ncyxcbiAgICBjbGVhckVycm9yLFxuXG4gICAgLy8gQWR2YW5jZWQgYWN0aW9uIG1ldGhvZHNcbiAgICBsb2FkRmF2b3JpdGVzLFxuICAgIHRvZ2dsZUZhdm9yaXRlLFxuICAgIGdlbmVyYXRlTmF2aWdhdGlvblNlY3Rpb25zLFxuICAgIGdlbmVyYXRlU2VxdWVuY2VTZWN0aW9ucyxcbiAgICB0b2dnbGVOYXZpZ2F0aW9uU2VjdGlvbixcbiAgICBzZXRBY3RpdmVOYXZpZ2F0aW9uSXRlbSxcbiAgICBmaWx0ZXJTZXF1ZW5jZXNCeU5hdmlnYXRpb24sXG4gICAgdG9nZ2xlU2VxdWVuY2VTZWN0aW9uLFxuICAgIHVwZGF0ZVNlY3Rpb25Db25maWd1cmF0aW9uLFxuICAgIHByZXBhcmVEZWxldGVTZXF1ZW5jZSxcbiAgICBjb25maXJtRGVsZXRlU2VxdWVuY2UsXG4gICAgY2FuY2VsRGVsZXRlU2VxdWVuY2UsXG4gIH07XG59XG5cbmV4cG9ydCB0eXBlIEJyb3dzZVN0YXRlID0gUmV0dXJuVHlwZTx0eXBlb2YgY3JlYXRlQnJvd3NlU3RhdGU+O1xuIl0sImZpbGUiOiJGOi9DT0RFL1RLQS93ZWIvc3JjL2xpYi9zdGF0ZS9icm93c2Utc3RhdGUuc3ZlbHRlLnRzIn0=