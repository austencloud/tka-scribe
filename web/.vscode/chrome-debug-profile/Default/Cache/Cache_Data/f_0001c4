/* motion-tester-state.svelte.ts generated by Svelte v5.38.1 */
import * as $ from "/node_modules/.vite/deps/svelte_internal_client.js?v=cc8aba6c";
import { MotionParameterService } from "/src/routes/motion-tester/services/MotionParameterService.ts";
import { AnimationControlService } from "/src/routes/motion-tester/services/AnimationControlService.ts";
import { resolve } from "/src/lib/services/bootstrap.ts";
import { OrientationCalculationService } from "/src/lib/services/implementations/positioning/OrientationCalculationService.ts";
import { MotionLetterIdentificationService } from "/src/routes/motion-tester/services/MotionLetterIdentificationService.ts";
import { MotionType, MotionColor } from "/src/lib/domain/enums.ts";

export function createMotionTesterState() {
	const motionService = new MotionParameterService();
	const animationEngine = resolve("ISequenceAnimationEngine");
	const animationService = new AnimationControlService(animationEngine);
	const orientationService = new OrientationCalculationService();
	const letterIdentificationService = new MotionLetterIdentificationService();
	let blueMotionParams = $.tag($.state($.proxy(motionService.createDefaultParams())), 'blueMotionParams');

	let redMotionParams = $.tag(
		$.state($.proxy({
			...motionService.createDefaultParams(),
			startLocation: "e",
			endLocation: "w",
			motionType: MotionType.DASH
		})),
		'redMotionParams'
	);

	const propVisibility = $.tag_proxy($.proxy({ blue: true, red: true }), 'propVisibility');
	const animationState = $.tag_proxy($.proxy({ isPlaying: false, progress: 0, currentBeat: 0 }), 'animationState');
	let isEngineInitialized = $.tag($.state(false), 'isEngineInitialized');
	let gridType = $.tag($.state("diamond"), 'gridType');

	const identifiedLetter = $.tag(
		$.derived(() => () => {
			return letterIdentificationService.identifyLetter($.get(blueMotionParams), $.get(redMotionParams), $.get(gridType));
		}),
		'identifiedLetter'
	);

	$.user_effect(() => {
		const { motionType, startLocation, endLocation, rotationDirection } = $.get(blueMotionParams);
		const newRotDir = motionService.calculateRotationDirection(motionType, startLocation, endLocation);

		if ($.strict_equals(newRotDir, rotationDirection, false)) {
			$.get(blueMotionParams).rotationDirection = newRotDir;
		}
	});

	$.user_effect(() => {
		const motionData = motionService.convertToMotionData($.get(blueMotionParams));
		const newEndOri = orientationService.calculateEndOrientation(motionData, MotionColor.BLUE);

		if ($.strict_equals(newEndOri, $.get(blueMotionParams).endOrientation, false)) {
			$.get(blueMotionParams).endOrientation = newEndOri;
		}
	});

	$.user_effect(() => {
		const { motionType, startLocation, endLocation, rotationDirection } = $.get(redMotionParams);

		console.log(`ðŸ”´ Red rotation effect triggered: ${startLocation}â†’${endLocation} (${motionType})`);

		const newRotDir = motionService.calculateRotationDirection(motionType, startLocation, endLocation);

		console.log(`ðŸ”´ Red rotation calculated: ${newRotDir}, current: ${rotationDirection}`);

		if ($.strict_equals(newRotDir, rotationDirection, false)) {
			console.log(`ðŸ”´ Red rotation updating from ${rotationDirection} to ${newRotDir}`);
			$.get(redMotionParams).rotationDirection = newRotDir;
		}
	});

	$.user_effect(() => {
		const motionData = motionService.convertToMotionData($.get(redMotionParams));
		const newEndOri = orientationService.calculateEndOrientation(motionData, MotionColor.RED);

		if ($.strict_equals(newEndOri, $.get(redMotionParams).endOrientation, false)) {
			$.get(redMotionParams).endOrientation = newEndOri;
		}
	});

	$.user_effect(() => {
		const initEngine = async () => {
			const blueParams = { ...$.get(blueMotionParams) };
			const redParams = { ...$.get(redMotionParams) };
			const success = (await $.track_reactivity_loss(animationService.initializeEngine(blueParams, redParams)))();

			$.set(isEngineInitialized, success, true);
		};

		initEngine();
	});

	$.user_effect(() => {
		animationState.progress = animationService.getProgress();
		animationState.currentBeat = animationService.getCurrentBeat();
		animationState.isPlaying = animationService.isPlaying();
	});

	return {
		// Reactive state getters
		get blueMotionParams() {
			return $.get(blueMotionParams);
		},

		get redMotionParams() {
			return $.get(redMotionParams);
		},

		get animationState() {
			return animationState;
		},

		get propVisibility() {
			return propVisibility;
		},

		get currentPropStates() {
			return animationService.getCurrentPropStates();
		},

		get isEngineInitialized() {
			return $.get(isEngineInitialized);
		},

		get gridType() {
			return $.get(gridType);
		},

		get identifiedLetter() {
			return $.get(identifiedLetter);
		},

		// Blue prop methods
		setBlueStartLocation: (location) => {
			$.get(blueMotionParams).startLocation = location;

			const updatedParams = motionService.updateMotionTypeForLocations($.get(blueMotionParams));

			$.set(blueMotionParams, updatedParams, true);
		},

		setBlueEndLocation: (location) => {
			console.log(`ðŸ”µ Blue end location changing from ${$.get(blueMotionParams).endLocation} to ${location}`);
			$.get(blueMotionParams).endLocation = location;

			const updatedParams = motionService.updateMotionTypeForLocations($.get(blueMotionParams));

			$.set(blueMotionParams, updatedParams, true);
			console.log(...$.log_if_contains_state('log', `ðŸ”µ Blue motion params updated:`, $.get(blueMotionParams)));
		},

		updateBlueMotionParam: (param, value) => {
			$.get(blueMotionParams)[param] = value;
		},

		// Red prop methods
		setRedStartLocation: (location) => {
			$.get(redMotionParams).startLocation = location;

			const updatedParams = motionService.updateMotionTypeForLocations($.get(redMotionParams));

			$.set(redMotionParams, updatedParams, true);
		},

		setRedEndLocation: (location) => {
			console.log(`ðŸ”´ Red end location changing from ${$.get(redMotionParams).endLocation} to ${location}`);
			$.get(redMotionParams).endLocation = location;

			const updatedParams = motionService.updateMotionTypeForLocations($.get(redMotionParams));

			$.set(redMotionParams, updatedParams, true);
			console.log(...$.log_if_contains_state('log', `ðŸ”´ Red motion params updated:`, $.get(redMotionParams)));
		},

		updateRedMotionParam: (param, value) => {
			$.get(redMotionParams)[param] = value;
		},

		// Animation control methods
		setProgress: (progress) => {
			animationService.setProgress(progress);
		},

		startAnimation: () => {
			animationService.startAnimation();
		},

		stopAnimation: () => {
			animationService.stopAnimation();
		},

		resetAnimation: () => {
			animationService.resetAnimation();
		},

		// Grid control methods
		setGridType: (newGridType) => {
			$.set(gridType, newGridType, true);
		}
	};
}
//# sourceMappingURL=data:application/json;base64,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aUJBQWdCLGdCQUFnQjs7U0FDMUIsZ0JBQ0osY0FBYyxtQ0FBNkIsZUFBZTs7U0FDNUQsaUJBQWtCO0VBQ3BCOztFQUVBLG9CQUFvQixhQUFxQjtHQUN2QyxRQUFRLCtDQUMrQixpQkFBZ0IsV0FBVyxPQUFPLFFBQVE7U0FFakYsaUJBQWdCLGNBQWM7O1NBQ3hCLGdCQUNKLGNBQWMsbUNBQTZCLGVBQWU7O1NBQzVELGlCQUFrQjtHQUNsQixRQUFRLDZFQUFxQyxlQUFlO0VBQzlEOztFQUVBLHVCQUNFLE9BQ0EsVUFDRztTQUNILGlCQUFnQixLQUFLLElBQUk7RUFDM0I7OztFQUdBLGNBQWMsYUFBcUI7R0FDakMsaUJBQWlCLFlBQVksUUFBUTtFQUN2Qzs7RUFFQSxzQkFBc0I7R0FDcEIsaUJBQWlCO0VBQ25COztFQUVBLHFCQUFxQjtHQUNuQixpQkFBaUI7RUFDbkI7O0VBRUEsc0JBQXNCO0dBQ3BCLGlCQUFpQjtFQUNuQjs7O0VBR0EsY0FBYyxnQkFBbUM7U0FDL0MsVUFBVztFQUNiOztBQUVKIiwibmFtZXMiOltdLCJpZ25vcmVMaXN0IjpbXSwic291cmNlcyI6WyJtb3Rpb24tdGVzdGVyLXN0YXRlLnN2ZWx0ZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBNb3Rpb25QYXJhbWV0ZXJTZXJ2aWNlLFxuICB0eXBlIE1vdGlvblRlc3RQYXJhbXMsXG59IGZyb20gXCIuLi9zZXJ2aWNlcy9Nb3Rpb25QYXJhbWV0ZXJTZXJ2aWNlXCI7XG5pbXBvcnQge1xuICBBbmltYXRpb25Db250cm9sU2VydmljZSxcbiAgdHlwZSBBbmltYXRpb25TdGF0ZSxcbiAgdHlwZSBQcm9wVmlzaWJpbGl0eSxcbiAgdHlwZSBQcm9wU3RhdGVzLFxufSBmcm9tIFwiLi4vc2VydmljZXMvQW5pbWF0aW9uQ29udHJvbFNlcnZpY2VcIjtcbmltcG9ydCB7IHJlc29sdmUgfSBmcm9tIFwiJGxpYi9zZXJ2aWNlcy9ib290c3RyYXBcIjtcbmltcG9ydCB0eXBlIHsgSVNlcXVlbmNlQW5pbWF0aW9uRW5naW5lIH0gZnJvbSBcIiRsaWIvc2VydmljZXMvZGkvaW50ZXJmYWNlcy9hbmltYXRvci1pbnRlcmZhY2VzXCI7XG5pbXBvcnQgeyBPcmllbnRhdGlvbkNhbGN1bGF0aW9uU2VydmljZSB9IGZyb20gXCIkbGliL3NlcnZpY2VzL2ltcGxlbWVudGF0aW9ucy9wb3NpdGlvbmluZy9PcmllbnRhdGlvbkNhbGN1bGF0aW9uU2VydmljZVwiO1xuaW1wb3J0IHtcbiAgTW90aW9uTGV0dGVySWRlbnRpZmljYXRpb25TZXJ2aWNlLFxuICB0eXBlIExldHRlcklkZW50aWZpY2F0aW9uUmVzdWx0LFxufSBmcm9tIFwiLi4vc2VydmljZXMvTW90aW9uTGV0dGVySWRlbnRpZmljYXRpb25TZXJ2aWNlXCI7XG5cbmltcG9ydCB7IE1vdGlvblR5cGUsIE1vdGlvbkNvbG9yIH0gZnJvbSBcIiRsaWIvZG9tYWluL2VudW1zXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTW90aW9uVGVzdGVyU3RhdGUge1xuICAvLyBSZWFjdGl2ZSBzdGF0ZSBnZXR0ZXJzXG4gIGdldCBibHVlTW90aW9uUGFyYW1zKCk6IE1vdGlvblRlc3RQYXJhbXM7XG4gIGdldCByZWRNb3Rpb25QYXJhbXMoKTogTW90aW9uVGVzdFBhcmFtcztcbiAgZ2V0IGFuaW1hdGlvblN0YXRlKCk6IEFuaW1hdGlvblN0YXRlO1xuICBnZXQgcHJvcFZpc2liaWxpdHkoKTogUHJvcFZpc2liaWxpdHk7XG4gIGdldCBjdXJyZW50UHJvcFN0YXRlcygpOiBQcm9wU3RhdGVzO1xuICBnZXQgaXNFbmdpbmVJbml0aWFsaXplZCgpOiBib29sZWFuO1xuICBnZXQgZ3JpZFR5cGUoKTogXCJkaWFtb25kXCIgfCBcImJveFwiO1xuICBnZXQgaWRlbnRpZmllZExldHRlcigpOiBMZXR0ZXJJZGVudGlmaWNhdGlvblJlc3VsdDtcblxuICAvLyBCbHVlIHByb3AgbWV0aG9kc1xuICBzZXRCbHVlU3RhcnRMb2NhdGlvbjogKGxvY2F0aW9uOiBzdHJpbmcpID0+IHZvaWQ7XG4gIHNldEJsdWVFbmRMb2NhdGlvbjogKGxvY2F0aW9uOiBzdHJpbmcpID0+IHZvaWQ7XG4gIHVwZGF0ZUJsdWVNb3Rpb25QYXJhbTogPEsgZXh0ZW5kcyBrZXlvZiBNb3Rpb25UZXN0UGFyYW1zPihcbiAgICBwYXJhbTogSyxcbiAgICB2YWx1ZTogTW90aW9uVGVzdFBhcmFtc1tLXVxuICApID0+IHZvaWQ7XG5cbiAgLy8gUmVkIHByb3AgbWV0aG9kc1xuICBzZXRSZWRTdGFydExvY2F0aW9uOiAobG9jYXRpb246IHN0cmluZykgPT4gdm9pZDtcbiAgc2V0UmVkRW5kTG9jYXRpb246IChsb2NhdGlvbjogc3RyaW5nKSA9PiB2b2lkO1xuICB1cGRhdGVSZWRNb3Rpb25QYXJhbTogPEsgZXh0ZW5kcyBrZXlvZiBNb3Rpb25UZXN0UGFyYW1zPihcbiAgICBwYXJhbTogSyxcbiAgICB2YWx1ZTogTW90aW9uVGVzdFBhcmFtc1tLXVxuICApID0+IHZvaWQ7XG5cbiAgLy8gQW5pbWF0aW9uIGNvbnRyb2wgbWV0aG9kc1xuICBzZXRQcm9ncmVzczogKHByb2dyZXNzOiBudW1iZXIpID0+IHZvaWQ7XG4gIHN0YXJ0QW5pbWF0aW9uOiAoKSA9PiB2b2lkO1xuICBzdG9wQW5pbWF0aW9uOiAoKSA9PiB2b2lkO1xuICByZXNldEFuaW1hdGlvbjogKCkgPT4gdm9pZDtcblxuICAvLyBHcmlkIGNvbnRyb2wgbWV0aG9kc1xuICBzZXRHcmlkVHlwZTogKGdyaWRUeXBlOiBcImRpYW1vbmRcIiB8IFwiYm94XCIpID0+IHZvaWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVNb3Rpb25UZXN0ZXJTdGF0ZSgpOiBNb3Rpb25UZXN0ZXJTdGF0ZSB7XG4gIC8vIFNlcnZpY2VzXG4gIGNvbnN0IG1vdGlvblNlcnZpY2UgPSBuZXcgTW90aW9uUGFyYW1ldGVyU2VydmljZSgpO1xuICBjb25zdCBhbmltYXRpb25FbmdpbmUgPSByZXNvbHZlKFxuICAgIFwiSVNlcXVlbmNlQW5pbWF0aW9uRW5naW5lXCJcbiAgKSBhcyBJU2VxdWVuY2VBbmltYXRpb25FbmdpbmU7XG4gIGNvbnN0IGFuaW1hdGlvblNlcnZpY2UgPSBuZXcgQW5pbWF0aW9uQ29udHJvbFNlcnZpY2UoYW5pbWF0aW9uRW5naW5lKTtcbiAgY29uc3Qgb3JpZW50YXRpb25TZXJ2aWNlID0gbmV3IE9yaWVudGF0aW9uQ2FsY3VsYXRpb25TZXJ2aWNlKCk7XG4gIGNvbnN0IGxldHRlcklkZW50aWZpY2F0aW9uU2VydmljZSA9IG5ldyBNb3Rpb25MZXR0ZXJJZGVudGlmaWNhdGlvblNlcnZpY2UoKTtcblxuICAvLyBSZWFjdGl2ZSBzdGF0ZVxuICBsZXQgYmx1ZU1vdGlvblBhcmFtcyA9ICRzdGF0ZTxNb3Rpb25UZXN0UGFyYW1zPihcbiAgICBtb3Rpb25TZXJ2aWNlLmNyZWF0ZURlZmF1bHRQYXJhbXMoKVxuICApO1xuICBsZXQgcmVkTW90aW9uUGFyYW1zID0gJHN0YXRlPE1vdGlvblRlc3RQYXJhbXM+KHtcbiAgICAuLi5tb3Rpb25TZXJ2aWNlLmNyZWF0ZURlZmF1bHRQYXJhbXMoKSxcbiAgICBzdGFydExvY2F0aW9uOiBcImVcIixcbiAgICBlbmRMb2NhdGlvbjogXCJ3XCIsXG4gICAgbW90aW9uVHlwZTogTW90aW9uVHlwZS5EQVNILFxuICB9KTtcblxuICAvLyBQcm9wcyBhcmUgYWx3YXlzIHZpc2libGUgLSBubyB1c2VyIGNvbnRyb2xzIG5lZWRlZFxuICBjb25zdCBwcm9wVmlzaWJpbGl0eSA9ICRzdGF0ZTxQcm9wVmlzaWJpbGl0eT4oe1xuICAgIGJsdWU6IHRydWUsXG4gICAgcmVkOiB0cnVlLFxuICB9KTtcblxuICBjb25zdCBhbmltYXRpb25TdGF0ZSA9ICRzdGF0ZTxBbmltYXRpb25TdGF0ZT4oe1xuICAgIGlzUGxheWluZzogZmFsc2UsXG4gICAgcHJvZ3Jlc3M6IDAsXG4gICAgY3VycmVudEJlYXQ6IDAsXG4gIH0pO1xuXG4gIGxldCBpc0VuZ2luZUluaXRpYWxpemVkID0gJHN0YXRlKGZhbHNlKTtcbiAgbGV0IGdyaWRUeXBlID0gJHN0YXRlPFwiZGlhbW9uZFwiIHwgXCJib3hcIj4oXCJkaWFtb25kXCIpO1xuXG4gIC8vIExldHRlciBpZGVudGlmaWNhdGlvbiAtIHJlYWN0aXZlIHRvIG1vdGlvbiBwYXJhbWV0ZXIgY2hhbmdlc1xuICBjb25zdCBpZGVudGlmaWVkTGV0dGVyID0gJGRlcml2ZWQoKCkgPT4ge1xuICAgIHJldHVybiBsZXR0ZXJJZGVudGlmaWNhdGlvblNlcnZpY2UuaWRlbnRpZnlMZXR0ZXIoXG4gICAgICBibHVlTW90aW9uUGFyYW1zLFxuICAgICAgcmVkTW90aW9uUGFyYW1zLFxuICAgICAgZ3JpZFR5cGVcbiAgICApO1xuICB9KTtcblxuICAvLyBBdXRvLWNhbGN1bGF0ZSByb3RhdGlvbiBkaXJlY3Rpb24gZm9yIGJsdWUgcHJvcFxuICAkZWZmZWN0KCgpID0+IHtcbiAgICAvLyBQcm9wZXJseSBhY2Nlc3MgcmVhY3RpdmUgc3RhdGVcbiAgICBjb25zdCB7IG1vdGlvblR5cGUsIHN0YXJ0TG9jYXRpb24sIGVuZExvY2F0aW9uLCByb3RhdGlvbkRpcmVjdGlvbiB9ID1cbiAgICAgIGJsdWVNb3Rpb25QYXJhbXM7XG4gICAgY29uc3QgbmV3Um90RGlyID0gbW90aW9uU2VydmljZS5jYWxjdWxhdGVSb3RhdGlvbkRpcmVjdGlvbihcbiAgICAgIG1vdGlvblR5cGUsXG4gICAgICBzdGFydExvY2F0aW9uLFxuICAgICAgZW5kTG9jYXRpb25cbiAgICApO1xuICAgIGlmIChuZXdSb3REaXIgIT09IHJvdGF0aW9uRGlyZWN0aW9uKSB7XG4gICAgICBibHVlTW90aW9uUGFyYW1zLnJvdGF0aW9uRGlyZWN0aW9uID0gbmV3Um90RGlyO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gQXV0by1jYWxjdWxhdGUgZW5kIG9yaWVudGF0aW9uIGZvciBibHVlIHByb3BcbiAgJGVmZmVjdCgoKSA9PiB7XG4gICAgY29uc3QgbW90aW9uRGF0YSA9IG1vdGlvblNlcnZpY2UuY29udmVydFRvTW90aW9uRGF0YShibHVlTW90aW9uUGFyYW1zKTtcbiAgICBjb25zdCBuZXdFbmRPcmkgPSBvcmllbnRhdGlvblNlcnZpY2UuY2FsY3VsYXRlRW5kT3JpZW50YXRpb24oXG4gICAgICBtb3Rpb25EYXRhLFxuICAgICAgTW90aW9uQ29sb3IuQkxVRVxuICAgICk7XG4gICAgaWYgKG5ld0VuZE9yaSAhPT0gYmx1ZU1vdGlvblBhcmFtcy5lbmRPcmllbnRhdGlvbikge1xuICAgICAgYmx1ZU1vdGlvblBhcmFtcy5lbmRPcmllbnRhdGlvbiA9IG5ld0VuZE9yaTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIEF1dG8tY2FsY3VsYXRlIHJvdGF0aW9uIGRpcmVjdGlvbiBmb3IgcmVkIHByb3BcbiAgJGVmZmVjdCgoKSA9PiB7XG4gICAgLy8gUHJvcGVybHkgYWNjZXNzIHJlYWN0aXZlIHN0YXRlXG4gICAgY29uc3QgeyBtb3Rpb25UeXBlLCBzdGFydExvY2F0aW9uLCBlbmRMb2NhdGlvbiwgcm90YXRpb25EaXJlY3Rpb24gfSA9XG4gICAgICByZWRNb3Rpb25QYXJhbXM7XG4gICAgY29uc29sZS5sb2coXG4gICAgICBg8J+UtCBSZWQgcm90YXRpb24gZWZmZWN0IHRyaWdnZXJlZDogJHtzdGFydExvY2F0aW9ufeKGkiR7ZW5kTG9jYXRpb259ICgke21vdGlvblR5cGV9KWBcbiAgICApO1xuICAgIGNvbnN0IG5ld1JvdERpciA9IG1vdGlvblNlcnZpY2UuY2FsY3VsYXRlUm90YXRpb25EaXJlY3Rpb24oXG4gICAgICBtb3Rpb25UeXBlLFxuICAgICAgc3RhcnRMb2NhdGlvbixcbiAgICAgIGVuZExvY2F0aW9uXG4gICAgKTtcbiAgICBjb25zb2xlLmxvZyhcbiAgICAgIGDwn5S0IFJlZCByb3RhdGlvbiBjYWxjdWxhdGVkOiAke25ld1JvdERpcn0sIGN1cnJlbnQ6ICR7cm90YXRpb25EaXJlY3Rpb259YFxuICAgICk7XG4gICAgaWYgKG5ld1JvdERpciAhPT0gcm90YXRpb25EaXJlY3Rpb24pIHtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBg8J+UtCBSZWQgcm90YXRpb24gdXBkYXRpbmcgZnJvbSAke3JvdGF0aW9uRGlyZWN0aW9ufSB0byAke25ld1JvdERpcn1gXG4gICAgICApO1xuICAgICAgcmVkTW90aW9uUGFyYW1zLnJvdGF0aW9uRGlyZWN0aW9uID0gbmV3Um90RGlyO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gQXV0by1jYWxjdWxhdGUgZW5kIG9yaWVudGF0aW9uIGZvciByZWQgcHJvcFxuICAkZWZmZWN0KCgpID0+IHtcbiAgICBjb25zdCBtb3Rpb25EYXRhID0gbW90aW9uU2VydmljZS5jb252ZXJ0VG9Nb3Rpb25EYXRhKHJlZE1vdGlvblBhcmFtcyk7XG4gICAgY29uc3QgbmV3RW5kT3JpID0gb3JpZW50YXRpb25TZXJ2aWNlLmNhbGN1bGF0ZUVuZE9yaWVudGF0aW9uKFxuICAgICAgbW90aW9uRGF0YSxcbiAgICAgIE1vdGlvbkNvbG9yLlJFRFxuICAgICk7XG4gICAgaWYgKG5ld0VuZE9yaSAhPT0gcmVkTW90aW9uUGFyYW1zLmVuZE9yaWVudGF0aW9uKSB7XG4gICAgICByZWRNb3Rpb25QYXJhbXMuZW5kT3JpZW50YXRpb24gPSBuZXdFbmRPcmk7XG4gICAgfVxuICB9KTtcblxuICAvLyBJbml0aWFsaXplIGVuZ2luZSB3aGVuIG1vdGlvbiBwYXJhbWV0ZXJzIGNoYW5nZVxuICAkZWZmZWN0KCgpID0+IHtcbiAgICBjb25zdCBpbml0RW5naW5lID0gYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gQ3JlYXRlIGNvcGllcyB0byBwcm9wZXJseSBjYXB0dXJlIHJlYWN0aXZlIHN0YXRlXG4gICAgICBjb25zdCBibHVlUGFyYW1zID0geyAuLi5ibHVlTW90aW9uUGFyYW1zIH07XG4gICAgICBjb25zdCByZWRQYXJhbXMgPSB7IC4uLnJlZE1vdGlvblBhcmFtcyB9O1xuICAgICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IGFuaW1hdGlvblNlcnZpY2UuaW5pdGlhbGl6ZUVuZ2luZShcbiAgICAgICAgYmx1ZVBhcmFtcyxcbiAgICAgICAgcmVkUGFyYW1zXG4gICAgICApO1xuICAgICAgaXNFbmdpbmVJbml0aWFsaXplZCA9IHN1Y2Nlc3M7XG4gICAgfTtcbiAgICBpbml0RW5naW5lKCk7XG4gIH0pO1xuXG4gIC8vIFVwZGF0ZSBhbmltYXRpb24gc3RhdGVcbiAgJGVmZmVjdCgoKSA9PiB7XG4gICAgYW5pbWF0aW9uU3RhdGUucHJvZ3Jlc3MgPSBhbmltYXRpb25TZXJ2aWNlLmdldFByb2dyZXNzKCk7XG4gICAgYW5pbWF0aW9uU3RhdGUuY3VycmVudEJlYXQgPSBhbmltYXRpb25TZXJ2aWNlLmdldEN1cnJlbnRCZWF0KCk7XG4gICAgYW5pbWF0aW9uU3RhdGUuaXNQbGF5aW5nID0gYW5pbWF0aW9uU2VydmljZS5pc1BsYXlpbmcoKTtcbiAgfSk7XG5cbiAgcmV0dXJuIHtcbiAgICAvLyBSZWFjdGl2ZSBzdGF0ZSBnZXR0ZXJzXG4gICAgZ2V0IGJsdWVNb3Rpb25QYXJhbXMoKSB7XG4gICAgICByZXR1cm4gYmx1ZU1vdGlvblBhcmFtcztcbiAgICB9LFxuICAgIGdldCByZWRNb3Rpb25QYXJhbXMoKSB7XG4gICAgICByZXR1cm4gcmVkTW90aW9uUGFyYW1zO1xuICAgIH0sXG4gICAgZ2V0IGFuaW1hdGlvblN0YXRlKCkge1xuICAgICAgcmV0dXJuIGFuaW1hdGlvblN0YXRlO1xuICAgIH0sXG4gICAgZ2V0IHByb3BWaXNpYmlsaXR5KCkge1xuICAgICAgcmV0dXJuIHByb3BWaXNpYmlsaXR5O1xuICAgIH0sXG4gICAgZ2V0IGN1cnJlbnRQcm9wU3RhdGVzKCkge1xuICAgICAgcmV0dXJuIGFuaW1hdGlvblNlcnZpY2UuZ2V0Q3VycmVudFByb3BTdGF0ZXMoKTtcbiAgICB9LFxuICAgIGdldCBpc0VuZ2luZUluaXRpYWxpemVkKCkge1xuICAgICAgcmV0dXJuIGlzRW5naW5lSW5pdGlhbGl6ZWQ7XG4gICAgfSxcbiAgICBnZXQgZ3JpZFR5cGUoKSB7XG4gICAgICByZXR1cm4gZ3JpZFR5cGU7XG4gICAgfSxcbiAgICBnZXQgaWRlbnRpZmllZExldHRlcigpIHtcbiAgICAgIHJldHVybiBpZGVudGlmaWVkTGV0dGVyO1xuICAgIH0sXG5cbiAgICAvLyBCbHVlIHByb3AgbWV0aG9kc1xuICAgIHNldEJsdWVTdGFydExvY2F0aW9uOiAobG9jYXRpb246IHN0cmluZykgPT4ge1xuICAgICAgYmx1ZU1vdGlvblBhcmFtcy5zdGFydExvY2F0aW9uID0gbG9jYXRpb247XG4gICAgICBjb25zdCB1cGRhdGVkUGFyYW1zID1cbiAgICAgICAgbW90aW9uU2VydmljZS51cGRhdGVNb3Rpb25UeXBlRm9yTG9jYXRpb25zKGJsdWVNb3Rpb25QYXJhbXMpO1xuICAgICAgYmx1ZU1vdGlvblBhcmFtcyA9IHVwZGF0ZWRQYXJhbXM7XG4gICAgfSxcblxuICAgIHNldEJsdWVFbmRMb2NhdGlvbjogKGxvY2F0aW9uOiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBg8J+UtSBCbHVlIGVuZCBsb2NhdGlvbiBjaGFuZ2luZyBmcm9tICR7Ymx1ZU1vdGlvblBhcmFtcy5lbmRMb2NhdGlvbn0gdG8gJHtsb2NhdGlvbn1gXG4gICAgICApO1xuICAgICAgYmx1ZU1vdGlvblBhcmFtcy5lbmRMb2NhdGlvbiA9IGxvY2F0aW9uO1xuICAgICAgY29uc3QgdXBkYXRlZFBhcmFtcyA9XG4gICAgICAgIG1vdGlvblNlcnZpY2UudXBkYXRlTW90aW9uVHlwZUZvckxvY2F0aW9ucyhibHVlTW90aW9uUGFyYW1zKTtcbiAgICAgIGJsdWVNb3Rpb25QYXJhbXMgPSB1cGRhdGVkUGFyYW1zO1xuICAgICAgY29uc29sZS5sb2coYPCflLUgQmx1ZSBtb3Rpb24gcGFyYW1zIHVwZGF0ZWQ6YCwgYmx1ZU1vdGlvblBhcmFtcyk7XG4gICAgfSxcblxuICAgIHVwZGF0ZUJsdWVNb3Rpb25QYXJhbTogPEsgZXh0ZW5kcyBrZXlvZiBNb3Rpb25UZXN0UGFyYW1zPihcbiAgICAgIHBhcmFtOiBLLFxuICAgICAgdmFsdWU6IE1vdGlvblRlc3RQYXJhbXNbS11cbiAgICApID0+IHtcbiAgICAgIGJsdWVNb3Rpb25QYXJhbXNbcGFyYW1dID0gdmFsdWU7XG4gICAgfSxcblxuICAgIC8vIFJlZCBwcm9wIG1ldGhvZHNcbiAgICBzZXRSZWRTdGFydExvY2F0aW9uOiAobG9jYXRpb246IHN0cmluZykgPT4ge1xuICAgICAgcmVkTW90aW9uUGFyYW1zLnN0YXJ0TG9jYXRpb24gPSBsb2NhdGlvbjtcbiAgICAgIGNvbnN0IHVwZGF0ZWRQYXJhbXMgPVxuICAgICAgICBtb3Rpb25TZXJ2aWNlLnVwZGF0ZU1vdGlvblR5cGVGb3JMb2NhdGlvbnMocmVkTW90aW9uUGFyYW1zKTtcbiAgICAgIHJlZE1vdGlvblBhcmFtcyA9IHVwZGF0ZWRQYXJhbXM7XG4gICAgfSxcblxuICAgIHNldFJlZEVuZExvY2F0aW9uOiAobG9jYXRpb246IHN0cmluZykgPT4ge1xuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgIGDwn5S0IFJlZCBlbmQgbG9jYXRpb24gY2hhbmdpbmcgZnJvbSAke3JlZE1vdGlvblBhcmFtcy5lbmRMb2NhdGlvbn0gdG8gJHtsb2NhdGlvbn1gXG4gICAgICApO1xuICAgICAgcmVkTW90aW9uUGFyYW1zLmVuZExvY2F0aW9uID0gbG9jYXRpb247XG4gICAgICBjb25zdCB1cGRhdGVkUGFyYW1zID1cbiAgICAgICAgbW90aW9uU2VydmljZS51cGRhdGVNb3Rpb25UeXBlRm9yTG9jYXRpb25zKHJlZE1vdGlvblBhcmFtcyk7XG4gICAgICByZWRNb3Rpb25QYXJhbXMgPSB1cGRhdGVkUGFyYW1zO1xuICAgICAgY29uc29sZS5sb2coYPCflLQgUmVkIG1vdGlvbiBwYXJhbXMgdXBkYXRlZDpgLCByZWRNb3Rpb25QYXJhbXMpO1xuICAgIH0sXG5cbiAgICB1cGRhdGVSZWRNb3Rpb25QYXJhbTogPEsgZXh0ZW5kcyBrZXlvZiBNb3Rpb25UZXN0UGFyYW1zPihcbiAgICAgIHBhcmFtOiBLLFxuICAgICAgdmFsdWU6IE1vdGlvblRlc3RQYXJhbXNbS11cbiAgICApID0+IHtcbiAgICAgIHJlZE1vdGlvblBhcmFtc1twYXJhbV0gPSB2YWx1ZTtcbiAgICB9LFxuXG4gICAgLy8gQW5pbWF0aW9uIGNvbnRyb2wgbWV0aG9kc1xuICAgIHNldFByb2dyZXNzOiAocHJvZ3Jlc3M6IG51bWJlcikgPT4ge1xuICAgICAgYW5pbWF0aW9uU2VydmljZS5zZXRQcm9ncmVzcyhwcm9ncmVzcyk7XG4gICAgfSxcblxuICAgIHN0YXJ0QW5pbWF0aW9uOiAoKSA9PiB7XG4gICAgICBhbmltYXRpb25TZXJ2aWNlLnN0YXJ0QW5pbWF0aW9uKCk7XG4gICAgfSxcblxuICAgIHN0b3BBbmltYXRpb246ICgpID0+IHtcbiAgICAgIGFuaW1hdGlvblNlcnZpY2Uuc3RvcEFuaW1hdGlvbigpO1xuICAgIH0sXG5cbiAgICByZXNldEFuaW1hdGlvbjogKCkgPT4ge1xuICAgICAgYW5pbWF0aW9uU2VydmljZS5yZXNldEFuaW1hdGlvbigpO1xuICAgIH0sXG5cbiAgICAvLyBHcmlkIGNvbnRyb2wgbWV0aG9kc1xuICAgIHNldEdyaWRUeXBlOiAobmV3R3JpZFR5cGU6IFwiZGlhbW9uZFwiIHwgXCJib3hcIikgPT4ge1xuICAgICAgZ3JpZFR5cGUgPSBuZXdHcmlkVHlwZTtcbiAgICB9LFxuICB9O1xufVxuIl0sImZpbGUiOiJGOi9DT0RFL1RLQS93ZWIvc3JjL3JvdXRlcy9tb3Rpb24tdGVzdGVyL3N0YXRlL21vdGlvbi10ZXN0ZXItc3RhdGUuc3ZlbHRlLnRzIn0=