/* browse-tab-state-manager.svelte.ts generated by Svelte v5.38.1 */
import * as $ from "/node_modules/.vite/deps/svelte_internal_client.js?v=de368f3a";
import { browser } from "/node_modules/@sveltejs/kit/src/runtime/app/environment/index.js?v=de368f3a";
import { SortMethod } from "/src/lib/domain/browse/index.ts";
import { getBrowseStatePersistence } from "/src/lib/state/appState.svelte.ts";

export class BrowseTabStateManager {
	persistenceService = getBrowseStatePersistence();
	saveTimeout = null;
	SAVE_DEBOUNCE_MS = 500;

	// Debounce saves to avoid excessive localStorage writes
	// ============================================================================
	// STATE PERSISTENCE
	// ============================================================================
	/**
	 * Save complete browse state
	 */
	async saveState(state) {
		if (!browser) return;

		if (this.saveTimeout) {
			clearTimeout(this.saveTimeout);
		}

		this.saveTimeout = window.setTimeout(
			async () => {
				try {
					(await $.track_reactivity_loss(this.persistenceService.saveBrowseState(state)))();
					console.log("üíæ Browse state saved successfully");
				} catch(error) {
					console.error(...$.log_if_contains_state('error', "‚ùå Failed to save browse state:", error));
				}
			},
			this.SAVE_DEBOUNCE_MS
		);
	}

	/**
	 * Load complete browse state
	 */
	async loadState() {
		if (!browser) return null;

		try {
			const state = (await $.track_reactivity_loss(this.persistenceService.loadBrowseState()))();

			if (state) {
				console.log("üìñ Browse state loaded successfully");

				return state;
			}
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "‚ùå Failed to load browse state:", error));
		}

		return null;
	}

	/**
	 * Get default state when no saved state exists
	 */
	getDefaultState() {
		return this.persistenceService.createDefaultBrowseState();
	}

	// ============================================================================
	// INDIVIDUAL STATE COMPONENT HELPERS
	// ============================================================================
	/**
	 * Save filter state
	 */
	async saveFilterState(type, value) {
		if (!browser) return;

		const filterState = { type, value, appliedAt: /* @__PURE__ */ new Date() };

		try {
			(await $.track_reactivity_loss(this.persistenceService.saveFilterState(filterState)))();
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "‚ùå Failed to save filter state:", error));
		}
	}

	/**
	 * Save sort state
	 */
	async saveSortState(method) {
		if (!browser) return;

		const sortState = {
			method: this.mapSortMethodToString(method),
			direction: "asc",

			// Default direction
			appliedAt: /* @__PURE__ */ new Date()
		};

		try {
			(await $.track_reactivity_loss(this.persistenceService.saveSortState(sortState)))();
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "‚ùå Failed to save sort state:", error));
		}
	}

	/**
	 * Save view state
	 */
	async saveViewState(mode, gridColumns) {
		if (!browser) return;

		const viewState = { mode, gridColumns, thumbnailSize: "medium"

		// Default size
		 };

		try {
			(await $.track_reactivity_loss(this.persistenceService.saveViewState(viewState)))();
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "‚ùå Failed to save view state:", error));
		}
	}

	/**
	 * Save scroll state
	 */
	async saveScrollState(scrollTop, scrollLeft, containerHeight, containerWidth) {
		if (!browser) return;

		const scrollState = { scrollTop, scrollLeft, containerHeight, containerWidth };

		try {
			(await $.track_reactivity_loss(this.persistenceService.saveScrollState(scrollState)))();
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "‚ùå Failed to save scroll state:", error));
		}
	}

	/**
	 * Save selection state
	 */
	async saveSelectionState(selectedSequenceId, selectedVariationIndex) {
		if (!browser) return;

		const selectionState = {
			selectedSequenceId,
			selectedVariationIndex,
			lastSelectedAt: selectedSequenceId ? /* @__PURE__ */ new Date() : null
		};

		try {
			(await $.track_reactivity_loss(this.persistenceService.saveSelectionState(selectionState)))();
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "‚ùå Failed to save selection state:", error));
		}
	}

	// ============================================================================
	// STATE RESTORATION HELPERS
	// ============================================================================
	/**
	 * Restore scroll position to a container element
	 */
	restoreScrollPosition(container, scrollState) {
		if (!container || !scrollState) return;

		requestAnimationFrame(() => {
			try {
				container.scrollTop = scrollState.scrollTop;
				container.scrollLeft = scrollState.scrollLeft;
				console.log(`üìú Scroll position restored: ${scrollState.scrollTop}px`);
			} catch(error) {
				console.warn(...$.log_if_contains_state('warn', "‚ö†Ô∏è Failed to restore scroll position:", error));
			}
		});
	}

	/**
	 * Create a scroll state observer for automatic saving
	 */
	createScrollObserver(container) {
		if (!browser || !container) return () => {};

		let saveTimeout = null;

		const handleScroll = () => {
			if (saveTimeout) {
				clearTimeout(saveTimeout);
			}

			saveTimeout = window.setTimeout(
				() => {
					this.saveScrollState(container.scrollTop, container.scrollLeft, container.clientHeight, container.clientWidth);
				},
				this.SAVE_DEBOUNCE_MS
			);
		};

		container.addEventListener("scroll", handleScroll, { passive: true });

		return () => {
			container.removeEventListener("scroll", handleScroll);

			if (saveTimeout) {
				clearTimeout(saveTimeout);
			}
		};
	}

	// ============================================================================
	// UTILITY METHODS
	// ============================================================================
	/**
	 * Map SortMethod enum to string for persistence
	 */
	mapSortMethodToString(method) {
		switch (method) {
			case SortMethod.ALPHABETICAL:
				return "name_asc";

			case SortMethod.DIFFICULTY_LEVEL:
				return "difficulty";

			case SortMethod.SEQUENCE_LENGTH:
				return "length";

			case SortMethod.DATE_ADDED:
				return "recent";

			case SortMethod.AUTHOR:
				return "author";

			default:
				return "name_asc";
		}
	}

	/**
	 * Map string back to SortMethod enum
	 */
	mapStringToSortMethod(method) {
		switch (method) {
			case "name_asc":

			case "name_desc":
				return SortMethod.ALPHABETICAL;

			case "difficulty":
				return SortMethod.DIFFICULTY_LEVEL;

			case "length":
				return SortMethod.SEQUENCE_LENGTH;

			case "recent":
				return SortMethod.DATE_ADDED;

			case "author":
				return SortMethod.AUTHOR;

			default:
				return SortMethod.ALPHABETICAL;
		}
	}

	/**
	 * Clear all browse state
	 */
	async clearState() {
		if (!browser) return;

		try {
			(await $.track_reactivity_loss(this.persistenceService.clearBrowseState()))();
			console.log("üóëÔ∏è Browse state cleared successfully");
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "‚ùå Failed to clear browse state:", error));
		}
	}
}

let browseTabStateManager = null;

export function getBrowseTabStateManager() {
	if (!browseTabStateManager) {
		browseTabStateManager = new BrowseTabStateManager();
	}

	return browseTabStateManager;
}
//# sourceMappingURL=data:application/json;base64,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R0FDWCxVQUFVLG9CQUFvQixVQUFVLFlBQVk7O09BQ2hELGFBQWE7SUFDZixhQUFhLFdBQVc7R0FDMUI7RUFDRjtDQUNGOzs7Ozs7OztDQVNRLHNCQUNOLFFBQzBFO1VBQ2xFO1FBQ0QsV0FBVztXQUNQOztRQUNKLFdBQVc7V0FDUDs7UUFDSixXQUFXO1dBQ1A7O1FBQ0osV0FBVztXQUNQOztRQUNKLFdBQVc7V0FDUDs7O1dBRUE7O0NBRWI7Ozs7O0NBS0Esc0JBQXNCLFFBQTRCO1VBQ3hDO1FBQ0Q7O1FBQ0E7V0FDSSxXQUFXOztRQUNmO1dBQ0ksV0FBVzs7UUFDZjtXQUNJLFdBQVc7O1FBQ2Y7V0FDSSxXQUFXOztRQUNmO1dBQ0ksV0FBVzs7O1dBRVgsV0FBVzs7Q0FFeEI7Ozs7O09BS00sYUFBNEI7T0FDM0I7O01BRUQ7a0NBQ0ksS0FBSyxtQkFBbUI7R0FDOUIsUUFBUSxJQUFJLHVDQUF1QztFQUNyRCxRQUFTLE9BQU87R0FDZCxRQUFRLDBDQUFNLG1DQUFtQyxLQUFLO0VBQ3hEO0NBQ0Y7QUFDRjs7SUFNSSx3QkFBc0Q7O2dCQUsxQywyQkFBa0Q7TUFDM0QsdUJBQXVCO0VBQzFCLDRCQUE0QjtDQUM5Qjs7UUFDTztBQUNUIiwibmFtZXMiOltdLCJpZ25vcmVMaXN0IjpbXSwic291cmNlcyI6WyJicm93c2UtdGFiLXN0YXRlLW1hbmFnZXIuc3ZlbHRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQnJvd3NlIFRhYiBTdGF0ZSBNYW5hZ2VyXG4gKlxuICogTWFuYWdlcyBjb21wcmVoZW5zaXZlIHN0YXRlIHBlcnNpc3RlbmNlIGZvciB0aGUgQnJvd3NlIHRhYiBpbmNsdWRpbmc6XG4gKiAtIEZpbHRlciBzdGF0ZSBtZW1vcnlcbiAqIC0gU29ydCBzdGF0ZSBtZW1vcnlcbiAqIC0gU2Nyb2xsIHBvc2l0aW9uIG1lbW9yeVxuICogLSBWaWV3IG1vZGUgbWVtb3J5XG4gKiAtIFNlbGVjdGVkIHNlcXVlbmNlIG1lbW9yeVxuICpcbiAqIEludGVncmF0ZXMgd2l0aCBCcm93c2VTdGF0ZVBlcnNpc3RlbmNlU2VydmljZSBmb3IgY3Jvc3Mtc2Vzc2lvbiBwZXJzaXN0ZW5jZS5cbiAqL1xuXG5pbXBvcnQgeyBicm93c2VyIH0gZnJvbSBcIiRhcHAvZW52aXJvbm1lbnRcIjtcbi8vIGltcG9ydCB0eXBlIHsgQnJvd3NlU2VxdWVuY2VNZXRhZGF0YSB9IGZyb20gXCIkbGliL2RvbWFpbi9icm93c2VcIjtcbmltcG9ydCB7IFNvcnRNZXRob2QgfSBmcm9tIFwiJGxpYi9kb21haW4vYnJvd3NlXCI7XG5pbXBvcnQgeyBnZXRCcm93c2VTdGF0ZVBlcnNpc3RlbmNlIH0gZnJvbSBcIi4vYXBwU3RhdGUuc3ZlbHRlXCI7XG5pbXBvcnQgdHlwZSB7XG4gIEJyb3dzZUZpbHRlclN0YXRlLFxuICBCcm93c2VTY3JvbGxTdGF0ZSxcbiAgQnJvd3NlU2VsZWN0aW9uU3RhdGUsXG4gIEJyb3dzZVNvcnRTdGF0ZSxcbiAgQnJvd3NlVmlld1N0YXRlLFxuICBDb21wbGV0ZUJyb3dzZVN0YXRlLFxufSBmcm9tIFwiLi4vc2VydmljZXMvaW1wbGVtZW50YXRpb25zL2Jyb3dzZS9Ccm93c2VTdGF0ZVBlcnNpc3RlbmNlU2VydmljZVwiO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBCUk9XU0UgVEFCIFNUQVRFIE1BTkFHRVJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGNsYXNzIEJyb3dzZVRhYlN0YXRlTWFuYWdlciB7XG4gIHByaXZhdGUgcGVyc2lzdGVuY2VTZXJ2aWNlID0gZ2V0QnJvd3NlU3RhdGVQZXJzaXN0ZW5jZSgpO1xuICBwcml2YXRlIHNhdmVUaW1lb3V0OiBudW1iZXIgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSByZWFkb25seSBTQVZFX0RFQk9VTkNFX01TID0gNTAwOyAvLyBEZWJvdW5jZSBzYXZlcyB0byBhdm9pZCBleGNlc3NpdmUgbG9jYWxTdG9yYWdlIHdyaXRlc1xuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gU1RBVEUgUEVSU0lTVEVOQ0VcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIC8qKlxuICAgKiBTYXZlIGNvbXBsZXRlIGJyb3dzZSBzdGF0ZVxuICAgKi9cbiAgYXN5bmMgc2F2ZVN0YXRlKHN0YXRlOiBDb21wbGV0ZUJyb3dzZVN0YXRlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFicm93c2VyKSByZXR1cm47XG5cbiAgICAvLyBEZWJvdW5jZSBzYXZlcyB0byBhdm9pZCBleGNlc3NpdmUgbG9jYWxTdG9yYWdlIHdyaXRlc1xuICAgIGlmICh0aGlzLnNhdmVUaW1lb3V0KSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5zYXZlVGltZW91dCk7XG4gICAgfVxuXG4gICAgdGhpcy5zYXZlVGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucGVyc2lzdGVuY2VTZXJ2aWNlLnNhdmVCcm93c2VTdGF0ZShzdGF0ZSk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwi8J+SviBCcm93c2Ugc3RhdGUgc2F2ZWQgc3VjY2Vzc2Z1bGx5XCIpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIuKdjCBGYWlsZWQgdG8gc2F2ZSBicm93c2Ugc3RhdGU6XCIsIGVycm9yKTtcbiAgICAgIH1cbiAgICB9LCB0aGlzLlNBVkVfREVCT1VOQ0VfTVMpO1xuICB9XG5cbiAgLyoqXG4gICAqIExvYWQgY29tcGxldGUgYnJvd3NlIHN0YXRlXG4gICAqL1xuICBhc3luYyBsb2FkU3RhdGUoKTogUHJvbWlzZTxDb21wbGV0ZUJyb3dzZVN0YXRlIHwgbnVsbD4ge1xuICAgIGlmICghYnJvd3NlcikgcmV0dXJuIG51bGw7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3RhdGUgPSBhd2FpdCB0aGlzLnBlcnNpc3RlbmNlU2VydmljZS5sb2FkQnJvd3NlU3RhdGUoKTtcbiAgICAgIGlmIChzdGF0ZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhcIvCfk5YgQnJvd3NlIHN0YXRlIGxvYWRlZCBzdWNjZXNzZnVsbHlcIik7XG4gICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIuKdjCBGYWlsZWQgdG8gbG9hZCBicm93c2Ugc3RhdGU6XCIsIGVycm9yKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZGVmYXVsdCBzdGF0ZSB3aGVuIG5vIHNhdmVkIHN0YXRlIGV4aXN0c1xuICAgKi9cbiAgZ2V0RGVmYXVsdFN0YXRlKCk6IENvbXBsZXRlQnJvd3NlU3RhdGUge1xuICAgIHJldHVybiB0aGlzLnBlcnNpc3RlbmNlU2VydmljZS5jcmVhdGVEZWZhdWx0QnJvd3NlU3RhdGUoKTtcbiAgfVxuXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgLy8gSU5ESVZJRFVBTCBTVEFURSBDT01QT05FTlQgSEVMUEVSU1xuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgLyoqXG4gICAqIFNhdmUgZmlsdGVyIHN0YXRlXG4gICAqL1xuICBhc3luYyBzYXZlRmlsdGVyU3RhdGUodHlwZTogc3RyaW5nIHwgbnVsbCwgdmFsdWU6IHVua25vd24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIWJyb3dzZXIpIHJldHVybjtcblxuICAgIGNvbnN0IGZpbHRlclN0YXRlOiBCcm93c2VGaWx0ZXJTdGF0ZSA9IHtcbiAgICAgIHR5cGUsXG4gICAgICB2YWx1ZSxcbiAgICAgIGFwcGxpZWRBdDogbmV3IERhdGUoKSxcbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMucGVyc2lzdGVuY2VTZXJ2aWNlLnNhdmVGaWx0ZXJTdGF0ZShmaWx0ZXJTdGF0ZSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCLinYwgRmFpbGVkIHRvIHNhdmUgZmlsdGVyIHN0YXRlOlwiLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNhdmUgc29ydCBzdGF0ZVxuICAgKi9cbiAgYXN5bmMgc2F2ZVNvcnRTdGF0ZShtZXRob2Q6IFNvcnRNZXRob2QpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIWJyb3dzZXIpIHJldHVybjtcblxuICAgIGNvbnN0IHNvcnRTdGF0ZTogQnJvd3NlU29ydFN0YXRlID0ge1xuICAgICAgbWV0aG9kOiB0aGlzLm1hcFNvcnRNZXRob2RUb1N0cmluZyhtZXRob2QpLFxuICAgICAgZGlyZWN0aW9uOiBcImFzY1wiLCAvLyBEZWZhdWx0IGRpcmVjdGlvblxuICAgICAgYXBwbGllZEF0OiBuZXcgRGF0ZSgpLFxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wZXJzaXN0ZW5jZVNlcnZpY2Uuc2F2ZVNvcnRTdGF0ZShzb3J0U3RhdGUpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwi4p2MIEZhaWxlZCB0byBzYXZlIHNvcnQgc3RhdGU6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2F2ZSB2aWV3IHN0YXRlXG4gICAqL1xuICBhc3luYyBzYXZlVmlld1N0YXRlKFxuICAgIG1vZGU6IFwiZ3JpZFwiIHwgXCJsaXN0XCIsXG4gICAgZ3JpZENvbHVtbnM/OiBudW1iZXJcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFicm93c2VyKSByZXR1cm47XG5cbiAgICBjb25zdCB2aWV3U3RhdGU6IEJyb3dzZVZpZXdTdGF0ZSA9IHtcbiAgICAgIG1vZGUsXG4gICAgICBncmlkQ29sdW1ucyxcbiAgICAgIHRodW1ibmFpbFNpemU6IFwibWVkaXVtXCIsIC8vIERlZmF1bHQgc2l6ZVxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wZXJzaXN0ZW5jZVNlcnZpY2Uuc2F2ZVZpZXdTdGF0ZSh2aWV3U3RhdGUpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwi4p2MIEZhaWxlZCB0byBzYXZlIHZpZXcgc3RhdGU6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2F2ZSBzY3JvbGwgc3RhdGVcbiAgICovXG4gIGFzeW5jIHNhdmVTY3JvbGxTdGF0ZShcbiAgICBzY3JvbGxUb3A6IG51bWJlcixcbiAgICBzY3JvbGxMZWZ0OiBudW1iZXIsXG4gICAgY29udGFpbmVySGVpZ2h0OiBudW1iZXIsXG4gICAgY29udGFpbmVyV2lkdGg6IG51bWJlclxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIWJyb3dzZXIpIHJldHVybjtcblxuICAgIGNvbnN0IHNjcm9sbFN0YXRlOiBCcm93c2VTY3JvbGxTdGF0ZSA9IHtcbiAgICAgIHNjcm9sbFRvcCxcbiAgICAgIHNjcm9sbExlZnQsXG4gICAgICBjb250YWluZXJIZWlnaHQsXG4gICAgICBjb250YWluZXJXaWR0aCxcbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMucGVyc2lzdGVuY2VTZXJ2aWNlLnNhdmVTY3JvbGxTdGF0ZShzY3JvbGxTdGF0ZSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCLinYwgRmFpbGVkIHRvIHNhdmUgc2Nyb2xsIHN0YXRlOlwiLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNhdmUgc2VsZWN0aW9uIHN0YXRlXG4gICAqL1xuICBhc3luYyBzYXZlU2VsZWN0aW9uU3RhdGUoXG4gICAgc2VsZWN0ZWRTZXF1ZW5jZUlkOiBzdHJpbmcgfCBudWxsLFxuICAgIHNlbGVjdGVkVmFyaWF0aW9uSW5kZXg6IG51bWJlciB8IG51bGxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFicm93c2VyKSByZXR1cm47XG5cbiAgICBjb25zdCBzZWxlY3Rpb25TdGF0ZTogQnJvd3NlU2VsZWN0aW9uU3RhdGUgPSB7XG4gICAgICBzZWxlY3RlZFNlcXVlbmNlSWQsXG4gICAgICBzZWxlY3RlZFZhcmlhdGlvbkluZGV4LFxuICAgICAgbGFzdFNlbGVjdGVkQXQ6IHNlbGVjdGVkU2VxdWVuY2VJZCA/IG5ldyBEYXRlKCkgOiBudWxsLFxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wZXJzaXN0ZW5jZVNlcnZpY2Uuc2F2ZVNlbGVjdGlvblN0YXRlKHNlbGVjdGlvblN0YXRlKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIuKdjCBGYWlsZWQgdG8gc2F2ZSBzZWxlY3Rpb24gc3RhdGU6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gIC8vIFNUQVRFIFJFU1RPUkFUSU9OIEhFTFBFUlNcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIC8qKlxuICAgKiBSZXN0b3JlIHNjcm9sbCBwb3NpdGlvbiB0byBhIGNvbnRhaW5lciBlbGVtZW50XG4gICAqL1xuICByZXN0b3JlU2Nyb2xsUG9zaXRpb24oXG4gICAgY29udGFpbmVyOiBIVE1MRWxlbWVudCxcbiAgICBzY3JvbGxTdGF0ZTogQnJvd3NlU2Nyb2xsU3RhdGVcbiAgKTogdm9pZCB7XG4gICAgaWYgKCFjb250YWluZXIgfHwgIXNjcm9sbFN0YXRlKSByZXR1cm47XG5cbiAgICAvLyBVc2UgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIHRvIGVuc3VyZSB0aGUgRE9NIGlzIHJlYWR5XG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnRhaW5lci5zY3JvbGxUb3AgPSBzY3JvbGxTdGF0ZS5zY3JvbGxUb3A7XG4gICAgICAgIGNvbnRhaW5lci5zY3JvbGxMZWZ0ID0gc2Nyb2xsU3RhdGUuc2Nyb2xsTGVmdDtcbiAgICAgICAgY29uc29sZS5sb2coYPCfk5wgU2Nyb2xsIHBvc2l0aW9uIHJlc3RvcmVkOiAke3Njcm9sbFN0YXRlLnNjcm9sbFRvcH1weGApO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS53YXJuKFwi4pqg77iPIEZhaWxlZCB0byByZXN0b3JlIHNjcm9sbCBwb3NpdGlvbjpcIiwgZXJyb3IpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIHNjcm9sbCBzdGF0ZSBvYnNlcnZlciBmb3IgYXV0b21hdGljIHNhdmluZ1xuICAgKi9cbiAgY3JlYXRlU2Nyb2xsT2JzZXJ2ZXIoY29udGFpbmVyOiBIVE1MRWxlbWVudCk6ICgpID0+IHZvaWQge1xuICAgIGlmICghYnJvd3NlciB8fCAhY29udGFpbmVyKSByZXR1cm4gKCkgPT4ge307XG5cbiAgICBsZXQgc2F2ZVRpbWVvdXQ6IG51bWJlciB8IG51bGwgPSBudWxsO1xuXG4gICAgY29uc3QgaGFuZGxlU2Nyb2xsID0gKCkgPT4ge1xuICAgICAgaWYgKHNhdmVUaW1lb3V0KSB7XG4gICAgICAgIGNsZWFyVGltZW91dChzYXZlVGltZW91dCk7XG4gICAgICB9XG5cbiAgICAgIHNhdmVUaW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLnNhdmVTY3JvbGxTdGF0ZShcbiAgICAgICAgICBjb250YWluZXIuc2Nyb2xsVG9wLFxuICAgICAgICAgIGNvbnRhaW5lci5zY3JvbGxMZWZ0LFxuICAgICAgICAgIGNvbnRhaW5lci5jbGllbnRIZWlnaHQsXG4gICAgICAgICAgY29udGFpbmVyLmNsaWVudFdpZHRoXG4gICAgICAgICk7XG4gICAgICB9LCB0aGlzLlNBVkVfREVCT1VOQ0VfTVMpO1xuICAgIH07XG5cbiAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcihcInNjcm9sbFwiLCBoYW5kbGVTY3JvbGwsIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcblxuICAgIC8vIFJldHVybiBjbGVhbnVwIGZ1bmN0aW9uXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKFwic2Nyb2xsXCIsIGhhbmRsZVNjcm9sbCk7XG4gICAgICBpZiAoc2F2ZVRpbWVvdXQpIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHNhdmVUaW1lb3V0KTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBVVElMSVRZIE1FVEhPRFNcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gIC8qKlxuICAgKiBNYXAgU29ydE1ldGhvZCBlbnVtIHRvIHN0cmluZyBmb3IgcGVyc2lzdGVuY2VcbiAgICovXG4gIHByaXZhdGUgbWFwU29ydE1ldGhvZFRvU3RyaW5nKFxuICAgIG1ldGhvZDogU29ydE1ldGhvZFxuICApOiBcIm5hbWVfYXNjXCIgfCBcIm5hbWVfZGVzY1wiIHwgXCJkaWZmaWN1bHR5XCIgfCBcImxlbmd0aFwiIHwgXCJyZWNlbnRcIiB8IFwiYXV0aG9yXCIge1xuICAgIHN3aXRjaCAobWV0aG9kKSB7XG4gICAgICBjYXNlIFNvcnRNZXRob2QuQUxQSEFCRVRJQ0FMOlxuICAgICAgICByZXR1cm4gXCJuYW1lX2FzY1wiO1xuICAgICAgY2FzZSBTb3J0TWV0aG9kLkRJRkZJQ1VMVFlfTEVWRUw6XG4gICAgICAgIHJldHVybiBcImRpZmZpY3VsdHlcIjtcbiAgICAgIGNhc2UgU29ydE1ldGhvZC5TRVFVRU5DRV9MRU5HVEg6XG4gICAgICAgIHJldHVybiBcImxlbmd0aFwiO1xuICAgICAgY2FzZSBTb3J0TWV0aG9kLkRBVEVfQURERUQ6XG4gICAgICAgIHJldHVybiBcInJlY2VudFwiO1xuICAgICAgY2FzZSBTb3J0TWV0aG9kLkFVVEhPUjpcbiAgICAgICAgcmV0dXJuIFwiYXV0aG9yXCI7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gXCJuYW1lX2FzY1wiO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBNYXAgc3RyaW5nIGJhY2sgdG8gU29ydE1ldGhvZCBlbnVtXG4gICAqL1xuICBtYXBTdHJpbmdUb1NvcnRNZXRob2QobWV0aG9kOiBzdHJpbmcpOiBTb3J0TWV0aG9kIHtcbiAgICBzd2l0Y2ggKG1ldGhvZCkge1xuICAgICAgY2FzZSBcIm5hbWVfYXNjXCI6XG4gICAgICBjYXNlIFwibmFtZV9kZXNjXCI6XG4gICAgICAgIHJldHVybiBTb3J0TWV0aG9kLkFMUEhBQkVUSUNBTDtcbiAgICAgIGNhc2UgXCJkaWZmaWN1bHR5XCI6XG4gICAgICAgIHJldHVybiBTb3J0TWV0aG9kLkRJRkZJQ1VMVFlfTEVWRUw7XG4gICAgICBjYXNlIFwibGVuZ3RoXCI6XG4gICAgICAgIHJldHVybiBTb3J0TWV0aG9kLlNFUVVFTkNFX0xFTkdUSDtcbiAgICAgIGNhc2UgXCJyZWNlbnRcIjpcbiAgICAgICAgcmV0dXJuIFNvcnRNZXRob2QuREFURV9BRERFRDtcbiAgICAgIGNhc2UgXCJhdXRob3JcIjpcbiAgICAgICAgcmV0dXJuIFNvcnRNZXRob2QuQVVUSE9SO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIFNvcnRNZXRob2QuQUxQSEFCRVRJQ0FMO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciBhbGwgYnJvd3NlIHN0YXRlXG4gICAqL1xuICBhc3luYyBjbGVhclN0YXRlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghYnJvd3NlcikgcmV0dXJuO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMucGVyc2lzdGVuY2VTZXJ2aWNlLmNsZWFyQnJvd3NlU3RhdGUoKTtcbiAgICAgIGNvbnNvbGUubG9nKFwi8J+Xke+4jyBCcm93c2Ugc3RhdGUgY2xlYXJlZCBzdWNjZXNzZnVsbHlcIik7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCLinYwgRmFpbGVkIHRvIGNsZWFyIGJyb3dzZSBzdGF0ZTpcIiwgZXJyb3IpO1xuICAgIH1cbiAgfVxufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBTSU5HTEVUT04gSU5TVEFOQ0Vcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxubGV0IGJyb3dzZVRhYlN0YXRlTWFuYWdlcjogQnJvd3NlVGFiU3RhdGVNYW5hZ2VyIHwgbnVsbCA9IG51bGw7XG5cbi8qKlxuICogR2V0IHRoZSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgQnJvd3NlVGFiU3RhdGVNYW5hZ2VyXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRCcm93c2VUYWJTdGF0ZU1hbmFnZXIoKTogQnJvd3NlVGFiU3RhdGVNYW5hZ2VyIHtcbiAgaWYgKCFicm93c2VUYWJTdGF0ZU1hbmFnZXIpIHtcbiAgICBicm93c2VUYWJTdGF0ZU1hbmFnZXIgPSBuZXcgQnJvd3NlVGFiU3RhdGVNYW5hZ2VyKCk7XG4gIH1cbiAgcmV0dXJuIGJyb3dzZVRhYlN0YXRlTWFuYWdlcjtcbn1cbiJdLCJmaWxlIjoiRjovQ09ERS9US0Evd2ViL3NyYy9saWIvc3RhdGUvYnJvd3NlLXRhYi1zdGF0ZS1tYW5hZ2VyLnN2ZWx0ZS50cyJ9