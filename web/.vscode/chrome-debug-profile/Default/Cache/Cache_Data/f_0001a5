export class DimensionCalculationService {
  // Base constants matching desktop application
  static BASE_MARGIN = 50;
  // Match desktop BASE_MARGIN
  /**
   * Determine additional heights for text areas
   * Exactly matches desktop HeightDeterminer.determine_additional_heights()
   */
  determineAdditionalHeights(options, beatCount, beatScale) {
    if (!this.validateDimensions(beatCount, beatScale, options)) {
      throw new Error(
        `Invalid dimension parameters: beatCount=${beatCount}, beatScale=${beatScale}`
      );
    }
    let additionalHeightTop = 0;
    let additionalHeightBottom = 0;
    if (beatCount === 0) {
      additionalHeightTop = 0;
      additionalHeightBottom = options.addUserInfo ? 55 : 0;
    } else if (beatCount === 1) {
      additionalHeightTop = options.addWord ? 150 : 0;
      additionalHeightBottom = options.addUserInfo ? 55 : 0;
    } else if (beatCount === 2) {
      additionalHeightTop = options.addWord ? 200 : 0;
      additionalHeightBottom = options.addUserInfo ? 75 : 0;
    } else {
      additionalHeightTop = options.addWord ? 300 : 0;
      additionalHeightBottom = options.addUserInfo ? 150 : 0;
    }
    const scaledTop = Math.floor(additionalHeightTop * beatScale);
    const scaledBottom = Math.floor(additionalHeightBottom * beatScale);
    return [scaledTop, scaledBottom];
  }
  /**
   * Calculate beat size with scaling
   * Matches desktop beat size calculation
   */
  calculateScaledBeatSize(baseSize, scale) {
    if (baseSize <= 0 || scale <= 0) {
      throw new Error(
        `Invalid size parameters: baseSize=${baseSize}, scale=${scale}`
      );
    }
    return Math.floor(baseSize * scale);
  }
  /**
   * Calculate margin with scaling
   * Matches desktop margin calculation
   */
  calculateScaledMargin(baseMargin, scale) {
    if (baseMargin < 0 || scale <= 0) {
      throw new Error(
        `Invalid margin parameters: baseMargin=${baseMargin}, scale=${scale}`
      );
    }
    return Math.floor(baseMargin * scale);
  }
  /**
   * Validate dimension parameters
   */
  validateDimensions(beatCount, beatScale, options) {
    if (beatCount < 0) {
      return false;
    }
    if (beatScale <= 0) {
      return false;
    }
    if (beatScale > 10) {
      return false;
    }
    if (!options) {
      return false;
    }
    if (typeof options.addWord !== "boolean" || typeof options.addUserInfo !== "boolean") {
      return false;
    }
    return true;
  }
  /**
   * Get base margin constant
   */
  static getBaseMargin() {
    return DimensionCalculationService.BASE_MARGIN;
  }
  /**
   * Calculate total additional height needed
   */
  calculateTotalAdditionalHeight(options, beatCount, beatScale) {
    const [top, bottom] = this.determineAdditionalHeights(
      options,
      beatCount,
      beatScale
    );
    return top + bottom;
  }
  /**
   * Calculate word area dimensions
   * Helper for text rendering service
   */
  calculateWordAreaDimensions(beatCount, beatScale, imageWidth) {
    let height = 0;
    if (beatCount === 0) {
      height = 0;
    } else if (beatCount === 1) {
      height = 150 * beatScale;
    } else if (beatCount === 2) {
      height = 200 * beatScale;
    } else {
      height = 300 * beatScale;
    }
    return {
      width: imageWidth,
      height: Math.floor(height),
      available: height > 0
    };
  }
  /**
   * Calculate user info area dimensions
   * Helper for text rendering service
   */
  calculateUserInfoAreaDimensions(beatCount, beatScale, imageWidth) {
    let height = 0;
    if (beatCount === 0) {
      height = 55 * beatScale;
    } else if (beatCount === 1) {
      height = 55 * beatScale;
    } else if (beatCount === 2) {
      height = 75 * beatScale;
    } else {
      height = 150 * beatScale;
    }
    return {
      width: imageWidth,
      height: Math.floor(height),
      available: height > 0
    };
  }
  /**
   * Calculate difficulty badge area
   * Based on desktop implementation
   */
  calculateDifficultyBadgeArea(additionalHeightTop) {
    if (additionalHeightTop <= 0) {
      return { size: 0, inset: 0, available: false };
    }
    const size = Math.floor(additionalHeightTop * 0.75);
    const inset = Math.floor(additionalHeightTop / 8);
    return {
      size,
      inset,
      available: size > 0
    };
  }
  /**
   * Get text scaling factors based on beat count
   * Matches desktop FontMarginHelper patterns
   */
  getTextScalingFactors(beatCount) {
    if (beatCount <= 1) {
      return {
        fontScale: 1 / 2.3,
        marginScale: 1 / 3,
        description: "Small scaling for 0-1 beats"
      };
    } else if (beatCount === 2) {
      return {
        fontScale: 1 / 1.5,
        marginScale: 1 / 2,
        description: "Medium scaling for 2 beats"
      };
    } else {
      return {
        fontScale: 1,
        marginScale: 1,
        description: "Full scaling for 3+ beats"
      };
    }
  }
  /**
   * Calculate memory usage estimate for dimensions
   */
  estimateMemoryUsage(width, height, bytesPerPixel = 4) {
    return width * height * bytesPerPixel;
  }
  /**
   * Get recommended maximum dimensions to prevent memory issues
   */
  getMaximumRecommendedDimensions() {
    return {
      maxWidth: 16384,
      // 16K width
      maxHeight: 16384,
      // 16K height
      maxPixels: 268435456
      // 256 megapixels
    };
  }
  /**
   * Validate that dimensions won't cause memory issues
   */
  validateMemoryUsage(width, height) {
    const limits = this.getMaximumRecommendedDimensions();
    const totalPixels = width * height;
    const estimatedBytes = this.estimateMemoryUsage(width, height);
    const estimatedMB = estimatedBytes / (1024 * 1024);
    const safe = width <= limits.maxWidth && height <= limits.maxHeight && totalPixels <= limits.maxPixels;
    return { safe, estimatedMB };
  }
  /**
   * Debug method to test height calculations across beat count range
   */
  debugHeightCalculations(maxBeats = 10, beatScale = 1) {
    const results = [];
    const testOptions = {
      addWord: true,
      addUserInfo: true,
      // Other required properties with defaults
      includeStartPosition: true,
      addBeatNumbers: true,
      addReversalSymbols: true,
      combinedGrids: false,
      beatScale,
      beatSize: 144,
      margin: 50,
      redVisible: true,
      blueVisible: true,
      userName: "Test User",
      exportDate: "1-1-2024",
      notes: "Test",
      format: "PNG",
      quality: 1,
      addDifficultyLevel: false
    };
    for (let beatCount = 0; beatCount <= maxBeats; beatCount++) {
      const [topHeight, bottomHeight] = this.determineAdditionalHeights(
        testOptions,
        beatCount,
        beatScale
      );
      results.push({
        beatCount,
        topHeight,
        bottomHeight,
        totalHeight: topHeight + bottomHeight,
        wordArea: topHeight > 0,
        userInfoArea: bottomHeight > 0
      });
    }
    return results;
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkRpbWVuc2lvbkNhbGN1bGF0aW9uU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIERpbWVuc2lvbiBDYWxjdWxhdGlvbiBTZXJ2aWNlXG4gKlxuICogSGFuZGxlcyBpbWFnZSBkaW1lbnNpb24gY2FsY3VsYXRpb25zIHdpdGggZXhhY3QgY29tcGF0aWJpbGl0eSB0byB0aGUgZGVza3RvcFxuICogSGVpZ2h0RGV0ZXJtaW5lci4gVGhpcyBzZXJ2aWNlIGNhbGN1bGF0ZXMgYWRkaXRpb25hbCBoZWlnaHRzIG5lZWRlZCBmb3IgdGV4dFxuICogYXJlYXMgKHdvcmQgdGl0bGVzLCB1c2VyIGluZm8pIGJhc2VkIG9uIGJlYXQgY291bnQgYW5kIHNjYWxpbmcuXG4gKlxuICogQ3JpdGljYWw6IEFsbCBjYWxjdWxhdGlvbnMgbWF0Y2ggZGVza3RvcCBkZXRlcm1pbmVfYWRkaXRpb25hbF9oZWlnaHRzKCkgZXhhY3RseS5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7XG4gIElEaW1lbnNpb25DYWxjdWxhdGlvblNlcnZpY2UsXG4gIFRLQUltYWdlRXhwb3J0T3B0aW9ucyxcbn0gZnJvbSBcIi4uLy4uL2ludGVyZmFjZXMvaW1hZ2UtZXhwb3J0LWludGVyZmFjZXNcIjtcblxuZXhwb3J0IGNsYXNzIERpbWVuc2lvbkNhbGN1bGF0aW9uU2VydmljZVxuICBpbXBsZW1lbnRzIElEaW1lbnNpb25DYWxjdWxhdGlvblNlcnZpY2VcbntcbiAgLy8gQmFzZSBjb25zdGFudHMgbWF0Y2hpbmcgZGVza3RvcCBhcHBsaWNhdGlvblxuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBCQVNFX01BUkdJTiA9IDUwOyAvLyBNYXRjaCBkZXNrdG9wIEJBU0VfTUFSR0lOXG5cbiAgLyoqXG4gICAqIERldGVybWluZSBhZGRpdGlvbmFsIGhlaWdodHMgZm9yIHRleHQgYXJlYXNcbiAgICogRXhhY3RseSBtYXRjaGVzIGRlc2t0b3AgSGVpZ2h0RGV0ZXJtaW5lci5kZXRlcm1pbmVfYWRkaXRpb25hbF9oZWlnaHRzKClcbiAgICovXG4gIGRldGVybWluZUFkZGl0aW9uYWxIZWlnaHRzKFxuICAgIG9wdGlvbnM6IFRLQUltYWdlRXhwb3J0T3B0aW9ucyxcbiAgICBiZWF0Q291bnQ6IG51bWJlcixcbiAgICBiZWF0U2NhbGU6IG51bWJlclxuICApOiBbbnVtYmVyLCBudW1iZXJdIHtcbiAgICBpZiAoIXRoaXMudmFsaWRhdGVEaW1lbnNpb25zKGJlYXRDb3VudCwgYmVhdFNjYWxlLCBvcHRpb25zKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgSW52YWxpZCBkaW1lbnNpb24gcGFyYW1ldGVyczogYmVhdENvdW50PSR7YmVhdENvdW50fSwgYmVhdFNjYWxlPSR7YmVhdFNjYWxlfWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbGV0IGFkZGl0aW9uYWxIZWlnaHRUb3AgPSAwO1xuICAgIGxldCBhZGRpdGlvbmFsSGVpZ2h0Qm90dG9tID0gMDtcblxuICAgIC8vIE1hdGNoIGRlc2t0b3AgbG9naWMgZXhhY3RseSBiYXNlZCBvbiBiZWF0IGNvdW50XG4gICAgaWYgKGJlYXRDb3VudCA9PT0gMCkge1xuICAgICAgYWRkaXRpb25hbEhlaWdodFRvcCA9IDA7XG4gICAgICBhZGRpdGlvbmFsSGVpZ2h0Qm90dG9tID0gb3B0aW9ucy5hZGRVc2VySW5mbyA/IDU1IDogMDtcbiAgICB9IGVsc2UgaWYgKGJlYXRDb3VudCA9PT0gMSkge1xuICAgICAgYWRkaXRpb25hbEhlaWdodFRvcCA9IG9wdGlvbnMuYWRkV29yZCA/IDE1MCA6IDA7XG4gICAgICBhZGRpdGlvbmFsSGVpZ2h0Qm90dG9tID0gb3B0aW9ucy5hZGRVc2VySW5mbyA/IDU1IDogMDtcbiAgICB9IGVsc2UgaWYgKGJlYXRDb3VudCA9PT0gMikge1xuICAgICAgYWRkaXRpb25hbEhlaWdodFRvcCA9IG9wdGlvbnMuYWRkV29yZCA/IDIwMCA6IDA7XG4gICAgICBhZGRpdGlvbmFsSGVpZ2h0Qm90dG9tID0gb3B0aW9ucy5hZGRVc2VySW5mbyA/IDc1IDogMDtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gYmVhdENvdW50ID49IDNcbiAgICAgIGFkZGl0aW9uYWxIZWlnaHRUb3AgPSBvcHRpb25zLmFkZFdvcmQgPyAzMDAgOiAwO1xuICAgICAgYWRkaXRpb25hbEhlaWdodEJvdHRvbSA9IG9wdGlvbnMuYWRkVXNlckluZm8gPyAxNTAgOiAwO1xuICAgIH1cblxuICAgIC8vIEFwcGx5IGJlYXQgc2NhbGUgZXhhY3RseSBhcyBkZXNrdG9wIGRvZXNcbiAgICBjb25zdCBzY2FsZWRUb3AgPSBNYXRoLmZsb29yKGFkZGl0aW9uYWxIZWlnaHRUb3AgKiBiZWF0U2NhbGUpO1xuICAgIGNvbnN0IHNjYWxlZEJvdHRvbSA9IE1hdGguZmxvb3IoYWRkaXRpb25hbEhlaWdodEJvdHRvbSAqIGJlYXRTY2FsZSk7XG5cbiAgICByZXR1cm4gW3NjYWxlZFRvcCwgc2NhbGVkQm90dG9tXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgYmVhdCBzaXplIHdpdGggc2NhbGluZ1xuICAgKiBNYXRjaGVzIGRlc2t0b3AgYmVhdCBzaXplIGNhbGN1bGF0aW9uXG4gICAqL1xuICBjYWxjdWxhdGVTY2FsZWRCZWF0U2l6ZShiYXNlU2l6ZTogbnVtYmVyLCBzY2FsZTogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBpZiAoYmFzZVNpemUgPD0gMCB8fCBzY2FsZSA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBJbnZhbGlkIHNpemUgcGFyYW1ldGVyczogYmFzZVNpemU9JHtiYXNlU2l6ZX0sIHNjYWxlPSR7c2NhbGV9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gTWF0aC5mbG9vcihiYXNlU2l6ZSAqIHNjYWxlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgbWFyZ2luIHdpdGggc2NhbGluZ1xuICAgKiBNYXRjaGVzIGRlc2t0b3AgbWFyZ2luIGNhbGN1bGF0aW9uXG4gICAqL1xuICBjYWxjdWxhdGVTY2FsZWRNYXJnaW4oYmFzZU1hcmdpbjogbnVtYmVyLCBzY2FsZTogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBpZiAoYmFzZU1hcmdpbiA8IDAgfHwgc2NhbGUgPD0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgSW52YWxpZCBtYXJnaW4gcGFyYW1ldGVyczogYmFzZU1hcmdpbj0ke2Jhc2VNYXJnaW59LCBzY2FsZT0ke3NjYWxlfWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIE1hdGguZmxvb3IoYmFzZU1hcmdpbiAqIHNjYWxlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSBkaW1lbnNpb24gcGFyYW1ldGVyc1xuICAgKi9cbiAgdmFsaWRhdGVEaW1lbnNpb25zKFxuICAgIGJlYXRDb3VudDogbnVtYmVyLFxuICAgIGJlYXRTY2FsZTogbnVtYmVyLFxuICAgIG9wdGlvbnM6IFRLQUltYWdlRXhwb3J0T3B0aW9uc1xuICApOiBib29sZWFuIHtcbiAgICAvLyBCZWF0IGNvdW50IG11c3QgYmUgbm9uLW5lZ2F0aXZlXG4gICAgaWYgKGJlYXRDb3VudCA8IDApIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBCZWF0IHNjYWxlIG11c3QgYmUgcG9zaXRpdmVcbiAgICBpZiAoYmVhdFNjYWxlIDw9IDApIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBCZWF0IHNjYWxlIHNob3VsZCBiZSByZWFzb25hYmxlIHRvIHByZXZlbnQgbWVtb3J5IGlzc3Vlc1xuICAgIGlmIChiZWF0U2NhbGUgPiAxMCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIE9wdGlvbnMgbXVzdCBiZSBwcm92aWRlZFxuICAgIGlmICghb3B0aW9ucykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIFJlcXVpcmVkIGJvb2xlYW4gcHJvcGVydGllcyBtdXN0IGJlIGRlZmluZWRcbiAgICBpZiAoXG4gICAgICB0eXBlb2Ygb3B0aW9ucy5hZGRXb3JkICE9PSBcImJvb2xlYW5cIiB8fFxuICAgICAgdHlwZW9mIG9wdGlvbnMuYWRkVXNlckluZm8gIT09IFwiYm9vbGVhblwiXG4gICAgKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGJhc2UgbWFyZ2luIGNvbnN0YW50XG4gICAqL1xuICBzdGF0aWMgZ2V0QmFzZU1hcmdpbigpOiBudW1iZXIge1xuICAgIHJldHVybiBEaW1lbnNpb25DYWxjdWxhdGlvblNlcnZpY2UuQkFTRV9NQVJHSU47XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlIHRvdGFsIGFkZGl0aW9uYWwgaGVpZ2h0IG5lZWRlZFxuICAgKi9cbiAgY2FsY3VsYXRlVG90YWxBZGRpdGlvbmFsSGVpZ2h0KFxuICAgIG9wdGlvbnM6IFRLQUltYWdlRXhwb3J0T3B0aW9ucyxcbiAgICBiZWF0Q291bnQ6IG51bWJlcixcbiAgICBiZWF0U2NhbGU6IG51bWJlclxuICApOiBudW1iZXIge1xuICAgIGNvbnN0IFt0b3AsIGJvdHRvbV0gPSB0aGlzLmRldGVybWluZUFkZGl0aW9uYWxIZWlnaHRzKFxuICAgICAgb3B0aW9ucyxcbiAgICAgIGJlYXRDb3VudCxcbiAgICAgIGJlYXRTY2FsZVxuICAgICk7XG4gICAgcmV0dXJuIHRvcCArIGJvdHRvbTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgd29yZCBhcmVhIGRpbWVuc2lvbnNcbiAgICogSGVscGVyIGZvciB0ZXh0IHJlbmRlcmluZyBzZXJ2aWNlXG4gICAqL1xuICBjYWxjdWxhdGVXb3JkQXJlYURpbWVuc2lvbnMoXG4gICAgYmVhdENvdW50OiBudW1iZXIsXG4gICAgYmVhdFNjYWxlOiBudW1iZXIsXG4gICAgaW1hZ2VXaWR0aDogbnVtYmVyXG4gICk6IHsgd2lkdGg6IG51bWJlcjsgaGVpZ2h0OiBudW1iZXI7IGF2YWlsYWJsZTogYm9vbGVhbiB9IHtcbiAgICBsZXQgaGVpZ2h0ID0gMDtcblxuICAgIGlmIChiZWF0Q291bnQgPT09IDApIHtcbiAgICAgIGhlaWdodCA9IDA7XG4gICAgfSBlbHNlIGlmIChiZWF0Q291bnQgPT09IDEpIHtcbiAgICAgIGhlaWdodCA9IDE1MCAqIGJlYXRTY2FsZTtcbiAgICB9IGVsc2UgaWYgKGJlYXRDb3VudCA9PT0gMikge1xuICAgICAgaGVpZ2h0ID0gMjAwICogYmVhdFNjYWxlO1xuICAgIH0gZWxzZSB7XG4gICAgICBoZWlnaHQgPSAzMDAgKiBiZWF0U2NhbGU7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHdpZHRoOiBpbWFnZVdpZHRoLFxuICAgICAgaGVpZ2h0OiBNYXRoLmZsb29yKGhlaWdodCksXG4gICAgICBhdmFpbGFibGU6IGhlaWdodCA+IDAsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgdXNlciBpbmZvIGFyZWEgZGltZW5zaW9uc1xuICAgKiBIZWxwZXIgZm9yIHRleHQgcmVuZGVyaW5nIHNlcnZpY2VcbiAgICovXG4gIGNhbGN1bGF0ZVVzZXJJbmZvQXJlYURpbWVuc2lvbnMoXG4gICAgYmVhdENvdW50OiBudW1iZXIsXG4gICAgYmVhdFNjYWxlOiBudW1iZXIsXG4gICAgaW1hZ2VXaWR0aDogbnVtYmVyXG4gICk6IHsgd2lkdGg6IG51bWJlcjsgaGVpZ2h0OiBudW1iZXI7IGF2YWlsYWJsZTogYm9vbGVhbiB9IHtcbiAgICBsZXQgaGVpZ2h0ID0gMDtcblxuICAgIGlmIChiZWF0Q291bnQgPT09IDApIHtcbiAgICAgIGhlaWdodCA9IDU1ICogYmVhdFNjYWxlO1xuICAgIH0gZWxzZSBpZiAoYmVhdENvdW50ID09PSAxKSB7XG4gICAgICBoZWlnaHQgPSA1NSAqIGJlYXRTY2FsZTtcbiAgICB9IGVsc2UgaWYgKGJlYXRDb3VudCA9PT0gMikge1xuICAgICAgaGVpZ2h0ID0gNzUgKiBiZWF0U2NhbGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGhlaWdodCA9IDE1MCAqIGJlYXRTY2FsZTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgd2lkdGg6IGltYWdlV2lkdGgsXG4gICAgICBoZWlnaHQ6IE1hdGguZmxvb3IoaGVpZ2h0KSxcbiAgICAgIGF2YWlsYWJsZTogaGVpZ2h0ID4gMCxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSBkaWZmaWN1bHR5IGJhZGdlIGFyZWFcbiAgICogQmFzZWQgb24gZGVza3RvcCBpbXBsZW1lbnRhdGlvblxuICAgKi9cbiAgY2FsY3VsYXRlRGlmZmljdWx0eUJhZGdlQXJlYShhZGRpdGlvbmFsSGVpZ2h0VG9wOiBudW1iZXIpOiB7XG4gICAgc2l6ZTogbnVtYmVyO1xuICAgIGluc2V0OiBudW1iZXI7XG4gICAgYXZhaWxhYmxlOiBib29sZWFuO1xuICB9IHtcbiAgICBpZiAoYWRkaXRpb25hbEhlaWdodFRvcCA8PSAwKSB7XG4gICAgICByZXR1cm4geyBzaXplOiAwLCBpbnNldDogMCwgYXZhaWxhYmxlOiBmYWxzZSB9O1xuICAgIH1cblxuICAgIC8vIE1hdGNoIGRlc2t0b3AgY2FsY3VsYXRpb24gZXhhY3RseVxuICAgIGNvbnN0IHNpemUgPSBNYXRoLmZsb29yKGFkZGl0aW9uYWxIZWlnaHRUb3AgKiAwLjc1KTtcbiAgICBjb25zdCBpbnNldCA9IE1hdGguZmxvb3IoYWRkaXRpb25hbEhlaWdodFRvcCAvIDgpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHNpemUsXG4gICAgICBpbnNldCxcbiAgICAgIGF2YWlsYWJsZTogc2l6ZSA+IDAsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGV4dCBzY2FsaW5nIGZhY3RvcnMgYmFzZWQgb24gYmVhdCBjb3VudFxuICAgKiBNYXRjaGVzIGRlc2t0b3AgRm9udE1hcmdpbkhlbHBlciBwYXR0ZXJuc1xuICAgKi9cbiAgZ2V0VGV4dFNjYWxpbmdGYWN0b3JzKGJlYXRDb3VudDogbnVtYmVyKToge1xuICAgIGZvbnRTY2FsZTogbnVtYmVyO1xuICAgIG1hcmdpblNjYWxlOiBudW1iZXI7XG4gICAgZGVzY3JpcHRpb246IHN0cmluZztcbiAgfSB7XG4gICAgaWYgKGJlYXRDb3VudCA8PSAxKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBmb250U2NhbGU6IDEgLyAyLjMsXG4gICAgICAgIG1hcmdpblNjYWxlOiAxIC8gMyxcbiAgICAgICAgZGVzY3JpcHRpb246IFwiU21hbGwgc2NhbGluZyBmb3IgMC0xIGJlYXRzXCIsXG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAoYmVhdENvdW50ID09PSAyKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBmb250U2NhbGU6IDEgLyAxLjUsXG4gICAgICAgIG1hcmdpblNjYWxlOiAxIC8gMixcbiAgICAgICAgZGVzY3JpcHRpb246IFwiTWVkaXVtIHNjYWxpbmcgZm9yIDIgYmVhdHNcIixcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGZvbnRTY2FsZTogMS4wLFxuICAgICAgICBtYXJnaW5TY2FsZTogMS4wLFxuICAgICAgICBkZXNjcmlwdGlvbjogXCJGdWxsIHNjYWxpbmcgZm9yIDMrIGJlYXRzXCIsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgbWVtb3J5IHVzYWdlIGVzdGltYXRlIGZvciBkaW1lbnNpb25zXG4gICAqL1xuICBlc3RpbWF0ZU1lbW9yeVVzYWdlKFxuICAgIHdpZHRoOiBudW1iZXIsXG4gICAgaGVpZ2h0OiBudW1iZXIsXG4gICAgYnl0ZXNQZXJQaXhlbDogbnVtYmVyID0gNFxuICApOiBudW1iZXIge1xuICAgIHJldHVybiB3aWR0aCAqIGhlaWdodCAqIGJ5dGVzUGVyUGl4ZWw7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHJlY29tbWVuZGVkIG1heGltdW0gZGltZW5zaW9ucyB0byBwcmV2ZW50IG1lbW9yeSBpc3N1ZXNcbiAgICovXG4gIGdldE1heGltdW1SZWNvbW1lbmRlZERpbWVuc2lvbnMoKToge1xuICAgIG1heFdpZHRoOiBudW1iZXI7XG4gICAgbWF4SGVpZ2h0OiBudW1iZXI7XG4gICAgbWF4UGl4ZWxzOiBudW1iZXI7XG4gIH0ge1xuICAgIC8vIENvbnNlcnZhdGl2ZSBsaW1pdHMgZm9yIHdlYiBicm93c2Vyc1xuICAgIHJldHVybiB7XG4gICAgICBtYXhXaWR0aDogMTYzODQsIC8vIDE2SyB3aWR0aFxuICAgICAgbWF4SGVpZ2h0OiAxNjM4NCwgLy8gMTZLIGhlaWdodFxuICAgICAgbWF4UGl4ZWxzOiAyNjg0MzU0NTYsIC8vIDI1NiBtZWdhcGl4ZWxzXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSB0aGF0IGRpbWVuc2lvbnMgd29uJ3QgY2F1c2UgbWVtb3J5IGlzc3Vlc1xuICAgKi9cbiAgdmFsaWRhdGVNZW1vcnlVc2FnZShcbiAgICB3aWR0aDogbnVtYmVyLFxuICAgIGhlaWdodDogbnVtYmVyXG4gICk6IHsgc2FmZTogYm9vbGVhbjsgZXN0aW1hdGVkTUI6IG51bWJlciB9IHtcbiAgICBjb25zdCBsaW1pdHMgPSB0aGlzLmdldE1heGltdW1SZWNvbW1lbmRlZERpbWVuc2lvbnMoKTtcbiAgICBjb25zdCB0b3RhbFBpeGVscyA9IHdpZHRoICogaGVpZ2h0O1xuICAgIGNvbnN0IGVzdGltYXRlZEJ5dGVzID0gdGhpcy5lc3RpbWF0ZU1lbW9yeVVzYWdlKHdpZHRoLCBoZWlnaHQpO1xuICAgIGNvbnN0IGVzdGltYXRlZE1CID0gZXN0aW1hdGVkQnl0ZXMgLyAoMTAyNCAqIDEwMjQpO1xuXG4gICAgY29uc3Qgc2FmZSA9XG4gICAgICB3aWR0aCA8PSBsaW1pdHMubWF4V2lkdGggJiZcbiAgICAgIGhlaWdodCA8PSBsaW1pdHMubWF4SGVpZ2h0ICYmXG4gICAgICB0b3RhbFBpeGVscyA8PSBsaW1pdHMubWF4UGl4ZWxzO1xuXG4gICAgcmV0dXJuIHsgc2FmZSwgZXN0aW1hdGVkTUIgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWJ1ZyBtZXRob2QgdG8gdGVzdCBoZWlnaHQgY2FsY3VsYXRpb25zIGFjcm9zcyBiZWF0IGNvdW50IHJhbmdlXG4gICAqL1xuICBkZWJ1Z0hlaWdodENhbGN1bGF0aW9ucyhcbiAgICBtYXhCZWF0czogbnVtYmVyID0gMTAsXG4gICAgYmVhdFNjYWxlOiBudW1iZXIgPSAxXG4gICk6IEFycmF5PHtcbiAgICBiZWF0Q291bnQ6IG51bWJlcjtcbiAgICB0b3BIZWlnaHQ6IG51bWJlcjtcbiAgICBib3R0b21IZWlnaHQ6IG51bWJlcjtcbiAgICB0b3RhbEhlaWdodDogbnVtYmVyO1xuICAgIHdvcmRBcmVhOiBib29sZWFuO1xuICAgIHVzZXJJbmZvQXJlYTogYm9vbGVhbjtcbiAgfT4ge1xuICAgIGNvbnN0IHJlc3VsdHMgPSBbXTtcblxuICAgIGNvbnN0IHRlc3RPcHRpb25zOiBUS0FJbWFnZUV4cG9ydE9wdGlvbnMgPSB7XG4gICAgICBhZGRXb3JkOiB0cnVlLFxuICAgICAgYWRkVXNlckluZm86IHRydWUsXG4gICAgICAvLyBPdGhlciByZXF1aXJlZCBwcm9wZXJ0aWVzIHdpdGggZGVmYXVsdHNcbiAgICAgIGluY2x1ZGVTdGFydFBvc2l0aW9uOiB0cnVlLFxuICAgICAgYWRkQmVhdE51bWJlcnM6IHRydWUsXG4gICAgICBhZGRSZXZlcnNhbFN5bWJvbHM6IHRydWUsXG4gICAgICBjb21iaW5lZEdyaWRzOiBmYWxzZSxcbiAgICAgIGJlYXRTY2FsZTogYmVhdFNjYWxlLFxuICAgICAgYmVhdFNpemU6IDE0NCxcbiAgICAgIG1hcmdpbjogNTAsXG4gICAgICByZWRWaXNpYmxlOiB0cnVlLFxuICAgICAgYmx1ZVZpc2libGU6IHRydWUsXG4gICAgICB1c2VyTmFtZTogXCJUZXN0IFVzZXJcIixcbiAgICAgIGV4cG9ydERhdGU6IFwiMS0xLTIwMjRcIixcbiAgICAgIG5vdGVzOiBcIlRlc3RcIixcbiAgICAgIGZvcm1hdDogXCJQTkdcIixcbiAgICAgIHF1YWxpdHk6IDEuMCxcbiAgICAgIGFkZERpZmZpY3VsdHlMZXZlbDogZmFsc2UsXG4gICAgfTtcblxuICAgIGZvciAobGV0IGJlYXRDb3VudCA9IDA7IGJlYXRDb3VudCA8PSBtYXhCZWF0czsgYmVhdENvdW50KyspIHtcbiAgICAgIGNvbnN0IFt0b3BIZWlnaHQsIGJvdHRvbUhlaWdodF0gPSB0aGlzLmRldGVybWluZUFkZGl0aW9uYWxIZWlnaHRzKFxuICAgICAgICB0ZXN0T3B0aW9ucyxcbiAgICAgICAgYmVhdENvdW50LFxuICAgICAgICBiZWF0U2NhbGVcbiAgICAgICk7XG5cbiAgICAgIHJlc3VsdHMucHVzaCh7XG4gICAgICAgIGJlYXRDb3VudCxcbiAgICAgICAgdG9wSGVpZ2h0LFxuICAgICAgICBib3R0b21IZWlnaHQsXG4gICAgICAgIHRvdGFsSGVpZ2h0OiB0b3BIZWlnaHQgKyBib3R0b21IZWlnaHQsXG4gICAgICAgIHdvcmRBcmVhOiB0b3BIZWlnaHQgPiAwLFxuICAgICAgICB1c2VySW5mb0FyZWE6IGJvdHRvbUhlaWdodCA+IDAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0cztcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiQUFlTyxhQUFNLDRCQUViO0FBQUE7QUFBQSxFQUVFLE9BQXdCLGNBQWM7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFNdEMsMkJBQ0UsU0FDQSxXQUNBLFdBQ2tCO0FBQ2xCLFFBQUksQ0FBQyxLQUFLLG1CQUFtQixXQUFXLFdBQVcsT0FBTyxHQUFHO0FBQzNELFlBQU0sSUFBSTtBQUFBLFFBQ1IsMkNBQTJDLFNBQVMsZUFBZSxTQUFTO0FBQUEsTUFDOUU7QUFBQSxJQUNGO0FBRUEsUUFBSSxzQkFBc0I7QUFDMUIsUUFBSSx5QkFBeUI7QUFHN0IsUUFBSSxjQUFjLEdBQUc7QUFDbkIsNEJBQXNCO0FBQ3RCLCtCQUF5QixRQUFRLGNBQWMsS0FBSztBQUFBLElBQ3RELFdBQVcsY0FBYyxHQUFHO0FBQzFCLDRCQUFzQixRQUFRLFVBQVUsTUFBTTtBQUM5QywrQkFBeUIsUUFBUSxjQUFjLEtB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