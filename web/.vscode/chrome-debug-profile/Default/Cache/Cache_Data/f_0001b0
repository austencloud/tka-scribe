import { createSequenceData } from "/src/lib/domain/index.ts";
import { GridMode } from "/src/lib/domain/index.ts";
import { createMotionData } from "/src/lib/domain/MotionData.ts";
import {
  MotionType,
  RotationDirection,
  Location,
  Orientation,
  DifficultyLevel,
  PropContinuity,
  GenerationMode
} from "/src/lib/domain/enums.ts";
const ROTATION_DIRS = {
  CLOCKWISE: RotationDirection.CLOCKWISE,
  COUNTER_CLOCKWISE: RotationDirection.COUNTER_CLOCKWISE,
  noRotation: RotationDirection.NO_ROTATION
};
const MOTION_TYPES = {
  PRO: MotionType.PRO,
  ANTI: MotionType.ANTI,
  FLOAT: MotionType.FLOAT,
  DASH: MotionType.DASH,
  STATIC: MotionType.STATIC
};
export class SequenceGenerationService {
  constructor(letterQueryService, orientationCalculationService) {
    this.letterQueryService = letterQueryService;
    this.orientationCalculationService = orientationCalculationService;
  }
  /**
   * Generate freeform sequence - exact port of legacy build_sequence()
   */
  async generateSequence(options) {
    try {
      console.log("ðŸŽ¯ Starting freeform generation with options:", options);
      const sequence = [];
      let blueRotationDirection;
      let redRotationDirection;
      if (options.propContinuity === PropContinuity.CONTINUOUS) {
        blueRotationDirection = this.randomChoice([
          ROTATION_DIRS.CLOCKWISE,
          ROTATION_DIRS.COUNTER_CLOCKWISE
        ]);
        redRotationDirection = this.randomChoice([
          ROTATION_DIRS.CLOCKWISE,
          ROTATION_DIRS.COUNTER_CLOCKWISE
        ]);
      } else {
        blueRotationDirection = "";
        redRotationDirection = "";
      }
      console.log("ðŸ”„ Rotation directions:", {
        blueRotationDirection,
        redRotationDirection,
        propContinuity: options.propContinuity
      });
      const lengthOfSequenceUponStart = Math.max(0, sequence.length - 2);
      const beatsToGenerate = options.length - lengthOfSequenceUponStart;
      console.log(
        `ðŸ“Š Generating ${beatsToGenerate} beats (requested: ${options.length}, existing: ${lengthOfSequenceUponStart})`
      );
      if (beatsToGenerate <= 0) {
        throw new Error(
          "No beats to generate - sequence may already be complete"
        );
      }
      const level = this.mapDifficultyToLevel(options.difficulty);
      const turnIntensity = options.turnIntensity || 1;
      const totalTurns = Math.floor(turnIntensity * beatsToGenerate);
      const turnAllocation = {
        blue: Array(beatsToGenerate).fill(0).map((_, i) => i < totalTurns / 2 ? 1 : 0),
        red: Array(beatsToGenerate).fill(0).map((_, i) => i < totalTurns / 2 ? 1 : 0)
      };
      console.log("ðŸŽ² Turn allocation:", turnAllocation);
      const generatedBeats = [];
      for (let i = 0; i < beatsToGenerate; i++) {
        console.log(`âš¡ Generating beat ${i + 1}/${beatsToGenerate}`);
        try {
          const nextPictograph = await this._generateNextPictograph(
            sequence,
            level,
            turnAllocation.blue[i],
            turnAllocation.red[i],
            options.propContinuity || PropContinuity.CONTINUOUS,
            blueRotationDirection,
            redRotationDirection,
            options.letterTypes || ["Dual-Shift"]
            // Default to Type1 if not specified
          );
          sequence.push(nextPictograph);
          generatedBeats.push(nextPictograph);
          console.log(
            `âœ… Generated beat ${i + 1}: ${nextPictograph.pictographData?.letter}`
          );
        } catch (beatError) {
          console.error(`âŒ Failed to generate beat ${i + 1}:`, beatError);
          throw new Error(
            `Beat generation failed at position ${i + 1}: ${beatError instanceof Error ? beatError.message : "Unknown error"}`
          );
        }
      }
      const generatedSequence = createSequenceData({
        name: this.generateSequenceName(options),
        word: "",
        // Will be calculated from beats
        beats: generatedBeats,
        gridMode: options.gridMode,
        propType: options.propType,
        difficulty_level: options.difficulty,
        is_favorite: false,
        is_circular: false,
        tags: [],
        metadata: {
          generated: true,
          generatedAt: (/* @__PURE__ */ new Date()).toISOString(),
          algorithm: "freeform",
          beatsGenerated: generatedBeats.length,
          propContinuity: options.propContinuity,
          blueRotationDirection,
          redRotationDirection,
          turnIntensity,
          level
        }
      });
      console.log("ðŸŽ‰ Sequence generation complete:", {
        id: generatedSequence.id,
        beats: generatedBeats.length,
        name: generatedSequence.name
      });
      return generatedSequence;
    } catch (error) {
      console.error("âŒ Sequence generation failed:", error);
      throw new Error(
        `Sequence generation failed: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Generate next pictograph - exact port of legacy _generate_next_pictograph()
   */
  async _generateNextPictograph(sequence, level, turnBlue, turnRed, propContinuity, blueRotationDirection, redRotationDirection, _letterTypes) {
    try {
      const optionDicts = await this.letterQueryService.getAllCodexPictographs(
        GridMode.DIAMOND
      );
      console.log(`ðŸ“‹ Loaded ${optionDicts.length} option dicts`);
      if (optionDicts.length === 0) {
        throw new Error("No pictographs available from option service");
      }
      console.log(
        `ðŸ” Using all ${optionDicts.length} options (filtering not yet implemented)`
      );
      console.log(`ðŸ”„ Rotation filtering not yet implemented`);
      if (optionDicts.length === 0) {
        throw new Error("No valid options available after filtering");
      }
      const selectedOption = this.randomChoice(optionDicts);
      console.log(`ðŸŽ¯ Selected option: ${selectedOption.letter}`);
      let nextBeat = this.convertPictographToBeat(
        selectedOption,
        sequence.length + 1
      );
      if (level === 2 || level === 3) {
        this.setTurns(nextBeat, turnBlue, turnRed);
        console.log(`ðŸŽ² Set turns: blue=${turnBlue}, red=${turnRed}`);
      }
      if (sequence.length > 0) {
        nextBeat = this.orientationCalculationService.updateStartOrientations(
          nextBeat,
          sequence[sequence.length - 1]
        );
      }
      this.updateDashStaticRotationDirections(
        nextBeat,
        propContinuity,
        blueRotationDirection,
        redRotationDirection
      );
      nextBeat = this.orientationCalculationService.updateEndOrientations(nextBeat);
      console.log(`ðŸ§­ Updated orientations for beat ${nextBeat.beatNumber}`);
      return nextBeat;
    } catch (error) {
      console.error(`âŒ Failed to generate pictograph:`, error);
      throw error;
    }
  }
  /**
   * Convert PictographData to BeatData - creates proper domain object
   */
  convertPictographToBeat(pictograph, beatNumber) {
    const motions = {
      blue: pictograph.motions.blue || createMotionData({
        motionType: MotionType.STATIC,
        rotationDirection: RotationDirection.NO_ROTATION,
        startLocation: Location.NORTH,
        endLocation: Location.NORTH,
        turns: 0,
        startOrientation: Orientation.IN,
        endOrientation: Orientation.IN
      }),
      red: pictograph.motions.red || createMotionData({
        motionType: MotionType.STATIC,
        rotationDirection: RotationDirection.NO_ROTATION,
        startLocation: Location.NORTH,
        endLocation: Location.NORTH,
        turns: 0,
        startOrientation: Orientation.IN,
        endOrientation: Orientation.IN
      }),
      ...pictograph.motions
    };
    return {
      id: crypto.randomUUID(),
      beatNumber,
      duration: 1,
      blueReversal: false,
      redReversal: false,
      isBlank: false,
      pictographData: {
        ...pictograph,
        motions
      },
      metadata: {
        generated: true,
        generatedAt: (/* @__PURE__ */ new Date()).toISOString(),
        letter: pictograph.letter
      }
    };
  }
  /**
   * Set turns - exact port from legacy set_turns()
   */
  setTurns(beat, turnBlue, turnRed) {
    if (!beat.pictographData) return;
    if (turnBlue === "fl") {
      if (beat.pictographData.motions.blue?.motionType === MotionType.PRO || beat.pictographData.motions.blue?.motionType === MotionType.ANTI) {
        if (beat.pictographData.motions.blue) {
          beat.pictographData.motions.blue = {
            ...beat.pictographData.motions.blue,
            turns: "fl",
            prefloat_motion_type: beat.pictographData.motions.blue.motionType,
            prefloat_prop_rot_dir: beat.pictographData.motions.blue.rotationDirection,
            motionType: MotionType.FLOAT,
            rotationDirection: RotationDirection.NO_ROTATION
          };
        }
      } else {
        if (beat.pictographData.motions.blue) {
          beat.pictographData.motions.blue = {
            ...beat.pictographData.motions.blue,
            turns: 0
          };
        }
      }
    } else {
      if (beat.pictographData.motions.blue) {
        beat.pictographData.motions.blue = {
          ...beat.pictographData.motions.blue,
          turns: turnBlue
        };
      }
    }
    if (turnRed === "fl") {
      if (beat.pictographData.motions.red?.motionType === MotionType.PRO || beat.pictographData.motions.red?.motionType === MotionType.ANTI) {
        if (beat.pictographData.motions.red) {
          beat.pictographData.motions.red = {
            ...beat.pictographData.motions.red,
            turns: "fl",
            prefloat_motion_type: beat.pictographData.motions.red.motionType,
            prefloat_prop_rot_dir: beat.pictographData.motions.red.rotationDirection,
            motionType: MotionType.FLOAT,
            rotationDirection: RotationDirection.NO_ROTATION
          };
        }
      } else {
        if (beat.pictographData.motions.red) {
          beat.pictographData.motions.red = {
            ...beat.pictographData.motions.red,
            turns: 0
          };
        }
      }
    } else {
      if (beat.pictographData.motions.red) {
        beat.pictographData.motions.red = {
          ...beat.pictographData.motions.red,
          turns: turnRed
        };
      }
    }
  }
  /**
   * Update dash/static prop rotation directions - exact port from legacy
   */
  updateDashStaticRotationDirections(beat, propContinuity, blueRotationDirection, redRotationDirection) {
    if (!beat.pictographData) return;
    if (beat.pictographData.motions.blue?.motionType === MOTION_TYPES.DASH || beat.pictographData.motions.blue?.motionType === MOTION_TYPES.STATIC) {
      const turns = beat.pictographData.motions.blue.turns || 0;
      if (propContinuity === PropContinuity.CONTINUOUS) {
        const newRotationDirection = typeof turns === "number" && turns > 0 ? blueRotationDirection : ROTATION_DIRS.noRotation;
        beat.pictographData.motions.blue = {
          ...beat.pictographData.motions.blue,
          rotationDirection: newRotationDirection
        };
      } else if (typeof turns === "number" && turns > 0) {
        const newRotationDirection = this.randomChoice([
          ROTATION_DIRS.CLOCKWISE,
          ROTATION_DIRS.COUNTER_CLOCKWISE
        ]);
        beat.pictographData.motions.blue = {
          ...beat.pictographData.motions.blue,
          rotationDirection: newRotationDirection
        };
      } else {
        beat.pictographData.motions.blue = {
          ...beat.pictographData.motions.blue,
          rotationDirection: ROTATION_DIRS.noRotation
        };
      }
    }
    if (beat.pictographData.motions.red?.motionType === MOTION_TYPES.DASH || beat.pictographData.motions.red?.motionType === MOTION_TYPES.STATIC) {
      const turns = beat.pictographData.motions.red.turns || 0;
      if (propContinuity === PropContinuity.CONTINUOUS) {
        const newRotationDirection = typeof turns === "number" && turns > 0 ? redRotationDirection : ROTATION_DIRS.noRotation;
        beat.pictographData.motions.red = {
          ...beat.pictographData.motions.red,
          rotationDirection: newRotationDirection
        };
      } else if (typeof turns === "number" && turns > 0) {
        const newRotationDirection = this.randomChoice([
          ROTATION_DIRS.CLOCKWISE,
          ROTATION_DIRS.COUNTER_CLOCKWISE
        ]);
        beat.pictographData.motions.red = {
          ...beat.pictographData.motions.red,
          rotationDirection: newRotationDirection
        };
      } else {
        beat.pictographData.motions.red = {
          ...beat.pictographData.motions.red,
          rotationDirection: ROTATION_DIRS.noRotation
        };
      }
    }
  }
  /**
   * Random choice helper - exact behavior from legacy random.choice()
   */
  randomChoice(array) {
    if (array.length === 0) {
      throw new Error("Cannot choose from empty array");
    }
    return array[Math.floor(Math.random() * array.length)];
  }
  /**
   * Map difficulty to level - legacy mapping
   */
  mapDifficultyToLevel(difficulty) {
    switch (difficulty) {
      case DifficultyLevel.BEGINNER:
        return 1;
      case DifficultyLevel.INTERMEDIATE:
        return 2;
      case DifficultyLevel.ADVANCED:
        return 3;
      default:
        return 2;
    }
  }
  /**
   * Generate sequence name based on options - matches legacy pattern
   */
  generateSequenceName(options) {
    const timestamp = (/* @__PURE__ */ new Date()).toLocaleString("en-US", {
      month: "short",
      day: "numeric",
      hour: "numeric",
      minute: "2-digit"
    });
    const difficulty = options.difficulty.charAt(0).toUpperCase() + options.difficulty.slice(1);
    return `${difficulty} ${options.length}-Beat (${timestamp})`;
  }
  /**
   * Generate circular sequence - not implemented in Phase 1
   */
  async generatePatternSequence(pattern, _options) {
    throw new Error(`${pattern} generation not implemented yet`);
  }
  /**
   * Get generation statistics - not implemented in Phase 1
   */
  getGenerationStats() {
    return {
      totalGenerated: 0,
      averageGenerationTime: 0,
      lastGenerated: null
    };
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNlcXVlbmNlR2VuZXJhdGlvblNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBTZXF1ZW5jZSBHZW5lcmF0aW9uIFNlcnZpY2UgLSBDb21wbGV0ZSBwb3J0IG9mIGxlZ2FjeSBmcmVlZm9ybSBhbGdvcml0aG1cbiAqXG4gKiBFeGFjdCBpbXBsZW1lbnRhdGlvbiBvZiBGcmVlRm9ybVNlcXVlbmNlQnVpbGRlci5idWlsZF9zZXF1ZW5jZSgpIGFuZCBfZ2VuZXJhdGVfbmV4dF9waWN0b2dyYXBoKCkuXG4gKiBObyBwbGFjZWhvbGRlcnMsIG5vIHNpbXBsaWZpZWQgdmVyc2lvbnMgLSBjb21wbGV0ZSBhbGdvcml0aG0gZnJvbSBsZWdhY3kgZGVza3RvcCBhcHAuXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBCZWF0RGF0YSwgU2VxdWVuY2VEYXRhIH0gZnJvbSBcIiRsaWIvZG9tYWluXCI7XG5pbXBvcnQgeyBjcmVhdGVTZXF1ZW5jZURhdGEgfSBmcm9tIFwiJGxpYi9kb21haW5cIjtcbmltcG9ydCB7IEdyaWRNb2RlIH0gZnJvbSBcIiRsaWIvZG9tYWluXCI7XG5pbXBvcnQgdHlwZSB7XG4gIEdlbmVyYXRpb25PcHRpb25zLFxuICBJU2VxdWVuY2VHZW5lcmF0aW9uU2VydmljZSxcbiAgSU9yaWVudGF0aW9uQ2FsY3VsYXRpb25TZXJ2aWNlLFxufSBmcm9tIFwiLi4vLi4vaW50ZXJmYWNlcy9nZW5lcmF0aW9uLWludGVyZmFjZXNcIjtcbmltcG9ydCB0eXBlIHsgSUxldHRlclF1ZXJ5U2VydmljZSB9IGZyb20gXCIuLi9kYXRhL0xldHRlclF1ZXJ5U2VydmljZVwiO1xuXG5pbXBvcnQgdHlwZSB7IFBpY3RvZ3JhcGhEYXRhIH0gZnJvbSBcIiRsaWIvZG9tYWluL1BpY3RvZ3JhcGhEYXRhXCI7XG5pbXBvcnQgeyBjcmVhdGVNb3Rpb25EYXRhIH0gZnJvbSBcIiRsaWIvZG9tYWluL01vdGlvbkRhdGFcIjtcbmltcG9ydCB7XG4gIE1vdGlvblR5cGUsXG4gIFJvdGF0aW9uRGlyZWN0aW9uLFxuICBMb2NhdGlvbixcbiAgT3JpZW50YXRpb24sXG4gIERpZmZpY3VsdHlMZXZlbCxcbiAgUHJvcENvbnRpbnVpdHksXG4gIEdlbmVyYXRpb25Nb2RlLFxufSBmcm9tIFwiJGxpYi9kb21haW4vZW51bXNcIjtcblxuLy8gTGVnYWN5IGNvbnN0YW50cyBmb3Igcm90YXRpb24gZGlyZWN0aW9ucyAtIHVzaW5nIGVudW0gdmFsdWVzXG5jb25zdCBST1RBVElPTl9ESVJTID0ge1xuICBDTE9DS1dJU0U6IFJvdGF0aW9uRGlyZWN0aW9uLkNMT0NLV0lTRSxcbiAgQ09VTlRFUl9DTE9DS1dJU0U6IFJvdGF0aW9uRGlyZWN0aW9uLkNPVU5URVJfQ0xPQ0tXSVNFLFxuICBub1JvdGF0aW9uOiBSb3RhdGlvbkRpcmVjdGlvbi5OT19ST1RBVElPTixcbn0gYXMgY29uc3Q7XG5cbmNvbnN0IE1PVElPTl9UWVBFUyA9IHtcbiAgUFJPOiBNb3Rpb25UeXBlLlBSTyxcbiAgQU5USTogTW90aW9uVHlwZS5BTlRJLFxuICBGTE9BVDogTW90aW9uVHlwZS5GTE9BVCxcbiAgREFTSDogTW90aW9uVHlwZS5EQVNILFxuICBTVEFUSUM6IE1vdGlvblR5cGUuU1RBVElDLFxufSBhcyBjb25zdDtcblxuZXhwb3J0IGNsYXNzIFNlcXVlbmNlR2VuZXJhdGlvblNlcnZpY2UgaW1wbGVtZW50cyBJU2VxdWVuY2VHZW5lcmF0aW9uU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbGV0dGVyUXVlcnlTZXJ2aWNlOiBJTGV0dGVyUXVlcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgb3JpZW50YXRpb25DYWxjdWxhdGlvblNlcnZpY2U6IElPcmllbnRhdGlvbkNhbGN1bGF0aW9uU2VydmljZVxuICApIHt9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIGZyZWVmb3JtIHNlcXVlbmNlIC0gZXhhY3QgcG9ydCBvZiBsZWdhY3kgYnVpbGRfc2VxdWVuY2UoKVxuICAgKi9cbiAgYXN5bmMgZ2VuZXJhdGVTZXF1ZW5jZShvcHRpb25zOiBHZW5lcmF0aW9uT3B0aW9ucyk6IFByb21pc2U8U2VxdWVuY2VEYXRhPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKFwi8J+OryBTdGFydGluZyBmcmVlZm9ybSBnZW5lcmF0aW9uIHdpdGggb3B0aW9uczpcIiwgb3B0aW9ucyk7XG5cbiAgICAgIC8vIFN0ZXAgMTogSW5pdGlhbGl6ZSBzZXF1ZW5jZSAobGVnYWN5OiBzZWxmLmluaXRpYWxpemVfc2VxdWVuY2UpXG4gICAgICAvLyBUT0RPOiBJbiBmdWxsIGltcGxlbWVudGF0aW9uLCB0aGlzIHNob3VsZCBsb2FkIGN1cnJlbnQgc2VxdWVuY2UgZnJvbSB3b3JrYmVuY2hcbiAgICAgIC8vIEZvciBub3csIHN0YXJ0IHdpdGggZW1wdHkgc2VxdWVuY2VcbiAgICAgIGNvbnN0IHNlcXVlbmNlOiBCZWF0RGF0YVtdID0gW107XG5cbiAgICAgIC8vIFN0ZXAgMjogU2V0IHJvdGF0aW9uIGRpcmVjdGlvbnMgYmFzZWQgb24gcHJvcCBjb250aW51aXR5IChsZWdhY3kgbGluZXMgMzEtMzUpXG4gICAgICBsZXQgYmx1ZVJvdGF0aW9uRGlyZWN0aW9uOiBzdHJpbmc7XG4gICAgICBsZXQgcmVkUm90YXRpb25EaXJlY3Rpb246IHN0cmluZztcblxuICAgICAgaWYgKG9wdGlvbnMucHJvcENvbnRpbnVpdHkgPT09IFByb3BDb250aW51aXR5LkNPTlRJTlVPVVMpIHtcbiAgICAgICAgYmx1ZVJvdGF0aW9uRGlyZWN0aW9uID0gdGhpcy5yYW5kb21DaG9pY2UoW1xuICAgICAgICAgIFJPVEFUSU9OX0RJUlMuQ0xPQ0tXSVNFLFxuICAgICAgICAgIFJPVEFUSU9OX0RJUlMuQ09VTlRFUl9DTE9DS1dJU0UsXG4gICAgICAgIF0pO1xuICAgICAgICByZWRSb3RhdGlvbkRpcmVjdGlvbiA9IHRoaXMucmFuZG9tQ2hvaWNlKFtcbiAgICAgICAgICBST1RBVElPTl9ESVJTLkNMT0NLV0lTRSxcbiAgICAgICAgICBST1RBVElPTl9ESVJTLkNPVU5URVJfQ0xPQ0tXSVNFLFxuICAgICAgICBdKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFJhbmRvbSBwcm9wIGNvbnRpbnVpdHkgLSB0aGVzZSB3aWxsIGJlIHNldCBwZXIgbW90aW9uXG4gICAgICAgIGJsdWVSb3RhdGlvbkRpcmVjdGlvbiA9IFwiXCI7XG4gICAgICAgIHJlZFJvdGF0aW9uRGlyZWN0aW9uID0gXCJcIjtcbiAgICAgIH1cblxuICAgICAgY29uc29sZS5sb2coXCLwn5SEIFJvdGF0aW9uIGRpcmVjdGlvbnM6XCIsIHtcbiAgICAgICAgYmx1ZVJvdGF0aW9uRGlyZWN0aW9uLFxuICAgICAgICByZWRSb3RhdGlvbkRpcmVjdGlvbixcbiAgICAgICAgcHJvcENvbnRpbnVpdHk6IG9wdGlvbnMucHJvcENvbnRpbnVpdHksXG4gICAgICB9KTtcblxuICAgICAgLy8gU3RlcCAzOiBDYWxjdWxhdGUgYmVhdHMgdG8gZ2VuZXJhdGUgKGxlZ2FjeSBsb2dpYylcbiAgICAgIGNvbnN0IGxlbmd0aE9mU2VxdWVuY2VVcG9uU3RhcnQgPSBNYXRoLm1heCgwLCBzZXF1ZW5jZS5sZW5ndGggLSAyKTtcbiAgICAgIGNvbnN0IGJlYXRzVG9HZW5lcmF0ZSA9IG9wdGlvbnMubGVuZ3RoIC0gbGVuZ3RoT2ZTZXF1ZW5jZVVwb25TdGFydDtcblxuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgIGDwn5OKIEdlbmVyYXRpbmcgJHtiZWF0c1RvR2VuZXJhdGV9IGJlYXRzIChyZXF1ZXN0ZWQ6ICR7b3B0aW9ucy5sZW5ndGh9LCBleGlzdGluZzogJHtsZW5ndGhPZlNlcXVlbmNlVXBvblN0YXJ0fSlgXG4gICAgICApO1xuXG4gICAgICBpZiAoYmVhdHNUb0dlbmVyYXRlIDw9IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIFwiTm8gYmVhdHMgdG8gZ2VuZXJhdGUgLSBzZXF1ZW5jZSBtYXkgYWxyZWFkeSBiZSBjb21wbGV0ZVwiXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIFN0ZXAgNDogQWxsb2NhdGUgdHVybnMgdXNpbmcgVHVybkludGVuc2l0eU1hbmFnZXIgKGxlZ2FjeSBsaW5lcyAzOS00MClcbiAgICAgIGNvbnN0IGxldmVsID0gdGhpcy5tYXBEaWZmaWN1bHR5VG9MZXZlbChvcHRpb25zLmRpZmZpY3VsdHkpO1xuICAgICAgY29uc3QgdHVybkludGVuc2l0eSA9IG9wdGlvbnMudHVybkludGVuc2l0eSB8fCAxO1xuXG4gICAgICAvLyBTaW1wbGUgdHVybiBhbGxvY2F0aW9uIGZvciBub3cgKGNhbiBiZSBlbmhhbmNlZCBsYXRlcilcbiAgICAgIGNvbnN0IHRvdGFsVHVybnMgPSBNYXRoLmZsb29yKHR1cm5JbnRlbnNpdHkgKiBiZWF0c1RvR2VuZXJhdGUpO1xuICAgICAgY29uc3QgdHVybkFsbG9jYXRpb24gPSB7XG4gICAgICAgIGJsdWU6IEFycmF5KGJlYXRzVG9HZW5lcmF0ZSlcbiAgICAgICAgICAuZmlsbCgwKVxuICAgICAgICAgIC5tYXAoKF8sIGkpID0+IChpIDwgdG90YWxUdXJucyAvIDIgPyAxIDogMCkpLFxuICAgICAgICByZWQ6IEFycmF5KGJlYXRzVG9HZW5lcmF0ZSlcbiAgICAgICAgICAuZmlsbCgwKVxuICAgICAgICAgIC5tYXAoKF8sIGkpID0+IChpIDwgdG90YWxUdXJucyAvIDIgPyAxIDogMCkpLFxuICAgICAgfTtcbiAgICAgIGNvbnNvbGUubG9nKFwi8J+OsiBUdXJuIGFsbG9jYXRpb246XCIsIHR1cm5BbGxvY2F0aW9uKTtcblxuICAgICAgLy8gU3RlcCA1OiBHZW5lcmF0aW9uIGxvb3AgKGxlZ2FjeSBsaW5lcyA0Mi01OClcbiAgICAgIGNvbnN0IGdlbmVyYXRlZEJlYXRzOiBCZWF0RGF0YVtdID0gW107XG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmVhdHNUb0dlbmVyYXRlOyBpKyspIHtcbiAgICAgICAgY29uc29sZS5sb2coYOKaoSBHZW5lcmF0aW5nIGJlYXQgJHtpICsgMX0vJHtiZWF0c1RvR2VuZXJhdGV9YCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBuZXh0UGljdG9ncmFwaCA9IGF3YWl0IHRoaXMuX2dlbmVyYXRlTmV4dFBpY3RvZ3JhcGgoXG4gICAgICAgICAgICBzZXF1ZW5jZSxcbiAgICAgICAgICAgIGxldmVsLFxuICAgICAgICAgICAgdHVybkFsbG9jYXRpb24uYmx1ZVtpXSxcbiAgICAgICAgICAgIHR1cm5BbGxvY2F0aW9uLnJlZFtpXSxcbiAgICAgICAgICAgIG9wdGlvbnMucHJvcENvbnRpbnVpdHkgfHwgUHJvcENvbnRpbnVpdHkuQ09OVElOVU9VUyxcbiAgICAgICAgICAgIGJsdWVSb3RhdGlvbkRpcmVjdGlvbixcbiAgICAgICAgICAgIHJlZFJvdGF0aW9uRGlyZWN0aW9uLFxuICAgICAgICAgICAgb3B0aW9ucy5sZXR0ZXJUeXBlcyB8fCBbXCJEdWFsLVNoaWZ0XCJdIC8vIERlZmF1bHQgdG8gVHlwZTEgaWYgbm90IHNwZWNpZmllZFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICAvLyBBZGQgdG8gc2VxdWVuY2UgZm9yIG5leHQgaXRlcmF0aW9uIChsZWdhY3kgbG9naWMpXG4gICAgICAgICAgc2VxdWVuY2UucHVzaChuZXh0UGljdG9ncmFwaCk7XG4gICAgICAgICAgZ2VuZXJhdGVkQmVhdHMucHVzaChuZXh0UGljdG9ncmFwaCk7XG5cbiAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgIGDinIUgR2VuZXJhdGVkIGJlYXQgJHtpICsgMX06ICR7bmV4dFBpY3RvZ3JhcGgucGljdG9ncmFwaERhdGE/LmxldHRlcn1gXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBjYXRjaCAoYmVhdEVycm9yKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihg4p2MIEZhaWxlZCB0byBnZW5lcmF0ZSBiZWF0ICR7aSArIDF9OmAsIGJlYXRFcnJvcik7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYEJlYXQgZ2VuZXJhdGlvbiBmYWlsZWQgYXQgcG9zaXRpb24gJHtpICsgMX06ICR7YmVhdEVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBiZWF0RXJyb3IubWVzc2FnZSA6IFwiVW5rbm93biBlcnJvclwifWBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFN0ZXAgNjogQ3JlYXRlIHNlcXVlbmNlIGRhdGEgc3RydWN0dXJlXG4gICAgICBjb25zdCBnZW5lcmF0ZWRTZXF1ZW5jZTogU2VxdWVuY2VEYXRhID0gY3JlYXRlU2VxdWVuY2VEYXRhKHtcbiAgICAgICAgbmFtZTogdGhpcy5nZW5lcmF0ZVNlcXVlbmNlTmFtZShvcHRpb25zKSxcbiAgICAgICAgd29yZDogXCJcIiwgLy8gV2lsbCBiZSBjYWxjdWxhdGVkIGZyb20gYmVhdHNcbiAgICAgICAgYmVhdHM6IGdlbmVyYXRlZEJlYXRzLFxuICAgICAgICBncmlkTW9kZTogb3B0aW9ucy5ncmlkTW9kZSxcbiAgICAgICAgcHJvcFR5cGU6IG9wdGlvbnMucHJvcFR5cGUsXG4gICAgICAgIGRpZmZpY3VsdHlfbGV2ZWw6IG9wdGlvbnMuZGlmZmljdWx0eSxcbiAgICAgICAgaXNfZmF2b3JpdGU6IGZhbHNlLFxuICAgICAgICBpc19jaXJjdWxhcjogZmFsc2UsXG4gICAgICAgIHRhZ3M6IFtdLFxuICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgIGdlbmVyYXRlZDogdHJ1ZSxcbiAgICAgICAgICBnZW5lcmF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIGFsZ29yaXRobTogXCJmcmVlZm9ybVwiLFxuICAgICAgICAgIGJlYXRzR2VuZXJhdGVkOiBnZW5lcmF0ZWRCZWF0cy5sZW5ndGgsXG4gICAgICAgICAgcHJvcENvbnRpbnVpdHk6IG9wdGlvbnMucHJvcENvbnRpbnVpdHksXG4gICAgICAgICAgYmx1ZVJvdGF0aW9uRGlyZWN0aW9uLFxuICAgICAgICAgIHJlZFJvdGF0aW9uRGlyZWN0aW9uLFxuICAgICAgICAgIHR1cm5JbnRlbnNpdHksXG4gICAgICAgICAgbGV2ZWwsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgY29uc29sZS5sb2coXCLwn46JIFNlcXVlbmNlIGdlbmVyYXRpb24gY29tcGxldGU6XCIsIHtcbiAgICAgICAgaWQ6IGdlbmVyYXRlZFNlcXVlbmNlLmlkLFxuICAgICAgICBiZWF0czogZ2VuZXJhdGVkQmVhdHMubGVuZ3RoLFxuICAgICAgICBuYW1lOiBnZW5lcmF0ZWRTZXF1ZW5jZS5uYW1lLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiBnZW5lcmF0ZWRTZXF1ZW5jZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIuKdjCBTZXF1ZW5jZSBnZW5lcmF0aW9uIGZhaWxlZDpcIiwgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgU2VxdWVuY2UgZ2VuZXJhdGlvbiBmYWlsZWQ6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBcIlVua25vd24gZXJyb3JcIn1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBuZXh0IHBpY3RvZ3JhcGggLSBleGFjdCBwb3J0IG9mIGxlZ2FjeSBfZ2VuZXJhdGVfbmV4dF9waWN0b2dyYXBoKClcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgX2dlbmVyYXRlTmV4dFBpY3RvZ3JhcGgoXG4gICAgc2VxdWVuY2U6IEJlYXREYXRhW10sXG4gICAgbGV2ZWw6IG51bWJlcixcbiAgICB0dXJuQmx1ZTogbnVtYmVyIHwgXCJmbFwiLFxuICAgIHR1cm5SZWQ6IG51bWJlciB8IFwiZmxcIixcbiAgICBwcm9wQ29udGludWl0eTogUHJvcENvbnRpbnVpdHksXG4gICAgYmx1ZVJvdGF0aW9uRGlyZWN0aW9uOiBzdHJpbmcsXG4gICAgcmVkUm90YXRpb25EaXJlY3Rpb246IHN0cmluZyxcbiAgICBfbGV0dGVyVHlwZXM6IHN0cmluZ1tdXG4gICk6IFByb21pc2U8QmVhdERhdGE+IHtcbiAgICB0cnkge1xuICAgICAgLy8gU3RlcCAxOiBHZXQgb3B0aW9uIGRpY3RzIChsZWdhY3k6IHNlbGYuX2dldF9vcHRpb25fZGljdHMoKSlcbiAgICAgIC8vIExldHRlclF1ZXJ5U2VydmljZSBpbml0aWFsaXplcyBhdXRvbWF0aWNhbGx5IHdoZW4gZmlyc3QgdXNlZFxuICAgICAgY29uc3Qgb3B0aW9uRGljdHMgPSBhd2FpdCB0aGlzLmxldHRlclF1ZXJ5U2VydmljZS5nZXRBbGxDb2RleFBpY3RvZ3JhcGhzKFxuICAgICAgICBHcmlkTW9kZS5ESUFNT05EXG4gICAgICApO1xuICAgICAgY29uc29sZS5sb2coYPCfk4sgTG9hZGVkICR7b3B0aW9uRGljdHMubGVuZ3RofSBvcHRpb24gZGljdHNgKTtcblxuICAgICAgaWYgKG9wdGlvbkRpY3RzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJObyBwaWN0b2dyYXBocyBhdmFpbGFibGUgZnJvbSBvcHRpb24gc2VydmljZVwiKTtcbiAgICAgIH1cblxuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgIGDwn5SNIFVzaW5nIGFsbCAke29wdGlvbkRpY3RzLmxlbmd0aH0gb3B0aW9ucyAoZmlsdGVyaW5nIG5vdCB5ZXQgaW1wbGVtZW50ZWQpYFxuICAgICAgKTtcbiAgICAgIGNvbnNvbGUubG9nKGDwn5SEIFJvdGF0aW9uIGZpbHRlcmluZyBub3QgeWV0IGltcGxlbWVudGVkYCk7XG5cbiAgICAgIGlmIChvcHRpb25EaWN0cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTm8gdmFsaWQgb3B0aW9ucyBhdmFpbGFibGUgYWZ0ZXIgZmlsdGVyaW5nXCIpO1xuICAgICAgfVxuXG4gICAgICAvLyBTdGVwIDQ6IFJhbmRvbSBzZWxlY3Rpb24gKGxlZ2FjeTogcmFuZG9tLmNob2ljZShvcHRpb25fZGljdHMpKVxuICAgICAgY29uc3Qgc2VsZWN0ZWRPcHRpb24gPSB0aGlzLnJhbmRvbUNob2ljZShvcHRpb25EaWN0cyk7XG4gICAgICBjb25zb2xlLmxvZyhg8J+OryBTZWxlY3RlZCBvcHRpb246ICR7c2VsZWN0ZWRPcHRpb24ubGV0dGVyfWApO1xuXG4gICAgICAvLyBTdGVwIDU6IENvbnZlcnQgdG8gQmVhdERhdGFcbiAgICAgIGxldCBuZXh0QmVhdCA9IHRoaXMuY29udmVydFBpY3RvZ3JhcGhUb0JlYXQoXG4gICAgICAgIHNlbGVjdGVkT3B0aW9uLFxuICAgICAgICBzZXF1ZW5jZS5sZW5ndGggKyAxXG4gICAgICApO1xuXG4gICAgICAvLyBTdGVwIDY6IFNldCB0dXJucyBpZiBsZXZlbCAyIG9yIDMgKGxlZ2FjeTogc2VsZi5zZXRfdHVybnMoKSlcbiAgICAgIGlmIChsZXZlbCA9PT0gMiB8fCBsZXZlbCA9PT0gMykge1xuICAgICAgICB0aGlzLnNldFR1cm5zKG5leHRCZWF0LCB0dXJuQmx1ZSwgdHVyblJlZCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGDwn46yIFNldCB0dXJuczogYmx1ZT0ke3R1cm5CbHVlfSwgcmVkPSR7dHVyblJlZH1gKTtcbiAgICAgIH1cblxuICAgICAgLy8gU3RlcCA3OiBVcGRhdGUgb3JpZW50YXRpb25zIChleGFjdCBsZWdhY3kgc2VxdWVuY2UpXG4gICAgICBpZiAoc2VxdWVuY2UubGVuZ3RoID4gMCkge1xuICAgICAgICBuZXh0QmVhdCA9IHRoaXMub3JpZW50YXRpb25DYWxjdWxhdGlvblNlcnZpY2UudXBkYXRlU3RhcnRPcmllbnRhdGlvbnMoXG4gICAgICAgICAgbmV4dEJlYXQsXG4gICAgICAgICAgc2VxdWVuY2Vbc2VxdWVuY2UubGVuZ3RoIC0gMV1cbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy51cGRhdGVEYXNoU3RhdGljUm90YXRpb25EaXJlY3Rpb25zKFxuICAgICAgICBuZXh0QmVhdCxcbiAgICAgICAgcHJvcENvbnRpbnVpdHksXG4gICAgICAgIGJsdWVSb3RhdGlvbkRpcmVjdGlvbixcbiAgICAgICAgcmVkUm90YXRpb25EaXJlY3Rpb25cbiAgICAgICk7XG4gICAgICBuZXh0QmVhdCA9XG4gICAgICAgIHRoaXMub3JpZW50YXRpb25DYWxjdWxhdGlvblNlcnZpY2UudXBkYXRlRW5kT3JpZW50YXRpb25zKG5leHRCZWF0KTtcblxuICAgICAgY29uc29sZS5sb2coYPCfp60gVXBkYXRlZCBvcmllbnRhdGlvbnMgZm9yIGJlYXQgJHtuZXh0QmVhdC5iZWF0TnVtYmVyfWApO1xuXG4gICAgICByZXR1cm4gbmV4dEJlYXQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYOKdjCBGYWlsZWQgdG8gZ2VuZXJhdGUgcGljdG9ncmFwaDpgLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydCBQaWN0b2dyYXBoRGF0YSB0byBCZWF0RGF0YSAtIGNyZWF0ZXMgcHJvcGVyIGRvbWFpbiBvYmplY3RcbiAgICovXG4gIHByaXZhdGUgY29udmVydFBpY3RvZ3JhcGhUb0JlYXQoXG4gICAgcGljdG9ncmFwaDogUGljdG9ncmFwaERhdGEsXG4gICAgYmVhdE51bWJlcjogbnVtYmVyXG4gICk6IEJlYXREYXRhIHtcbiAgICAvLyBFbnN1cmUgbW90aW9ucyBleGlzdCBmb3IgYmx1ZSBhbmQgcmVkXG4gICAgY29uc3QgbW90aW9ucyA9IHtcbiAgICAgIGJsdWU6XG4gICAgICAgIHBpY3RvZ3JhcGgubW90aW9ucy5ibHVlIHx8XG4gICAgICAgIGNyZWF0ZU1vdGlvbkRhdGEoe1xuICAgICAgICAgIG1vdGlvblR5cGU6IE1vdGlvblR5cGUuU1RBVElDLFxuICAgICAgICAgIHJvdGF0aW9uRGlyZWN0aW9uOiBSb3RhdGlvbkRpcmVjdGlvbi5OT19ST1RBVElPTixcbiAgICAgICAgICBzdGFydExvY2F0aW9uOiBMb2NhdGlvbi5OT1JUSCxcbiAgICAgICAgICBlbmRMb2NhdGlvbjogTG9jYXRpb24uTk9SVEgsXG4gICAgICAgICAgdHVybnM6IDAsXG4gICAgICAgICAgc3RhcnRPcmllbnRhdGlvbjogT3JpZW50YXRpb24uSU4sXG4gICAgICAgICAgZW5kT3JpZW50YXRpb246IE9yaWVudGF0aW9uLklOLFxuICAgICAgICB9KSxcbiAgICAgIHJlZDpcbiAgICAgICAgcGljdG9ncmFwaC5tb3Rpb25zLnJlZCB8fFxuICAgICAgICBjcmVhdGVNb3Rpb25EYXRhKHtcbiAgICAgICAgICBtb3Rpb25UeXBlOiBNb3Rpb25UeXBlLlNUQVRJQyxcbiAgICAgICAgICByb3RhdGlvbkRpcmVjdGlvbjogUm90YXRpb25EaXJlY3Rpb24uTk9fUk9UQVRJT04sXG4gICAgICAgICAgc3RhcnRMb2NhdGlvbjogTG9jYXRpb24uTk9SVEgsXG4gICAgICAgICAgZW5kTG9jYXRpb246IExvY2F0aW9uLk5PUlRILFxuICAgICAgICAgIHR1cm5zOiAwLFxuICAgICAgICAgIHN0YXJ0T3JpZW50YXRpb246IE9yaWVudGF0aW9uLklOLFxuICAgICAgICAgIGVuZE9yaWVudGF0aW9uOiBPcmllbnRhdGlvbi5JTixcbiAgICAgICAgfSksXG4gICAgICAuLi5waWN0b2dyYXBoLm1vdGlvbnMsXG4gICAgfTtcblxuICAgIHJldHVybiB7XG4gICAgICBpZDogY3J5cHRvLnJhbmRvbVVVSUQoKSxcbiAgICAgIGJlYXROdW1iZXI6IGJlYXROdW1iZXIsXG4gICAgICBkdXJhdGlvbjogMS4wLFxuICAgICAgYmx1ZVJldmVyc2FsOiBmYWxzZSxcbiAgICAgIHJlZFJldmVyc2FsOiBmYWxzZSxcbiAgICAgIGlzQmxhbms6IGZhbHNlLFxuICAgICAgcGljdG9ncmFwaERhdGE6IHtcbiAgICAgICAgLi4ucGljdG9ncmFwaCxcbiAgICAgICAgbW90aW9ucyxcbiAgICAgIH0sXG4gICAgICBtZXRhZGF0YToge1xuICAgICAgICBnZW5lcmF0ZWQ6IHRydWUsXG4gICAgICAgIGdlbmVyYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIGxldHRlcjogcGljdG9ncmFwaC5sZXR0ZXIsXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogU2V0IHR1cm5zIC0gZXhhY3QgcG9ydCBmcm9tIGxlZ2FjeSBzZXRfdHVybnMoKVxuICAgKi9cbiAgcHJpdmF0ZSBzZXRUdXJucyhcbiAgICBiZWF0OiBCZWF0RGF0YSxcbiAgICB0dXJuQmx1ZTogbnVtYmVyIHwgXCJmbFwiLFxuICAgIHR1cm5SZWQ6IG51bWJlciB8IFwiZmxcIlxuICApOiB2b2lkIHtcbiAgICBpZiAoIWJlYXQucGljdG9ncmFwaERhdGEpIHJldHVybjtcblxuICAgIC8vIEhhbmRsZSBibHVlIHR1cm5zIC0gZXhhY3QgbGVnYWN5IGxvZ2ljXG4gICAgaWYgKHR1cm5CbHVlID09PSBcImZsXCIpIHtcbiAgICAgIGlmIChcbiAgICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLmJsdWU/Lm1vdGlvblR5cGUgPT09IE1vdGlvblR5cGUuUFJPIHx8XG4gICAgICAgIGJlYXQucGljdG9ncmFwaERhdGEubW90aW9ucy5ibHVlPy5tb3Rpb25UeXBlID09PSBNb3Rpb25UeXBlLkFOVElcbiAgICAgICkge1xuICAgICAgICBpZiAoYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLmJsdWUpIHtcbiAgICAgICAgICAvLyBDcmVhdGUgdXBkYXRlZCBtb3Rpb24gd2l0aCBmbG9hdCBwcm9wZXJ0aWVzXG4gICAgICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLmJsdWUgPSB7XG4gICAgICAgICAgICAuLi5iZWF0LnBpY3RvZ3JhcGhEYXRhLm1vdGlvbnMuYmx1ZSxcbiAgICAgICAgICAgIHR1cm5zOiBcImZsXCIsXG4gICAgICAgICAgICBwcmVmbG9hdF9tb3Rpb25fdHlwZTogYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLmJsdWUubW90aW9uVHlwZSxcbiAgICAgICAgICAgIHByZWZsb2F0X3Byb3Bfcm90X2RpcjpcbiAgICAgICAgICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLmJsdWUucm90YXRpb25EaXJlY3Rpb24sXG4gICAgICAgICAgICBtb3Rpb25UeXBlOiBNb3Rpb25UeXBlLkZMT0FULFxuICAgICAgICAgICAgcm90YXRpb25EaXJlY3Rpb246IFJvdGF0aW9uRGlyZWN0aW9uLk5PX1JPVEFUSU9OLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChiZWF0LnBpY3RvZ3JhcGhEYXRhLm1vdGlvbnMuYmx1ZSkge1xuICAgICAgICAgIGJlYXQucGljdG9ncmFwaERhdGEubW90aW9ucy5ibHVlID0ge1xuICAgICAgICAgICAgLi4uYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLmJsdWUsXG4gICAgICAgICAgICB0dXJuczogMCxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChiZWF0LnBpY3RvZ3JhcGhEYXRhLm1vdGlvbnMuYmx1ZSkge1xuICAgICAgICBiZWF0LnBpY3RvZ3JhcGhEYXRhLm1vdGlvbnMuYmx1ZSA9IHtcbiAgICAgICAgICAuLi5iZWF0LnBpY3RvZ3JhcGhEYXRhLm1vdGlvbnMuYmx1ZSxcbiAgICAgICAgICB0dXJuczogdHVybkJsdWUsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIHJlZCB0dXJucyAtIGV4YWN0IGxlZ2FjeSBsb2dpY1xuICAgIGlmICh0dXJuUmVkID09PSBcImZsXCIpIHtcbiAgICAgIGlmIChcbiAgICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLnJlZD8ubW90aW9uVHlwZSA9PT0gTW90aW9uVHlwZS5QUk8gfHxcbiAgICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLnJlZD8ubW90aW9uVHlwZSA9PT0gTW90aW9uVHlwZS5BTlRJXG4gICAgICApIHtcbiAgICAgICAgaWYgKGJlYXQucGljdG9ncmFwaERhdGEubW90aW9ucy5yZWQpIHtcbiAgICAgICAgICAvLyBDcmVhdGUgdXBkYXRlZCBtb3Rpb24gd2l0aCBmbG9hdCBwcm9wZXJ0aWVzXG4gICAgICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLnJlZCA9IHtcbiAgICAgICAgICAgIC4uLmJlYXQucGljdG9ncmFwaERhdGEubW90aW9ucy5yZWQsXG4gICAgICAgICAgICB0dXJuczogXCJmbFwiLFxuICAgICAgICAgICAgcHJlZmxvYXRfbW90aW9uX3R5cGU6IGJlYXQucGljdG9ncmFwaERhdGEubW90aW9ucy5yZWQubW90aW9uVHlwZSxcbiAgICAgICAgICAgIHByZWZsb2F0X3Byb3Bfcm90X2RpcjpcbiAgICAgICAgICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLnJlZC5yb3RhdGlvbkRpcmVjdGlvbixcbiAgICAgICAgICAgIG1vdGlvblR5cGU6IE1vdGlvblR5cGUuRkxPQVQsXG4gICAgICAgICAgICByb3RhdGlvbkRpcmVjdGlvbjogUm90YXRpb25EaXJlY3Rpb24uTk9fUk9UQVRJT04sXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGJlYXQucGljdG9ncmFwaERhdGEubW90aW9ucy5yZWQpIHtcbiAgICAgICAgICBiZWF0LnBpY3RvZ3JhcGhEYXRhLm1vdGlvbnMucmVkID0ge1xuICAgICAgICAgICAgLi4uYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLnJlZCxcbiAgICAgICAgICAgIHR1cm5zOiAwLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGJlYXQucGljdG9ncmFwaERhdGEubW90aW9ucy5yZWQpIHtcbiAgICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLnJlZCA9IHtcbiAgICAgICAgICAuLi5iZWF0LnBpY3RvZ3JhcGhEYXRhLm1vdGlvbnMucmVkLFxuICAgICAgICAgIHR1cm5zOiB0dXJuUmVkLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgZGFzaC9zdGF0aWMgcHJvcCByb3RhdGlvbiBkaXJlY3Rpb25zIC0gZXhhY3QgcG9ydCBmcm9tIGxlZ2FjeVxuICAgKi9cbiAgcHJpdmF0ZSB1cGRhdGVEYXNoU3RhdGljUm90YXRpb25EaXJlY3Rpb25zKFxuICAgIGJlYXQ6IEJlYXREYXRhLFxuICAgIHByb3BDb250aW51aXR5OiBzdHJpbmcsXG4gICAgYmx1ZVJvdGF0aW9uRGlyZWN0aW9uOiBzdHJpbmcsXG4gICAgcmVkUm90YXRpb25EaXJlY3Rpb246IHN0cmluZ1xuICApOiB2b2lkIHtcbiAgICBpZiAoIWJlYXQucGljdG9ncmFwaERhdGEpIHJldHVybjtcblxuICAgIC8vIFVwZGF0ZSBibHVlIC0gZXhhY3QgbGVnYWN5IGxvZ2ljXG4gICAgaWYgKFxuICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLmJsdWU/Lm1vdGlvblR5cGUgPT09IE1PVElPTl9UWVBFUy5EQVNIIHx8XG4gICAgICBiZWF0LnBpY3RvZ3JhcGhEYXRhLm1vdGlvbnMuYmx1ZT8ubW90aW9uVHlwZSA9PT0gTU9USU9OX1RZUEVTLlNUQVRJQ1xuICAgICkge1xuICAgICAgY29uc3QgdHVybnMgPSBiZWF0LnBpY3RvZ3JhcGhEYXRhLm1vdGlvbnMuYmx1ZS50dXJucyB8fCAwO1xuICAgICAgaWYgKHByb3BDb250aW51aXR5ID09PSBQcm9wQ29udGludWl0eS5DT05USU5VT1VTKSB7XG4gICAgICAgIGNvbnN0IG5ld1JvdGF0aW9uRGlyZWN0aW9uID1cbiAgICAgICAgICB0eXBlb2YgdHVybnMgPT09IFwibnVtYmVyXCIgJiYgdHVybnMgPiAwXG4gICAgICAgICAgICA/IGJsdWVSb3RhdGlvbkRpcmVjdGlvblxuICAgICAgICAgICAgOiBST1RBVElPTl9ESVJTLm5vUm90YXRpb247XG4gICAgICAgIGJlYXQucGljdG9ncmFwaERhdGEubW90aW9ucy5ibHVlID0ge1xuICAgICAgICAgIC4uLmJlYXQucGljdG9ncmFwaERhdGEubW90aW9ucy5ibHVlLFxuICAgICAgICAgIHJvdGF0aW9uRGlyZWN0aW9uOiBuZXdSb3RhdGlvbkRpcmVjdGlvbiBhcyBSb3RhdGlvbkRpcmVjdGlvbixcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHR1cm5zID09PSBcIm51bWJlclwiICYmIHR1cm5zID4gMCkge1xuICAgICAgICBjb25zdCBuZXdSb3RhdGlvbkRpcmVjdGlvbiA9IHRoaXMucmFuZG9tQ2hvaWNlKFtcbiAgICAgICAgICBST1RBVElPTl9ESVJTLkNMT0NLV0lTRSxcbiAgICAgICAgICBST1RBVElPTl9ESVJTLkNPVU5URVJfQ0xPQ0tXSVNFLFxuICAgICAgICBdKTtcbiAgICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLmJsdWUgPSB7XG4gICAgICAgICAgLi4uYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLmJsdWUsXG4gICAgICAgICAgcm90YXRpb25EaXJlY3Rpb246IG5ld1JvdGF0aW9uRGlyZWN0aW9uLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLmJsdWUgPSB7XG4gICAgICAgICAgLi4uYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLmJsdWUsXG4gICAgICAgICAgcm90YXRpb25EaXJlY3Rpb246IFJPVEFUSU9OX0RJUlMubm9Sb3RhdGlvbixcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgcmVkIC0gZXhhY3QgbGVnYWN5IGxvZ2ljXG4gICAgaWYgKFxuICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLnJlZD8ubW90aW9uVHlwZSA9PT0gTU9USU9OX1RZUEVTLkRBU0ggfHxcbiAgICAgIGJlYXQucGljdG9ncmFwaERhdGEubW90aW9ucy5yZWQ/Lm1vdGlvblR5cGUgPT09IE1PVElPTl9UWVBFUy5TVEFUSUNcbiAgICApIHtcbiAgICAgIGNvbnN0IHR1cm5zID0gYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLnJlZC50dXJucyB8fCAwO1xuICAgICAgaWYgKHByb3BDb250aW51aXR5ID09PSBQcm9wQ29udGludWl0eS5DT05USU5VT1VTKSB7XG4gICAgICAgIGNvbnN0IG5ld1JvdGF0aW9uRGlyZWN0aW9uID1cbiAgICAgICAgICB0eXBlb2YgdHVybnMgPT09IFwibnVtYmVyXCIgJiYgdHVybnMgPiAwXG4gICAgICAgICAgICA/IHJlZFJvdGF0aW9uRGlyZWN0aW9uXG4gICAgICAgICAgICA6IFJPVEFUSU9OX0RJUlMubm9Sb3RhdGlvbjtcbiAgICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLnJlZCA9IHtcbiAgICAgICAgICAuLi5iZWF0LnBpY3RvZ3JhcGhEYXRhLm1vdGlvbnMucmVkLFxuICAgICAgICAgIHJvdGF0aW9uRGlyZWN0aW9uOiBuZXdSb3RhdGlvbkRpcmVjdGlvbiBhcyBSb3RhdGlvbkRpcmVjdGlvbixcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHR1cm5zID09PSBcIm51bWJlclwiICYmIHR1cm5zID4gMCkge1xuICAgICAgICBjb25zdCBuZXdSb3RhdGlvbkRpcmVjdGlvbiA9IHRoaXMucmFuZG9tQ2hvaWNlKFtcbiAgICAgICAgICBST1RBVElPTl9ESVJTLkNMT0NLV0lTRSxcbiAgICAgICAgICBST1RBVElPTl9ESVJTLkNPVU5URVJfQ0xPQ0tXSVNFLFxuICAgICAgICBdKTtcbiAgICAgICAgYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLnJlZCA9IHtcbiAgICAgICAgICAuLi5iZWF0LnBpY3RvZ3JhcGhEYXRhLm1vdGlvbnMucmVkLFxuICAgICAgICAgIHJvdGF0aW9uRGlyZWN0aW9uOiBuZXdSb3RhdGlvbkRpcmVjdGlvbixcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGJlYXQucGljdG9ncmFwaERhdGEubW90aW9ucy5yZWQgPSB7XG4gICAgICAgICAgLi4uYmVhdC5waWN0b2dyYXBoRGF0YS5tb3Rpb25zLnJlZCxcbiAgICAgICAgICByb3RhdGlvbkRpcmVjdGlvbjogUk9UQVRJT05fRElSUy5ub1JvdGF0aW9uLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSYW5kb20gY2hvaWNlIGhlbHBlciAtIGV4YWN0IGJlaGF2aW9yIGZyb20gbGVnYWN5IHJhbmRvbS5jaG9pY2UoKVxuICAgKi9cbiAgcHJpdmF0ZSByYW5kb21DaG9pY2U8VD4oYXJyYXk6IFRbXSk6IFQge1xuICAgIGlmIChhcnJheS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBjaG9vc2UgZnJvbSBlbXB0eSBhcnJheVwiKTtcbiAgICB9XG4gICAgcmV0dXJuIGFycmF5W01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGFycmF5Lmxlbmd0aCldO1xuICB9XG5cbiAgLyoqXG4gICAqIE1hcCBkaWZmaWN1bHR5IHRvIGxldmVsIC0gbGVnYWN5IG1hcHBpbmdcbiAgICovXG4gIHByaXZhdGUgbWFwRGlmZmljdWx0eVRvTGV2ZWwoZGlmZmljdWx0eTogRGlmZmljdWx0eUxldmVsKTogbnVtYmVyIHtcbiAgICBzd2l0Y2ggKGRpZmZpY3VsdHkpIHtcbiAgICAgIGNhc2UgRGlmZmljdWx0eUxldmVsLkJFR0lOTkVSOlxuICAgICAgICByZXR1cm4gMTtcbiAgICAgIGNhc2UgRGlmZmljdWx0eUxldmVsLklOVEVSTUVESUFURTpcbiAgICAgICAgcmV0dXJuIDI7XG4gICAgICBjYXNlIERpZmZpY3VsdHlMZXZlbC5BRFZBTkNFRDpcbiAgICAgICAgcmV0dXJuIDM7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gMjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgc2VxdWVuY2UgbmFtZSBiYXNlZCBvbiBvcHRpb25zIC0gbWF0Y2hlcyBsZWdhY3kgcGF0dGVyblxuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZVNlcXVlbmNlTmFtZShvcHRpb25zOiBHZW5lcmF0aW9uT3B0aW9ucyk6IHN0cmluZyB7XG4gICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0xvY2FsZVN0cmluZyhcImVuLVVTXCIsIHtcbiAgICAgIG1vbnRoOiBcInNob3J0XCIsXG4gICAgICBkYXk6IFwibnVtZXJpY1wiLFxuICAgICAgaG91cjogXCJudW1lcmljXCIsXG4gICAgICBtaW51dGU6IFwiMi1kaWdpdFwiLFxuICAgIH0pO1xuXG4gICAgY29uc3QgZGlmZmljdWx0eSA9XG4gICAgICBvcHRpb25zLmRpZmZpY3VsdHkuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBvcHRpb25zLmRpZmZpY3VsdHkuc2xpY2UoMSk7XG4gICAgcmV0dXJuIGAke2RpZmZpY3VsdHl9ICR7b3B0aW9ucy5sZW5ndGh9LUJlYXQgKCR7dGltZXN0YW1wfSlgO1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIGNpcmN1bGFyIHNlcXVlbmNlIC0gbm90IGltcGxlbWVudGVkIGluIFBoYXNlIDFcbiAgICovXG4gIGFzeW5jIGdlbmVyYXRlUGF0dGVyblNlcXVlbmNlKFxuICAgIHBhdHRlcm46IEdlbmVyYXRpb25Nb2RlLFxuICAgIF9vcHRpb25zOiBHZW5lcmF0aW9uT3B0aW9uc1xuICApOiBQcm9taXNlPFNlcXVlbmNlRGF0YT4ge1xuICAgIHRocm93IG5ldyBFcnJvcihgJHtwYXR0ZXJufSBnZW5lcmF0aW9uIG5vdCBpbXBsZW1lbnRlZCB5ZXRgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZ2VuZXJhdGlvbiBzdGF0aXN0aWNzIC0gbm90IGltcGxlbWVudGVkIGluIFBoYXNlIDFcbiAgICovXG4gIGdldEdlbmVyYXRpb25TdGF0cygpOiB7XG4gICAgdG90YWxHZW5lcmF0ZWQ6IG51bWJlcjtcbiAgICBhdmVyYWdlR2VuZXJhdGlvblRpbWU6IG51bWJlcjtcbiAgICBsYXN0R2VuZXJhdGVkOiBzdHJpbmcgfCBudWxsO1xuICB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxHZW5lcmF0ZWQ6IDAsXG4gICAgICBhdmVyYWdlR2VuZXJhdGlvblRpbWU6IDAsXG4gICAgICBsYXN0R2VuZXJhdGVkOiBudWxsLFxuICAgIH07XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6IkFBUUEsU0FBUywwQkFBMEI7QUFDbkMsU0FBUyxnQkFBZ0I7QUFTekIsU0FBUyx3QkFBd0I7QUFDakM7QUFBQSxFQUNFO0FBQUEsRUFDQTtBQUFBLEVBQ0E7QUFBQSxFQUNBO0FBQUEsRUFDQTtBQUFBLEVBQ0E7QUFBQSxFQUNBO0FBQUEsT0FDSztBQUdQLE1BQU0sZ0JBQWdCO0FBQUEsRUFDcEIsV0FBVyxrQkFBa0I7QUFBQSxFQUM3QixtQkFBbUIsa0JBQWtCO0FBQUEsRUFDckMsWUFBWSxrQkFBa0I7QUFDaEM7QUFFQSxNQUFNLGVBQWU7QUFBQSxFQUNuQixLQUFLLFdBQVc7QUFBQSxFQUNoQixNQUFNLFdBQVc7QUFBQSxFQUNqQixPQUFPLFdBQVc7QUFBQSxFQUNsQixNQUFNLFdBQVc7QUFBQSxFQUNqQixRQUFRLFdBQVc7QUFDckI7QUFFTyxhQUFNLDBCQUFnRTtBQUFBLEVBQzNFLFlBQ1Usb0JBQ0EsK0JBQ1I7QUFGUTtBQUNBO0FBQUEsRUFDUDtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS0gsTUFBTSxpQkFBaUIsU0FBbUQ7QUFDeEUsUUFBSTtBQUNGLGNBQVEsSUFBSSxpREFBaUQsT0FBTztBQUtwRSxZQUFNLFdBQXVCLENBQUM7QUFHOUIsVUFBSTtBQUNKLFVBQUk7QUFFSixVQUFJLFFBQVEsbUJBQW1CLGVBQWUsWUFBWTtBQUN4RCxnQ0FBd0IsS0FBSyxhQUFhO0FBQUEsVUFDeEMsY0FBYztBQUFBLFVBQ2QsY0FBYztBQUFBLFFBQ2hCLENBQUM7QUFDRCwrQkFBdUIsS0FBSyxhQUFhO0FBQUEsVUFDdkMsY0FBYztBQUFBLFVBQ2QsY0FBYztBQUFBLFFBQ2hCLENBQUM7QUFBQSxNQUNILE9BQU87QUFF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