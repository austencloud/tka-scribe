/* BackgroundContext.svelte.ts generated by Svelte v5.38.1 */
import * as $ from "/node_modules/.vite/deps/svelte_internal_client.js?v=de368f3a";
import { browser } from "/node_modules/@sveltejs/kit/src/runtime/app/environment/index.js?v=de368f3a";
import { getContext, setContext } from "/node_modules/.vite/deps/svelte.js?v=de368f3a";
import { detectAppropriateQuality } from "/src/lib/components/backgrounds/config.ts";
import { BackgroundFactory } from "/src/lib/components/backgrounds/core/BackgroundFactory.ts";
import { PerformanceTracker } from "/src/lib/components/backgrounds/core/PerformanceTracker.ts";
import { BackgroundType } from "/src/lib/components/backgrounds/types/types.ts";

const BACKGROUND_CONTEXT_KEY = "background-context-runes";
const contextInstances = new Set();

export function createRunesBackgroundContext() {
	if (!browser) {
		return createMockRunesBackgroundContext();
	}

	const contextId = Math.floor(Math.random() * 1e4);

	if (contextInstances.size > 0) {
		try {
			const existingContext = getRunesBackgroundContext();

			if (existingContext) {
				return existingContext;
			}
		} catch {
			contextInstances.clear();
		}
	}

	let dimensions = $.tag($.state($.proxy({ width: 0, height: 0 })), 'dimensions');
	let performanceMetrics = $.tag($.state($.proxy({ fps: 60, warnings: [] })), 'performanceMetrics');
	let isActive = $.tag($.state(true), 'isActive');
	let qualityLevel = $.tag($.state($.proxy(detectAppropriateQuality())), 'qualityLevel');
	let isLoading = $.tag($.state(false), 'isLoading');
	let backgroundType = $.tag($.state($.proxy(BackgroundType.NIGHT_SKY)), 'backgroundType');
	let isInitialized = $.tag($.state(false), 'isInitialized');
	const shouldRender = $.tag($.derived(() => $.get(isActive) && $.get(performanceMetrics).fps > 30), 'shouldRender');
	let backgroundSystem = $.tag($.state(null), 'backgroundSystem');
	let canvas = null;
	let ctx = null;

	function initializeBackgroundSystem() {
		if (browser && !$.get(backgroundSystem)) {
			try {
				$.set(
					backgroundSystem,
					BackgroundFactory.createBackgroundSystem({
						type: $.get(backgroundType),
						initialQuality: $.get(qualityLevel)
					}),
					true
				);
			} catch(error) {
				console.error(...$.log_if_contains_state('error', "[SYSTEM] Error creating initial background system:", error));

				try {
					$.set(
						backgroundSystem,
						BackgroundFactory.createBackgroundSystem({
							type: BackgroundType.NIGHT_SKY,
							initialQuality: $.get(qualityLevel)
						}),
						true
					);
				} catch(fallbackError) {
					console.error(...$.log_if_contains_state('error', "[SYSTEM] Error creating fallback background system:", fallbackError));
				}
			}
		}
	}

	initializeBackgroundSystem();

	let animationFrameId = null;
	let reportCallback = null;

	function loadPreferences() {
		if (!browser) return;

		try {
			const savedPrefs = localStorage.getItem("background-preferences");

			if (savedPrefs) {
				const prefs = JSON.parse(savedPrefs);
				const currentBackgroundType = $.get(backgroundType);
				const currentQualityLevel = $.get(qualityLevel);

				if (prefs.backgroundType && $.strict_equals(prefs.backgroundType, currentBackgroundType, false)) {
					$.set(backgroundType, prefs.backgroundType, true);
				}

				if (prefs.qualityLevel && $.strict_equals(prefs.qualityLevel, currentQualityLevel, false)) {
					$.set(qualityLevel, prefs.qualityLevel, true);
				}
			}
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "Failed to load background preferences:", error));
		}
	}

	function savePreferences() {
		if (!browser) return;

		try {
			const prefs = {
				backgroundType: $.get(backgroundType),
				qualityLevel: $.get(qualityLevel)
			};

			localStorage.setItem("background-preferences", JSON.stringify(prefs));
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "Failed to save background preferences:", error));
		}
	}

	function createAndInitializeBackgroundSystem(type, quality) {
		if ($.get(backgroundSystem)) {
			$.get(backgroundSystem).cleanup();
		}

		try {
			const newSystem = BackgroundFactory.createBackgroundSystem({ type, initialQuality: quality });

			if ($.get(isInitialized) && canvas && ctx) {
				newSystem.initialize($.get(dimensions), quality);
			}

			$.set(backgroundSystem, newSystem, true);
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "[SYSTEM] Error creating background system:", error));

			if ($.strict_equals(type, BackgroundType.NIGHT_SKY, false)) {
				try {
					const fallbackSystem = BackgroundFactory.createBackgroundSystem({ type: BackgroundType.NIGHT_SKY, initialQuality: quality });

					if ($.get(isInitialized) && canvas && ctx) {
						fallbackSystem.initialize($.get(dimensions), quality);
					}

					$.set(backgroundSystem, fallbackSystem, true);
				} catch(fallbackError) {
					console.error(...$.log_if_contains_state('error', "[SYSTEM] Error creating fallback background system:", fallbackError));
				}
			}
		}
	}

	const performanceTracker = PerformanceTracker.getInstance();

	function initializeCanvas(canvasElement, onReady) {
		canvas = canvasElement;
		ctx = canvas.getContext("2d");

		if (!ctx) {
			return;
		}

		const initialWidth = browser ? window.innerWidth : 1280;
		const initialHeight = browser ? window.innerHeight : 720;

		$.set(dimensions, { width: initialWidth, height: initialHeight }, true);
		canvas.width = initialWidth;
		canvas.height = initialHeight;

		if (browser) {
			window.addEventListener("resize", handleResize);
			document.addEventListener("visibilitychange", handleVisibilityChange);
		}

		$.set(isInitialized, true);

		if ($.get(backgroundSystem)) {
			$.get(backgroundSystem).initialize($.get(dimensions), $.get(qualityLevel));
		}

		if (onReady) {
			onReady();
		}
	}

	function startAnimation(renderFn, reportFn) {
		if (!ctx || !canvas) {
			return;
		}

		if (reportFn) {
			reportCallback = reportFn;
		}

		performanceTracker.reset();

		const animate = () => {
			if (!ctx || !canvas) return;

			performanceTracker.update();

			const perfStatus = performanceTracker.getPerformanceStatus();

			$.set(performanceMetrics, { fps: perfStatus.fps, warnings: perfStatus.warnings }, true);

			if (reportCallback) {
				reportCallback($.get(performanceMetrics));
			}

			const shouldRenderNow = $.get(isActive) && perfStatus.fps > 30;

			if (shouldRenderNow) {
				ctx.clearRect(0, 0, $.get(dimensions).width, $.get(dimensions).height);
				renderFn(ctx, $.get(dimensions));
			}

			animationFrameId = requestAnimationFrame(animate);
		};

		if (browser) {
			animationFrameId = requestAnimationFrame(animate);
		}
	}

	function stopAnimation() {
		if (animationFrameId && browser) {
			cancelAnimationFrame(animationFrameId);
			animationFrameId = null;
		}
	}

	function cleanup() {
		stopAnimation();

		if (browser) {
			window.removeEventListener("resize", handleResize);
			document.removeEventListener("visibilitychange", handleVisibilityChange);
		}

		if ($.get(backgroundSystem)) {
			$.get(backgroundSystem).cleanup();
		}

		canvas = null;
		ctx = null;
	}

	function setQuality(quality) {
		$.set(qualityLevel, quality, true);

		if ($.get(backgroundSystem)) {
			$.get(backgroundSystem).setQuality(quality);
		}

		savePreferences();
	}

	function setLoading(loading) {
		$.set(isLoading, loading, true);
	}

	function setBackgroundType(type) {
		$.set(backgroundType, type, true);
		createAndInitializeBackgroundSystem(type, $.get(qualityLevel));
		savePreferences();
	}

	function handleResize() {
		if (!canvas) return;
		if (!browser) return;

		const newWidth = window.innerWidth;
		const newHeight = window.innerHeight;

		canvas.width = newWidth;
		canvas.height = newHeight;
		$.set(dimensions, { width: newWidth, height: newHeight }, true);

		const currentQuality = $.get(qualityLevel);

		$.set(qualityLevel, "low");

		setTimeout(
			() => {
				setQuality(currentQuality);
			},
			500
		);
	}

	function handleVisibilityChange() {
		if (!browser) return;

		const isVisible = $.strict_equals(document.visibilityState, "visible");

		$.set(isActive, isVisible);
	}

	if (browser) {
		loadPreferences();
	}

	contextInstances.add(contextId);

	return {
		// State getters (reactive)
		get dimensions() {
			return $.get(dimensions);
		},

		get performanceMetrics() {
			return $.get(performanceMetrics);
		},

		get isActive() {
			return $.get(isActive);
		},

		get qualityLevel() {
			return $.get(qualityLevel);
		},

		get isLoading() {
			return $.get(isLoading);
		},

		get backgroundType() {
			return $.get(backgroundType);
		},

		get isInitialized() {
			return $.get(isInitialized);
		},

		get shouldRender() {
			return $.get(shouldRender);
		},

		get backgroundSystem() {
			return $.get(backgroundSystem);
		},

		// Actions
		initializeCanvas,

		startAnimation,
		stopAnimation,
		setQuality,
		setLoading,
		setBackgroundType,
		cleanup,
		savePreferences,
		loadPreferences
	};
}

function createMockRunesBackgroundContext() {
	return {
		dimensions: { width: 0, height: 0 },
		performanceMetrics: { fps: 60, warnings: [] },
		isActive: true,
		qualityLevel: "medium",
		isLoading: false,
		backgroundType: BackgroundType.NIGHT_SKY,
		isInitialized: false,
		shouldRender: true,
		backgroundSystem: null,
		initializeCanvas: () => {},
		startAnimation: () => {},
		stopAnimation: () => {},
		setQuality: () => {},
		setLoading: () => {},
		setBackgroundType: () => {},
		cleanup: () => {},
		savePreferences: () => {},
		loadPreferences: () => {}
	};
}

export function setRunesBackgroundContext() {
	const context = createRunesBackgroundContext();

	setContext(BACKGROUND_CONTEXT_KEY, context);

	return context;
}

export function getRunesBackgroundContext() {
	const context = getContext(BACKGROUND_CONTEXT_KEY);

	if (!context) {
		throw new Error("No runes background context found. Make sure to use BackgroundProvider. This can happen during HMR - try refreshing the page.");
	}

	return context;
}
//# sourceMappingURL=data:application/json;base64,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a0IsQ0FBQztFQUNuQix5QkFBeUIsQ0FBQztFQUMxQixlQUFlLENBQUM7RUFDaEIsdUJBQXVCLENBQUM7RUFDeEIsdUJBQXVCLENBQUM7O0FBRTVCOztnQkFLZ0IsNEJBQW9EO09BQzVELFVBQVU7O0NBQ2hCLFdBQVcsd0JBQXdCLE9BQU87O1FBQ25DO0FBQ1Q7O2dCQUtnQiw0QkFBb0Q7T0FDNUQsVUFBVSxXQUFtQyxzQkFBc0I7O01BRXBFLFNBQVM7WUFDRixNQUNSO0NBRUo7O1FBRU87QUFDVCIsIm5hbWVzIjpbXSwiaWdub3JlTGlzdCI6W10sInNvdXJjZXMiOlsiQmFja2dyb3VuZENvbnRleHQuc3ZlbHRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogU3ZlbHRlIDUgUnVuZXMgSW50ZWdyYXRpb24gZm9yIEJhY2tncm91bmQgQ29udGV4dFxuICpcbiAqIFRoaXMgbW9kdWxlIHByb3ZpZGVzIHV0aWxpdGllcyBmb3IgaW50ZWdyYXRpbmcgdGhlIGJhY2tncm91bmQgY29udGV4dFxuICogd2l0aCBTdmVsdGUgNSBydW5lcy4gVGhpcyBmaWxlIGhhcyBhIC5zdmVsdGUudHMgZXh0ZW5zaW9uIHRvIGVuYWJsZSBydW5lcyBzdXBwb3J0LlxuICovXG5cbmltcG9ydCB7IGJyb3dzZXIgfSBmcm9tIFwiJGFwcC9lbnZpcm9ubWVudFwiO1xuaW1wb3J0IHsgZ2V0Q29udGV4dCwgc2V0Q29udGV4dCB9IGZyb20gXCJzdmVsdGVcIjtcbmltcG9ydCB7IGRldGVjdEFwcHJvcHJpYXRlUXVhbGl0eSB9IGZyb20gXCIuLi9jb25maWdcIjtcbmltcG9ydCB7IEJhY2tncm91bmRGYWN0b3J5IH0gZnJvbSBcIi4uL2NvcmUvQmFja2dyb3VuZEZhY3RvcnlcIjtcbmltcG9ydCB7IFBlcmZvcm1hbmNlVHJhY2tlciB9IGZyb20gXCIuLi9jb3JlL1BlcmZvcm1hbmNlVHJhY2tlclwiO1xuaW1wb3J0IHtcbiAgQmFja2dyb3VuZFR5cGUsXG4gIHR5cGUgQmFja2dyb3VuZFN5c3RlbSxcbiAgdHlwZSBEaW1lbnNpb25zLFxuICB0eXBlIFBlcmZvcm1hbmNlTWV0cmljcyxcbiAgdHlwZSBRdWFsaXR5TGV2ZWwsXG59IGZyb20gXCIuLi90eXBlcy90eXBlc1wiO1xuXG4vLyBUaGUgY29udGV4dCBrZXlcbmNvbnN0IEJBQ0tHUk9VTkRfQ09OVEVYVF9LRVkgPSBcImJhY2tncm91bmQtY29udGV4dC1ydW5lc1wiO1xuXG4vKipcbiAqIEludGVyZmFjZSBmb3IgdGhlIHJ1bmVzLWJhc2VkIGJhY2tncm91bmQgY29udGV4dFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJ1bmVzQmFja2dyb3VuZENvbnRleHQge1xuICAvLyBTdGF0ZVxuICBkaW1lbnNpb25zOiBEaW1lbnNpb25zO1xuICBwZXJmb3JtYW5jZU1ldHJpY3M6IFBlcmZvcm1hbmNlTWV0cmljcztcbiAgaXNBY3RpdmU6IGJvb2xlYW47XG4gIHF1YWxpdHlMZXZlbDogUXVhbGl0eUxldmVsO1xuICBpc0xvYWRpbmc6IGJvb2xlYW47XG4gIGJhY2tncm91bmRUeXBlOiBCYWNrZ3JvdW5kVHlwZTtcbiAgaXNJbml0aWFsaXplZDogYm9vbGVhbjtcbiAgc2hvdWxkUmVuZGVyOiBib29sZWFuO1xuICBiYWNrZ3JvdW5kU3lzdGVtOiBCYWNrZ3JvdW5kU3lzdGVtIHwgbnVsbDtcblxuICAvLyBNZXRob2RzXG4gIGluaXRpYWxpemVDYW52YXM6IChjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50LCBvblJlYWR5PzogKCkgPT4gdm9pZCkgPT4gdm9pZDtcbiAgc3RhcnRBbmltYXRpb246IChcbiAgICByZW5kZXJGbjogKGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELCBkaW1lbnNpb25zOiBEaW1lbnNpb25zKSA9PiB2b2lkLFxuICAgIHJlcG9ydEZuPzogKG1ldHJpY3M6IFBlcmZvcm1hbmNlTWV0cmljcykgPT4gdm9pZFxuICApID0+IHZvaWQ7XG4gIHN0b3BBbmltYXRpb246ICgpID0+IHZvaWQ7XG4gIHNldFF1YWxpdHk6IChxdWFsaXR5OiBRdWFsaXR5TGV2ZWwpID0+IHZvaWQ7XG4gIHNldExvYWRpbmc6IChpc0xvYWRpbmc6IGJvb2xlYW4pID0+IHZvaWQ7XG4gIHNldEJhY2tncm91bmRUeXBlOiAodHlwZTogQmFja2dyb3VuZFR5cGUpID0+IHZvaWQ7XG4gIGNsZWFudXA6ICgpID0+IHZvaWQ7XG5cbiAgLy8gU3RhdGUgcGVyc2lzdGVuY2VcbiAgc2F2ZVByZWZlcmVuY2VzOiAoKSA9PiB2b2lkO1xuICBsb2FkUHJlZmVyZW5jZXM6ICgpID0+IHZvaWQ7XG59XG5cbi8vIFRyYWNrIGNyZWF0ZWQgY29udGV4dCBpbnN0YW5jZXMgdG8gcHJldmVudCBkdXBsaWNhdGVzXG5jb25zdCBjb250ZXh0SW5zdGFuY2VzID0gbmV3IFNldCgpO1xuXG4vKipcbiAqIENyZWF0ZSBhIG5ldyBiYWNrZ3JvdW5kIGNvbnRleHQgdXNpbmcgU3ZlbHRlIDUgcnVuZXNcbiAqXG4gKiBUaGlzIGZ1bmN0aW9uIGNyZWF0ZXMgYSBuZXcgYmFja2dyb3VuZCBjb250ZXh0IHVzaW5nIFN2ZWx0ZSA1J3MgcnVuZXMgc3lzdGVtXG4gKiBmb3IgcmVhY3RpdmUgc3RhdGUgbWFuYWdlbWVudC4gSXQgcHJvdmlkZXMgdGhlIHNhbWUgQVBJIGFzIHRoZSBvcmlnaW5hbCBjb250ZXh0XG4gKiBidXQgdXNlcyBydW5lcyBpbnN0ZWFkIG9mIHN0b3Jlcy5cbiAqXG4gKiBAcmV0dXJucyBBIHJ1bmVzLWJhc2VkIGJhY2tncm91bmQgY29udGV4dFxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUnVuZXNCYWNrZ3JvdW5kQ29udGV4dCgpOiBSdW5lc0JhY2tncm91bmRDb250ZXh0IHtcbiAgLy8gU2tpcCBicm93c2VyLXNwZWNpZmljIGluaXRpYWxpemF0aW9uIGR1cmluZyBTU1JcbiAgaWYgKCFicm93c2VyKSB7XG4gICAgcmV0dXJuIGNyZWF0ZU1vY2tSdW5lc0JhY2tncm91bmRDb250ZXh0KCk7XG4gIH1cblxuICAvLyBEZWJ1ZyBjb3VudGVyIHRvIHRyYWNrIGNvbnRleHQgY3JlYXRpb25cbiAgY29uc3QgY29udGV4dElkID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTAwMDApO1xuXG4gIC8vIEVuc3VyZSB3ZSBkb24ndCBjcmVhdGUgZHVwbGljYXRlIGNvbnRleHRzXG4gIGlmIChjb250ZXh0SW5zdGFuY2VzLnNpemUgPiAwKSB7XG4gICAgLy8gVHJ5IHRvIGdldCBleGlzdGluZyBjb250ZXh0LCBidXQgZG9uJ3QgdGhyb3cgZHVyaW5nIEhNUlxuICAgIHRyeSB7XG4gICAgICBjb25zdCBleGlzdGluZ0NvbnRleHQgPSBnZXRSdW5lc0JhY2tncm91bmRDb250ZXh0KCk7XG4gICAgICBpZiAoZXhpc3RpbmdDb250ZXh0KSB7XG4gICAgICAgIHJldHVybiBleGlzdGluZ0NvbnRleHQ7XG4gICAgICB9XG4gICAgfSBjYXRjaCB7XG4gICAgICAvLyBDb250ZXh0IG5vdCBmb3VuZCAobGlrZWx5IGR1ZSB0byBITVIpLCBjb250aW51ZSB3aXRoIGNyZWF0aW5nIG5ldyBvbmVcbiAgICAgIGNvbnRleHRJbnN0YW5jZXMuY2xlYXIoKTsgLy8gQ2xlYXIgc3RhbGUgaW5zdGFuY2VzXG4gICAgfVxuICB9XG5cbiAgLy8gSW5pdGlhbGl6ZSBzdGF0ZSB3aXRoIHJ1bmVzIC0gdXNlIGV4cGxpY2l0IGluaXRpYWwgdmFsdWVzIHRvIGF2b2lkIHVuZGVmaW5lZFxuICBsZXQgZGltZW5zaW9ucyA9ICRzdGF0ZTxEaW1lbnNpb25zPih7IHdpZHRoOiAwLCBoZWlnaHQ6IDAgfSk7XG4gIGxldCBwZXJmb3JtYW5jZU1ldHJpY3MgPSAkc3RhdGU8UGVyZm9ybWFuY2VNZXRyaWNzPih7XG4gICAgZnBzOiA2MCxcbiAgICB3YXJuaW5nczogW10sXG4gIH0pO1xuICBsZXQgaXNBY3RpdmUgPSAkc3RhdGUodHJ1ZSk7XG4gIGxldCBxdWFsaXR5TGV2ZWwgPSAkc3RhdGU8UXVhbGl0eUxldmVsPihkZXRlY3RBcHByb3ByaWF0ZVF1YWxpdHkoKSk7XG4gIGxldCBpc0xvYWRpbmcgPSAkc3RhdGUoZmFsc2UpO1xuICBsZXQgYmFja2dyb3VuZFR5cGUgPSAkc3RhdGU8QmFja2dyb3VuZFR5cGU+KEJhY2tncm91bmRUeXBlLk5JR0hUX1NLWSk7XG4gIGxldCBpc0luaXRpYWxpemVkID0gJHN0YXRlKGZhbHNlKTtcblxuICAvLyBEZXJpdmVkIHZhbHVlc1xuICBjb25zdCBzaG91bGRSZW5kZXIgPSAkZGVyaXZlZChpc0FjdGl2ZSAmJiBwZXJmb3JtYW5jZU1ldHJpY3MuZnBzID4gMzApO1xuXG4gIC8vIENyZWF0ZSBiYWNrZ3JvdW5kIHN5c3RlbSBiYXNlZCBvbiB0eXBlIGFuZCBxdWFsaXR5XG4gIGxldCBiYWNrZ3JvdW5kU3lzdGVtID0gJHN0YXRlPEJhY2tncm91bmRTeXN0ZW0gfCBudWxsPihudWxsKTtcblxuICAvLyBDYW52YXMgYW5kIGNvbnRleHQgcmVmZXJlbmNlc1xuICBsZXQgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCB8IG51bGwgPSBudWxsO1xuICBsZXQgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQgfCBudWxsID0gbnVsbDtcblxuICAvLyBJbml0aWFsaXplIGJhY2tncm91bmQgc3lzdGVtXG4gIGZ1bmN0aW9uIGluaXRpYWxpemVCYWNrZ3JvdW5kU3lzdGVtKCkge1xuICAgIGlmIChicm93c2VyICYmICFiYWNrZ3JvdW5kU3lzdGVtKSB7XG4gICAgICB0cnkge1xuICAgICAgICBiYWNrZ3JvdW5kU3lzdGVtID0gQmFja2dyb3VuZEZhY3RvcnkuY3JlYXRlQmFja2dyb3VuZFN5c3RlbSh7XG4gICAgICAgICAgdHlwZTogYmFja2dyb3VuZFR5cGUsXG4gICAgICAgICAgaW5pdGlhbFF1YWxpdHk6IHF1YWxpdHlMZXZlbCxcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAgIFwiW1NZU1RFTV0gRXJyb3IgY3JlYXRpbmcgaW5pdGlhbCBiYWNrZ3JvdW5kIHN5c3RlbTpcIixcbiAgICAgICAgICBlcnJvclxuICAgICAgICApO1xuICAgICAgICAvLyBUcnkgZmFsbGJhY2tcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBiYWNrZ3JvdW5kU3lzdGVtID0gQmFja2dyb3VuZEZhY3RvcnkuY3JlYXRlQmFja2dyb3VuZFN5c3RlbSh7XG4gICAgICAgICAgICB0eXBlOiBCYWNrZ3JvdW5kVHlwZS5OSUdIVF9TS1ksXG4gICAgICAgICAgICBpbml0aWFsUXVhbGl0eTogcXVhbGl0eUxldmVsLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChmYWxsYmFja0Vycm9yKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihcbiAgICAgICAgICAgIFwiW1NZU1RFTV0gRXJyb3IgY3JlYXRpbmcgZmFsbGJhY2sgYmFja2dyb3VuZCBzeXN0ZW06XCIsXG4gICAgICAgICAgICBmYWxsYmFja0Vycm9yXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIEluaXRpYWxpemUgb24gZmlyc3QgbG9hZFxuICBpbml0aWFsaXplQmFja2dyb3VuZFN5c3RlbSgpO1xuICBsZXQgYW5pbWF0aW9uRnJhbWVJZDogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gIGxldCByZXBvcnRDYWxsYmFjazogKChtZXRyaWNzOiBQZXJmb3JtYW5jZU1ldHJpY3MpID0+IHZvaWQpIHwgbnVsbCA9IG51bGw7XG5cbiAgLy8gTG9hZCBwcmVmZXJlbmNlcyBmcm9tIGxvY2FsU3RvcmFnZVxuICBmdW5jdGlvbiBsb2FkUHJlZmVyZW5jZXMoKSB7XG4gICAgaWYgKCFicm93c2VyKSByZXR1cm47XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2F2ZWRQcmVmcyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFwiYmFja2dyb3VuZC1wcmVmZXJlbmNlc1wiKTtcbiAgICAgIGlmIChzYXZlZFByZWZzKSB7XG4gICAgICAgIGNvbnN0IHByZWZzID0gSlNPTi5wYXJzZShzYXZlZFByZWZzKTtcblxuICAgICAgICAvLyBPbmx5IHVwZGF0ZSBpZiB2YWx1ZXMgYXJlIGRpZmZlcmVudCB0byBwcmV2ZW50IHRyaWdnZXJpbmcgZWZmZWN0c1xuICAgICAgICBjb25zdCBjdXJyZW50QmFja2dyb3VuZFR5cGUgPSBiYWNrZ3JvdW5kVHlwZTtcbiAgICAgICAgY29uc3QgY3VycmVudFF1YWxpdHlMZXZlbCA9IHF1YWxpdHlMZXZlbDtcblxuICAgICAgICBpZiAoXG4gICAgICAgICAgcHJlZnMuYmFja2dyb3VuZFR5cGUgJiZcbiAgICAgICAgICBwcmVmcy5iYWNrZ3JvdW5kVHlwZSAhPT0gY3VycmVudEJhY2tncm91bmRUeXBlXG4gICAgICAgICkge1xuICAgICAgICAgIGJhY2tncm91bmRUeXBlID0gcHJlZnMuYmFja2dyb3VuZFR5cGU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocHJlZnMucXVhbGl0eUxldmVsICYmIHByZWZzLnF1YWxpdHlMZXZlbCAhPT0gY3VycmVudFF1YWxpdHlMZXZlbCkge1xuICAgICAgICAgIHF1YWxpdHlMZXZlbCA9IHByZWZzLnF1YWxpdHlMZXZlbDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIGxvYWQgYmFja2dyb3VuZCBwcmVmZXJlbmNlczpcIiwgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8vIFNhdmUgcHJlZmVyZW5jZXMgdG8gbG9jYWxTdG9yYWdlXG4gIGZ1bmN0aW9uIHNhdmVQcmVmZXJlbmNlcygpIHtcbiAgICBpZiAoIWJyb3dzZXIpIHJldHVybjtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBwcmVmcyA9IHtcbiAgICAgICAgYmFja2dyb3VuZFR5cGUsXG4gICAgICAgIHF1YWxpdHlMZXZlbCxcbiAgICAgIH07XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShcImJhY2tncm91bmQtcHJlZmVyZW5jZXNcIiwgSlNPTi5zdHJpbmdpZnkocHJlZnMpKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBzYXZlIGJhY2tncm91bmQgcHJlZmVyZW5jZXM6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvLyBGdW5jdGlvbiB0byBjcmVhdGUgYW5kIGluaXRpYWxpemUgdGhlIGJhY2tncm91bmQgc3lzdGVtXG4gIGZ1bmN0aW9uIGNyZWF0ZUFuZEluaXRpYWxpemVCYWNrZ3JvdW5kU3lzdGVtKFxuICAgIHR5cGU6IEJhY2tncm91bmRUeXBlLFxuICAgIHF1YWxpdHk6IFF1YWxpdHlMZXZlbFxuICApOiB2b2lkIHtcbiAgICBpZiAoYmFja2dyb3VuZFN5c3RlbSkge1xuICAgICAgYmFja2dyb3VuZFN5c3RlbS5jbGVhbnVwKCk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG5ld1N5c3RlbSA9IEJhY2tncm91bmRGYWN0b3J5LmNyZWF0ZUJhY2tncm91bmRTeXN0ZW0oe1xuICAgICAgICB0eXBlLFxuICAgICAgICBpbml0aWFsUXVhbGl0eTogcXVhbGl0eSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBJbml0aWFsaXplIGlmIGNhbnZhcyBpcyBhbHJlYWR5IHNldCB1cFxuICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgJiYgY2FudmFzICYmIGN0eCkge1xuICAgICAgICBuZXdTeXN0ZW0uaW5pdGlhbGl6ZShkaW1lbnNpb25zLCBxdWFsaXR5KTtcbiAgICAgIH1cblxuICAgICAgLy8gU2V0IHRoZSBiYWNrZ3JvdW5kIHN5c3RlbVxuICAgICAgYmFja2dyb3VuZFN5c3RlbSA9IG5ld1N5c3RlbTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIltTWVNURU1dIEVycm9yIGNyZWF0aW5nIGJhY2tncm91bmQgc3lzdGVtOlwiLCBlcnJvcik7XG5cbiAgICAgIC8vIEZhbGxiYWNrIHRvIG5pZ2h0U2t5IGlmIHRoZXJlJ3MgYW4gZXJyb3Igd2l0aCB0aGUgcmVxdWVzdGVkIGJhY2tncm91bmRcbiAgICAgIGlmICh0eXBlICE9PSBCYWNrZ3JvdW5kVHlwZS5OSUdIVF9TS1kpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBmYWxsYmFja1N5c3RlbSA9IEJhY2tncm91bmRGYWN0b3J5LmNyZWF0ZUJhY2tncm91bmRTeXN0ZW0oe1xuICAgICAgICAgICAgdHlwZTogQmFja2dyb3VuZFR5cGUuTklHSFRfU0tZLFxuICAgICAgICAgICAgaW5pdGlhbFF1YWxpdHk6IHF1YWxpdHksXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBpZiAoaXNJbml0aWFsaXplZCAmJiBjYW52YXMgJiYgY3R4KSB7XG4gICAgICAgICAgICBmYWxsYmFja1N5c3RlbS5pbml0aWFsaXplKGRpbWVuc2lvbnMsIHF1YWxpdHkpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGJhY2tncm91bmRTeXN0ZW0gPSBmYWxsYmFja1N5c3RlbTtcbiAgICAgICAgfSBjYXRjaCAoZmFsbGJhY2tFcnJvcikge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICAgICBcIltTWVNURU1dIEVycm9yIGNyZWF0aW5nIGZhbGxiYWNrIGJhY2tncm91bmQgc3lzdGVtOlwiLFxuICAgICAgICAgICAgZmFsbGJhY2tFcnJvclxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBSZW1vdmUgcHJvYmxlbWF0aWMgZWZmZWN0cyB0aGF0IGNhdXNlIGNpcmN1bGFyIGRlcGVuZGVuY2llc1xuICAvLyBJbnN0ZWFkLCB3ZSdsbCBoYW5kbGUgdXBkYXRlcyB0aHJvdWdoIHRoZSBzZXR0ZXIgbWV0aG9kc1xuXG4gIC8vIEluaXRpYWxpemUgcGVyZm9ybWFuY2UgdHJhY2tlclxuICBjb25zdCBwZXJmb3JtYW5jZVRyYWNrZXIgPSBQZXJmb3JtYW5jZVRyYWNrZXIuZ2V0SW5zdGFuY2UoKTtcblxuICAvLyBBY3Rpb25zXG4gIGZ1bmN0aW9uIGluaXRpYWxpemVDYW52YXMoXG4gICAgY2FudmFzRWxlbWVudDogSFRNTENhbnZhc0VsZW1lbnQsXG4gICAgb25SZWFkeT86ICgpID0+IHZvaWRcbiAgKTogdm9pZCB7XG4gICAgY2FudmFzID0gY2FudmFzRWxlbWVudDtcbiAgICBjdHggPSBjYW52YXMuZ2V0Q29udGV4dChcIjJkXCIpO1xuXG4gICAgaWYgKCFjdHgpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBpbml0aWFsV2lkdGggPSBicm93c2VyID8gd2luZG93LmlubmVyV2lkdGggOiAxMjgwO1xuICAgIGNvbnN0IGluaXRpYWxIZWlnaHQgPSBicm93c2VyID8gd2luZG93LmlubmVySGVpZ2h0IDogNzIwO1xuXG4gICAgZGltZW5zaW9ucyA9IHsgd2lkdGg6IGluaXRpYWxXaWR0aCwgaGVpZ2h0OiBpbml0aWFsSGVpZ2h0IH07XG5cbiAgICBjYW52YXMud2lkdGggPSBpbml0aWFsV2lkdGg7XG4gICAgY2FudmFzLmhlaWdodCA9IGluaXRpYWxIZWlnaHQ7XG5cbiAgICBpZiAoYnJvd3Nlcikge1xuICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJyZXNpemVcIiwgaGFuZGxlUmVzaXplKTtcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJ2aXNpYmlsaXR5Y2hhbmdlXCIsIGhhbmRsZVZpc2liaWxpdHlDaGFuZ2UpO1xuICAgIH1cblxuICAgIGlzSW5pdGlhbGl6ZWQgPSB0cnVlO1xuXG4gICAgLy8gSW5pdGlhbGl6ZSB0aGUgYmFja2dyb3VuZCBzeXN0ZW0gaWYgaXQgZXhpc3RzXG4gICAgaWYgKGJhY2tncm91bmRTeXN0ZW0pIHtcbiAgICAgIGJhY2tncm91bmRTeXN0ZW0uaW5pdGlhbGl6ZShkaW1lbnNpb25zLCBxdWFsaXR5TGV2ZWwpO1xuICAgIH1cblxuICAgIGlmIChvblJlYWR5KSB7XG4gICAgICBvblJlYWR5KCk7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gc3RhcnRBbmltYXRpb24oXG4gICAgcmVuZGVyRm46IChjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCwgZGltZW5zaW9uczogRGltZW5zaW9ucykgPT4gdm9pZCxcbiAgICByZXBvcnRGbj86IChtZXRyaWNzOiBQZXJmb3JtYW5jZU1ldHJpY3MpID0+IHZvaWRcbiAgKTogdm9pZCB7XG4gICAgaWYgKCFjdHggfHwgIWNhbnZhcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChyZXBvcnRGbikge1xuICAgICAgcmVwb3J0Q2FsbGJhY2sgPSByZXBvcnRGbjtcbiAgICB9XG5cbiAgICBwZXJmb3JtYW5jZVRyYWNrZXIucmVzZXQoKTtcblxuICAgIGNvbnN0IGFuaW1hdGUgPSAoKSA9PiB7XG4gICAgICBpZiAoIWN0eCB8fCAhY2FudmFzKSByZXR1cm47XG5cbiAgICAgIHBlcmZvcm1hbmNlVHJhY2tlci51cGRhdGUoKTtcblxuICAgICAgY29uc3QgcGVyZlN0YXR1cyA9IHBlcmZvcm1hbmNlVHJhY2tlci5nZXRQZXJmb3JtYW5jZVN0YXR1cygpO1xuICAgICAgcGVyZm9ybWFuY2VNZXRyaWNzID0ge1xuICAgICAgICBmcHM6IHBlcmZTdGF0dXMuZnBzLFxuICAgICAgICB3YXJuaW5nczogcGVyZlN0YXR1cy53YXJuaW5ncyxcbiAgICAgIH07XG5cbiAgICAgIGlmIChyZXBvcnRDYWxsYmFjaykge1xuICAgICAgICByZXBvcnRDYWxsYmFjayhwZXJmb3JtYW5jZU1ldHJpY3MpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzaG91bGRSZW5kZXJOb3cgPSBpc0FjdGl2ZSAmJiBwZXJmU3RhdHVzLmZwcyA+IDMwO1xuXG4gICAgICBpZiAoc2hvdWxkUmVuZGVyTm93KSB7XG4gICAgICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgZGltZW5zaW9ucy53aWR0aCwgZGltZW5zaW9ucy5oZWlnaHQpO1xuICAgICAgICByZW5kZXJGbihjdHgsIGRpbWVuc2lvbnMpO1xuICAgICAgfVxuXG4gICAgICBhbmltYXRpb25GcmFtZUlkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpO1xuICAgIH07XG5cbiAgICBpZiAoYnJvd3Nlcikge1xuICAgICAgYW5pbWF0aW9uRnJhbWVJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBzdG9wQW5pbWF0aW9uKCk6IHZvaWQge1xuICAgIGlmIChhbmltYXRpb25GcmFtZUlkICYmIGJyb3dzZXIpIHtcbiAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKGFuaW1hdGlvbkZyYW1lSWQpO1xuICAgICAgYW5pbWF0aW9uRnJhbWVJZCA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gY2xlYW51cCgpOiB2b2lkIHtcbiAgICBzdG9wQW5pbWF0aW9uKCk7XG5cbiAgICBpZiAoYnJvd3Nlcikge1xuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJyZXNpemVcIiwgaGFuZGxlUmVzaXplKTtcbiAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJ2aXNpYmlsaXR5Y2hhbmdlXCIsIGhhbmRsZVZpc2liaWxpdHlDaGFuZ2UpO1xuICAgIH1cblxuICAgIGlmIChiYWNrZ3JvdW5kU3lzdGVtKSB7XG4gICAgICBiYWNrZ3JvdW5kU3lzdGVtLmNsZWFudXAoKTtcbiAgICB9XG5cbiAgICBjYW52YXMgPSBudWxsO1xuICAgIGN0eCA9IG51bGw7XG4gIH1cblxuICBmdW5jdGlvbiBzZXRRdWFsaXR5KHF1YWxpdHk6IFF1YWxpdHlMZXZlbCk6IHZvaWQge1xuICAgIHF1YWxpdHlMZXZlbCA9IHF1YWxpdHk7XG4gICAgaWYgKGJhY2tncm91bmRTeXN0ZW0pIHtcbiAgICAgIGJhY2tncm91bmRTeXN0ZW0uc2V0UXVhbGl0eShxdWFsaXR5KTtcbiAgICB9XG4gICAgc2F2ZVByZWZlcmVuY2VzKCk7XG4gIH1cblxuICBmdW5jdGlvbiBzZXRMb2FkaW5nKGxvYWRpbmc6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBpc0xvYWRpbmcgPSBsb2FkaW5nO1xuICB9XG5cbiAgZnVuY3Rpb24gc2V0QmFja2dyb3VuZFR5cGUodHlwZTogQmFja2dyb3VuZFR5cGUpOiB2b2lkIHtcbiAgICBiYWNrZ3JvdW5kVHlwZSA9IHR5cGU7XG4gICAgLy8gQ3JlYXRlIG5ldyBiYWNrZ3JvdW5kIHN5c3RlbSB3aXRoIHRoZSBuZXcgdHlwZVxuICAgIGNyZWF0ZUFuZEluaXRpYWxpemVCYWNrZ3JvdW5kU3lzdGVtKHR5cGUsIHF1YWxpdHlMZXZlbCk7XG4gICAgc2F2ZVByZWZlcmVuY2VzKCk7XG4gIH1cblxuICAvLyBJbnRlcm5hbCBoYW5kbGVyc1xuICBmdW5jdGlvbiBoYW5kbGVSZXNpemUoKTogdm9pZCB7XG4gICAgaWYgKCFjYW52YXMpIHJldHVybjtcbiAgICBpZiAoIWJyb3dzZXIpIHJldHVybjtcblxuICAgIGNvbnN0IG5ld1dpZHRoID0gd2luZG93LmlubmVyV2lkdGg7XG4gICAgY29uc3QgbmV3SGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuXG4gICAgY2FudmFzLndpZHRoID0gbmV3V2lkdGg7XG4gICAgY2FudmFzLmhlaWdodCA9IG5ld0hlaWdodDtcblxuICAgIGRpbWVuc2lvbnMgPSB7IHdpZHRoOiBuZXdXaWR0aCwgaGVpZ2h0OiBuZXdIZWlnaHQgfTtcblxuICAgIC8vIFRlbXBvcmFyaWx5IHJlZHVjZSBxdWFsaXR5IGR1cmluZyByZXNpemUgZm9yIGJldHRlciBwZXJmb3JtYW5jZVxuICAgIGNvbnN0IGN1cnJlbnRRdWFsaXR5ID0gcXVhbGl0eUxldmVsO1xuICAgIHF1YWxpdHlMZXZlbCA9IFwibG93XCI7XG5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHNldFF1YWxpdHkoY3VycmVudFF1YWxpdHkpO1xuICAgIH0sIDUwMCk7XG4gIH1cblxuICBmdW5jdGlvbiBoYW5kbGVWaXNpYmlsaXR5Q2hhbmdlKCk6IHZvaWQge1xuICAgIGlmICghYnJvd3NlcikgcmV0dXJuO1xuICAgIGNvbnN0IGlzVmlzaWJsZSA9IGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSA9PT0gXCJ2aXNpYmxlXCI7XG4gICAgaXNBY3RpdmUgPSBpc1Zpc2libGU7XG4gIH1cblxuICAvLyBMb2FkIHByZWZlcmVuY2VzIG9uIGluaXRpYWxpemF0aW9uXG4gIGlmIChicm93c2VyKSB7XG4gICAgbG9hZFByZWZlcmVuY2VzKCk7XG4gIH1cblxuICAvLyBNYXJrIGNvbnRleHQgYXMgY3JlYXRlZFxuICBjb250ZXh0SW5zdGFuY2VzLmFkZChjb250ZXh0SWQpO1xuXG4gIHJldHVybiB7XG4gICAgLy8gU3RhdGUgZ2V0dGVycyAocmVhY3RpdmUpXG4gICAgZ2V0IGRpbWVuc2lvbnMoKSB7XG4gICAgICByZXR1cm4gZGltZW5zaW9ucztcbiAgICB9LFxuICAgIGdldCBwZXJmb3JtYW5jZU1ldHJpY3MoKSB7XG4gICAgICByZXR1cm4gcGVyZm9ybWFuY2VNZXRyaWNzO1xuICAgIH0sXG4gICAgZ2V0IGlzQWN0aXZlKCkge1xuICAgICAgcmV0dXJuIGlzQWN0aXZlO1xuICAgIH0sXG4gICAgZ2V0IHF1YWxpdHlMZXZlbCgpIHtcbiAgICAgIHJldHVybiBxdWFsaXR5TGV2ZWw7XG4gICAgfSxcbiAgICBnZXQgaXNMb2FkaW5nKCkge1xuICAgICAgcmV0dXJuIGlzTG9hZGluZztcbiAgICB9LFxuICAgIGdldCBiYWNrZ3JvdW5kVHlwZSgpIHtcbiAgICAgIHJldHVybiBiYWNrZ3JvdW5kVHlwZTtcbiAgICB9LFxuICAgIGdldCBpc0luaXRpYWxpemVkKCkge1xuICAgICAgcmV0dXJuIGlzSW5pdGlhbGl6ZWQ7XG4gICAgfSxcbiAgICBnZXQgc2hvdWxkUmVuZGVyKCkge1xuICAgICAgcmV0dXJuIHNob3VsZFJlbmRlcjtcbiAgICB9LFxuICAgIGdldCBiYWNrZ3JvdW5kU3lzdGVtKCkge1xuICAgICAgcmV0dXJuIGJhY2tncm91bmRTeXN0ZW07XG4gICAgfSxcblxuICAgIC8vIEFjdGlvbnNcbiAgICBpbml0aWFsaXplQ2FudmFzLFxuICAgIHN0YXJ0QW5pbWF0aW9uLFxuICAgIHN0b3BBbmltYXRpb24sXG4gICAgc2V0UXVhbGl0eSxcbiAgICBzZXRMb2FkaW5nLFxuICAgIHNldEJhY2tncm91bmRUeXBlLFxuICAgIGNsZWFudXAsXG4gICAgc2F2ZVByZWZlcmVuY2VzLFxuICAgIGxvYWRQcmVmZXJlbmNlcyxcbiAgfTtcbn1cblxuLyoqXG4gKiBDcmVhdGUgYSBtb2NrIGJhY2tncm91bmQgY29udGV4dCBmb3IgU1NSXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZU1vY2tSdW5lc0JhY2tncm91bmRDb250ZXh0KCk6IFJ1bmVzQmFja2dyb3VuZENvbnRleHQge1xuICByZXR1cm4ge1xuICAgIGRpbWVuc2lvbnM6IHsgd2lkdGg6IDAsIGhlaWdodDogMCB9LFxuICAgIHBlcmZvcm1hbmNlTWV0cmljczogeyBmcHM6IDYwLCB3YXJuaW5nczogW10gfSxcbiAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICBxdWFsaXR5TGV2ZWw6IFwibWVkaXVtXCIsXG4gICAgaXNMb2FkaW5nOiBmYWxzZSxcbiAgICBiYWNrZ3JvdW5kVHlwZTogQmFja2dyb3VuZFR5cGUuTklHSFRfU0tZLFxuICAgIGlzSW5pdGlhbGl6ZWQ6IGZhbHNlLFxuICAgIHNob3VsZFJlbmRlcjogdHJ1ZSxcbiAgICBiYWNrZ3JvdW5kU3lzdGVtOiBudWxsLFxuICAgIGluaXRpYWxpemVDYW52YXM6ICgpID0+IHt9LFxuICAgIHN0YXJ0QW5pbWF0aW9uOiAoKSA9PiB7fSxcbiAgICBzdG9wQW5pbWF0aW9uOiAoKSA9PiB7fSxcbiAgICBzZXRRdWFsaXR5OiAoKSA9PiB7fSxcbiAgICBzZXRMb2FkaW5nOiAoKSA9PiB7fSxcbiAgICBzZXRCYWNrZ3JvdW5kVHlwZTogKCkgPT4ge30sXG4gICAgY2xlYW51cDogKCkgPT4ge30sXG4gICAgc2F2ZVByZWZlcmVuY2VzOiAoKSA9PiB7fSxcbiAgICBsb2FkUHJlZmVyZW5jZXM6ICgpID0+IHt9LFxuICB9O1xufVxuXG4vKipcbiAqIFNldCB0aGUgcnVuZXMtYmFzZWQgYmFja2dyb3VuZCBjb250ZXh0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZXRSdW5lc0JhY2tncm91bmRDb250ZXh0KCk6IFJ1bmVzQmFja2dyb3VuZENvbnRleHQge1xuICBjb25zdCBjb250ZXh0ID0gY3JlYXRlUnVuZXNCYWNrZ3JvdW5kQ29udGV4dCgpO1xuICBzZXRDb250ZXh0KEJBQ0tHUk9VTkRfQ09OVEVYVF9LRVksIGNvbnRleHQpO1xuICByZXR1cm4gY29udGV4dDtcbn1cblxuLyoqXG4gKiBHZXQgdGhlIHJ1bmVzLWJhc2VkIGJhY2tncm91bmQgY29udGV4dFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0UnVuZXNCYWNrZ3JvdW5kQ29udGV4dCgpOiBSdW5lc0JhY2tncm91bmRDb250ZXh0IHtcbiAgY29uc3QgY29udGV4dCA9IGdldENvbnRleHQ8UnVuZXNCYWNrZ3JvdW5kQ29udGV4dD4oQkFDS0dST1VORF9DT05URVhUX0tFWSk7XG5cbiAgaWYgKCFjb250ZXh0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgXCJObyBydW5lcyBiYWNrZ3JvdW5kIGNvbnRleHQgZm91bmQuIE1ha2Ugc3VyZSB0byB1c2UgQmFja2dyb3VuZFByb3ZpZGVyLiBUaGlzIGNhbiBoYXBwZW4gZHVyaW5nIEhNUiAtIHRyeSByZWZyZXNoaW5nIHRoZSBwYWdlLlwiXG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiBjb250ZXh0O1xufVxuIl0sImZpbGUiOiJGOi9DT0RFL1RLQS93ZWIvc3JjL2xpYi9jb21wb25lbnRzL2JhY2tncm91bmRzL2NvbnRleHRzL0JhY2tncm91bmRDb250ZXh0LnN2ZWx0ZS50cyJ9