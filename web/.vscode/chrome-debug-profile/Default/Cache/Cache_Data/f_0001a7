export class BeatRenderingService {
  constructor(pictographService) {
    this.pictographService = pictographService;
  }
  // Canvas pool for memory efficiency
  canvasPool = [];
  MAX_POOL_SIZE = 10;
  /**
   * Render a single beat to canvas
   * Converts SVG pictograph to canvas representation
   */
  async renderBeatToCanvas(beatData, size, options) {
    if (!beatData) {
      throw new Error("Beat data is required for rendering");
    }
    if (size <= 0) {
      throw new Error(`Invalid size: ${size}`);
    }
    try {
      const canvas = this.getCanvasFromPool(size, size);
      const ctx = canvas.getContext("2d");
      if (!ctx) {
        throw new Error("Failed to get 2D context from canvas");
      }
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, size, size);
      if (beatData.isBlank || !beatData.pictographData) {
        await this.renderEmptyBeat(ctx, beatData, size, options);
        return canvas;
      }
      await this.renderPictographToCanvas(ctx, beatData, size, options);
      this.applyPostProcessing(ctx, beatData, size, options);
      return canvas;
    } catch (error) {
      throw new Error(
        `Failed to render beat to canvas: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Render start position to canvas
   * Handles the special case of sequence start position
   */
  async renderStartPositionToCanvas(sequence, size, options) {
    if (!sequence) {
      throw new Error("Sequence data is required for start position rendering");
    }
    try {
      const canvas = this.getCanvasFromPool(size, size);
      const ctx = canvas.getContext("2d");
      if (!ctx) {
        throw new Error("Failed to get 2D context from canvas");
      }
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, size, size);
      if (sequence.startPosition) {
        await this.renderPictographToCanvas(
          ctx,
          { ...sequence.startPosition, beatNumber: 0 },
          size,
          options
        );
      } else {
        await this.renderDefaultStartPosition(ctx, size, options);
      }
      if (options.addBeatNumbers) {
        this.renderStartPositionLabel(ctx, size);
      }
      return canvas;
    } catch (error) {
      throw new Error(
        `Failed to render start position: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Batch render multiple beats
   * Optimized for rendering many beats efficiently
   */
  async renderBeatsToCanvases(beats, size, options) {
    if (!beats || beats.length === 0) {
      return [];
    }
    const canvases = [];
    try {
      const CHUNK_SIZE = 5;
      for (let i = 0; i < beats.length; i += CHUNK_SIZE) {
        const chunk = beats.slice(i, i + CHUNK_SIZE);
        const chunkCanvases = await Promise.all(
          chunk.map((beat) => this.renderBeatToCanvas(beat, size, options))
        );
        canvases.push(...chunkCanvases);
      }
      return canvases;
    } catch (error) {
      canvases.forEach((canvas) => this.returnCanvasToPool(canvas));
      throw new Error(
        `Batch rendering failed: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Apply visibility settings to rendered beat
   * Matches desktop visibility logic
   */
  applyVisibilitySettings(canvas, options) {
    if (options.redVisible && options.blueVisible) {
      return canvas;
    }
    const filteredCanvas = this.getCanvasFromPool(canvas.width, canvas.height);
    const filteredCtx = filteredCanvas.getContext("2d");
    if (!filteredCtx) {
      throw new Error("Failed to get 2D context from filtered canvas");
    }
    filteredCtx.drawImage(canvas, 0, 0);
    this.applyColorFilters(filteredCtx, canvas.width, canvas.height, options);
    this.returnCanvasToPool(canvas);
    return filteredCanvas;
  }
  /**
   * Render pictograph data to canvas context
   * Core rendering logic that converts pictograph to canvas
   */
  async renderPictographToCanvas(ctx, beatData, size, options) {
    if (!beatData.pictographData) {
      return;
    }
    try {
      const svgElement = await this.createSVGFromPictographData(
        beatData,
        size,
        options
      );
      if (svgElement) {
        await this.drawSVGToCanvas(ctx, svgElement, size, size);
        return;
      }
      await this.renderPictographManually(ctx, beatData, size, options);
    } catch (error) {
      console.warn("Pictograph rendering failed, using fallback:", error);
      await this.renderFallbackBeat(ctx, beatData, size, options);
    }
  }
  /**
   * Create SVG element from pictograph data
   * Uses the injected pictograph service instead of creating components directly
   */
  async createSVGFromPictographData(beatData, size, _options) {
    try {
      if (!beatData.pictographData) {
        return null;
      }
      const svgElement = await this.pictographService.renderPictograph(
        beatData.pictographData
      );
      if (svgElement) {
        svgElement.setAttribute("width", size.toString());
        svgElement.setAttribute("height", size.toString());
        svgElement.setAttribute("viewBox", `0 0 ${size} ${size}`);
        return svgElement;
      }
      return null;
    } catch (error) {
      console.warn("Failed to create SVG from pictograph service:", error);
      return null;
    }
  }
  /**
   * Draw SVG element to canvas
   */
  async drawSVGToCanvas(ctx, svgElement, width, height) {
    return new Promise((resolve, reject) => {
      try {
        const svgData = new XMLSerializer().serializeToString(svgElement);
        const img = new Image();
        img.onload = () => {
          try {
            ctx.drawImage(img, 0, 0, width, height);
            resolve();
          } catch (error) {
            reject(error);
          }
        };
        img.onerror = () => {
          reject(new Error("Failed to load SVG as image"));
        };
        const svgBlob = new Blob([svgData], {
          type: "image/svg+xml;charset=utf-8"
        });
        const url = URL.createObjectURL(svgBlob);
        img.src = url;
        img.onload = () => {
          try {
            ctx.drawImage(img, 0, 0, width, height);
            URL.revokeObjectURL(url);
            resolve();
          } catch (error) {
            URL.revokeObjectURL(url);
            reject(error);
          }
        };
      } catch (error) {
        reject(error);
      }
    });
  }
  /**
   * Manual pictograph rendering (fallback method)
   */
  async renderPictographManually(ctx, beatData, size, options) {
    const pictograph = beatData.pictographData;
    if (!pictograph) {
      throw new Error("Pictograph data is required for rendering");
    }
    this.drawGrid(ctx, pictograph.gridData?.gridMode || "diamond", size);
    if (pictograph.props) {
      if (options.blueVisible && pictograph.props.blue) {
        this.drawProp(ctx, pictograph.props.blue, "blue", size);
      }
      if (options.redVisible && pictograph.props.red) {
        this.drawProp(ctx, pictograph.props.red, "red", size);
      }
    }
    if (pictograph.arrows) {
      if (options.blueVisible && pictograph.arrows.blue) {
        this.drawArrow(ctx, pictograph.arrows.blue, "blue", size);
      }
      if (options.redVisible && pictograph.arrows.red) {
        this.drawArrow(ctx, pictograph.arrows.red, "red", size);
      }
    }
    if (pictograph.letter) {
      this.drawLetter(ctx, pictograph.letter, size);
    }
  }
  /**
   * Render empty beat (blank beat with just beat number)
   */
  async renderEmptyBeat(ctx, beatData, size, options) {
    this.drawGrid(ctx, "diamond", size);
    if (options.addBeatNumbers && beatData.beatNumber > 0) {
      this.drawBeatNumber(ctx, beatData.beatNumber, size);
    }
  }
  /**
   * Render fallback beat when all else fails
   */
  async renderFallbackBeat(ctx, beatData, size, options) {
    ctx.strokeStyle = "#ccc";
    ctx.lineWidth = 2;
    ctx.strokeRect(10, 10, size - 20, size - 20);
    ctx.beginPath();
    ctx.moveTo(20, 20);
    ctx.lineTo(size - 20, size - 20);
    ctx.moveTo(size - 20, 20);
    ctx.lineTo(20, size - 20);
    ctx.stroke();
    if (options.addBeatNumbers) {
      this.drawBeatNumber(ctx, beatData.beatNumber, size);
    }
  }
  /**
   * Render default start position
   */
  async renderDefaultStartPosition(ctx, size, _options) {
    this.drawGrid(ctx, "diamond", size);
    const centerX = size / 2;
    const centerY = size / 2;
    const radius = size * 0.1;
    ctx.fillStyle = "#10b981";
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fill();
  }
  /**
   * Draw simple grid pattern
   */
  drawGrid(ctx, gridMode, size) {
    ctx.strokeStyle = "#e5e7eb";
    ctx.lineWidth = 1;
    if (gridMode === "diamond") {
      const centerX = size / 2;
      const centerY = size / 2;
      const radius = size * 0.4;
      ctx.beginPath();
      ctx.moveTo(centerX, centerY - radius);
      ctx.lineTo(centerX + radius, centerY);
      ctx.lineTo(centerX, centerY + radius);
      ctx.lineTo(centerX - radius, centerY);
      ctx.closePath();
      ctx.stroke();
    } else {
      const margin = size * 0.1;
      ctx.strokeRect(margin, margin, size - 2 * margin, size - 2 * margin);
    }
  }
  /**
   * Draw prop placeholder
   */
  drawProp(ctx, propData, color, size) {
    if (!propData) return;
    const centerX = size / 2;
    const centerY = size / 2;
    const radius = size * 0.05;
    ctx.fillStyle = color === "blue" ? "#3b82f6" : "#ef4444";
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fill();
  }
  /**
   * Draw arrow placeholder
   */
  drawArrow(ctx, arrowData, color, size) {
    if (!arrowData) return;
    const centerX = size / 2;
    const centerY = size / 2;
    const length = size * 0.2;
    ctx.strokeStyle = color === "blue" ? "#3b82f6" : "#ef4444";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(centerX - length / 2, centerY);
    ctx.lineTo(centerX + length / 2, centerY);
    ctx.moveTo(centerX + length / 2 - 10, centerY - 5);
    ctx.lineTo(centerX + length / 2, centerY);
    ctx.lineTo(centerX + length / 2 - 10, centerY + 5);
    ctx.stroke();
  }
  /**
   * Draw letter text
   */
  drawLetter(ctx, letter, size) {
    ctx.fillStyle = "#374151";
    ctx.font = `${size * 0.2}px Arial, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(letter, size / 2, size / 2);
  }
  /**
   * Draw beat number
   */
  drawBeatNumber(ctx, beatNumber, size) {
    ctx.fillStyle = "#4b5563";
    ctx.font = `bold ${size * 0.15}px Arial, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    ctx.fillText(beatNumber.toString(), size / 2, size * 0.05);
  }
  /**
   * Render start position label
   */
  renderStartPositionLabel(ctx, size) {
    ctx.fillStyle = "#059669";
    ctx.font = `bold ${size * 0.12}px Arial, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    ctx.fillText("START", size / 2, size * 0.05);
  }
  /**
   * Apply post-processing effects
   */
  applyPostProcessing(ctx, beatData, size, options) {
    if (options.combinedGrids) {
      this.applyCombinedGrids(ctx, size);
    }
    if (beatData.blueReversal || beatData.redReversal) {
      this.drawReversalSymbols(ctx, beatData, size);
    }
  }
  /**
   * Apply combined grids overlay
   */
  applyCombinedGrids(ctx, size) {
    ctx.globalAlpha = 0.5;
    this.drawGrid(ctx, "diamond", size);
    this.drawGrid(ctx, "box", size);
    ctx.globalAlpha = 1;
  }
  /**
   * Draw reversal symbols
   */
  drawReversalSymbols(ctx, beatData, size) {
    const symbolSize = size * 0.08;
    if (beatData.blueReversal) {
      ctx.fillStyle = "#3b82f6";
      ctx.fillRect(size - symbolSize - 5, 5, symbolSize, symbolSize);
    }
    if (beatData.redReversal) {
      ctx.fillStyle = "#ef4444";
      ctx.fillRect(
        size - symbolSize - 5,
        symbolSize + 10,
        symbolSize,
        symbolSize
      );
    }
  }
  /**
   * Apply color visibility filters
   */
  applyColorFilters(ctx, width, height, options) {
    if (!options.redVisible || !options.blueVisible) {
      console.warn("Color filtering not fully implemented yet");
    }
  }
  /**
   * Canvas pool management
   */
  getCanvasFromPool(width, height) {
    const canvas = this.canvasPool.pop() || document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    if (!ctx) {
      throw new Error("Failed to get 2D context from canvas");
    }
    ctx.clearRect(0, 0, width, height);
    return canvas;
  }
  returnCanvasToPool(canvas) {
    if (this.canvasPool.length < this.MAX_POOL_SIZE) {
      this.canvasPool.push(canvas);
    }
  }
  /**
   * Cleanup method to dispose of resources
   */
  dispose() {
    this.canvasPool.length = 0;
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkJlYXRSZW5kZXJpbmdTZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQmVhdCBSZW5kZXJpbmcgU2VydmljZVxuICpcbiAqIENvbnZlcnRzIFRLQSBiZWF0cyBhbmQgcGljdG9ncmFwaHMgZnJvbSBTVkcgZm9ybWF0IHRvIENhbnZhcyBmb3IgaW1hZ2UgZXhwb3J0LlxuICogVGhpcyBzZXJ2aWNlIHByb3ZpZGVzIGZ1bmN0aW9uYWxpdHkgZXF1aXZhbGVudCB0byB0aGUgZGVza3RvcCBCZWF0RHJhd2VyIGFuZFxuICogSW1hZ2VFeHBvcnRCZWF0RmFjdG9yeSwgaGFuZGxpbmcgdGhlIGNvbXBsZXggdGFzayBvZiByZW5kZXJpbmcgYmVhdHMgZm9yIGV4cG9ydC5cbiAqXG4gKiBDcml0aWNhbDogTXVzdCBtYWludGFpbiB2aXN1YWwgZmlkZWxpdHkgd2hlbiBjb252ZXJ0aW5nIGZyb20gU1ZHIHRvIENhbnZhcy5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7XG4gIElCZWF0UmVuZGVyaW5nU2VydmljZSxcbiAgQmVhdFJlbmRlck9wdGlvbnMsXG59IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL2ltYWdlLWV4cG9ydC1pbnRlcmZhY2VzXCI7XG5pbXBvcnQgdHlwZSB7IEJlYXREYXRhLCBTZXF1ZW5jZURhdGEgfSBmcm9tIFwiLi4vLi4vaW50ZXJmYWNlcy9kb21haW4tdHlwZXNcIjtcbmltcG9ydCB0eXBlIHsgUHJvcERhdGEsIEFycm93RGF0YSB9IGZyb20gXCIkbGliL2RvbWFpblwiO1xuaW1wb3J0IHR5cGUgeyBJUGljdG9ncmFwaFNlcnZpY2UgfSBmcm9tIFwiLi4vLi4vaW50ZXJmYWNlcy9waWN0b2dyYXBoLWludGVyZmFjZXNcIjtcblxuZXhwb3J0IGNsYXNzIEJlYXRSZW5kZXJpbmdTZXJ2aWNlIGltcGxlbWVudHMgSUJlYXRSZW5kZXJpbmdTZXJ2aWNlIHtcbiAgLy8gQ2FudmFzIHBvb2wgZm9yIG1lbW9yeSBlZmZpY2llbmN5XG4gIHByaXZhdGUgY2FudmFzUG9vbDogSFRNTENhbnZhc0VsZW1lbnRbXSA9IFtdO1xuICBwcml2YXRlIHJlYWRvbmx5IE1BWF9QT09MX1NJWkUgPSAxMDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBpY3RvZ3JhcGhTZXJ2aWNlOiBJUGljdG9ncmFwaFNlcnZpY2UpIHt9XG5cbiAgLyoqXG4gICAqIFJlbmRlciBhIHNpbmdsZSBiZWF0IHRvIGNhbnZhc1xuICAgKiBDb252ZXJ0cyBTVkcgcGljdG9ncmFwaCB0byBjYW52YXMgcmVwcmVzZW50YXRpb25cbiAgICovXG4gIGFzeW5jIHJlbmRlckJlYXRUb0NhbnZhcyhcbiAgICBiZWF0RGF0YTogQmVhdERhdGEsXG4gICAgc2l6ZTogbnVtYmVyLFxuICAgIG9wdGlvbnM6IEJlYXRSZW5kZXJPcHRpb25zXG4gICk6IFByb21pc2U8SFRNTENhbnZhc0VsZW1lbnQ+IHtcbiAgICBpZiAoIWJlYXREYXRhKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCZWF0IGRhdGEgaXMgcmVxdWlyZWQgZm9yIHJlbmRlcmluZ1wiKTtcbiAgICB9XG5cbiAgICBpZiAoc2l6ZSA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgc2l6ZTogJHtzaXplfWApO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBDcmVhdGUgY2FudmFzIGZvciB0aGlzIGJlYXRcbiAgICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuZ2V0Q2FudmFzRnJvbVBvb2woc2l6ZSwgc2l6ZSk7XG4gICAgICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dChcIjJkXCIpO1xuICAgICAgaWYgKCFjdHgpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRmFpbGVkIHRvIGdldCAyRCBjb250ZXh0IGZyb20gY2FudmFzXCIpO1xuICAgICAgfVxuXG4gICAgICAvLyBDbGVhciBjYW52YXMgd2l0aCB3aGl0ZSBiYWNrZ3JvdW5kIChtYXRjaCBkZXNrdG9wKVxuICAgICAgY3R4LmZpbGxTdHlsZSA9IFwid2hpdGVcIjtcbiAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTtcblxuICAgICAgLy8gSWYgYmVhdCBpcyBibGFuaywgcmV0dXJuIGNhbnZhcyB3aXRoIGp1c3QgYmFja2dyb3VuZFxuICAgICAgaWYgKGJlYXREYXRhLmlzQmxhbmsgfHwgIWJlYXREYXRhLnBpY3RvZ3JhcGhEYXRhKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucmVuZGVyRW1wdHlCZWF0KGN0eCwgYmVhdERhdGEsIHNpemUsIG9wdGlvbnMpO1xuICAgICAgICByZXR1cm4gY2FudmFzO1xuICAgICAgfVxuXG4gICAgICAvLyBSZW5kZXIgcGljdG9ncmFwaCB0byBjYW52YXNcbiAgICAgIGF3YWl0IHRoaXMucmVuZGVyUGljdG9ncmFwaFRvQ2FudmFzKGN0eCwgYmVhdERhdGEsIHNpemUsIG9wdGlvbnMpO1xuXG4gICAgICAvLyBBcHBseSBwb3N0LXByb2Nlc3NpbmdcbiAgICAgIHRoaXMuYXBwbHlQb3N0UHJvY2Vzc2luZyhjdHgsIGJlYXREYXRhLCBzaXplLCBvcHRpb25zKTtcblxuICAgICAgcmV0dXJuIGNhbnZhcztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIHJlbmRlciBiZWF0IHRvIGNhbnZhczogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFwiVW5rbm93biBlcnJvclwifWBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlbmRlciBzdGFydCBwb3NpdGlvbiB0byBjYW52YXNcbiAgICogSGFuZGxlcyB0aGUgc3BlY2lhbCBjYXNlIG9mIHNlcXVlbmNlIHN0YXJ0IHBvc2l0aW9uXG4gICAqL1xuICBhc3luYyByZW5kZXJTdGFydFBvc2l0aW9uVG9DYW52YXMoXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBzaXplOiBudW1iZXIsXG4gICAgb3B0aW9uczogQmVhdFJlbmRlck9wdGlvbnNcbiAgKTogUHJvbWlzZTxIVE1MQ2FudmFzRWxlbWVudD4ge1xuICAgIGlmICghc2VxdWVuY2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlNlcXVlbmNlIGRhdGEgaXMgcmVxdWlyZWQgZm9yIHN0YXJ0IHBvc2l0aW9uIHJlbmRlcmluZ1wiKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5nZXRDYW52YXNGcm9tUG9vbChzaXplLCBzaXplKTtcbiAgICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XG4gICAgICBpZiAoIWN0eCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJGYWlsZWQgdG8gZ2V0IDJEIGNvbnRleHQgZnJvbSBjYW52YXNcIik7XG4gICAgICB9XG5cbiAgICAgIC8vIENsZWFyIGNhbnZhcyB3aXRoIHdoaXRlIGJhY2tncm91bmRcbiAgICAgIGN0eC5maWxsU3R5bGUgPSBcIndoaXRlXCI7XG4gICAgICBjdHguZmlsbFJlY3QoMCwgMCwgc2l6ZSwgc2l6ZSk7XG5cbiAgICAgIC8vIENoZWNrIGlmIHNlcXVlbmNlIGhhcyBleHBsaWNpdCBzdGFydCBwb3NpdGlvbiBkYXRhXG4gICAgICBpZiAoc2VxdWVuY2Uuc3RhcnRQb3NpdGlvbikge1xuICAgICAgICBhd2FpdCB0aGlzLnJlbmRlclBpY3RvZ3JhcGhUb0NhbnZhcyhcbiAgICAgICAgICBjdHgsXG4gICAgICAgICAgeyAuLi5zZXF1ZW5jZS5zdGFydFBvc2l0aW9uLCBiZWF0TnVtYmVyOiAwIH0gYXMgQmVhdERhdGEsXG4gICAgICAgICAgc2l6ZSxcbiAgICAgICAgICBvcHRpb25zXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBSZW5kZXIgZGVmYXVsdCBzdGFydCBwb3NpdGlvblxuICAgICAgICBhd2FpdCB0aGlzLnJlbmRlckRlZmF1bHRTdGFydFBvc2l0aW9uKGN0eCwgc2l6ZSwgb3B0aW9ucyk7XG4gICAgICB9XG5cbiAgICAgIC8vIEFkZCBcIlNUQVJUXCIgbGFiZWwgaWYgYmVhdCBudW1iZXJzIGFyZSBlbmFibGVkXG4gICAgICBpZiAob3B0aW9ucy5hZGRCZWF0TnVtYmVycykge1xuICAgICAgICB0aGlzLnJlbmRlclN0YXJ0UG9zaXRpb25MYWJlbChjdHgsIHNpemUpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gY2FudmFzO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gcmVuZGVyIHN0YXJ0IHBvc2l0aW9uOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCJ9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQmF0Y2ggcmVuZGVyIG11bHRpcGxlIGJlYXRzXG4gICAqIE9wdGltaXplZCBmb3IgcmVuZGVyaW5nIG1hbnkgYmVhdHMgZWZmaWNpZW50bHlcbiAgICovXG4gIGFzeW5jIHJlbmRlckJlYXRzVG9DYW52YXNlcyhcbiAgICBiZWF0czogQmVhdERhdGFbXSxcbiAgICBzaXplOiBudW1iZXIsXG4gICAgb3B0aW9uczogQmVhdFJlbmRlck9wdGlvbnNcbiAgKTogUHJvbWlzZTxIVE1MQ2FudmFzRWxlbWVudFtdPiB7XG4gICAgaWYgKCFiZWF0cyB8fCBiZWF0cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBjb25zdCBjYW52YXNlczogSFRNTENhbnZhc0VsZW1lbnRbXSA9IFtdO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFByb2Nlc3MgYmVhdHMgaW4gY2h1bmtzIHRvIG1hbmFnZSBtZW1vcnlcbiAgICAgIGNvbnN0IENIVU5LX1NJWkUgPSA1O1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBiZWF0cy5sZW5ndGg7IGkgKz0gQ0hVTktfU0laRSkge1xuICAgICAgICBjb25zdCBjaHVuayA9IGJlYXRzLnNsaWNlKGksIGkgKyBDSFVOS19TSVpFKTtcbiAgICAgICAgY29uc3QgY2h1bmtDYW52YXNlcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICAgIGNodW5rLm1hcCgoYmVhdCkgPT4gdGhpcy5yZW5kZXJCZWF0VG9DYW52YXMoYmVhdCwgc2l6ZSwgb3B0aW9ucykpXG4gICAgICAgICk7XG4gICAgICAgIGNhbnZhc2VzLnB1c2goLi4uY2h1bmtDYW52YXNlcyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBjYW52YXNlcztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gQ2xlYW4gdXAgYW55IGNyZWF0ZWQgY2FudmFzZXMgb24gZXJyb3JcbiAgICAgIGNhbnZhc2VzLmZvckVhY2goKGNhbnZhcykgPT4gdGhpcy5yZXR1cm5DYW52YXNUb1Bvb2woY2FudmFzKSk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBCYXRjaCByZW5kZXJpbmcgZmFpbGVkOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCJ9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQXBwbHkgdmlzaWJpbGl0eSBzZXR0aW5ncyB0byByZW5kZXJlZCBiZWF0XG4gICAqIE1hdGNoZXMgZGVza3RvcCB2aXNpYmlsaXR5IGxvZ2ljXG4gICAqL1xuICBhcHBseVZpc2liaWxpdHlTZXR0aW5ncyhcbiAgICBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50LFxuICAgIG9wdGlvbnM6IEJlYXRSZW5kZXJPcHRpb25zXG4gICk6IEhUTUxDYW52YXNFbGVtZW50IHtcbiAgICBpZiAob3B0aW9ucy5yZWRWaXNpYmxlICYmIG9wdGlvbnMuYmx1ZVZpc2libGUpIHtcbiAgICAgIC8vIEJvdGggdmlzaWJsZSAtIG5vIGNoYW5nZXMgbmVlZGVkXG4gICAgICByZXR1cm4gY2FudmFzO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBhIG5ldyBjYW52YXMgZm9yIGZpbHRlcmVkIHJlc3VsdFxuICAgIGNvbnN0IGZpbHRlcmVkQ2FudmFzID0gdGhpcy5nZXRDYW52YXNGcm9tUG9vbChjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpO1xuICAgIGNvbnN0IGZpbHRlcmVkQ3R4ID0gZmlsdGVyZWRDYW52YXMuZ2V0Q29udGV4dChcIjJkXCIpO1xuICAgIGlmICghZmlsdGVyZWRDdHgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkZhaWxlZCB0byBnZXQgMkQgY29udGV4dCBmcm9tIGZpbHRlcmVkIGNhbnZhc1wiKTtcbiAgICB9XG5cbiAgICAvLyBEcmF3IG9yaWdpbmFsIGNhbnZhc1xuICAgIGZpbHRlcmVkQ3R4LmRyYXdJbWFnZShjYW52YXMsIDAsIDApO1xuXG4gICAgLy8gQXBwbHkgdmlzaWJpbGl0eSBmaWx0ZXJzXG4gICAgdGhpcy5hcHBseUNvbG9yRmlsdGVycyhmaWx0ZXJlZEN0eCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0LCBvcHRpb25zKTtcblxuICAgIC8vIFJldHVybiBvcmlnaW5hbCBjYW52YXMgdG8gcG9vbFxuICAgIHRoaXMucmV0dXJuQ2FudmFzVG9Qb29sKGNhbnZhcyk7XG5cbiAgICByZXR1cm4gZmlsdGVyZWRDYW52YXM7XG4gIH1cblxuICAvKipcbiAgICogUmVuZGVyIHBpY3RvZ3JhcGggZGF0YSB0byBjYW52YXMgY29udGV4dFxuICAgKiBDb3JlIHJlbmRlcmluZyBsb2dpYyB0aGF0IGNvbnZlcnRzIHBpY3RvZ3JhcGggdG8gY2FudmFzXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHJlbmRlclBpY3RvZ3JhcGhUb0NhbnZhcyhcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICBiZWF0RGF0YTogQmVhdERhdGEsXG4gICAgc2l6ZTogbnVtYmVyLFxuICAgIG9wdGlvbnM6IEJlYXRSZW5kZXJPcHRpb25zXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghYmVhdERhdGEucGljdG9ncmFwaERhdGEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gTWV0aG9kIDE6IFRyeSB0byByZW5kZXIgdXNpbmcgZXhpc3RpbmcgUGljdG9ncmFwaCBjb21wb25lbnRcbiAgICAgIGNvbnN0IHN2Z0VsZW1lbnQgPSBhd2FpdCB0aGlzLmNyZWF0ZVNWR0Zyb21QaWN0b2dyYXBoRGF0YShcbiAgICAgICAgYmVhdERhdGEsXG4gICAgICAgIHNpemUsXG4gICAgICAgIG9wdGlvbnNcbiAgICAgICk7XG4gICAgICBpZiAoc3ZnRWxlbWVudCkge1xuICAgICAgICBhd2FpdCB0aGlzLmRyYXdTVkdUb0NhbnZhcyhjdHgsIHN2Z0VsZW1lbnQsIHNpemUsIHNpemUpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIE1ldGhvZCAyOiBGYWxsYmFjayB0byBtYW51YWwgcmVuZGVyaW5nXG4gICAgICBhd2FpdCB0aGlzLnJlbmRlclBpY3RvZ3JhcGhNYW51YWxseShjdHgsIGJlYXREYXRhLCBzaXplLCBvcHRpb25zKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKFwiUGljdG9ncmFwaCByZW5kZXJpbmcgZmFpbGVkLCB1c2luZyBmYWxsYmFjazpcIiwgZXJyb3IpO1xuICAgICAgYXdhaXQgdGhpcy5yZW5kZXJGYWxsYmFja0JlYXQoY3R4LCBiZWF0RGF0YSwgc2l6ZSwgb3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBTVkcgZWxlbWVudCBmcm9tIHBpY3RvZ3JhcGggZGF0YVxuICAgKiBVc2VzIHRoZSBpbmplY3RlZCBwaWN0b2dyYXBoIHNlcnZpY2UgaW5zdGVhZCBvZiBjcmVhdGluZyBjb21wb25lbnRzIGRpcmVjdGx5XG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGNyZWF0ZVNWR0Zyb21QaWN0b2dyYXBoRGF0YShcbiAgICBiZWF0RGF0YTogQmVhdERhdGEsXG4gICAgc2l6ZTogbnVtYmVyLFxuICAgIF9vcHRpb25zOiBCZWF0UmVuZGVyT3B0aW9uc1xuICApOiBQcm9taXNlPFNWR0VsZW1lbnQgfCBudWxsPiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghYmVhdERhdGEucGljdG9ncmFwaERhdGEpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIC8vIFVzZSB0aGUgaW5qZWN0ZWQgcGljdG9ncmFwaCBzZXJ2aWNlIHRvIHJlbmRlciB0aGUgcGljdG9ncmFwaCB0byBTVkdcbiAgICAgIGNvbnN0IHN2Z0VsZW1lbnQgPSBhd2FpdCB0aGlzLnBpY3RvZ3JhcGhTZXJ2aWNlLnJlbmRlclBpY3RvZ3JhcGgoXG4gICAgICAgIGJlYXREYXRhLnBpY3RvZ3JhcGhEYXRhXG4gICAgICApO1xuXG4gICAgICBpZiAoc3ZnRWxlbWVudCkge1xuICAgICAgICAvLyBTZXQgYXBwcm9wcmlhdGUgc2l6ZSBhdHRyaWJ1dGVzIG9uIHRoZSBTVkdcbiAgICAgICAgc3ZnRWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJ3aWR0aFwiLCBzaXplLnRvU3RyaW5nKCkpO1xuICAgICAgICBzdmdFbGVtZW50LnNldEF0dHJpYnV0ZShcImhlaWdodFwiLCBzaXplLnRvU3RyaW5nKCkpO1xuICAgICAgICBzdmdFbGVtZW50LnNldEF0dHJpYnV0ZShcInZpZXdCb3hcIiwgYDAgMCAke3NpemV9ICR7c2l6ZX1gKTtcblxuICAgICAgICByZXR1cm4gc3ZnRWxlbWVudDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIkZhaWxlZCB0byBjcmVhdGUgU1ZHIGZyb20gcGljdG9ncmFwaCBzZXJ2aWNlOlwiLCBlcnJvcik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRHJhdyBTVkcgZWxlbWVudCB0byBjYW52YXNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZHJhd1NWR1RvQ2FudmFzKFxuICAgIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELFxuICAgIHN2Z0VsZW1lbnQ6IFNWR0VsZW1lbnQsXG4gICAgd2lkdGg6IG51bWJlcixcbiAgICBoZWlnaHQ6IG51bWJlclxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgLy8gU2VyaWFsaXplIFNWRyB0byBzdHJpbmdcbiAgICAgICAgY29uc3Qgc3ZnRGF0YSA9IG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoc3ZnRWxlbWVudCk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIGltYWdlIGZyb20gU1ZHXG4gICAgICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xuXG4gICAgICAgIGltZy5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgaW1nLm9uZXJyb3IgPSAoKSA9PiB7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihcIkZhaWxlZCB0byBsb2FkIFNWRyBhcyBpbWFnZVwiKSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gQ29udmVydCBTVkcgdG8gZGF0YSBVUkxcbiAgICAgICAgY29uc3Qgc3ZnQmxvYiA9IG5ldyBCbG9iKFtzdmdEYXRhXSwge1xuICAgICAgICAgIHR5cGU6IFwiaW1hZ2Uvc3ZnK3htbDtjaGFyc2V0PXV0Zi04XCIsXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHN2Z0Jsb2IpO1xuXG4gICAgICAgIGltZy5zcmMgPSB1cmw7XG5cbiAgICAgICAgLy8gQ2xlYW4gdXAgVVJMIGFmdGVyIGltYWdlIGxvYWRzXG4gICAgICAgIGltZy5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoaW1nLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTtcbiAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpO1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIE1hbnVhbCBwaWN0b2dyYXBoIHJlbmRlcmluZyAoZmFsbGJhY2sgbWV0aG9kKVxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyByZW5kZXJQaWN0b2dyYXBoTWFudWFsbHkoXG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsXG4gICAgYmVhdERhdGE6IEJlYXREYXRhLFxuICAgIHNpemU6IG51bWJlcixcbiAgICBvcHRpb25zOiBCZWF0UmVuZGVyT3B0aW9uc1xuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBwaWN0b2dyYXBoID0gYmVhdERhdGEucGljdG9ncmFwaERhdGE7XG4gICAgaWYgKCFwaWN0b2dyYXBoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJQaWN0b2dyYXBoIGRhdGEgaXMgcmVxdWlyZWQgZm9yIHJlbmRlcmluZ1wiKTtcbiAgICB9XG5cbiAgICAvLyBEcmF3IGdyaWQgYmFja2dyb3VuZFxuICAgIHRoaXMuZHJhd0dyaWQoY3R4LCBwaWN0b2dyYXBoLmdyaWREYXRhPy5ncmlkTW9kZSB8fCBcImRpYW1vbmRcIiwgc2l6ZSk7XG5cbiAgICAvLyBEcmF3IHByb3BzIGlmIHZpc2libGVcbiAgICBpZiAocGljdG9ncmFwaC5wcm9wcykge1xuICAgICAgaWYgKG9wdGlvbnMuYmx1ZVZpc2libGUgJiYgcGljdG9ncmFwaC5wcm9wcy5ibHVlKSB7XG4gICAgICAgIHRoaXMuZHJhd1Byb3AoY3R4LCBwaWN0b2dyYXBoLnByb3BzLmJsdWUsIFwiYmx1ZVwiLCBzaXplKTtcbiAgICAgIH1cbiAgICAgIGlmIChvcHRpb25zLnJlZFZpc2libGUgJiYgcGljdG9ncmFwaC5wcm9wcy5yZWQpIHtcbiAgICAgICAgdGhpcy5kcmF3UHJvcChjdHgsIHBpY3RvZ3JhcGgucHJvcHMucmVkLCBcInJlZFwiLCBzaXplKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBEcmF3IGFycm93cyBpZiB2aXNpYmxlXG4gICAgaWYgKHBpY3RvZ3JhcGguYXJyb3dzKSB7XG4gICAgICBpZiAob3B0aW9ucy5ibHVlVmlzaWJsZSAmJiBwaWN0b2dyYXBoLmFycm93cy5ibHVlKSB7XG4gICAgICAgIHRoaXMuZHJhd0Fycm93KGN0eCwgcGljdG9ncmFwaC5hcnJvd3MuYmx1ZSwgXCJibHVlXCIsIHNpemUpO1xuICAgICAgfVxuICAgICAgaWYgKG9wdGlvbnMucmVkVmlzaWJsZSAmJiBwaWN0b2dyYXBoLmFycm93cy5yZWQpIHtcbiAgICAgICAgdGhpcy5kcmF3QXJyb3coY3R4LCBwaWN0b2dyYXBoLmFycm93cy5yZWQsIFwicmVkXCIsIHNpemUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIERyYXcgbGV0dGVyIGlmIHByZXNlbnRcbiAgICBpZiAocGljdG9ncmFwaC5sZXR0ZXIpIHtcbiAgICAgIHRoaXMuZHJhd0xldHRlcihjdHgsIHBpY3RvZ3JhcGgubGV0dGVyLCBzaXplKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVuZGVyIGVtcHR5IGJlYXQgKGJsYW5rIGJlYXQgd2l0aCBqdXN0IGJlYXQgbnVtYmVyKVxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyByZW5kZXJFbXB0eUJlYXQoXG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsXG4gICAgYmVhdERhdGE6IEJlYXREYXRhLFxuICAgIHNpemU6IG51bWJlcixcbiAgICBvcHRpb25zOiBCZWF0UmVuZGVyT3B0aW9uc1xuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBEcmF3IG1pbmltYWwgZ3JpZFxuICAgIHRoaXMuZHJhd0dyaWQoY3R4LCBcImRpYW1vbmRcIiwgc2l6ZSk7XG5cbiAgICAvLyBEcmF3IGJlYXQgbnVtYmVyIGlmIGVuYWJsZWRcbiAgICBpZiAob3B0aW9ucy5hZGRCZWF0TnVtYmVycyAmJiBiZWF0RGF0YS5iZWF0TnVtYmVyID4gMCkge1xuICAgICAgdGhpcy5kcmF3QmVhdE51bWJlcihjdHgsIGJlYXREYXRhLmJlYXROdW1iZXIsIHNpemUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZW5kZXIgZmFsbGJhY2sgYmVhdCB3aGVuIGFsbCBlbHNlIGZhaWxzXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHJlbmRlckZhbGxiYWNrQmVhdChcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICBiZWF0RGF0YTogQmVhdERhdGEsXG4gICAgc2l6ZTogbnVtYmVyLFxuICAgIG9wdGlvbnM6IEJlYXRSZW5kZXJPcHRpb25zXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIERyYXcgYmFzaWMgcGxhY2Vob2xkZXJcbiAgICBjdHguc3Ryb2tlU3R5bGUgPSBcIiNjY2NcIjtcbiAgICBjdHgubGluZVdpZHRoID0gMjtcbiAgICBjdHguc3Ryb2tlUmVjdCgxMCwgMTAsIHNpemUgLSAyMCwgc2l6ZSAtIDIwKTtcblxuICAgIC8vIERyYXcgWCB0byBpbmRpY2F0ZSBlcnJvclxuICAgIGN0eC5iZWdpblBhdGgoKTtcbiAgICBjdHgubW92ZVRvKDIwLCAyMCk7XG4gICAgY3R4LmxpbmVUbyhzaXplIC0gMjAsIHNpemUgLSAyMCk7XG4gICAgY3R4Lm1vdmVUbyhzaXplIC0gMjAsIDIwKTtcbiAgICBjdHgubGluZVRvKDIwLCBzaXplIC0gMjApO1xuICAgIGN0eC5zdHJva2UoKTtcblxuICAgIC8vIERyYXcgYmVhdCBudW1iZXJcbiAgICBpZiAob3B0aW9ucy5hZGRCZWF0TnVtYmVycykge1xuICAgICAgdGhpcy5kcmF3QmVhdE51bWJlcihjdHgsIGJlYXREYXRhLmJlYXROdW1iZXIsIHNpemUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZW5kZXIgZGVmYXVsdCBzdGFydCBwb3NpdGlvblxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyByZW5kZXJEZWZhdWx0U3RhcnRQb3NpdGlvbihcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICBzaXplOiBudW1iZXIsXG4gICAgX29wdGlvbnM6IEJlYXRSZW5kZXJPcHRpb25zXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIERyYXcgZ3JpZFxuICAgIHRoaXMuZHJhd0dyaWQoY3R4LCBcImRpYW1vbmRcIiwgc2l6ZSk7XG5cbiAgICAvLyBEcmF3IGNlbnRlciBjaXJjbGUgdG8gaW5kaWNhdGUgc3RhcnQgcG9zaXRpb25cbiAgICBjb25zdCBjZW50ZXJYID0gc2l6ZSAvIDI7XG4gICAgY29uc3QgY2VudGVyWSA9IHNpemUgLyAyO1xuICAgIGNvbnN0IHJhZGl1cyA9IHNpemUgKiAwLjE7XG5cbiAgICBjdHguZmlsbFN0eWxlID0gXCIjMTBiOTgxXCI7IC8vIEdyZWVuIGNvbG9yIGZvciBzdGFydFxuICAgIGN0eC5iZWdpblBhdGgoKTtcbiAgICBjdHguYXJjKGNlbnRlclgsIGNlbnRlclksIHJhZGl1cywgMCwgMiAqIE1hdGguUEkpO1xuICAgIGN0eC5maWxsKCk7XG4gIH1cblxuICAvKipcbiAgICogRHJhdyBzaW1wbGUgZ3JpZCBwYXR0ZXJuXG4gICAqL1xuICBwcml2YXRlIGRyYXdHcmlkKFxuICAgIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELFxuICAgIGdyaWRNb2RlOiBzdHJpbmcsXG4gICAgc2l6ZTogbnVtYmVyXG4gICk6IHZvaWQge1xuICAgIGN0eC5zdHJva2VTdHlsZSA9IFwiI2U1ZTdlYlwiO1xuICAgIGN0eC5saW5lV2lkdGggPSAxO1xuXG4gICAgaWYgKGdyaWRNb2RlID09PSBcImRpYW1vbmRcIikge1xuICAgICAgLy8gRHJhdyBkaWFtb25kIGdyaWRcbiAgICAgIGNvbnN0IGNlbnRlclggPSBzaXplIC8gMjtcbiAgICAgIGNvbnN0IGNlbnRlclkgPSBzaXplIC8gMjtcbiAgICAgIGNvbnN0IHJhZGl1cyA9IHNpemUgKiAwLjQ7XG5cbiAgICAgIGN0eC5iZWdpblBhdGgoKTtcbiAgICAgIGN0eC5tb3ZlVG8oY2VudGVyWCwgY2VudGVyWSAtIHJhZGl1cyk7XG4gICAgICBjdHgubGluZVRvKGNlbnRlclggKyByYWRpdXMsIGNlbnRlclkpO1xuICAgICAgY3R4LmxpbmVUbyhjZW50ZXJYLCBjZW50ZXJZICsgcmFkaXVzKTtcbiAgICAgIGN0eC5saW5lVG8oY2VudGVyWCAtIHJhZGl1cywgY2VudGVyWSk7XG4gICAgICBjdHguY2xvc2VQYXRoKCk7XG4gICAgICBjdHguc3Ryb2tlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIERyYXcgYm94IGdyaWRcbiAgICAgIGNvbnN0IG1hcmdpbiA9IHNpemUgKiAwLjE7XG4gICAgICBjdHguc3Ryb2tlUmVjdChtYXJnaW4sIG1hcmdpbiwgc2l6ZSAtIDIgKiBtYXJnaW4sIHNpemUgLSAyICogbWFyZ2luKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRHJhdyBwcm9wIHBsYWNlaG9sZGVyXG4gICAqL1xuICBwcml2YXRlIGRyYXdQcm9wKFxuICAgIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELFxuICAgIHByb3BEYXRhOiBQcm9wRGF0YSB8IG51bGwsXG4gICAgY29sb3I6IHN0cmluZyxcbiAgICBzaXplOiBudW1iZXJcbiAgKTogdm9pZCB7XG4gICAgaWYgKCFwcm9wRGF0YSkgcmV0dXJuO1xuXG4gICAgY29uc3QgY2VudGVyWCA9IHNpemUgLyAyO1xuICAgIGNvbnN0IGNlbnRlclkgPSBzaXplIC8gMjtcbiAgICBjb25zdCByYWRpdXMgPSBzaXplICogMC4wNTtcblxuICAgIGN0eC5maWxsU3R5bGUgPSBjb2xvciA9PT0gXCJibHVlXCIgPyBcIiMzYjgyZjZcIiA6IFwiI2VmNDQ0NFwiO1xuICAgIGN0eC5iZWdpblBhdGgoKTtcbiAgICBjdHguYXJjKGNlbnRlclgsIGNlbnRlclksIHJhZGl1cywgMCwgMiAqIE1hdGguUEkpO1xuICAgIGN0eC5maWxsKCk7XG4gIH1cblxuICAvKipcbiAgICogRHJhdyBhcnJvdyBwbGFjZWhvbGRlclxuICAgKi9cbiAgcHJpdmF0ZSBkcmF3QXJyb3coXG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsXG4gICAgYXJyb3dEYXRhOiBBcnJvd0RhdGEgfCBudWxsLFxuICAgIGNvbG9yOiBzdHJpbmcsXG4gICAgc2l6ZTogbnVtYmVyXG4gICk6IHZvaWQge1xuICAgIGlmICghYXJyb3dEYXRhKSByZXR1cm47XG5cbiAgICBjb25zdCBjZW50ZXJYID0gc2l6ZSAvIDI7XG4gICAgY29uc3QgY2VudGVyWSA9IHNpemUgLyAyO1xuICAgIGNvbnN0IGxlbmd0aCA9IHNpemUgKiAwLjI7XG5cbiAgICBjdHguc3Ryb2tlU3R5bGUgPSBjb2xvciA9PT0gXCJibHVlXCIgPyBcIiMzYjgyZjZcIiA6IFwiI2VmNDQ0NFwiO1xuICAgIGN0eC5saW5lV2lkdGggPSAzO1xuXG4gICAgLy8gU2ltcGxlIGFycm93IHBvaW50aW5nIHJpZ2h0XG4gICAgY3R4LmJlZ2luUGF0aCgpO1xuICAgIGN0eC5tb3ZlVG8oY2VudGVyWCAtIGxlbmd0aCAvIDIsIGNlbnRlclkpO1xuICAgIGN0eC5saW5lVG8oY2VudGVyWCArIGxlbmd0aCAvIDIsIGNlbnRlclkpO1xuICAgIGN0eC5tb3ZlVG8oY2VudGVyWCArIGxlbmd0aCAvIDIgLSAxMCwgY2VudGVyWSAtIDUpO1xuICAgIGN0eC5saW5lVG8oY2VudGVyWCArIGxlbmd0aCAvIDIsIGNlbnRlclkpO1xuICAgIGN0eC5saW5lVG8oY2VudGVyWCArIGxlbmd0aCAvIDIgLSAxMCwgY2VudGVyWSArIDUpO1xuICAgIGN0eC5zdHJva2UoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEcmF3IGxldHRlciB0ZXh0XG4gICAqL1xuICBwcml2YXRlIGRyYXdMZXR0ZXIoXG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsXG4gICAgbGV0dGVyOiBzdHJpbmcsXG4gICAgc2l6ZTogbnVtYmVyXG4gICk6IHZvaWQge1xuICAgIGN0eC5maWxsU3R5bGUgPSBcIiMzNzQxNTFcIjtcbiAgICBjdHguZm9udCA9IGAke3NpemUgKiAwLjJ9cHggQXJpYWwsIHNhbnMtc2VyaWZgO1xuICAgIGN0eC50ZXh0QWxpZ24gPSBcImNlbnRlclwiO1xuICAgIGN0eC50ZXh0QmFzZWxpbmUgPSBcIm1pZGRsZVwiO1xuICAgIGN0eC5maWxsVGV4dChsZXR0ZXIsIHNpemUgLyAyLCBzaXplIC8gMik7XG4gIH1cblxuICAvKipcbiAgICogRHJhdyBiZWF0IG51bWJlclxuICAgKi9cbiAgcHJpdmF0ZSBkcmF3QmVhdE51bWJlcihcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICBiZWF0TnVtYmVyOiBudW1iZXIsXG4gICAgc2l6ZTogbnVtYmVyXG4gICk6IHZvaWQge1xuICAgIGN0eC5maWxsU3R5bGUgPSBcIiM0YjU1NjNcIjtcbiAgICBjdHguZm9udCA9IGBib2xkICR7c2l6ZSAqIDAuMTV9cHggQXJpYWwsIHNhbnMtc2VyaWZgO1xuICAgIGN0eC50ZXh0QWxpZ24gPSBcImNlbnRlclwiO1xuICAgIGN0eC50ZXh0QmFzZWxpbmUgPSBcInRvcFwiO1xuICAgIGN0eC5maWxsVGV4dChiZWF0TnVtYmVyLnRvU3RyaW5nKCksIHNpemUgLyAyLCBzaXplICogMC4wNSk7XG4gIH1cblxuICAvKipcbiAgICogUmVuZGVyIHN0YXJ0IHBvc2l0aW9uIGxhYmVsXG4gICAqL1xuICBwcml2YXRlIHJlbmRlclN0YXJ0UG9zaXRpb25MYWJlbChcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICBzaXplOiBudW1iZXJcbiAgKTogdm9pZCB7XG4gICAgY3R4LmZpbGxTdHlsZSA9IFwiIzA1OTY2OVwiO1xuICAgIGN0eC5mb250ID0gYGJvbGQgJHtzaXplICogMC4xMn1weCBBcmlhbCwgc2Fucy1zZXJpZmA7XG4gICAgY3R4LnRleHRBbGlnbiA9IFwiY2VudGVyXCI7XG4gICAgY3R4LnRleHRCYXNlbGluZSA9IFwidG9wXCI7XG4gICAgY3R4LmZpbGxUZXh0KFwiU1RBUlRcIiwgc2l6ZSAvIDIsIHNpemUgKiAwLjA1KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBseSBwb3N0LXByb2Nlc3NpbmcgZWZmZWN0c1xuICAgKi9cbiAgcHJpdmF0ZSBhcHBseVBvc3RQcm9jZXNzaW5nKFxuICAgIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELFxuICAgIGJlYXREYXRhOiBCZWF0RGF0YSxcbiAgICBzaXplOiBudW1iZXIsXG4gICAgb3B0aW9uczogQmVhdFJlbmRlck9wdGlvbnNcbiAgKTogdm9pZCB7XG4gICAgLy8gQXBwbHkgY29tYmluZWQgZ3JpZHMgaWYgZW5hYmxlZFxuICAgIGlmIChvcHRpb25zLmNvbWJpbmVkR3JpZHMpIHtcbiAgICAgIHRoaXMuYXBwbHlDb21iaW5lZEdyaWRzKGN0eCwgc2l6ZSk7XG4gICAgfVxuXG4gICAgLy8gQXBwbHkgcmV2ZXJzYWwgc3ltYm9scyBpZiBuZWVkZWRcbiAgICBpZiAoYmVhdERhdGEuYmx1ZVJldmVyc2FsIHx8IGJlYXREYXRhLnJlZFJldmVyc2FsKSB7XG4gICAgICB0aGlzLmRyYXdSZXZlcnNhbFN5bWJvbHMoY3R4LCBiZWF0RGF0YSwgc2l6ZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEFwcGx5IGNvbWJpbmVkIGdyaWRzIG92ZXJsYXlcbiAgICovXG4gIHByaXZhdGUgYXBwbHlDb21iaW5lZEdyaWRzKFxuICAgIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELFxuICAgIHNpemU6IG51bWJlclxuICApOiB2b2lkIHtcbiAgICAvLyBEcmF3IGJvdGggZGlhbW9uZCBhbmQgYm94IGdyaWRzIHdpdGggc2xpZ2h0IHRyYW5zcGFyZW5jeVxuICAgIGN0eC5nbG9iYWxBbHBoYSA9IDAuNTtcbiAgICB0aGlzLmRyYXdHcmlkKGN0eCwgXCJkaWFtb25kXCIsIHNpemUpO1xuICAgIHRoaXMuZHJhd0dyaWQoY3R4LCBcImJveFwiLCBzaXplKTtcbiAgICBjdHguZ2xvYmFsQWxwaGEgPSAxLjA7XG4gIH1cblxuICAvKipcbiAgICogRHJhdyByZXZlcnNhbCBzeW1ib2xzXG4gICAqL1xuICBwcml2YXRlIGRyYXdSZXZlcnNhbFN5bWJvbHMoXG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsXG4gICAgYmVhdERhdGE6IEJlYXREYXRhLFxuICAgIHNpemU6IG51bWJlclxuICApOiB2b2lkIHtcbiAgICBjb25zdCBzeW1ib2xTaXplID0gc2l6ZSAqIDAuMDg7XG5cbiAgICBpZiAoYmVhdERhdGEuYmx1ZVJldmVyc2FsKSB7XG4gICAgICBjdHguZmlsbFN0eWxlID0gXCIjM2I4MmY2XCI7XG4gICAgICBjdHguZmlsbFJlY3Qoc2l6ZSAtIHN5bWJvbFNpemUgLSA1LCA1LCBzeW1ib2xTaXplLCBzeW1ib2xTaXplKTtcbiAgICB9XG5cbiAgICBpZiAoYmVhdERhdGEucmVkUmV2ZXJzYWwpIHtcbiAgICAgIGN0eC5maWxsU3R5bGUgPSBcIiNlZjQ0NDRcIjtcbiAgICAgIGN0eC5maWxsUmVjdChcbiAgICAgICAgc2l6ZSAtIHN5bWJvbFNpemUgLSA1LFxuICAgICAgICBzeW1ib2xTaXplICsgMTAsXG4gICAgICAgIHN5bWJvbFNpemUsXG4gICAgICAgIHN5bWJvbFNpemVcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEFwcGx5IGNvbG9yIHZpc2liaWxpdHkgZmlsdGVyc1xuICAgKi9cbiAgcHJpdmF0ZSBhcHBseUNvbG9yRmlsdGVycyhcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICB3aWR0aDogbnVtYmVyLFxuICAgIGhlaWdodDogbnVtYmVyLFxuICAgIG9wdGlvbnM6IEJlYXRSZW5kZXJPcHRpb25zXG4gICk6IHZvaWQge1xuICAgIGlmICghb3B0aW9ucy5yZWRWaXNpYmxlIHx8ICFvcHRpb25zLmJsdWVWaXNpYmxlKSB7XG4gICAgICAvLyBUaGlzIGlzIGEgc2ltcGxpZmllZCBhcHByb2FjaCAtIGluIGEgZnVsbCBpbXBsZW1lbnRhdGlvbixcbiAgICAgIC8vIHdlIHdvdWxkIG5lZWQgbW9yZSBzb3BoaXN0aWNhdGVkIGNvbG9yIGZpbHRlcmluZ1xuICAgICAgY29uc29sZS53YXJuKFwiQ29sb3IgZmlsdGVyaW5nIG5vdCBmdWxseSBpbXBsZW1lbnRlZCB5ZXRcIik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENhbnZhcyBwb29sIG1hbmFnZW1lbnRcbiAgICovXG4gIHByaXZhdGUgZ2V0Q2FudmFzRnJvbVBvb2wod2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpOiBIVE1MQ2FudmFzRWxlbWVudCB7XG4gICAgY29uc3QgY2FudmFzID0gdGhpcy5jYW52YXNQb29sLnBvcCgpIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYW52YXNcIik7XG4gICAgY2FudmFzLndpZHRoID0gd2lkdGg7XG4gICAgY2FudmFzLmhlaWdodCA9IGhlaWdodDtcblxuICAgIC8vIENsZWFyIHRoZSBjYW52YXNcbiAgICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dChcIjJkXCIpO1xuICAgIGlmICghY3R4KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJGYWlsZWQgdG8gZ2V0IDJEIGNvbnRleHQgZnJvbSBjYW52YXNcIik7XG4gICAgfVxuICAgIGN0eC5jbGVhclJlY3QoMCwgMCwgd2lkdGgsIGhlaWdodCk7XG5cbiAgICByZXR1cm4gY2FudmFzO1xuICB9XG5cbiAgcHJpdmF0ZSByZXR1cm5DYW52YXNUb1Bvb2woY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmNhbnZhc1Bvb2wubGVuZ3RoIDwgdGhpcy5NQVhfUE9PTF9TSVpFKSB7XG4gICAgICB0aGlzLmNhbnZhc1Bvb2wucHVzaChjYW52YXMpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhbnVwIG1ldGhvZCB0byBkaXNwb3NlIG9mIHJlc291cmNlc1xuICAgKi9cbiAgZGlzcG9zZSgpOiB2b2lkIHtcbiAgICB0aGlzLmNhbnZhc1Bvb2wubGVuZ3RoID0gMDtcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiQUFrQk8sYUFBTSxxQkFBc0Q7QUFBQSxFQUtqRSxZQUFvQixtQkFBdUM7QUFBdkM7QUFBQSxFQUF3QztBQUFBO0FBQUEsRUFIcEQsYUFBa0MsQ0FBQztBQUFBLEVBQzFCLGdCQUFnQjtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFRakMsTUFBTSxtQkFDSixVQUNBLE1BQ0EsU0FDNEI7QUFDNUIsUUFBSSxDQUFDLFVBQVU7QUFDYixZQUFNLElBQUksTUFBTSxxQ0FBcUM7QUFBQSxJQUN2RDtBQUVBLFFBQUksUUFBUSxHQUFHO0FBQ2IsWUFBTSxJQUFJLE1BQU0saUJBQWlCLElBQUksRUFBRTtBQUFBLElBQ3pDO0FBRUEsUUFBSTtBQUVGLFlBQU0sU0FBUyxLQUFLLGtCQUFrQixNQUFNLElBQUk7QUFDaEQsWUFBTSxNQUFNLE9BQU8sV0FBVyxJQUFJO0FBQ2xDLFVBQUksQ0FBQyxLQUFLO0FBQ1IsY0FBTSxJQUFJLE1BQU0sc0NBQXNDO0FBQUEsTUFDeEQ7QUFHQSxVQUFJLFlBQVk7QUFDaEIsVUFBSSxTQUFTLEdBQUcsR0FBRyxNQUFNLElBQUk7QUFHN0IsVUFBSSxTQUFTLFdBQVcsQ0FBQyxTQUFTLGdCQUFnQjtBQUNoRCxjQUFNLEtBQUssZ0JBQWdCLEtBQUssVUFBVSxNQUFNLE9BQU87QUFDdkQsZUFBTztBQUFBLE1BQ1Q7QUFHQSxZQUFNLEtBQUsseUJBQXlCLEtBQUssVUFBVSxNQUFNLE9BQU87QUFHaEUsV0FBSyxvQkFBb0IsS0FBSyxVQUFVLE1BQU0sT0FBTztBQUVyRCxhQUFPO0FBQUEsSUFDVCxTQUFTLE9BQU87QUFDZCxZQUFNLElBQUk7QUFBQSxRQUNSLG9DQUFvQyxpQkFBaUIsUUFBUSxNQUFNLFVBQVUsZUFBZTtBQUFBLE1BQzlGO0FBQUEsSUFDRjtBQUFBLEVBQ0Y7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBTUEsTUFBTSw0QkFDSixVQUNBLE1BQ0EsU0FDNEI7QUFDNUIsUUFBSSxDQUFDLFVBQVU7QUFDYixZQUFNLElBQUksTUFBTSx3REFBd0Q7QUFBQSxJQUMxRTtBQUVBLFFBQUk7QUFDRixZQUFNLFNBQVMsS0FBSyxrQkFBa0IsTUFBTSxJQUFJO0FBQ2hELFlBQU0sTUFBTSxPQUFPLFdBQVcsSUFBSTtBQUNsQyxVQUFJLENBQUMsS0FBSztBQUNSLGNBQU0sSUFBSSxNQUFNLHNDQUFzQztBQUFBLE1BQ3hEO0FBR0EsVUFBSSxZQUFZO0FBQ2hCLFVBQUksU0FBUyxHQUFHLEdBQUcsTUFBTSxJQUFJO0FBRzdCLFVBQUksU0FBUyxlQUFlO0FBQzFCLGNBQU0sS0FBSztBQUFBLFVBQ1Q7QUFBQSxVQUNBLEVBQUUsR0FBRyxTQUFTLGVBQWUsWUFBWSxFQUFFO0FBQUEsVUFDM0M7QUFBQSxVQUNBO0FBQUEsUUFDRjtBQUFBLE1BQ0YsT0FBTztBQUVMLGNBQU0sS0FBSywyQkFBMkIsS0FBSyxNQUFNLE9BQU87QUFBQSxNQUMxRDtBQUdBLFVBQUksUUFBUSxnQkFBZ0I7QUFDMUIsYUFBSyx5QkFBeUIsS0FBSyxJQUFJO0FBQUEsTUFDekM7QUFFQSxhQUFPO0FBQUEsSUFDVCxTQUFTLE9BQU87QUFDZCxZQUFNLElBQUk7QUFBQSxRQUNSLG9DQUFvQyxpQkFBaUIsUUFBUSxNQUFNLFVBQVUsZUFBZTtBQUFBLE1BQzlGO0FBQUEsSUFDRjtBQUFBLEVBQ0Y7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBTUEsTUFBTSxzQkFDSixPQUNBLE1BQ0EsU0FDOEI7QUFDOUIsUUFBSSxDQUFDLFNBQVMsTUFBTSxXQUFXLEdBQUc7QUFDaEMsYUFBTyxDQUFDO0FBQUEsSUFDVjtBQUVBLFVBQU0sV0FBZ0MsQ0FBQztBQUV2QyxRQUFJO0FBRUYsWUFBTSxhQUFhO0FBQ25CLGVBQVMsSUFBSSxHQUFHLElBQUksTUFBTSxRQUFRLEtBQUssWUFBWTtBQUNqRCxjQUFNLFFBQVEsTUFBTSxNQUFNLEdBQUcsSUFBSSxVQUFVO0FBQzNDLGNBQU0sZ0JBQWdCLE1BQU0sUUFBUTtBQUFBLFVBQ2xDLE1BQU0sSUFBSSxDQUFDLFNBQVMsS0FBSyxtQkFBbUIsTUFBTSxNQUFNLE9BQU8sQ0FBQztBQUFBLFFBQ2xFO0FBQ0EsaUJBQVMsS0FBSyxHQUFHLGFBQWE7QUFBQSxNQUNoQztBQUVBLGFBQU87QUFBQSxJQUNULFNBQVMsT0FBTztBQUVkLGVBQVMsUUFBUSxDQUFDLFdBQVcsS0FBSyxtQkFBbUIsTUFBTSxDQUFDO0FBQzVELFlBQU0sSUFBSTtBQUFBLFFBQ1IsMkJBQTJCLGlCQUFpQixRQUFRLE1BQU0sVUFBVSxlQUFlO0FBQUEsTUFDckY7QUFBQSxJQUNGO0FBQUEsRUFDRjtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFNQSx3QkFDRSxRQUNBLFNBQ21CO0FBQ25CLFFBQUksUUFBUSxjQUFjLFFBQVEsYUFBYTtBQUU3QyxhQUFPO0FBQUEsSUFDVDtBQUdBLFVBQU0saUJBQWlCLEtBQUssa0JBQWtCLE9BQU8sT0FBTyxPQUFPLE1BQU07QUFDekUsVUFBTSxjQUFjLGVBQWUsV0FBVyxJQUFJO0FBQ2xELFFBQUksQ0FBQyxhQUFhO0FBQ2hCLFlBQU0sSUFBSSxNQUFNLCtDQUErQztBQUFBLElBQ2pFO0FBR0EsZ0JBQVksVUFBVSxRQUFRLEdBQUcsQ0FBQztBQUdsQyxTQUFLLGtCQUFrQixhQUFhLE9BQU8sT0FBTyxPQUFPLFFBQVEsT0FBTztBQUd4RSxTQUFLLG1CQUFtQixNQUFNO0FBRTlCLFdBQU87QUFBQSxFQUNUO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQU1BLE1BQWMseUJBQ1osS0FDQSxVQUNBLE1BQ0EsU0FDZTtBQUNmLFFBQUksQ0FBQyxTQUFTLGdCQUFnQjtBQUM1QjtBQUFBLElBQ0Y7QUFFQSxRQUFJO0FBRUYsWUFBTSxhQUFhLE1BQU0sS0FBSztBQUFBLFFBQzVCO0FBQUEsUUFDQTtBQUFBLFFBQ0E7QUFBQSxNQUNGO0FBQ0EsVUFBSSxZQUFZO0FBQ2QsY0FBTSxLQUFLLGdCQUFnQixLQUFLLFlBQVksTUFBTSxJQUFJO0FBQ3REO0FBQUEsTUFDRjtBQUdBLFlBQU0sS0FBSyx5QkFBeUIsS0FBSyxVQUFVLE1BQU0sT0FBTztBQUFBLElBQ2xFLFNBQVMsT0FBTztBQUNkLGNBQVEsS0FBSyxnREFBZ0QsS0FBSztBQUNsRSxZQUFNLEtBQUssbUJBQW1CLEtBQUssVUFBVSxNQUFNLE9BQU87QUFBQSxJQUM1RDtBQUFBLEVBQ0Y7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBTUEsTUFBYyw0QkFDWixVQUNBLE1BQ0EsVUFDNEI7QUFDNUIsUUFBSTtBQUNGLFVBQUksQ0FBQyxTQUFTLGdCQUFnQjtBQUM1QixlQUFPO0FBQUEsTUFDVDtBQUdBLFlBQU0sYUFBYSxNQUFNLEtBQUssa0JBQWtCO0FBQUEsUUFDOUMsU0FBUztBQUFBLE1BQ1g7QUFFQSxVQUFJLFlBQVk7QUFFZCxtQkFBVyxhQUFhLFNBQVMsS0FBSyxTQUFTLENBQUM7QUFDaEQsbUJBQVcsYUFBYSxVQUFVLEtBQUssU0FBUyxDQUFDO0FBQ2pELG1CQUFXLGFBQWEsV0FBVyxPQUFPLElBQUksSUFBSSxJQUFJLEVBQUU7QUFFeEQsZUFBTztBQUFBLE1BQ1Q7QUFFQSxhQUFPO0FBQUEsSUFDVCxTQUFTLE9BQU87QUFDZCxjQUFRLEtBQUssaURBQWlELEtBQUs7QUFDbkUsYUFBTztBQUFBLElBQ1Q7QUFBQSxFQUNGO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLQSxNQUFjLGdCQUNaLEtBQ0EsWUFDQSxPQUNBLFFBQ2U7QUFDZixXQUFPLElBQUksUUFBUSxDQUFDLFNBQVMsV0FBVztBQUN0QyxVQUFJO0FBRUYsY0FBTSxVQUFVLElBQUksY0FBYyxFQUFFLGtCQUFrQixVQUFVO0FBR2hFLGNBQU0sTUFBTSxJQUFJLE1BQU07QUFFdEIsWUFBSSxTQUFTLE1BQU07QUFDakIsY0FBSTtBQUNGLGdCQUFJLFVBQVUsS0FBSyxHQUFHLEdBQUcsT0FBTyxNQUFNO0FBQ3RDLG9CQUFRO0FBQUEsVUFDVixTQUFTLE9BQU87QUFDZCxtQkFBTyxLQUFLO0FBQUEsVUFDZDtBQUFBLFFBQ0Y7QUFFQSxZQUFJLFVBQVUsTUFBTTtBQUNsQixpQkFBTyxJQUFJLE1BQU0sNkJBQTZCLENBQUM7QUFBQSxRQUNqRDtBQUdBLGNBQU0sVUFBVSxJQUFJLEtBQUssQ0FBQyxPQUFPLEdBQUc7QUFBQSxVQUNsQyxNQUFNO0FBQUEsUUFDUixDQUFDO0FBQ0QsY0FBTSxNQUFNLElBQUksZ0JBQWdCLE9BQU87QUFFdkMsWUFBSSxNQUFNO0FBR1YsWUFBSSxTQUFTLE1BQU07QUFDakIsY0FBSTtBQUNGLGdCQUFJLFVBQVUsS0FBSyxHQUFHLEdBQUcsT0FBTyxNQUFNO0FBQ3RDLGdCQUFJLGdCQUFnQixHQUFHO0FBQ3ZCLG9CQUFRO0FBQUEsVUFDVixTQUFTLE9BQU87QUFDZCxnQkFBSSxnQkFBZ0IsR0FBRztBQUN2QixtQkFBTyxLQUFLO0FBQUEsVUFDZDtBQUFBLFFBQ0Y7QUFBQSxNQUNGLFNBQVMsT0FBTztBQUNkLGVBQU8sS0FBSztBQUFBLE1BQ2Q7QUFBQSxJQUNGLENBQUM7QUFBQSxFQUNIO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLQSxNQUFjLHlCQUNaLEtBQ0EsVUFDQSxNQUNBLFNBQ2U7QUFDZixVQUFNLGFBQWEsU0FBUztBQUM1QixRQUFJLENBQUMsWUFBWTtBQUNmLFlBQU0sSUFBSSxNQUFNLDJDQUEyQztBQUFBLElBQzdEO0FBR0EsU0FBSyxTQUFTLEtBQUssV0FBVyxVQUFVLFlBQVksV0FBVyxJQUFJO0FBR25FLFFBQUksV0FBVyxPQUFPO0FBQ3BCLFVBQUksUUFBUSxlQUFlLFdBQVcsTUFBTSxNQUFNO0FBQ2hELGFBQUssU0FBUyxLQUFLLFdBQVcsTUFBTSxNQUFNLFFBQVEsSUFBSTtBQUFBLE1BQ3hEO0FBQ0EsVUFBSSxRQUFRLGNBQWMsV0FBVyxNQUFNLEtBQUs7QUFDOUMsYUFBSyxTQUFTLEtBQUssV0FBVyxNQUFNLEtBQUssT0FBTyxJQUFJO0FBQUEsTUFDdEQ7QUFBQSxJQUNGO0FBR0EsUUFBSSxXQUFXLFFBQVE7QUFDckIsVUFBSSxRQUFRLGVBQWUsV0FBVyxPQUFPLE1BQU07QUFDakQsYUFBSyxVQUFVLEtBQUssV0FBVyxPQUFPLE1BQU0sUUFBUSxJQUFJO0FBQUEsTUFDMUQ7QUFDQSxVQUFJLFFBQVEsY0FBYyxXQUFXLE9BQU8sS0FBSztBQUMvQyxhQUFLLFVBQVUsS0FBSyxXQUFXLE9BQU8sS0FBSyxPQUFPLElBQUk7QUFBQSxNQUN4RDtBQUFBLElBQ0Y7QUFHQSxRQUFJLFdBQVcsUUFBUTtBQUNyQixXQUFLLFdBQVcsS0FBSyxXQUFXLFFBQVEsSUFBSTtBQUFBLElBQzlDO0FBQUEsRUFDRjtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS0EsTUFBYyxnQkFDWixLQUNBLFVBQ0EsTUFDQSxTQUNlO0FBRWYsU0FBSyxTQUFTLEtBQUssV0FBVyxJQUFJO0FBR2xDLFFBQUksUUFBUSxrQkFBa0IsU0FBUyxhQUFhLEdBQUc7QUFDckQsV0FBSyxlQUFlLEtBQUssU0FBUyxZQUFZLElBQUk7QUFBQSxJQUNwRDtBQUFBLEVBQ0Y7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQUtBLE1BQWMsbUJBQ1osS0FDQSxVQUNBLE1BQ0EsU0FDZTtBQUVmLFFBQUksY0FBYztBQUNsQixRQUFJLFlBQVk7QUFDaEIsUUFBSSxXQUFXLElBQUksSUFBSSxPQUFPLElBQUksT0FBTyxFQUFFO0FBRzNDLFFBQUksVUFBVTtBQUNkLFFBQUksT0FBTyxJQUFJLEVBQUU7QUFDakIsUUFBSSxPQUFPLE9BQU8sSUFBSSxPQUFPLEVBQUU7QUFDL0IsUUFBSSxPQUFPLE9BQU8sSUFBSSxFQUFFO0FBQ3hCLFFBQUksT0FBTyxJQUFJLE9BQU8sRUFBRTtBQUN4QixRQUFJLE9BQU87QUFHWCxRQUFJLFFBQVEsZ0JBQWdCO0FBQzFCLFdBQUssZUFBZSxLQUFLLFNBQVMsWUFBWSxJQUFJO0FBQUEsSUFDcEQ7QUFBQSxFQUNGO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLQSxNQUFjLDJCQUNaLEtBQ0EsTUFDQSxVQUNlO0FBRWYsU0FBSyxTQUFTLEtBQUssV0FBVyxJQUFJO0FBR2xDLFVBQU0sVUFBVSxPQUFPO0FBQ3ZCLFVBQU0sVUFBVSxPQUFPO0FBQ3ZCLFVBQU0sU0FBUyxPQUFPO0FBRXRCLFFBQUksWUFBWTtBQUNoQixRQUFJLFVBQVU7QUFDZCxRQUFJLElBQUksU0FBUyxTQUFTLFFBQVEsR0FBRyxJQUFJLEtBQUssRUFBRTtBQUNoRCxRQUFJLEtBQUs7QUFBQSxFQUNYO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLUSxTQUNOLEtBQ0EsVUFDQSxNQUNNO0FBQ04sUUFBSSxjQUFjO0FBQ2xCLFFBQUksWUFBWTtBQUVoQixRQUFJLGFBQWEsV0FBVztBQUUxQixZQUFNLFVBQVUsT0FBTztBQUN2QixZQUFNLFVBQVUsT0FBTztBQUN2QixZQUFNLFNBQVMsT0FBTztBQUV0QixVQUFJLFVBQVU7QUFDZCxVQUFJLE9BQU8sU0FBUyxVQUFVLE1BQU07QUFDcEMsVUFBSSxPQUFPLFVBQVUsUUFBUSxPQUFPO0FBQ3BDLFVBQUksT0FBTyxTQUFTLFVBQVUsTUFBTTtBQUNwQyxVQUFJLE9BQU8sVUFBVSxRQUFRLE9BQU87QUFDcEMsVUFBSSxVQUFVO0FBQ2QsVUFBSSxPQUFPO0FBQUEsSUFDYixPQUFPO0FBRUwsWUFBTSxTQUFTLE9BQU87QUFDdEIsVUFBSSxXQUFXLFFBQVEsUUFBUSxPQUFPLElBQUksUUFBUSxPQUFPLElBQUksTUFBTTtBQUFBLElBQ3JFO0FBQUEsRUFDRjtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS1EsU0FDTixLQUNBLFVBQ0EsT0FDQSxNQUNNO0FBQ04sUUFBSSxDQUFDLFNBQVU7QUFFZixVQUFNLFVBQVUsT0FBTztBQUN2QixVQUFNLFVBQVUsT0FBTztBQUN2QixVQUFNLFNBQVMsT0FBTztBQUV0QixRQUFJLFlBQVksVUFBVSxTQUFTLFlBQVk7QUFDL0MsUUFBSSxVQUFVO0FBQ2QsUUFBSSxJQUFJLFNBQVMsU0FBUyxRQUFRLEdBQUcsSUFBSSxLQUFLLEVBQUU7QUFDaEQsUUFBSSxLQUFLO0FBQUEsRUFDWDtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS1EsVUFDTixLQUNBLFdBQ0EsT0FDQSxNQUNNO0FBQ04sUUFBSSxDQUFDLFVBQVc7QUFFaEIsVUFBTSxVQUFVLE9BQU87QUFDdkIsVUFBTSxVQUFVLE9BQU87QUFDdkIsVUFBTSxTQUFTLE9BQU87QUFFdEIsUUFBSSxjQUFjLFVBQVUsU0FBUyxZQUFZO0FBQ2pELFFBQUksWUFBWTtBQUdoQixRQUFJLFVBQVU7QUFDZCxRQUFJLE9BQU8sVUFBVSxTQUFTLEdBQUcsT0FBTztBQUN4QyxRQUFJLE9BQU8sVUFBVSxTQUFTLEdBQUcsT0FBTztBQUN4QyxRQUFJLE9BQU8sVUFBVSxTQUFTLElBQUksSUFBSSxVQUFVLENBQUM7QUFDakQsUUFBSSxPQUFPLFVBQVUsU0FBUyxHQUFHLE9BQU87QUFDeEMsUUFBSSxPQUFPLFVBQVUsU0FBUyxJQUFJLElBQUksVUFBVSxDQUFDO0FBQ2pELFFBQUksT0FBTztBQUFBLEVBQ2I7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQUtRLFdBQ04sS0FDQSxRQUNBLE1BQ007QUFDTixRQUFJLFlBQVk7QUFDaEIsUUFBSSxPQUFPLEdBQUcsT0FBTyxHQUFHO0FBQ3hCLFFBQUksWUFBWTtBQUNoQixRQUFJLGVBQWU7QUFDbkIsUUFBSSxTQUFTLFFBQVEsT0FBTyxHQUFHLE9BQU8sQ0FBQztBQUFBLEVBQ3pDO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLUSxlQUNOLEtBQ0EsWUFDQSxNQUNNO0FBQ04sUUFBSSxZQUFZO0FBQ2hCLFFBQUksT0FBTyxRQUFRLE9BQU8sSUFBSTtBQUM5QixRQUFJLFlBQVk7QUFDaEIsUUFBSSxlQUFlO0FBQ25CLFFBQUksU0FBUyxXQUFXLFNBQVMsR0FBRyxPQUFPLEdBQUcsT0FBTyxJQUFJO0FBQUEsRUFDM0Q7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQUtRLHlCQUNOLEtBQ0EsTUFDTTtBQUNOLFFBQUksWUFBWTtBQUNoQixRQUFJLE9BQU8sUUFBUSxPQUFPLElBQUk7QUFDOUIsUUFBSSxZQUFZO0FBQ2hCLFFBQUksZUFBZTtBQUNuQixRQUFJLFNBQVMsU0FBUyxPQUFPLEdBQUcsT0FBTyxJQUFJO0FBQUEsRUFDN0M7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQUtRLG9CQUNOLEtBQ0EsVUFDQSxNQUNBLFNBQ007QUFFTixRQUFJLFFBQVEsZUFBZTtBQUN6QixXQUFLLG1CQUFtQixLQUFLLElBQUk7QUFBQSxJQUNuQztBQUdBLFFBQUksU0FBUyxnQkFBZ0IsU0FBUyxhQUFhO0FBQ2pELFdBQUssb0JBQW9CLEtBQUssVUFBVSxJQUFJO0FBQUEsSUFDOUM7QUFBQSxFQUNGO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLUSxtQkFDTixLQUNBLE1BQ007QUFFTixRQUFJLGNBQWM7QUFDbEIsU0FBSyxTQUFTLEtBQUssV0FBVyxJQUFJO0FBQ2xDLFNBQUssU0FBUyxLQUFLLE9BQU8sSUFBSTtBQUM5QixRQUFJLGNBQWM7QUFBQSxFQUNwQjtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS1Esb0JBQ04sS0FDQSxVQUNBLE1BQ007QUFDTixVQUFNLGFBQWEsT0FBTztBQUUxQixRQUFJLFNBQVMsY0FBYztBQUN6QixVQUFJLFlBQVk7QUFDaEIsVUFBSSxTQUFTLE9BQU8sYUFBYSxHQUFHLEdBQUcsWUFBWSxVQUFVO0FBQUEsSUFDL0Q7QUFFQSxRQUFJLFNBQVMsYUFBYTtBQUN4QixVQUFJLFlBQVk7QUFDaEIsVUFBSTtBQUFBLFFBQ0YsT0FBTyxhQUFhO0FBQUEsUUFDcEIsYUFBYTtBQUFBLFFBQ2I7QUFBQSxRQUNBO0FBQUEsTUFDRjtBQUFBLElBQ0Y7QUFBQSxFQUNGO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLUSxrQkFDTixLQUNBLE9BQ0EsUUFDQSxTQUNNO0FBQ04sUUFBSSxDQUFDLFFBQVEsY0FBYyxDQUFDLFFBQVEsYUFBYTtBQUcvQyxjQUFRLEtBQUssMkNBQTJDO0FBQUEsSUFDMUQ7QUFBQSxFQUNGO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLUSxrQkFBa0IsT0FBZSxRQUFtQztBQUMxRSxVQUFNLFNBQVMsS0FBSyxXQUFXLElBQUksS0FBSyxTQUFTLGNBQWMsUUFBUTtBQUN2RSxXQUFPLFFBQVE7QUFDZixXQUFPLFNBQVM7QUFHaEIsVUFBTSxNQUFNLE9BQU8sV0FBVyxJQUFJO0FBQ2xDLFFBQUksQ0FBQyxLQUFLO0FBQ1IsWUFBTSxJQUFJLE1BQU0sc0NBQXNDO0FBQUEsSUFDeEQ7QUFDQSxRQUFJLFVBQVUsR0FBRyxHQUFHLE9BQU8sTUFBTTtBQUVqQyxXQUFPO0FBQUEsRUFDVDtBQUFBLEVBRVEsbUJBQW1CLFFBQWlDO0FBQzFELFFBQUksS0FBSyxXQUFXLFNBQVMsS0FBSyxlQUFlO0FBQy9DLFdBQUssV0FBVyxLQUFLLE1BQU07QUFBQSxJQUM3QjtBQUFBLEVBQ0Y7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQUtBLFVBQWdCO0FBQ2QsU0FBSyxXQUFXLFNBQVM7QUFBQSxFQUMzQjtBQUNGOyIsIm5hbWVzIjpbXX0=