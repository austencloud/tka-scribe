export class TKAImageExportService {
  constructor(compositionService, fileService, layoutService, dimensionService) {
    this.compositionService = compositionService;
    this.fileService = fileService;
    this.layoutService = layoutService;
    this.dimensionService = dimensionService;
  }
  /**
   * Export a complete sequence as an image blob
   * Main entry point for image export functionality
   */
  async exportSequenceImage(sequence, options = {}) {
    if (!sequence) {
      throw new Error("Sequence data is required for export");
    }
    const fullOptions = this.mergeWithDefaults(options);
    const validation = this.validateExport(sequence, fullOptions);
    if (!validation.valid) {
      throw new Error(
        `Export validation failed: ${validation.errors.join(", ")}`
      );
    }
    try {
      const canvas = await this.compositionService.composeSequenceImage(
        sequence,
        fullOptions
      );
      const blob = await this.fileService.canvasToBlob(
        canvas,
        fullOptions.format,
        fullOptions.quality
      );
      return blob;
    } catch (error) {
      throw new Error(
        `Image export failed: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Generate a preview image (smaller scale for UI)
   * Returns data URL for immediate display
   */
  async generatePreview(sequence, options = {}) {
    if (!sequence) {
      throw new Error("Sequence data is required for preview");
    }
    try {
      const previewOptions = this.createPreviewOptions(options);
      const canvas = await this.compositionService.composeSequenceImage(
        sequence,
        previewOptions
      );
      return this.fileService.canvasToDataURL(
        canvas,
        previewOptions.format,
        previewOptions.quality
      );
    } catch (error) {
      throw new Error(
        `Preview generation failed: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Export and download image file directly
   * Convenience method that handles the complete export-to-download flow
   */
  async exportAndDownload(sequence, filename, options = {}) {
    if (!sequence) {
      throw new Error("Sequence data is required for export and download");
    }
    try {
      const blob = await this.exportSequenceImage(sequence, options);
      const finalFilename = filename || this.generateDefaultFilename(sequence, options);
      await this.fileService.downloadBlob(blob, finalFilename);
    } catch (error) {
      throw new Error(
        `Export and download failed: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Validate sequence and options before export
   */
  validateExport(sequence, options) {
    const errors = [];
    if (!sequence) {
      errors.push("Sequence data is required");
    } else {
      if (!sequence.beats) {
        errors.push("Sequence must have beats array");
      } else if (sequence.beats.length === 0 && !options.includeStartPosition) {
        errors.push("Empty sequence requires start position to be included");
      } else if (sequence.beats.length > 64) {
        errors.push("Sequence has too many beats (maximum 64)");
      }
      if (options.addWord && (!sequence.word || sequence.word.trim().length === 0)) {
        errors.push('Sequence word is required when "add word" is enabled');
      }
    }
    if (!options) {
      errors.push("Export options are required");
    } else {
      if (options.beatScale <= 0 || options.beatScale > 5) {
        errors.push("Beat scale must be between 0.1 and 5");
      }
      if (options.beatSize <= 0 || options.beatSize > 1e3) {
        errors.push("Beat size must be between 1 and 1000 pixels");
      }
      if (options.margin < 0 || options.margin > 200) {
        errors.push("Margin must be between 0 and 200 pixels");
      }
      if (options.quality < 0 || options.quality > 1) {
        errors.push("Quality must be between 0 and 1");
      }
      if (!["PNG", "JPEG"].includes(options.format)) {
        errors.push("Format must be PNG or JPEG");
      }
      if (options.addUserInfo && !options.userName) {
        errors.push('User name is required when "add user info" is enabled');
      }
    }
    if (sequence && options) {
      const memoryEstimate = this.estimateMemoryUsage(sequence, options);
      if (memoryEstimate.estimatedMB > 200) {
        errors.push(
          `Image would require ${Math.round(memoryEstimate.estimatedMB)}MB memory (limit: 200MB)`
        );
      }
    }
    return {
      valid: errors.length === 0,
      errors
    };
  }
  /**
   * Get default export options
   * Matches desktop application defaults exactly
   */
  getDefaultOptions() {
    return {
      // Core export settings (match desktop defaults)
      includeStartPosition: true,
      addBeatNumbers: true,
      addReversalSymbols: true,
      addUserInfo: true,
      addWord: true,
      combinedGrids: false,
      // Scaling and sizing
      beatScale: 1,
      beatSize: 144,
      // Match desktop base beat size
      margin: 50,
      // Match desktop base margin
      // Visibility settings
      redVisible: true,
      blueVisible: true,
      // User information
      userName: "TKA User",
      exportDate: (/* @__PURE__ */ new Date()).toLocaleDateString("en-US", {
        year: "numeric",
        month: "numeric",
        day: "numeric"
      }).replace(/\//g, "-"),
      notes: "Created using The Kinetic Alphabet",
      // Output format
      format: "PNG",
      quality: 1,
      // Maximum quality
      // Additional features
      addDifficultyLevel: false
    };
  }
  /**
   * Merge provided options with defaults
   */
  mergeWithDefaults(options) {
    const defaults = this.getDefaultOptions();
    return { ...defaults, ...options };
  }
  /**
   * Create preview-optimized options
   */
  createPreviewOptions(options) {
    const baseOptions = this.mergeWithDefaults(options);
    return {
      ...baseOptions,
      beatScale: baseOptions.beatScale * 0.5,
      // Smaller scale for preview
      quality: 0.8,
      // Lower quality for faster generation
      // Disable expensive features for preview
      addReversalSymbols: false,
      combinedGrids: false
    };
  }
  /**
   * Generate default filename for export
   */
  generateDefaultFilename(sequence, options) {
    const word = sequence.word || "sequence";
    const format = options.format || "PNG";
    return this.fileService.generateVersionedFilename(word, format);
  }
  /**
   * Estimate memory usage for export
   */
  estimateMemoryUsage(sequence, options) {
    const beatCount = sequence.beats.length;
    const [columns, rows] = this.layoutService.calculateLayout(
      beatCount,
      options.includeStartPosition
    );
    const [additionalTop, additionalBottom] = this.dimensionService.determineAdditionalHeights(
      options,
      beatCount,
      options.beatScale
    );
    const [width, height] = this.layoutService.calculateImageDimensions(
      [columns, rows],
      additionalTop + additionalBottom,
      options.beatScale
    );
    const mainCanvasBytes = width * height * 4;
    const beatCanvasBytes = beatCount * (options.beatSize * options.beatScale) ** 2 * 4;
    const totalBytes = mainCanvasBytes + beatCanvasBytes * 2;
    const estimatedMB = totalBytes / (1024 * 1024);
    const safe = estimatedMB < 200;
    return { estimatedMB, safe };
  }
  /**
   * Get export capabilities and limits
   */
  getExportCapabilities() {
    return {
      maxSequenceLength: 64,
      supportedFormats: ["PNG", "JPEG"],
      maxImageDimensions: { width: 16384, height: 16384 },
      maxMemoryMB: 200,
      supportedFeatures: [
        "includeStartPosition",
        "addBeatNumbers",
        "addReversalSymbols",
        "addUserInfo",
        "addWord",
        "addDifficultyLevel",
        "combinedGrids",
        "customScaling",
        "visibilityControl"
      ]
    };
  }
  /**
   * Batch export multiple sequences
   */
  async batchExport(sequences, options = {}, progressCallback) {
    const results = [];
    for (let i = 0; i < sequences.length; i++) {
      const sequence = sequences[i];
      try {
        const blob = await this.exportSequenceImage(sequence, options);
        results.push({ sequence, blob });
      } catch (error) {
        results.push({
          sequence,
          blob: null,
          error: error instanceof Error ? error.message : "Unknown error"
        });
      }
      progressCallback?.(i + 1, sequences.length);
    }
  }
  /**
   * Export with custom canvas size (for special use cases)
   */
  async exportWithCustomSize(sequence, targetWidth, targetHeight, options = {}) {
    const beatCount = sequence.beats.length;
    const [columns, rows] = this.layoutService.calculateLayout(
      beatCount,
      options.includeStartPosition ?? true
    );
    const baseOptions = this.mergeWithDefaults(options);
    const [additionalTop, additionalBottom] = this.dimensionService.determineAdditionalHeights(
      baseOptions,
      beatCount,
      1
      // Use scale 1.0 for calculation
    );
    const [baseWidth, baseHeight] = this.layoutService.calculateImageDimensions(
      [columns, rows],
      additionalTop + additionalBottom,
      1
      // Use scale 1.0 for calculation
    );
    const scaleX = targetWidth / baseWidth;
    const scaleY = targetHeight / baseHeight;
    const scale = Math.min(scaleX, scaleY);
    const customOptions = {
      ...baseOptions,
      beatScale: scale
    };
    return await this.exportSequenceImage(sequence, customOptions);
  }
  /**
   * Debug method to test export pipeline
   */
  async debugExport() {
    let defaultOptionsTest = false;
    let validationTest = false;
    let previewTest = false;
    let exportTest = false;
    try {
      const defaults = this.getDefaultOptions();
      defaultOptionsTest = defaults.beatScale === 1 && defaults.format === "PNG";
      const testSequence = {
        id: "test",
        name: "Test",
        word: "TEST",
        beats: [],
        thumbnails: [],
        is_favorite: false,
        is_circular: false,
        tags: [],
        metadata: {}
      };
      const validation = this.validateExport(testSequence, defaults);
      validationTest = validation.valid;
      const preview = await this.generatePreview(testSequence);
      previewTest = preview.startsWith("data:image/");
      const blob = await this.exportSequenceImage(testSequence);
      exportTest = blob.size > 0;
    } catch (error) {
      console.error("Export debug failed:", error);
    }
    return {
      defaultOptionsTest,
      validationTest,
      previewTest,
      exportTest
    };
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRLQUltYWdlRXhwb3J0U2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRLQSBJbWFnZSBFeHBvcnQgU2VydmljZVxuICpcbiAqIE1haW4gb3JjaGVzdHJhdG9yIGZvciBUS0Egc2VxdWVuY2UgaW1hZ2UgZXhwb3J0LiBUaGlzIHNlcnZpY2UgcHJvdmlkZXMgdGhlXG4gKiB0b3AtbGV2ZWwgQVBJIGZvciBleHBvcnRpbmcgc2VxdWVuY2VzIGFzIGltYWdlcywgY29vcmRpbmF0aW5nIGFsbCB0aGVcbiAqIHNwZWNpYWxpemVkIHNlcnZpY2VzIHRvIGNyZWF0ZSBwaXhlbC1wZXJmZWN0IGltYWdlcyBtYXRjaGluZyB0aGUgZGVza3RvcFxuICogYXBwbGljYXRpb24ncyBvdXRwdXQuXG4gKlxuICogRXF1aXZhbGVudCB0byBkZXNrdG9wIEltYWdlRXhwb3J0TWFuYWdlci5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7XG4gIElUS0FJbWFnZUV4cG9ydFNlcnZpY2UsXG4gIElJbWFnZUNvbXBvc2l0aW9uU2VydmljZSxcbiAgSUZpbGVFeHBvcnRTZXJ2aWNlLFxuICBJTGF5b3V0Q2FsY3VsYXRpb25TZXJ2aWNlLFxuICBJRGltZW5zaW9uQ2FsY3VsYXRpb25TZXJ2aWNlLFxuICBUS0FJbWFnZUV4cG9ydE9wdGlvbnMsXG59IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL2ltYWdlLWV4cG9ydC1pbnRlcmZhY2VzXCI7XG5pbXBvcnQgdHlwZSB7IFNlcXVlbmNlRGF0YSB9IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL2RvbWFpbi10eXBlc1wiO1xuXG5leHBvcnQgY2xhc3MgVEtBSW1hZ2VFeHBvcnRTZXJ2aWNlIGltcGxlbWVudHMgSVRLQUltYWdlRXhwb3J0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY29tcG9zaXRpb25TZXJ2aWNlOiBJSW1hZ2VDb21wb3NpdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBmaWxlU2VydmljZTogSUZpbGVFeHBvcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgbGF5b3V0U2VydmljZTogSUxheW91dENhbGN1bGF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGRpbWVuc2lvblNlcnZpY2U6IElEaW1lbnNpb25DYWxjdWxhdGlvblNlcnZpY2VcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBFeHBvcnQgYSBjb21wbGV0ZSBzZXF1ZW5jZSBhcyBhbiBpbWFnZSBibG9iXG4gICAqIE1haW4gZW50cnkgcG9pbnQgZm9yIGltYWdlIGV4cG9ydCBmdW5jdGlvbmFsaXR5XG4gICAqL1xuICBhc3luYyBleHBvcnRTZXF1ZW5jZUltYWdlKFxuICAgIHNlcXVlbmNlOiBTZXF1ZW5jZURhdGEsXG4gICAgb3B0aW9uczogUGFydGlhbDxUS0FJbWFnZUV4cG9ydE9wdGlvbnM+ID0ge31cbiAgKTogUHJvbWlzZTxCbG9iPiB7XG4gICAgaWYgKCFzZXF1ZW5jZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiU2VxdWVuY2UgZGF0YSBpcyByZXF1aXJlZCBmb3IgZXhwb3J0XCIpO1xuICAgIH1cblxuICAgIC8vIE1lcmdlIHdpdGggZGVmYXVsdHMgdG8gZ2V0IGNvbXBsZXRlIG9wdGlvbnNcbiAgICBjb25zdCBmdWxsT3B0aW9ucyA9IHRoaXMubWVyZ2VXaXRoRGVmYXVsdHMob3B0aW9ucyk7XG5cbiAgICAvLyBWYWxpZGF0ZSBleHBvcnQgcGFyYW1ldGVyc1xuICAgIGNvbnN0IHZhbGlkYXRpb24gPSB0aGlzLnZhbGlkYXRlRXhwb3J0KHNlcXVlbmNlLCBmdWxsT3B0aW9ucyk7XG4gICAgaWYgKCF2YWxpZGF0aW9uLnZhbGlkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBFeHBvcnQgdmFsaWRhdGlvbiBmYWlsZWQ6ICR7dmFsaWRhdGlvbi5lcnJvcnMuam9pbihcIiwgXCIpfWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENvbXBvc2UgdGhlIGltYWdlXG4gICAgICBjb25zdCBjYW52YXMgPSBhd2FpdCB0aGlzLmNvbXBvc2l0aW9uU2VydmljZS5jb21wb3NlU2VxdWVuY2VJbWFnZShcbiAgICAgICAgc2VxdWVuY2UsXG4gICAgICAgIGZ1bGxPcHRpb25zXG4gICAgICApO1xuXG4gICAgICAvLyBDb252ZXJ0IHRvIGJsb2JcbiAgICAgIGNvbnN0IGJsb2IgPSBhd2FpdCB0aGlzLmZpbGVTZXJ2aWNlLmNhbnZhc1RvQmxvYihcbiAgICAgICAgY2FudmFzLFxuICAgICAgICBmdWxsT3B0aW9ucy5mb3JtYXQsXG4gICAgICAgIGZ1bGxPcHRpb25zLnF1YWxpdHlcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiBibG9iO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBJbWFnZSBleHBvcnQgZmFpbGVkOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCJ9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgYSBwcmV2aWV3IGltYWdlIChzbWFsbGVyIHNjYWxlIGZvciBVSSlcbiAgICogUmV0dXJucyBkYXRhIFVSTCBmb3IgaW1tZWRpYXRlIGRpc3BsYXlcbiAgICovXG4gIGFzeW5jIGdlbmVyYXRlUHJldmlldyhcbiAgICBzZXF1ZW5jZTogU2VxdWVuY2VEYXRhLFxuICAgIG9wdGlvbnM6IFBhcnRpYWw8VEtBSW1hZ2VFeHBvcnRPcHRpb25zPiA9IHt9XG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgaWYgKCFzZXF1ZW5jZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiU2VxdWVuY2UgZGF0YSBpcyByZXF1aXJlZCBmb3IgcHJldmlld1wiKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gQ3JlYXRlIHByZXZpZXcgb3B0aW9ucyB3aXRoIHNtYWxsZXIgc2NhbGVcbiAgICAgIGNvbnN0IHByZXZpZXdPcHRpb25zID0gdGhpcy5jcmVhdGVQcmV2aWV3T3B0aW9ucyhvcHRpb25zKTtcblxuICAgICAgLy8gQ29tcG9zZSBwcmV2aWV3IGltYWdlXG4gICAgICBjb25zdCBjYW52YXMgPSBhd2FpdCB0aGlzLmNvbXBvc2l0aW9uU2VydmljZS5jb21wb3NlU2VxdWVuY2VJbWFnZShcbiAgICAgICAgc2VxdWVuY2UsXG4gICAgICAgIHByZXZpZXdPcHRpb25zXG4gICAgICApO1xuXG4gICAgICAvLyBDb252ZXJ0IHRvIGRhdGEgVVJMIGZvciBpbW1lZGlhdGUgZGlzcGxheVxuICAgICAgcmV0dXJuIHRoaXMuZmlsZVNlcnZpY2UuY2FudmFzVG9EYXRhVVJMKFxuICAgICAgICBjYW52YXMsXG4gICAgICAgIHByZXZpZXdPcHRpb25zLmZvcm1hdCxcbiAgICAgICAgcHJldmlld09wdGlvbnMucXVhbGl0eVxuICAgICAgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgUHJldmlldyBnZW5lcmF0aW9uIGZhaWxlZDogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFwiVW5rbm93biBlcnJvclwifWBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEV4cG9ydCBhbmQgZG93bmxvYWQgaW1hZ2UgZmlsZSBkaXJlY3RseVxuICAgKiBDb252ZW5pZW5jZSBtZXRob2QgdGhhdCBoYW5kbGVzIHRoZSBjb21wbGV0ZSBleHBvcnQtdG8tZG93bmxvYWQgZmxvd1xuICAgKi9cbiAgYXN5bmMgZXhwb3J0QW5kRG93bmxvYWQoXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBmaWxlbmFtZT86IHN0cmluZyxcbiAgICBvcHRpb25zOiBQYXJ0aWFsPFRLQUltYWdlRXhwb3J0T3B0aW9ucz4gPSB7fVxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXNlcXVlbmNlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJTZXF1ZW5jZSBkYXRhIGlzIHJlcXVpcmVkIGZvciBleHBvcnQgYW5kIGRvd25sb2FkXCIpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBHZW5lcmF0ZSB0aGUgaW1hZ2UgYmxvYlxuICAgICAgY29uc3QgYmxvYiA9IGF3YWl0IHRoaXMuZXhwb3J0U2VxdWVuY2VJbWFnZShzZXF1ZW5jZSwgb3B0aW9ucyk7XG5cbiAgICAgIC8vIEdlbmVyYXRlIGZpbGVuYW1lIGlmIG5vdCBwcm92aWRlZFxuICAgICAgY29uc3QgZmluYWxGaWxlbmFtZSA9XG4gICAgICAgIGZpbGVuYW1lIHx8IHRoaXMuZ2VuZXJhdGVEZWZhdWx0RmlsZW5hbWUoc2VxdWVuY2UsIG9wdGlvbnMpO1xuXG4gICAgICAvLyBEb3dubG9hZCB0aGUgZmlsZVxuICAgICAgYXdhaXQgdGhpcy5maWxlU2VydmljZS5kb3dubG9hZEJsb2IoYmxvYiwgZmluYWxGaWxlbmFtZSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEV4cG9ydCBhbmQgZG93bmxvYWQgZmFpbGVkOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCJ9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgc2VxdWVuY2UgYW5kIG9wdGlvbnMgYmVmb3JlIGV4cG9ydFxuICAgKi9cbiAgdmFsaWRhdGVFeHBvcnQoXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBvcHRpb25zOiBUS0FJbWFnZUV4cG9ydE9wdGlvbnNcbiAgKTogeyB2YWxpZDogYm9vbGVhbjsgZXJyb3JzOiBzdHJpbmdbXSB9IHtcbiAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG5cbiAgICAvLyBWYWxpZGF0ZSBzZXF1ZW5jZVxuICAgIGlmICghc2VxdWVuY2UpIHtcbiAgICAgIGVycm9ycy5wdXNoKFwiU2VxdWVuY2UgZGF0YSBpcyByZXF1aXJlZFwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFzZXF1ZW5jZS5iZWF0cykge1xuICAgICAgICBlcnJvcnMucHVzaChcIlNlcXVlbmNlIG11c3QgaGF2ZSBiZWF0cyBhcnJheVwiKTtcbiAgICAgIH0gZWxzZSBpZiAoc2VxdWVuY2UuYmVhdHMubGVuZ3RoID09PSAwICYmICFvcHRpb25zLmluY2x1ZGVTdGFydFBvc2l0aW9uKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKFwiRW1wdHkgc2VxdWVuY2UgcmVxdWlyZXMgc3RhcnQgcG9zaXRpb24gdG8gYmUgaW5jbHVkZWRcIik7XG4gICAgICB9IGVsc2UgaWYgKHNlcXVlbmNlLmJlYXRzLmxlbmd0aCA+IDY0KSB7XG4gICAgICAgIGVycm9ycy5wdXNoKFwiU2VxdWVuY2UgaGFzIHRvbyBtYW55IGJlYXRzIChtYXhpbXVtIDY0KVwiKTtcbiAgICAgIH1cblxuICAgICAgaWYgKFxuICAgICAgICBvcHRpb25zLmFkZFdvcmQgJiZcbiAgICAgICAgKCFzZXF1ZW5jZS53b3JkIHx8IHNlcXVlbmNlLndvcmQudHJpbSgpLmxlbmd0aCA9PT0gMClcbiAgICAgICkge1xuICAgICAgICBlcnJvcnMucHVzaCgnU2VxdWVuY2Ugd29yZCBpcyByZXF1aXJlZCB3aGVuIFwiYWRkIHdvcmRcIiBpcyBlbmFibGVkJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgb3B0aW9uc1xuICAgIGlmICghb3B0aW9ucykge1xuICAgICAgZXJyb3JzLnB1c2goXCJFeHBvcnQgb3B0aW9ucyBhcmUgcmVxdWlyZWRcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChvcHRpb25zLmJlYXRTY2FsZSA8PSAwIHx8IG9wdGlvbnMuYmVhdFNjYWxlID4gNSkge1xuICAgICAgICBlcnJvcnMucHVzaChcIkJlYXQgc2NhbGUgbXVzdCBiZSBiZXR3ZWVuIDAuMSBhbmQgNVwiKTtcbiAgICAgIH1cblxuICAgICAgaWYgKG9wdGlvbnMuYmVhdFNpemUgPD0gMCB8fCBvcHRpb25zLmJlYXRTaXplID4gMTAwMCkge1xuICAgICAgICBlcnJvcnMucHVzaChcIkJlYXQgc2l6ZSBtdXN0IGJlIGJldHdlZW4gMSBhbmQgMTAwMCBwaXhlbHNcIik7XG4gICAgICB9XG5cbiAgICAgIGlmIChvcHRpb25zLm1hcmdpbiA8IDAgfHwgb3B0aW9ucy5tYXJnaW4gPiAyMDApIHtcbiAgICAgICAgZXJyb3JzLnB1c2goXCJNYXJnaW4gbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDIwMCBwaXhlbHNcIik7XG4gICAgICB9XG5cbiAgICAgIGlmIChvcHRpb25zLnF1YWxpdHkgPCAwIHx8IG9wdGlvbnMucXVhbGl0eSA+IDEpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goXCJRdWFsaXR5IG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxXCIpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIVtcIlBOR1wiLCBcIkpQRUdcIl0uaW5jbHVkZXMob3B0aW9ucy5mb3JtYXQpKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKFwiRm9ybWF0IG11c3QgYmUgUE5HIG9yIEpQRUdcIik7XG4gICAgICB9XG5cbiAgICAgIGlmIChvcHRpb25zLmFkZFVzZXJJbmZvICYmICFvcHRpb25zLnVzZXJOYW1lKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdVc2VyIG5hbWUgaXMgcmVxdWlyZWQgd2hlbiBcImFkZCB1c2VyIGluZm9cIiBpcyBlbmFibGVkJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgbWVtb3J5IHJlcXVpcmVtZW50c1xuICAgIGlmIChzZXF1ZW5jZSAmJiBvcHRpb25zKSB7XG4gICAgICBjb25zdCBtZW1vcnlFc3RpbWF0ZSA9IHRoaXMuZXN0aW1hdGVNZW1vcnlVc2FnZShzZXF1ZW5jZSwgb3B0aW9ucyk7XG4gICAgICBpZiAobWVtb3J5RXN0aW1hdGUuZXN0aW1hdGVkTUIgPiAyMDApIHtcbiAgICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgICAgYEltYWdlIHdvdWxkIHJlcXVpcmUgJHtNYXRoLnJvdW5kKG1lbW9yeUVzdGltYXRlLmVzdGltYXRlZE1CKX1NQiBtZW1vcnkgKGxpbWl0OiAyMDBNQilgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHZhbGlkOiBlcnJvcnMubGVuZ3RoID09PSAwLFxuICAgICAgZXJyb3JzLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IGRlZmF1bHQgZXhwb3J0IG9wdGlvbnNcbiAgICogTWF0Y2hlcyBkZXNrdG9wIGFwcGxpY2F0aW9uIGRlZmF1bHRzIGV4YWN0bHlcbiAgICovXG4gIGdldERlZmF1bHRPcHRpb25zKCk6IFRLQUltYWdlRXhwb3J0T3B0aW9ucyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC8vIENvcmUgZXhwb3J0IHNldHRpbmdzIChtYXRjaCBkZXNrdG9wIGRlZmF1bHRzKVxuICAgICAgaW5jbHVkZVN0YXJ0UG9zaXRpb246IHRydWUsXG4gICAgICBhZGRCZWF0TnVtYmVyczogdHJ1ZSxcbiAgICAgIGFkZFJldmVyc2FsU3ltYm9sczogdHJ1ZSxcbiAgICAgIGFkZFVzZXJJbmZvOiB0cnVlLFxuICAgICAgYWRkV29yZDogdHJ1ZSxcbiAgICAgIGNvbWJpbmVkR3JpZHM6IGZhbHNlLFxuXG4gICAgICAvLyBTY2FsaW5nIGFuZCBzaXppbmdcbiAgICAgIGJlYXRTY2FsZTogMS4wLFxuICAgICAgYmVhdFNpemU6IDE0NCwgLy8gTWF0Y2ggZGVza3RvcCBiYXNlIGJlYXQgc2l6ZVxuICAgICAgbWFyZ2luOiA1MCwgLy8gTWF0Y2ggZGVza3RvcCBiYXNlIG1hcmdpblxuXG4gICAgICAvLyBWaXNpYmlsaXR5IHNldHRpbmdzXG4gICAgICByZWRWaXNpYmxlOiB0cnVlLFxuICAgICAgYmx1ZVZpc2libGU6IHRydWUsXG5cbiAgICAgIC8vIFVzZXIgaW5mb3JtYXRpb25cbiAgICAgIHVzZXJOYW1lOiBcIlRLQSBVc2VyXCIsXG4gICAgICBleHBvcnREYXRlOiBuZXcgRGF0ZSgpXG4gICAgICAgIC50b0xvY2FsZURhdGVTdHJpbmcoXCJlbi1VU1wiLCB7XG4gICAgICAgICAgeWVhcjogXCJudW1lcmljXCIsXG4gICAgICAgICAgbW9udGg6IFwibnVtZXJpY1wiLFxuICAgICAgICAgIGRheTogXCJudW1lcmljXCIsXG4gICAgICAgIH0pXG4gICAgICAgIC5yZXBsYWNlKC9cXC8vZywgXCItXCIpLFxuICAgICAgbm90ZXM6IFwiQ3JlYXRlZCB1c2luZyBUaGUgS2luZXRpYyBBbHBoYWJldFwiLFxuXG4gICAgICAvLyBPdXRwdXQgZm9ybWF0XG4gICAgICBmb3JtYXQ6IFwiUE5HXCIsXG4gICAgICBxdWFsaXR5OiAxLjAsIC8vIE1heGltdW0gcXVhbGl0eVxuXG4gICAgICAvLyBBZGRpdGlvbmFsIGZlYXR1cmVzXG4gICAgICBhZGREaWZmaWN1bHR5TGV2ZWw6IGZhbHNlLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogTWVyZ2UgcHJvdmlkZWQgb3B0aW9ucyB3aXRoIGRlZmF1bHRzXG4gICAqL1xuICBwcml2YXRlIG1lcmdlV2l0aERlZmF1bHRzKFxuICAgIG9wdGlvbnM6IFBhcnRpYWw8VEtBSW1hZ2VFeHBvcnRPcHRpb25zPlxuICApOiBUS0FJbWFnZUV4cG9ydE9wdGlvbnMge1xuICAgIGNvbnN0IGRlZmF1bHRzID0gdGhpcy5nZXREZWZhdWx0T3B0aW9ucygpO1xuICAgIHJldHVybiB7IC4uLmRlZmF1bHRzLCAuLi5vcHRpb25zIH07XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIHByZXZpZXctb3B0aW1pemVkIG9wdGlvbnNcbiAgICovXG4gIHByaXZhdGUgY3JlYXRlUHJldmlld09wdGlvbnMoXG4gICAgb3B0aW9uczogUGFydGlhbDxUS0FJbWFnZUV4cG9ydE9wdGlvbnM+XG4gICk6IFRLQUltYWdlRXhwb3J0T3B0aW9ucyB7XG4gICAgY29uc3QgYmFzZU9wdGlvbnMgPSB0aGlzLm1lcmdlV2l0aERlZmF1bHRzKG9wdGlvbnMpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLmJhc2VPcHRpb25zLFxuICAgICAgYmVhdFNjYWxlOiBiYXNlT3B0aW9ucy5iZWF0U2NhbGUgKiAwLjUsIC8vIFNtYWxsZXIgc2NhbGUgZm9yIHByZXZpZXdcbiAgICAgIHF1YWxpdHk6IDAuOCwgLy8gTG93ZXIgcXVhbGl0eSBmb3IgZmFzdGVyIGdlbmVyYXRpb25cbiAgICAgIC8vIERpc2FibGUgZXhwZW5zaXZlIGZlYXR1cmVzIGZvciBwcmV2aWV3XG4gICAgICBhZGRSZXZlcnNhbFN5bWJvbHM6IGZhbHNlLFxuICAgICAgY29tYmluZWRHcmlkczogZmFsc2UsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBkZWZhdWx0IGZpbGVuYW1lIGZvciBleHBvcnRcbiAgICovXG4gIHByaXZhdGUgZ2VuZXJhdGVEZWZhdWx0RmlsZW5hbWUoXG4gICAgc2VxdWVuY2U6IFNlcXVlbmNlRGF0YSxcbiAgICBvcHRpb25zOiBQYXJ0aWFsPFRLQUltYWdlRXhwb3J0T3B0aW9ucz5cbiAgKTogc3RyaW5nIHtcbiAgICBjb25zdCB3b3JkID0gc2VxdWVuY2Uud29yZCB8fCBcInNlcXVlbmNlXCI7XG4gICAgY29uc3QgZm9ybWF0ID0gb3B0aW9ucy5mb3JtYXQgfHwgXCJQTkdcIjtcblxuICAgIHJldHVybiB0aGlzLmZpbGVTZXJ2aWNlLmdlbmVyYXRlVmVyc2lvbmVkRmlsZW5hbWUod29yZCwgZm9ybWF0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFc3RpbWF0ZSBtZW1vcnkgdXNhZ2UgZm9yIGV4cG9ydFxuICAgKi9cbiAgcHJpdmF0ZSBlc3RpbWF0ZU1lbW9yeVVzYWdlKFxuICAgIHNlcXVlbmNlOiBTZXF1ZW5jZURhdGEsXG4gICAgb3B0aW9uczogVEtBSW1hZ2VFeHBvcnRPcHRpb25zXG4gICk6IHsgZXN0aW1hdGVkTUI6IG51bWJlcjsgc2FmZTogYm9vbGVhbiB9IHtcbiAgICBjb25zdCBiZWF0Q291bnQgPSBzZXF1ZW5jZS5iZWF0cy5sZW5ndGg7XG5cbiAgICAvLyBDYWxjdWxhdGUgbGF5b3V0IGFuZCBkaW1lbnNpb25zXG4gICAgY29uc3QgW2NvbHVtbnMsIHJvd3NdID0gdGhpcy5sYXlvdXRTZXJ2aWNlLmNhbGN1bGF0ZUxheW91dChcbiAgICAgIGJlYXRDb3VudCxcbiAgICAgIG9wdGlvbnMuaW5jbHVkZVN0YXJ0UG9zaXRpb25cbiAgICApO1xuXG4gICAgY29uc3QgW2FkZGl0aW9uYWxUb3AsIGFkZGl0aW9uYWxCb3R0b21dID1cbiAgICAgIHRoaXMuZGltZW5zaW9uU2VydmljZS5kZXRlcm1pbmVBZGRpdGlvbmFsSGVpZ2h0cyhcbiAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgYmVhdENvdW50LFxuICAgICAgICBvcHRpb25zLmJlYXRTY2FsZVxuICAgICAgKTtcblxuICAgIGNvbnN0IFt3aWR0aCwgaGVpZ2h0XSA9IHRoaXMubGF5b3V0U2VydmljZS5jYWxjdWxhdGVJbWFnZURpbWVuc2lvbnMoXG4gICAgICBbY29sdW1ucywgcm93c10sXG4gICAgICBhZGRpdGlvbmFsVG9wICsgYWRkaXRpb25hbEJvdHRvbSxcbiAgICAgIG9wdGlvbnMuYmVhdFNjYWxlXG4gICAgKTtcblxuICAgIC8vIEVzdGltYXRlIG1lbW9yeSB1c2FnZVxuICAgIGNvbnN0IG1haW5DYW52YXNCeXRlcyA9IHdpZHRoICogaGVpZ2h0ICogNDsgLy8gUkdCQVxuICAgIGNvbnN0IGJlYXRDYW52YXNCeXRlcyA9XG4gICAgICBiZWF0Q291bnQgKiAob3B0aW9ucy5iZWF0U2l6ZSAqIG9wdGlvbnMuYmVhdFNjYWxlKSAqKiAyICogNDtcbiAgICBjb25zdCB0b3RhbEJ5dGVzID0gbWFpbkNhbnZhc0J5dGVzICsgYmVhdENhbnZhc0J5dGVzICogMjsgLy8gMnggZm9yIHByb2Nlc3Npbmcgb3ZlcmhlYWRcblxuICAgIGNvbnN0IGVzdGltYXRlZE1CID0gdG90YWxCeXRlcyAvICgxMDI0ICogMTAyNCk7XG4gICAgY29uc3Qgc2FmZSA9IGVzdGltYXRlZE1CIDwgMjAwOyAvLyAyMDBNQiBjb25zZXJ2YXRpdmUgbGltaXRcblxuICAgIHJldHVybiB7IGVzdGltYXRlZE1CLCBzYWZlIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IGV4cG9ydCBjYXBhYmlsaXRpZXMgYW5kIGxpbWl0c1xuICAgKi9cbiAgZ2V0RXhwb3J0Q2FwYWJpbGl0aWVzKCk6IHtcbiAgICBtYXhTZXF1ZW5jZUxlbmd0aDogbnVtYmVyO1xuICAgIHN1cHBvcnRlZEZvcm1hdHM6IHN0cmluZ1tdO1xuICAgIG1heEltYWdlRGltZW5zaW9uczogeyB3aWR0aDogbnVtYmVyOyBoZWlnaHQ6IG51bWJlciB9O1xuICAgIG1heE1lbW9yeU1COiBudW1iZXI7XG4gICAgc3VwcG9ydGVkRmVhdHVyZXM6IHN0cmluZ1tdO1xuICB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgbWF4U2VxdWVuY2VMZW5ndGg6IDY0LFxuICAgICAgc3VwcG9ydGVkRm9ybWF0czogW1wiUE5HXCIsIFwiSlBFR1wiXSxcbiAgICAgIG1heEltYWdlRGltZW5zaW9uczogeyB3aWR0aDogMTYzODQsIGhlaWdodDogMTYzODQgfSxcbiAgICAgIG1heE1lbW9yeU1COiAyMDAsXG4gICAgICBzdXBwb3J0ZWRGZWF0dXJlczogW1xuICAgICAgICBcImluY2x1ZGVTdGFydFBvc2l0aW9uXCIsXG4gICAgICAgIFwiYWRkQmVhdE51bWJlcnNcIixcbiAgICAgICAgXCJhZGRSZXZlcnNhbFN5bWJvbHNcIixcbiAgICAgICAgXCJhZGRVc2VySW5mb1wiLFxuICAgICAgICBcImFkZFdvcmRcIixcbiAgICAgICAgXCJhZGREaWZmaWN1bHR5TGV2ZWxcIixcbiAgICAgICAgXCJjb21iaW5lZEdyaWRzXCIsXG4gICAgICAgIFwiY3VzdG9tU2NhbGluZ1wiLFxuICAgICAgICBcInZpc2liaWxpdHlDb250cm9sXCIsXG4gICAgICBdLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQmF0Y2ggZXhwb3J0IG11bHRpcGxlIHNlcXVlbmNlc1xuICAgKi9cbiAgYXN5bmMgYmF0Y2hFeHBvcnQoXG4gICAgc2VxdWVuY2VzOiBTZXF1ZW5jZURhdGFbXSxcbiAgICBvcHRpb25zOiBQYXJ0aWFsPFRLQUltYWdlRXhwb3J0T3B0aW9ucz4gPSB7fSxcbiAgICBwcm9ncmVzc0NhbGxiYWNrPzogKGN1cnJlbnQ6IG51bWJlciwgdG90YWw6IG51bWJlcikgPT4gdm9pZFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXN1bHRzOiBBcnJheTx7XG4gICAgICBzZXF1ZW5jZTogU2VxdWVuY2VEYXRhO1xuICAgICAgYmxvYjogQmxvYiB8IG51bGw7XG4gICAgICBlcnJvcj86IHN0cmluZztcbiAgICB9PiA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZXF1ZW5jZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHNlcXVlbmNlID0gc2VxdWVuY2VzW2ldO1xuXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBibG9iID0gYXdhaXQgdGhpcy5leHBvcnRTZXF1ZW5jZUltYWdlKHNlcXVlbmNlLCBvcHRpb25zKTtcbiAgICAgICAgcmVzdWx0cy5wdXNoKHsgc2VxdWVuY2UsIGJsb2IgfSk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZXN1bHRzLnB1c2goe1xuICAgICAgICAgIHNlcXVlbmNlLFxuICAgICAgICAgIGJsb2I6IG51bGwsXG4gICAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCIsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBwcm9ncmVzc0NhbGxiYWNrPy4oaSArIDEsIHNlcXVlbmNlcy5sZW5ndGgpO1xuICAgIH1cblxuICAgIC8vIE1ldGhvZCByZXR1cm5zIHZvaWQgLSByZXN1bHRzIGFyZSBoYW5kbGVkIHRocm91Z2ggZG93bmxvYWRzXG4gIH1cblxuICAvKipcbiAgICogRXhwb3J0IHdpdGggY3VzdG9tIGNhbnZhcyBzaXplIChmb3Igc3BlY2lhbCB1c2UgY2FzZXMpXG4gICAqL1xuICBhc3luYyBleHBvcnRXaXRoQ3VzdG9tU2l6ZShcbiAgICBzZXF1ZW5jZTogU2VxdWVuY2VEYXRhLFxuICAgIHRhcmdldFdpZHRoOiBudW1iZXIsXG4gICAgdGFyZ2V0SGVpZ2h0OiBudW1iZXIsXG4gICAgb3B0aW9uczogUGFydGlhbDxUS0FJbWFnZUV4cG9ydE9wdGlvbnM+ID0ge31cbiAgKTogUHJvbWlzZTxCbG9iPiB7XG4gICAgLy8gQ2FsY3VsYXRlIHJlcXVpcmVkIHNjYWxlIHRvIGZpdCB0YXJnZXQgZGltZW5zaW9uc1xuICAgIGNvbnN0IGJlYXRDb3VudCA9IHNlcXVlbmNlLmJlYXRzLmxlbmd0aDtcbiAgICBjb25zdCBbY29sdW1ucywgcm93c10gPSB0aGlzLmxheW91dFNlcnZpY2UuY2FsY3VsYXRlTGF5b3V0KFxuICAgICAgYmVhdENvdW50LFxuICAgICAgb3B0aW9ucy5pbmNsdWRlU3RhcnRQb3NpdGlvbiA/PyB0cnVlXG4gICAgKTtcblxuICAgIGNvbnN0IGJhc2VPcHRpb25zID0gdGhpcy5tZXJnZVdpdGhEZWZhdWx0cyhvcHRpb25zKTtcbiAgICBjb25zdCBbYWRkaXRpb25hbFRvcCwgYWRkaXRpb25hbEJvdHRvbV0gPVxuICAgICAgdGhpcy5kaW1lbnNpb25TZXJ2aWNlLmRldGVybWluZUFkZGl0aW9uYWxIZWlnaHRzKFxuICAgICAgICBiYXNlT3B0aW9ucyxcbiAgICAgICAgYmVhdENvdW50LFxuICAgICAgICAxLjAgLy8gVXNlIHNjYWxlIDEuMCBmb3IgY2FsY3VsYXRpb25cbiAgICAgICk7XG5cbiAgICBjb25zdCBbYmFzZVdpZHRoLCBiYXNlSGVpZ2h0XSA9IHRoaXMubGF5b3V0U2VydmljZS5jYWxjdWxhdGVJbWFnZURpbWVuc2lvbnMoXG4gICAgICBbY29sdW1ucywgcm93c10sXG4gICAgICBhZGRpdGlvbmFsVG9wICsgYWRkaXRpb25hbEJvdHRvbSxcbiAgICAgIDEuMCAvLyBVc2Ugc2NhbGUgMS4wIGZvciBjYWxjdWxhdGlvblxuICAgICk7XG5cbiAgICAvLyBDYWxjdWxhdGUgc2NhbGUgdG8gZml0IHRhcmdldCBkaW1lbnNpb25zXG4gICAgY29uc3Qgc2NhbGVYID0gdGFyZ2V0V2lkdGggLyBiYXNlV2lkdGg7XG4gICAgY29uc3Qgc2NhbGVZID0gdGFyZ2V0SGVpZ2h0IC8gYmFzZUhlaWdodDtcbiAgICBjb25zdCBzY2FsZSA9IE1hdGgubWluKHNjYWxlWCwgc2NhbGVZKTtcblxuICAgIC8vIEV4cG9ydCB3aXRoIGNhbGN1bGF0ZWQgc2NhbGVcbiAgICBjb25zdCBjdXN0b21PcHRpb25zID0ge1xuICAgICAgLi4uYmFzZU9wdGlvbnMsXG4gICAgICBiZWF0U2NhbGU6IHNjYWxlLFxuICAgIH07XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leHBvcnRTZXF1ZW5jZUltYWdlKHNlcXVlbmNlLCBjdXN0b21PcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWJ1ZyBtZXRob2QgdG8gdGVzdCBleHBvcnQgcGlwZWxpbmVcbiAgICovXG4gIGFzeW5jIGRlYnVnRXhwb3J0KCk6IFByb21pc2U8e1xuICAgIGRlZmF1bHRPcHRpb25zVGVzdDogYm9vbGVhbjtcbiAgICB2YWxpZGF0aW9uVGVzdDogYm9vbGVhbjtcbiAgICBwcmV2aWV3VGVzdDogYm9vbGVhbjtcbiAgICBleHBvcnRUZXN0OiBib29sZWFuO1xuICB9PiB7XG4gICAgbGV0IGRlZmF1bHRPcHRpb25zVGVzdCA9IGZhbHNlO1xuICAgIGxldCB2YWxpZGF0aW9uVGVzdCA9IGZhbHNlO1xuICAgIGxldCBwcmV2aWV3VGVzdCA9IGZhbHNlO1xuICAgIGxldCBleHBvcnRUZXN0ID0gZmFsc2U7XG5cbiAgICB0cnkge1xuICAgICAgLy8gVGVzdCBkZWZhdWx0IG9wdGlvbnNcbiAgICAgIGNvbnN0IGRlZmF1bHRzID0gdGhpcy5nZXREZWZhdWx0T3B0aW9ucygpO1xuICAgICAgZGVmYXVsdE9wdGlvbnNUZXN0ID1cbiAgICAgICAgZGVmYXVsdHMuYmVhdFNjYWxlID09PSAxLjAgJiYgZGVmYXVsdHMuZm9ybWF0ID09PSBcIlBOR1wiO1xuXG4gICAgICAvLyBUZXN0IHZhbGlkYXRpb25cbiAgICAgIGNvbnN0IHRlc3RTZXF1ZW5jZTogU2VxdWVuY2VEYXRhID0ge1xuICAgICAgICBpZDogXCJ0ZXN0XCIsXG4gICAgICAgIG5hbWU6IFwiVGVzdFwiLFxuICAgICAgICB3b3JkOiBcIlRFU1RcIixcbiAgICAgICAgYmVhdHM6IFtdLFxuICAgICAgICB0aHVtYm5haWxzOiBbXSxcbiAgICAgICAgaXNfZmF2b3JpdGU6IGZhbHNlLFxuICAgICAgICBpc19jaXJjdWxhcjogZmFsc2UsXG4gICAgICAgIHRhZ3M6IFtdLFxuICAgICAgICBtZXRhZGF0YToge30sXG4gICAgICB9O1xuXG4gICAgICBjb25zdCB2YWxpZGF0aW9uID0gdGhpcy52YWxpZGF0ZUV4cG9ydCh0ZXN0U2VxdWVuY2UsIGRlZmF1bHRzKTtcbiAgICAgIHZhbGlkYXRpb25UZXN0ID0gdmFsaWRhdGlvbi52YWxpZDtcblxuICAgICAgLy8gVGVzdCBwcmV2aWV3IGdlbmVyYXRpb25cbiAgICAgIGNvbnN0IHByZXZpZXcgPSBhd2FpdCB0aGlzLmdlbmVyYXRlUHJldmlldyh0ZXN0U2VxdWVuY2UpO1xuICAgICAgcHJldmlld1Rlc3QgPSBwcmV2aWV3LnN0YXJ0c1dpdGgoXCJkYXRhOmltYWdlL1wiKTtcblxuICAgICAgLy8gVGVzdCBleHBvcnRcbiAgICAgIGNvbnN0IGJsb2IgPSBhd2FpdCB0aGlzLmV4cG9ydFNlcXVlbmNlSW1hZ2UodGVzdFNlcXVlbmNlKTtcbiAgICAgIGV4cG9ydFRlc3QgPSBibG9iLnNpemUgPiAwO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRXhwb3J0IGRlYnVnIGZhaWxlZDpcIiwgZXJyb3IpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBkZWZhdWx0T3B0aW9uc1Rlc3QsXG4gICAgICB2YWxpZGF0aW9uVGVzdCxcbiAgICAgIHByZXZpZXdUZXN0LFxuICAg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