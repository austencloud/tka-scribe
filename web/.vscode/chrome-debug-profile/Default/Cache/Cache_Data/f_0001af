export class OptionFilteringService {
  constructor(enumMappingService) {
    this.enumMappingService = enumMappingService;
  }
  /**
   * Filter options by start position
   */
  filterByStartPosition(options, startPosition) {
    if (!startPosition) return options;
    return options.filter((option) => {
      const optionStartPos = option.startPosition?.toString().toLowerCase();
      const targetStartPos = startPosition.toLowerCase();
      return optionStartPos === targetStartPos;
    });
  }
  /**
   * Filter options by end position
   */
  filterByEndPosition(options, endPosition) {
    if (!endPosition) return options;
    return options.filter((option) => {
      const optionEndPos = option.endPosition?.toString().toLowerCase();
      const targetEndPos = endPosition.toLowerCase();
      return optionEndPos === targetEndPos;
    });
  }
  /**
   * Filter options by letter types
   */
  filterByLetterTypes(options, letterTypes) {
    if (!letterTypes || letterTypes.length === 0) return options;
    return options.filter((option) => {
      if (!option.letter) return false;
      const letterType = this.enumMappingService.getLetterType(option.letter);
      return letterTypes.includes(letterType);
    });
  }
  /**
   * Filter options by rotation directions
   */
  filterByRotation(options, blueRotationDirection, redRotationDirection) {
    return options.filter((option) => {
      let matches = true;
      if (blueRotationDirection && blueRotationDirection !== "any") {
        const blueRotation = option.motions?.blue?.rotationDirection?.toString().toLowerCase();
        const targetBlueRotation = blueRotationDirection.toLowerCase();
        matches = matches && blueRotation === targetBlueRotation;
      }
      if (redRotationDirection && redRotationDirection !== "any") {
        const redRotation = option.motions?.red?.rotationDirection?.toString().toLowerCase();
        const targetRedRotation = redRotationDirection.toLowerCase();
        matches = matches && redRotation === targetRedRotation;
      }
      return matches;
    });
  }
  /**
   * Filter options by multiple criteria with detailed result
   */
  filterByCriteria(options, criteria) {
    let filtered = [...options];
    const appliedFilters = [];
    const totalOriginal = options.length;
    if (criteria.startPosition) {
      filtered = this.filterByStartPosition(filtered, criteria.startPosition);
      appliedFilters.push(`startPosition: ${criteria.startPosition}`);
    }
    if (criteria.endPosition) {
      filtered = this.filterByEndPosition(filtered, criteria.endPosition);
      appliedFilters.push(`endPosition: ${criteria.endPosition}`);
    }
    if (criteria.letterTypes && criteria.letterTypes.length > 0) {
      filtered = this.filterByLetterTypes(filtered, criteria.letterTypes);
      appliedFilters.push(`letterTypes: ${criteria.letterTypes.join(", ")}`);
    }
    if (criteria.blueRotationDirection || criteria.redRotationDirection) {
      filtered = this.filterByRotation(
        filtered,
        criteria.blueRotationDirection || "",
        criteria.redRotationDirection || ""
      );
      appliedFilters.push(
        `rotation: blue=${criteria.blueRotationDirection || "any"}, red=${criteria.redRotationDirection || "any"}`
      );
    }
    if (criteria.motionTypes && criteria.motionTypes.length > 0) {
      filtered = this.filterByMotionTypes(filtered, criteria.motionTypes);
      appliedFilters.push(`motionTypes: ${criteria.motionTypes.join(", ")}`);
    }
    if (criteria.excludeLetters && criteria.excludeLetters.length > 0) {
      filtered = this.filterExcludeLetters(filtered, criteria.excludeLetters);
      appliedFilters.push(
        `excludeLetters: ${criteria.excludeLetters.join(", ")}`
      );
    }
    return {
      filtered,
      totalOriginal,
      totalFiltered: filtered.length,
      appliedFilters
    };
  }
  /**
   * Extract end position from the last beat in a sequence
   */
  extractEndPosition(lastBeat) {
    try {
      if (!lastBeat || !lastBeat.pictographData) {
        return null;
      }
      const endPosition = lastBeat.pictographData.endPosition;
      return endPosition ? endPosition.toString() : null;
    } catch (error) {
      console.warn("⚠️ Failed to extract end position from beat:", error);
      return null;
    }
  }
  /**
   * Filter by motion types
   */
  filterByMotionTypes(options, motionTypes) {
    return options.filter((option) => {
      const blueMotionType = option.motions?.blue?.motionType?.toString().toLowerCase();
      const redMotionType = option.motions?.red?.motionType?.toString().toLowerCase();
      const normalizedMotionTypes = motionTypes.map((mt) => mt.toLowerCase());
      return normalizedMotionTypes.includes(blueMotionType || "") || normalizedMotionTypes.includes(redMotionType || "");
    });
  }
  /**
   * Filter to exclude specific letters
   */
  filterExcludeLetters(options, excludeLetters) {
    return options.filter((option) => {
      return !excludeLetters.includes(option.letter || "");
    });
  }
  /**
   * Get filtering statistics for debugging
   */
  getFilteringStats(originalOptions, criteria) {
    let current = [...originalOptions];
    const afterEachFilter = [];
    if (criteria.startPosition) {
      current = this.filterByStartPosition(current, criteria.startPosition);
      afterEachFilter.push({
        filterName: "startPosition",
        count: current.length,
        criteria: criteria.startPosition
      });
    }
    if (criteria.endPosition) {
      current = this.filterByEndPosition(current, criteria.endPosition);
      afterEachFilter.push({
        filterName: "endPosition",
        count: current.length,
        criteria: criteria.endPosition
      });
    }
    if (criteria.letterTypes && criteria.letterTypes.length > 0) {
      current = this.filterByLetterTypes(current, criteria.letterTypes);
      afterEachFilter.push({
        filterName: "letterTypes",
        count: current.length,
        criteria: criteria.letterTypes.join(", ")
      });
    }
    return {
      originalCount: originalOptions.length,
      afterEachFilter,
      finalCount: current.length
    };
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk9wdGlvbkZpbHRlcmluZ1NlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBPcHRpb25GaWx0ZXJpbmdTZXJ2aWNlIC0gQ2VudHJhbGl6ZWQgb3B0aW9uIGZpbHRlcmluZyB1dGlsaXRpZXNcbiAqXG4gKiBIYW5kbGVzIGZpbHRlcmluZyBvZiBwaWN0b2dyYXBoIG9wdGlvbnMgYnkgdmFyaW91cyBjcml0ZXJpYSBpbmNsdWRpbmdcbiAqIHBvc2l0aW9uLCBsZXR0ZXIgdHlwZXMsIHJvdGF0aW9uLCBhbmQgb3RoZXIgbW90aW9uIHBhcmFtZXRlcnMuXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBQaWN0b2dyYXBoRGF0YSB9IGZyb20gXCIkbGliL2RvbWFpbi9QaWN0b2dyYXBoRGF0YVwiO1xuaW1wb3J0IHR5cGUgeyBCZWF0RGF0YSB9IGZyb20gXCIkbGliL2RvbWFpbi9CZWF0RGF0YVwiO1xuaW1wb3J0IHR5cGUgeyBJRW51bU1hcHBpbmdTZXJ2aWNlIH0gZnJvbSBcIi4vRW51bU1hcHBpbmdTZXJ2aWNlXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmlsdGVyQ3JpdGVyaWEge1xuICBzdGFydFBvc2l0aW9uPzogc3RyaW5nO1xuICBlbmRQb3NpdGlvbj86IHN0cmluZztcbiAgbGV0dGVyVHlwZXM/OiBzdHJpbmdbXTtcbiAgYmx1ZVJvdGF0aW9uRGlyZWN0aW9uPzogc3RyaW5nO1xuICByZWRSb3RhdGlvbkRpcmVjdGlvbj86IHN0cmluZztcbiAgbW90aW9uVHlwZXM/OiBzdHJpbmdbXTtcbiAgZGlmZmljdWx0eT86IHN0cmluZztcbiAgZXhjbHVkZUxldHRlcnM/OiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGaWx0ZXJSZXN1bHQge1xuICBmaWx0ZXJlZDogUGljdG9ncmFwaERhdGFbXTtcbiAgdG90YWxPcmlnaW5hbDogbnVtYmVyO1xuICB0b3RhbEZpbHRlcmVkOiBudW1iZXI7XG4gIGFwcGxpZWRGaWx0ZXJzOiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJT3B0aW9uRmlsdGVyaW5nU2VydmljZSB7XG4gIGZpbHRlckJ5U3RhcnRQb3NpdGlvbihcbiAgICBvcHRpb25zOiBQaWN0b2dyYXBoRGF0YVtdLFxuICAgIHN0YXJ0UG9zaXRpb246IHN0cmluZ1xuICApOiBQaWN0b2dyYXBoRGF0YVtdO1xuICBmaWx0ZXJCeUVuZFBvc2l0aW9uKFxuICAgIG9wdGlvbnM6IFBpY3RvZ3JhcGhEYXRhW10sXG4gICAgZW5kUG9zaXRpb246IHN0cmluZ1xuICApOiBQaWN0b2dyYXBoRGF0YVtdO1xuICBmaWx0ZXJCeUxldHRlclR5cGVzKFxuICAgIG9wdGlvbnM6IFBpY3RvZ3JhcGhEYXRhW10sXG4gICAgbGV0dGVyVHlwZXM6IHN0cmluZ1tdXG4gICk6IFBpY3RvZ3JhcGhEYXRhW107XG4gIGZpbHRlckJ5Um90YXRpb24oXG4gICAgb3B0aW9uczogUGljdG9ncmFwaERhdGFbXSxcbiAgICBibHVlUm90YXRpb25EaXJlY3Rpb246IHN0cmluZyxcbiAgICByZWRSb3RhdGlvbkRpcmVjdGlvbjogc3RyaW5nXG4gICk6IFBpY3RvZ3JhcGhEYXRhW107XG4gIGZpbHRlckJ5Q3JpdGVyaWEoXG4gICAgb3B0aW9uczogUGljdG9ncmFwaERhdGFbXSxcbiAgICBjcml0ZXJpYTogRmlsdGVyQ3JpdGVyaWFcbiAgKTogRmlsdGVyUmVzdWx0O1xuICBleHRyYWN0RW5kUG9zaXRpb24obGFzdEJlYXQ6IEJlYXREYXRhKTogc3RyaW5nIHwgbnVsbDtcbn1cblxuZXhwb3J0IGNsYXNzIE9wdGlvbkZpbHRlcmluZ1NlcnZpY2UgaW1wbGVtZW50cyBJT3B0aW9uRmlsdGVyaW5nU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZW51bU1hcHBpbmdTZXJ2aWNlOiBJRW51bU1hcHBpbmdTZXJ2aWNlKSB7fVxuXG4gIC8qKlxuICAgKiBGaWx0ZXIgb3B0aW9ucyBieSBzdGFydCBwb3NpdGlvblxuICAgKi9cbiAgZmlsdGVyQnlTdGFydFBvc2l0aW9uKFxuICAgIG9wdGlvbnM6IFBpY3RvZ3JhcGhEYXRhW10sXG4gICAgc3RhcnRQb3NpdGlvbjogc3RyaW5nXG4gICk6IFBpY3RvZ3JhcGhEYXRhW10ge1xuICAgIGlmICghc3RhcnRQb3NpdGlvbikgcmV0dXJuIG9wdGlvbnM7XG5cbiAgICByZXR1cm4gb3B0aW9ucy5maWx0ZXIoKG9wdGlvbikgPT4ge1xuICAgICAgY29uc3Qgb3B0aW9uU3RhcnRQb3MgPSBvcHRpb24uc3RhcnRQb3NpdGlvbj8udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgY29uc3QgdGFyZ2V0U3RhcnRQb3MgPSBzdGFydFBvc2l0aW9uLnRvTG93ZXJDYXNlKCk7XG4gICAgICByZXR1cm4gb3B0aW9uU3RhcnRQb3MgPT09IHRhcmdldFN0YXJ0UG9zO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZpbHRlciBvcHRpb25zIGJ5IGVuZCBwb3NpdGlvblxuICAgKi9cbiAgZmlsdGVyQnlFbmRQb3NpdGlvbihcbiAgICBvcHRpb25zOiBQaWN0b2dyYXBoRGF0YVtdLFxuICAgIGVuZFBvc2l0aW9uOiBzdHJpbmdcbiAgKTogUGljdG9ncmFwaERhdGFbXSB7XG4gICAgaWYgKCFlbmRQb3NpdGlvbikgcmV0dXJuIG9wdGlvbnM7XG5cbiAgICByZXR1cm4gb3B0aW9ucy5maWx0ZXIoKG9wdGlvbikgPT4ge1xuICAgICAgY29uc3Qgb3B0aW9uRW5kUG9zID0gb3B0aW9uLmVuZFBvc2l0aW9uPy50b1N0cmluZygpLnRvTG93ZXJDYXNlKCk7XG4gICAgICBjb25zdCB0YXJnZXRFbmRQb3MgPSBlbmRQb3NpdGlvbi50b0xvd2VyQ2FzZSgpO1xuICAgICAgcmV0dXJuIG9wdGlvbkVuZFBvcyA9PT0gdGFyZ2V0RW5kUG9zO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZpbHRlciBvcHRpb25zIGJ5IGxldHRlciB0eXBlc1xuICAgKi9cbiAgZmlsdGVyQnlMZXR0ZXJUeXBlcyhcbiAgICBvcHRpb25zOiBQaWN0b2dyYXBoRGF0YVtdLFxuICAgIGxldHRlclR5cGVzOiBzdHJpbmdbXVxuICApOiBQaWN0b2dyYXBoRGF0YVtdIHtcbiAgICBpZiAoIWxldHRlclR5cGVzIHx8IGxldHRlclR5cGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG9wdGlvbnM7XG5cbiAgICByZXR1cm4gb3B0aW9ucy5maWx0ZXIoKG9wdGlvbikgPT4ge1xuICAgICAgaWYgKCFvcHRpb24ubGV0dGVyKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgIGNvbnN0IGxldHRlclR5cGUgPSB0aGlzLmVudW1NYXBwaW5nU2VydmljZS5nZXRMZXR0ZXJUeXBlKG9wdGlvbi5sZXR0ZXIpO1xuICAgICAgcmV0dXJuIGxldHRlclR5cGVzLmluY2x1ZGVzKGxldHRlclR5cGUpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZpbHRlciBvcHRpb25zIGJ5IHJvdGF0aW9uIGRpcmVjdGlvbnNcbiAgICovXG4gIGZpbHRlckJ5Um90YXRpb24oXG4gICAgb3B0aW9uczogUGljdG9ncmFwaERhdGFbXSxcbiAgICBibHVlUm90YXRpb25EaXJlY3Rpb246IHN0cmluZyxcbiAgICByZWRSb3RhdGlvbkRpcmVjdGlvbjogc3RyaW5nXG4gICk6IFBpY3RvZ3JhcGhEYXRhW10ge1xuICAgIHJldHVybiBvcHRpb25zLmZpbHRlcigob3B0aW9uKSA9PiB7XG4gICAgICBsZXQgbWF0Y2hlcyA9IHRydWU7XG5cbiAgICAgIC8vIENoZWNrIGJsdWUgcm90YXRpb24gaWYgc3BlY2lmaWVkXG4gICAgICBpZiAoYmx1ZVJvdGF0aW9uRGlyZWN0aW9uICYmIGJsdWVSb3RhdGlvbkRpcmVjdGlvbiAhPT0gXCJhbnlcIikge1xuICAgICAgICBjb25zdCBibHVlUm90YXRpb24gPSBvcHRpb24ubW90aW9ucz8uYmx1ZT8ucm90YXRpb25EaXJlY3Rpb25cbiAgICAgICAgICA/LnRvU3RyaW5nKClcbiAgICAgICAgICAudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgY29uc3QgdGFyZ2V0Qmx1ZVJvdGF0aW9uID0gYmx1ZVJvdGF0aW9uRGlyZWN0aW9uLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIG1hdGNoZXMgPSBtYXRjaGVzICYmIGJsdWVSb3RhdGlvbiA9PT0gdGFyZ2V0Qmx1ZVJvdGF0aW9uO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayByZWQgcm90YXRpb24gaWYgc3BlY2lmaWVkXG4gICAgICBpZiAocmVkUm90YXRpb25EaXJlY3Rpb24gJiYgcmVkUm90YXRpb25EaXJlY3Rpb24gIT09IFwiYW55XCIpIHtcbiAgICAgICAgY29uc3QgcmVkUm90YXRpb24gPSBvcHRpb24ubW90aW9ucz8ucmVkPy5yb3RhdGlvbkRpcmVjdGlvblxuICAgICAgICAgID8udG9TdHJpbmcoKVxuICAgICAgICAgIC50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBjb25zdCB0YXJnZXRSZWRSb3RhdGlvbiA9IHJlZFJvdGF0aW9uRGlyZWN0aW9uLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIG1hdGNoZXMgPSBtYXRjaGVzICYmIHJlZFJvdGF0aW9uID09PSB0YXJnZXRSZWRSb3RhdGlvbjtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG1hdGNoZXM7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRmlsdGVyIG9wdGlvbnMgYnkgbXVsdGlwbGUgY3JpdGVyaWEgd2l0aCBkZXRhaWxlZCByZXN1bHRcbiAgICovXG4gIGZpbHRlckJ5Q3JpdGVyaWEoXG4gICAgb3B0aW9uczogUGljdG9ncmFwaERhdGFbXSxcbiAgICBjcml0ZXJpYTogRmlsdGVyQ3JpdGVyaWFcbiAgKTogRmlsdGVyUmVzdWx0IHtcbiAgICBsZXQgZmlsdGVyZWQgPSBbLi4ub3B0aW9uc107XG4gICAgY29uc3QgYXBwbGllZEZpbHRlcnM6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgdG90YWxPcmlnaW5hbCA9IG9wdGlvbnMubGVuZ3RoO1xuXG4gICAgLy8gQXBwbHkgc3RhcnQgcG9zaXRpb24gZmlsdGVyXG4gICAgaWYgKGNyaXRlcmlhLnN0YXJ0UG9zaXRpb24pIHtcbiAgICAgIGZpbHRlcmVkID0gdGhpcy5maWx0ZXJCeVN0YXJ0UG9zaXRpb24oZmlsdGVyZWQsIGNyaXRlcmlhLnN0YXJ0UG9zaXRpb24pO1xuICAgICAgYXBwbGllZEZpbHRlcnMucHVzaChgc3RhcnRQb3NpdGlvbjogJHtjcml0ZXJpYS5zdGFydFBvc2l0aW9ufWApO1xuICAgIH1cblxuICAgIC8vIEFwcGx5IGVuZCBwb3NpdGlvbiBmaWx0ZXJcbiAgICBpZiAoY3JpdGVyaWEuZW5kUG9zaXRpb24pIHtcbiAgICAgIGZpbHRlcmVkID0gdGhpcy5maWx0ZXJCeUVuZFBvc2l0aW9uKGZpbHRlcmVkLCBjcml0ZXJpYS5lbmRQb3NpdGlvbik7XG4gICAgICBhcHBsaWVkRmlsdGVycy5wdXNoKGBlbmRQb3NpdGlvbjogJHtjcml0ZXJpYS5lbmRQb3NpdGlvbn1gKTtcbiAgICB9XG5cbiAgICAvLyBBcHBseSBsZXR0ZXIgdHlwZXMgZmlsdGVyXG4gICAgaWYgKGNyaXRlcmlhLmxldHRlclR5cGVzICYmIGNyaXRlcmlhLmxldHRlclR5cGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGZpbHRlcmVkID0gdGhpcy5maWx0ZXJCeUxldHRlclR5cGVzKGZpbHRlcmVkLCBjcml0ZXJpYS5sZXR0ZXJUeXBlcyk7XG4gICAgICBhcHBsaWVkRmlsdGVycy5wdXNoKGBsZXR0ZXJUeXBlczogJHtjcml0ZXJpYS5sZXR0ZXJUeXBlcy5qb2luKFwiLCBcIil9YCk7XG4gICAgfVxuXG4gICAgLy8gQXBwbHkgcm90YXRpb24gZmlsdGVyXG4gICAgaWYgKGNyaXRlcmlhLmJsdWVSb3RhdGlvbkRpcmVjdGlvbiB8fCBjcml0ZXJpYS5yZWRSb3RhdGlvbkRpcmVjdGlvbikge1xuICAgICAgZmlsdGVyZWQgPSB0aGlzLmZpbHRlckJ5Um90YXRpb24oXG4gICAgICAgIGZpbHRlcmVkLFxuICAgICAgICBjcml0ZXJpYS5ibHVlUm90YXRpb25EaXJlY3Rpb24gfHwgXCJcIixcbiAgICAgICAgY3JpdGVyaWEucmVkUm90YXRpb25EaXJlY3Rpb24gfHwgXCJcIlxuICAgICAgKTtcbiAgICAgIGFwcGxpZWRGaWx0ZXJzLnB1c2goXG4gICAgICAgIGByb3RhdGlvbjogYmx1ZT0ke2NyaXRlcmlhLmJsdWVSb3RhdGlvbkRpcmVjdGlvbiB8fCBcImFueVwifSwgcmVkPSR7Y3JpdGVyaWEucmVkUm90YXRpb25EaXJlY3Rpb24gfHwgXCJhbnlcIn1gXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIEFwcGx5IG1vdGlvbiB0eXBlcyBmaWx0ZXJcbiAgICBpZiAoY3JpdGVyaWEubW90aW9uVHlwZXMgJiYgY3JpdGVyaWEubW90aW9uVHlwZXMubGVuZ3RoID4gMCkge1xuICAgICAgZmlsdGVyZWQgPSB0aGlzLmZpbHRlckJ5TW90aW9uVHlwZXMoZmlsdGVyZWQsIGNyaXRlcmlhLm1vdGlvblR5cGVzKTtcbiAgICAgIGFwcGxpZWRGaWx0ZXJzLnB1c2goYG1vdGlvblR5cGVzOiAke2NyaXRlcmlhLm1vdGlvblR5cGVzLmpvaW4oXCIsIFwiKX1gKTtcbiAgICB9XG5cbiAgICAvLyBBcHBseSBleGNsdWRlIGxldHRlcnMgZmlsdGVyXG4gICAgaWYgKGNyaXRlcmlhLmV4Y2x1ZGVMZXR0ZXJzICYmIGNyaXRlcmlhLmV4Y2x1ZGVMZXR0ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIGZpbHRlcmVkID0gdGhpcy5maWx0ZXJFeGNsdWRlTGV0dGVycyhmaWx0ZXJlZCwgY3JpdGVyaWEuZXhjbHVkZUxldHRlcnMpO1xuICAgICAgYXBwbGllZEZpbHRlcnMucHVzaChcbiAgICAgICAgYGV4Y2x1ZGVMZXR0ZXJzOiAke2NyaXRlcmlhLmV4Y2x1ZGVMZXR0ZXJzLmpvaW4oXCIsIFwiKX1gXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBmaWx0ZXJlZCxcbiAgICAgIHRvdGFsT3JpZ2luYWwsXG4gICAgICB0b3RhbEZpbHRlcmVkOiBmaWx0ZXJlZC5sZW5ndGgsXG4gICAgICBhcHBsaWVkRmlsdGVycyxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3QgZW5kIHBvc2l0aW9uIGZyb20gdGhlIGxhc3QgYmVhdCBpbiBhIHNlcXVlbmNlXG4gICAqL1xuICBleHRyYWN0RW5kUG9zaXRpb24obGFzdEJlYXQ6IEJlYXREYXRhKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghbGFzdEJlYXQgfHwgIWxhc3RCZWF0LnBpY3RvZ3JhcGhEYXRhKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBlbmRQb3NpdGlvbiA9IGxhc3RCZWF0LnBpY3RvZ3JhcGhEYXRhLmVuZFBvc2l0aW9uO1xuICAgICAgcmV0dXJuIGVuZFBvc2l0aW9uID8gZW5kUG9zaXRpb24udG9TdHJpbmcoKSA6IG51bGw7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIuKaoO+4jyBGYWlsZWQgdG8gZXh0cmFjdCBlbmQgcG9zaXRpb24gZnJvbSBiZWF0OlwiLCBlcnJvcik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRmlsdGVyIGJ5IG1vdGlvbiB0eXBlc1xuICAgKi9cbiAgcHJpdmF0ZSBmaWx0ZXJCeU1vdGlvblR5cGVzKFxuICAgIG9wdGlvbnM6IFBpY3RvZ3JhcGhEYXRhW10sXG4gICAgbW90aW9uVHlwZXM6IHN0cmluZ1tdXG4gICk6IFBpY3RvZ3JhcGhEYXRhW10ge1xuICAgIHJldHVybiBvcHRpb25zLmZpbHRlcigob3B0aW9uKSA9PiB7XG4gICAgICBjb25zdCBibHVlTW90aW9uVHlwZSA9IG9wdGlvbi5tb3Rpb25zPy5ibHVlPy5tb3Rpb25UeXBlXG4gICAgICAgID8udG9TdHJpbmcoKVxuICAgICAgICAudG9Mb3dlckNhc2UoKTtcbiAgICAgIGNvbnN0IHJlZE1vdGlvblR5cGUgPSBvcHRpb24ubW90aW9ucz8ucmVkPy5tb3Rpb25UeXBlXG4gICAgICAgID8udG9TdHJpbmcoKVxuICAgICAgICAudG9Mb3dlckNhc2UoKTtcblxuICAgICAgY29uc3Qgbm9ybWFsaXplZE1vdGlvblR5cGVzID0gbW90aW9uVHlwZXMubWFwKChtdCkgPT4gbXQudG9Mb3dlckNhc2UoKSk7XG5cbiAgICAgIHJldHVybiAoXG4gICAgICAgIG5vcm1hbGl6ZWRNb3Rpb25UeXBlcy5pbmNsdWRlcyhibHVlTW90aW9uVHlwZSB8fCBcIlwiKSB8fFxuICAgICAgICBub3JtYWxpemVkTW90aW9uVHlwZXMuaW5jbHVkZXMocmVkTW90aW9uVHlwZSB8fCBcIlwiKVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGaWx0ZXIgdG8gZXhjbHVkZSBzcGVjaWZpYyBsZXR0ZXJzXG4gICAqL1xuICBwcml2YXRlIGZpbHRlckV4Y2x1ZGVMZXR0ZXJzKFxuICAgIG9wdGlvbnM6IFBpY3RvZ3JhcGhEYXRhW10sXG4gICAgZXhjbHVkZUxldHRlcnM6IHN0cmluZ1tdXG4gICk6IFBpY3RvZ3JhcGhEYXRhW10ge1xuICAgIHJldHVybiBvcHRpb25zLmZpbHRlcigob3B0aW9uKSA9PiB7XG4gICAgICByZXR1cm4gIWV4Y2x1ZGVMZXR0ZXJzLmluY2x1ZGVzKG9wdGlvbi5sZXR0ZXIgfHwgXCJcIik7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGZpbHRlcmluZyBzdGF0aXN0aWNzIGZvciBkZWJ1Z2dpbmdcbiAgICovXG4gIGdldEZpbHRlcmluZ1N0YXRzKFxuICAgIG9yaWdpbmFsT3B0aW9uczogUGljdG9ncmFwaERhdGFbXSxcbiAgICBjcml0ZXJpYTogRmlsdGVyQ3JpdGVyaWFcbiAgKToge1xuICAgIG9yaWdpbmFsQ291bnQ6IG51bWJlcjtcbiAgICBhZnRlckVhY2hGaWx0ZXI6IEFycmF5PHtcbiAgICAgIGZpbHRlck5hbWU6IHN0cmluZztcbiAgICAgIGNvdW50OiBudW1iZXI7XG4gICAgICBjcml0ZXJpYTogc3RyaW5nO1xuICAgIH0+O1xuICAgIGZpbmFsQ291bnQ6IG51bWJlcjtcbiAgfSB7XG4gICAgbGV0IGN1cnJlbnQgPSBbLi4ub3JpZ2luYWxPcHRpb25zXTtcbiAgICBjb25zdCBhZnRlckVhY2hGaWx0ZXI6IEFycmF5PHtcbiAgICAgIGZpbHRlck5hbWU6IHN0cmluZztcbiAgICAgIGNvdW50OiBudW1iZXI7XG4gICAgICBjcml0ZXJpYTogc3RyaW5nO1xuICAgIH0+ID0gW107XG5cbiAgICAvLyBUcmFjayBlYWNoIGZpbHRlciBzdGVwXG4gICAgaWYgKGNyaXRlcmlhLnN0YXJ0UG9zaXRpb24pIHtcbiAgICAgIGN1cnJlbnQgPSB0aGlzLmZpbHRlckJ5U3RhcnRQb3NpdGlvbihjdXJyZW50LCBjcml0ZXJpYS5zdGFydFBvc2l0aW9uKTtcbiAgICAgIGFmdGVyRWFjaEZpbHRlci5wdXNoKHtcbiAgICAgICAgZmlsdGVyTmFtZTogXCJzdGFydFBvc2l0aW9uXCIsXG4gICAgICAgIGNvdW50OiBjdXJyZW50Lmxlbmd0aCxcbiAgICAgICAgY3JpdGVyaWE6IGNyaXRlcmlhLnN0YXJ0UG9zaXRpb24sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoY3JpdGVyaWEuZW5kUG9zaXRpb24pIHtcbiAgICAgIGN1cnJlbnQgPSB0aGlzLmZpbHRlckJ5RW5kUG9zaXRpb24oY3VycmVudCwgY3JpdGVyaWEuZW5kUG9zaXRpb24pO1xuICAgICAgYWZ0ZXJFYWNoRmlsdGVyLnB1c2goe1xuICAgICAgICBmaWx0ZXJOYW1lOiBcImVuZFBvc2l0aW9uXCIsXG4gICAgICAgIGNvdW50OiBjdXJyZW50Lmxlbmd0aCxcbiAgICAgICAgY3JpdGVyaWE6IGNyaXRlcmlhLmVuZFBvc2l0aW9uLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGNyaXRlcmlhLmxldHRlclR5cGVzICYmIGNyaXRlcmlhLmxldHRlclR5cGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGN1cnJlbnQgPSB0aGlzLmZpbHRlckJ5TGV0dGVyVHlwZXMoY3VycmVudCwgY3JpdGVyaWEubGV0dGVyVHlwZXMpO1xuICAgICAgYWZ0ZXJFYWNoRmlsdGVyLnB1c2goe1xuICAgICAgICBmaWx0ZXJOYW1lOiBcImxldHRlclR5cGVzXCIsXG4gICAgICAgIGNvdW50OiBjdXJyZW50Lmxlbmd0aCxcbiAgICAgICAgY3JpdGVyaWE6IGNyaXRlcmlhLmxldHRlclR5cGVzLmpvaW4oXCIsIFwiKSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBvcmlnaW5hbENvdW50OiBvcmlnaW5hbE9wdGlvbnMubGVuZ3RoLFxuICAgICAgYWZ0ZXJFYWNoRmlsdGVyLFxuICAgICAgZmluYWxDb3VudDogY3VycmVudC5sZW5ndGgsXG4gICAgfTtcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiQUFzRE8sYUFBTSx1QkFBMEQ7QUFBQSxFQUNyRSxZQUFvQixvQkFBeUM7QUFBekM7QUFBQSxFQUEwQztBQUFBO0FBQUE7QUFBQTtBQUFBLEVBSzlELHNCQUNFLFNBQ0EsZUFDa0I7QUFDbEIsUUFBSSxDQUFDLGNBQWUsUUFBTztBQUUzQixXQUFPLFFBQVEsT0FBTyxDQUFDLFdBQVc7QUFDaEMsWUFBTSxpQkFBaUIsT0FBTyxlQUFlLFNBQVMsRUFBRSxZQUFZO0FBQ3BFLFlBQU0saUJBQWlCLGNBQWMsWUFBWTtBQUNqRCxhQUFPLG1CQUFtQjtBQUFBLElBQzVCLENBQUM7QUFBQSxFQUNIO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLQSxvQkFDRSxTQUNBLGFBQ2tCO0FBQ2xCLFFBQUksQ0FBQyxZQUFhLFFBQU87QUFFekIsV0FBTyxRQUFRLE9BQU8sQ0FBQyxXQUFXO0FBQ2hDLFlBQU0sZUFBZSxPQUFPLGFBQWEsU0FBUyxFQUFFLFlBQVk7QUFDaEUsWUFBTSxlQUFlLFlBQVksWUFBWTtBQUM3QyxhQUFPLGlCQUFpQjtBQUFBLElBQzFCLENBQUM7QUFBQSxFQUNIO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLQSxvQkFDRSxTQUNBLGFBQ2tCO0FBQ2xCLFFBQUksQ0FBQyxlQUFlLFlBQVksV0FBVyxFQUFHLFFBQU87QUFFckQsV0FBTyxRQUFRLE9B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