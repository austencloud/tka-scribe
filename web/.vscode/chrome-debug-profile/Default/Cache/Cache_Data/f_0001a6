export class FileExportService {
  /**
   * Convert canvas to blob
   * Handles both PNG and JPEG formats with quality control
   */
  async canvasToBlob(canvas, format, quality = 1) {
    if (!canvas) {
      throw new Error("Canvas is required for blob conversion");
    }
    if (!this.getSupportedFormats().includes(format)) {
      throw new Error(`Unsupported format: ${format}`);
    }
    if (quality < 0 || quality > 1) {
      throw new Error(`Quality must be between 0 and 1, got: ${quality}`);
    }
    return new Promise((resolve, reject) => {
      const mimeType = format === "PNG" ? "image/png" : "image/jpeg";
      canvas.toBlob(
        (blob) => {
          if (blob) {
            resolve(blob);
          } else {
            reject(new Error(`Failed to convert canvas to ${format} blob`));
          }
        },
        mimeType,
        quality
      );
    });
  }
  /**
   * Download blob as file using the app's file download utility
   * Matches desktop save functionality
   */
  async downloadBlob(blob, filename) {
    if (!blob) {
      throw new Error("Blob is required for download");
    }
    if (!this.validateFilename(filename)) {
      throw new Error(`Invalid filename: ${filename}`);
    }
    try {
      const { downloadBlob } = await import("/src/lib/utils/file-download.ts");
      await downloadBlob(blob, filename);
    } catch (error) {
      throw new Error(
        `Download failed: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Generate versioned filename
   * Matches desktop filename generation with versioning
   */
  generateVersionedFilename(word, format, timestamp) {
    const sanitizedWord = this.sanitizeForFilename(word) || "sequence";
    const date = timestamp || /* @__PURE__ */ new Date();
    const dateString = date.toISOString().slice(0, 10).replace(/-/g, "");
    const version = 1;
    const extension = format.toLowerCase();
    return `${sanitizedWord}_v${version}_${dateString}.${extension}`;
  }
  /**
   * Validate filename
   * Checks for valid characters and reasonable length
   */
  validateFilename(filename) {
    if (!filename || typeof filename !== "string") {
      return false;
    }
    if (filename.length === 0 || filename.length > 255) {
      return false;
    }
    const invalidChars = /[<>:"/\\|?*\x00-\x1f]/;
    if (invalidChars.test(filename)) {
      return false;
    }
    const reservedNames = /^(CON|PRN|AUX|NUL|COM[1-9]|LPT[1-9])(\.|$)/i;
    if (reservedNames.test(filename)) {
      return false;
    }
    if (!filename.includes(".")) {
      return false;
    }
    return true;
  }
  /**
   * Get supported export formats
   */
  getSupportedFormats() {
    return ["PNG", "JPEG"];
  }
  /**
   * Sanitize string for use in filename
   */
  sanitizeForFilename(input) {
    if (!input) return "";
    return input.replace(/[<>:"/\\|?*\x00-\x1f]/g, "").replace(/\s+/g, "_").replace(/_{2,}/g, "_").replace(/^_|_$/g, "").toLowerCase().slice(0, 100);
  }
  /**
   * Get MIME type for format
   */
  getMimeType(format) {
    switch (format) {
      case "PNG":
        return "image/png";
      case "JPEG":
        return "image/jpeg";
      default:
        throw new Error(`Unknown format: ${format}`);
    }
  }
  /**
   * Estimate file size for canvas export
   */
  estimateFileSize(canvas, format, quality = 1) {
    const pixels = canvas.width * canvas.height;
    if (format === "PNG") {
      return pixels * 3.5;
    } else {
      const baseSize = pixels * 1.5;
      return baseSize * quality;
    }
  }
  /**
   * Check if file size is reasonable for download
   */
  validateFileSize(estimatedSize) {
    const sizeMB = estimatedSize / (1024 * 1024);
    if (sizeMB > 100) {
      return {
        valid: false,
        sizeMB,
        warning: "File size exceeds 100MB limit"
      };
    }
    if (sizeMB > 10) {
      return {
        valid: true,
        sizeMB,
        warning: "Large file size may take time to download"
      };
    }
    return { valid: true, sizeMB };
  }
  /**
   * Create download with progress tracking (for large files)
   */
  async downloadWithProgress(canvas, filename, format = "PNG", quality = 1, onProgress) {
    onProgress?.(0);
    const blob = await this.canvasToBlob(canvas, format, quality);
    onProgress?.(50);
    const sizeValidation = this.validateFileSize(blob.size);
    if (!sizeValidation.valid) {
      throw new Error(sizeValidation.warning || "File size validation failed");
    }
    await this.downloadBlob(blob, filename);
    onProgress?.(100);
  }
  /**
   * Export canvas as data URL (for previews)
   */
  canvasToDataURL(canvas, format = "PNG", quality = 1) {
    if (!canvas) {
      throw new Error("Canvas is required for data URL conversion");
    }
    const mimeType = this.getMimeType(format);
    return canvas.toDataURL(mimeType, quality);
  }
  /**
   * Batch export multiple canvases
   */
  async batchExport(canvases, baseFilename, format = "PNG", quality = 1, onProgress) {
    if (!canvases || canvases.length === 0) {
      throw new Error("At least one canvas is required for batch export");
    }
    for (let i = 0; i < canvases.length; i++) {
      const canvas = canvases[i];
      const filename = canvases.length === 1 ? `${baseFilename}.${format.toLowerCase()}` : `${baseFilename}_${i + 1}.${format.toLowerCase()}`;
      await this.downloadWithProgress(canvas, filename, format, quality);
      onProgress?.(i + 1, canvases.length);
    }
  }
  /**
   * Debug method to test export functionality
   */
  async testExport() {
    try {
      const canvas = document.createElement("canvas");
      canvas.width = 100;
      canvas.height = 100;
      const ctx = canvas.getContext("2d");
      if (!ctx) {
        return {
          success: false,
          error: "Failed to get 2D context from test canvas"
        };
      }
      ctx.fillStyle = "red";
      ctx.fillRect(10, 10, 80, 80);
      const blob = await this.canvasToBlob(canvas, "PNG");
      if (blob.size === 0) {
        return { success: false, error: "Generated blob is empty" };
      }
      const filename = this.generateVersionedFilename("test", "PNG");
      if (!this.validateFilename(filename)) {
        return { success: false, error: "Generated filename is invalid" };
      }
      return { success: true };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : "Unknown error"
      };
    }
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkZpbGVFeHBvcnRTZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogRmlsZSBFeHBvcnQgU2VydmljZVxuICpcbiAqIEhhbmRsZXMgZmlsZSBleHBvcnQgb3BlcmF0aW9ucyBmb3IgdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQsIHByb3ZpZGluZ1xuICogZnVuY3Rpb25hbGl0eSBlcXVpdmFsZW50IHRvIHRoZSBkZXNrdG9wIEltYWdlU2F2ZXIuIFRoaXMgc2VydmljZSBtYW5hZ2VzXG4gKiBjYW52YXMtdG8tYmxvYiBjb252ZXJzaW9uIGFuZCBicm93c2VyIGRvd25sb2Fkcy5cbiAqXG4gKiBVc2VzIHRoZSBleGlzdGluZyBmaWxlLWRvd25sb2FkIHV0aWxpdHkgZm9yIGNvbnNpc3RlbmN5IHdpdGggdGhlIGFwcC5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7IElGaWxlRXhwb3J0U2VydmljZSB9IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL2ltYWdlLWV4cG9ydC1pbnRlcmZhY2VzXCI7XG5cbmV4cG9ydCBjbGFzcyBGaWxlRXhwb3J0U2VydmljZSBpbXBsZW1lbnRzIElGaWxlRXhwb3J0U2VydmljZSB7XG4gIC8qKlxuICAgKiBDb252ZXJ0IGNhbnZhcyB0byBibG9iXG4gICAqIEhhbmRsZXMgYm90aCBQTkcgYW5kIEpQRUcgZm9ybWF0cyB3aXRoIHF1YWxpdHkgY29udHJvbFxuICAgKi9cbiAgYXN5bmMgY2FudmFzVG9CbG9iKFxuICAgIGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQsXG4gICAgZm9ybWF0OiBcIlBOR1wiIHwgXCJKUEVHXCIsXG4gICAgcXVhbGl0eTogbnVtYmVyID0gMS4wXG4gICk6IFByb21pc2U8QmxvYj4ge1xuICAgIGlmICghY2FudmFzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW52YXMgaXMgcmVxdWlyZWQgZm9yIGJsb2IgY29udmVyc2lvblwiKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuZ2V0U3VwcG9ydGVkRm9ybWF0cygpLmluY2x1ZGVzKGZvcm1hdCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgZm9ybWF0OiAke2Zvcm1hdH1gKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBxdWFsaXR5IHBhcmFtZXRlclxuICAgIGlmIChxdWFsaXR5IDwgMCB8fCBxdWFsaXR5ID4gMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBRdWFsaXR5IG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxLCBnb3Q6ICR7cXVhbGl0eX1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgbWltZVR5cGUgPSBmb3JtYXQgPT09IFwiUE5HXCIgPyBcImltYWdlL3BuZ1wiIDogXCJpbWFnZS9qcGVnXCI7XG5cbiAgICAgIGNhbnZhcy50b0Jsb2IoXG4gICAgICAgIChibG9iKSA9PiB7XG4gICAgICAgICAgaWYgKGJsb2IpIHtcbiAgICAgICAgICAgIHJlc29sdmUoYmxvYik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYEZhaWxlZCB0byBjb252ZXJ0IGNhbnZhcyB0byAke2Zvcm1hdH0gYmxvYmApKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIG1pbWVUeXBlLFxuICAgICAgICBxdWFsaXR5XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIERvd25sb2FkIGJsb2IgYXMgZmlsZSB1c2luZyB0aGUgYXBwJ3MgZmlsZSBkb3dubG9hZCB1dGlsaXR5XG4gICAqIE1hdGNoZXMgZGVza3RvcCBzYXZlIGZ1bmN0aW9uYWxpdHlcbiAgICovXG4gIGFzeW5jIGRvd25sb2FkQmxvYihibG9iOiBCbG9iLCBmaWxlbmFtZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFibG9iKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCbG9iIGlzIHJlcXVpcmVkIGZvciBkb3dubG9hZFwiKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMudmFsaWRhdGVGaWxlbmFtZShmaWxlbmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBmaWxlbmFtZTogJHtmaWxlbmFtZX1gKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgLy8gVXNlIHRoZSBleGlzdGluZyBmaWxlLWRvd25sb2FkIHV0aWxpdHkgZm9yIGNvbnNpc3RlbmN5XG4gICAgICBjb25zdCB7IGRvd25sb2FkQmxvYiB9ID0gYXdhaXQgaW1wb3J0KFwiJGxpYi91dGlscy9maWxlLWRvd25sb2FkXCIpO1xuICAgICAgYXdhaXQgZG93bmxvYWRCbG9iKGJsb2IsIGZpbGVuYW1lKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRG93bmxvYWQgZmFpbGVkOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCJ9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgdmVyc2lvbmVkIGZpbGVuYW1lXG4gICAqIE1hdGNoZXMgZGVza3RvcCBmaWxlbmFtZSBnZW5lcmF0aW9uIHdpdGggdmVyc2lvbmluZ1xuICAgKi9cbiAgZ2VuZXJhdGVWZXJzaW9uZWRGaWxlbmFtZShcbiAgICB3b3JkOiBzdHJpbmcsXG4gICAgZm9ybWF0OiBzdHJpbmcsXG4gICAgdGltZXN0YW1wPzogRGF0ZVxuICApOiBzdHJpbmcge1xuICAgIC8vIFNhbml0aXplIHdvcmQgZm9yIGZpbGVuYW1lIHVzZVxuICAgIGNvbnN0IHNhbml0aXplZFdvcmQgPSB0aGlzLnNhbml0aXplRm9yRmlsZW5hbWUod29yZCkgfHwgXCJzZXF1ZW5jZVwiO1xuXG4gICAgLy8gVXNlIHByb3ZpZGVkIHRpbWVzdGFtcCBvciBjdXJyZW50IHRpbWVcbiAgICBjb25zdCBkYXRlID0gdGltZXN0YW1wIHx8IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgZGF0ZVN0cmluZyA9IGRhdGUudG9JU09TdHJpbmcoKS5zbGljZSgwLCAxMCkucmVwbGFjZSgvLS9nLCBcIlwiKTsgLy8gWVlZWU1NRERcblxuICAgIC8vIEdlbmVyYXRlIHZlcnNpb24gbnVtYmVyIChpbiByZWFsIGltcGxlbWVudGF0aW9uLCB0aGlzIHdvdWxkIGNoZWNrIGZvciBleGlzdGluZyBmaWxlcylcbiAgICBjb25zdCB2ZXJzaW9uID0gMTtcblxuICAgIC8vIEZvcm1hdCBleHRlbnNpb25cbiAgICBjb25zdCBleHRlbnNpb24gPSBmb3JtYXQudG9Mb3dlckNhc2UoKTtcblxuICAgIHJldHVybiBgJHtzYW5pdGl6ZWRXb3JkfV92JHt2ZXJzaW9ufV8ke2RhdGVTdHJpbmd9LiR7ZXh0ZW5zaW9ufWA7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgZmlsZW5hbWVcbiAgICogQ2hlY2tzIGZvciB2YWxpZCBjaGFyYWN0ZXJzIGFuZCByZWFzb25hYmxlIGxlbmd0aFxuICAgKi9cbiAgdmFsaWRhdGVGaWxlbmFtZShmaWxlbmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgaWYgKCFmaWxlbmFtZSB8fCB0eXBlb2YgZmlsZW5hbWUgIT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBsZW5ndGhcbiAgICBpZiAoZmlsZW5hbWUubGVuZ3RoID09PSAwIHx8IGZpbGVuYW1lLmxlbmd0aCA+IDI1NSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciBpbnZhbGlkIGNoYXJhY3RlcnMgKFdpbmRvd3MtY29tcGF0aWJsZSlcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29udHJvbC1yZWdleFxuICAgIGNvbnN0IGludmFsaWRDaGFycyA9IC9bPD46XCIvXFxcXHw/KlxceDAwLVxceDFmXS87XG4gICAgaWYgKGludmFsaWRDaGFycy50ZXN0KGZpbGVuYW1lKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciByZXNlcnZlZCBuYW1lcyAoV2luZG93cylcbiAgICBjb25zdCByZXNlcnZlZE5hbWVzID0gL14oQ09OfFBSTnxBVVh8TlVMfENPTVsxLTldfExQVFsxLTldKShcXC58JCkvaTtcbiAgICBpZiAocmVzZXJ2ZWROYW1lcy50ZXN0KGZpbGVuYW1lKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIE11c3QgaGF2ZSBhbiBleHRlbnNpb25cbiAgICBpZiAoIWZpbGVuYW1lLmluY2x1ZGVzKFwiLlwiKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBzdXBwb3J0ZWQgZXhwb3J0IGZvcm1hdHNcbiAgICovXG4gIGdldFN1cHBvcnRlZEZvcm1hdHMoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiBbXCJQTkdcIiwgXCJKUEVHXCJdO1xuICB9XG5cbiAgLyoqXG4gICAqIFNhbml0aXplIHN0cmluZyBmb3IgdXNlIGluIGZpbGVuYW1lXG4gICAqL1xuICBwcml2YXRlIHNhbml0aXplRm9yRmlsZW5hbWUoaW5wdXQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKCFpbnB1dCkgcmV0dXJuIFwiXCI7XG5cbiAgICByZXR1cm4gKFxuICAgICAgaW5wdXRcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnRyb2wtcmVnZXhcbiAgICAgICAgLnJlcGxhY2UoL1s8PjpcIi9cXFxcfD8qXFx4MDAtXFx4MWZdL2csIFwiXCIpIC8vIFJlbW92ZSBpbnZhbGlkIGNoYXJhY3RlcnNcbiAgICAgICAgLnJlcGxhY2UoL1xccysvZywgXCJfXCIpIC8vIFJlcGxhY2Ugc3BhY2VzIHdpdGggdW5kZXJzY29yZXNcbiAgICAgICAgLnJlcGxhY2UoL197Mix9L2csIFwiX1wiKSAvLyBSZXBsYWNlIG11bHRpcGxlIHVuZGVyc2NvcmVzIHdpdGggc2luZ2xlXG4gICAgICAgIC5yZXBsYWNlKC9eX3xfJC9nLCBcIlwiKSAvLyBSZW1vdmUgbGVhZGluZy90cmFpbGluZyB1bmRlcnNjb3Jlc1xuICAgICAgICAudG9Mb3dlckNhc2UoKSAvLyBVc2UgbG93ZXJjYXNlIGZvciBjb25zaXN0ZW5jeVxuICAgICAgICAuc2xpY2UoMCwgMTAwKVxuICAgICk7IC8vIExpbWl0IGxlbmd0aFxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBNSU1FIHR5cGUgZm9yIGZvcm1hdFxuICAgKi9cbiAgZ2V0TWltZVR5cGUoZm9ybWF0OiBcIlBOR1wiIHwgXCJKUEVHXCIpOiBzdHJpbmcge1xuICAgIHN3aXRjaCAoZm9ybWF0KSB7XG4gICAgICBjYXNlIFwiUE5HXCI6XG4gICAgICAgIHJldHVybiBcImltYWdlL3BuZ1wiO1xuICAgICAgY2FzZSBcIkpQRUdcIjpcbiAgICAgICAgcmV0dXJuIFwiaW1hZ2UvanBlZ1wiO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGZvcm1hdDogJHtmb3JtYXR9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEVzdGltYXRlIGZpbGUgc2l6ZSBmb3IgY2FudmFzIGV4cG9ydFxuICAgKi9cbiAgZXN0aW1hdGVGaWxlU2l6ZShcbiAgICBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50LFxuICAgIGZvcm1hdDogXCJQTkdcIiB8IFwiSlBFR1wiLFxuICAgIHF1YWxpdHk6IG51bWJlciA9IDEuMFxuICApOiBudW1iZXIge1xuICAgIGNvbnN0IHBpeGVscyA9IGNhbnZhcy53aWR0aCAqIGNhbnZhcy5oZWlnaHQ7XG5cbiAgICBpZiAoZm9ybWF0ID09PSBcIlBOR1wiKSB7XG4gICAgICAvLyBQTkc6IHJvdWdobHkgMy00IGJ5dGVzIHBlciBwaXhlbCBmb3IgdHlwaWNhbCBwaWN0b2dyYXBoc1xuICAgICAgcmV0dXJuIHBpeGVscyAqIDMuNTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gSlBFRzogdmFyaWVzIGdyZWF0bHkgd2l0aCBxdWFsaXR5LCByb3VnaGx5IDAuNS0zIGJ5dGVzIHBlciBwaXhlbFxuICAgICAgY29uc3QgYmFzZVNpemUgPSBwaXhlbHMgKiAxLjU7XG4gICAgICByZXR1cm4gYmFzZVNpemUgKiBxdWFsaXR5O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBmaWxlIHNpemUgaXMgcmVhc29uYWJsZSBmb3IgZG93bmxvYWRcbiAgICovXG4gIHZhbGlkYXRlRmlsZVNpemUoZXN0aW1hdGVkU2l6ZTogbnVtYmVyKToge1xuICAgIHZhbGlkOiBib29sZWFuO1xuICAgIHNpemVNQjogbnVtYmVyO1xuICAgIHdhcm5pbmc/OiBzdHJpbmc7XG4gIH0ge1xuICAgIGNvbnN0IHNpemVNQiA9IGVzdGltYXRlZFNpemUgLyAoMTAyNCAqIDEwMjQpO1xuXG4gICAgaWYgKHNpemVNQiA+IDEwMCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICBzaXplTUIsXG4gICAgICAgIHdhcm5pbmc6IFwiRmlsZSBzaXplIGV4Y2VlZHMgMTAwTUIgbGltaXRcIixcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKHNpemVNQiA+IDEwKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB2YWxpZDogdHJ1ZSxcbiAgICAgICAgc2l6ZU1CLFxuICAgICAgICB3YXJuaW5nOiBcIkxhcmdlIGZpbGUgc2l6ZSBtYXkgdGFrZSB0aW1lIHRvIGRvd25sb2FkXCIsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7IHZhbGlkOiB0cnVlLCBzaXplTUIgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgZG93bmxvYWQgd2l0aCBwcm9ncmVzcyB0cmFja2luZyAoZm9yIGxhcmdlIGZpbGVzKVxuICAgKi9cbiAgYXN5bmMgZG93bmxvYWRXaXRoUHJvZ3Jlc3MoXG4gICAgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCxcbiAgICBmaWxlbmFtZTogc3RyaW5nLFxuICAgIGZvcm1hdDogXCJQTkdcIiB8IFwiSlBFR1wiID0gXCJQTkdcIixcbiAgICBxdWFsaXR5OiBudW1iZXIgPSAxLjAsXG4gICAgb25Qcm9ncmVzcz86IChwcm9ncmVzczogbnVtYmVyKSA9PiB2b2lkXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIFJlcG9ydCBjb252ZXJzaW9uIHN0YXJ0XG4gICAgb25Qcm9ncmVzcz8uKDApO1xuXG4gICAgLy8gQ29udmVydCBjYW52YXMgdG8gYmxvYlxuICAgIGNvbnN0IGJsb2IgPSBhd2FpdCB0aGlzLmNhbnZhc1RvQmxvYihjYW52YXMsIGZvcm1hdCwgcXVhbGl0eSk7XG4gICAgb25Qcm9ncmVzcz8uKDUwKTtcblxuICAgIC8vIFZhbGlkYXRlIGZpbGUgc2l6ZVxuICAgIGNvbnN0IHNpemVWYWxpZGF0aW9uID0gdGhpcy52YWxpZGF0ZUZpbGVTaXplKGJsb2Iuc2l6ZSk7XG4gICAgaWYgKCFzaXplVmFsaWRhdGlvbi52YWxpZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKHNpemVWYWxpZGF0aW9uLndhcm5pbmcgfHwgXCJGaWxlIHNpemUgdmFsaWRhdGlvbiBmYWlsZWRcIik7XG4gICAgfVxuXG4gICAgLy8gRG93bmxvYWQgZmlsZVxuICAgIGF3YWl0IHRoaXMuZG93bmxvYWRCbG9iKGJsb2IsIGZpbGVuYW1lKTtcbiAgICBvblByb2dyZXNzPy4oMTAwKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHBvcnQgY2FudmFzIGFzIGRhdGEgVVJMIChmb3IgcHJldmlld3MpXG4gICAqL1xuICBjYW52YXNUb0RhdGFVUkwoXG4gICAgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCxcbiAgICBmb3JtYXQ6IFwiUE5HXCIgfCBcIkpQRUdcIiA9IFwiUE5HXCIsXG4gICAgcXVhbGl0eTogbnVtYmVyID0gMS4wXG4gICk6IHN0cmluZyB7XG4gICAgaWYgKCFjYW52YXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbnZhcyBpcyByZXF1aXJlZCBmb3IgZGF0YSBVUkwgY29udmVyc2lvblwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBtaW1lVHlwZSA9IHRoaXMuZ2V0TWltZVR5cGUoZm9ybWF0KTtcbiAgICByZXR1cm4gY2FudmFzLnRvRGF0YVVSTChtaW1lVHlwZSwgcXVhbGl0eSk7XG4gIH1cblxuICAvKipcbiAgICogQmF0Y2ggZXhwb3J0IG11bHRpcGxlIGNhbnZhc2VzXG4gICAqL1xuICBhc3luYyBiYXRjaEV4cG9ydChcbiAgICBjYW52YXNlczogSFRNTENhbnZhc0VsZW1lbnRbXSxcbiAgICBiYXNlRmlsZW5hbWU6IHN0cmluZyxcbiAgICBmb3JtYXQ6IFwiUE5HXCIgfCBcIkpQRUdcIiA9IFwiUE5HXCIsXG4gICAgcXVhbGl0eTogbnVtYmVyID0gMS4wLFxuICAgIG9uUHJvZ3Jlc3M/OiAoY3VycmVudDogbnVtYmVyLCB0b3RhbDogbnVtYmVyKSA9PiB2b2lkXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghY2FudmFzZXMgfHwgY2FudmFzZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBdCBsZWFzdCBvbmUgY2FudmFzIGlzIHJlcXVpcmVkIGZvciBiYXRjaCBleHBvcnRcIik7XG4gICAgfVxuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjYW52YXNlcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgY2FudmFzID0gY2FudmFzZXNbaV07XG4gICAgICBjb25zdCBmaWxlbmFtZSA9XG4gICAgICAgIGNhbnZhc2VzLmxlbmd0aCA9PT0gMVxuICAgICAgICAgID8gYCR7YmFzZUZpbGVuYW1lfS4ke2Zvcm1hdC50b0xvd2VyQ2FzZSgpfWBcbiAgICAgICAgICA6IGAke2Jhc2VGaWxlbmFtZX1fJHtpICsgMX0uJHtmb3JtYXQudG9Mb3dlckNhc2UoKX1gO1xuXG4gICAgICBhd2FpdCB0aGlzLmRvd25sb2FkV2l0aFByb2dyZXNzKGNhbnZhcywgZmlsZW5hbWUsIGZvcm1hdCwgcXVhbGl0eSk7XG4gICAgICBvblByb2dyZXNzPy4oaSArIDEsIGNhbnZhc2VzLmxlbmd0aCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERlYnVnIG1ldGhvZCB0byB0ZXN0IGV4cG9ydCBmdW5jdGlvbmFsaXR5XG4gICAqL1xuICBhc3luYyB0ZXN0RXhwb3J0KCk6IFByb21pc2U8eyBzdWNjZXNzOiBib29sZWFuOyBlcnJvcj86IHN0cmluZyB9PiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIENyZWF0ZSBhIHNpbXBsZSB0ZXN0IGNhbnZhc1xuICAgICAgY29uc3QgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImNhbnZhc1wiKTtcbiAgICAgIGNhbnZhcy53aWR0aCA9IDEwMDtcbiAgICAgIGNhbnZhcy5oZWlnaHQgPSAxMDA7XG5cbiAgICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XG4gICAgICBpZiAoIWN0eCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiBcIkZhaWxlZCB0byBnZXQgMkQgY29udGV4dCBmcm9tIHRlc3QgY2FudmFzXCIsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgICBjdHguZmlsbFN0eWxlID0gXCJyZWRcIjtcbiAgICAgIGN0eC5maWxsUmVjdCgxMCwgMTAsIDgwLCA4MCk7XG5cbiAgICAgIC8vIFRlc3QgYmxvYiBjb252ZXJzaW9uXG4gICAgICBjb25zdCBibG9iID0gYXdhaXQgdGhpcy5jYW52YXNUb0Jsb2IoY2FudmFzLCBcIlBOR1wiKTtcblxuICAgICAgaWYgKGJsb2Iuc2l6ZSA9PT0gMCkge1xuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IFwiR2VuZXJhdGVkIGJsb2IgaXMgZW1wdHlcIiB9O1xuICAgICAgfVxuXG4gICAgICAvLyBUZXN0IGZpbGVuYW1lIGdlbmVyYXRpb25cbiAgICAgIGNvbnN0IGZpbGVuYW1lID0gdGhpcy5nZW5lcmF0ZVZlcnNpb25lZEZpbGVuYW1lKFwidGVzdFwiLCBcIlBOR1wiKTtcbiAgICAgIGlmICghdGhpcy52YWxpZGF0ZUZpbGVuYW1lKGZpbGVuYW1lKSkge1xuICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IFwiR2VuZXJhdGVkIGZpbGVuYW1lIGlzIGludmFsaWRcIiB9O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBcIlVua25vd24gZXJyb3JcIixcbiAgICAgIH07XG4gICAgfVxuICB9XG59XG4iXSwibWFwcGluZ3MiOiJBQVlPLGFBQU0sa0JBQWdEO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQUszRCxNQUFNLGFBQ0osUUFDQSxRQUNBLFVBQWtCLEdBQ0g7QUFDZixRQUFJLENBQUMsUUFBUTtBQUNYLFlBQU0sSUFBSSxNQUFNLHdDQUF3QztBQUFBLElBQzFEO0FBRUEsUUFBSSxDQUFDLEtBQUssb0JBQW9CLEVBQUUsU0FBUyxNQUFNLEdBQUc7QUFDaEQsWUFBTSxJQUFJLE1BQU0sdUJBQXVCLE1BQU0sRUFBRTtBQUFBLElBQ2pEO0FBR0EsUUFBSSxVQUFVLEtBQUssVUFBVSxHQUFHO0FBQzlCLFlBQU0sSUFBSSxNQUFNLHlDQUF5QyxPQUFPLEVBQUU7QUFBQSxJQUNwRTtBQUVBLFdBQU8sSUFBSSxRQUFRLENBQUMsU0FBUyxXQUFXO0FBQ3RDLFlBQU0sV0FBVyxXQUFXLFFBQVEsY0FBYztBQUVsRCxhQUFPO0FBQUEsUUFDTCxDQUFDLFNBQVM7QUFDUixjQUFJLE1BQU07QUFDUixvQkFBUSxJQUFJO0FBQUEsVUFDZCxPQUFPO0FBQ0wsbUJB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