import { SortMethod as SortMethodEnum } from "/src/lib/domain/browse/SortMethod.ts";
export class FilterPersistenceService {
  CACHE_VERSION = "v2.1";
  // âœ… ROBUST: Cache versioning
  BROWSE_STATE_KEY = `tka-${this.CACHE_VERSION}-browse-state`;
  FILTER_HISTORY_KEY = `tka-${this.CACHE_VERSION}-filter-history`;
  MAX_HISTORY_SIZE = 50;
  async saveBrowseState(state) {
    try {
      const stateToSave = {
        ...state,
        lastUpdated: /* @__PURE__ */ new Date()
      };
      sessionStorage.setItem(
        this.BROWSE_STATE_KEY,
        JSON.stringify(stateToSave)
      );
    } catch (error) {
      console.error("Failed to save browse state:", error);
    }
  }
  async loadBrowseState() {
    try {
      const saved = sessionStorage.getItem(this.BROWSE_STATE_KEY);
      if (!saved) return null;
      const parsed = JSON.parse(saved);
      if (parsed.currentFilter?.appliedAt) {
        parsed.currentFilter.appliedAt = new Date(
          parsed.currentFilter.appliedAt
        );
      }
      if (parsed.lastUpdated) {
        parsed.lastUpdated = new Date(parsed.lastUpdated);
      }
      const oneDay = 24 * 60 * 60 * 1e3;
      if (parsed.lastUpdated && Date.now() - parsed.lastUpdated.getTime() > oneDay) {
        return null;
      }
      return parsed;
    } catch (error) {
      console.warn("Failed to load browse state:", error);
      return null;
    }
  }
  async saveFilterToHistory(filter) {
    try {
      const history = await this.getFilterHistory();
      const filteredHistory = history.filter(
        (f) => !(f.type === filter.type && JSON.stringify(f.value) === JSON.stringify(filter.value))
      );
      const newHistory = [filter, ...filteredHistory];
      const trimmedHistory = newHistory.slice(0, this.MAX_HISTORY_SIZE);
      sessionStorage.setItem(
        this.FILTER_HISTORY_KEY,
        JSON.stringify(trimmedHistory)
      );
    } catch (error) {
      console.error("Failed to save filter to history:", error);
    }
  }
  async getFilterHistory() {
    try {
      const saved = sessionStorage.getItem(this.FILTER_HISTORY_KEY);
      if (!saved) return [];
      const parsed = JSON.parse(saved);
      return parsed.map(
        (filter) => ({
          ...filter,
          appliedAt: new Date(filter.appliedAt)
        })
      );
    } catch (error) {
      console.warn("Failed to load filter history:", error);
      return [];
    }
  }
  async clearFilterHistory() {
    try {
      sessionStorage.removeItem(this.FILTER_HISTORY_KEY);
    } catch (error) {
      console.error("Failed to clear filter history:", error);
    }
  }
  async getRecentFilters(limit = 10) {
    const history = await this.getFilterHistory();
    return history.slice(0, limit);
  }
  async clearAllState() {
    try {
      sessionStorage.removeItem(this.BROWSE_STATE_KEY);
      sessionStorage.removeItem(this.FILTER_HISTORY_KEY);
    } catch (error) {
      console.error("Failed to clear all state:", error);
    }
  }
  // Utility methods for filter management
  async getFilterFrequency() {
    const history = await this.getFilterHistory();
    const frequency = /* @__PURE__ */ new Map();
    history.forEach((filter) => {
      const key = `${filter.type}:${JSON.stringify(filter.value)}`;
      frequency.set(key, (frequency.get(key) || 0) + 1);
    });
    return frequency;
  }
  async getMostUsedFilters(limit = 5) {
    const history = await this.getFilterHistory();
    const frequency = await this.getFilterFrequency();
    const filterMap = /* @__PURE__ */ new Map();
    history.forEach((filter) => {
      const key = `${filter.type}:${JSON.stringify(filter.value)}`;
      if (!filterMap.has(key)) {
        filterMap.set(key, filter);
      }
    });
    return Array.from(filterMap.values()).sort((a, b) => {
      const keyA = `${a.type}:${JSON.stringify(a.value)}`;
      const keyB = `${b.type}:${JSON.stringify(b.value)}`;
      return (frequency.get(keyB) || 0) - (frequency.get(keyA) || 0);
    }).slice(0, limit);
  }
  async getDefaultBrowseState() {
    return {
      displayState: {
        currentView: "filter_selection",
        selectedSequence: null,
        isSequenceDetailOpen: false
      },
      loadingState: {
        isLoading: false,
        hasError: false,
        errorMessage: null
      },
      filterState: {
        activeFilters: {
          starting_letter: "",
          contains_letters: "",
          length: "",
          difficulty: "",
          starting_position: "",
          author: "",
          gridMode: "",
          all_sequences: "",
          favorites: "",
          recent: ""
        },
        sortMethod: "alphabetical",
        searchQuery: ""
      }
    };
  }
  // Additional methods required by browse-interfaces.ts
  async saveFilterState(state) {
    const browseState = {
      displayState: {
        currentView: "filter_selection",
        selectedSequence: null,
        isSequenceDetailOpen: false
      },
      loadingState: {
        isLoading: false,
        hasError: false,
        errorMessage: null
      },
      filterState: state
    };
    await this.saveBrowseState(browseState);
  }
  async loadFilterState() {
    const browseState = await this.loadBrowseState();
    return browseState?.filterState || {
      activeFilters: {
        starting_letter: null,
        contains_letters: null,
        length: null,
        difficulty: null,
        starting_position: null,
        author: null,
        gridMode: null,
        all_sequences: null,
        favorites: null,
        recent: null
      },
      sortMethod: SortMethodEnum.ALPHABETICAL,
      searchQuery: ""
    };
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkZpbHRlclBlcnNpc3RlbmNlU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEZpbHRlciBQZXJzaXN0ZW5jZSBTZXJ2aWNlIC0gTWFuYWdlcyBmaWx0ZXIgc3RhdGUgcGVyc2lzdGVuY2VcbiAqXG4gKiBIYW5kbGVzIHNhdmluZyBhbmQgcmVzdG9yaW5nIGZpbHRlciBzdGF0ZXMgYWNyb3NzIHNlc3Npb25zLFxuICogZm9sbG93aW5nIHRoZSBtaWNyb3NlcnZpY2VzIGFyY2hpdGVjdHVyZSBwYXR0ZXJuLlxuICovXG5cbmltcG9ydCB0eXBlIHtcbiAgRmlsdGVyVHlwZSxcbiAgRmlsdGVyVmFsdWUsXG4gIFNvcnRNZXRob2QsXG59IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL2RvbWFpbi10eXBlc1wiO1xuaW1wb3J0IHR5cGUge1xuICBCcm93c2VTdGF0ZSxcbiAgRmlsdGVyU3RhdGUgYXMgQnJvd3NlRmlsdGVyU3RhdGUsXG59IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL2Jyb3dzZS1pbnRlcmZhY2VzXCI7XG5pbXBvcnQgeyBTb3J0TWV0aG9kIGFzIFNvcnRNZXRob2RFbnVtIH0gZnJvbSBcIi4uLy4uLy4uL2RvbWFpbi9icm93c2UvU29ydE1ldGhvZFwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIEZpbHRlclN0YXRlIHtcbiAgdHlwZTogRmlsdGVyVHlwZTtcbiAgdmFsdWU6IEZpbHRlclZhbHVlO1xuICBhcHBsaWVkQXQ6IERhdGU7XG59XG5cbi8vIFVzZSB0aGUgQnJvd3NlU3RhdGUgZnJvbSB0aGUgaW50ZXJmYWNlIGluc3RlYWQgb2YgZGVmaW5pbmcgb3VyIG93blxuLy8gZXhwb3J0IGludGVyZmFjZSBCcm93c2VTdGF0ZSB7XG4vLyAgIGN1cnJlbnRGaWx0ZXI6IEZpbHRlclN0YXRlIHwgbnVsbDtcbi8vICAgc29ydE1ldGhvZDogU29ydE1ldGhvZDtcbi8vICAgbmF2aWdhdGlvbk1vZGU6IFwiZmlsdGVyX3NlbGVjdGlvblwiIHwgXCJzZXF1ZW5jZV9icm93c2VyXCI7XG4vLyAgIHNlYXJjaFF1ZXJ5OiBzdHJpbmc7XG4vLyAgIGxhc3RVcGRhdGVkOiBEYXRlO1xuLy8gfVxuXG5leHBvcnQgaW50ZXJmYWNlIElGaWx0ZXJQZXJzaXN0ZW5jZVNlcnZpY2Uge1xuICAvKiogU2F2ZSBjdXJyZW50IGJyb3dzZSBzdGF0ZSAqL1xuICBzYXZlQnJvd3NlU3RhdGUoc3RhdGU6IEJyb3dzZVN0YXRlKTogUHJvbWlzZTx2b2lkPjtcblxuICAvKiogTG9hZCBzYXZlZCBicm93c2Ugc3RhdGUgKi9cbiAgbG9hZEJyb3dzZVN0YXRlKCk6IFByb21pc2U8QnJvd3NlU3RhdGUgfCBudWxsPjtcblxuICAvKiogU2F2ZSBmaWx0ZXIgaGlzdG9yeSAqL1xuICBzYXZlRmlsdGVyVG9IaXN0b3J5KGZpbHRlcjogRmlsdGVyU3RhdGUpOiBQcm9taXNlPHZvaWQ+O1xuXG4gIC8qKiBHZXQgZmlsdGVyIGhpc3RvcnkgKi9cbiAgZ2V0RmlsdGVySGlzdG9yeSgpOiBQcm9taXNlPEZpbHRlclN0YXRlW10+O1xuXG4gIC8qKiBDbGVhciBmaWx0ZXIgaGlzdG9yeSAqL1xuICBjbGVhckZpbHRlckhpc3RvcnkoKTogUHJvbWlzZTx2b2lkPjtcblxuICAvKiogR2V0IHJlY2VudGx5IHVzZWQgZmlsdGVycyAqL1xuICBnZXRSZWNlbnRGaWx0ZXJzKGxpbWl0PzogbnVtYmVyKTogUHJvbWlzZTxGaWx0ZXJTdGF0ZVtdPjtcblxuICAvKiogQ2xlYXIgYWxsIHNhdmVkIHN0YXRlICovXG4gIGNsZWFyQWxsU3RhdGUoKTogUHJvbWlzZTx2b2lkPjtcbn1cblxuZXhwb3J0IGNsYXNzIEZpbHRlclBlcnNpc3RlbmNlU2VydmljZSBpbXBsZW1lbnRzIElGaWx0ZXJQZXJzaXN0ZW5jZVNlcnZpY2Uge1xuICBwcml2YXRlIHJlYWRvbmx5IENBQ0hFX1ZFUlNJT04gPSBcInYyLjFcIjsgLy8g4pyFIFJPQlVTVDogQ2FjaGUgdmVyc2lvbmluZ1xuICBwcml2YXRlIHJlYWRvbmx5IEJST1dTRV9TVEFURV9LRVkgPSBgdGthLSR7dGhpcy5DQUNIRV9WRVJTSU9OfS1icm93c2Utc3RhdGVgO1xuICBwcml2YXRlIHJlYWRvbmx5IEZJTFRFUl9ISVNUT1JZX0tFWSA9IGB0a2EtJHt0aGlzLkNBQ0hFX1ZFUlNJT059LWZpbHRlci1oaXN0b3J5YDtcbiAgcHJpdmF0ZSByZWFkb25seSBNQVhfSElTVE9SWV9TSVpFID0gNTA7XG5cbiAgYXN5bmMgc2F2ZUJyb3dzZVN0YXRlKHN0YXRlOiBCcm93c2VTdGF0ZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzdGF0ZVRvU2F2ZSA9IHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGxhc3RVcGRhdGVkOiBuZXcgRGF0ZSgpLFxuICAgICAgfTtcbiAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oXG4gICAgICAgIHRoaXMuQlJPV1NFX1NUQVRFX0tFWSxcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkoc3RhdGVUb1NhdmUpXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIHNhdmUgYnJvd3NlIHN0YXRlOlwiLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbG9hZEJyb3dzZVN0YXRlKCk6IFByb21pc2U8QnJvd3NlU3RhdGUgfCBudWxsPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNhdmVkID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSh0aGlzLkJST1dTRV9TVEFURV9LRVkpO1xuICAgICAgaWYgKCFzYXZlZCkgcmV0dXJuIG51bGw7XG5cbiAgICAgIGNvbnN0IHBhcnNlZCA9IEpTT04ucGFyc2Uoc2F2ZWQpO1xuXG4gICAgICAvLyBDb252ZXJ0IGRhdGUgc3RyaW5ncyBiYWNrIHRvIERhdGUgb2JqZWN0c1xuICAgICAgaWYgKHBhcnNlZC5jdXJyZW50RmlsdGVyPy5hcHBsaWVkQXQpIHtcbiAgICAgICAgcGFyc2VkLmN1cnJlbnRGaWx0ZXIuYXBwbGllZEF0ID0gbmV3IERhdGUoXG4gICAgICAgICAgcGFyc2VkLmN1cnJlbnRGaWx0ZXIuYXBwbGllZEF0XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAocGFyc2VkLmxhc3RVcGRhdGVkKSB7XG4gICAgICAgIHBhcnNlZC5sYXN0VXBkYXRlZCA9IG5ldyBEYXRlKHBhcnNlZC5sYXN0VXBkYXRlZCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYXRlIHN0YXRlIGlzIG5vdCB0b28gb2xkIChvbGRlciB0aGFuIDEgZGF5KVxuICAgICAgY29uc3Qgb25lRGF5ID0gMjQgKiA2MCAqIDYwICogMTAwMDtcbiAgICAgIGlmIChcbiAgICAgICAgcGFyc2VkLmxhc3RVcGRhdGVkICYmXG4gICAgICAgIERhdGUubm93KCkgLSBwYXJzZWQubGFzdFVwZGF0ZWQuZ2V0VGltZSgpID4gb25lRGF5XG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwYXJzZWQgYXMgQnJvd3NlU3RhdGU7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIkZhaWxlZCB0byBsb2FkIGJyb3dzZSBzdGF0ZTpcIiwgZXJyb3IpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2F2ZUZpbHRlclRvSGlzdG9yeShmaWx0ZXI6IEZpbHRlclN0YXRlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGhpc3RvcnkgPSBhd2FpdCB0aGlzLmdldEZpbHRlckhpc3RvcnkoKTtcblxuICAgICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZSBmaWx0ZXJzIChzYW1lIHR5cGUgYW5kIHZhbHVlKVxuICAgICAgY29uc3QgZmlsdGVyZWRIaXN0b3J5ID0gaGlzdG9yeS5maWx0ZXIoXG4gICAgICAgIChmKSA9PlxuICAgICAgICAgICEoXG4gICAgICAgICAgICBmLnR5cGUgPT09IGZpbHRlci50eXBlICYmXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeShmLnZhbHVlKSA9PT0gSlNPTi5zdHJpbmdpZnkoZmlsdGVyLnZhbHVlKVxuICAgICAgICAgIClcbiAgICAgICk7XG5cbiAgICAgIC8vIEFkZCBuZXcgZmlsdGVyIHRvIHRoZSBiZWdpbm5pbmdcbiAgICAgIGNvbnN0IG5ld0hpc3RvcnkgPSBbZmlsdGVyLCAuLi5maWx0ZXJlZEhpc3RvcnldO1xuXG4gICAgICAvLyBMaW1pdCBoaXN0b3J5IHNpemVcbiAgICAgIGNvbnN0IHRyaW1tZWRIaXN0b3J5ID0gbmV3SGlzdG9yeS5zbGljZSgwLCB0aGlzLk1BWF9ISVNUT1JZX1NJWkUpO1xuXG4gICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKFxuICAgICAgICB0aGlzLkZJTFRFUl9ISVNUT1JZX0tFWSxcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkodHJpbW1lZEhpc3RvcnkpXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIHNhdmUgZmlsdGVyIHRvIGhpc3Rvcnk6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRGaWx0ZXJIaXN0b3J5KCk6IFByb21pc2U8RmlsdGVyU3RhdGVbXT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzYXZlZCA9IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0odGhpcy5GSUxURVJfSElTVE9SWV9LRVkpO1xuICAgICAgaWYgKCFzYXZlZCkgcmV0dXJuIFtdO1xuXG4gICAgICBjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKHNhdmVkKTtcblxuICAgICAgLy8gQ29udmVydCBkYXRlIHN0cmluZ3MgYmFjayB0byBEYXRlIG9iamVjdHNcbiAgICAgIHJldHVybiBwYXJzZWQubWFwKFxuICAgICAgICAoZmlsdGVyOiB7XG4gICAgICAgICAgdHlwZTogRmlsdGVyVHlwZTtcbiAgICAgICAgICB2YWx1ZTogRmlsdGVyVmFsdWU7XG4gICAgICAgICAgYXBwbGllZEF0OiBzdHJpbmc7XG4gICAgICAgIH0pID0+ICh7XG4gICAgICAgICAgLi4uZmlsdGVyLFxuICAgICAgICAgIGFwcGxpZWRBdDogbmV3IERhdGUoZmlsdGVyLmFwcGxpZWRBdCksXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJGYWlsZWQgdG8gbG9hZCBmaWx0ZXIgaGlzdG9yeTpcIiwgZXJyb3IpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNsZWFyRmlsdGVySGlzdG9yeSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSh0aGlzLkZJTFRFUl9ISVNUT1JZX0tFWSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJGYWlsZWQgdG8gY2xlYXIgZmlsdGVyIGhpc3Rvcnk6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRSZWNlbnRGaWx0ZXJzKGxpbWl0OiBudW1iZXIgPSAxMCk6IFByb21pc2U8RmlsdGVyU3RhdGVbXT4ge1xuICAgIGNvbnN0IGhpc3RvcnkgPSBhd2FpdCB0aGlzLmdldEZpbHRlckhpc3RvcnkoKTtcbiAgICByZXR1cm4gaGlzdG9yeS5zbGljZSgwLCBsaW1pdCk7XG4gIH1cblxuICBhc3luYyBjbGVhckFsbFN0YXRlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKHRoaXMuQlJPV1NFX1NUQVRFX0tFWSk7XG4gICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKHRoaXMuRklMVEVSX0hJU1RPUllfS0VZKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBjbGVhciBhbGwgc3RhdGU6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvLyBVdGlsaXR5IG1ldGhvZHMgZm9yIGZpbHRlciBtYW5hZ2VtZW50XG4gIGFzeW5jIGdldEZpbHRlckZyZXF1ZW5jeSgpOiBQcm9taXNlPE1hcDxzdHJpbmcsIG51bWJlcj4+IHtcbiAgICBjb25zdCBoaXN0b3J5ID0gYXdhaXQgdGhpcy5nZXRGaWx0ZXJIaXN0b3J5KCk7XG4gICAgY29uc3QgZnJlcXVlbmN5ID0gbmV3IE1hcDxzdHJpbmcsIG51bWJlcj4oKTtcblxuICAgIGhpc3RvcnkuZm9yRWFjaCgoZmlsdGVyKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBgJHtmaWx0ZXIudHlwZX06JHtKU09OLnN0cmluZ2lmeShmaWx0ZXIudmFsdWUpfWA7XG4gICAgICBmcmVxdWVuY3kuc2V0KGtleSwgKGZyZXF1ZW5jeS5nZXQoa2V5KSB8fCAwKSArIDEpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGZyZXF1ZW5jeTtcbiAgfVxuXG4gIGFzeW5jIGdldE1vc3RVc2VkRmlsdGVycyhsaW1pdDogbnVtYmVyID0gNSk6IFByb21pc2U8RmlsdGVyU3RhdGVbXT4ge1xuICAgIGNvbnN0IGhpc3RvcnkgPSBhd2FpdCB0aGlzLmdldEZpbHRlckhpc3RvcnkoKTtcbiAgICBjb25zdCBmcmVxdWVuY3kgPSBhd2FpdCB0aGlzLmdldEZpbHRlckZyZXF1ZW5jeSgpO1xuXG4gICAgLy8gR3JvdXAgZmlsdGVycyBieSB0eXBlOnZhbHVlIGFuZCBmaW5kIG1vc3QgZnJlcXVlbnRcbiAgICBjb25zdCBmaWx0ZXJNYXAgPSBuZXcgTWFwPHN0cmluZywgRmlsdGVyU3RhdGU+KCk7XG4gICAgaGlzdG9yeS5mb3JFYWNoKChmaWx0ZXIpID0+IHtcbiAgICAgIGNvbnN0IGtleSA9IGAke2ZpbHRlci50eXBlfToke0pTT04uc3RyaW5naWZ5KGZpbHRlci52YWx1ZSl9YDtcbiAgICAgIGlmICghZmlsdGVyTWFwLmhhcyhrZXkpKSB7XG4gICAgICAgIGZpbHRlck1hcC5zZXQoa2V5LCBmaWx0ZXIpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIEFycmF5LmZyb20oZmlsdGVyTWFwLnZhbHVlcygpKVxuICAgICAgLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgY29uc3Qga2V5QSA9IGAke2EudHlwZX06JHtKU09OLnN0cmluZ2lmeShhLnZhbHVlKX1gO1xuICAgICAgICBjb25zdCBrZXlCID0gYCR7Yi50eXBlfToke0pTT04uc3RyaW5naWZ5KGIudmFsdWUpfWA7XG4gICAgICAgIHJldHVybiAoZnJlcXVlbmN5LmdldChrZXlCKSB8fCAwKSAtIChmcmVxdWVuY3kuZ2V0KGtleUEpIHx8IDApO1xuICAgICAgfSlcbiAgICAgIC5zbGljZSgwLCBsaW1pdCk7XG4gIH1cblxuICBhc3luYyBnZXREZWZhdWx0QnJvd3NlU3RhdGUoKTogUHJvbWlzZTxCcm93c2VTdGF0ZT4ge1xuICAgIHJldHVybiB7XG4gICAgICBkaXNwbGF5U3RhdGU6IHtcbiAgICAgICAgY3VycmVudFZpZXc6IFwiZmlsdGVyX3NlbGVjdGlvblwiLFxuICAgICAgICBzZWxlY3RlZFNlcXVlbmNlOiBudWxsLFxuICAgICAgICBpc1NlcXVlbmNlRGV0YWlsT3BlbjogZmFsc2UsXG4gICAgICB9LFxuICAgICAgbG9hZGluZ1N0YXRlOiB7XG4gICAgICAgIGlzTG9hZGluZzogZmFsc2UsXG4gICAgICAgIGhhc0Vycm9yOiBmYWxzZSxcbiAgICAgICAgZXJyb3JNZXNzYWdlOiBudWxsLFxuICAgICAgfSxcbiAgICAgIGZpbHRlclN0YXRlOiB7XG4gICAgICAgIGFjdGl2ZUZpbHRlcnM6IHtcbiAgICAgICAgICBzdGFydGluZ19sZXR0ZXI6IFwiXCIsXG4gICAgICAgICAgY29udGFpbnNfbGV0dGVyczogXCJcIixcbiAgICAgICAgICBsZW5ndGg6IFwiXCIsXG4gICAgICAgICAgZGlmZmljdWx0eTogXCJcIixcbiAgICAgICAgICBzdGFydGluZ19wb3NpdGlvbjogXCJcIixcbiAgICAgICAgICBhdXRob3I6IFwiXCIsXG4gICAgICAgICAgZ3JpZE1vZGU6IFwiXCIsXG4gICAgICAgICAgYWxsX3NlcXVlbmNlczogXCJcIixcbiAgICAgICAgICBmYXZvcml0ZXM6IFwiXCIsXG4gICAgICAgICAgcmVjZW50OiBcIlwiLFxuICAgICAgICB9LFxuICAgICAgICBzb3J0TWV0aG9kOiBcImFscGhhYmV0aWNhbFwiIGFzIFNvcnRNZXRob2QsXG4gICAgICAgIHNlYXJjaFF1ZXJ5OiBcIlwiLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgLy8gQWRkaXRpb25hbCBtZXRob2RzIHJlcXVpcmVkIGJ5IGJyb3dzZS1pbnRlcmZhY2VzLnRzXG4gIGFzeW5jIHNhdmVGaWx0ZXJTdGF0ZShzdGF0ZTogQnJvd3NlRmlsdGVyU3RhdGUpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBDcmVhdGUgYSBCcm93c2VTdGF0ZSB3aXRoIHRoZSBmaWx0ZXIgc3RhdGVcbiAgICBjb25zdCBicm93c2VTdGF0ZTogQnJvd3NlU3RhdGUgPSB7XG4gICAgICBkaXNwbGF5U3RhdGU6IHtcbiAgICAgICAgY3VycmVudFZpZXc6IFwiZmlsdGVyX3NlbGVjdGlvblwiLFxuICAgICAgICBzZWxlY3RlZFNlcXVlbmNlOiBudWxsLFxuICAgICAgICBpc1NlcXVlbmNlRGV0YWlsT3BlbjogZmFsc2UsXG4gICAgICB9LFxuICAgICAgbG9hZGluZ1N0YXRlOiB7XG4gICAgICAgIGlzTG9hZGluZzogZmFsc2UsXG4gICAgICAgIGhhc0Vycm9yOiBmYWxzZSxcbiAgICAgICAgZXJyb3JNZXNzYWdlOiBudWxsLFxuICAgICAgfSxcbiAgICAgIGZpbHRlclN0YXRlOiBzdGF0ZSxcbiAgICB9O1xuICAgIGF3YWl0IHRoaXMuc2F2ZUJyb3dzZVN0YXRlKGJyb3dzZVN0YXRlKTtcbiAgfVxuXG4gIGFzeW5jIGxvYWRGaWx0ZXJTdGF0ZSgpOiBQcm9taXNlPEJyb3dzZUZpbHRlclN0YXRlPiB7XG4gICAgLy8gVXNlIHRoZSBleGlzdGluZyBsb2FkQnJvd3NlU3RhdGUgbWV0aG9kXG4gICAgY29uc3QgYnJvd3NlU3RhdGUgPSBhd2FpdCB0aGlzLmxvYWRCcm93c2VTdGF0ZSgpO1xuXG4gICAgLy8gUmV0dXJuIHRoZSBmaWx0ZXIgc3RhdGUgb3IgYSBkZWZhdWx0IG9uZSB3aXRoIHByb3BlciBGaWx0ZXJUeXBlIGtleXNcbiAgICByZXR1cm4gKFxuICAgICAgYnJvd3NlU3RhdGU/LmZpbHRlclN0YXRlIHx8IHtcbiAgICAgICAgYWN0aXZlRmlsdGVyczoge1xuICAgICAgICAgIHN0YXJ0aW5nX2xldHRlcjogbnVsbCxcbiAgICAgICAgICBjb250YWluc19sZXR0ZXJzOiBudWxsLFxuICAgICAgICAgIGxlbmd0aDogbnVsbCxcbiAgICAgICAgICBkaWZmaWN1bHR5OiBudWxsLFxuICAgICAgICAgIHN0YXJ0aW5nX3Bvc2l0aW9uOiBudWxsLFxuICAgICAgICAgIGF1dGhvcjogbnVsbCxcbiAgICAgICAgICBncmlkTW9kZTogbnVsbCxcbiAgICAgICAgICBhbGxfc2VxdWVuY2VzOiBudWxsLFxuICAgICAgICAgIGZhdm9yaXRlczogbnVsbCxcbiAgICAgICAgICByZWNlbnQ6IG51bGwsXG4gICAgICAgIH0sXG4gICAgICAgIHNvcnRNZXRob2Q6IFNvcnRNZXRob2RFbnVtLkFMUEhBQkVUSUNBTCxcbiAgICAgICAgc2VhcmNoUXVlcnk6IFwiXCIsXG4gICAgICB9XG4gICAgKTtcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiQUFnQkEsU0FBUyxjQUFjLHNCQUFzQjtBQXdDdEMsYUFBTSx5QkFBOEQ7QUFBQSxFQUN4RCxnQkFBZ0I7QUFBQTtBQUFBLEVBQ2hCLG1CQUFtQixPQUFPLEtBQUssYUFBYTtBQUFBLEVBQzVDLHFCQUFxQixPQUFPLEtBQUssYUFBYTtBQUFBLEVBQzlDLG1CQUFtQjtBQUFBLEVBRXBDLE1BQU0sZ0JBQWdCLE9BQW1DO0FBQ3ZELFFBQUk7QUFDRixZQUFNLGNBQWM7QUFBQSxRQUNsQixHQUFHO0FBQUEsUUFDSCxhQUFhLG9CQUFJLEtBQUs7QUFBQSxNQUN4QjtBQUNBLHFCQUFl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