export class PanelManagementService {
  panels = /* @__PURE__ */ new Map();
  configurations = /* @__PURE__ */ new Map();
  currentResize = null;
  stateChangeCallbacks = [];
  constructor() {
    this.loadPanelStates();
  }
  // Panel registration
  registerPanel(config) {
    this.configurations.set(config.id, config);
    if (!this.panels.has(config.id)) {
      const savedWidth = this.loadPanelWidth(
        config.persistKey,
        config.defaultWidth
      );
      const initialState = {
        id: config.id,
        width: savedWidth,
        isCollapsed: false,
        isVisible: true,
        minWidth: config.minWidth,
        maxWidth: config.maxWidth,
        defaultWidth: config.defaultWidth,
        collapsedWidth: config.collapsedWidth,
        isResizing: false
      };
      this.panels.set(config.id, initialState);
    }
  }
  unregisterPanel(panelId) {
    this.panels.delete(panelId);
    this.configurations.delete(panelId);
  }
  // Panel state management
  getPanelState(panelId) {
    const state = this.panels.get(panelId);
    if (!state) {
      console.warn(`Panel not registered: ${panelId}, returning default state`);
      return {
        id: panelId,
        width: 300,
        isCollapsed: false,
        isVisible: true,
        minWidth: 200,
        maxWidth: 600,
        defaultWidth: 300,
        collapsedWidth: 60,
        isResizing: false
      };
    }
    return { ...state };
  }
  togglePanelCollapse(panelId) {
    const state = this.panels.get(panelId);
    if (!state) return;
    this.setPanelCollapsed(panelId, !state.isCollapsed);
  }
  setPanelCollapsed(panelId, isCollapsed) {
    const state = this.panels.get(panelId);
    if (!state) return;
    const updatedState = {
      ...state,
      isCollapsed
      // Don't change width when collapsing - layout handles this with CSS
    };
    this.panels.set(panelId, updatedState);
    this.notifyStateChange(panelId, updatedState);
    this.savePanelStates();
  }
  setPanelVisible(panelId, isVisible) {
    const state = this.panels.get(panelId);
    if (!state) return;
    const updatedState = {
      ...state,
      isVisible
    };
    this.panels.set(panelId, updatedState);
    this.notifyStateChange(panelId, updatedState);
  }
  setPanelWidth(panelId, width) {
    const state = this.panels.get(panelId);
    if (!state) return;
    const validatedWidth = this.validateWidth(panelId, width);
    const updatedState = {
      ...state,
      width: validatedWidth
    };
    this.panels.set(panelId, updatedState);
    this.notifyStateChange(panelId, updatedState);
    this.savePanelStates();
  }
  // Resize operations
  startResize(panelId, startX) {
    const state = this.panels.get(panelId);
    if (!state || !this.canResize(panelId)) {
      return null;
    }
    const operation = {
      panelId,
      startWidth: state.width,
      startX,
      currentX: startX
    };
    this.currentResize = operation;
    const updatedState = { ...state, isResizing: true };
    this.panels.set(panelId, updatedState);
    this.notifyStateChange(panelId, updatedState);
    return operation;
  }
  updateResize(operation, currentX) {
    const state = this.panels.get(operation.panelId);
    if (!state) {
      throw new Error(`Panel not found during resize: ${operation.panelId}`);
    }
    operation.currentX = currentX;
    const deltaX = currentX - operation.startX;
    const newWidth = operation.startWidth + deltaX;
    const validatedWidth = this.validateWidth(operation.panelId, newWidth);
    const updatedState = {
      ...state,
      width: validatedWidth
    };
    this.panels.set(operation.panelId, updatedState);
    this.notifyStateChange(operation.panelId, updatedState);
    return updatedState;
  }
  endResize(operation) {
    const state = this.panels.get(operation.panelId);
    if (!state) return;
    const updatedState = { ...state, isResizing: false };
    this.panels.set(operation.panelId, updatedState);
    this.notifyStateChange(operation.panelId, updatedState);
    this.currentResize = null;
    this.savePanelStates();
  }
  // Validation
  validateWidth(panelId, width) {
    const state = this.panels.get(panelId);
    if (!state) return width;
    return Math.max(state.minWidth, Math.min(state.maxWidth, width));
  }
  canResize(panelId) {
    const state = this.panels.get(panelId);
    return !!(state && state.isVisible && !state.isCollapsed);
  }
  // Persistence
  savePanelStates() {
    try {
      const states = {};
      for (const [panelId, state] of this.panels) {
        const config = this.configurations.get(panelId);
        if (config) {
          states[config.persistKey] = {
            width: state.width,
            isCollapsed: state.isCollapsed
          };
        }
      }
      localStorage.setItem("tka-panel-states", JSON.stringify(states));
    } catch (error) {
      console.warn("Failed to save panel states:", error);
    }
  }
  loadPanelStates() {
    try {
      const saved = localStorage.getItem("tka-panel-states");
      if (!saved) return;
      const states = JSON.parse(saved);
      this.savedStates = states;
    } catch (error) {
      console.warn("Failed to load panel states:", error);
    }
  }
  savedStates = {};
  loadPanelWidth(persistKey, defaultWidth) {
    const saved = this.savedStates[persistKey];
    return saved?.width ?? defaultWidth;
  }
  loadPanelCollapsed(persistKey) {
    const saved = this.savedStates[persistKey];
    return saved?.isCollapsed ?? false;
  }
  // Event handling
  onPanelStateChanged(callback) {
    this.stateChangeCallbacks.push(callback);
  }
  offPanelStateChanged(callback) {
    const index = this.stateChangeCallbacks.indexOf(callback);
    if (index > -1) {
      this.stateChangeCallbacks.splice(index, 1);
    }
  }
  notifyStateChange(panelId, state) {
    this.stateChangeCallbacks.forEach((callback) => {
      try {
        callback(panelId, { ...state });
      } catch (error) {
        console.error("Error in panel state change callback:", error);
      }
    });
  }
  // Utility methods
  getAllPanelStates() {
    const states = {};
    for (const [panelId, state] of this.panels) {
      states[panelId] = { ...state };
    }
    return states;
  }
  resetPanel(panelId) {
    const config = this.configurations.get(panelId);
    if (!config) return;
    const resetState = {
      id: panelId,
      width: config.defaultWidth,
      isCollapsed: false,
      isVisible: true,
      minWidth: config.minWidth,
      maxWidth: config.maxWidth,
      defaultWidth: config.defaultWidth,
      collapsedWidth: config.collapsedWidth,
      isResizing: false
    };
    this.panels.set(panelId, resetState);
    this.notifyStateChange(panelId, resetState);
    this.savePanelStates();
  }
  resetAllPanels() {
    for (const panelId of this.panels.keys()) {
      this.resetPanel(panelId);
    }
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlBhbmVsTWFuYWdlbWVudFNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBQYW5lbCBNYW5hZ2VtZW50IFNlcnZpY2UgSW1wbGVtZW50YXRpb25cbiAqXG4gKiBQcm92aWRlcyB1bmlmaWVkIHBhbmVsIHN0YXRlIG1hbmFnZW1lbnQgd2l0aCBjb2xsYXBzZS9leHBhbmQsIHJlc2l6aW5nLCBhbmQgcGVyc2lzdGVuY2UuXG4gKiBGb2xsb3dzIG1pY3Jvc2VydmljZXMgYXJjaGl0ZWN0dXJlIHdpdGggY2xlYW4gYnVzaW5lc3MgbG9naWMgc2VwYXJhdGlvbi5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7XG4gIElQYW5lbE1hbmFnZW1lbnRTZXJ2aWNlLFxuICBQYW5lbFN0YXRlLFxuICBQYW5lbENvbmZpZ3VyYXRpb24sXG4gIFJlc2l6ZU9wZXJhdGlvbixcbn0gZnJvbSBcIi4uLy4uL2RpL2ludGVyZmFjZXMvcGFuZWwtaW50ZXJmYWNlc1wiO1xuXG5leHBvcnQgY2xhc3MgUGFuZWxNYW5hZ2VtZW50U2VydmljZSBpbXBsZW1lbnRzIElQYW5lbE1hbmFnZW1lbnRTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBwYW5lbHMgPSBuZXcgTWFwPHN0cmluZywgUGFuZWxTdGF0ZT4oKTtcbiAgcHJpdmF0ZSBjb25maWd1cmF0aW9ucyA9IG5ldyBNYXA8c3RyaW5nLCBQYW5lbENvbmZpZ3VyYXRpb24+KCk7XG4gIHByaXZhdGUgY3VycmVudFJlc2l6ZTogUmVzaXplT3BlcmF0aW9uIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgc3RhdGVDaGFuZ2VDYWxsYmFja3M6IEFycmF5PFxuICAgIChwYW5lbElkOiBzdHJpbmcsIHN0YXRlOiBQYW5lbFN0YXRlKSA9PiB2b2lkXG4gID4gPSBbXTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmxvYWRQYW5lbFN0YXRlcygpO1xuICB9XG5cbiAgLy8gUGFuZWwgcmVnaXN0cmF0aW9uXG4gIHJlZ2lzdGVyUGFuZWwoY29uZmlnOiBQYW5lbENvbmZpZ3VyYXRpb24pOiB2b2lkIHtcbiAgICB0aGlzLmNvbmZpZ3VyYXRpb25zLnNldChjb25maWcuaWQsIGNvbmZpZyk7XG5cbiAgICAvLyBDcmVhdGUgaW5pdGlhbCBzdGF0ZSBpZiBub3QgZXhpc3RzXG4gICAgaWYgKCF0aGlzLnBhbmVscy5oYXMoY29uZmlnLmlkKSkge1xuICAgICAgY29uc3Qgc2F2ZWRXaWR0aCA9IHRoaXMubG9hZFBhbmVsV2lkdGgoXG4gICAgICAgIGNvbmZpZy5wZXJzaXN0S2V5LFxuICAgICAgICBjb25maWcuZGVmYXVsdFdpZHRoXG4gICAgICApO1xuICAgICAgY29uc3QgaW5pdGlhbFN0YXRlOiBQYW5lbFN0YXRlID0ge1xuICAgICAgICBpZDogY29uZmlnLmlkLFxuICAgICAgICB3aWR0aDogc2F2ZWRXaWR0aCxcbiAgICAgICAgaXNDb2xsYXBzZWQ6IGZhbHNlLFxuICAgICAgICBpc1Zpc2libGU6IHRydWUsXG4gICAgICAgIG1pbldpZHRoOiBjb25maWcubWluV2lkdGgsXG4gICAgICAgIG1heFdpZHRoOiBjb25maWcubWF4V2lkdGgsXG4gICAgICAgIGRlZmF1bHRXaWR0aDogY29uZmlnLmRlZmF1bHRXaWR0aCxcbiAgICAgICAgY29sbGFwc2VkV2lkdGg6IGNvbmZpZy5jb2xsYXBzZWRXaWR0aCxcbiAgICAgICAgaXNSZXNpemluZzogZmFsc2UsXG4gICAgICB9O1xuXG4gICAgICB0aGlzLnBhbmVscy5zZXQoY29uZmlnLmlkLCBpbml0aWFsU3RhdGUpO1xuICAgIH1cbiAgfVxuXG4gIHVucmVnaXN0ZXJQYW5lbChwYW5lbElkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnBhbmVscy5kZWxldGUocGFuZWxJZCk7XG4gICAgdGhpcy5jb25maWd1cmF0aW9ucy5kZWxldGUocGFuZWxJZCk7XG4gIH1cblxuICAvLyBQYW5lbCBzdGF0ZSBtYW5hZ2VtZW50XG4gIGdldFBhbmVsU3RhdGUocGFuZWxJZDogc3RyaW5nKTogUGFuZWxTdGF0ZSB7XG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLnBhbmVscy5nZXQocGFuZWxJZCk7XG4gICAgaWYgKCFzdGF0ZSkge1xuICAgICAgLy8gUmV0dXJuIGEgZGVmYXVsdCBzdGF0ZSBmb3IgdW5yZWdpc3RlcmVkIHBhbmVscyBpbnN0ZWFkIG9mIHRocm93aW5nXG4gICAgICBjb25zb2xlLndhcm4oYFBhbmVsIG5vdCByZWdpc3RlcmVkOiAke3BhbmVsSWR9LCByZXR1cm5pbmcgZGVmYXVsdCBzdGF0ZWApO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IHBhbmVsSWQsXG4gICAgICAgIHdpZHRoOiAzMDAsXG4gICAgICAgIGlzQ29sbGFwc2VkOiBmYWxzZSxcbiAgICAgICAgaXNWaXNpYmxlOiB0cnVlLFxuICAgICAgICBtaW5XaWR0aDogMjAwLFxuICAgICAgICBtYXhXaWR0aDogNjAwLFxuICAgICAgICBkZWZhdWx0V2lkdGg6IDMwMCxcbiAgICAgICAgY29sbGFwc2VkV2lkdGg6IDYwLFxuICAgICAgICBpc1Jlc2l6aW5nOiBmYWxzZSxcbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB7IC4uLnN0YXRlIH07IC8vIFJldHVybiBjb3B5IHRvIHByZXZlbnQgZGlyZWN0IG11dGF0aW9uXG4gIH1cblxuICB0b2dnbGVQYW5lbENvbGxhcHNlKHBhbmVsSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5wYW5lbHMuZ2V0KHBhbmVsSWQpO1xuICAgIGlmICghc3RhdGUpIHJldHVybjtcblxuICAgIHRoaXMuc2V0UGFuZWxDb2xsYXBzZWQocGFuZWxJZCwgIXN0YXRlLmlzQ29sbGFwc2VkKTtcbiAgfVxuXG4gIHNldFBhbmVsQ29sbGFwc2VkKHBhbmVsSWQ6IHN0cmluZywgaXNDb2xsYXBzZWQ6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMucGFuZWxzLmdldChwYW5lbElkKTtcbiAgICBpZiAoIXN0YXRlKSByZXR1cm47XG5cbiAgICBjb25zdCB1cGRhdGVkU3RhdGUgPSB7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIGlzQ29sbGFwc2VkLFxuICAgICAgLy8gRG9uJ3QgY2hhbmdlIHdpZHRoIHdoZW4gY29sbGFwc2luZyAtIGxheW91dCBoYW5kbGVzIHRoaXMgd2l0aCBDU1NcbiAgICB9O1xuXG4gICAgdGhpcy5wYW5lbHMuc2V0KHBhbmVsSWQsIHVwZGF0ZWRTdGF0ZSk7XG4gICAgdGhpcy5ub3RpZnlTdGF0ZUNoYW5nZShwYW5lbElkLCB1cGRhdGVkU3RhdGUpO1xuICAgIHRoaXMuc2F2ZVBhbmVsU3RhdGVzKCk7XG4gIH1cblxuICBzZXRQYW5lbFZpc2libGUocGFuZWxJZDogc3RyaW5nLCBpc1Zpc2libGU6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMucGFuZWxzLmdldChwYW5lbElkKTtcbiAgICBpZiAoIXN0YXRlKSByZXR1cm47XG5cbiAgICBjb25zdCB1cGRhdGVkU3RhdGUgPSB7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIGlzVmlzaWJsZSxcbiAgICB9O1xuXG4gICAgdGhpcy5wYW5lbHMuc2V0KHBhbmVsSWQsIHVwZGF0ZWRTdGF0ZSk7XG4gICAgdGhpcy5ub3RpZnlTdGF0ZUNoYW5nZShwYW5lbElkLCB1cGRhdGVkU3RhdGUpO1xuICB9XG5cbiAgc2V0UGFuZWxXaWR0aChwYW5lbElkOiBzdHJpbmcsIHdpZHRoOiBudW1iZXIpOiB2b2lkIHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMucGFuZWxzLmdldChwYW5lbElkKTtcbiAgICBpZiAoIXN0YXRlKSByZXR1cm47XG5cbiAgICBjb25zdCB2YWxpZGF0ZWRXaWR0aCA9IHRoaXMudmFsaWRhdGVXaWR0aChwYW5lbElkLCB3aWR0aCk7XG4gICAgY29uc3QgdXBkYXRlZFN0YXRlID0ge1xuICAgICAgLi4uc3RhdGUsXG4gICAgICB3aWR0aDogdmFsaWRhdGVkV2lkdGgsXG4gICAgfTtcblxuICAgIHRoaXMucGFuZWxzLnNldChwYW5lbElkLCB1cGRhdGVkU3RhdGUpO1xuICAgIHRoaXMubm90aWZ5U3RhdGVDaGFuZ2UocGFuZWxJZCwgdXBkYXRlZFN0YXRlKTtcbiAgICB0aGlzLnNhdmVQYW5lbFN0YXRlcygpO1xuICB9XG5cbiAgLy8gUmVzaXplIG9wZXJhdGlvbnNcbiAgc3RhcnRSZXNpemUocGFuZWxJZDogc3RyaW5nLCBzdGFydFg6IG51bWJlcik6IFJlc2l6ZU9wZXJhdGlvbiB8IG51bGwge1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5wYW5lbHMuZ2V0KHBhbmVsSWQpO1xuICAgIGlmICghc3RhdGUgfHwgIXRoaXMuY2FuUmVzaXplKHBhbmVsSWQpKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBvcGVyYXRpb246IFJlc2l6ZU9wZXJhdGlvbiA9IHtcbiAgICAgIHBhbmVsSWQsXG4gICAgICBzdGFydFdpZHRoOiBzdGF0ZS53aWR0aCxcbiAgICAgIHN0YXJ0WCxcbiAgICAgIGN1cnJlbnRYOiBzdGFydFgsXG4gICAgfTtcblxuICAgIHRoaXMuY3VycmVudFJlc2l6ZSA9IG9wZXJhdGlvbjtcblxuICAgIC8vIE1hcmsgcGFuZWwgYXMgcmVzaXppbmdcbiAgICBjb25zdCB1cGRhdGVkU3RhdGUgPSB7IC4uLnN0YXRlLCBpc1Jlc2l6aW5nOiB0cnVlIH07XG4gICAgdGhpcy5wYW5lbHMuc2V0KHBhbmVsSWQsIHVwZGF0ZWRTdGF0ZSk7XG4gICAgdGhpcy5ub3RpZnlTdGF0ZUNoYW5nZShwYW5lbElkLCB1cGRhdGVkU3RhdGUpO1xuXG4gICAgcmV0dXJuIG9wZXJhdGlvbjtcbiAgfVxuXG4gIHVwZGF0ZVJlc2l6ZShvcGVyYXRpb246IFJlc2l6ZU9wZXJhdGlvbiwgY3VycmVudFg6IG51bWJlcik6IFBhbmVsU3RhdGUge1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5wYW5lbHMuZ2V0KG9wZXJhdGlvbi5wYW5lbElkKTtcbiAgICBpZiAoIXN0YXRlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFBhbmVsIG5vdCBmb3VuZCBkdXJpbmcgcmVzaXplOiAke29wZXJhdGlvbi5wYW5lbElkfWApO1xuICAgIH1cblxuICAgIG9wZXJhdGlvbi5jdXJyZW50WCA9IGN1cnJlbnRYO1xuICAgIGNvbnN0IGRlbHRhWCA9IGN1cnJlbnRYIC0gb3BlcmF0aW9uLnN0YXJ0WDtcbiAgICBjb25zdCBuZXdXaWR0aCA9IG9wZXJhdGlvbi5zdGFydFdpZHRoICsgZGVsdGFYO1xuICAgIGNvbnN0IHZhbGlkYXRlZFdpZHRoID0gdGhpcy52YWxpZGF0ZVdpZHRoKG9wZXJhdGlvbi5wYW5lbElkLCBuZXdXaWR0aCk7XG5cbiAgICBjb25zdCB1cGRhdGVkU3RhdGUgPSB7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIHdpZHRoOiB2YWxpZGF0ZWRXaWR0aCxcbiAgICB9O1xuXG4gICAgdGhpcy5wYW5lbHMuc2V0KG9wZXJhdGlvbi5wYW5lbElkLCB1cGRhdGVkU3RhdGUpO1xuICAgIHRoaXMubm90aWZ5U3RhdGVDaGFuZ2Uob3BlcmF0aW9uLnBhbmVsSWQsIHVwZGF0ZWRTdGF0ZSk7XG5cbiAgICByZXR1cm4gdXBkYXRlZFN0YXRlO1xuICB9XG5cbiAgZW5kUmVzaXplKG9wZXJhdGlvbjogUmVzaXplT3BlcmF0aW9uKTogdm9pZCB7XG4gICAgY29uc3Qgc3RhdGUgPSB0aGlzLnBhbmVscy5nZXQob3BlcmF0aW9uLnBhbmVsSWQpO1xuICAgIGlmICghc3RhdGUpIHJldHVybjtcblxuICAgIGNvbnN0IHVwZGF0ZWRTdGF0ZSA9IHsgLi4uc3RhdGUsIGlzUmVzaXppbmc6IGZhbHNlIH07XG4gICAgdGhpcy5wYW5lbHMuc2V0KG9wZXJhdGlvbi5wYW5lbElkLCB1cGRhdGVkU3RhdGUpO1xuICAgIHRoaXMubm90aWZ5U3RhdGVDaGFuZ2Uob3BlcmF0aW9uLnBhbmVsSWQsIHVwZGF0ZWRTdGF0ZSk7XG5cbiAgICB0aGlzLmN1cnJlbnRSZXNpemUgPSBudWxsO1xuICAgIHRoaXMuc2F2ZVBhbmVsU3RhdGVzKCk7XG4gIH1cblxuICAvLyBWYWxpZGF0aW9uXG4gIHZhbGlkYXRlV2lkdGgocGFuZWxJZDogc3RyaW5nLCB3aWR0aDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMucGFuZWxzLmdldChwYW5lbElkKTtcbiAgICBpZiAoIXN0YXRlKSByZXR1cm4gd2lkdGg7XG5cbiAgICByZXR1cm4gTWF0aC5tYXgoc3RhdGUubWluV2lkdGgsIE1hdGgubWluKHN0YXRlLm1heFdpZHRoLCB3aWR0aCkpO1xuICB9XG5cbiAgY2FuUmVzaXplKHBhbmVsSWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5wYW5lbHMuZ2V0KHBhbmVsSWQpO1xuICAgIHJldHVybiAhIShzdGF0ZSAmJiBzdGF0ZS5pc1Zpc2libGUgJiYgIXN0YXRlLmlzQ29sbGFwc2VkKTtcbiAgfVxuXG4gIC8vIFBlcnNpc3RlbmNlXG4gIHNhdmVQYW5lbFN0YXRlcygpOiB2b2lkIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3RhdGVzOiBSZWNvcmQ8c3RyaW5nLCB7IHdpZHRoOiBudW1iZXI7IGlzQ29sbGFwc2VkOiBib29sZWFuIH0+ID1cbiAgICAgICAge307XG5cbiAgICAgIGZvciAoY29uc3QgW3BhbmVsSWQsIHN0YXRlXSBvZiB0aGlzLnBhbmVscykge1xuICAgICAgICBjb25zdCBjb25maWcgPSB0aGlzLmNvbmZpZ3VyYXRpb25zLmdldChwYW5lbElkKTtcbiAgICAgICAgaWYgKGNvbmZpZykge1xuICAgICAgICAgIHN0YXRlc1tjb25maWcucGVyc2lzdEtleV0gPSB7XG4gICAgICAgICAgICB3aWR0aDogc3RhdGUud2lkdGgsXG4gICAgICAgICAgICBpc0NvbGxhcHNlZDogc3RhdGUuaXNDb2xsYXBzZWQsXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShcInRrYS1wYW5lbC1zdGF0ZXNcIiwgSlNPTi5zdHJpbmdpZnkoc3RhdGVzKSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIkZhaWxlZCB0byBzYXZlIHBhbmVsIHN0YXRlczpcIiwgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIGxvYWRQYW5lbFN0YXRlcygpOiB2b2lkIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2F2ZWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcInRrYS1wYW5lbC1zdGF0ZXNcIik7XG4gICAgICBpZiAoIXNhdmVkKSByZXR1cm47XG5cbiAgICAgIGNvbnN0IHN0YXRlcyA9IEpTT04ucGFyc2Uoc2F2ZWQpO1xuXG4gICAgICAvLyBXaWxsIGFwcGx5IHRvIHBhbmVscyB3aGVuIHRoZXkgYXJlIHJlZ2lzdGVyZWRcbiAgICAgIHRoaXMuc2F2ZWRTdGF0ZXMgPSBzdGF0ZXM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIkZhaWxlZCB0byBsb2FkIHBhbmVsIHN0YXRlczpcIiwgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2F2ZWRTdGF0ZXM6IFJlY29yZDxzdHJpbmcsIHsgd2lkdGg6IG51bWJlcjsgaXNDb2xsYXBzZWQ6IGJvb2xlYW4gfT4gPVxuICAgIHt9O1xuXG4gIHByaXZhdGUgbG9hZFBhbmVsV2lkdGgocGVyc2lzdEtleTogc3RyaW5nLCBkZWZhdWx0V2lkdGg6IG51bWJlcik6IG51bWJlciB7XG4gICAgY29uc3Qgc2F2ZWQgPSB0aGlzLnNhdmVkU3RhdGVzW3BlcnNpc3RLZXldO1xuICAgIHJldHVybiBzYXZlZD8ud2lkdGggPz8gZGVmYXVsdFdpZHRoO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkUGFuZWxDb2xsYXBzZWQocGVyc2lzdEtleTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3Qgc2F2ZWQgPSB0aGlzLnNhdmVkU3RhdGVzW3BlcnNpc3RLZXldO1xuICAgIHJldHVybiBzYXZlZD8uaXNDb2xsYXBzZWQgPz8gZmFsc2U7XG4gIH1cblxuICAvLyBFdmVudCBoYW5kbGluZ1xuICBvblBhbmVsU3RhdGVDaGFuZ2VkKFxuICAgIGNhbGxiYWNrOiAocGFuZWxJZDogc3RyaW5nLCBzdGF0ZTogUGFuZWxTdGF0ZSkgPT4gdm9pZFxuICApOiB2b2lkIHtcbiAgICB0aGlzLnN0YXRlQ2hhbmdlQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spO1xuICB9XG5cbiAgb2ZmUGFuZWxTdGF0ZUNoYW5nZWQoXG4gICAgY2FsbGJhY2s6IChwYW5lbElkOiBzdHJpbmcsIHN0YXRlOiBQYW5lbFN0YXRlKSA9PiB2b2lkXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5zdGF0ZUNoYW5nZUNhbGxiYWNrcy5pbmRleE9mKGNhbGxiYWNrKTtcbiAgICBpZiAoaW5kZXggPiAtMSkge1xuICAgICAgdGhpcy5zdGF0ZUNoYW5nZUNhbGxiYWNrcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbm90aWZ5U3RhdGVDaGFuZ2UocGFuZWxJZDogc3RyaW5nLCBzdGF0ZTogUGFuZWxTdGF0ZSk6IHZvaWQge1xuICAgIHRoaXMuc3RhdGVDaGFuZ2VDYWxsYmFja3MuZm9yRWFjaCgoY2FsbGJhY2spID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNhbGxiYWNrKHBhbmVsSWQsIHsgLi4uc3RhdGUgfSk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgaW4gcGFuZWwgc3RhdGUgY2hhbmdlIGNhbGxiYWNrOlwiLCBlcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvLyBVdGlsaXR5IG1ldGhvZHNcbiAgZ2V0QWxsUGFuZWxTdGF0ZXMoKTogUmVjb3JkPHN0cmluZywgUGFuZWxTdGF0ZT4ge1xuICAgIGNvbnN0IHN0YXRlczogUmVjb3JkPHN0cmluZywgUGFuZWxTdGF0ZT4gPSB7fTtcbiAgICBmb3IgKGNvbnN0IFtwYW5lbElkLCBzdGF0ZV0gb2YgdGhpcy5wYW5lbHMpIHtcbiAgICAgIHN0YXRlc1twYW5lbElkXSA9IHsgLi4uc3RhdGUgfTtcbiAgICB9XG4gICAgcmV0dXJuIHN0YXRlcztcbiAgfVxuXG4gIHJlc2V0UGFuZWwocGFuZWxJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgY29uZmlnID0gdGhpcy5jb25maWd1cmF0aW9ucy5nZXQocGFuZWxJZCk7XG4gICAgaWYgKCFjb25maWcpIHJldHVybjtcblxuICAgIGNvbnN0IHJlc2V0U3RhdGU6IFBhbmVsU3RhdGUgPSB7XG4gICAgICBpZDogcGFuZWxJZCxcbiAgICAgIHdpZHRoOiBjb25maWcuZGVmYXVsdFdpZHRoLFxuICAgICAgaXNDb2xsYXBzZWQ6IGZhbHNlLFxuICAgICAgaXNWaXNpYmxlOiB0cnVlLFxuICAgICAgbWluV2lkdGg6IGNvbmZpZy5taW5XaWR0aCxcbiAgICAgIG1heFdpZHRoOiBjb25maWcubWF4V2lkdGgsXG4gICAgICBkZWZhdWx0V2lkdGg6IGNvbmZpZy5kZWZhdWx0V2lkdGgsXG4gICAgICBjb2xsYXBzZWRXaWR0aDogY29uZmlnLmNvbGxhcHNlZFdpZHRoLFxuICAgICAgaXNSZXNpemluZzogZmFsc2UsXG4gICAgfTtcblxuICAgIHRoaXMucGFuZWxzLnNldChwYW5lbElkLCByZXNldFN0YXRlKTtcbiAgICB0aGlzLm5vdGlmeVN0YXRlQ2hhbmdlKHBhbmVsSWQsIHJlc2V0U3RhdGUpO1xuICAgIHRoaXMuc2F2ZVBhbmVsU3RhdGVzKCk7XG4gIH1cblxuICByZXNldEFsbFBhbmVscygpOiB2b2lkIHtcbiAgICBmb3IgKGNvbnN0IHBhbmVsSWQgb2YgdGhpcy5wYW5lbHMua2V5cygpKSB7XG4gICAgICB0aGlzLnJlc2V0UGFuZWwocGFuZWxJZCk7XG4gICAgfVxuICB9XG59XG4iXSwibWFwcGluZ3MiOiJBQWNPLGFBQU0sdUJBQTBEO0FBQUEsRUFDN0QsU0FBUyxvQkFBSSxJQUF3QjtBQUFBLEVBQ3JDLGlCQUFpQixvQkFBSSxJQUFnQztBQUFBLEVBQ3JELGdCQUF3QztBQUFBLEVBQ3hDLHVCQUVK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