/* optionPickerRunes.svelte.ts generated by Svelte v5.38.1 */
import * as $ from "/node_modules/.vite/deps/svelte_internal_client.js?v=cc8aba6c";
import { resolve } from "/src/lib/services/bootstrap.ts";
import { createBeatData } from "/src/lib/domain/BeatData.ts";
import { determineGroupKey, getSortedGroupKeys, getSorter } from "/src/lib/components/construct/option-picker/services/OptionsService.ts";
import { GridMode } from "/src/lib/domain/index.ts";

function getStoredState() {
	if ($.strict_equals(typeof window, "undefined")) return {
		sortMethod: "type",
		isLoading: false,
		error: null,
		lastSelectedTab: {}
	};

	try {
		const stored = localStorage.getItem("optionPickerUIState");

		if (!stored) return {
			sortMethod: "type",
			isLoading: false,
			error: null,
			lastSelectedTab: { type: "all" }
		};

		const parsed = JSON.parse(stored);

		return {
			sortMethod: parsed.sortMethod || "type",
			isLoading: false,
			error: null,
			lastSelectedTab: parsed.lastSelectedTab || { type: "all" }
		};
	} catch(e) {
		console.error(...$.log_if_contains_state('error', "Error reading from localStorage:", e));

		return {
			sortMethod: "type",
			isLoading: false,
			error: null,
			lastSelectedTab: { type: "all" }
		};
	}
}

export function createOptionPickerRunes() {
	let sequenceData = $.tag($.state($.proxy([])), 'sequenceData');
	let optionsData = $.tag($.state($.proxy([])), 'optionsData');
	let selectedPictograph = $.tag($.state(null), 'selectedPictograph');
	const storedState = getStoredState();

	let uiState = $.tag(
		$.state($.proxy({
			sortMethod: storedState.sortMethod,
			isLoading: storedState.isLoading,
			error: storedState.error,
			lastSelectedTab: storedState.lastSelectedTab
		})),
		'uiState'
	);

	const filteredOptions = $.tag(
		$.derived(() => () => {
			const options = [...$.get(optionsData)];

			options.sort(getSorter($.get(uiState).sortMethod, $.get(sequenceData)));

			return options;
		}),
		'filteredOptions'
	);

	let cachedGroupedOptions = $.tag($.state($.proxy({})), 'cachedGroupedOptions');

	function computeGroupedOptions() {
		const groups = {};
		const options = $.get(filteredOptions)();

		options.forEach((option) => {
			const groupKey = determineGroupKey(option, $.get(uiState).sortMethod, $.get(sequenceData));

			if (!groups[groupKey]) groups[groupKey] = [];

			groups[groupKey].push(option);
		});

		const sortedKeys = getSortedGroupKeys(Object.keys(groups), $.get(uiState).sortMethod);
		const sortedGroups = {};

		sortedKeys.forEach((key) => {
			if (groups[key]) {
				sortedGroups[key] = groups[key];
			}
		});

		$.set(cachedGroupedOptions, sortedGroups, true);

		return sortedGroups;
	}

	const categoryKeys = $.tag($.derived(() => () => Object.keys($.get(cachedGroupedOptions))), 'categoryKeys');

	async function loadOptions(sequence) {
		$.set(sequenceData, sequence, true);

		try {
			const preloadedData = localStorage.getItem("preloaded_options");

			if (preloadedData) {
				const preloadedOptions = JSON.parse(preloadedData);

				$.set(optionsData, preloadedOptions || [], true);
				$.get(uiState).isLoading = false;
				$.get(uiState).error = null;
				localStorage.removeItem("preloaded_options");

				if (!$.get(uiState).lastSelectedTab[$.get(uiState).sortMethod] || $.strict_equals($.get(uiState).lastSelectedTab[$.get(uiState).sortMethod], null)) {
					setLastSelectedTabForSort($.get(uiState).sortMethod, "all");
				}

				return;
			}

			const allPreloadedData = localStorage.getItem("all_preloaded_options");

			if (allPreloadedData) {
				const allPreloadedOptions = JSON.parse(allPreloadedData);
				let targetEndPosition = null;

				if (sequence && sequence.length > 0) {
					const lastBeat = sequence[sequence.length - 1];
					const endPosition = lastBeat?.endPosition || lastBeat?.metadata?.endPosition;

					targetEndPosition = $.strict_equals(typeof endPosition, "string") ? endPosition : null;
				} else {
					const startPositionData = localStorage.getItem("startPosition");

					if (startPositionData) {
						const startPosition = JSON.parse(startPositionData);

						targetEndPosition = startPosition.endPosition || null;
					}
				}

				if (targetEndPosition && allPreloadedOptions[targetEndPosition]) {
					const optionsForPosition = allPreloadedOptions[targetEndPosition];

					$.set(optionsData, optionsForPosition || [], true);
					$.get(uiState).isLoading = false;
					$.get(uiState).error = null;

					if (!$.get(uiState).lastSelectedTab[$.get(uiState).sortMethod] || $.strict_equals($.get(uiState).lastSelectedTab[$.get(uiState).sortMethod], null)) {
						setLastSelectedTabForSort($.get(uiState).sortMethod, "all");
					}

					return;
				}
			}
		} catch(error) {
			console.warn(...$.log_if_contains_state('warn', "Failed to load preloaded options, falling back to normal loading:", error));
		}

		$.get(uiState).isLoading = true;
		$.get(uiState).error = null;

		try {
			let nextOptions = [];

			if (sequence && sequence.length > 0) {
				const lastBeat = sequence[sequence.length - 1];
				const endPosition = lastBeat?.endPosition || lastBeat?.metadata?.endPosition;

				if (endPosition && $.strict_equals(typeof endPosition, "string")) {
					const optionDataService = resolve("IOptionDataService");
					const minimalSequence = [createBeatData({ beatNumber: 1, metadata: { endPosition } })];

					nextOptions = (await $.track_reactivity_loss(optionDataService.getNextOptions(minimalSequence)))();
				} else {
					console.warn("No end position found in sequence");
				}
			} else {
				const startPositionData = localStorage.getItem("startPosition");

				if (startPositionData) {
					const startPosition = JSON.parse(startPositionData);
					const endPosition = $.strict_equals(typeof startPosition.endPosition, "string") ? startPosition.endPosition : null;

					if (endPosition) {
						const { ILetterQueryServiceInterface } = (await $.track_reactivity_loss(import("/src/lib/services/di/interfaces/codex-interfaces.ts")))();
						const letterQueryService = resolve(ILetterQueryServiceInterface);

						nextOptions = (await $.track_reactivity_loss(letterQueryService.getAllCodexPictographs(GridMode.DIAMOND)))();
					}
				}
			}

			if (!nextOptions || $.strict_equals(nextOptions.length, 0)) {
				console.warn("No options available for the current sequence");
			}

			$.set(optionsData, nextOptions || [], true);
			$.get(uiState).isLoading = false;

			if (!$.get(uiState).lastSelectedTab[$.get(uiState).sortMethod] || $.strict_equals($.get(uiState).lastSelectedTab[$.get(uiState).sortMethod], null)) {
				setLastSelectedTabForSort($.get(uiState).sortMethod, "all");

				if ($.strict_equals(typeof document, "undefined", false)) {
					const viewChangeEvent = new CustomEvent("viewchange", { detail: { mode: "all" }, bubbles: true });

					document.dispatchEvent(viewChangeEvent);
				}
			}
		} catch(error) {
			console.error(...$.log_if_contains_state('error', "Error loading options:", error));
			$.get(uiState).isLoading = false;
			$.get(uiState).error = error instanceof Error ? error.message : "Unknown error loading options";
			$.set(optionsData, [], true);
		}
	}

	function setSortMethod(method) {
		$.get(uiState).sortMethod = method;
	}

	function setReversalFilter(_filter) {}

	function setLastSelectedTabForSort(sortMethod, tabKey) {
		if ($.strict_equals($.get(uiState).lastSelectedTab[sortMethod], tabKey)) {
			return;
		}

		$.get(uiState).lastSelectedTab = { ...$.get(uiState).lastSelectedTab, [sortMethod]: tabKey };
	}

	async function selectOption(option) {
		$.set(selectedPictograph, option, true);

		if ($.strict_equals(typeof document, "undefined", false)) {
			const beatAddedEvent = new CustomEvent("beat-added", { detail: { beat: option }, bubbles: true });

			document.dispatchEvent(beatAddedEvent);

			const optionSelectedEvent = new CustomEvent("option-selected", { detail: { option }, bubbles: true });

			document.dispatchEvent(optionSelectedEvent);
		}
	}

	function reset() {
		$.set(optionsData, [], true);
		$.set(sequenceData, [], true);

		const currentSortMethod = $.get(uiState).sortMethod || "type";

		$.set(
			uiState,
			{
				sortMethod: currentSortMethod,
				isLoading: false,
				error: null,
				lastSelectedTab: $.get(uiState).lastSelectedTab || {}
			},
			true
		);

		setLastSelectedTabForSort(currentSortMethod, "all");
		$.set(selectedPictograph, null);
	}

	function setLoading(loading) {
		$.get(uiState).isLoading = loading;
	}

	function setError(error) {
		$.get(uiState).error = error;
	}

	return {
		// ✅ FIXED: Use getters that access the state directly for reactivity
		get optionsData() {
			return $.get(optionsData);
		},

		get sequenceData() {
			return $.get(sequenceData);
		},

		get selectedPictograph() {
			return $.get(selectedPictograph);
		},

		get filteredOptions() {
			return $.get(filteredOptions)();
		},

		get groupedOptions() {
			return computeGroupedOptions();
		},

		get categoryKeys() {
			return $.get(categoryKeys)();
		},

		// ✅ Keep getters for backward compatibility, but prefer direct access above
		get sequence() {
			return $.get(sequenceData);
		},

		get allOptions() {
			return $.get(optionsData);
		},

		get isLoading() {
			return $.get(uiState).isLoading;
		},

		get error() {
			return $.get(uiState).error;
		},

		get sortMethod() {
			return $.get(uiState).sortMethod;
		},

		get lastSelectedTab() {
			return $.get(uiState).lastSelectedTab;
		},

		// Actions
		loadOptions,

		setSortMethod,
		setReversalFilter,
		setLastSelectedTabForSort,
		selectOption,
		reset,
		setLoading,
		setError,

		// Direct state setters (for advanced use)
		setSequence: (seq) => {
			$.set(sequenceData, seq, true);
		},

		setOptions: (opts) => {
			$.set(optionsData, opts, true);
		},

		setSelectedPictograph: (opt) => {
			$.set(selectedPictograph, opt, true);
		}
	};
}
//# sourceMappingURL=data:application/json;base64,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YUFBYTtnQkFDUixTQUFRO0VBQ2pCOztNQUNJLGtCQUFrQjtnQkFDYixTQUFRO0VBQ2pCOzs7RUFHQTs7RUFDQTtFQUNBO0VBQ0E7RUFDQTtFQUNBO0VBQ0E7RUFDQTs7O0VBR0EsY0FBYyxRQUEwQjtTQUN0QyxjQUFlO0VBQ2pCOztFQUNBLGFBQWEsU0FBMkI7U0FDdEMsYUFBYztFQUNoQjs7RUFDQSx3QkFBd0IsUUFBK0I7U0FDckQsb0JBQXFCO0VBQ3ZCOztBQUVKIiwibmFtZXMiOltdLCJpZ25vcmVMaXN0IjpbXSwic291cmNlcyI6WyJvcHRpb25QaWNrZXJSdW5lcy5zdmVsdGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBTb3BoaXN0aWNhdGVkIE9wdGlvbiBQaWNrZXIgU3RhdGUgdXNpbmcgT05MWSBTdmVsdGUgNSBSdW5lc1xuICpcbiAqIENvbXBsZXRlIHBvcnQgb2YgdGhlIGxlZ2FjeSBzeXN0ZW0gd2l0aCBhZHZhbmNlZCBmZWF0dXJlcyB1c2luZyBwdXJlIHJ1bmVzOlxuICogLSBBZHZhbmNlZCBzdGF0ZSBtYW5hZ2VtZW50XG4gKiAtIFNvcGhpc3RpY2F0ZWQgZmlsdGVyaW5nIGFuZCBncm91cGluZ1xuICogLSBSZWFsIG9wdGlvbiBkYXRhIHNlcnZpY2UgaW50ZWdyYXRpb25cbiAqIC0gUGVyZm9ybWFuY2Ugb3B0aW1pemF0aW9uc1xuICogLSBDb21wbGV4IHJlYWN0aXZlIHN0YXRlIGRlcml2YXRpb25zXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBQaWN0b2dyYXBoRGF0YSB9IGZyb20gXCIkbGliL2RvbWFpbi9QaWN0b2dyYXBoRGF0YVwiO1xuaW1wb3J0IHsgcmVzb2x2ZSB9IGZyb20gXCIkc2VydmljZXMvYm9vdHN0cmFwXCI7XG5pbXBvcnQgeyBjcmVhdGVCZWF0RGF0YSB9IGZyb20gXCIkbGliL2RvbWFpbi9CZWF0RGF0YVwiO1xuaW1wb3J0IHR5cGUgeyBSZXZlcnNhbEZpbHRlciwgU29ydE1ldGhvZCB9IGZyb20gXCIuL2NvbmZpZ1wiO1xuaW1wb3J0IHtcbiAgZGV0ZXJtaW5lR3JvdXBLZXksXG4gIGdldFNvcnRlZEdyb3VwS2V5cyxcbiAgZ2V0U29ydGVyLFxufSBmcm9tIFwiLi9zZXJ2aWNlcy9PcHRpb25zU2VydmljZVwiO1xuaW1wb3J0IHsgR3JpZE1vZGUgfSBmcm9tIFwiJGxpYi9kb21haW5cIjtcblxuLy8gPT09PT0gVHlwZXMgPT09PT1cbmV4cG9ydCB0eXBlIExhc3RTZWxlY3RlZFRhYlN0YXRlID0gUGFydGlhbDxSZWNvcmQ8U29ydE1ldGhvZCwgc3RyaW5nIHwgbnVsbD4+O1xuXG5pbnRlcmZhY2UgVUlTdGF0ZSB7XG4gIHNvcnRNZXRob2Q6IFNvcnRNZXRob2Q7XG4gIGlzTG9hZGluZzogYm9vbGVhbjtcbiAgZXJyb3I6IHN0cmluZyB8IG51bGw7XG4gIGxhc3RTZWxlY3RlZFRhYjogTGFzdFNlbGVjdGVkVGFiU3RhdGU7XG59XG5cbi8vID09PT09IEhlbHBlciBGdW5jdGlvbnMgPT09PT1cbmZ1bmN0aW9uIGdldFN0b3JlZFN0YXRlKCk6IFVJU3RhdGUge1xuICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gXCJ1bmRlZmluZWRcIilcbiAgICByZXR1cm4ge1xuICAgICAgc29ydE1ldGhvZDogXCJ0eXBlXCIsXG4gICAgICBpc0xvYWRpbmc6IGZhbHNlLFxuICAgICAgZXJyb3I6IG51bGwsXG4gICAgICBsYXN0U2VsZWN0ZWRUYWI6IHt9LFxuICAgIH07XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBzdG9yZWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcIm9wdGlvblBpY2tlclVJU3RhdGVcIik7XG5cbiAgICBpZiAoIXN0b3JlZClcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHNvcnRNZXRob2Q6IFwidHlwZVwiLFxuICAgICAgICBpc0xvYWRpbmc6IGZhbHNlLFxuICAgICAgICBlcnJvcjogbnVsbCxcbiAgICAgICAgbGFzdFNlbGVjdGVkVGFiOiB7IHR5cGU6IFwiYWxsXCIgfSxcbiAgICAgIH07XG5cbiAgICBjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKHN0b3JlZCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc29ydE1ldGhvZDogcGFyc2VkLnNvcnRNZXRob2QgfHwgXCJ0eXBlXCIsXG4gICAgICBpc0xvYWRpbmc6IGZhbHNlLFxuICAgICAgZXJyb3I6IG51bGwsXG4gICAgICBsYXN0U2VsZWN0ZWRUYWI6IHBhcnNlZC5sYXN0U2VsZWN0ZWRUYWIgfHwgeyB0eXBlOiBcImFsbFwiIH0sXG4gICAgfTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciByZWFkaW5nIGZyb20gbG9jYWxTdG9yYWdlOlwiLCBlKTtcbiAgICByZXR1cm4ge1xuICAgICAgc29ydE1ldGhvZDogXCJ0eXBlXCIsXG4gICAgICBpc0xvYWRpbmc6IGZhbHNlLFxuICAgICAgZXJyb3I6IG51bGwsXG4gICAgICBsYXN0U2VsZWN0ZWRUYWI6IHsgdHlwZTogXCJhbGxcIiB9LFxuICAgIH07XG4gIH1cbn1cblxuLyoqXG4gKiBDcmVhdGUgc29waGlzdGljYXRlZCBvcHRpb24gcGlja2VyIHN0YXRlIHVzaW5nIE9OTFkgU3ZlbHRlIDUgcnVuZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZU9wdGlvblBpY2tlclJ1bmVzKCkge1xuICAvLyA9PT09PSBDb3JlIFN0YXRlIFVzaW5nIFJ1bmVzID09PT09XG4gIGxldCBzZXF1ZW5jZURhdGEgPSAkc3RhdGU8UGljdG9ncmFwaERhdGFbXT4oW10pO1xuICBsZXQgb3B0aW9uc0RhdGEgPSAkc3RhdGU8UGljdG9ncmFwaERhdGFbXT4oW10pO1xuICBsZXQgc2VsZWN0ZWRQaWN0b2dyYXBoID0gJHN0YXRlPFBpY3RvZ3JhcGhEYXRhIHwgbnVsbD4obnVsbCk7XG5cbiAgLy8gPT09PT0gVUkgU3RhdGUgVXNpbmcgUnVuZXMgPT09PT1cbiAgY29uc3Qgc3RvcmVkU3RhdGUgPSBnZXRTdG9yZWRTdGF0ZSgpO1xuICBsZXQgdWlTdGF0ZSA9ICRzdGF0ZTxVSVN0YXRlPih7XG4gICAgc29ydE1ldGhvZDogc3RvcmVkU3RhdGUuc29ydE1ldGhvZCxcbiAgICBpc0xvYWRpbmc6IHN0b3JlZFN0YXRlLmlzTG9hZGluZyxcbiAgICBlcnJvcjogc3RvcmVkU3RhdGUuZXJyb3IsXG4gICAgbGFzdFNlbGVjdGVkVGFiOiBzdG9yZWRTdGF0ZS5sYXN0U2VsZWN0ZWRUYWIsXG4gIH0pO1xuXG4gIC8vID09PT09IERlcml2ZWQgU3RhdGUgVXNpbmcgUnVuZXMgPT09PT1cblxuICAvLyBGaWx0ZXJlZCBhbmQgc29ydGVkIG9wdGlvbnNcbiAgY29uc3QgZmlsdGVyZWRPcHRpb25zID0gJGRlcml2ZWQoKCkgPT4ge1xuICAgIGNvbnN0IG9wdGlvbnMgPSBbLi4ub3B0aW9uc0RhdGFdO1xuICAgIG9wdGlvbnMuc29ydChnZXRTb3J0ZXIodWlTdGF0ZS5zb3J0TWV0aG9kLCBzZXF1ZW5jZURhdGEpKTtcbiAgICByZXR1cm4gb3B0aW9ucztcbiAgfSk7XG5cbiAgLy8gU2ltcGxpZmllZCBncm91cGVkIG9wdGlvbnMgLSBjb21wdXRlIG9ubHkgd2hlbiBleHBsaWNpdGx5IG5lZWRlZFxuICBsZXQgY2FjaGVkR3JvdXBlZE9wdGlvbnMgPSAkc3RhdGU8UmVjb3JkPHN0cmluZywgUGljdG9ncmFwaERhdGFbXT4+KHt9KTtcblxuICBmdW5jdGlvbiBjb21wdXRlR3JvdXBlZE9wdGlvbnMoKTogUmVjb3JkPHN0cmluZywgUGljdG9ncmFwaERhdGFbXT4ge1xuICAgIGNvbnN0IGdyb3VwczogUmVjb3JkPHN0cmluZywgUGljdG9ncmFwaERhdGFbXT4gPSB7fTtcbiAgICBjb25zdCBvcHRpb25zID0gZmlsdGVyZWRPcHRpb25zKCk7XG4gICAgb3B0aW9ucy5mb3JFYWNoKChvcHRpb24pID0+IHtcbiAgICAgIGNvbnN0IGdyb3VwS2V5ID0gZGV0ZXJtaW5lR3JvdXBLZXkoXG4gICAgICAgIG9wdGlvbixcbiAgICAgICAgdWlTdGF0ZS5zb3J0TWV0aG9kLFxuICAgICAgICBzZXF1ZW5jZURhdGFcbiAgICAgICk7XG4gICAgICBpZiAoIWdyb3Vwc1tncm91cEtleV0pIGdyb3Vwc1tncm91cEtleV0gPSBbXTtcbiAgICAgIGdyb3Vwc1tncm91cEtleV0ucHVzaChvcHRpb24pO1xuICAgIH0pO1xuXG4gICAgY29uc3Qgc29ydGVkS2V5cyA9IGdldFNvcnRlZEdyb3VwS2V5cyhcbiAgICAgIE9iamVjdC5rZXlzKGdyb3VwcyksXG4gICAgICB1aVN0YXRlLnNvcnRNZXRob2RcbiAgICApO1xuICAgIGNvbnN0IHNvcnRlZEdyb3VwczogUmVjb3JkPHN0cmluZywgUGljdG9ncmFwaERhdGFbXT4gPSB7fTtcbiAgICBzb3J0ZWRLZXlzLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgaWYgKGdyb3Vwc1trZXldKSB7XG4gICAgICAgIHNvcnRlZEdyb3Vwc1trZXldID0gZ3JvdXBzW2tleV07XG4gICAgICB9XG4gICAgfSk7XG4gICAgY2FjaGVkR3JvdXBlZE9wdGlvbnMgPSBzb3J0ZWRHcm91cHM7XG4gICAgcmV0dXJuIHNvcnRlZEdyb3VwcztcbiAgfVxuXG4gIC8vIENhdGVnb3J5IGtleXMgYXZhaWxhYmxlIC0gc2ltcGxpZmllZFxuICBjb25zdCBjYXRlZ29yeUtleXMgPSAkZGVyaXZlZCgoKSA9PiBPYmplY3Qua2V5cyhjYWNoZWRHcm91cGVkT3B0aW9ucykpO1xuXG4gIC8vID09PT09IFN0YXRlIFBlcnNpc3RlbmNlIEVmZmVjdCA9PT09PVxuICAvLyBEaXNhYmxlIGF1dG9tYXRpYyBzdGF0ZSBwZXJzaXN0ZW5jZSB0byBwcmV2ZW50IHJlYWN0aXZlIGNhc2NhZGVzXG4gIC8vIE9ubHkgc2F2ZSBzdGF0ZSBvbiBleHBsaWNpdCB1c2VyIGFjdGlvbnNcbiAgLy8gJGVmZmVjdCgoKSA9PiB7XG4gIC8vICAgLy8gU2F2ZSBzdGF0ZSBjaGFuZ2VzIHRvIGxvY2FsU3RvcmFnZVxuICAvLyAgIHNhdmVTdGF0ZVRvTG9jYWxTdG9yYWdlKHVpU3RhdGUpO1xuICAvLyB9KTtcblxuICAvLyA9PT09PSBBY3Rpb25zID09PT09XG4gIGFzeW5jIGZ1bmN0aW9uIGxvYWRPcHRpb25zKHNlcXVlbmNlOiBQaWN0b2dyYXBoRGF0YVtdKSB7XG4gICAgc2VxdWVuY2VEYXRhID0gc2VxdWVuY2U7XG5cbiAgICAvLyAqKkNoZWNrIGZvciBwcmVsb2FkZWQgb3B0aW9ucyBmaXJzdCB0byBhdm9pZCBsb2FkaW5nIHN0YXRlKipcbiAgICB0cnkge1xuICAgICAgLy8gRmlyc3QgY2hlY2sgZm9yIHNwZWNpZmljIHByZWxvYWRlZCBvcHRpb25zIChmcm9tIGluZGl2aWR1YWwgY2xpY2tzKVxuICAgICAgY29uc3QgcHJlbG9hZGVkRGF0YSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFwicHJlbG9hZGVkX29wdGlvbnNcIik7XG4gICAgICBpZiAocHJlbG9hZGVkRGF0YSkge1xuICAgICAgICBjb25zdCBwcmVsb2FkZWRPcHRpb25zID0gSlNPTi5wYXJzZShwcmVsb2FkZWREYXRhKTtcbiAgICAgICAgb3B0aW9uc0RhdGEgPSBwcmVsb2FkZWRPcHRpb25zIHx8IFtdO1xuICAgICAgICB1aVN0YXRlLmlzTG9hZGluZyA9IGZhbHNlO1xuICAgICAgICB1aVN0YXRlLmVycm9yID0gbnVsbDtcblxuICAgICAgICAvLyBDbGVhciBwcmVsb2FkZWQgZGF0YSBzbyBpdCdzIG9ubHkgdXNlZCBvbmNlXG4gICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFwicHJlbG9hZGVkX29wdGlvbnNcIik7XG5cbiAgICAgICAgLy8gU2V0IGRlZmF1bHQgdGFiIGlmIG5lZWRlZFxuICAgICAgICBpZiAoXG4gICAgICAgICAgIXVpU3RhdGUubGFzdFNlbGVjdGVkVGFiW3VpU3RhdGUuc29ydE1ldGhvZF0gfHxcbiAgICAgICAgICB1aVN0YXRlLmxhc3RTZWxlY3RlZFRhYlt1aVN0YXRlLnNvcnRNZXRob2RdID09PSBudWxsXG4gICAgICAgICkge1xuICAgICAgICAgIHNldExhc3RTZWxlY3RlZFRhYkZvclNvcnQodWlTdGF0ZS5zb3J0TWV0aG9kLCBcImFsbFwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybjsgLy8gU2tpcCB0aGUgbG9hZGluZyBwcm9jZXNzXG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGZvciBidWxrIHByZWxvYWRlZCBvcHRpb25zIChmcm9tIGNvbXBvbmVudCBsb2FkKVxuICAgICAgY29uc3QgYWxsUHJlbG9hZGVkRGF0YSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFwiYWxsX3ByZWxvYWRlZF9vcHRpb25zXCIpO1xuICAgICAgaWYgKGFsbFByZWxvYWRlZERhdGEpIHtcbiAgICAgICAgY29uc3QgYWxsUHJlbG9hZGVkT3B0aW9ucyA9IEpTT04ucGFyc2UoYWxsUHJlbG9hZGVkRGF0YSk7XG5cbiAgICAgICAgLy8gRGV0ZXJtaW5lIHRoZSBjdXJyZW50IGVuZCBwb3NpdGlvbiB3ZSBuZWVkIG9wdGlvbnMgZm9yXG4gICAgICAgIGxldCB0YXJnZXRFbmRQb3NpdGlvbjogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgICAgICAgaWYgKHNlcXVlbmNlICYmIHNlcXVlbmNlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBjb25zdCBsYXN0QmVhdCA9IHNlcXVlbmNlW3NlcXVlbmNlLmxlbmd0aCAtIDFdO1xuICAgICAgICAgIGNvbnN0IGVuZFBvc2l0aW9uID1cbiAgICAgICAgICAgIGxhc3RCZWF0Py5lbmRQb3NpdGlvbiB8fCBsYXN0QmVhdD8ubWV0YWRhdGE/LmVuZFBvc2l0aW9uO1xuICAgICAgICAgIHRhcmdldEVuZFBvc2l0aW9uID1cbiAgICAgICAgICAgIHR5cGVvZiBlbmRQb3NpdGlvbiA9PT0gXCJzdHJpbmdcIiA/IGVuZFBvc2l0aW9uIDogbnVsbDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBGb3IgZW1wdHkgc2VxdWVuY2UsIGdldCBmcm9tIHN0YXJ0IHBvc2l0aW9uXG4gICAgICAgICAgY29uc3Qgc3RhcnRQb3NpdGlvbkRhdGEgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcInN0YXJ0UG9zaXRpb25cIik7XG4gICAgICAgICAgaWYgKHN0YXJ0UG9zaXRpb25EYXRhKSB7XG4gICAgICAgICAgICBjb25zdCBzdGFydFBvc2l0aW9uID0gSlNPTi5wYXJzZShzdGFydFBvc2l0aW9uRGF0YSk7XG4gICAgICAgICAgICB0YXJnZXRFbmRQb3NpdGlvbiA9IHN0YXJ0UG9zaXRpb24uZW5kUG9zaXRpb24gfHwgbnVsbDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBJZiB3ZSBoYXZlIHByZWxvYWRlZCBvcHRpb25zIGZvciB0aGlzIGVuZCBwb3NpdGlvbiwgdXNlIHRoZW1cbiAgICAgICAgaWYgKHRhcmdldEVuZFBvc2l0aW9uICYmIGFsbFByZWxvYWRlZE9wdGlvbnNbdGFyZ2V0RW5kUG9zaXRpb25dKSB7XG4gICAgICAgICAgY29uc3Qgb3B0aW9uc0ZvclBvc2l0aW9uID0gYWxsUHJlbG9hZGVkT3B0aW9uc1t0YXJnZXRFbmRQb3NpdGlvbl07XG4gICAgICAgICAgb3B0aW9uc0RhdGEgPSBvcHRpb25zRm9yUG9zaXRpb24gfHwgW107XG4gICAgICAgICAgdWlTdGF0ZS5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgICB1aVN0YXRlLmVycm9yID0gbnVsbDtcblxuICAgICAgICAgIC8vIFNldCBkZWZhdWx0IHRhYiBpZiBuZWVkZWRcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAhdWlTdGF0ZS5sYXN0U2VsZWN0ZWRUYWJbdWlTdGF0ZS5zb3J0TWV0aG9kXSB8fFxuICAgICAgICAgICAgdWlTdGF0ZS5sYXN0U2VsZWN0ZWRUYWJbdWlTdGF0ZS5zb3J0TWV0aG9kXSA9PT0gbnVsbFxuICAgICAgICAgICkge1xuICAgICAgICAgICAgc2V0TGFzdFNlbGVjdGVkVGFiRm9yU29ydCh1aVN0YXRlLnNvcnRNZXRob2QsIFwiYWxsXCIpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybjsgLy8gU2tpcCB0aGUgbG9hZGluZyBwcm9jZXNzXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICBcIkZhaWxlZCB0byBsb2FkIHByZWxvYWRlZCBvcHRpb25zLCBmYWxsaW5nIGJhY2sgdG8gbm9ybWFsIGxvYWRpbmc6XCIsXG4gICAgICAgIGVycm9yXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIE5vcm1hbCBsb2FkaW5nIHByb2Nlc3MgKG9ubHkgaWYgbm8gcHJlbG9hZGVkIG9wdGlvbnMpXG4gICAgdWlTdGF0ZS5pc0xvYWRpbmcgPSB0cnVlO1xuICAgIHVpU3RhdGUuZXJyb3IgPSBudWxsO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEV4dHJhY3QgZW5kIHBvc2l0aW9uIGZyb20gc2VxdWVuY2UgZm9yIHRoZSByZWFsIE9wdGlvbkRhdGFTZXJ2aWNlXG4gICAgICBsZXQgbmV4dE9wdGlvbnM6IFBpY3RvZ3JhcGhEYXRhW10gPSBbXTtcblxuICAgICAgaWYgKHNlcXVlbmNlICYmIHNlcXVlbmNlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgbGFzdEJlYXQgPSBzZXF1ZW5jZVtzZXF1ZW5jZS5sZW5ndGggLSAxXTtcbiAgICAgICAgY29uc3QgZW5kUG9zaXRpb24gPVxuICAgICAgICAgIGxhc3RCZWF0Py5lbmRQb3NpdGlvbiB8fCBsYXN0QmVhdD8ubWV0YWRhdGE/LmVuZFBvc2l0aW9uO1xuXG4gICAgICAgIGlmIChlbmRQb3NpdGlvbiAmJiB0eXBlb2YgZW5kUG9zaXRpb24gPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAvLyBHZXQgdGhlIG9wdGlvbiBkYXRhIHNlcnZpY2UgdGhyb3VnaCBESVxuICAgICAgICAgIGNvbnN0IG9wdGlvbkRhdGFTZXJ2aWNlID0gcmVzb2x2ZShcIklPcHRpb25EYXRhU2VydmljZVwiKSBhcyB7XG4gICAgICAgICAgICBnZXROZXh0T3B0aW9ucyhzZXF1ZW5jZTogdW5rbm93bltdKTogUHJvbWlzZTxQaWN0b2dyYXBoRGF0YVtdPjtcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgLy8gQ3JlYXRlIGEgbWluaW1hbCBzZXF1ZW5jZSB3aXRoIGEgYmVhdCB0aGF0IGhhcyB0aGUgZW5kIHBvc2l0aW9uXG4gICAgICAgICAgY29uc3QgbWluaW1hbFNlcXVlbmNlID0gW1xuICAgICAgICAgICAgY3JlYXRlQmVhdERhdGEoe1xuICAgICAgICAgICAgICBiZWF0TnVtYmVyOiAxLFxuICAgICAgICAgICAgICBtZXRhZGF0YTogeyBlbmRQb3NpdGlvbjogZW5kUG9zaXRpb24gfSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIF07XG5cbiAgICAgICAgICBuZXh0T3B0aW9ucyA9IGF3YWl0IG9wdGlvbkRhdGFTZXJ2aWNlLmdldE5leHRPcHRpb25zKG1pbmltYWxTZXF1ZW5jZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKFwiTm8gZW5kIHBvc2l0aW9uIGZvdW5kIGluIHNlcXVlbmNlXCIpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBGb3IgZW1wdHkgc2VxdWVuY2UsIHRyeSB0byBnZXQgc3RhcnQgcG9zaXRpb24gZnJvbSBsb2NhbFN0b3JhZ2VcbiAgICAgICAgY29uc3Qgc3RhcnRQb3NpdGlvbkRhdGEgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcInN0YXJ0UG9zaXRpb25cIik7XG4gICAgICAgIGlmIChzdGFydFBvc2l0aW9uRGF0YSkge1xuICAgICAgICAgIGNvbnN0IHN0YXJ0UG9zaXRpb24gPSBKU09OLnBhcnNlKHN0YXJ0UG9zaXRpb25EYXRhKTtcbiAgICAgICAgICBjb25zdCBlbmRQb3NpdGlvbiA9XG4gICAgICAgICAgICB0eXBlb2Ygc3RhcnRQb3NpdGlvbi5lbmRQb3NpdGlvbiA9PT0gXCJzdHJpbmdcIlxuICAgICAgICAgICAgICA/IHN0YXJ0UG9zaXRpb24uZW5kUG9zaXRpb25cbiAgICAgICAgICAgICAgOiBudWxsO1xuICAgICAgICAgIGlmIChlbmRQb3NpdGlvbikge1xuICAgICAgICAgICAgLy8gR2V0IHRoZSBMZXR0ZXJRdWVyeVNlcnZpY2UgdGhyb3VnaCBESVxuICAgICAgICAgICAgY29uc3QgeyBJTGV0dGVyUXVlcnlTZXJ2aWNlSW50ZXJmYWNlIH0gPSBhd2FpdCBpbXBvcnQoXG4gICAgICAgICAgICAgIFwiJGxpYi9zZXJ2aWNlcy9kaS9pbnRlcmZhY2VzL2NvZGV4LWludGVyZmFjZXNcIlxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGNvbnN0IGxldHRlclF1ZXJ5U2VydmljZSA9IHJlc29sdmUoSUxldHRlclF1ZXJ5U2VydmljZUludGVyZmFjZSk7XG5cbiAgICAgICAgICAgIC8vIEZvciBub3csIGdldCBhbGwgcGljdG9ncmFwaHMgLSBvcHRpb24gZmlsdGVyaW5nIGxvZ2ljIHdvdWxkIG5lZWQgdG8gYmUgaW1wbGVtZW50ZWRcbiAgICAgICAgICAgIG5leHRPcHRpb25zID0gYXdhaXQgbGV0dGVyUXVlcnlTZXJ2aWNlLmdldEFsbENvZGV4UGljdG9ncmFwaHMoXG4gICAgICAgICAgICAgIEdyaWRNb2RlLkRJQU1PTkRcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIElmIHdlIGdvdCBubyBvcHRpb25zLCBsb2cgYSB3YXJuaW5nIGJ1dCBkb24ndCB0cmVhdCBpdCBhcyBhbiBlcnJvclxuICAgICAgaWYgKCFuZXh0T3B0aW9ucyB8fCBuZXh0T3B0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgY29uc29sZS53YXJuKFwiTm8gb3B0aW9ucyBhdmFpbGFibGUgZm9yIHRoZSBjdXJyZW50IHNlcXVlbmNlXCIpO1xuICAgICAgfVxuXG4gICAgICBvcHRpb25zRGF0YSA9IG5leHRPcHRpb25zIHx8IFtdO1xuICAgICAgdWlTdGF0ZS5pc0xvYWRpbmcgPSBmYWxzZTtcblxuICAgICAgLy8gT25seSBzZXQgZGVmYXVsdCB0YWIgaWYgd2UgZG9uJ3QgaGF2ZSBhIHNlbGVjdGVkIHRhYiB5ZXRcbiAgICAgIGlmIChcbiAgICAgICAgIXVpU3RhdGUubGFzdFNlbGVjdGVkVGFiW3VpU3RhdGUuc29ydE1ldGhvZF0gfHxcbiAgICAgICAgdWlTdGF0ZS5sYXN0U2VsZWN0ZWRUYWJbdWlTdGF0ZS5zb3J0TWV0aG9kXSA9PT0gbnVsbFxuICAgICAgKSB7XG4gICAgICAgIHNldExhc3RTZWxlY3RlZFRhYkZvclNvcnQodWlTdGF0ZS5zb3J0TWV0aG9kLCBcImFsbFwiKTtcblxuICAgICAgICBpZiAodHlwZW9mIGRvY3VtZW50ICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgICAgY29uc3Qgdmlld0NoYW5nZUV2ZW50ID0gbmV3IEN1c3RvbUV2ZW50KFwidmlld2NoYW5nZVwiLCB7XG4gICAgICAgICAgICBkZXRhaWw6IHsgbW9kZTogXCJhbGxcIiB9LFxuICAgICAgICAgICAgYnViYmxlczogdHJ1ZSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KHZpZXdDaGFuZ2VFdmVudCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGxvYWRpbmcgb3B0aW9uczpcIiwgZXJyb3IpO1xuICAgICAgdWlTdGF0ZS5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICAgIHVpU3RhdGUuZXJyb3IgPVxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yXG4gICAgICAgICAgPyBlcnJvci5tZXNzYWdlXG4gICAgICAgICAgOiBcIlVua25vd24gZXJyb3IgbG9hZGluZyBvcHRpb25zXCI7XG4gICAgICBvcHRpb25zRGF0YSA9IFtdO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIHNldFNvcnRNZXRob2QobWV0aG9kOiBTb3J0TWV0aG9kKSB7XG4gICAgdWlTdGF0ZS5zb3J0TWV0aG9kID0gbWV0aG9kO1xuICB9XG5cbiAgZnVuY3Rpb24gc2V0UmV2ZXJzYWxGaWx0ZXIoX2ZpbHRlcjogUmV2ZXJzYWxGaWx0ZXIpIHtcbiAgICAvLyBOb3RlOiBSZXZlcnNhbEZpbHRlciB3b3VsZCBuZWVkIHRvIGJlIGFkZGVkIHRvIFVJU3RhdGUgaWYgbmVlZGVkXG4gIH1cblxuICBmdW5jdGlvbiBzZXRMYXN0U2VsZWN0ZWRUYWJGb3JTb3J0KFxuICAgIHNvcnRNZXRob2Q6IFNvcnRNZXRob2QsXG4gICAgdGFiS2V5OiBzdHJpbmcgfCBudWxsXG4gICkge1xuICAgIC8vIEF2b2lkIHVubmVjZXNzYXJ5IHVwZGF0ZXMgaWYgdGhlIHZhbHVlIGhhc24ndCBjaGFuZ2VkXG4gICAgaWYgKHVpU3RhdGUubGFzdFNlbGVjdGVkVGFiW3NvcnRNZXRob2RdID09PSB0YWJLZXkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB1aVN0YXRlLmxhc3RTZWxlY3RlZFRhYiA9IHtcbiAgICAgIC4uLnVpU3RhdGUubGFzdFNlbGVjdGVkVGFiLFxuICAgICAgW3NvcnRNZXRob2RdOiB0YWJLZXksXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIHNlbGVjdE9wdGlvbihvcHRpb246IFBpY3RvZ3JhcGhEYXRhKSB7XG4gICAgLy8gVXBkYXRlIHNlbGVjdGVkIHBpY3RvZ3JhcGhcbiAgICBzZWxlY3RlZFBpY3RvZ3JhcGggPSBvcHRpb247XG5cbiAgICAvLyBEaXNwYXRjaCBjdXN0b20gZXZlbnRzXG4gICAgaWYgKHR5cGVvZiBkb2N1bWVudCAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgY29uc3QgYmVhdEFkZGVkRXZlbnQgPSBuZXcgQ3VzdG9tRXZlbnQoXCJiZWF0LWFkZGVkXCIsIHtcbiAgICAgICAgZGV0YWlsOiB7IGJlYXQ6IG9wdGlvbiB9LFxuICAgICAgICBidWJibGVzOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KGJlYXRBZGRlZEV2ZW50KTtcblxuICAgICAgY29uc3Qgb3B0aW9uU2VsZWN0ZWRFdmVudCA9IG5ldyBDdXN0b21FdmVudChcIm9wdGlvbi1zZWxlY3RlZFwiLCB7XG4gICAgICAgIGRldGFpbDogeyBvcHRpb24gfSxcbiAgICAgICAgYnViYmxlczogdHJ1ZSxcbiAgICAgIH0pO1xuICAgICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudChvcHRpb25TZWxlY3RlZEV2ZW50KTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiByZXNldCgpIHtcbiAgICBvcHRpb25zRGF0YSA9IFtdO1xuICAgIHNlcXVlbmNlRGF0YSA9IFtdO1xuXG4gICAgLy8gUHJlc2VydmUgdXNlciBwcmVmZXJlbmNlc1xuICAgIGNvbnN0IGN1cnJlbnRTb3J0TWV0aG9kID0gdWlTdGF0ZS5zb3J0TWV0aG9kIHx8IFwidHlwZVwiO1xuICAgIHVpU3RhdGUgPSB7XG4gICAgICBzb3J0TWV0aG9kOiBjdXJyZW50U29ydE1ldGhvZCxcbiAgICAgIGlzTG9hZGluZzogZmFsc2UsXG4gICAgICBlcnJvcjogbnVsbCxcbiAgICAgIGxhc3RTZWxlY3RlZFRhYjogdWlTdGF0ZS5sYXN0U2VsZWN0ZWRUYWIgfHwge30sXG4gICAgfTtcblxuICAgIC8vIEVuc3VyZSAnYWxsJyBpcyBzZXQgYXMgdGhlIGRlZmF1bHQgdGFiIGZvciB0aGUgY3VycmVudCBzb3J0IG1ldGhvZFxuICAgIHNldExhc3RTZWxlY3RlZFRhYkZvclNvcnQoY3VycmVudFNvcnRNZXRob2QsIFwiYWxsXCIpO1xuICAgIHNlbGVjdGVkUGljdG9ncmFwaCA9IG51bGw7XG4gIH1cblxuICBmdW5jdGlvbiBzZXRMb2FkaW5nKGxvYWRpbmc6IGJvb2xlYW4pIHtcbiAgICB1aVN0YXRlLmlzTG9hZGluZyA9IGxvYWRpbmc7XG4gIH1cblxuICBmdW5jdGlvbiBzZXRFcnJvcihlcnJvcjogc3RyaW5nIHwgbnVsbCkge1xuICAgIHVpU3RhdGUuZXJyb3IgPSBlcnJvcjtcbiAgfVxuXG4gIC8vID09PT09IFJldHVybiBSZWFjdGl2ZSBJbnRlcmZhY2UgPT09PT1cbiAgcmV0dXJuIHtcbiAgICAvLyDinIUgRklYRUQ6IFVzZSBnZXR0ZXJzIHRoYXQgYWNjZXNzIHRoZSBzdGF0ZSBkaXJlY3RseSBmb3IgcmVhY3Rpdml0eVxuICAgIGdldCBvcHRpb25zRGF0YSgpIHtcbiAgICAgIHJldHVybiBvcHRpb25zRGF0YTtcbiAgICB9LFxuICAgIGdldCBzZXF1ZW5jZURhdGEoKSB7XG4gICAgICByZXR1cm4gc2VxdWVuY2VEYXRhO1xuICAgIH0sXG4gICAgZ2V0IHNlbGVjdGVkUGljdG9ncmFwaCgpIHtcbiAgICAgIHJldHVybiBzZWxlY3RlZFBpY3RvZ3JhcGg7XG4gICAgfSxcbiAgICBnZXQgZmlsdGVyZWRPcHRpb25zKCkge1xuICAgICAgcmV0dXJuIGZpbHRlcmVkT3B0aW9ucygpO1xuICAgIH0sXG4gICAgZ2V0IGdyb3VwZWRPcHRpb25zKCkge1xuICAgICAgcmV0dXJuIGNvbXB1dGVHcm91cGVkT3B0aW9ucygpO1xuICAgIH0sXG4gICAgZ2V0IGNhdGVnb3J5S2V5cygpIHtcbiAgICAgIHJldHVybiBjYXRlZ29yeUtleXMoKTtcbiAgICB9LFxuXG4gICAgLy8g4pyFIEtlZXAgZ2V0dGVycyBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgYnV0IHByZWZlciBkaXJlY3QgYWNjZXNzIGFib3ZlXG4gICAgZ2V0IHNlcXVlbmNlKCkge1xuICAgICAgcmV0dXJuIHNlcXVlbmNlRGF0YTtcbiAgICB9LFxuICAgIGdldCBhbGxPcHRpb25zKCkge1xuICAgICAgcmV0dXJuIG9wdGlvbnNEYXRhO1xuICAgIH0sXG4gICAgZ2V0IGlzTG9hZGluZygpIHtcbiAgICAgIHJldHVybiB1aVN0YXRlLmlzTG9hZGluZztcbiAgICB9LFxuICAgIGdldCBlcnJvcigpIHtcbiAgICAgIHJldHVybiB1aVN0YXRlLmVycm9yO1xuICAgIH0sXG4gICAgZ2V0IHNvcnRNZXRob2QoKSB7XG4gICAgICByZXR1cm4gdWlTdGF0ZS5zb3J0TWV0aG9kO1xuICAgIH0sXG4gICAgZ2V0IGxhc3RTZWxlY3RlZFRhYigpIHtcbiAgICAgIHJldHVybiB1aVN0YXRlLmxhc3RTZWxlY3RlZFRhYjtcbiAgICB9LFxuXG4gICAgLy8gQWN0aW9uc1xuICAgIGxvYWRPcHRpb25zLFxuICAgIHNldFNvcnRNZXRob2QsXG4gICAgc2V0UmV2ZXJzYWxGaWx0ZXIsXG4gICAgc2V0TGFzdFNlbGVjdGVkVGFiRm9yU29ydCxcbiAgICBzZWxlY3RPcHRpb24sXG4gICAgcmVzZXQsXG4gICAgc2V0TG9hZGluZyxcbiAgICBzZXRFcnJvcixcblxuICAgIC8vIERpcmVjdCBzdGF0ZSBzZXR0ZXJzIChmb3IgYWR2YW5jZWQgdXNlKVxuICAgIHNldFNlcXVlbmNlOiAoc2VxOiBQaWN0b2dyYXBoRGF0YVtdKSA9PiB7XG4gICAgICBzZXF1ZW5jZURhdGEgPSBzZXE7XG4gICAgfSxcbiAgICBzZXRPcHRpb25zOiAob3B0czogUGljdG9ncmFwaERhdGFbXSkgPT4ge1xuICAgICAgb3B0aW9uc0RhdGEgPSBvcHRzO1xuICAgIH0sXG4gICAgc2V0U2VsZWN0ZWRQaWN0b2dyYXBoOiAob3B0OiBQaWN0b2dyYXBoRGF0YSB8IG51bGwpID0+IHtcbiAgICAgIHNlbGVjdGVkUGljdG9ncmFwaCA9IG9wdDtcbiAgICB9LFxuICB9O1xufVxuLyoqXG4gKiBUeXBlIGZvciB0aGUgb3B0aW9uIHBpY2tlciBydW5lcyBpbnN0YW5jZVxuICovXG5leHBvcnQgdHlwZSBPcHRpb25QaWNrZXJSdW5lcyA9IFJldHVyblR5cGU8dHlwZW9mIGNyZWF0ZU9wdGlvblBpY2tlclJ1bmVzPjtcbiJdLCJmaWxlIjoiRjovQ09ERS9US0Evd2ViL3NyYy9saWIvY29tcG9uZW50cy9jb25zdHJ1Y3Qvb3B0aW9uLXBpY2tlci9vcHRpb25QaWNrZXJSdW5lcy5zdmVsdGUudHMifQ==