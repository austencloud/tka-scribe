import {
  GridMode,
  MotionType,
  RotationDirection,
  Location,
  Orientation
} from "/src/lib/domain/enums.ts";
import { PngMetadataExtractor } from "/src/lib/utils/png-metadata-extractor.ts";
export class SequenceService {
  constructor(sequenceDomainService, persistenceService) {
    this.sequenceDomainService = sequenceDomainService;
    this.persistenceService = persistenceService;
  }
  /**
   * Create a new sequence
   */
  async createSequence(request) {
    try {
      const sequence = this.sequenceDomainService.createSequence(request);
      await this.persistenceService.saveSequence(sequence);
      return sequence;
    } catch (error) {
      console.error("Failed to create sequence:", error);
      throw new Error(
        `Failed to create sequence: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Update a beat in a sequence
   */
  async updateBeat(sequenceId, beatIndex, beatData) {
    try {
      const currentSequence = await this.persistenceService.loadSequence(sequenceId);
      if (!currentSequence) {
        throw new Error(`Sequence ${sequenceId} not found`);
      }
      const updatedSequence = this.sequenceDomainService.updateBeat(
        currentSequence,
        beatIndex,
        beatData
      );
      await this.persistenceService.saveSequence(updatedSequence);
    } catch (error) {
      console.error("Failed to update beat:", error);
      throw new Error(
        `Failed to update beat: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Set the start position for a sequence
   */
  async setSequenceStartPosition(sequenceId, startPosition) {
    try {
      const currentSequence = await this.persistenceService.loadSequence(sequenceId);
      if (!currentSequence) {
        throw new Error(`Sequence ${sequenceId} not found`);
      }
      const updatedSequence = {
        ...currentSequence,
        startPosition
      };
      await this.persistenceService.saveSequence(updatedSequence);
    } catch (error) {
      console.error("Failed to set start position:", error);
      throw new Error(
        `Failed to set start position: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Delete a sequence
   */
  async deleteSequence(id) {
    try {
      await this.persistenceService.deleteSequence(id);
    } catch (error) {
      console.error("Failed to delete sequence:", error);
      throw new Error(
        `Failed to delete sequence: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Get a sequence by ID
   */
  async getSequence(id) {
    try {
      let sequence = await this.persistenceService.loadSequence(id);
      if (!sequence) {
        console.log(
          `ðŸŽ¬ Sequence ${id} not found, attempting to load from PNG metadata`
        );
        try {
          sequence = await this.loadSequenceFromPNG(id);
          if (sequence) {
            await this.persistenceService.saveSequence(sequence);
          }
        } catch (error) {
          console.error(`Failed to load sequence ${id} from PNG:`, error);
          return null;
        }
      }
      return sequence;
    } catch (error) {
      console.error(`Failed to get sequence ${id}:`, error);
      return null;
    }
  }
  /**
   * Get all sequences
   */
  async getAllSequences() {
    try {
      return await this.persistenceService.loadAllSequences();
    } catch (error) {
      console.error("Failed to get all sequences:", error);
      return [];
    }
  }
  /**
   * Add a beat to a sequence
   */
  async addBeat(sequenceId, beatData) {
    try {
      const sequence = await this.getSequence(sequenceId);
      if (!sequence) {
        throw new Error(`Sequence ${sequenceId} not found`);
      }
      const nextBeatNumber = sequence.beats.length + 1;
      const newBeat = {
        id: crypto.randomUUID(),
        beatNumber: nextBeatNumber,
        duration: 1,
        blueReversal: false,
        redReversal: false,
        isBlank: true,
        pictographData: null,
        metadata: {},
        ...beatData
      };
      const updatedSequence = {
        ...sequence,
        beats: [...sequence.beats, newBeat]
      };
      await this.persistenceService.saveSequence(updatedSequence);
    } catch (error) {
      console.error("Failed to add beat:", error);
      throw new Error(
        `Failed to add beat: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Remove a beat from a sequence
   */
  async removeBeat(sequenceId, beatIndex) {
    try {
      const sequence = await this.getSequence(sequenceId);
      if (!sequence) {
        throw new Error(`Sequence ${sequenceId} not found`);
      }
      if (beatIndex < 0 || beatIndex >= sequence.beats.length) {
        throw new Error(`Beat index ${beatIndex} is out of range`);
      }
      const newBeats = sequence.beats.filter((_, index) => index !== beatIndex).map((beat, index) => ({ ...beat, beatNumber: index + 1 }));
      const updatedSequence = { ...sequence, beats: newBeats };
      await this.persistenceService.saveSequence(updatedSequence);
    } catch (error) {
      console.error("Failed to remove beat:", error);
      throw new Error(
        `Failed to remove beat: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Load sequence from PNG metadata using the reliable PNG metadata extractor
   */
  async loadSequenceFromPNG(id) {
    console.log(`ðŸŽ¬ Loading sequence from PNG metadata for ID: ${id}`);
    try {
      const pngMetadata = await PngMetadataExtractor.extractSequenceMetadata(
        id.toUpperCase()
      );
      if (!pngMetadata || pngMetadata.length === 0) {
        console.error(`No metadata found in PNG for sequence: ${id}`);
        return null;
      }
      const sequence = await this.convertPngMetadataToSequence(id, pngMetadata);
      console.log(`âœ… Loaded real sequence data from PNG for ${id}`);
      return sequence;
    } catch (error) {
      console.error(`Failed to load PNG metadata for ${id}:`, error);
      return this.createTestSequence(id);
    }
  }
  /**
   * Convert PNG metadata to SequenceData format
   */
  async convertPngMetadataToSequence(id, pngMetadata) {
    console.log(`ðŸ”„ Converting standalone data to web app format for ${id}`);
    const meta = pngMetadata[0];
    const steps = pngMetadata.slice(1);
    const beats = steps.filter((step) => typeof step.beat === "number" && step.beat > 0).map((step) => ({
      id: `${step.beat}-${step.letter}`,
      beatNumber: step.beat,
      duration: 1,
      blueReversal: false,
      redReversal: false,
      isBlank: false,
      pictographData: {
        id: `pictograph-${step.beat}`,
        gridData: {
          gridMode: meta.gridMode || GridMode.DIAMOND,
          center_x: 0,
          center_y: 0,
          radius: 100,
          gridPoints: {}
        },
        arrows: {},
        props: {},
        motions: {
          blue: {
            motionType: step.blueAttributes?.motionType || MotionType.STATIC,
            startLocation: step.blueAttributes?.startLocation || Location.SOUTH,
            endLocation: step.blueAttributes?.endLocation || Location.SOUTH,
            startOrientation: step.blueAttributes?.startOrientation || Orientation.IN,
            endOrientation: step.blueAttributes?.endOrientation,
            // Don't set default - let it be undefined
            rotationDirection: step.blueAttributes?.rotationDirection || RotationDirection.NO_ROTATION,
            turns: step.blueAttributes?.turns || 0,
            isVisible: true
          },
          red: {
            motionType: step.redAttributes?.motionType || MotionType.STATIC,
            startLocation: step.redAttributes?.startLocation || Location.SOUTH,
            endLocation: step.redAttributes?.endLocation || Location.SOUTH,
            startOrientation: step.redAttributes?.startOrientation || Orientation.IN,
            endOrientation: step.redAttributes?.endOrientation,
            // Don't set default - let it be undefined
            rotationDirection: step.redAttributes?.rotationDirection || RotationDirection.NO_ROTATION,
            turns: step.redAttributes?.turns || 0,
            isVisible: true
          }
        },
        letter: step.letter || "",
        beat: step.beat,
        isBlank: false,
        isMirrored: false,
        metadata: {}
      },
      metadata: {}
    }));
    console.log(`âœ… Converted to web app format: ${beats.length} beats`);
    return {
      id,
      name: meta.word || id.toUpperCase(),
      word: meta.word || id.toUpperCase(),
      beats,
      thumbnails: [`${id.toUpperCase()}_ver1.png`],
      sequence_length: beats.length,
      author: meta.author || "Unknown",
      level: meta.level || 1,
      date_added: new Date(meta.date_added || Date.now()),
      gridMode: meta.gridMode || "diamond",
      propType: meta.propType || "unknown",
      is_favorite: meta.is_favorite || false,
      is_circular: meta.is_circular || false,
      starting_position: meta.sequence_start_position || "beta",
      difficulty_level: this.mapLevelToDifficulty(meta.level || 1),
      tags: ["flow", "practice"],
      metadata: {
        source: "png_metadata",
        extracted_at: (/* @__PURE__ */ new Date()).toISOString(),
        ...meta
      }
    };
  }
  /**
   * Map numeric level to difficulty string
   */
  mapLevelToDifficulty(level) {
    if (level <= 1) return "beginner";
    if (level <= 2) return "intermediate";
    return "advanced";
  }
  /**
   * Load sequence from PNG metadata or create fallback
   */
  async createTestSequence(id) {
    console.log(`ðŸŽ¬ Loading sequence from PNG metadata for ID: ${id}`);
    try {
      const sequenceData = await this.loadSequenceFromPNG(id);
      if (sequenceData) {
        console.log(`âœ… Loaded real sequence data from PNG for ${id}`);
        return sequenceData;
      }
    } catch (error) {
      console.warn(`âš ï¸ Failed to load PNG metadata for ${id}:`, error);
    }
    throw new Error(
      `No PNG metadata found for sequence ${id}. Please ensure the sequence has a valid PNG thumbnail with embedded metadata.`
    );
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNlcXVlbmNlU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFNlcXVlbmNlIFNlcnZpY2UgLSBBcHBsaWNhdGlvbiBMYXllclxuICpcbiAqIENvb3JkaW5hdGVzIGJldHdlZW4gZG9tYWluIGxvZ2ljIGFuZCBwZXJzaXN0ZW5jZSBmb3Igc2VxdWVuY2Ugb3BlcmF0aW9ucy5cbiAqIFRoaXMgc2VydmljZSBvcmNoZXN0cmF0ZXMgdGhlIGJ1c2luZXNzIHdvcmtmbG93cyBmb3Igc2VxdWVuY2UgbWFuYWdlbWVudC5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7IEJlYXREYXRhLCBTZXF1ZW5jZURhdGEgfSBmcm9tIFwiJGxpYi9kb21haW5cIjtcbmltcG9ydCB7XG4gIEdyaWRNb2RlLFxuICBNb3Rpb25UeXBlLFxuICBSb3RhdGlvbkRpcmVjdGlvbixcbiAgTG9jYXRpb24sXG4gIE9yaWVudGF0aW9uLFxufSBmcm9tIFwiJGxpYi9kb21haW4vZW51bXNcIjtcblxuaW1wb3J0IHsgUG5nTWV0YWRhdGFFeHRyYWN0b3IgfSBmcm9tIFwiJGxpYi91dGlscy9wbmctbWV0YWRhdGEtZXh0cmFjdG9yXCI7XG5pbXBvcnQgdHlwZSB7XG4gIElQZXJzaXN0ZW5jZVNlcnZpY2UsXG4gIElTZXF1ZW5jZURvbWFpblNlcnZpY2UsXG4gIElTZXF1ZW5jZVNlcnZpY2UsXG4gIFNlcXVlbmNlQ3JlYXRlUmVxdWVzdCxcbn0gZnJvbSBcIi4uLy4uL2ludGVyZmFjZXMvc2VxdWVuY2UtaW50ZXJmYWNlc1wiO1xuXG5leHBvcnQgY2xhc3MgU2VxdWVuY2VTZXJ2aWNlIGltcGxlbWVudHMgSVNlcXVlbmNlU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgc2VxdWVuY2VEb21haW5TZXJ2aWNlOiBJU2VxdWVuY2VEb21haW5TZXJ2aWNlLFxuICAgIHByaXZhdGUgcGVyc2lzdGVuY2VTZXJ2aWNlOiBJUGVyc2lzdGVuY2VTZXJ2aWNlXG4gICkge31cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IHNlcXVlbmNlXG4gICAqL1xuICBhc3luYyBjcmVhdGVTZXF1ZW5jZShyZXF1ZXN0OiBTZXF1ZW5jZUNyZWF0ZVJlcXVlc3QpOiBQcm9taXNlPFNlcXVlbmNlRGF0YT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBVc2UgZG9tYWluIHNlcnZpY2UgdG8gY3JlYXRlIHRoZSBzZXF1ZW5jZVxuICAgICAgY29uc3Qgc2VxdWVuY2UgPSB0aGlzLnNlcXVlbmNlRG9tYWluU2VydmljZS5jcmVhdGVTZXF1ZW5jZShyZXF1ZXN0KTtcbiAgICAgIGF3YWl0IHRoaXMucGVyc2lzdGVuY2VTZXJ2aWNlLnNhdmVTZXF1ZW5jZShzZXF1ZW5jZSk7XG4gICAgICByZXR1cm4gc2VxdWVuY2U7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJGYWlsZWQgdG8gY3JlYXRlIHNlcXVlbmNlOlwiLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gY3JlYXRlIHNlcXVlbmNlOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCJ9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIGEgYmVhdCBpbiBhIHNlcXVlbmNlXG4gICAqL1xuICBhc3luYyB1cGRhdGVCZWF0KFxuICAgIHNlcXVlbmNlSWQ6IHN0cmluZyxcbiAgICBiZWF0SW5kZXg6IG51bWJlcixcbiAgICBiZWF0RGF0YTogQmVhdERhdGFcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIExvYWQgdGhlIGN1cnJlbnQgc2VxdWVuY2VcbiAgICAgIGNvbnN0IGN1cnJlbnRTZXF1ZW5jZSA9XG4gICAgICAgIGF3YWl0IHRoaXMucGVyc2lzdGVuY2VTZXJ2aWNlLmxvYWRTZXF1ZW5jZShzZXF1ZW5jZUlkKTtcbiAgICAgIGlmICghY3VycmVudFNlcXVlbmNlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgU2VxdWVuY2UgJHtzZXF1ZW5jZUlkfSBub3QgZm91bmRgKTtcbiAgICAgIH1cblxuICAgICAgLy8gVXNlIGRvbWFpbiBzZXJ2aWNlIHRvIHVwZGF0ZSB0aGUgYmVhdFxuICAgICAgY29uc3QgdXBkYXRlZFNlcXVlbmNlID0gdGhpcy5zZXF1ZW5jZURvbWFpblNlcnZpY2UudXBkYXRlQmVhdChcbiAgICAgICAgY3VycmVudFNlcXVlbmNlLFxuICAgICAgICBiZWF0SW5kZXgsXG4gICAgICAgIGJlYXREYXRhXG4gICAgICApO1xuXG4gICAgICBhd2FpdCB0aGlzLnBlcnNpc3RlbmNlU2VydmljZS5zYXZlU2VxdWVuY2UodXBkYXRlZFNlcXVlbmNlKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byB1cGRhdGUgYmVhdDpcIiwgZXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIHVwZGF0ZSBiZWF0OiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCJ9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSBzdGFydCBwb3NpdGlvbiBmb3IgYSBzZXF1ZW5jZVxuICAgKi9cbiAgYXN5bmMgc2V0U2VxdWVuY2VTdGFydFBvc2l0aW9uKFxuICAgIHNlcXVlbmNlSWQ6IHN0cmluZyxcbiAgICBzdGFydFBvc2l0aW9uOiBCZWF0RGF0YVxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgLy8gTG9hZCB0aGUgY3VycmVudCBzZXF1ZW5jZVxuICAgICAgY29uc3QgY3VycmVudFNlcXVlbmNlID1cbiAgICAgICAgYXdhaXQgdGhpcy5wZXJzaXN0ZW5jZVNlcnZpY2UubG9hZFNlcXVlbmNlKHNlcXVlbmNlSWQpO1xuICAgICAgaWYgKCFjdXJyZW50U2VxdWVuY2UpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTZXF1ZW5jZSAke3NlcXVlbmNlSWR9IG5vdCBmb3VuZGApO1xuICAgICAgfVxuXG4gICAgICAvLyBVcGRhdGUgdGhlIHNlcXVlbmNlIHdpdGggdGhlIHN0YXJ0IHBvc2l0aW9uXG4gICAgICBjb25zdCB1cGRhdGVkU2VxdWVuY2UgPSB7XG4gICAgICAgIC4uLmN1cnJlbnRTZXF1ZW5jZSxcbiAgICAgICAgc3RhcnRQb3NpdGlvbjogc3RhcnRQb3NpdGlvbixcbiAgICAgIH0gYXMgU2VxdWVuY2VEYXRhO1xuXG4gICAgICBhd2FpdCB0aGlzLnBlcnNpc3RlbmNlU2VydmljZS5zYXZlU2VxdWVuY2UodXBkYXRlZFNlcXVlbmNlKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihcIkZhaWxlZCB0byBzZXQgc3RhcnQgcG9zaXRpb246XCIsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byBzZXQgc3RhcnQgcG9zaXRpb246ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBcIlVua25vd24gZXJyb3JcIn1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGUgYSBzZXF1ZW5jZVxuICAgKi9cbiAgYXN5bmMgZGVsZXRlU2VxdWVuY2UoaWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnBlcnNpc3RlbmNlU2VydmljZS5kZWxldGVTZXF1ZW5jZShpZCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJGYWlsZWQgdG8gZGVsZXRlIHNlcXVlbmNlOlwiLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gZGVsZXRlIHNlcXVlbmNlOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCJ9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGEgc2VxdWVuY2UgYnkgSURcbiAgICovXG4gIGFzeW5jIGdldFNlcXVlbmNlKGlkOiBzdHJpbmcpOiBQcm9taXNlPFNlcXVlbmNlRGF0YSB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgbGV0IHNlcXVlbmNlID0gYXdhaXQgdGhpcy5wZXJzaXN0ZW5jZVNlcnZpY2UubG9hZFNlcXVlbmNlKGlkKTtcblxuICAgICAgLy8gSWYgc2VxdWVuY2Ugbm90IGZvdW5kLCB0cnkgdG8gbG9hZCBmcm9tIFBORyBtZXRhZGF0YVxuICAgICAgaWYgKCFzZXF1ZW5jZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBg8J+OrCBTZXF1ZW5jZSAke2lkfSBub3QgZm91bmQsIGF0dGVtcHRpbmcgdG8gbG9hZCBmcm9tIFBORyBtZXRhZGF0YWBcbiAgICAgICAgKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBzZXF1ZW5jZSA9IGF3YWl0IHRoaXMubG9hZFNlcXVlbmNlRnJvbVBORyhpZCk7XG4gICAgICAgICAgLy8gU2F2ZSBpdCB0byBsb2NhbFN0b3JhZ2UgZm9yIGZ1dHVyZSB1c2VcbiAgICAgICAgICBpZiAoc2VxdWVuY2UpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucGVyc2lzdGVuY2VTZXJ2aWNlLnNhdmVTZXF1ZW5jZShzZXF1ZW5jZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBsb2FkIHNlcXVlbmNlICR7aWR9IGZyb20gUE5HOmAsIGVycm9yKTtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gc2VxdWVuY2U7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBnZXQgc2VxdWVuY2UgJHtpZH06YCwgZXJyb3IpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbGwgc2VxdWVuY2VzXG4gICAqL1xuICBhc3luYyBnZXRBbGxTZXF1ZW5jZXMoKTogUHJvbWlzZTxTZXF1ZW5jZURhdGFbXT4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wZXJzaXN0ZW5jZVNlcnZpY2UubG9hZEFsbFNlcXVlbmNlcygpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIGdldCBhbGwgc2VxdWVuY2VzOlwiLCBlcnJvcik7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIGJlYXQgdG8gYSBzZXF1ZW5jZVxuICAgKi9cbiAgYXN5bmMgYWRkQmVhdChcbiAgICBzZXF1ZW5jZUlkOiBzdHJpbmcsXG4gICAgYmVhdERhdGE/OiBQYXJ0aWFsPEJlYXREYXRhPlxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2VxdWVuY2UgPSBhd2FpdCB0aGlzLmdldFNlcXVlbmNlKHNlcXVlbmNlSWQpO1xuICAgICAgaWYgKCFzZXF1ZW5jZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFNlcXVlbmNlICR7c2VxdWVuY2VJZH0gbm90IGZvdW5kYCk7XG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSBuZXcgYmVhdCB3aXRoIG5leHQgYmVhdCBudW1iZXJcbiAgICAgIGNvbnN0IG5leHRCZWF0TnVtYmVyID0gc2VxdWVuY2UuYmVhdHMubGVuZ3RoICsgMTtcbiAgICAgIGNvbnN0IG5ld0JlYXQ6IEJlYXREYXRhID0ge1xuICAgICAgICBpZDogY3J5cHRvLnJhbmRvbVVVSUQoKSxcbiAgICAgICAgYmVhdE51bWJlcjogbmV4dEJlYXROdW1iZXIsXG4gICAgICAgIGR1cmF0aW9uOiAxLjAsXG4gICAgICAgIGJsdWVSZXZlcnNhbDogZmFsc2UsXG4gICAgICAgIHJlZFJldmVyc2FsOiBmYWxzZSxcbiAgICAgICAgaXNCbGFuazogdHJ1ZSxcbiAgICAgICAgcGljdG9ncmFwaERhdGE6IG51bGwsXG4gICAgICAgIG1ldGFkYXRhOiB7fSxcbiAgICAgICAgLi4uYmVhdERhdGEsXG4gICAgICB9O1xuICAgICAgY29uc3QgdXBkYXRlZFNlcXVlbmNlID0ge1xuICAgICAgICAuLi5zZXF1ZW5jZSxcbiAgICAgICAgYmVhdHM6IFsuLi5zZXF1ZW5jZS5iZWF0cywgbmV3QmVhdF0sXG4gICAgICB9IGFzIFNlcXVlbmNlRGF0YTtcbiAgICAgIGF3YWl0IHRoaXMucGVyc2lzdGVuY2VTZXJ2aWNlLnNhdmVTZXF1ZW5jZSh1cGRhdGVkU2VxdWVuY2UpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIGFkZCBiZWF0OlwiLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gYWRkIGJlYXQ6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBcIlVua25vd24gZXJyb3JcIn1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgYSBiZWF0IGZyb20gYSBzZXF1ZW5jZVxuICAgKi9cbiAgYXN5bmMgcmVtb3ZlQmVhdChzZXF1ZW5jZUlkOiBzdHJpbmcsIGJlYXRJbmRleDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNlcXVlbmNlID0gYXdhaXQgdGhpcy5nZXRTZXF1ZW5jZShzZXF1ZW5jZUlkKTtcbiAgICAgIGlmICghc2VxdWVuY2UpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTZXF1ZW5jZSAke3NlcXVlbmNlSWR9IG5vdCBmb3VuZGApO1xuICAgICAgfVxuXG4gICAgICBpZiAoYmVhdEluZGV4IDwgMCB8fCBiZWF0SW5kZXggPj0gc2VxdWVuY2UuYmVhdHMubGVuZ3RoKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQmVhdCBpbmRleCAke2JlYXRJbmRleH0gaXMgb3V0IG9mIHJhbmdlYCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFJlbW92ZSB0aGUgYmVhdCBhbmQgcmVudW1iZXIgcmVtYWluaW5nIGJlYXRzXG4gICAgICBjb25zdCBuZXdCZWF0cyA9IHNlcXVlbmNlLmJlYXRzXG4gICAgICAgIC5maWx0ZXIoKF8sIGluZGV4KSA9PiBpbmRleCAhPT0gYmVhdEluZGV4KVxuICAgICAgICAubWFwKChiZWF0LCBpbmRleCkgPT4gKHsgLi4uYmVhdCwgYmVhdE51bWJlcjogaW5kZXggKyAxIH0pKTtcbiAgICAgIGNvbnN0IHVwZGF0ZWRTZXF1ZW5jZSA9IHsgLi4uc2VxdWVuY2UsIGJlYXRzOiBuZXdCZWF0cyB9IGFzIFNlcXVlbmNlRGF0YTtcbiAgICAgIGF3YWl0IHRoaXMucGVyc2lzdGVuY2VTZXJ2aWNlLnNhdmVTZXF1ZW5jZSh1cGRhdGVkU2VxdWVuY2UpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIHJlbW92ZSBiZWF0OlwiLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gcmVtb3ZlIGJlYXQ6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBcIlVua25vd24gZXJyb3JcIn1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBMb2FkIHNlcXVlbmNlIGZyb20gUE5HIG1ldGFkYXRhIHVzaW5nIHRoZSByZWxpYWJsZSBQTkcgbWV0YWRhdGEgZXh0cmFjdG9yXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGxvYWRTZXF1ZW5jZUZyb21QTkcoaWQ6IHN0cmluZyk6IFByb21pc2U8U2VxdWVuY2VEYXRhIHwgbnVsbD4ge1xuICAgIGNvbnNvbGUubG9nKGDwn46sIExvYWRpbmcgc2VxdWVuY2UgZnJvbSBQTkcgbWV0YWRhdGEgZm9yIElEOiAke2lkfWApO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEV4dHJhY3QgbWV0YWRhdGEgZnJvbSBQTkcgZmlsZSB1c2luZyB0aGUgcmVsaWFibGUgZXh0cmFjdG9yXG4gICAgICBjb25zdCBwbmdNZXRhZGF0YSA9IGF3YWl0IFBuZ01ldGFkYXRhRXh0cmFjdG9yLmV4dHJhY3RTZXF1ZW5jZU1ldGFkYXRhKFxuICAgICAgICBpZC50b1VwcGVyQ2FzZSgpXG4gICAgICApO1xuXG4gICAgICBpZiAoIXBuZ01ldGFkYXRhIHx8IHBuZ01ldGFkYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBObyBtZXRhZGF0YSBmb3VuZCBpbiBQTkcgZm9yIHNlcXVlbmNlOiAke2lkfWApO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgLy8gQ29udmVydCBQTkcgbWV0YWRhdGEgdG8gd2ViIGFwcCBmb3JtYXRcbiAgICAgIGNvbnN0IHNlcXVlbmNlID0gYXdhaXQgdGhpcy5jb252ZXJ0UG5nTWV0YWRhdGFUb1NlcXVlbmNlKGlkLCBwbmdNZXRhZGF0YSk7XG4gICAgICBjb25zb2xlLmxvZyhg4pyFIExvYWRlZCByZWFsIHNlcXVlbmNlIGRhdGEgZnJvbSBQTkcgZm9yICR7aWR9YCk7XG4gICAgICByZXR1cm4gc2VxdWVuY2U7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBsb2FkIFBORyBtZXRhZGF0YSBmb3IgJHtpZH06YCwgZXJyb3IpO1xuICAgICAgLy8gRmFsbGJhY2sgdG8gdGVzdCBzZXF1ZW5jZVxuICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlVGVzdFNlcXVlbmNlKGlkKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydCBQTkcgbWV0YWRhdGEgdG8gU2VxdWVuY2VEYXRhIGZvcm1hdFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBjb252ZXJ0UG5nTWV0YWRhdGFUb1NlcXVlbmNlKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcG5nTWV0YWRhdGE6IHVua25vd25bXVxuICApOiBQcm9taXNlPFNlcXVlbmNlRGF0YT4ge1xuICAgIGNvbnNvbGUubG9nKGDwn5SEIENvbnZlcnRpbmcgc3RhbmRhbG9uZSBkYXRhIHRvIHdlYiBhcHAgZm9ybWF0IGZvciAke2lkfWApO1xuXG4gICAgLy8gRXh0cmFjdCBtZXRhZGF0YSBmcm9tIGZpcnN0IGVsZW1lbnRcbiAgICBjb25zdCBtZXRhID0gcG5nTWV0YWRhdGFbMF0gYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG4gICAgY29uc3Qgc3RlcHMgPSBwbmdNZXRhZGF0YS5zbGljZSgxKSBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPltdOyAvLyBTa2lwIG1ldGFkYXRhLCBnZXQgYWN0dWFsIHN0ZXBzXG5cbiAgICAvLyBDb252ZXJ0IHN0ZXBzIHRvIGJlYXRzXG4gICAgY29uc3QgYmVhdHM6IEJlYXREYXRhW10gPSBzdGVwc1xuICAgICAgLmZpbHRlcigoc3RlcCkgPT4gdHlwZW9mIHN0ZXAuYmVhdCA9PT0gXCJudW1iZXJcIiAmJiBzdGVwLmJlYXQgPiAwKSAvLyBPbmx5IGFjdHVhbCBiZWF0cywgbm90IHN0YXJ0IHN0YXRlXG4gICAgICAubWFwKChzdGVwKSA9PiAoe1xuICAgICAgICBpZDogYCR7c3RlcC5iZWF0fS0ke3N0ZXAubGV0dGVyfWAsXG4gICAgICAgIGJlYXROdW1iZXI6IHN0ZXAuYmVhdCBhcyBudW1iZXIsXG4gICAgICAgIGR1cmF0aW9uOiAxLFxuICAgICAgICBibHVlUmV2ZXJzYWw6IGZhbHNlLFxuICAgICAgICByZWRSZXZlcnNhbDogZmFsc2UsXG4gICAgICAgIGlzQmxhbms6IGZhbHNlLFxuICAgICAgICBwaWN0b2dyYXBoRGF0YToge1xuICAgICAgICAgIGlkOiBgcGljdG9ncmFwaC0ke3N0ZXAuYmVhdH1gLFxuICAgICAgICAgIGdyaWREYXRhOiB7XG4gICAgICAgICAgICBncmlkTW9kZTogKG1ldGEuZ3JpZE1vZGUgYXMgR3JpZE1vZGUpIHx8IEdyaWRNb2RlLkRJQU1PTkQsXG4gICAgICAgICAgICBjZW50ZXJfeDogMCxcbiAgICAgICAgICAgIGNlbnRlcl95OiAwLFxuICAgICAgICAgICAgcmFkaXVzOiAxMDAsXG4gICAgICAgICAgICBncmlkUG9pbnRzOiB7fSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGFycm93czoge30sXG4gICAgICAgICAgcHJvcHM6IHt9LFxuICAgICAgICAgIG1vdGlvbnM6IHtcbiAgICAgICAgICAgIGJsdWU6IHtcbiAgICAgICAgICAgICAgbW90aW9uVHlwZTpcbiAgICAgICAgICAgICAgICAoKHN0ZXAuYmx1ZUF0dHJpYnV0ZXMgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pXG4gICAgICAgICAgICAgICAgICA/Lm1vdGlvblR5cGUgYXMgTW90aW9uVHlwZSkgfHwgTW90aW9uVHlwZS5TVEFUSUMsXG4gICAgICAgICAgICAgIHN0YXJ0TG9jYXRpb246XG4gICAgICAgICAgICAgICAgKChzdGVwLmJsdWVBdHRyaWJ1dGVzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KVxuICAgICAgICAgICAgICAgICAgPy5zdGFydExvY2F0aW9uIGFzIExvY2F0aW9uKSB8fCBMb2NhdGlvbi5TT1VUSCxcbiAgICAgICAgICAgICAgZW5kTG9jYXRpb246XG4gICAgICAgICAgICAgICAgKChzdGVwLmJsdWVBdHRyaWJ1dGVzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KVxuICAgICAgICAgICAgICAgICAgPy5lbmRMb2NhdGlvbiBhcyBMb2NhdGlvbikgfHwgTG9jYXRpb24uU09VVEgsXG4gICAgICAgICAgICAgIHN0YXJ0T3JpZW50YXRpb246XG4gICAgICAgICAgICAgICAgKChzdGVwLmJsdWVBdHRyaWJ1dGVzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KVxuICAgICAgICAgICAgICAgICAgPy5zdGFydE9yaWVudGF0aW9uIGFzIE9yaWVudGF0aW9uKSB8fCBPcmllbnRhdGlvbi5JTixcbiAgICAgICAgICAgICAgZW5kT3JpZW50YXRpb246IChzdGVwLmJsdWVBdHRyaWJ1dGVzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KVxuICAgICAgICAgICAgICAgID8uZW5kT3JpZW50YXRpb24gYXMgT3JpZW50YXRpb24sIC8vIERvbid0IHNldCBkZWZhdWx0IC0gbGV0IGl0IGJlIHVuZGVmaW5lZFxuICAgICAgICAgICAgICByb3RhdGlvbkRpcmVjdGlvbjpcbiAgICAgICAgICAgICAgICAoKHN0ZXAuYmx1ZUF0dHJpYnV0ZXMgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pXG4gICAgICAgICAgICAgICAgICA/LnJvdGF0aW9uRGlyZWN0aW9uIGFzIFJvdGF0aW9uRGlyZWN0aW9uKSB8fFxuICAgICAgICAgICAgICAgIFJvdGF0aW9uRGlyZWN0aW9uLk5PX1JPVEFUSU9OLFxuICAgICAgICAgICAgICB0dXJuczpcbiAgICAgICAgICAgICAgICAoKHN0ZXAuYmx1ZUF0dHJpYnV0ZXMgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pXG4gICAgICAgICAgICAgICAgICA/LnR1cm5zIGFzIG51bWJlcikgfHwgMCxcbiAgICAgICAgICAgICAgaXNWaXNpYmxlOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHJlZDoge1xuICAgICAgICAgICAgICBtb3Rpb25UeXBlOlxuICAgICAgICAgICAgICAgICgoc3RlcC5yZWRBdHRyaWJ1dGVzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KVxuICAgICAgICAgICAgICAgICAgPy5tb3Rpb25UeXBlIGFzIE1vdGlvblR5cGUpIHx8IE1vdGlvblR5cGUuU1RBVElDLFxuICAgICAgICAgICAgICBzdGFydExvY2F0aW9uOlxuICAgICAgICAgICAgICAgICgoc3RlcC5yZWRBdHRyaWJ1dGVzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KVxuICAgICAgICAgICAgICAgICAgPy5zdGFydExvY2F0aW9uIGFzIExvY2F0aW9uKSB8fCBMb2NhdGlvbi5TT1VUSCxcbiAgICAgICAgICAgICAgZW5kTG9jYXRpb246XG4gICAgICAgICAgICAgICAgKChzdGVwLnJlZEF0dHJpYnV0ZXMgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pXG4gICAgICAgICAgICAgICAgICA/LmVuZExvY2F0aW9uIGFzIExvY2F0aW9uKSB8fCBMb2NhdGlvbi5TT1VUSCxcbiAgICAgICAgICAgICAgc3RhcnRPcmllbnRhdGlvbjpcbiAgICAgICAgICAgICAgICAoKHN0ZXAucmVkQXR0cmlidXRlcyBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPilcbiAgICAgICAgICAgICAgICAgID8uc3RhcnRPcmllbnRhdGlvbiBhcyBPcmllbnRhdGlvbikgfHwgT3JpZW50YXRpb24uSU4sXG4gICAgICAgICAgICAgIGVuZE9yaWVudGF0aW9uOiAoc3RlcC5yZWRBdHRyaWJ1dGVzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KVxuICAgICAgICAgICAgICAgID8uZW5kT3JpZW50YXRpb24gYXMgT3JpZW50YXRpb24sIC8vIERvbid0IHNldCBkZWZhdWx0IC0gbGV0IGl0IGJlIHVuZGVmaW5lZFxuICAgICAgICAgICAgICByb3RhdGlvbkRpcmVjdGlvbjpcbiAgICAgICAgICAgICAgICAoKHN0ZXAucmVkQXR0cmlidXRlcyBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPilcbiAgICAgICAgICAgICAgICAgID8ucm90YXRpb25EaXJlY3Rpb24gYXMgUm90YXRpb25EaXJlY3Rpb24pIHx8XG4gICAgICAgICAgICAgICAgUm90YXRpb25EaXJlY3Rpb24uTk9fUk9UQVRJT04sXG4gICAgICAgICAgICAgIHR1cm5zOlxuICAgICAgICAgICAgICAgICgoc3RlcC5yZWRBdHRyaWJ1dGVzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KVxuICAgICAgICAgICAgICAgICAgPy50dXJucyBhcyBudW1iZXIpIHx8IDAsXG4gICAgICAgICAgICAgIGlzVmlzaWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBsZXR0ZXI6IChzdGVwLmxldHRlciBhcyBzdHJpbmcpIHx8IFwiXCIsXG4gICAgICAgICAgYmVhdDogc3RlcC5iZWF0IGFzIG51bWJlcixcbiAgICAgICAgICBpc0JsYW5rOiBmYWxzZSxcbiAgICAgICAgICBpc01pcnJvcmVkOiBmYWxzZSxcbiAgICAgICAgICBtZXRhZGF0YToge30sXG4gICAgICAgIH0sXG4gICAgICAgIG1ldGFkYXRhOiB7fSxcbiAgICAgIH0pKTtcblxuICAgIGNvbnNvbGUubG9nKGDinIUgQ29udmVydGVkIHRvIHdlYiBhcHAgZm9ybWF0OiAke2JlYXRzLmxlbmd0aH0gYmVhdHNgKTtcblxuICAgIHJldHVybiB7XG4gICAgICBpZCxcbiAgICAgIG5hbWU6IChtZXRhLndvcmQgYXMgc3RyaW5nKSB8fCBpZC50b1VwcGVyQ2FzZSgpLFxuICAgICAgd29yZDogKG1ldGEud29yZCBhcyBzdHJpbmcpIHx8IGlkLnRvVXBwZXJDYXNlKCksXG4gICAgICBiZWF0cyxcbiAgICAgIHRodW1ibmFpbHM6IFtgJHtpZC50b1VwcGVyQ2FzZSgpfV92ZXIxLnBuZ2BdLFxuICAgICAgc2VxdWVuY2VfbGVuZ3RoOiBiZWF0cy5sZW5ndGgsXG4gICAgICBhdXRob3I6IChtZXRhLmF1dGhvciBhcyBzdHJpbmcpIHx8IFwiVW5rbm93blwiLFxuICAgICAgbGV2ZWw6IChtZXRhLmxldmVsIGFzIG51bWJlcikgfHwgMSxcbiAgICAgIGRhdGVfYWRkZWQ6IG5ldyBEYXRlKChtZXRhLmRhdGVfYWRkZWQgYXMgc3RyaW5nIHwgbnVtYmVyKSB8fCBEYXRlLm5vdygpKSxcbiAgICAgIGdyaWRNb2RlOiAobWV0YS5ncmlkTW9kZSBhcyBzdHJpbmcpIHx8IFwiZGlhbW9uZFwiLFxuICAgICAgcHJvcFR5cGU6IChtZXRhLnByb3BUeXBlIGFzIHN0cmluZykgfHwgXCJ1bmtub3duXCIsXG4gICAgICBpc19mYXZvcml0ZTogKG1ldGEuaXNfZmF2b3JpdGUgYXMgYm9vbGVhbikgfHwgZmFsc2UsXG4gICAgICBpc19jaXJjdWxhcjogKG1ldGEuaXNfY2lyY3VsYXIgYXMgYm9vbGVhbikgfHwgZmFsc2UsXG4gICAgICBzdGFydGluZ19wb3NpdGlvbjogKG1ldGEuc2VxdWVuY2Vfc3RhcnRfcG9zaXRpb24gYXMgc3RyaW5nKSB8fCBcImJldGFcIixcbiAgICAgIGRpZmZpY3VsdHlfbGV2ZWw6IHRoaXMubWFwTGV2ZWxUb0RpZmZpY3VsdHkoKG1ldGEubGV2ZWwgYXMgbnVtYmVyKSB8fCAxKSxcbiAgICAgIHRhZ3M6IFtcImZsb3dcIiwgXCJwcmFjdGljZVwiXSxcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgIHNvdXJjZTogXCJwbmdfbWV0YWRhdGFcIixcbiAgICAgICAgZXh0cmFjdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIC4uLm1ldGEsXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogTWFwIG51bWVyaWMgbGV2ZWwgdG8gZGlmZmljdWx0eSBzdHJpbmdcbiAgICovXG4gIHByaXZhdGUgbWFwTGV2ZWxUb0RpZmZpY3VsdHkobGV2ZWw6IG51bWJlcik6IHN0cmluZyB7XG4gICAgaWYgKGxldmVsIDw9IDEpIHJldHVybiBcImJlZ2lubmVyXCI7XG4gICAgaWYgKGxldmVsIDw9IDIpIHJldHVybiBcImludGVybWVkaWF0ZVwiO1xuICAgIHJldHVybiBcImFkdmFuY2VkXCI7XG4gIH1cblxuICAvKipcbiAgICogTG9hZCBzZXF1ZW5jZSBmcm9tIFBORyBtZXRhZGF0YSBvciBjcmVhdGUgZmFsbGJhY2tcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgY3JlYXRlVGVzdFNlcXVlbmNlKGlkOiBzdHJpbmcpOiBQcm9taXNlPFNlcXVlbmNlRGF0YT4ge1xuICAgIGNvbnNvbGUubG9nKGDwn46sIExvYWRpbmcgc2VxdWVuY2UgZnJvbSBQTkcgbWV0YWRhdGEgZm9yIElEOiAke2lkfWApO1xuXG4gICAgLy8gVHJ5IHRvIGxvYWQgZnJvbSBQTkcgbWV0YWRhdGEgZmlyc3RcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2VxdWVuY2VEYXRhID0gYXdhaXQgdGhpcy5sb2FkU2VxdWVuY2VGcm9tUE5HKGlkKTtcbiAgICAgIGlmIChzZXF1ZW5jZURhdGEpIHtcbiAgICAgICAgY29uc29sZS5sb2coYOKchSBMb2FkZWQgcmVhbCBzZXF1ZW5jZSBkYXRhIGZyb20gUE5HIGZvciAke2lkfWApO1xuICAgICAgICByZXR1cm4gc2VxdWVuY2VEYXRhO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oYOKaoO+4jyBGYWlsZWQgdG8gbG9hZCBQTkcgbWV0YWRhdGEgZm9yICR7aWR9OmAsIGVycm9yKTtcbiAgICB9XG5cbiAgICAvLyBGYWxsYmFjazogUmV0dXJuIGVycm9yIC0gbm8gZmFrZSBzZXF1ZW5jZXNcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgTm8gUE5HIG1ldGFkYXRhIGZvdW5kIGZvciBzZXF1ZW5jZSAke2lkfS4gUGxlYXNlIGVuc3VyZSB0aGUgc2VxdWVuY2UgaGFzIGEgdmFsaWQgUE5HIHRodW1ibmFpbCB3aXRoIGVtYmVkZGVkIG1ldGFkYXRhLmBcbiAgICApO1xuICB9XG59XG4iXSwibWFwcGluZ3MiOiJBQVFBO0FBQUEsRUFDRTtBQUFBLEVBQ0E7QUFBQSxFQUNBO0FBQUEsRUFDQTtBQUFBLEVBQ0E7QUFBQSxPQUNLO0FBRVAsU0FBUyw0QkFBNEI7QUFROUIsYUFBTSxnQkFBNEM7QUFBQSxFQUN2RCxZQUNVLHVCQUNBLG9CQUNSO0FBRlE7QUFDQTtBQUFBLEVBQ1A7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQUtILE1BQU0sZUFBZSxTQUF1RDtBQUMxRSxRQUFJO0FBRUYsWUFBTSxXQUFXLEtBQUssc0JBQXNCLGVBQWUsT0FBTztBQUNsRSxZQUFN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