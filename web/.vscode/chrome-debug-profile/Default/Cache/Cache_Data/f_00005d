export class DeleteService {
  async prepareDeleteConfirmation(sequence, allSequences) {
    const relatedSequences = this.findRelatedSequences(sequence, allSequences);
    const hasVariations = relatedSequences.length > 0;
    const willFixVariationNumbers = hasVariations && this.needsVariationNumberFix(sequence, relatedSequences);
    return {
      sequence,
      relatedSequences,
      hasVariations,
      willFixVariationNumbers
    };
  }
  async deleteSequence(sequenceOrId, allSequences) {
    try {
      const sequence = typeof sequenceOrId === "string" ? allSequences.find((seq) => seq.id === sequenceOrId) : sequenceOrId;
      if (!sequence) {
        return {
          success: false,
          deletedSequence: null,
          affectedSequences: [],
          error: "Sequence not found"
        };
      }
      const canDelete = await this.canDeleteSequence(sequence, allSequences);
      if (!canDelete) {
        return {
          success: false,
          deletedSequence: null,
          affectedSequences: [],
          error: "Sequence cannot be deleted"
        };
      }
      const affectedSequences = await this.getAffectedSequences(
        sequence,
        allSequences
      );
      const updatedSequences = await this.fixVariationNumbers(
        sequence,
        allSequences
      );
      console.log(`Deleting sequence: ${sequence.word} (${sequence.id})`);
      const remainingSequences = updatedSequences.filter(
        (seq) => seq.id !== sequence.id
      );
      return {
        success: true,
        deletedSequence: sequence,
        affectedSequences: remainingSequences.filter(
          (seq) => affectedSequences.some((affected) => affected.id === seq.id)
        )
      };
    } catch (error) {
      return {
        success: false,
        deletedSequence: null,
        affectedSequences: [],
        error: error instanceof Error ? error.message : "Unknown error occurred"
      };
    }
  }
  async fixVariationNumbers(deletedSequence, allSequences) {
    const baseWord = this.extractBaseWord(deletedSequence.word);
    const deletedVariation = this.extractVariationNumber(deletedSequence.word);
    if (!deletedVariation) {
      return allSequences;
    }
    const updatedSequences = allSequences.map((sequence) => {
      if (sequence.id === deletedSequence.id) {
        return sequence;
      }
      const sequenceBaseWord = this.extractBaseWord(sequence.word);
      const sequenceVariation = this.extractVariationNumber(sequence.word);
      if (sequenceBaseWord === baseWord && sequenceVariation && sequenceVariation > deletedVariation) {
        const newVariationNumber = sequenceVariation - 1;
        const newWord = this.createWordWithVariation(
          baseWord,
          newVariationNumber
        );
        return {
          ...sequence,
          word: newWord,
          name: sequence.name.replace(sequence.word, newWord)
        };
      }
      return sequence;
    });
    return updatedSequences;
  }
  async canDeleteSequence(sequence, _allSequences) {
    const isProtected = sequence.metadata?.isProtected;
    const isSystem = sequence.metadata?.isSystem;
    if (isProtected || isSystem) {
      return false;
    }
    if (sequence.author && sequence.author !== "current-user") {
      return true;
    }
    return true;
  }
  async getAffectedSequences(sequence, allSequences) {
    const affected = [];
    const baseWord = this.extractBaseWord(sequence.word);
    const deletedVariation = this.extractVariationNumber(sequence.word);
    if (!deletedVariation) {
      return affected;
    }
    allSequences.forEach((seq) => {
      if (seq.id === sequence.id) return;
      const seqBaseWord = this.extractBaseWord(seq.word);
      const seqVariation = this.extractVariationNumber(seq.word);
      if (seqBaseWord === baseWord && seqVariation && seqVariation > deletedVariation) {
        affected.push(seq);
      }
    });
    return affected;
  }
  // Private helper methods
  findRelatedSequences(sequence, allSequences) {
    const baseWord = this.extractBaseWord(sequence.word);
    return allSequences.filter((seq) => {
      if (seq.id === sequence.id) return false;
      const seqBaseWord = this.extractBaseWord(seq.word);
      return seqBaseWord === baseWord;
    });
  }
  needsVariationNumberFix(deletedSequence, relatedSequences) {
    const deletedVariation = this.extractVariationNumber(deletedSequence.word);
    if (!deletedVariation) return false;
    return relatedSequences.some((seq) => {
      const variation = this.extractVariationNumber(seq.word);
      return variation && variation > deletedVariation;
    });
  }
  extractBaseWord(word) {
    const match = word.match(/^([A-Z]+)(?:[_-]v?(\d+))?$/i);
    return match && match[1] ? match[1] : word;
  }
  extractVariationNumber(word) {
    const match = word.match(/[_-]v?(\d+)$/i);
    return match && match[1] ? parseInt(match[1]) : null;
  }
  createWordWithVariation(baseWord, variation) {
    if (variation <= 1) {
      return baseWord;
    }
    return `${baseWord}_v${variation}`;
  }
  // Utility methods for UI components
  async formatDeleteConfirmationMessage(data) {
    const {
      sequence,
      relatedSequences,
      hasVariations,
      willFixVariationNumbers
    } = data;
    let message = `Are you sure you want to delete "${sequence.word}"?`;
    if (hasVariations) {
      message += `

This sequence has ${relatedSequences.length} related variation(s).`;
      if (willFixVariationNumbers) {
        message += "\nVariation numbers will be automatically updated to maintain sequence.";
      }
    }
    message += "\n\nThis action cannot be undone.";
    return message;
  }
  async getDeleteButtonText(data) {
    if (data.willFixVariationNumbers) {
      return "Delete & Fix Variations";
    }
    return "Delete Sequence";
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkRlbGV0ZVNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBEZWxldGUgU2VydmljZSAtIE1hbmFnZXMgc2VxdWVuY2UgZGVsZXRpb24gb3BlcmF0aW9uc1xuICpcbiAqIEhhbmRsZXMgc2VxdWVuY2UgZGVsZXRpb24gd2l0aCBjb25maXJtYXRpb24sIHZhcmlhdGlvbiBudW1iZXIgZml4aW5nLFxuICogYW5kIGNsZWFudXAgb3BlcmF0aW9ucyBmb2xsb3dpbmcgdGhlIG1pY3Jvc2VydmljZXMgYXJjaGl0ZWN0dXJlIHBhdHRlcm4uXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhIH0gZnJvbSBcIi4uLy4uL2ludGVyZmFjZXMvZG9tYWluLXR5cGVzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGVsZXRlUmVzdWx0IHtcbiAgc3VjY2VzczogYm9vbGVhbjtcbiAgZGVsZXRlZFNlcXVlbmNlOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhIHwgbnVsbDtcbiAgYWZmZWN0ZWRTZXF1ZW5jZXM6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXTtcbiAgZXJyb3I/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGVsZXRlQ29uZmlybWF0aW9uRGF0YSB7XG4gIHNlcXVlbmNlOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhO1xuICByZWxhdGVkU2VxdWVuY2VzOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW107XG4gIGhhc1ZhcmlhdGlvbnM6IGJvb2xlYW47XG4gIHdpbGxGaXhWYXJpYXRpb25OdW1iZXJzOiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElEZWxldGVTZXJ2aWNlIHtcbiAgLyoqIFByZXBhcmUgZGVsZXRpb24gZGF0YSBmb3IgY29uZmlybWF0aW9uIGRpYWxvZyAqL1xuICBwcmVwYXJlRGVsZXRlQ29uZmlybWF0aW9uKFxuICAgIHNlcXVlbmNlOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhLFxuICAgIGFsbFNlcXVlbmNlczogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdXG4gICk6IFByb21pc2U8RGVsZXRlQ29uZmlybWF0aW9uRGF0YT47XG5cbiAgLyoqIERlbGV0ZSBzZXF1ZW5jZSBhbmQgaGFuZGxlIGNsZWFudXAgKi9cbiAgZGVsZXRlU2VxdWVuY2UoXG4gICAgc2VxdWVuY2VJZDogc3RyaW5nLFxuICAgIGFsbFNlcXVlbmNlczogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdXG4gICk6IFByb21pc2U8RGVsZXRlUmVzdWx0PjtcblxuICAvKiogRml4IHZhcmlhdGlvbiBudW1iZXJzIGFmdGVyIGRlbGV0aW9uICovXG4gIGZpeFZhcmlhdGlvbk51bWJlcnMoXG4gICAgZGVsZXRlZFNlcXVlbmNlOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhLFxuICAgIGFsbFNlcXVlbmNlczogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdXG4gICk6IFByb21pc2U8QnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdPjtcblxuICAvKiogQ2hlY2sgaWYgc2VxdWVuY2UgY2FuIGJlIHNhZmVseSBkZWxldGVkICovXG4gIGNhbkRlbGV0ZVNlcXVlbmNlKFxuICAgIHNlcXVlbmNlOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhLFxuICAgIGFsbFNlcXVlbmNlczogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdXG4gICk6IFByb21pc2U8Ym9vbGVhbj47XG5cbiAgLyoqIEdldCBzZXF1ZW5jZXMgdGhhdCB3b3VsZCBiZSBhZmZlY3RlZCBieSBkZWxldGlvbiAqL1xuICBnZXRBZmZlY3RlZFNlcXVlbmNlcyhcbiAgICBzZXF1ZW5jZTogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YSxcbiAgICBhbGxTZXF1ZW5jZXM6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXVxuICApOiBQcm9taXNlPEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXT47XG59XG5cbmV4cG9ydCBjbGFzcyBEZWxldGVTZXJ2aWNlIGltcGxlbWVudHMgSURlbGV0ZVNlcnZpY2Uge1xuICBhc3luYyBwcmVwYXJlRGVsZXRlQ29uZmlybWF0aW9uKFxuICAgIHNlcXVlbmNlOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhLFxuICAgIGFsbFNlcXVlbmNlczogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdXG4gICk6IFByb21pc2U8RGVsZXRlQ29uZmlybWF0aW9uRGF0YT4ge1xuICAgIGNvbnN0IHJlbGF0ZWRTZXF1ZW5jZXMgPSB0aGlzLmZpbmRSZWxhdGVkU2VxdWVuY2VzKHNlcXVlbmNlLCBhbGxTZXF1ZW5jZXMpO1xuICAgIGNvbnN0IGhhc1ZhcmlhdGlvbnMgPSByZWxhdGVkU2VxdWVuY2VzLmxlbmd0aCA+IDA7XG4gICAgY29uc3Qgd2lsbEZpeFZhcmlhdGlvbk51bWJlcnMgPVxuICAgICAgaGFzVmFyaWF0aW9ucyAmJiB0aGlzLm5lZWRzVmFyaWF0aW9uTnVtYmVyRml4KHNlcXVlbmNlLCByZWxhdGVkU2VxdWVuY2VzKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzZXF1ZW5jZSxcbiAgICAgIHJlbGF0ZWRTZXF1ZW5jZXMsXG4gICAgICBoYXNWYXJpYXRpb25zLFxuICAgICAgd2lsbEZpeFZhcmlhdGlvbk51bWJlcnMsXG4gICAgfTtcbiAgfVxuXG4gIC8vIE92ZXJsb2FkIHRvIG1hdGNoIGludGVyZmFjZSBzaWduYXR1cmVcbiAgYXN5bmMgZGVsZXRlU2VxdWVuY2UoXG4gICAgc2VxdWVuY2U6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEsXG4gICAgYWxsU2VxdWVuY2VzOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW11cbiAgKTogUHJvbWlzZTxEZWxldGVSZXN1bHQ+O1xuICBhc3luYyBkZWxldGVTZXF1ZW5jZShcbiAgICBzZXF1ZW5jZUlkOiBzdHJpbmcsXG4gICAgYWxsU2VxdWVuY2VzOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW11cbiAgKTogUHJvbWlzZTxEZWxldGVSZXN1bHQ+O1xuICBhc3luYyBkZWxldGVTZXF1ZW5jZShcbiAgICBzZXF1ZW5jZU9ySWQ6IHN0cmluZyB8IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEsXG4gICAgYWxsU2VxdWVuY2VzOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW11cbiAgKTogUHJvbWlzZTxEZWxldGVSZXN1bHQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2VxdWVuY2UgPVxuICAgICAgICB0eXBlb2Ygc2VxdWVuY2VPcklkID09PSBcInN0cmluZ1wiXG4gICAgICAgICAgPyBhbGxTZXF1ZW5jZXMuZmluZCgoc2VxKSA9PiBzZXEuaWQgPT09IHNlcXVlbmNlT3JJZClcbiAgICAgICAgICA6IHNlcXVlbmNlT3JJZDtcbiAgICAgIGlmICghc2VxdWVuY2UpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBkZWxldGVkU2VxdWVuY2U6IG51bGwsXG4gICAgICAgICAgYWZmZWN0ZWRTZXF1ZW5jZXM6IFtdLFxuICAgICAgICAgIGVycm9yOiBcIlNlcXVlbmNlIG5vdCBmb3VuZFwiLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiBkZWxldGlvbiBpcyBhbGxvd2VkXG4gICAgICBjb25zdCBjYW5EZWxldGUgPSBhd2FpdCB0aGlzLmNhbkRlbGV0ZVNlcXVlbmNlKHNlcXVlbmNlLCBhbGxTZXF1ZW5jZXMpO1xuICAgICAgaWYgKCFjYW5EZWxldGUpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBkZWxldGVkU2VxdWVuY2U6IG51bGwsXG4gICAgICAgICAgYWZmZWN0ZWRTZXF1ZW5jZXM6IFtdLFxuICAgICAgICAgIGVycm9yOiBcIlNlcXVlbmNlIGNhbm5vdCBiZSBkZWxldGVkXCIsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIEdldCBhZmZlY3RlZCBzZXF1ZW5jZXMgYmVmb3JlIGRlbGV0aW9uXG4gICAgICBjb25zdCBhZmZlY3RlZFNlcXVlbmNlcyA9IGF3YWl0IHRoaXMuZ2V0QWZmZWN0ZWRTZXF1ZW5jZXMoXG4gICAgICAgIHNlcXVlbmNlLFxuICAgICAgICBhbGxTZXF1ZW5jZXNcbiAgICAgICk7XG5cbiAgICAgIC8vIEZpeCB2YXJpYXRpb24gbnVtYmVycyBpZiBuZWVkZWRcbiAgICAgIGNvbnN0IHVwZGF0ZWRTZXF1ZW5jZXMgPSBhd2FpdCB0aGlzLmZpeFZhcmlhdGlvbk51bWJlcnMoXG4gICAgICAgIHNlcXVlbmNlLFxuICAgICAgICBhbGxTZXF1ZW5jZXNcbiAgICAgICk7XG5cbiAgICAgIC8vIEluIGEgcmVhbCBpbXBsZW1lbnRhdGlvbiwgdGhpcyB3b3VsZCBjYWxsIHRoZSBwZXJzaXN0ZW5jZSBzZXJ2aWNlXG4gICAgICAvLyBGb3Igbm93LCB3ZSdsbCBzaW11bGF0ZSB0aGUgZGVsZXRpb25cbiAgICAgIGNvbnNvbGUubG9nKGBEZWxldGluZyBzZXF1ZW5jZTogJHtzZXF1ZW5jZS53b3JkfSAoJHtzZXF1ZW5jZS5pZH0pYCk7XG5cbiAgICAgIC8vIFJlbW92ZSB0aGUgc2VxdWVuY2UgZnJvbSB0aGUgbGlzdFxuICAgICAgY29uc3QgcmVtYWluaW5nU2VxdWVuY2VzID0gdXBkYXRlZFNlcXVlbmNlcy5maWx0ZXIoXG4gICAgICAgIChzZXEpID0+IHNlcS5pZCAhPT0gc2VxdWVuY2UuaWRcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGRlbGV0ZWRTZXF1ZW5jZTogc2VxdWVuY2UsXG4gICAgICAgIGFmZmVjdGVkU2VxdWVuY2VzOiByZW1haW5pbmdTZXF1ZW5jZXMuZmlsdGVyKChzZXEpID0+XG4gICAgICAgICAgYWZmZWN0ZWRTZXF1ZW5jZXMuc29tZSgoYWZmZWN0ZWQpID0+IGFmZmVjdGVkLmlkID09PSBzZXEuaWQpXG4gICAgICAgICksXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZGVsZXRlZFNlcXVlbmNlOiBudWxsLFxuICAgICAgICBhZmZlY3RlZFNlcXVlbmNlczogW10sXG4gICAgICAgIGVycm9yOlxuICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yIG9jY3VycmVkXCIsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZpeFZhcmlhdGlvbk51bWJlcnMoXG4gICAgZGVsZXRlZFNlcXVlbmNlOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhLFxuICAgIGFsbFNlcXVlbmNlczogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdXG4gICk6IFByb21pc2U8QnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdPiB7XG4gICAgY29uc3QgYmFzZVdvcmQgPSB0aGlzLmV4dHJhY3RCYXNlV29yZChkZWxldGVkU2VxdWVuY2Uud29yZCk7XG4gICAgY29uc3QgZGVsZXRlZFZhcmlhdGlvbiA9IHRoaXMuZXh0cmFjdFZhcmlhdGlvbk51bWJlcihkZWxldGVkU2VxdWVuY2Uud29yZCk7XG5cbiAgICBpZiAoIWRlbGV0ZWRWYXJpYXRpb24pIHtcbiAgICAgIHJldHVybiBhbGxTZXF1ZW5jZXM7IC8vIE5vIHZhcmlhdGlvbiBudW1iZXIgdG8gZml4XG4gICAgfVxuXG4gICAgY29uc3QgdXBkYXRlZFNlcXVlbmNlcyA9IGFsbFNlcXVlbmNlcy5tYXAoKHNlcXVlbmNlKSA9PiB7XG4gICAgICAvLyBTa2lwIHRoZSBzZXF1ZW5jZSBiZWluZyBkZWxldGVkXG4gICAgICBpZiAoc2VxdWVuY2UuaWQgPT09IGRlbGV0ZWRTZXF1ZW5jZS5pZCkge1xuICAgICAgICByZXR1cm4gc2VxdWVuY2U7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNlcXVlbmNlQmFzZVdvcmQgPSB0aGlzLmV4dHJhY3RCYXNlV29yZChzZXF1ZW5jZS53b3JkKTtcbiAgICAgIGNvbnN0IHNlcXVlbmNlVmFyaWF0aW9uID0gdGhpcy5leHRyYWN0VmFyaWF0aW9uTnVtYmVyKHNlcXVlbmNlLndvcmQpO1xuXG4gICAgICAvLyBPbmx5IGZpeCBzZXF1ZW5jZXMgd2l0aCB0aGUgc2FtZSBiYXNlIHdvcmQgYW5kIGhpZ2hlciB2YXJpYXRpb24gbnVtYmVyc1xuICAgICAgaWYgKFxuICAgICAgICBzZXF1ZW5jZUJhc2VXb3JkID09PSBiYXNlV29yZCAmJlxuICAgICAgICBzZXF1ZW5jZVZhcmlhdGlvbiAmJlxuICAgICAgICBzZXF1ZW5jZVZhcmlhdGlvbiA+IGRlbGV0ZWRWYXJpYXRpb25cbiAgICAgICkge1xuICAgICAgICBjb25zdCBuZXdWYXJpYXRpb25OdW1iZXIgPSBzZXF1ZW5jZVZhcmlhdGlvbiAtIDE7XG4gICAgICAgIGNvbnN0IG5ld1dvcmQgPSB0aGlzLmNyZWF0ZVdvcmRXaXRoVmFyaWF0aW9uKFxuICAgICAgICAgIGJhc2VXb3JkLFxuICAgICAgICAgIG5ld1ZhcmlhdGlvbk51bWJlclxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgLi4uc2VxdWVuY2UsXG4gICAgICAgICAgd29yZDogbmV3V29yZCxcbiAgICAgICAgICBuYW1lOiBzZXF1ZW5jZS5uYW1lLnJlcGxhY2Uoc2VxdWVuY2Uud29yZCwgbmV3V29yZCksXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBzZXF1ZW5jZTtcbiAgICB9KTtcblxuICAgIHJldHVybiB1cGRhdGVkU2VxdWVuY2VzO1xuICB9XG5cbiAgYXN5bmMgY2FuRGVsZXRlU2VxdWVuY2UoXG4gICAgc2VxdWVuY2U6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEsXG4gICAgX2FsbFNlcXVlbmNlczogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSBzeXN0ZW0gb3IgcHJvdGVjdGVkIHNlcXVlbmNlIChjaGVjayBtZXRhZGF0YSlcbiAgICBjb25zdCBpc1Byb3RlY3RlZCA9IHNlcXVlbmNlLm1ldGFkYXRhPy5pc1Byb3RlY3RlZCBhcyBib29sZWFuO1xuICAgIGNvbnN0IGlzU3lzdGVtID0gc2VxdWVuY2UubWV0YWRhdGE/LmlzU3lzdGVtIGFzIGJvb2xlYW47XG5cbiAgICBpZiAoaXNQcm90ZWN0ZWQgfHwgaXNTeXN0ZW0pIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiB1c2VyIGhhcyBwZXJtaXNzaW9uIHRvIGRlbGV0ZSAod291bGQgYmUgYmFzZWQgb24gYXV0aG9yc2hpcCBpbiByZWFsIGFwcClcbiAgICBpZiAoc2VxdWVuY2UuYXV0aG9yICYmIHNlcXVlbmNlLmF1dGhvciAhPT0gXCJjdXJyZW50LXVzZXJcIikge1xuICAgICAgLy8gSW4gYSByZWFsIGFwcCwgdGhpcyB3b3VsZCBjaGVjayB1c2VyIHBlcm1pc3Npb25zXG4gICAgICAvLyBGb3Igbm93LCBhbGxvdyBkZWxldGlvbiBvZiBkZW1vIHNlcXVlbmNlc1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBhc3luYyBnZXRBZmZlY3RlZFNlcXVlbmNlcyhcbiAgICBzZXF1ZW5jZTogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YSxcbiAgICBhbGxTZXF1ZW5jZXM6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXVxuICApOiBQcm9taXNlPEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXT4ge1xuICAgIGNvbnN0IGFmZmVjdGVkOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW10gPSBbXTtcbiAgICBjb25zdCBiYXNlV29yZCA9IHRoaXMuZXh0cmFjdEJhc2VXb3JkKHNlcXVlbmNlLndvcmQpO1xuICAgIGNvbnN0IGRlbGV0ZWRWYXJpYXRpb24gPSB0aGlzLmV4dHJhY3RWYXJpYXRpb25OdW1iZXIoc2VxdWVuY2Uud29yZCk7XG5cbiAgICBpZiAoIWRlbGV0ZWRWYXJpYXRpb24pIHtcbiAgICAgIHJldHVybiBhZmZlY3RlZDtcbiAgICB9XG5cbiAgICAvLyBGaW5kIHNlcXVlbmNlcyB0aGF0IHdpbGwgaGF2ZSB0aGVpciB2YXJpYXRpb24gbnVtYmVycyBhZGp1c3RlZFxuICAgIGFsbFNlcXVlbmNlcy5mb3JFYWNoKChzZXEpID0+IHtcbiAgICAgIGlmIChzZXEuaWQgPT09IHNlcXVlbmNlLmlkKSByZXR1cm47XG5cbiAgICAgIGNvbnN0IHNlcUJhc2VXb3JkID0gdGhpcy5leHRyYWN0QmFzZVdvcmQoc2VxLndvcmQpO1xuICAgICAgY29uc3Qgc2VxVmFyaWF0aW9uID0gdGhpcy5leHRyYWN0VmFyaWF0aW9uTnVtYmVyKHNlcS53b3JkKTtcblxuICAgICAgaWYgKFxuICAgICAgICBzZXFCYXNlV29yZCA9PT0gYmFzZVdvcmQgJiZcbiAgICAgICAgc2VxVmFyaWF0aW9uICYmXG4gICAgICAgIHNlcVZhcmlhdGlvbiA+IGRlbGV0ZWRWYXJpYXRpb25cbiAgICAgICkge1xuICAgICAgICBhZmZlY3RlZC5wdXNoKHNlcSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gYWZmZWN0ZWQ7XG4gIH1cblxuICAvLyBQcml2YXRlIGhlbHBlciBtZXRob2RzXG4gIHByaXZhdGUgZmluZFJlbGF0ZWRTZXF1ZW5jZXMoXG4gICAgc2VxdWVuY2U6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEsXG4gICAgYWxsU2VxdWVuY2VzOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW11cbiAgKTogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdIHtcbiAgICBjb25zdCBiYXNlV29yZCA9IHRoaXMuZXh0cmFjdEJhc2VXb3JkKHNlcXVlbmNlLndvcmQpO1xuXG4gICAgcmV0dXJuIGFsbFNlcXVlbmNlcy5maWx0ZXIoKHNlcSkgPT4ge1xuICAgICAgaWYgKHNlcS5pZCA9PT0gc2VxdWVuY2UuaWQpIHJldHVybiBmYWxzZTtcbiAgICAgIGNvbnN0IHNlcUJhc2VXb3JkID0gdGhpcy5leHRyYWN0QmFzZVdvcmQoc2VxLndvcmQpO1xuICAgICAgcmV0dXJuIHNlcUJhc2VXb3JkID09PSBiYXNlV29yZDtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgbmVlZHNWYXJpYXRpb25OdW1iZXJGaXgoXG4gICAgZGVsZXRlZFNlcXVlbmNlOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhLFxuICAgIHJlbGF0ZWRTZXF1ZW5jZXM6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXVxuICApOiBib29sZWFuIHtcbiAgICBjb25zdCBkZWxldGVkVmFyaWF0aW9uID0gdGhpcy5leHRyYWN0VmFyaWF0aW9uTnVtYmVyKGRlbGV0ZWRTZXF1ZW5jZS53b3JkKTtcbiAgICBpZiAoIWRlbGV0ZWRWYXJpYXRpb24pIHJldHVybiBmYWxzZTtcblxuICAgIC8vIENoZWNrIGlmIHRoZXJlIGFyZSBzZXF1ZW5jZXMgd2l0aCBoaWdoZXIgdmFyaWF0aW9uIG51bWJlcnNcbiAgICByZXR1cm4gcmVsYXRlZFNlcXVlbmNlcy5zb21lKChzZXEpID0+IHtcbiAgICAgIGNvbnN0IHZhcmlhdGlvbiA9IHRoaXMuZXh0cmFjdFZhcmlhdGlvbk51bWJlcihzZXEud29yZCk7XG4gICAgICByZXR1cm4gdmFyaWF0aW9uICYmIHZhcmlhdGlvbiA+IGRlbGV0ZWRWYXJpYXRpb247XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGV4dHJhY3RCYXNlV29yZCh3b3JkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIC8vIEV4dHJhY3QgYmFzZSB3b3JkIGZyb20gdmFyaWF0aW9ucyBsaWtlIFwiQ0FLRV92MlwiIG9yIFwiQUJDLTJcIlxuICAgIGNvbnN0IG1hdGNoID0gd29yZC5tYXRjaCgvXihbQS1aXSspKD86W18tXXY/KFxcZCspKT8kL2kpO1xuICAgIHJldHVybiBtYXRjaCAmJiBtYXRjaFsxXSA/IG1hdGNoWzFdIDogd29yZDtcbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdFZhcmlhdGlvbk51bWJlcih3b3JkOiBzdHJpbmcpOiBudW1iZXIgfCBudWxsIHtcbiAgICAvLyBFeHRyYWN0IHZhcmlhdGlvbiBudW1iZXIgZnJvbSB3b3JkcyBsaWtlIFwiQ0FLRV92MlwiIG9yIFwiQUJDLTJcIlxuICAgIGNvbnN0IG1hdGNoID0gd29yZC5tYXRjaCgvW18tXXY/KFxcZCspJC9pKTtcbiAgICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2hbMV0gPyBwYXJzZUludChtYXRjaFsxXSkgOiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVXb3JkV2l0aFZhcmlhdGlvbihiYXNlV29yZDogc3RyaW5nLCB2YXJpYXRpb246IG51bWJlcik6IHN0cmluZyB7XG4gICAgaWYgKHZhcmlhdGlvbiA8PSAxKSB7XG4gICAgICByZXR1cm4gYmFzZVdvcmQ7XG4gICAgfVxuICAgIHJldHVybiBgJHtiYXNlV29yZH1fdiR7dmFyaWF0aW9ufWA7XG4gIH1cblxuICAvLyBVdGlsaXR5IG1ldGhvZHMgZm9yIFVJIGNvbXBvbmVudHNcbiAgYXN5bmMgZm9ybWF0RGVsZXRlQ29uZmlybWF0aW9uTWVzc2FnZShcbiAgICBkYXRhOiBEZWxldGVDb25maXJtYXRpb25EYXRhXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3Qge1xuICAgICAgc2VxdWVuY2UsXG4gICAgICByZWxhdGVkU2VxdWVuY2VzLFxuICAgICAgaGFzVmFyaWF0aW9ucyxcbiAgICAgIHdpbGxGaXhWYXJpYXRpb25OdW1iZXJzLFxuICAgIH0gPSBkYXRhO1xuXG4gICAgbGV0IG1lc3NhZ2UgPSBgQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGRlbGV0ZSBcIiR7c2VxdWVuY2Uud29yZH1cIj9gO1xuXG4gICAgaWYgKGhhc1ZhcmlhdGlvbnMpIHtcbiAgICAgIG1lc3NhZ2UgKz0gYFxcblxcblRoaXMgc2VxdWVuY2UgaGFzICR7cmVsYXRlZFNlcXVlbmNlcy5sZW5ndGh9IHJlbGF0ZWQgdmFyaWF0aW9uKHMpLmA7XG5cbiAgICAgIGlmICh3aWxsRml4VmFyaWF0aW9uTnVtYmVycykge1xuICAgICAgICBtZXNzYWdlICs9XG4gICAgICAgICAgXCJcXG5WYXJpYXRpb24gbnVtYmVycyB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgdXBkYXRlZCB0byBtYWludGFpbiBzZXF1ZW5jZS5cIjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBtZXNzYWdlICs9IFwiXFxuXFxuVGhpcyBhY3Rpb24gY2Fubm90IGJlIHVuZG9uZS5cIjtcblxuICAgIHJldHVybiBtZXNzYWdlO1xuICB9XG5cbiAgYXN5bmMgZ2V0RGVsZXRlQnV0dG9uVGV4dChkYXRhOiBEZWxldGVDb25maXJtYXRpb25EYXRhKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBpZiAoZGF0YS53aWxsRml4VmFyaWF0aW9uTnVtYmVycykge1xuICAgICAgcmV0dXJuIFwiRGVsZXRlICYgRml4IFZhcmlhdGlvbnNcIjtcbiAgICB9XG4gICAgcmV0dXJuIFwiRGVsZXRlIFNlcXVlbmNlXCI7XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6IkFBdURPLGFBQU0sY0FBd0M7QUFBQSxFQUNuRCxNQUFNLDBCQUNKLFVBQ0EsY0FDaUM7QUFDakMsVUFBTSxtQkFBbUIsS0FBSyxxQkFBcUIsVUFBVSxZQUFZO0FBQ3pFLFVBQU0sZ0JBQWdCLGlCQUFpQixTQUFTO0FBQ2hELFVBQU0sMEJBQ0osaUJBQWlCLEtBQUssd0JBQXdCLFVBQVUsZ0JBQWdCO0FBRTFFLFdBQU87QUFBQSxNQUNMO0FBQUEsTUFDQTtBQUFBLE1BQ0E7QUFBQSxNQUNBO0FBQUEsSUFDRjtBQUFBLEVBQ0Y7QUFBQSxFQVdBLE1BQU0sZUFDSixjQUNBLGNBQ3VCO0FBQ3ZCLFFBQUk7QUFDRixZQUFNLFdBQ0osT0FBTyxpQkFBaUIsV0FDcEIsYUFBYSxLQUFLLENBQUMsUUFBUSxJQUFJLE9BQU8sWUFBWSxJQUNsRDtBQUNOLFVBQUksQ0FBQyxVQUFVO0FBQ2IsZUFBTztBQUFBLFVBQ0wsU0FBUztBQUFBLFVBQ1QsaUJBQWlCO0FBQUEsVUFDakIsbUJBQW1CLENBQUM7QUFBQSxVQUNwQixPQUFPO0FBQUEsUUFDVDtBQUFBLE1BQ0Y7QUFHQSxZQUFNLFlBQVksTUFBTSxLQUFLLGtCQUFrQixVQUFVLFlBQVk7QUFDckUsVUFBSSxDQUFDLFdBQVc7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