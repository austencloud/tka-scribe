export class DeleteService {
  async prepareDeleteConfirmation(sequence, allSequences) {
    const relatedSequences = this.findRelatedSequences(sequence, allSequences);
    const hasVariations = relatedSequences.length > 0;
    const willFixVariationNumbers = hasVariations && this.needsVariationNumberFix(sequence, relatedSequences);
    return {
      sequence,
      relatedSequences,
      hasVariations,
      willFixVariationNumbers
    };
  }
  async deleteSequence(sequenceOrId, allSequences) {
    try {
      const sequence = typeof sequenceOrId === "string" ? allSequences.find((seq) => seq.id === sequenceOrId) : sequenceOrId;
      if (!sequence) {
        return {
          success: false,
          deletedSequence: null,
          affectedSequences: [],
          error: "Sequence not found"
        };
      }
      const canDelete = await this.canDeleteSequence(sequence, allSequences);
      if (!canDelete) {
        return {
          success: false,
          deletedSequence: null,
          affectedSequences: [],
          error: "Sequence cannot be deleted"
        };
      }
      const affectedSequences = await this.getAffectedSequences(
        sequence,
        allSequences
      );
      const updatedSequences = await this.fixVariationNumbers(
        sequence,
        allSequences
      );
      console.log(`Deleting sequence: ${sequence.word} (${sequence.id})`);
      const remainingSequences = updatedSequences.filter(
        (seq) => seq.id !== sequence.id
      );
      return {
        success: true,
        deletedSequence: sequence,
        affectedSequences: remainingSequences.filter(
          (seq) => affectedSequences.some((affected) => affected.id === seq.id)
        )
      };
    } catch (error) {
      return {
        success: false,
        deletedSequence: null,
        affectedSequences: [],
        error: error instanceof Error ? error.message : "Unknown error occurred"
      };
    }
  }
  async fixVariationNumbers(deletedSequence, allSequences) {
    const baseWord = this.extractBaseWord(deletedSequence.word);
    const deletedVariation = this.extractVariationNumber(deletedSequence.word);
    if (!deletedVariation) {
      return allSequences;
    }
    const updatedSequences = allSequences.map((sequence) => {
      if (sequence.id === deletedSequence.id) {
        return sequence;
      }
      const sequenceBaseWord = this.extractBaseWord(sequence.word);
      const sequenceVariation = this.extractVariationNumber(sequence.word);
      if (sequenceBaseWord === baseWord && sequenceVariation && sequenceVariation > deletedVariation) {
        const newVariationNumber = sequenceVariation - 1;
        const newWord = this.createWordWithVariation(
          baseWord,
          newVariationNumber
        );
        return {
          ...sequence,
          word: newWord,
          name: sequence.name.replace(sequence.word, newWord)
        };
      }
      return sequence;
    });
    return updatedSequences;
  }
  async canDeleteSequence(sequence, _allSequences) {
    const isProtected = sequence.metadata?.isProtected;
    const isSystem = sequence.metadata?.isSystem;
    if (isProtected || isSystem) {
      return false;
    }
    if (sequence.author && sequence.author !== "current-user") {
      return true;
    }
    return true;
  }
  async getAffectedSequences(sequence, allSequences) {
    const affected = [];
    const baseWord = this.extractBaseWord(sequence.word);
    const deletedVariation = this.extractVariationNumber(sequence.word);
    if (!deletedVariation) {
      return affected;
    }
    allSequences.forEach((seq) => {
      if (seq.id === sequence.id) return;
      const seqBaseWord = this.extractBaseWord(seq.word);
      const seqVariation = this.extractVariationNumber(seq.word);
      if (seqBaseWord === baseWord && seqVariation && seqVariation > deletedVariation) {
        affected.push(seq);
      }
    });
    return affected;
  }
  // Private helper methods
  findRelatedSequences(sequence, allSequences) {
    const baseWord = this.extractBaseWord(sequence.word);
    return allSequences.filter((seq) => {
      if (seq.id === sequence.id) return false;
      const seqBaseWord = this.extractBaseWord(seq.word);
      return seqBaseWord === baseWord;
    });
  }
  needsVariationNumberFix(deletedSequence, relatedSequences) {
    const deletedVariation = this.extractVariationNumber(deletedSequence.word);
    if (!deletedVariation) return false;
    return relatedSequences.some((seq) => {
      const variation = this.extractVariationNumber(seq.word);
      return variation && variation > deletedVariation;
    });
  }
  extractBaseWord(word) {
    const match = word.match(/^([A-Z]+)(?:[_-]v?(\d+))?$/i);
    return match && match[1] ? match[1] : word;
  }
  extractVariationNumber(word) {
    const match = word.match(/[_-]v?(\d+)$/i);
    return match && match[1] ? parseInt(match[1]) : null;
  }
  createWordWithVariation(baseWord, variation) {
    if (variation <= 1) {
      return baseWord;
    }
    return `${baseWord}_v${variation}`;
  }
  // Utility methods for UI components
  async formatDeleteConfirmationMessage(data) {
    const {
      sequence,
      relatedSequences,
      hasVariations,
      willFixVariationNumbers
    } = data;
    let message = `Are you sure you want to delete "${sequence.word}"?`;
    if (hasVariations) {
      message += `

This sequence has ${relatedSequences.length} related variation(s).`;
      if (willFixVariationNumbers) {
        message += "\nVariation numbers will be automatically updated to maintain sequence.";
      }
    }
    message += "\n\nThis action cannot be undone.";
    return message;
  }
  async getDeleteButtonText(data) {
    if (data.willFixVariationNumbers) {
      return "Delete & Fix Variations";
    }
    return "Delete Sequence";
  }
}
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiQzovVEtBL3dlYi9zcmMvbGliL3NlcnZpY2VzL2ltcGxlbWVudGF0aW9ucy9zZXF1ZW5jZS9EZWxldGVTZXJ2aWNlLnRzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWyIvKipcbiAqIERlbGV0ZSBTZXJ2aWNlIC0gTWFuYWdlcyBzZXF1ZW5jZSBkZWxldGlvbiBvcGVyYXRpb25zXG4gKlxuICogSGFuZGxlcyBzZXF1ZW5jZSBkZWxldGlvbiB3aXRoIGNvbmZpcm1hdGlvbiwgdmFyaWF0aW9uIG51bWJlciBmaXhpbmcsXG4gKiBhbmQgY2xlYW51cCBvcGVyYXRpb25zIGZvbGxvd2luZyB0aGUgbWljcm9zZXJ2aWNlcyBhcmNoaXRlY3R1cmUgcGF0dGVybi5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEgfSBmcm9tIFwiLi4vLi4vaW50ZXJmYWNlcy9kb21haW4tdHlwZXNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBEZWxldGVSZXN1bHQge1xuICBzdWNjZXNzOiBib29sZWFuO1xuICBkZWxldGVkU2VxdWVuY2U6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEgfCBudWxsO1xuICBhZmZlY3RlZFNlcXVlbmNlczogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdO1xuICBlcnJvcj86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEZWxldGVDb25maXJtYXRpb25EYXRhIHtcbiAgc2VxdWVuY2U6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGE7XG4gIHJlbGF0ZWRTZXF1ZW5jZXM6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXTtcbiAgaGFzVmFyaWF0aW9uczogYm9vbGVhbjtcbiAgd2lsbEZpeFZhcmlhdGlvbk51bWJlcnM6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSURlbGV0ZVNlcnZpY2Uge1xuICAvKiogUHJlcGFyZSBkZWxldGlvbiBkYXRhIGZvciBjb25maXJtYXRpb24gZGlhbG9nICovXG4gIHByZXBhcmVEZWxldGVDb25maXJtYXRpb24oXG4gICAgc2VxdWVuY2U6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEsXG4gICAgYWxsU2VxdWVuY2VzOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW11cbiAgKTogUHJvbWlzZTxEZWxldGVDb25maXJtYXRpb25EYXRhPjtcblxuICAvKiogRGVsZXRlIHNlcXVlbmNlIGFuZCBoYW5kbGUgY2xlYW51cCAqL1xuICBkZWxldGVTZXF1ZW5jZShcbiAgICBzZXF1ZW5jZUlkOiBzdHJpbmcsXG4gICAgYWxsU2VxdWVuY2VzOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW11cbiAgKTogUHJvbWlzZTxEZWxldGVSZXN1bHQ+O1xuXG4gIC8qKiBGaXggdmFyaWF0aW9uIG51bWJlcnMgYWZ0ZXIgZGVsZXRpb24gKi9cbiAgZml4VmFyaWF0aW9uTnVtYmVycyhcbiAgICBkZWxldGVkU2VxdWVuY2U6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEsXG4gICAgYWxsU2VxdWVuY2VzOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW11cbiAgKTogUHJvbWlzZTxCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW10+O1xuXG4gIC8qKiBDaGVjayBpZiBzZXF1ZW5jZSBjYW4gYmUgc2FmZWx5IGRlbGV0ZWQgKi9cbiAgY2FuRGVsZXRlU2VxdWVuY2UoXG4gICAgc2VxdWVuY2U6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEsXG4gICAgYWxsU2VxdWVuY2VzOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW11cbiAgKTogUHJvbWlzZTxib29sZWFuPjtcblxuICAvKiogR2V0IHNlcXVlbmNlcyB0aGF0IHdvdWxkIGJlIGFmZmVjdGVkIGJ5IGRlbGV0aW9uICovXG4gIGdldEFmZmVjdGVkU2VxdWVuY2VzKFxuICAgIHNlcXVlbmNlOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhLFxuICAgIGFsbFNlcXVlbmNlczogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdXG4gICk6IFByb21pc2U8QnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdPjtcbn1cblxuZXhwb3J0IGNsYXNzIERlbGV0ZVNlcnZpY2UgaW1wbGVtZW50cyBJRGVsZXRlU2VydmljZSB7XG4gIGFzeW5jIHByZXBhcmVEZWxldGVDb25maXJtYXRpb24oXG4gICAgc2VxdWVuY2U6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEsXG4gICAgYWxsU2VxdWVuY2VzOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW11cbiAgKTogUHJvbWlzZTxEZWxldGVDb25maXJtYXRpb25EYXRhPiB7XG4gICAgY29uc3QgcmVsYXRlZFNlcXVlbmNlcyA9IHRoaXMuZmluZFJlbGF0ZWRTZXF1ZW5jZXMoc2VxdWVuY2UsIGFsbFNlcXVlbmNlcyk7XG4gICAgY29uc3QgaGFzVmFyaWF0aW9ucyA9IHJlbGF0ZWRTZXF1ZW5jZXMubGVuZ3RoID4gMDtcbiAgICBjb25zdCB3aWxsRml4VmFyaWF0aW9uTnVtYmVycyA9XG4gICAgICBoYXNWYXJpYXRpb25zICYmIHRoaXMubmVlZHNWYXJpYXRpb25OdW1iZXJGaXgoc2VxdWVuY2UsIHJlbGF0ZWRTZXF1ZW5jZXMpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHNlcXVlbmNlLFxuICAgICAgcmVsYXRlZFNlcXVlbmNlcyxcbiAgICAgIGhhc1ZhcmlhdGlvbnMsXG4gICAgICB3aWxsRml4VmFyaWF0aW9uTnVtYmVycyxcbiAgICB9O1xuICB9XG5cbiAgLy8gT3ZlcmxvYWQgdG8gbWF0Y2ggaW50ZXJmYWNlIHNpZ25hdHVyZVxuICBhc3luYyBkZWxldGVTZXF1ZW5jZShcbiAgICBzZXF1ZW5jZTogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YSxcbiAgICBhbGxTZXF1ZW5jZXM6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXVxuICApOiBQcm9taXNlPERlbGV0ZVJlc3VsdD47XG4gIGFzeW5jIGRlbGV0ZVNlcXVlbmNlKFxuICAgIHNlcXVlbmNlSWQ6IHN0cmluZyxcbiAgICBhbGxTZXF1ZW5jZXM6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXVxuICApOiBQcm9taXNlPERlbGV0ZVJlc3VsdD47XG4gIGFzeW5jIGRlbGV0ZVNlcXVlbmNlKFxuICAgIHNlcXVlbmNlT3JJZDogc3RyaW5nIHwgQnJvd3NlU2VxdWVuY2VNZXRhZGF0YSxcbiAgICBhbGxTZXF1ZW5jZXM6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXVxuICApOiBQcm9taXNlPERlbGV0ZVJlc3VsdD4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZXF1ZW5jZSA9XG4gICAgICAgIHR5cGVvZiBzZXF1ZW5jZU9ySWQgPT09IFwic3RyaW5nXCJcbiAgICAgICAgICA/IGFsbFNlcXVlbmNlcy5maW5kKChzZXEpID0+IHNlcS5pZCA9PT0gc2VxdWVuY2VPcklkKVxuICAgICAgICAgIDogc2VxdWVuY2VPcklkO1xuICAgICAgaWYgKCFzZXF1ZW5jZSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGRlbGV0ZWRTZXF1ZW5jZTogbnVsbCxcbiAgICAgICAgICBhZmZlY3RlZFNlcXVlbmNlczogW10sXG4gICAgICAgICAgZXJyb3I6IFwiU2VxdWVuY2Ugbm90IGZvdW5kXCIsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIGlmIGRlbGV0aW9uIGlzIGFsbG93ZWRcbiAgICAgIGNvbnN0IGNhbkRlbGV0ZSA9IGF3YWl0IHRoaXMuY2FuRGVsZXRlU2VxdWVuY2Uoc2VxdWVuY2UsIGFsbFNlcXVlbmNlcyk7XG4gICAgICBpZiAoIWNhbkRlbGV0ZSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIGRlbGV0ZWRTZXF1ZW5jZTogbnVsbCxcbiAgICAgICAgICBhZmZlY3RlZFNlcXVlbmNlczogW10sXG4gICAgICAgICAgZXJyb3I6IFwiU2VxdWVuY2UgY2Fubm90IGJlIGRlbGV0ZWRcIixcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gR2V0IGFmZmVjdGVkIHNlcXVlbmNlcyBiZWZvcmUgZGVsZXRpb25cbiAgICAgIGNvbnN0IGFmZmVjdGVkU2VxdWVuY2VzID0gYXdhaXQgdGhpcy5nZXRBZmZlY3RlZFNlcXVlbmNlcyhcbiAgICAgICAgc2VxdWVuY2UsXG4gICAgICAgIGFsbFNlcXVlbmNlc1xuICAgICAgKTtcblxuICAgICAgLy8gRml4IHZhcmlhdGlvbiBudW1iZXJzIGlmIG5lZWRlZFxuICAgICAgY29uc3QgdXBkYXRlZFNlcXVlbmNlcyA9IGF3YWl0IHRoaXMuZml4VmFyaWF0aW9uTnVtYmVycyhcbiAgICAgICAgc2VxdWVuY2UsXG4gICAgICAgIGFsbFNlcXVlbmNlc1xuICAgICAgKTtcblxuICAgICAgLy8gSW4gYSByZWFsIGltcGxlbWVudGF0aW9uLCB0aGlzIHdvdWxkIGNhbGwgdGhlIHBlcnNpc3RlbmNlIHNlcnZpY2VcbiAgICAgIC8vIEZvciBub3csIHdlJ2xsIHNpbXVsYXRlIHRoZSBkZWxldGlvblxuICAgICAgY29uc29sZS5sb2coYERlbGV0aW5nIHNlcXVlbmNlOiAke3NlcXVlbmNlLndvcmR9ICgke3NlcXVlbmNlLmlkfSlgKTtcblxuICAgICAgLy8gUmVtb3ZlIHRoZSBzZXF1ZW5jZSBmcm9tIHRoZSBsaXN0XG4gICAgICBjb25zdCByZW1haW5pbmdTZXF1ZW5jZXMgPSB1cGRhdGVkU2VxdWVuY2VzLmZpbHRlcihcbiAgICAgICAgKHNlcSkgPT4gc2VxLmlkICE9PSBzZXF1ZW5jZS5pZFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGVsZXRlZFNlcXVlbmNlOiBzZXF1ZW5jZSxcbiAgICAgICAgYWZmZWN0ZWRTZXF1ZW5jZXM6IHJlbWFpbmluZ1NlcXVlbmNlcy5maWx0ZXIoKHNlcSkgPT5cbiAgICAgICAgICBhZmZlY3RlZFNlcXVlbmNlcy5zb21lKChhZmZlY3RlZCkgPT4gYWZmZWN0ZWQuaWQgPT09IHNlcS5pZClcbiAgICAgICAgKSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBkZWxldGVkU2VxdWVuY2U6IG51bGwsXG4gICAgICAgIGFmZmVjdGVkU2VxdWVuY2VzOiBbXSxcbiAgICAgICAgZXJyb3I6XG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBcIlVua25vd24gZXJyb3Igb2NjdXJyZWRcIixcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZml4VmFyaWF0aW9uTnVtYmVycyhcbiAgICBkZWxldGVkU2VxdWVuY2U6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEsXG4gICAgYWxsU2VxdWVuY2VzOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW11cbiAgKTogUHJvbWlzZTxCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW10+IHtcbiAgICBjb25zdCBiYXNlV29yZCA9IHRoaXMuZXh0cmFjdEJhc2VXb3JkKGRlbGV0ZWRTZXF1ZW5jZS53b3JkKTtcbiAgICBjb25zdCBkZWxldGVkVmFyaWF0aW9uID0gdGhpcy5leHRyYWN0VmFyaWF0aW9uTnVtYmVyKGRlbGV0ZWRTZXF1ZW5jZS53b3JkKTtcblxuICAgIGlmICghZGVsZXRlZFZhcmlhdGlvbikge1xuICAgICAgcmV0dXJuIGFsbFNlcXVlbmNlczsgLy8gTm8gdmFyaWF0aW9uIG51bWJlciB0byBmaXhcbiAgICB9XG5cbiAgICBjb25zdCB1cGRhdGVkU2VxdWVuY2VzID0gYWxsU2VxdWVuY2VzLm1hcCgoc2VxdWVuY2UpID0+IHtcbiAgICAgIC8vIFNraXAgdGhlIHNlcXVlbmNlIGJlaW5nIGRlbGV0ZWRcbiAgICAgIGlmIChzZXF1ZW5jZS5pZCA9PT0gZGVsZXRlZFNlcXVlbmNlLmlkKSB7XG4gICAgICAgIHJldHVybiBzZXF1ZW5jZTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc2VxdWVuY2VCYXNlV29yZCA9IHRoaXMuZXh0cmFjdEJhc2VXb3JkKHNlcXVlbmNlLndvcmQpO1xuICAgICAgY29uc3Qgc2VxdWVuY2VWYXJpYXRpb24gPSB0aGlzLmV4dHJhY3RWYXJpYXRpb25OdW1iZXIoc2VxdWVuY2Uud29yZCk7XG5cbiAgICAgIC8vIE9ubHkgZml4IHNlcXVlbmNlcyB3aXRoIHRoZSBzYW1lIGJhc2Ugd29yZCBhbmQgaGlnaGVyIHZhcmlhdGlvbiBudW1iZXJzXG4gICAgICBpZiAoXG4gICAgICAgIHNlcXVlbmNlQmFzZVdvcmQgPT09IGJhc2VXb3JkICYmXG4gICAgICAgIHNlcXVlbmNlVmFyaWF0aW9uICYmXG4gICAgICAgIHNlcXVlbmNlVmFyaWF0aW9uID4gZGVsZXRlZFZhcmlhdGlvblxuICAgICAgKSB7XG4gICAgICAgIGNvbnN0IG5ld1ZhcmlhdGlvbk51bWJlciA9IHNlcXVlbmNlVmFyaWF0aW9uIC0gMTtcbiAgICAgICAgY29uc3QgbmV3V29yZCA9IHRoaXMuY3JlYXRlV29yZFdpdGhWYXJpYXRpb24oXG4gICAgICAgICAgYmFzZVdvcmQsXG4gICAgICAgICAgbmV3VmFyaWF0aW9uTnVtYmVyXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAuLi5zZXF1ZW5jZSxcbiAgICAgICAgICB3b3JkOiBuZXdXb3JkLFxuICAgICAgICAgIG5hbWU6IHNlcXVlbmNlLm5hbWUucmVwbGFjZShzZXF1ZW5jZS53b3JkLCBuZXdXb3JkKSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHNlcXVlbmNlO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHVwZGF0ZWRTZXF1ZW5jZXM7XG4gIH1cblxuICBhc3luYyBjYW5EZWxldGVTZXF1ZW5jZShcbiAgICBzZXF1ZW5jZTogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YSxcbiAgICBfYWxsU2VxdWVuY2VzOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW11cbiAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgLy8gQ2hlY2sgaWYgdGhpcyBpcyBhIHN5c3RlbSBvciBwcm90ZWN0ZWQgc2VxdWVuY2UgKGNoZWNrIG1ldGFkYXRhKVxuICAgIGNvbnN0IGlzUHJvdGVjdGVkID0gc2VxdWVuY2UubWV0YWRhdGE/LmlzUHJvdGVjdGVkIGFzIGJvb2xlYW47XG4gICAgY29uc3QgaXNTeXN0ZW0gPSBzZXF1ZW5jZS5tZXRhZGF0YT8uaXNTeXN0ZW0gYXMgYm9vbGVhbjtcblxuICAgIGlmIChpc1Byb3RlY3RlZCB8fCBpc1N5c3RlbSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHVzZXIgaGFzIHBlcm1pc3Npb24gdG8gZGVsZXRlICh3b3VsZCBiZSBiYXNlZCBvbiBhdXRob3JzaGlwIGluIHJlYWwgYXBwKVxuICAgIGlmIChzZXF1ZW5jZS5hdXRob3IgJiYgc2VxdWVuY2UuYXV0aG9yICE9PSBcImN1cnJlbnQtdXNlclwiKSB7XG4gICAgICAvLyBJbiBhIHJlYWwgYXBwLCB0aGlzIHdvdWxkIGNoZWNrIHVzZXIgcGVybWlzc2lvbnNcbiAgICAgIC8vIEZvciBub3csIGFsbG93IGRlbGV0aW9uIG9mIGRlbW8gc2VxdWVuY2VzXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGFzeW5jIGdldEFmZmVjdGVkU2VxdWVuY2VzKFxuICAgIHNlcXVlbmNlOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhLFxuICAgIGFsbFNlcXVlbmNlczogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdXG4gICk6IFByb21pc2U8QnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdPiB7XG4gICAgY29uc3QgYWZmZWN0ZWQ6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXSA9IFtdO1xuICAgIGNvbnN0IGJhc2VXb3JkID0gdGhpcy5leHRyYWN0QmFzZVdvcmQoc2VxdWVuY2Uud29yZCk7XG4gICAgY29uc3QgZGVsZXRlZFZhcmlhdGlvbiA9IHRoaXMuZXh0cmFjdFZhcmlhdGlvbk51bWJlcihzZXF1ZW5jZS53b3JkKTtcblxuICAgIGlmICghZGVsZXRlZFZhcmlhdGlvbikge1xuICAgICAgcmV0dXJuIGFmZmVjdGVkO1xuICAgIH1cblxuICAgIC8vIEZpbmQgc2VxdWVuY2VzIHRoYXQgd2lsbCBoYXZlIHRoZWlyIHZhcmlhdGlvbiBudW1iZXJzIGFkanVzdGVkXG4gICAgYWxsU2VxdWVuY2VzLmZvckVhY2goKHNlcSkgPT4ge1xuICAgICAgaWYgKHNlcS5pZCA9PT0gc2VxdWVuY2UuaWQpIHJldHVybjtcblxuICAgICAgY29uc3Qgc2VxQmFzZVdvcmQgPSB0aGlzLmV4dHJhY3RCYXNlV29yZChzZXEud29yZCk7XG4gICAgICBjb25zdCBzZXFWYXJpYXRpb24gPSB0aGlzLmV4dHJhY3RWYXJpYXRpb25OdW1iZXIoc2VxLndvcmQpO1xuXG4gICAgICBpZiAoXG4gICAgICAgIHNlcUJhc2VXb3JkID09PSBiYXNlV29yZCAmJlxuICAgICAgICBzZXFWYXJpYXRpb24gJiZcbiAgICAgICAgc2VxVmFyaWF0aW9uID4gZGVsZXRlZFZhcmlhdGlvblxuICAgICAgKSB7XG4gICAgICAgIGFmZmVjdGVkLnB1c2goc2VxKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBhZmZlY3RlZDtcbiAgfVxuXG4gIC8vIFByaXZhdGUgaGVscGVyIG1ldGhvZHNcbiAgcHJpdmF0ZSBmaW5kUmVsYXRlZFNlcXVlbmNlcyhcbiAgICBzZXF1ZW5jZTogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YSxcbiAgICBhbGxTZXF1ZW5jZXM6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGFbXVxuICApOiBCcm93c2VTZXF1ZW5jZU1ldGFkYXRhW10ge1xuICAgIGNvbnN0IGJhc2VXb3JkID0gdGhpcy5leHRyYWN0QmFzZVdvcmQoc2VxdWVuY2Uud29yZCk7XG5cbiAgICByZXR1cm4gYWxsU2VxdWVuY2VzLmZpbHRlcigoc2VxKSA9PiB7XG4gICAgICBpZiAoc2VxLmlkID09PSBzZXF1ZW5jZS5pZCkgcmV0dXJuIGZhbHNlO1xuICAgICAgY29uc3Qgc2VxQmFzZVdvcmQgPSB0aGlzLmV4dHJhY3RCYXNlV29yZChzZXEud29yZCk7XG4gICAgICByZXR1cm4gc2VxQmFzZVdvcmQgPT09IGJhc2VXb3JkO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBuZWVkc1ZhcmlhdGlvbk51bWJlckZpeChcbiAgICBkZWxldGVkU2VxdWVuY2U6IEJyb3dzZVNlcXVlbmNlTWV0YWRhdGEsXG4gICAgcmVsYXRlZFNlcXVlbmNlczogQnJvd3NlU2VxdWVuY2VNZXRhZGF0YVtdXG4gICk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGRlbGV0ZWRWYXJpYXRpb24gPSB0aGlzLmV4dHJhY3RWYXJpYXRpb25OdW1iZXIoZGVsZXRlZFNlcXVlbmNlLndvcmQpO1xuICAgIGlmICghZGVsZXRlZFZhcmlhdGlvbikgcmV0dXJuIGZhbHNlO1xuXG4gICAgLy8gQ2hlY2sgaWYgdGhlcmUgYXJlIHNlcXVlbmNlcyB3aXRoIGhpZ2hlciB2YXJpYXRpb24gbnVtYmVyc1xuICAgIHJldHVybiByZWxhdGVkU2VxdWVuY2VzLnNvbWUoKHNlcSkgPT4ge1xuICAgICAgY29uc3QgdmFyaWF0aW9uID0gdGhpcy5leHRyYWN0VmFyaWF0aW9uTnVtYmVyKHNlcS53b3JkKTtcbiAgICAgIHJldHVybiB2YXJpYXRpb24gJiYgdmFyaWF0aW9uID4gZGVsZXRlZFZhcmlhdGlvbjtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdEJhc2VXb3JkKHdvcmQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gRXh0cmFjdCBiYXNlIHdvcmQgZnJvbSB2YXJpYXRpb25zIGxpa2UgXCJDQUtFX3YyXCIgb3IgXCJBQkMtMlwiXG4gICAgY29uc3QgbWF0Y2ggPSB3b3JkLm1hdGNoKC9eKFtBLVpdKykoPzpbXy1ddj8oXFxkKykpPyQvaSk7XG4gICAgcmV0dXJuIG1hdGNoICYmIG1hdGNoWzFdID8gbWF0Y2hbMV0gOiB3b3JkO1xuICB9XG5cbiAgcHJpdmF0ZSBleHRyYWN0VmFyaWF0aW9uTnVtYmVyKHdvcmQ6IHN0cmluZyk6IG51bWJlciB8IG51bGwge1xuICAgIC8vIEV4dHJhY3QgdmFyaWF0aW9uIG51bWJlciBmcm9tIHdvcmRzIGxpa2UgXCJDQUtFX3YyXCIgb3IgXCJBQkMtMlwiXG4gICAgY29uc3QgbWF0Y2ggPSB3b3JkLm1hdGNoKC9bXy1ddj8oXFxkKykkL2kpO1xuICAgIHJldHVybiBtYXRjaCAmJiBtYXRjaFsxXSA/IHBhcnNlSW50KG1hdGNoWzFdKSA6IG51bGw7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVdvcmRXaXRoVmFyaWF0aW9uKGJhc2VXb3JkOiBzdHJpbmcsIHZhcmlhdGlvbjogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBpZiAodmFyaWF0aW9uIDw9IDEpIHtcbiAgICAgIHJldHVybiBiYXNlV29yZDtcbiAgICB9XG4gICAgcmV0dXJuIGAke2Jhc2VXb3JkfV92JHt2YXJpYXRpb259YDtcbiAgfVxuXG4gIC8vIFV0aWxpdHkgbWV0aG9kcyBmb3IgVUkgY29tcG9uZW50c1xuICBhc3luYyBmb3JtYXREZWxldGVDb25maXJtYXRpb25NZXNzYWdlKFxuICAgIGRhdGE6IERlbGV0ZUNvbmZpcm1hdGlvbkRhdGFcbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCB7XG4gICAgICBzZXF1ZW5jZSxcbiAgICAgIHJlbGF0ZWRTZXF1ZW5jZXMsXG4gICAgICBoYXNWYXJpYXRpb25zLFxuICAgICAgd2lsbEZpeFZhcmlhdGlvbk51bWJlcnMsXG4gICAgfSA9IGRhdGE7XG5cbiAgICBsZXQgbWVzc2FnZSA9IGBBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gZGVsZXRlIFwiJHtzZXF1ZW5jZS53b3JkfVwiP2A7XG5cbiAgICBpZiAoaGFzVmFyaWF0aW9ucykge1xuICAgICAgbWVzc2FnZSArPSBgXFxuXFxuVGhpcyBzZXF1ZW5jZSBoYXMgJHtyZWxhdGVkU2VxdWVuY2VzLmxlbmd0aH0gcmVsYXRlZCB2YXJpYXRpb24ocykuYDtcblxuICAgICAgaWYgKHdpbGxGaXhWYXJpYXRpb25OdW1iZXJzKSB7XG4gICAgICAgIG1lc3NhZ2UgKz1cbiAgICAgICAgICBcIlxcblZhcmlhdGlvbiBudW1iZXJzIHdpbGwgYmUgYXV0b21hdGljYWxseSB1cGRhdGVkIHRvIG1haW50YWluIHNlcXVlbmNlLlwiO1xuICAgICAgfVxuICAgIH1cblxuICAgIG1lc3NhZ2UgKz0gXCJcXG5cXG5UaGlzIGFjdGlvbiBjYW5ub3QgYmUgdW5kb25lLlwiO1xuXG4gICAgcmV0dXJuIG1lc3NhZ2U7XG4gIH1cblxuICBhc3luYyBnZXREZWxldGVCdXR0b25UZXh0KGRhdGE6IERlbGV0ZUNvbmZpcm1hdGlvbkRhdGEpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmIChkYXRhLndpbGxGaXhWYXJpYXRpb25OdW1iZXJzKSB7XG4gICAgICByZXR1cm4gXCJEZWxldGUgJiBGaXggVmFyaWF0aW9uc1wiO1xuICAgIH1cbiAgICByZXR1cm4gXCJEZWxldGUgU2VxdWVuY2VcIjtcbiAgfVxufVxuIl0sCiAgIm1hcHBpbmdzIjogIkFBdURPLGFBQU0sY0FBd0M7QUFBQSxFQUNuRCxNQUFNLDBCQUNKLFVBQ0EsY0FDaUM7QUFDakMsVUFBTSxtQkFBbUIsS0FBSyxxQkFBcUIsVUFBVSxZQUFZO0FBQ3pFLFVBQU0sZ0JBQWdCLGlCQUFpQixTQUFTO0FBQ2hELFVBQU0sMEJBQ0osaUJBQWlCLEtBQUssd0JBQXdCLFVBQVUsZ0JBQWdCO0FBRTFFLFdBQU87QUFBQSxNQUNMO0FBQUEsTUFDQTtBQUFBLE1BQ0E7QUFBQSxNQUNBO0FBQUEsSUFDRjtBQUFBLEVBQ0Y7QUFBQSxFQVdBLE1BQU0sZUFDSixjQUNBLGNBQ3VCO0FBQ3ZCLFFBQUk7QUFDRixZQUFNLFdBQ0osT0FBTyxpQkFBaUIsV0FDcEIsYUFBYSxLQUFLLENBQUMsUUFBUSxJQUFJLE9BQU8sWUFBWSxJQUNsRDtBQUNOLFVBQUksQ0FBQyxVQUFVO0FBQ2IsZUFBTztBQUFBLFVBQ0wsU0FBUztBQUFBLFVBQ1QsaUJBQWlCO0FBQUEsVUFDakIsbUJBQW1CLENBQUM7QUFBQSxVQUNwQixPQUFPO0FBQUEsUUFDVDtBQUFB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
