import { GridMode } from "/src/lib/domain/enums.ts";
import { SpecialPlacementOriKeyGenerator } from "/src/lib/services/positioning/arrows/key_generators/SpecialPlacementOriKeyGenerator.ts";
import { jsonCache } from "/src/lib/services/positioning/cache/SimpleJsonCache.ts";
export class SpecialPlacementService {
  // Structure: [gridMode][oriKey][letter] -> Record<string, unknown>
  specialPlacements = {};
  loadingCache = /* @__PURE__ */ new Set();
  oriKeyGenerator;
  constructor() {
    this.specialPlacements = { diamond: {}, box: {} };
    this.oriKeyGenerator = new SpecialPlacementOriKeyGenerator();
  }
  /**
   * Get special adjustment for arrow based on special placement logic.
   *
   * @param motionData Motion data containing motion information
   * @param pictographData Pictograph data containing letter and context
   * @param arrowColor Color of the arrow ('red' or 'blue') - if not provided, will try to determine from motion
   * @returns Point with special adjustment or null if no special placement found
   */
  async getSpecialAdjustment(motionData, pictographData, arrowColor) {
    if (!motionData || !pictographData.letter) {
      return null;
    }
    const motion = motionData;
    const letter = pictographData.letter;
    const oriKey = this.oriKeyGenerator.generateOrientationKey(
      motion,
      pictographData
    );
    const gridMode = pictographData.gridData?.gridMode || pictographData.gridMode || GridMode.DIAMOND;
    const turnsTuple = this.generateTurnsTuple(pictographData);
    await this.ensureLetterPlacementsLoaded(gridMode, oriKey, letter);
    const letterData = this.specialPlacements[gridMode]?.[oriKey]?.[letter];
    if (!letterData) {
      return null;
    }
    const turnData = letterData?.[turnsTuple];
    if (!turnData) {
      return null;
    }
    let colorKey = "";
    if (arrowColor) {
      colorKey = arrowColor;
    } else if (pictographData.motions?.blue && pictographData.motions.blue === motion) {
      colorKey = "blue";
    } else if (pictographData.motions?.red && pictographData.motions.red === motion) {
      colorKey = "red";
    } else {
      colorKey = "blue";
    }
    if (colorKey in turnData) {
      const adjustmentValues = turnData[colorKey];
      if (Array.isArray(adjustmentValues) && adjustmentValues.length === 2) {
        return { x: adjustmentValues[0], y: adjustmentValues[1] };
      }
    }
    const motionTypeKey = motionData.motionType?.toLowerCase() || "";
    if (motionTypeKey in turnData) {
      const adjustmentValues = turnData[motionTypeKey];
      if (Array.isArray(adjustmentValues) && adjustmentValues.length === 2) {
        return { x: adjustmentValues[0], y: adjustmentValues[1] };
      }
    }
    return null;
  }
  /**
   * Load special placement data from JSON configuration files.
   */
  async ensureLetterPlacementsLoaded(gridMode, oriKey, letter) {
    try {
      if (!this.specialPlacements[gridMode]) {
        this.specialPlacements[gridMode] = {};
      }
      if (!this.specialPlacements[gridMode][oriKey]) {
        this.specialPlacements[gridMode][oriKey] = {};
      }
      if (this.specialPlacements[gridMode][oriKey][letter]) {
        return;
      }
      const cacheKey = `${gridMode}:${oriKey}:${letter}`;
      if (this.loadingCache.has(cacheKey)) {
        return;
      }
      this.loadingCache.add(cacheKey);
      const encodedLetter = encodeURIComponent(letter);
      const basePath = `/data/arrow_placement/${gridMode}/special/${oriKey}/${encodedLetter}_placements.json`;
      try {
        const data = await jsonCache.get(basePath);
        this.specialPlacements[gridMode][oriKey][letter] = data;
      } catch (error) {
        this.specialPlacements[gridMode][oriKey][letter] = {};
      }
    } catch (error) {
      console.error("Error ensuring special placement data:", error);
    }
  }
  /**
   * Generate turns tuple string matching the turns_tuple_generator logic.
   *
   * This creates a string representation of the turn values for lookup in JSON data.
   * Format: "(blue_turns, red_turns)" e.g., "(0, 1.5)", "(1, 0.5)"
   */
  generateTurnsTuple(pictographData) {
    try {
      const blueMotion = pictographData.motions?.blue;
      const redMotion = pictographData.motions?.red;
      if (blueMotion && redMotion) {
        const blueTurns = typeof blueMotion.turns === "number" ? blueMotion.turns : 0;
        const redTurns = typeof redMotion.turns === "number" ? redMotion.turns : 0;
        const blueStr = blueTurns === Math.floor(blueTurns) ? Math.floor(blueTurns).toString() : blueTurns.toString();
        const redStr = redTurns === Math.floor(redTurns) ? Math.floor(redTurns).toString() : redTurns.toString();
        return `(${blueStr}, ${redStr})`;
      }
      return "(0, 0)";
    } catch (error) {
      return "(0, 0)";
    }
  }
}
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiQzovVEtBL3dlYi9zcmMvbGliL3NlcnZpY2VzL3Bvc2l0aW9uaW5nL2Fycm93cy9wbGFjZW1lbnQvU3BlY2lhbFBsYWNlbWVudFNlcnZpY2UudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbIi8qKlxuICogU3BlY2lhbCBQbGFjZW1lbnQgU2VydmljZSBmb3IgTW9kZXJuIEFycm93IFBvc2l0aW9uaW5nXG4gKlxuICogVGhpcyBzZXJ2aWNlIGltcGxlbWVudHMgc3BlY2lhbCBwbGFjZW1lbnQgbG9naWMgdXNpbmcgdGhlIHNhbWUgSlNPTiBjb25maWd1cmF0aW9uIGRhdGEuXG4gKiBJdCBwcm92aWRlcyBwaXhlbC1wZXJmZWN0IHNwZWNpYWwgcGxhY2VtZW50IGFkanVzdG1lbnRzIGZvciBzcGVjaWZpYyBwaWN0b2dyYXBoIGNvbmZpZ3VyYXRpb25zLlxuICpcbiAqIElNUExFTUVOVFMgU1BFQ0lBTCBQTEFDRU1FTlQgUElQRUxJTkU6XG4gKiAtIExvYWRzIHNwZWNpYWwgcGxhY2VtZW50IEpTT04gZmlsZXMgZnJvbSBzdGF0aWMvZGF0YS9hcnJvd19wbGFjZW1lbnQgZGlyZWN0b3J5XG4gKiAtIEdlbmVyYXRlcyBvcmllbnRhdGlvbiBrZXlzIChvcmlfa2V5KSBmb3IgbW90aW9uIGNsYXNzaWZpY2F0aW9uXG4gKiAtIEFwcGxpZXMgbGV0dGVyLXNwZWNpZmljLCB0dXJuLXNwZWNpZmljLCBhbmQgbW90aW9uLXR5cGUtc3BlY2lmaWMgYWRqdXN0bWVudHNcbiAqIC0gSGFuZGxlcyBjb21wbGV4IHBsYWNlbWVudCBydWxlcyBmb3Igc3BlY2lmaWMgcGljdG9ncmFwaCBwYXR0ZXJuc1xuICpcbiAqIERpcmVjdCBUeXBlU2NyaXB0IG1pcnJvciBvZiByZWZlcmVuY2UvbW9kZXJuL2FwcGxpY2F0aW9uL3NlcnZpY2VzL3Bvc2l0aW9uaW5nL2Fycm93cy9wbGFjZW1lbnQvc3BlY2lhbF9wbGFjZW1lbnRfc2VydmljZS5weVxuICovXG5cbmltcG9ydCB0eXBlIHsgTW90aW9uRGF0YSwgUGljdG9ncmFwaERhdGEgfSBmcm9tIFwiJGxpYi9kb21haW5cIjtcbmltcG9ydCB7IEdyaWRNb2RlIH0gZnJvbSBcIiRsaWIvZG9tYWluL2VudW1zXCI7XG5pbXBvcnQgdHlwZSB7IElTcGVjaWFsUGxhY2VtZW50U2VydmljZSB9IGZyb20gXCIuLi8uLi9wbGFjZW1lbnQtc2VydmljZXNcIjtcbmltcG9ydCB7IFNwZWNpYWxQbGFjZW1lbnRPcmlLZXlHZW5lcmF0b3IgfSBmcm9tIFwiLi4va2V5X2dlbmVyYXRvcnMvU3BlY2lhbFBsYWNlbWVudE9yaUtleUdlbmVyYXRvclwiO1xuaW1wb3J0IHsganNvbkNhY2hlIH0gZnJvbSBcIi4uLy4uL2NhY2hlL1NpbXBsZUpzb25DYWNoZVwiO1xuXG4vLyBEZWZpbmUgUG9pbnQgaW50ZXJmYWNlIGxvY2FsbHkgc2luY2UgaXQgbWlnaHQgbm90IGJlIGluIGRvbWFpblxuaW50ZXJmYWNlIFBvaW50IHtcbiAgeDogbnVtYmVyO1xuICB5OiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBTcGVjaWFsUGxhY2VtZW50U2VydmljZSBpbXBsZW1lbnRzIElTcGVjaWFsUGxhY2VtZW50U2VydmljZSB7XG4gIC8vIFN0cnVjdHVyZTogW2dyaWRNb2RlXVtvcmlLZXldW2xldHRlcl0gLT4gUmVjb3JkPHN0cmluZywgdW5rbm93bj5cbiAgcHJpdmF0ZSBzcGVjaWFsUGxhY2VtZW50czogUmVjb3JkPFxuICAgIHN0cmluZyxcbiAgICBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPj4+XG4gID4gPSB7fTtcbiAgcHJpdmF0ZSBsb2FkaW5nQ2FjaGU6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpO1xuICBwcml2YXRlIG9yaUtleUdlbmVyYXRvcjogU3BlY2lhbFBsYWNlbWVudE9yaUtleUdlbmVyYXRvcjtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICAvLyBEZWZlciBsb2FkaW5nOyB3ZSdsbCBsYXppbHkgbG9hZCBwZXItbGV0dGVyIG9uIGRlbWFuZFxuICAgIHRoaXMuc3BlY2lhbFBsYWNlbWVudHMgPSB7IGRpYW1vbmQ6IHt9LCBib3g6IHt9IH0gYXMgUmVjb3JkPFxuICAgICAgc3RyaW5nLFxuICAgICAgUmVjb3JkPHN0cmluZywgUmVjb3JkPHN0cmluZywgUmVjb3JkPHN0cmluZywgdW5rbm93bj4+PlxuICAgID47XG4gICAgdGhpcy5vcmlLZXlHZW5lcmF0b3IgPSBuZXcgU3BlY2lhbFBsYWNlbWVudE9yaUtleUdlbmVyYXRvcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBzcGVjaWFsIGFkanVzdG1lbnQgZm9yIGFycm93IGJhc2VkIG9uIHNwZWNpYWwgcGxhY2VtZW50IGxvZ2ljLlxuICAgKlxuICAgKiBAcGFyYW0gbW90aW9uRGF0YSBNb3Rpb24gZGF0YSBjb250YWluaW5nIG1vdGlvbiBpbmZvcm1hdGlvblxuICAgKiBAcGFyYW0gcGljdG9ncmFwaERhdGEgUGljdG9ncmFwaCBkYXRhIGNvbnRhaW5pbmcgbGV0dGVyIGFuZCBjb250ZXh0XG4gICAqIEBwYXJhbSBhcnJvd0NvbG9yIENvbG9yIG9mIHRoZSBhcnJvdyAoJ3JlZCcgb3IgJ2JsdWUnKSAtIGlmIG5vdCBwcm92aWRlZCwgd2lsbCB0cnkgdG8gZGV0ZXJtaW5lIGZyb20gbW90aW9uXG4gICAqIEByZXR1cm5zIFBvaW50IHdpdGggc3BlY2lhbCBhZGp1c3RtZW50IG9yIG51bGwgaWYgbm8gc3BlY2lhbCBwbGFjZW1lbnQgZm91bmRcbiAgICovXG4gIGFzeW5jIGdldFNwZWNpYWxBZGp1c3RtZW50KFxuICAgIG1vdGlvbkRhdGE6IE1vdGlvbkRhdGEsXG4gICAgcGljdG9ncmFwaERhdGE6IFBpY3RvZ3JhcGhEYXRhLFxuICAgIGFycm93Q29sb3I/OiBzdHJpbmdcbiAgKTogUHJvbWlzZTxQb2ludCB8IG51bGw+IHtcbiAgICBpZiAoIW1vdGlvbkRhdGEgfHwgIXBpY3RvZ3JhcGhEYXRhLmxldHRlcikge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgbW90aW9uID0gbW90aW9uRGF0YTtcbiAgICBjb25zdCBsZXR0ZXIgPSBwaWN0b2dyYXBoRGF0YS5sZXR0ZXI7XG5cbiAgICAvLyBHZW5lcmF0ZSBvcmllbnRhdGlvbiBrZXkgdXNpbmcgdmFsaWRhdGVkIGxvZ2ljXG4gICAgY29uc3Qgb3JpS2V5ID0gdGhpcy5vcmlLZXlHZW5lcmF0b3IuZ2VuZXJhdGVPcmllbnRhdGlvbktleShcbiAgICAgIG1vdGlvbixcbiAgICAgIHBpY3RvZ3JhcGhEYXRhXG4gICAgKTtcblxuICAgIC8vIEdldCBncmlkIG1vZGUgKGRlZmF1bHQgdG8gZGlhbW9uZClcbiAgICBjb25zdCBncmlkTW9kZSA9XG4gICAgICBwaWN0b2dyYXBoRGF0YS5ncmlkRGF0YT8uZ3JpZE1vZGUgfHxcbiAgICAgIHBpY3RvZ3JhcGhEYXRhLmdyaWRNb2RlIHx8XG4gICAgICBHcmlkTW9kZS5ESUFNT05EO1xuXG4gICAgLy8gR2VuZXJhdGUgdHVybnMgdHVwbGUgZm9yIGxvb2t1cFxuICAgIGNvbnN0IHR1cm5zVHVwbGUgPSB0aGlzLmdlbmVyYXRlVHVybnNUdXBsZShwaWN0b2dyYXBoRGF0YSk7XG5cbiAgICAvLyBFbnN1cmUgdGhlIGxldHRlci1zcGVjaWZpYyBzcGVjaWFsIHBsYWNlbWVudCBkYXRhIGlzIGxvYWRlZCBsYXppbHlcbiAgICBhd2FpdCB0aGlzLmVuc3VyZUxldHRlclBsYWNlbWVudHNMb2FkZWQoZ3JpZE1vZGUsIG9yaUtleSwgbGV0dGVyKTtcblxuICAgIC8vIExvb2sgdXAgc3BlY2lhbCBwbGFjZW1lbnQgZGF0YVxuICAgIGNvbnN0IGxldHRlckRhdGEgPSB0aGlzLnNwZWNpYWxQbGFjZW1lbnRzW2dyaWRNb2RlXT8uW29yaUtleV0/LltsZXR0ZXJdIGFzXG4gICAgICB8IFJlY29yZDxzdHJpbmcsIHVua25vd24+XG4gICAgICB8IHVuZGVmaW5lZDtcblxuICAgIGlmICghbGV0dGVyRGF0YSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gR2V0IHR1cm4tc3BlY2lmaWMgZGF0YVxuICAgIGNvbnN0IHR1cm5EYXRhID0gbGV0dGVyRGF0YT8uW3R1cm5zVHVwbGVdIGFzXG4gICAgICB8IFJlY29yZDxzdHJpbmcsIHVua25vd24+XG4gICAgICB8IHVuZGVmaW5lZDtcblxuICAgIGlmICghdHVybkRhdGEpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8vIEZpcnN0LCB0cnkgZGlyZWN0IGNvbG9yLWJhc2VkIGNvb3JkaW5hdGUgbG9va3VwIChtb3N0IGNvbW1vbiBjYXNlKVxuICAgIGxldCBjb2xvcktleSA9IFwiXCI7XG4gICAgaWYgKGFycm93Q29sb3IpIHtcbiAgICAgIC8vIFVzZSBwcm92aWRlZCBhcnJvdyBjb2xvciBkaXJlY3RseVxuICAgICAgY29sb3JLZXkgPSBhcnJvd0NvbG9yO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICBwaWN0b2dyYXBoRGF0YS5tb3Rpb25zPy5ibHVlICYmXG4gICAgICBwaWN0b2dyYXBoRGF0YS5tb3Rpb25zLmJsdWUgPT09IG1vdGlvblxuICAgICkge1xuICAgICAgY29sb3JLZXkgPSBcImJsdWVcIjtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgcGljdG9ncmFwaERhdGEubW90aW9ucz8ucmVkICYmXG4gICAgICBwaWN0b2dyYXBoRGF0YS5tb3Rpb25zLnJlZCA9PT0gbW90aW9uXG4gICAgKSB7XG4gICAgICBjb2xvcktleSA9IFwicmVkXCI7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEZhbGxiYWNrOiB0cnkgdG8gZGV0ZXJtaW5lIGZyb20gbW90aW9uIGRhdGFcbiAgICAgIGNvbG9yS2V5ID0gXCJibHVlXCI7IC8vIERlZmF1bHQgZmFsbGJhY2tcbiAgICB9XG5cbiAgICBpZiAoY29sb3JLZXkgaW4gdHVybkRhdGEpIHtcbiAgICAgIGNvbnN0IGFkanVzdG1lbnRWYWx1ZXMgPSB0dXJuRGF0YVtjb2xvcktleV07XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShhZGp1c3RtZW50VmFsdWVzKSAmJiBhZGp1c3RtZW50VmFsdWVzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICByZXR1cm4geyB4OiBhZGp1c3RtZW50VmFsdWVzWzBdLCB5OiBhZGp1c3RtZW50VmFsdWVzWzFdIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gU2Vjb25kLCB0cnkgbW90aW9uLXR5cGUtc3BlY2lmaWMgYWRqdXN0bWVudCAoZm9yIGxldHRlcnMgbGlrZSBJKVxuICAgIGNvbnN0IG1vdGlvblR5cGVLZXkgPSBtb3Rpb25EYXRhLm1vdGlvblR5cGU/LnRvTG93ZXJDYXNlKCkgfHwgXCJcIjtcblxuICAgIGlmIChtb3Rpb25UeXBlS2V5IGluIHR1cm5EYXRhKSB7XG4gICAgICBjb25zdCBhZGp1c3RtZW50VmFsdWVzID0gdHVybkRhdGFbbW90aW9uVHlwZUtleV07XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShhZGp1c3RtZW50VmFsdWVzKSAmJiBhZGp1c3RtZW50VmFsdWVzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICByZXR1cm4geyB4OiBhZGp1c3RtZW50VmFsdWVzWzBdLCB5OiBhZGp1c3RtZW50VmFsdWVzWzFdIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvKipcbiAgICogTG9hZCBzcGVjaWFsIHBsYWNlbWVudCBkYXRhIGZyb20gSlNPTiBjb25maWd1cmF0aW9uIGZpbGVzLlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBlbnN1cmVMZXR0ZXJQbGFjZW1lbnRzTG9hZGVkKFxuICAgIGdyaWRNb2RlOiBzdHJpbmcsXG4gICAgb3JpS2V5OiBzdHJpbmcsXG4gICAgbGV0dGVyOiBzdHJpbmdcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghdGhpcy5zcGVjaWFsUGxhY2VtZW50c1tncmlkTW9kZV0pIHtcbiAgICAgICAgdGhpcy5zcGVjaWFsUGxhY2VtZW50c1tncmlkTW9kZV0gPSB7fSBhcyBSZWNvcmQ8XG4gICAgICAgICAgc3RyaW5nLFxuICAgICAgICAgIFJlY29yZDxzdHJpbmcsIFJlY29yZDxzdHJpbmcsIHVua25vd24+PlxuICAgICAgICA+O1xuICAgICAgfVxuICAgICAgaWYgKCF0aGlzLnNwZWNpYWxQbGFjZW1lbnRzW2dyaWRNb2RlXVtvcmlLZXldKSB7XG4gICAgICAgIHRoaXMuc3BlY2lhbFBsYWNlbWVudHNbZ3JpZE1vZGVdW29yaUtleV0gPSB7fSBhcyBSZWNvcmQ8XG4gICAgICAgICAgc3RyaW5nLFxuICAgICAgICAgIFJlY29yZDxzdHJpbmcsIHVua25vd24+XG4gICAgICAgID47XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5zcGVjaWFsUGxhY2VtZW50c1tncmlkTW9kZV1bb3JpS2V5XVtsZXR0ZXJdKSB7XG4gICAgICAgIHJldHVybjsgLy8gYWxyZWFkeSBsb2FkZWRcbiAgICAgIH1cblxuICAgICAgY29uc3QgY2FjaGVLZXkgPSBgJHtncmlkTW9kZX06JHtvcmlLZXl9OiR7bGV0dGVyfWA7XG4gICAgICBpZiAodGhpcy5sb2FkaW5nQ2FjaGUuaGFzKGNhY2hlS2V5KSkge1xuICAgICAgICByZXR1cm47IC8vIGxvYWRpbmcgaW4gcHJvZ3Jlc3Mgb3IgYWxyZWFkeSBhdHRlbXB0ZWRcbiAgICAgIH1cbiAgICAgIHRoaXMubG9hZGluZ0NhY2hlLmFkZChjYWNoZUtleSk7XG5cbiAgICAgIC8vIEZpbGVzIGFyZSBzZXJ2ZWQgdW5kZXIgL2RhdGEvLi4uIGluIHRoZSB3ZWIgYXBwXG4gICAgICAvLyBFeGFtcGxlIHBhdGg6IC9kYXRhL2Fycm93X3BsYWNlbWVudC9kaWFtb25kL3NwZWNpYWwvZnJvbV9sYXllcjEvQV9wbGFjZW1lbnRzLmpzb25cbiAgICAgIGNvbnN0IGVuY29kZWRMZXR0ZXIgPSBlbmNvZGVVUklDb21wb25lbnQobGV0dGVyKTtcbiAgICAgIGNvbnN0IGJhc2VQYXRoID0gYC9kYXRhL2Fycm93X3BsYWNlbWVudC8ke2dyaWRNb2RlfS9zcGVjaWFsLyR7b3JpS2V5fS8ke2VuY29kZWRMZXR0ZXJ9X3BsYWNlbWVudHMuanNvbmA7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBkYXRhID0gKGF3YWl0IGpzb25DYWNoZS5nZXQoYmFzZVBhdGgpKSBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbiAgICAgICAgdGhpcy5zcGVjaWFsUGxhY2VtZW50c1tncmlkTW9kZV1bb3JpS2V5XVtsZXR0ZXJdID0gZGF0YTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMuc3BlY2lhbFBsYWNlbWVudHNbZ3JpZE1vZGVdW29yaUtleV1bbGV0dGVyXSA9IHt9O1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgZW5zdXJpbmcgc3BlY2lhbCBwbGFjZW1lbnQgZGF0YTpcIiwgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSB0dXJucyB0dXBsZSBzdHJpbmcgbWF0Y2hpbmcgdGhlIHR1cm5zX3R1cGxlX2dlbmVyYXRvciBsb2dpYy5cbiAgICpcbiAgICogVGhpcyBjcmVhdGVzIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSB0dXJuIHZhbHVlcyBmb3IgbG9va3VwIGluIEpTT04gZGF0YS5cbiAgICogRm9ybWF0OiBcIihibHVlX3R1cm5zLCByZWRfdHVybnMpXCIgZS5nLiwgXCIoMCwgMS41KVwiLCBcIigxLCAwLjUpXCJcbiAgICovXG4gIHByaXZhdGUgZ2VuZXJhdGVUdXJuc1R1cGxlKHBpY3RvZ3JhcGhEYXRhOiBQaWN0b2dyYXBoRGF0YSk6IHN0cmluZyB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGJsdWVNb3Rpb24gPSBwaWN0b2dyYXBoRGF0YS5tb3Rpb25zPy5ibHVlO1xuICAgICAgY29uc3QgcmVkTW90aW9uID0gcGljdG9ncmFwaERhdGEubW90aW9ucz8ucmVkO1xuXG4gICAgICBpZiAoYmx1ZU1vdGlvbiAmJiByZWRNb3Rpb24pIHtcbiAgICAgICAgY29uc3QgYmx1ZVR1cm5zID1cbiAgICAgICAgICB0eXBlb2YgYmx1ZU1vdGlvbi50dXJucyA9PT0gXCJudW1iZXJcIiA/IGJsdWVNb3Rpb24udHVybnMgOiAwO1xuICAgICAgICBjb25zdCByZWRUdXJucyA9XG4gICAgICAgICAgdHlwZW9mIHJlZE1vdGlvbi50dXJucyA9PT0gXCJudW1iZXJcIiA/IHJlZE1vdGlvbi50dXJucyA6IDA7XG5cbiAgICAgICAgY29uc3QgYmx1ZVN0ciA9XG4gICAgICAgICAgYmx1ZVR1cm5zID09PSBNYXRoLmZsb29yKGJsdWVUdXJucylcbiAgICAgICAgICAgID8gTWF0aC5mbG9vcihibHVlVHVybnMpLnRvU3RyaW5nKClcbiAgICAgICAgICAgIDogYmx1ZVR1cm5zLnRvU3RyaW5nKCk7XG4gICAgICAgIGNvbnN0IHJlZFN0ciA9XG4gICAgICAgICAgcmVkVHVybnMgPT09IE1hdGguZmxvb3IocmVkVHVybnMpXG4gICAgICAgICAgICA/IE1hdGguZmxvb3IocmVkVHVybnMpLnRvU3RyaW5nKClcbiAgICAgICAgICAgIDogcmVkVHVybnMudG9TdHJpbmcoKTtcblxuICAgICAgICByZXR1cm4gYCgke2JsdWVTdHJ9LCAke3JlZFN0cn0pYDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIFwiKDAsIDApXCI7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBcIigwLCAwKVwiO1xuICAgIH1cbiAgfVxufVxuIl0sCiAgIm1hcHBpbmdzIjogIkFBZ0JBLFNBQVMsZ0JBQWdCO0FBRXpCLFNBQVMsdUNBQXVDO0FBQ2hELFNBQVMsaUJBQWlCO0FBUW5CLGFBQU0sd0JBQTREO0FBQUE7QUFBQSxFQUUvRCxvQkFHSixDQUFDO0FBQUEsRUFDRyxlQUE0QixvQkFBSSxJQUFJO0FBQUEsRUFDcEM7QUFBQSxFQUVSLGNBQWM7QUFFWixTQUFLLG9CQUFvQixFQUFFLFNBQVMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxFQUFFO0FBSWhELFNBQUss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
