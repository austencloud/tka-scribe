import { SortMethod as SortMethodEnum } from "/src/lib/domain/browse/SortMethod.ts";
import {
  safeSessionStorageGet,
  safeSessionStorageSet,
  safeSessionStorageRemove
} from "/src/lib/utils/safe-storage.ts";
export class FilterPersistenceService {
  CACHE_VERSION = "v2.1";
  // âœ… ROBUST: Cache versioning
  BROWSE_STATE_KEY = `tka-${this.CACHE_VERSION}-browse-state`;
  FILTER_HISTORY_KEY = `tka-${this.CACHE_VERSION}-filter-history`;
  MAX_HISTORY_SIZE = 50;
  async saveBrowseState(state) {
    try {
      const stateToSave = {
        ...state,
        lastUpdated: /* @__PURE__ */ new Date()
      };
      safeSessionStorageSet(this.BROWSE_STATE_KEY, stateToSave);
    } catch (error) {
      console.error("Failed to save browse state:", error);
    }
  }
  async loadBrowseState() {
    try {
      const parsed = safeSessionStorageGet(
        this.BROWSE_STATE_KEY,
        null
      );
      if (!parsed) return null;
      if (parsed.currentFilter && typeof parsed.currentFilter === "object" && parsed.currentFilter !== null && "appliedAt" in parsed.currentFilter) {
        parsed.currentFilter.appliedAt = new Date(
          parsed.currentFilter.appliedAt
        );
      }
      if (parsed.lastUpdated && typeof parsed.lastUpdated === "string") {
        parsed.lastUpdated = new Date(parsed.lastUpdated);
      }
      const oneDay = 24 * 60 * 60 * 1e3;
      if (parsed.lastUpdated instanceof Date && Date.now() - parsed.lastUpdated.getTime() > oneDay) {
        return null;
      }
      return parsed;
    } catch (error) {
      console.warn("Failed to load browse state:", error);
      return null;
    }
  }
  async saveFilterToHistory(filter) {
    try {
      const history = await this.getFilterHistory();
      const filteredHistory = history.filter(
        (f) => !(f.type === filter.type && JSON.stringify(f.value) === JSON.stringify(filter.value))
      );
      const newHistory = [filter, ...filteredHistory];
      const trimmedHistory = newHistory.slice(0, this.MAX_HISTORY_SIZE);
      safeSessionStorageSet(this.FILTER_HISTORY_KEY, trimmedHistory);
    } catch (error) {
      console.error("Failed to save filter to history:", error);
    }
  }
  async getFilterHistory() {
    try {
      const parsed = safeSessionStorageGet(
        this.FILTER_HISTORY_KEY,
        []
      );
      if (!parsed) return [];
      return parsed.map((filter) => {
        const f = filter;
        return {
          ...f,
          appliedAt: new Date(f.appliedAt)
        };
      });
    } catch (error) {
      console.warn("Failed to load filter history:", error);
      return [];
    }
  }
  async clearFilterHistory() {
    safeSessionStorageRemove(this.FILTER_HISTORY_KEY);
  }
  async getRecentFilters(limit = 10) {
    const history = await this.getFilterHistory();
    return history.slice(0, limit);
  }
  async clearAllState() {
    safeSessionStorageRemove(this.BROWSE_STATE_KEY);
    safeSessionStorageRemove(this.FILTER_HISTORY_KEY);
  }
  // Utility methods for filter management
  async getFilterFrequency() {
    const history = await this.getFilterHistory();
    const frequency = /* @__PURE__ */ new Map();
    history.forEach((filter) => {
      const key = `${filter.type}:${JSON.stringify(filter.value)}`;
      frequency.set(key, (frequency.get(key) || 0) + 1);
    });
    return frequency;
  }
  async getMostUsedFilters(limit = 5) {
    const history = await this.getFilterHistory();
    const frequency = await this.getFilterFrequency();
    const filterMap = /* @__PURE__ */ new Map();
    history.forEach((filter) => {
      const key = `${filter.type}:${JSON.stringify(filter.value)}`;
      if (!filterMap.has(key)) {
        filterMap.set(key, filter);
      }
    });
    return Array.from(filterMap.values()).sort((a, b) => {
      const keyA = `${a.type}:${JSON.stringify(a.value)}`;
      const keyB = `${b.type}:${JSON.stringify(b.value)}`;
      return (frequency.get(keyB) || 0) - (frequency.get(keyA) || 0);
    }).slice(0, limit);
  }
  async getDefaultBrowseState() {
    return {
      displayState: {
        currentView: "filter_selection",
        selectedSequence: null,
        isSequenceDetailOpen: false
      },
      loadingState: {
        isLoading: false,
        hasError: false,
        errorMessage: null
      },
      filterState: {
        activeFilters: {
          starting_letter: "",
          contains_letters: "",
          length: "",
          difficulty: "",
          starting_position: "",
          author: "",
          gridMode: "",
          all_sequences: "",
          favorites: "",
          recent: ""
        },
        sortMethod: "alphabetical",
        searchQuery: ""
      }
    };
  }
  // Additional methods required by browse-interfaces.ts
  async saveFilterState(state) {
    const browseState = {
      displayState: {
        currentView: "filter_selection",
        selectedSequence: null,
        isSequenceDetailOpen: false
      },
      loadingState: {
        isLoading: false,
        hasError: false,
        errorMessage: null
      },
      filterState: state
    };
    await this.saveBrowseState(browseState);
  }
  async loadFilterState() {
    const browseState = await this.loadBrowseState();
    return browseState?.filterState || {
      activeFilters: {
        starting_letter: null,
        contains_letters: null,
        length: null,
        difficulty: null,
        starting_position: null,
        author: null,
        gridMode: null,
        all_sequences: null,
        favorites: null,
        recent: null
      },
      sortMethod: SortMethodEnum.ALPHABETICAL,
      searchQuery: ""
    };
  }
}
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiQzovVEtBL3dlYi9zcmMvbGliL3NlcnZpY2VzL2ltcGxlbWVudGF0aW9ucy9wZXJzaXN0ZW5jZS9GaWx0ZXJQZXJzaXN0ZW5jZVNlcnZpY2UudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbIi8qKlxuICogRmlsdGVyIFBlcnNpc3RlbmNlIFNlcnZpY2UgLSBNYW5hZ2VzIGZpbHRlciBzdGF0ZSBwZXJzaXN0ZW5jZVxuICpcbiAqIEhhbmRsZXMgc2F2aW5nIGFuZCByZXN0b3JpbmcgZmlsdGVyIHN0YXRlcyBhY3Jvc3Mgc2Vzc2lvbnMsXG4gKiBmb2xsb3dpbmcgdGhlIG1pY3Jvc2VydmljZXMgYXJjaGl0ZWN0dXJlIHBhdHRlcm4uXG4gKi9cblxuaW1wb3J0IHR5cGUge1xuICBGaWx0ZXJUeXBlLFxuICBGaWx0ZXJWYWx1ZSxcbiAgU29ydE1ldGhvZCxcbn0gZnJvbSBcIi4uLy4uL2ludGVyZmFjZXMvZG9tYWluLXR5cGVzXCI7XG5pbXBvcnQgdHlwZSB7XG4gIEJyb3dzZVN0YXRlLFxuICBGaWx0ZXJTdGF0ZSBhcyBCcm93c2VGaWx0ZXJTdGF0ZSxcbn0gZnJvbSBcIi4uLy4uL2ludGVyZmFjZXMvYnJvd3NlLWludGVyZmFjZXNcIjtcbmltcG9ydCB7IFNvcnRNZXRob2QgYXMgU29ydE1ldGhvZEVudW0gfSBmcm9tIFwiLi4vLi4vLi4vZG9tYWluL2Jyb3dzZS9Tb3J0TWV0aG9kXCI7XG5pbXBvcnQge1xuICBzYWZlU2Vzc2lvblN0b3JhZ2VHZXQsXG4gIHNhZmVTZXNzaW9uU3RvcmFnZVNldCxcbiAgc2FmZVNlc3Npb25TdG9yYWdlUmVtb3ZlLFxufSBmcm9tIFwiJGxpYi91dGlscy9zYWZlLXN0b3JhZ2VcIjtcblxuZXhwb3J0IGludGVyZmFjZSBGaWx0ZXJTdGF0ZSB7XG4gIHR5cGU6IEZpbHRlclR5cGU7XG4gIHZhbHVlOiBGaWx0ZXJWYWx1ZTtcbiAgYXBwbGllZEF0OiBEYXRlO1xufVxuXG4vLyBVc2UgdGhlIEJyb3dzZVN0YXRlIGZyb20gdGhlIGludGVyZmFjZSBpbnN0ZWFkIG9mIGRlZmluaW5nIG91ciBvd25cbi8vIGV4cG9ydCBpbnRlcmZhY2UgQnJvd3NlU3RhdGUge1xuLy8gICBjdXJyZW50RmlsdGVyOiBGaWx0ZXJTdGF0ZSB8IG51bGw7XG4vLyAgIHNvcnRNZXRob2Q6IFNvcnRNZXRob2Q7XG4vLyAgIG5hdmlnYXRpb25Nb2RlOiBcImZpbHRlcl9zZWxlY3Rpb25cIiB8IFwic2VxdWVuY2VfYnJvd3NlclwiO1xuLy8gICBzZWFyY2hRdWVyeTogc3RyaW5nO1xuLy8gICBsYXN0VXBkYXRlZDogRGF0ZTtcbi8vIH1cblxuZXhwb3J0IGludGVyZmFjZSBJRmlsdGVyUGVyc2lzdGVuY2VTZXJ2aWNlIHtcbiAgLyoqIFNhdmUgY3VycmVudCBicm93c2Ugc3RhdGUgKi9cbiAgc2F2ZUJyb3dzZVN0YXRlKHN0YXRlOiBCcm93c2VTdGF0ZSk6IFByb21pc2U8dm9pZD47XG5cbiAgLyoqIExvYWQgc2F2ZWQgYnJvd3NlIHN0YXRlICovXG4gIGxvYWRCcm93c2VTdGF0ZSgpOiBQcm9taXNlPEJyb3dzZVN0YXRlIHwgbnVsbD47XG5cbiAgLyoqIFNhdmUgZmlsdGVyIGhpc3RvcnkgKi9cbiAgc2F2ZUZpbHRlclRvSGlzdG9yeShmaWx0ZXI6IEZpbHRlclN0YXRlKTogUHJvbWlzZTx2b2lkPjtcblxuICAvKiogR2V0IGZpbHRlciBoaXN0b3J5ICovXG4gIGdldEZpbHRlckhpc3RvcnkoKTogUHJvbWlzZTxGaWx0ZXJTdGF0ZVtdPjtcblxuICAvKiogQ2xlYXIgZmlsdGVyIGhpc3RvcnkgKi9cbiAgY2xlYXJGaWx0ZXJIaXN0b3J5KCk6IFByb21pc2U8dm9pZD47XG5cbiAgLyoqIEdldCByZWNlbnRseSB1c2VkIGZpbHRlcnMgKi9cbiAgZ2V0UmVjZW50RmlsdGVycyhsaW1pdD86IG51bWJlcik6IFByb21pc2U8RmlsdGVyU3RhdGVbXT47XG5cbiAgLyoqIENsZWFyIGFsbCBzYXZlZCBzdGF0ZSAqL1xuICBjbGVhckFsbFN0YXRlKCk6IFByb21pc2U8dm9pZD47XG59XG5cbmV4cG9ydCBjbGFzcyBGaWx0ZXJQZXJzaXN0ZW5jZVNlcnZpY2UgaW1wbGVtZW50cyBJRmlsdGVyUGVyc2lzdGVuY2VTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBDQUNIRV9WRVJTSU9OID0gXCJ2Mi4xXCI7IC8vIOKchSBST0JVU1Q6IENhY2hlIHZlcnNpb25pbmdcbiAgcHJpdmF0ZSByZWFkb25seSBCUk9XU0VfU1RBVEVfS0VZID0gYHRrYS0ke3RoaXMuQ0FDSEVfVkVSU0lPTn0tYnJvd3NlLXN0YXRlYDtcbiAgcHJpdmF0ZSByZWFkb25seSBGSUxURVJfSElTVE9SWV9LRVkgPSBgdGthLSR7dGhpcy5DQUNIRV9WRVJTSU9OfS1maWx0ZXItaGlzdG9yeWA7XG4gIHByaXZhdGUgcmVhZG9ubHkgTUFYX0hJU1RPUllfU0laRSA9IDUwO1xuXG4gIGFzeW5jIHNhdmVCcm93c2VTdGF0ZShzdGF0ZTogQnJvd3NlU3RhdGUpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3RhdGVUb1NhdmUgPSB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBsYXN0VXBkYXRlZDogbmV3IERhdGUoKSxcbiAgICAgIH07XG4gICAgICBzYWZlU2Vzc2lvblN0b3JhZ2VTZXQodGhpcy5CUk9XU0VfU1RBVEVfS0VZLCBzdGF0ZVRvU2F2ZSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJGYWlsZWQgdG8gc2F2ZSBicm93c2Ugc3RhdGU6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBsb2FkQnJvd3NlU3RhdGUoKTogUHJvbWlzZTxCcm93c2VTdGF0ZSB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcGFyc2VkID0gc2FmZVNlc3Npb25TdG9yYWdlR2V0PFJlY29yZDxzdHJpbmcsIHVua25vd24+PihcbiAgICAgICAgdGhpcy5CUk9XU0VfU1RBVEVfS0VZLFxuICAgICAgICBudWxsXG4gICAgICApO1xuICAgICAgaWYgKCFwYXJzZWQpIHJldHVybiBudWxsO1xuXG4gICAgICAvLyBDb252ZXJ0IGRhdGUgc3RyaW5ncyBiYWNrIHRvIERhdGUgb2JqZWN0c1xuICAgICAgaWYgKFxuICAgICAgICBwYXJzZWQuY3VycmVudEZpbHRlciAmJlxuICAgICAgICB0eXBlb2YgcGFyc2VkLmN1cnJlbnRGaWx0ZXIgPT09IFwib2JqZWN0XCIgJiZcbiAgICAgICAgcGFyc2VkLmN1cnJlbnRGaWx0ZXIgIT09IG51bGwgJiZcbiAgICAgICAgXCJhcHBsaWVkQXRcIiBpbiBwYXJzZWQuY3VycmVudEZpbHRlclxuICAgICAgKSB7XG4gICAgICAgIChwYXJzZWQuY3VycmVudEZpbHRlciBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikuYXBwbGllZEF0ID0gbmV3IERhdGUoXG4gICAgICAgICAgKHBhcnNlZC5jdXJyZW50RmlsdGVyIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KS5hcHBsaWVkQXQgYXMgc3RyaW5nXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAocGFyc2VkLmxhc3RVcGRhdGVkICYmIHR5cGVvZiBwYXJzZWQubGFzdFVwZGF0ZWQgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgcGFyc2VkLmxhc3RVcGRhdGVkID0gbmV3IERhdGUocGFyc2VkLmxhc3RVcGRhdGVkKTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgc3RhdGUgaXMgbm90IHRvbyBvbGQgKG9sZGVyIHRoYW4gMSBkYXkpXG4gICAgICBjb25zdCBvbmVEYXkgPSAyNCAqIDYwICogNjAgKiAxMDAwO1xuICAgICAgaWYgKFxuICAgICAgICBwYXJzZWQubGFzdFVwZGF0ZWQgaW5zdGFuY2VvZiBEYXRlICYmXG4gICAgICAgIERhdGUubm93KCkgLSBwYXJzZWQubGFzdFVwZGF0ZWQuZ2V0VGltZSgpID4gb25lRGF5XG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwYXJzZWQgYXMgdW5rbm93biBhcyBCcm93c2VTdGF0ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKFwiRmFpbGVkIHRvIGxvYWQgYnJvd3NlIHN0YXRlOlwiLCBlcnJvcik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzYXZlRmlsdGVyVG9IaXN0b3J5KGZpbHRlcjogRmlsdGVyU3RhdGUpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgaGlzdG9yeSA9IGF3YWl0IHRoaXMuZ2V0RmlsdGVySGlzdG9yeSgpO1xuXG4gICAgICAvLyBSZW1vdmUgZHVwbGljYXRlIGZpbHRlcnMgKHNhbWUgdHlwZSBhbmQgdmFsdWUpXG4gICAgICBjb25zdCBmaWx0ZXJlZEhpc3RvcnkgPSBoaXN0b3J5LmZpbHRlcihcbiAgICAgICAgKGYpID0+XG4gICAgICAgICAgIShcbiAgICAgICAgICAgIGYudHlwZSA9PT0gZmlsdGVyLnR5cGUgJiZcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KGYudmFsdWUpID09PSBKU09OLnN0cmluZ2lmeShmaWx0ZXIudmFsdWUpXG4gICAgICAgICAgKVxuICAgICAgKTtcblxuICAgICAgLy8gQWRkIG5ldyBmaWx0ZXIgdG8gdGhlIGJlZ2lubmluZ1xuICAgICAgY29uc3QgbmV3SGlzdG9yeSA9IFtmaWx0ZXIsIC4uLmZpbHRlcmVkSGlzdG9yeV07XG5cbiAgICAgIC8vIExpbWl0IGhpc3Rvcnkgc2l6ZVxuICAgICAgY29uc3QgdHJpbW1lZEhpc3RvcnkgPSBuZXdIaXN0b3J5LnNsaWNlKDAsIHRoaXMuTUFYX0hJU1RPUllfU0laRSk7XG5cbiAgICAgIHNhZmVTZXNzaW9uU3RvcmFnZVNldCh0aGlzLkZJTFRFUl9ISVNUT1JZX0tFWSwgdHJpbW1lZEhpc3RvcnkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIHNhdmUgZmlsdGVyIHRvIGhpc3Rvcnk6XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRGaWx0ZXJIaXN0b3J5KCk6IFByb21pc2U8RmlsdGVyU3RhdGVbXT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwYXJzZWQgPSBzYWZlU2Vzc2lvblN0b3JhZ2VHZXQ8dW5rbm93bltdPihcbiAgICAgICAgdGhpcy5GSUxURVJfSElTVE9SWV9LRVksXG4gICAgICAgIFtdXG4gICAgICApO1xuICAgICAgaWYgKCFwYXJzZWQpIHJldHVybiBbXTtcblxuICAgICAgLy8gQ29udmVydCBkYXRlIHN0cmluZ3MgYmFjayB0byBEYXRlIG9iamVjdHNcbiAgICAgIHJldHVybiBwYXJzZWQubWFwKChmaWx0ZXI6IHVua25vd24pID0+IHtcbiAgICAgICAgY29uc3QgZiA9IGZpbHRlciBhcyB7XG4gICAgICAgICAgdHlwZTogRmlsdGVyVHlwZTtcbiAgICAgICAgICB2YWx1ZTogRmlsdGVyVmFsdWU7XG4gICAgICAgICAgYXBwbGllZEF0OiBzdHJpbmc7XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgLi4uZixcbiAgICAgICAgICBhcHBsaWVkQXQ6IG5ldyBEYXRlKGYuYXBwbGllZEF0KSxcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJGYWlsZWQgdG8gbG9hZCBmaWx0ZXIgaGlzdG9yeTpcIiwgZXJyb3IpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNsZWFyRmlsdGVySGlzdG9yeSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBzYWZlU2Vzc2lvblN0b3JhZ2VSZW1vdmUodGhpcy5GSUxURVJfSElTVE9SWV9LRVkpO1xuICB9XG5cbiAgYXN5bmMgZ2V0UmVjZW50RmlsdGVycyhsaW1pdDogbnVtYmVyID0gMTApOiBQcm9taXNlPEZpbHRlclN0YXRlW10+IHtcbiAgICBjb25zdCBoaXN0b3J5ID0gYXdhaXQgdGhpcy5nZXRGaWx0ZXJIaXN0b3J5KCk7XG4gICAgcmV0dXJuIGhpc3Rvcnkuc2xpY2UoMCwgbGltaXQpO1xuICB9XG5cbiAgYXN5bmMgY2xlYXJBbGxTdGF0ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBzYWZlU2Vzc2lvblN0b3JhZ2VSZW1vdmUodGhpcy5CUk9XU0VfU1RBVEVfS0VZKTtcbiAgICBzYWZlU2Vzc2lvblN0b3JhZ2VSZW1vdmUodGhpcy5GSUxURVJfSElTVE9SWV9LRVkpO1xuICB9XG5cbiAgLy8gVXRpbGl0eSBtZXRob2RzIGZvciBmaWx0ZXIgbWFuYWdlbWVudFxuICBhc3luYyBnZXRGaWx0ZXJGcmVxdWVuY3koKTogUHJvbWlzZTxNYXA8c3RyaW5nLCBudW1iZXI+PiB7XG4gICAgY29uc3QgaGlzdG9yeSA9IGF3YWl0IHRoaXMuZ2V0RmlsdGVySGlzdG9yeSgpO1xuICAgIGNvbnN0IGZyZXF1ZW5jeSA9IG5ldyBNYXA8c3RyaW5nLCBudW1iZXI+KCk7XG5cbiAgICBoaXN0b3J5LmZvckVhY2goKGZpbHRlcikgPT4ge1xuICAgICAgY29uc3Qga2V5ID0gYCR7ZmlsdGVyLnR5cGV9OiR7SlNPTi5zdHJpbmdpZnkoZmlsdGVyLnZhbHVlKX1gO1xuICAgICAgZnJlcXVlbmN5LnNldChrZXksIChmcmVxdWVuY3kuZ2V0KGtleSkgfHwgMCkgKyAxKTtcbiAgICB9KTtcblxuICAgIHJldHVybiBmcmVxdWVuY3k7XG4gIH1cblxuICBhc3luYyBnZXRNb3N0VXNlZEZpbHRlcnMobGltaXQ6IG51bWJlciA9IDUpOiBQcm9taXNlPEZpbHRlclN0YXRlW10+IHtcbiAgICBjb25zdCBoaXN0b3J5ID0gYXdhaXQgdGhpcy5nZXRGaWx0ZXJIaXN0b3J5KCk7XG4gICAgY29uc3QgZnJlcXVlbmN5ID0gYXdhaXQgdGhpcy5nZXRGaWx0ZXJGcmVxdWVuY3koKTtcblxuICAgIC8vIEdyb3VwIGZpbHRlcnMgYnkgdHlwZTp2YWx1ZSBhbmQgZmluZCBtb3N0IGZyZXF1ZW50XG4gICAgY29uc3QgZmlsdGVyTWFwID0gbmV3IE1hcDxzdHJpbmcsIEZpbHRlclN0YXRlPigpO1xuICAgIGhpc3RvcnkuZm9yRWFjaCgoZmlsdGVyKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBgJHtmaWx0ZXIudHlwZX06JHtKU09OLnN0cmluZ2lmeShmaWx0ZXIudmFsdWUpfWA7XG4gICAgICBpZiAoIWZpbHRlck1hcC5oYXMoa2V5KSkge1xuICAgICAgICBmaWx0ZXJNYXAuc2V0KGtleSwgZmlsdGVyKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBBcnJheS5mcm9tKGZpbHRlck1hcC52YWx1ZXMoKSlcbiAgICAgIC5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgIGNvbnN0IGtleUEgPSBgJHthLnR5cGV9OiR7SlNPTi5zdHJpbmdpZnkoYS52YWx1ZSl9YDtcbiAgICAgICAgY29uc3Qga2V5QiA9IGAke2IudHlwZX06JHtKU09OLnN0cmluZ2lmeShiLnZhbHVlKX1gO1xuICAgICAgICByZXR1cm4gKGZyZXF1ZW5jeS5nZXQoa2V5QikgfHwgMCkgLSAoZnJlcXVlbmN5LmdldChrZXlBKSB8fCAwKTtcbiAgICAgIH0pXG4gICAgICAuc2xpY2UoMCwgbGltaXQpO1xuICB9XG5cbiAgYXN5bmMgZ2V0RGVmYXVsdEJyb3dzZVN0YXRlKCk6IFByb21pc2U8QnJvd3NlU3RhdGU+IHtcbiAgICByZXR1cm4ge1xuICAgICAgZGlzcGxheVN0YXRlOiB7XG4gICAgICAgIGN1cnJlbnRWaWV3OiBcImZpbHRlcl9zZWxlY3Rpb25cIixcbiAgICAgICAgc2VsZWN0ZWRTZXF1ZW5jZTogbnVsbCxcbiAgICAgICAgaXNTZXF1ZW5jZURldGFpbE9wZW46IGZhbHNlLFxuICAgICAgfSxcbiAgICAgIGxvYWRpbmdTdGF0ZToge1xuICAgICAgICBpc0xvYWRpbmc6IGZhbHNlLFxuICAgICAgICBoYXNFcnJvcjogZmFsc2UsXG4gICAgICAgIGVycm9yTWVzc2FnZTogbnVsbCxcbiAgICAgIH0sXG4gICAgICBmaWx0ZXJTdGF0ZToge1xuICAgICAgICBhY3RpdmVGaWx0ZXJzOiB7XG4gICAgICAgICAgc3RhcnRpbmdfbGV0dGVyOiBcIlwiLFxuICAgICAgICAgIGNvbnRhaW5zX2xldHRlcnM6IFwiXCIsXG4gICAgICAgICAgbGVuZ3RoOiBcIlwiLFxuICAgICAgICAgIGRpZmZpY3VsdHk6IFwiXCIsXG4gICAgICAgICAgc3RhcnRpbmdfcG9zaXRpb246IFwiXCIsXG4gICAgICAgICAgYXV0aG9yOiBcIlwiLFxuICAgICAgICAgIGdyaWRNb2RlOiBcIlwiLFxuICAgICAgICAgIGFsbF9zZXF1ZW5jZXM6IFwiXCIsXG4gICAgICAgICAgZmF2b3JpdGVzOiBcIlwiLFxuICAgICAgICAgIHJlY2VudDogXCJcIixcbiAgICAgICAgfSxcbiAgICAgICAgc29ydE1ldGhvZDogXCJhbHBoYWJldGljYWxcIiBhcyBTb3J0TWV0aG9kLFxuICAgICAgICBzZWFyY2hRdWVyeTogXCJcIixcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIC8vIEFkZGl0aW9uYWwgbWV0aG9kcyByZXF1aXJlZCBieSBicm93c2UtaW50ZXJmYWNlcy50c1xuICBhc3luYyBzYXZlRmlsdGVyU3RhdGUoc3RhdGU6IEJyb3dzZUZpbHRlclN0YXRlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gQ3JlYXRlIGEgQnJvd3NlU3RhdGUgd2l0aCB0aGUgZmlsdGVyIHN0YXRlXG4gICAgY29uc3QgYnJvd3NlU3RhdGU6IEJyb3dzZVN0YXRlID0ge1xuICAgICAgZGlzcGxheVN0YXRlOiB7XG4gICAgICAgIGN1cnJlbnRWaWV3OiBcImZpbHRlcl9zZWxlY3Rpb25cIixcbiAgICAgICAgc2VsZWN0ZWRTZXF1ZW5jZTogbnVsbCxcbiAgICAgICAgaXNTZXF1ZW5jZURldGFpbE9wZW46IGZhbHNlLFxuICAgICAgfSxcbiAgICAgIGxvYWRpbmdTdGF0ZToge1xuICAgICAgICBpc0xvYWRpbmc6IGZhbHNlLFxuICAgICAgICBoYXNFcnJvcjogZmFsc2UsXG4gICAgICAgIGVycm9yTWVzc2FnZTogbnVsbCxcbiAgICAgIH0sXG4gICAgICBmaWx0ZXJTdGF0ZTogc3RhdGUsXG4gICAgfTtcbiAgICBhd2FpdCB0aGlzLnNhdmVCcm93c2VTdGF0ZShicm93c2VTdGF0ZSk7XG4gIH1cblxuICBhc3luYyBsb2FkRmlsdGVyU3RhdGUoKTogUHJvbWlzZTxCcm93c2VGaWx0ZXJTdGF0ZT4ge1xuICAgIC8vIFVzZSB0aGUgZXhpc3RpbmcgbG9hZEJyb3dzZVN0YXRlIG1ldGhvZFxuICAgIGNvbnN0IGJyb3dzZVN0YXRlID0gYXdhaXQgdGhpcy5sb2FkQnJvd3NlU3RhdGUoKTtcblxuICAgIC8vIFJldHVybiB0aGUgZmlsdGVyIHN0YXRlIG9yIGEgZGVmYXVsdCBvbmUgd2l0aCBwcm9wZXIgRmlsdGVyVHlwZSBrZXlzXG4gICAgcmV0dXJuIChcbiAgICAgIGJyb3dzZVN0YXRlPy5maWx0ZXJTdGF0ZSB8fCB7XG4gICAgICAgIGFjdGl2ZUZpbHRlcnM6IHtcbiAgICAgICAgICBzdGFydGluZ19sZXR0ZXI6IG51bGwsXG4gICAgICAgICAgY29udGFpbnNfbGV0dGVyczogbnVsbCxcbiAgICAgICAgICBsZW5ndGg6IG51bGwsXG4gICAgICAgICAgZGlmZmljdWx0eTogbnVsbCxcbiAgICAgICAgICBzdGFydGluZ19wb3NpdGlvbjogbnVsbCxcbiAgICAgICAgICBhdXRob3I6IG51bGwsXG4gICAgICAgICAgZ3JpZE1vZGU6IG51bGwsXG4gICAgICAgICAgYWxsX3NlcXVlbmNlczogbnVsbCxcbiAgICAgICAgICBmYXZvcml0ZXM6IG51bGwsXG4gICAgICAgICAgcmVjZW50OiBudWxsLFxuICAgICAgICB9LFxuICAgICAgICBzb3J0TWV0aG9kOiBTb3J0TWV0aG9kRW51bS5BTFBIQUJFVElDQUwsXG4gICAgICAgIHNlYXJjaFF1ZXJ5OiBcIlwiLFxuICAgICAgfVxuICAgICk7XG4gIH1cbn1cbiJdLAogICJtYXBwaW5ncyI6ICJBQWdCQSxTQUFTLGNBQWMsc0JBQXNCO0FBQzdD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LElBQzlELENBQUMsRUFDQSxNQUFNLEdBQUcsS0FBSztBQUFBLEVBQ25CO0FBQUEsRUFFQSxNQUFNLHdCQUE4QztBQUNsRCxXQUFPO0FBQUEsTUFDTCxjQUFjO0FBQUEsUUFDWixhQUFhO0FBQUEsUUFDYixrQkFBa0I7QUFBQSxRQUNsQixzQkFBc0I7QUFBQSxNQUN4QjtBQUFBLE1BQ0EsY0FBYztBQUFBLFFBQ1osV0FBVztBQUFBLFFBQ1gsVUFBVTtBQUFBLFFBQ1YsY0FBYztBQUFBLE1BQ2hCO0FBQUEsTUFDQSxhQUFhO0FBQUEsUUFDWCxlQUFlO0FBQUEsVUFDYixpQkFBaUI7QUFBQSxVQUNqQixrQkFBa0I7QUFBQSxVQUNsQixRQUFRO0FBQUEsVUFDUixZQUFZO0FBQUEsVUFDWixtQkFBbUI7QUFBQSxVQUNuQixRQUFRO0FBQUEsVUFDUixVQUFVO0FBQUEsVUFDVixlQUFlO0FBQUEsVUFDZixXQUFXO0FBQUEsVUFDWCxRQUFRO0FBQUEsUUFDVjtBQUFBLFFBQ0EsWUFBWTtBQUFBLFFBQ1osYUFBYTtBQUFBLE1BQ2Y7QUFBQSxJQUNGO0FBQUEsRUFDRjtBQUFBO0FBQUEsRUFHQSxNQUFNLGdCQUFnQixPQUF5QztBQUU3RCxVQUFNLGNBQTJCO0FBQUEsTUFDL0IsY0FBYztBQUFBLFFBQ1osYUFBYTtBQUFBLFFBQ2Isa0JBQWtCO0FBQUEsUUFDbEIsc0JBQXNCO0FBQUEsTUFDeEI7QUFBQSxNQUNBLGNBQWM7QUFBQSxRQUNaLFdBQVc7QUFBQSxRQUNYLFVBQVU7QUFBQSxRQUNWLGNBQWM7QUFBQSxNQUNoQjtBQUFBLE1BQ0EsYUFBYTtBQUFBLElBQ2Y7QUFDQSxVQUFNLEtBQUssZ0JBQWdCLFdBQVc7QUFBQSxFQUN4QztBQUFBLEVBRUEsTUFBTSxrQkFBOEM7QUFFbEQsVUFBTSxjQUFjLE1BQU0sS0FBSyxnQkFBZ0I7QUFHL0MsV0FDRSxhQUFhLGVBQWU7QUFBQSxNQUMxQixlQUFlO0FBQUEsUUFDYixpQkFBaUI7QUFBQSxRQUNqQixrQkFBa0I7QUFBQSxRQUNsQixRQUFRO0FBQUEsUUFDUixZQUFZO0FBQUEsUUFDWixtQkFBbUI7QUFBQSxRQUNuQixRQUFRO0FBQUEsUUFDUixVQUFVO0FBQUEsUUFDVixlQUFlO0FBQUEsUUFDZixXQUFXO0FBQUEsUUFDWCxRQUFRO0FBQUEsTUFDVjtBQUFBLE1BQ0EsWUFBWSxlQUFlO0FBQUEsTUFDM0IsYUFBYTtBQUFBLElBQ2Y7QUFBQSxFQUVKO0FBQ0Y7IiwKICAibmFtZXMiOiBbXQp9Cg==
