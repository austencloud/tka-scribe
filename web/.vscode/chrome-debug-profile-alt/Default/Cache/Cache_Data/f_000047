import { GridMode as DomainGridMode } from "/src/lib/domain/index.ts";
import { MotionType } from "/src/lib/domain/enums.ts";
import { jsonCache } from "/src/lib/services/positioning/cache/SimpleJsonCache.ts";
export class ArrowPlacementDataService {
  allPlacements = {
    [DomainGridMode.DIAMOND]: {},
    [DomainGridMode.BOX]: {}
  };
  isDataLoaded = false;
  // File mapping for placement data
  placementFiles = {
    [DomainGridMode.DIAMOND]: {
      pro: "/data/arrow_placement/diamond/default/default_diamond_pro_placements.json",
      anti: "/data/arrow_placement/diamond/default/default_diamond_anti_placements.json",
      float: "/data/arrow_placement/diamond/default/default_diamond_float_placements.json",
      dash: "/data/arrow_placement/diamond/default/default_diamond_dash_placements.json",
      static: "/data/arrow_placement/diamond/default/default_diamond_static_placements.json"
    },
    [DomainGridMode.BOX]: {
      pro: "/data/arrow_placement/box/default/default_box_pro_placements.json",
      anti: "/data/arrow_placement/box/default/default_box_anti_placements.json",
      float: "/data/arrow_placement/box/default/default_box_float_placements.json",
      dash: "/data/arrow_placement/box/default/default_box_dash_placements.json",
      static: "/data/arrow_placement/box/default/default_box_static_placements.json"
    }
  };
  /**
   * Load all placement data from JSON files
   */
  async loadPlacementData() {
    if (this.isDataLoaded) {
      return;
    }
    try {
      await this.loadGridPlacements(DomainGridMode.DIAMOND);
      await this.loadGridPlacements(DomainGridMode.BOX);
      this.isDataLoaded = true;
    } catch (error) {
      console.error("❌ Failed to load arrow placement data:", error);
      throw new Error(
        `Placement data loading failed: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Load placements for a specific grid mode
   */
  async loadGridPlacements(gridMode) {
    const files = this.placementFiles[gridMode];
    this.allPlacements[gridMode] = {};
    for (const [motionType, filePath] of Object.entries(files)) {
      try {
        const placementData = await this.loadJsonFile(filePath);
        this.allPlacements[gridMode][motionType] = placementData;
      } catch (error) {
        console.warn(
          `Could not load ${motionType} placements for ${gridMode}: ${error}`
        );
        this.allPlacements[gridMode][motionType] = {};
      }
    }
  }
  /**
   * Load JSON file with caching
   */
  async loadJsonFile(path) {
    try {
      const data = await jsonCache.get(path);
      return data;
    } catch (error) {
      console.warn(`Failed to load placement data from ${path}:`, error);
      return {};
    }
  }
  /**
   * Get default adjustment using placement key and turns
   */
  async getDefaultAdjustment(motionType, placementKey, turns, gridMode = DomainGridMode.DIAMOND) {
    await this.ensureDataLoaded();
    const gridPlacements = this.allPlacements[gridMode];
    if (!gridPlacements) {
      console.warn(`No placement data for grid mode: ${gridMode}`);
      return { x: 0, y: 0 };
    }
    const motionPlacements = gridPlacements[motionType];
    if (!motionPlacements) {
      console.warn(`No placement data for motion type: ${motionType}`);
      return { x: 0, y: 0 };
    }
    const placementData = motionPlacements[placementKey];
    if (!placementData) {
      console.warn(`No placement data for key: ${placementKey}`);
      return { x: 0, y: 0 };
    }
    const turnsStr = this.formatTurnsForLookup(turns);
    const adjustment = placementData[turnsStr];
    if (!adjustment) {
      console.warn(
        `No adjustment for turns: ${turnsStr} in placement: ${placementKey}`
      );
      return { x: 0, y: 0 };
    }
    const [x, y] = adjustment;
    return { x, y };
  }
  /**
   * Get available placement keys for a motion type
   */
  async getAvailablePlacementKeys(motionType, gridMode = DomainGridMode.DIAMOND) {
    await this.ensureDataLoaded();
    const motionPlacements = this.allPlacements[gridMode]?.[motionType];
    if (!motionPlacements) {
      return [];
    }
    return Object.keys(motionPlacements);
  }
  /**
   * Check if data is loaded
   */
  isLoaded() {
    return this.isDataLoaded;
  }
  /**
   * Ensure data is loaded before operations
   */
  async ensureDataLoaded() {
    if (!this.isDataLoaded) {
      await this.loadPlacementData();
    }
  }
  /**
   * Format turns value for JSON lookup
   * Converts: 1.0 → "1", 0.5 → "0.5", etc.
   */
  formatTurnsForLookup(turns) {
    if (typeof turns === "string") {
      return turns;
    }
    if (turns === Math.floor(turns)) {
      return Math.floor(turns).toString();
    }
    return turns.toString();
  }
  /**
   * Debug method to log available keys
   */
  async debugAvailableKeys(motionType, gridMode = DomainGridMode.DIAMOND) {
    const keys = await this.getAvailablePlacementKeys(motionType, gridMode);
    console.log(
      `Available placement keys for ${motionType} (${gridMode}):`,
      keys
    );
  }
  /**
   * Get raw placement data for debugging
   */
  async getPlacementData(motionType, placementKey, gridMode = DomainGridMode.DIAMOND) {
    await this.ensureDataLoaded();
    const motionPlacements = this.allPlacements[gridMode]?.[motionType];
    return motionPlacements?.[placementKey] || {};
  }
}
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiQzovVEtBL3dlYi9zcmMvbGliL3NlcnZpY2VzL2ltcGxlbWVudGF0aW9ucy9kYXRhL0Fycm93UGxhY2VtZW50RGF0YVNlcnZpY2UudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbIi8qKlxuICogQXJyb3cgUGxhY2VtZW50IERhdGEgU2VydmljZVxuICpcbiAqIExvYWRzIGFuZCBtYW5hZ2VzIGFycm93IHBsYWNlbWVudCBKU09OIGRhdGEgZm9yIHBvc2l0aW9uaW5nIGNhbGN1bGF0aW9ucy5cbiAqIFBvcnRzIHRoZSBleGFjdCBmdW5jdGlvbmFsaXR5IGZyb20gZGVza3RvcCBEZWZhdWx0UGxhY2VtZW50U2VydmljZS5cbiAqL1xuXG5pbXBvcnQgeyBHcmlkTW9kZSBhcyBEb21haW5HcmlkTW9kZSB9IGZyb20gXCIkbGliL2RvbWFpblwiO1xuaW1wb3J0IHR5cGUgeyBHcmlkTW9kZSB9IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL2NvcmUtdHlwZXNcIjtcbmltcG9ydCB7IE1vdGlvblR5cGUgfSBmcm9tIFwiJGxpYi9kb21haW4vZW51bXNcIjsgLy8g4pyFIEltcG9ydCBmcm9tIGNlbnRyYWxpemVkIGVudW1zXG5pbXBvcnQgeyBqc29uQ2FjaGUgfSBmcm9tIFwiLi4vLi4vcG9zaXRpb25pbmcvY2FjaGUvU2ltcGxlSnNvbkNhY2hlXCI7XG5cbi8vIFBsYWNlbWVudCBkYXRhIHN0cnVjdHVyZSBmcm9tIEpTT04gZmlsZXNcbmV4cG9ydCBpbnRlcmZhY2UgUGxhY2VtZW50RGF0YSB7XG4gIFtwbGFjZW1lbnRLZXk6IHN0cmluZ106IHtcbiAgICBbdHVybnM6IHN0cmluZ106IFtudW1iZXIsIG51bWJlcl07IC8vIFt4LCB5XSBhZGp1c3RtZW50XG4gIH07XG59XG5cbi8vIENvbXBsZXRlIHBsYWNlbWVudCBkYXRhIGZvciBhbGwgbW90aW9uIHR5cGVzXG5leHBvcnQgaW50ZXJmYWNlIEdyaWRQbGFjZW1lbnREYXRhIHtcbiAgW21vdGlvblR5cGU6IHN0cmluZ106IFBsYWNlbWVudERhdGE7XG59XG5cbi8vIEFsbCBwbGFjZW1lbnQgZGF0YSBmb3IgYWxsIGdyaWQgbW9kZXNcbmV4cG9ydCBpbnRlcmZhY2UgQWxsUGxhY2VtZW50RGF0YSB7XG4gIFtncmlkTW9kZTogc3RyaW5nXTogR3JpZFBsYWNlbWVudERhdGE7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUFycm93UGxhY2VtZW50RGF0YVNlcnZpY2Uge1xuICBnZXREZWZhdWx0QWRqdXN0bWVudChcbiAgICBtb3Rpb25UeXBlOiBNb3Rpb25UeXBlLFxuICAgIHBsYWNlbWVudEtleTogc3RyaW5nLFxuICAgIHR1cm5zOiBudW1iZXIgfCBzdHJpbmcsXG4gICAgZ3JpZE1vZGU6IEdyaWRNb2RlXG4gICk6IFByb21pc2U8eyB4OiBudW1iZXI7IHk6IG51bWJlciB9PjtcblxuICBnZXRBdmFpbGFibGVQbGFjZW1lbnRLZXlzKFxuICAgIG1vdGlvblR5cGU6IE1vdGlvblR5cGUsXG4gICAgZ3JpZE1vZGU6IEdyaWRNb2RlXG4gICk6IFByb21pc2U8c3RyaW5nW10+O1xuXG4gIGlzTG9hZGVkKCk6IGJvb2xlYW47XG4gIGxvYWRQbGFjZW1lbnREYXRhKCk6IFByb21pc2U8dm9pZD47XG59XG5cbmV4cG9ydCBjbGFzcyBBcnJvd1BsYWNlbWVudERhdGFTZXJ2aWNlIGltcGxlbWVudHMgSUFycm93UGxhY2VtZW50RGF0YVNlcnZpY2Uge1xuICBwcml2YXRlIGFsbFBsYWNlbWVudHM6IEFsbFBsYWNlbWVudERhdGEgPSB7XG4gICAgW0RvbWFpbkdyaWRNb2RlLkRJQU1PTkRdOiB7fSxcbiAgICBbRG9tYWluR3JpZE1vZGUuQk9YXToge30sXG4gIH07XG5cbiAgcHJpdmF0ZSBpc0RhdGFMb2FkZWQgPSBmYWxzZTtcblxuICAvLyBGaWxlIG1hcHBpbmcgZm9yIHBsYWNlbWVudCBkYXRhXG4gIHByaXZhdGUgcmVhZG9ubHkgcGxhY2VtZW50RmlsZXMgPSB7XG4gICAgW0RvbWFpbkdyaWRNb2RlLkRJQU1PTkRdOiB7XG4gICAgICBwcm86IFwiL2RhdGEvYXJyb3dfcGxhY2VtZW50L2RpYW1vbmQvZGVmYXVsdC9kZWZhdWx0X2RpYW1vbmRfcHJvX3BsYWNlbWVudHMuanNvblwiLFxuICAgICAgYW50aTogXCIvZGF0YS9hcnJvd19wbGFjZW1lbnQvZGlhbW9uZC9kZWZhdWx0L2RlZmF1bHRfZGlhbW9uZF9hbnRpX3BsYWNlbWVudHMuanNvblwiLFxuICAgICAgZmxvYXQ6XG4gICAgICAgIFwiL2RhdGEvYXJyb3dfcGxhY2VtZW50L2RpYW1vbmQvZGVmYXVsdC9kZWZhdWx0X2RpYW1vbmRfZmxvYXRfcGxhY2VtZW50cy5qc29uXCIsXG4gICAgICBkYXNoOiBcIi9kYXRhL2Fycm93X3BsYWNlbWVudC9kaWFtb25kL2RlZmF1bHQvZGVmYXVsdF9kaWFtb25kX2Rhc2hfcGxhY2VtZW50cy5qc29uXCIsXG4gICAgICBzdGF0aWM6XG4gICAgICAgIFwiL2RhdGEvYXJyb3dfcGxhY2VtZW50L2RpYW1vbmQvZGVmYXVsdC9kZWZhdWx0X2RpYW1vbmRfc3RhdGljX3BsYWNlbWVudHMuanNvblwiLFxuICAgIH0sXG4gICAgW0RvbWFpbkdyaWRNb2RlLkJPWF06IHtcbiAgICAgIHBybzogXCIvZGF0YS9hcnJvd19wbGFjZW1lbnQvYm94L2RlZmF1bHQvZGVmYXVsdF9ib3hfcHJvX3BsYWNlbWVudHMuanNvblwiLFxuICAgICAgYW50aTogXCIvZGF0YS9hcnJvd19wbGFjZW1lbnQvYm94L2RlZmF1bHQvZGVmYXVsdF9ib3hfYW50aV9wbGFjZW1lbnRzLmpzb25cIixcbiAgICAgIGZsb2F0OlxuICAgICAgICBcIi9kYXRhL2Fycm93X3BsYWNlbWVudC9ib3gvZGVmYXVsdC9kZWZhdWx0X2JveF9mbG9hdF9wbGFjZW1lbnRzLmpzb25cIixcbiAgICAgIGRhc2g6IFwiL2RhdGEvYXJyb3dfcGxhY2VtZW50L2JveC9kZWZhdWx0L2RlZmF1bHRfYm94X2Rhc2hfcGxhY2VtZW50cy5qc29uXCIsXG4gICAgICBzdGF0aWM6XG4gICAgICAgIFwiL2RhdGEvYXJyb3dfcGxhY2VtZW50L2JveC9kZWZhdWx0L2RlZmF1bHRfYm94X3N0YXRpY19wbGFjZW1lbnRzLmpzb25cIixcbiAgICB9LFxuICB9O1xuXG4gIC8qKlxuICAgKiBMb2FkIGFsbCBwbGFjZW1lbnQgZGF0YSBmcm9tIEpTT04gZmlsZXNcbiAgICovXG4gIGFzeW5jIGxvYWRQbGFjZW1lbnREYXRhKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLmlzRGF0YUxvYWRlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBMb2FkIGRpYW1vbmQgcGxhY2VtZW50c1xuICAgICAgYXdhaXQgdGhpcy5sb2FkR3JpZFBsYWNlbWVudHMoRG9tYWluR3JpZE1vZGUuRElBTU9ORCk7XG5cbiAgICAgIC8vIExvYWQgYm94IHBsYWNlbWVudHMgKG1heSBub3QgZXhpc3QgeWV0KVxuICAgICAgYXdhaXQgdGhpcy5sb2FkR3JpZFBsYWNlbWVudHMoRG9tYWluR3JpZE1vZGUuQk9YKTtcblxuICAgICAgdGhpcy5pc0RhdGFMb2FkZWQgPSB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwi4p2MIEZhaWxlZCB0byBsb2FkIGFycm93IHBsYWNlbWVudCBkYXRhOlwiLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBQbGFjZW1lbnQgZGF0YSBsb2FkaW5nIGZhaWxlZDogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFwiVW5rbm93biBlcnJvclwifWBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExvYWQgcGxhY2VtZW50cyBmb3IgYSBzcGVjaWZpYyBncmlkIG1vZGVcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgbG9hZEdyaWRQbGFjZW1lbnRzKGdyaWRNb2RlOiBHcmlkTW9kZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGZpbGVzID0gdGhpcy5wbGFjZW1lbnRGaWxlc1tncmlkTW9kZV07XG4gICAgdGhpcy5hbGxQbGFjZW1lbnRzW2dyaWRNb2RlXSA9IHt9O1xuXG4gICAgZm9yIChjb25zdCBbbW90aW9uVHlwZSwgZmlsZVBhdGhdIG9mIE9iamVjdC5lbnRyaWVzKGZpbGVzKSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcGxhY2VtZW50RGF0YSA9IGF3YWl0IHRoaXMubG9hZEpzb25GaWxlKGZpbGVQYXRoKTtcbiAgICAgICAgdGhpcy5hbGxQbGFjZW1lbnRzW2dyaWRNb2RlXVttb3Rpb25UeXBlXSA9IHBsYWNlbWVudERhdGE7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgYENvdWxkIG5vdCBsb2FkICR7bW90aW9uVHlwZX0gcGxhY2VtZW50cyBmb3IgJHtncmlkTW9kZX06ICR7ZXJyb3J9YFxuICAgICAgICApO1xuICAgICAgICB0aGlzLmFsbFBsYWNlbWVudHNbZ3JpZE1vZGVdW21vdGlvblR5cGVdID0ge307XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExvYWQgSlNPTiBmaWxlIHdpdGggY2FjaGluZ1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBsb2FkSnNvbkZpbGUocGF0aDogc3RyaW5nKTogUHJvbWlzZTxQbGFjZW1lbnREYXRhPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBqc29uQ2FjaGUuZ2V0KHBhdGgpO1xuICAgICAgcmV0dXJuIGRhdGEgYXMgUGxhY2VtZW50RGF0YTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKGBGYWlsZWQgdG8gbG9hZCBwbGFjZW1lbnQgZGF0YSBmcm9tICR7cGF0aH06YCwgZXJyb3IpO1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZGVmYXVsdCBhZGp1c3RtZW50IHVzaW5nIHBsYWNlbWVudCBrZXkgYW5kIHR1cm5zXG4gICAqL1xuICBhc3luYyBnZXREZWZhdWx0QWRqdXN0bWVudChcbiAgICBtb3Rpb25UeXBlOiBNb3Rpb25UeXBlLFxuICAgIHBsYWNlbWVudEtleTogc3RyaW5nLFxuICAgIHR1cm5zOiBudW1iZXIgfCBzdHJpbmcsXG4gICAgZ3JpZE1vZGU6IEdyaWRNb2RlID0gRG9tYWluR3JpZE1vZGUuRElBTU9ORFxuICApOiBQcm9taXNlPHsgeDogbnVtYmVyOyB5OiBudW1iZXIgfT4ge1xuICAgIGF3YWl0IHRoaXMuZW5zdXJlRGF0YUxvYWRlZCgpO1xuXG4gICAgY29uc3QgZ3JpZFBsYWNlbWVudHMgPSB0aGlzLmFsbFBsYWNlbWVudHNbZ3JpZE1vZGVdO1xuICAgIGlmICghZ3JpZFBsYWNlbWVudHMpIHtcbiAgICAgIGNvbnNvbGUud2FybihgTm8gcGxhY2VtZW50IGRhdGEgZm9yIGdyaWQgbW9kZTogJHtncmlkTW9kZX1gKTtcbiAgICAgIHJldHVybiB7IHg6IDAsIHk6IDAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBtb3Rpb25QbGFjZW1lbnRzID0gZ3JpZFBsYWNlbWVudHNbbW90aW9uVHlwZV07XG4gICAgaWYgKCFtb3Rpb25QbGFjZW1lbnRzKSB7XG4gICAgICBjb25zb2xlLndhcm4oYE5vIHBsYWNlbWVudCBkYXRhIGZvciBtb3Rpb24gdHlwZTogJHttb3Rpb25UeXBlfWApO1xuICAgICAgcmV0dXJuIHsgeDogMCwgeTogMCB9O1xuICAgIH1cblxuICAgIGNvbnN0IHBsYWNlbWVudERhdGEgPSBtb3Rpb25QbGFjZW1lbnRzW3BsYWNlbWVudEtleV07XG4gICAgaWYgKCFwbGFjZW1lbnREYXRhKSB7XG4gICAgICBjb25zb2xlLndhcm4oYE5vIHBsYWNlbWVudCBkYXRhIGZvciBrZXk6ICR7cGxhY2VtZW50S2V5fWApO1xuICAgICAgcmV0dXJuIHsgeDogMCwgeTogMCB9O1xuICAgIH1cblxuICAgIC8vIENvbnZlcnQgdHVybnMgdG8gc3RyaW5nIGZvcm1hdCB1c2VkIGluIEpTT05cbiAgICBjb25zdCB0dXJuc1N0ciA9IHRoaXMuZm9ybWF0VHVybnNGb3JMb29rdXAodHVybnMpO1xuICAgIGNvbnN0IGFkanVzdG1lbnQgPSBwbGFjZW1lbnREYXRhW3R1cm5zU3RyXTtcblxuICAgIGlmICghYWRqdXN0bWVudCkge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICBgTm8gYWRqdXN0bWVudCBmb3IgdHVybnM6ICR7dHVybnNTdHJ9IGluIHBsYWNlbWVudDogJHtwbGFjZW1lbnRLZXl9YFxuICAgICAgKTtcbiAgICAgIHJldHVybiB7IHg6IDAsIHk6IDAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBbeCwgeV0gPSBhZGp1c3RtZW50O1xuICAgIHJldHVybiB7IHgsIHkgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYXZhaWxhYmxlIHBsYWNlbWVudCBrZXlzIGZvciBhIG1vdGlvbiB0eXBlXG4gICAqL1xuICBhc3luYyBnZXRBdmFpbGFibGVQbGFjZW1lbnRLZXlzKFxuICAgIG1vdGlvblR5cGU6IE1vdGlvblR5cGUsXG4gICAgZ3JpZE1vZGU6IEdyaWRNb2RlID0gRG9tYWluR3JpZE1vZGUuRElBTU9ORFxuICApOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgYXdhaXQgdGhpcy5lbnN1cmVEYXRhTG9hZGVkKCk7XG5cbiAgICBjb25zdCBtb3Rpb25QbGFjZW1lbnRzID0gdGhpcy5hbGxQbGFjZW1lbnRzW2dyaWRNb2RlXT8uW21vdGlvblR5cGVdO1xuICAgIGlmICghbW90aW9uUGxhY2VtZW50cykge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHJldHVybiBPYmplY3Qua2V5cyhtb3Rpb25QbGFjZW1lbnRzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBkYXRhIGlzIGxvYWRlZFxuICAgKi9cbiAgaXNMb2FkZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaXNEYXRhTG9hZGVkO1xuICB9XG5cbiAgLyoqXG4gICAqIEVuc3VyZSBkYXRhIGlzIGxvYWRlZCBiZWZvcmUgb3BlcmF0aW9uc1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBlbnN1cmVEYXRhTG9hZGVkKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5pc0RhdGFMb2FkZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMubG9hZFBsYWNlbWVudERhdGEoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRm9ybWF0IHR1cm5zIHZhbHVlIGZvciBKU09OIGxvb2t1cFxuICAgKiBDb252ZXJ0czogMS4wIOKGkiBcIjFcIiwgMC41IOKGkiBcIjAuNVwiLCBldGMuXG4gICAqL1xuICBwcml2YXRlIGZvcm1hdFR1cm5zRm9yTG9va3VwKHR1cm5zOiBudW1iZXIgfCBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmICh0eXBlb2YgdHVybnMgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiB0dXJuczsgLy8gQWxyZWFkeSBmb3JtYXR0ZWQgKGUuZy4sIFwiZmxcIiBmb3IgZmxvYXQpXG4gICAgfVxuXG4gICAgLy8gQ29udmVydCBudW1iZXJzOiByZW1vdmUgLjAgZm9yIHdob2xlIG51bWJlcnNcbiAgICBpZiAodHVybnMgPT09IE1hdGguZmxvb3IodHVybnMpKSB7XG4gICAgICByZXR1cm4gTWF0aC5mbG9vcih0dXJucykudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHVybnMudG9TdHJpbmcoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWJ1ZyBtZXRob2QgdG8gbG9nIGF2YWlsYWJsZSBrZXlzXG4gICAqL1xuICBhc3luYyBkZWJ1Z0F2YWlsYWJsZUtleXMoXG4gICAgbW90aW9uVHlwZTogTW90aW9uVHlwZSxcbiAgICBncmlkTW9kZTogR3JpZE1vZGUgPSBEb21haW5HcmlkTW9kZS5ESUFNT05EXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGtleXMgPSBhd2FpdCB0aGlzLmdldEF2YWlsYWJsZVBsYWNlbWVudEtleXMobW90aW9uVHlwZSwgZ3JpZE1vZGUpO1xuICAgIGNvbnNvbGUubG9nKFxuICAgICAgYEF2YWlsYWJsZSBwbGFjZW1lbnQga2V5cyBmb3IgJHttb3Rpb25UeXBlfSAoJHtncmlkTW9kZX0pOmAsXG4gICAgICBrZXlzXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgcmF3IHBsYWNlbWVudCBkYXRhIGZvciBkZWJ1Z2dpbmdcbiAgICovXG4gIGFzeW5jIGdldFBsYWNlbWVudERhdGEoXG4gICAgbW90aW9uVHlwZTogTW90aW9uVHlwZSxcbiAgICBwbGFjZW1lbnRLZXk6IHN0cmluZyxcbiAgICBncmlkTW9kZTogR3JpZE1vZGUgPSBEb21haW5HcmlkTW9kZS5ESUFNT05EXG4gICk6IFByb21pc2U8eyBbdHVybnM6IHN0cmluZ106IFtudW1iZXIsIG51bWJlcl0gfT4ge1xuICAgIGF3YWl0IHRoaXMuZW5zdXJlRGF0YUxvYWRlZCgpO1xuXG4gICAgY29uc3QgbW90aW9uUGxhY2VtZW50cyA9IHRoaXMuYWxsUGxhY2VtZW50c1tncmlkTW9kZV0/Llttb3Rpb25UeXBlXTtcbiAgICByZXR1cm4gbW90aW9uUGxhY2VtZW50cz8uW3BsYWNlbWVudEtleV0gfHwge307XG4gIH1cbn1cbiJdLAogICJtYXBwaW5ncyI6ICJBQU9BLFNBQVMsWUFBWSxzQkFBc0I7QUFFM0MsU0FBUyxrQkFBa0I7QUFDM0IsU0FBUyxpQkFBaUI7QUFvQ25CLGFBQU0sMEJBQWdFO0FBQUEsRUFDbkUsZ0JBQWtDO0FBQUEsSUFDeEMsQ0FBQyxlQUFlLE9BQU8sR0FBRyxDQUFDO0FBQUEsSUFDM0IsQ0FBQyxlQUFlLEdBQUcsR0FBRyxDQUFDO0FBQUEsRUFDekI7QUFBQSxFQUVRLGVBQWU7QUFBQTtBQUFBLEVBR04saUJBQWlCO0FBQUEsSUFDaEMsQ0FBQyxlQUFlLE9BQU8sR0FBRztBQUFBLE1BQ3hCLEtBQUs7QUFBQSxNQUNMLE1BQU07QUFBQSxNQUNOLE9BQ0U7QUFBQSxNQUNGLE1BQU07QUFBQSxNQUNOLFFBQ0U7QUFBQSxJQUNKO0FB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
