import { MotionColor, GridMode } from "/src/lib/domain/enums.ts";
export class BeatRenderingService {
  constructor(pictographService) {
    this.pictographService = pictographService;
  }
  // Canvas pool for memory efficiency
  canvasPool = [];
  MAX_POOL_SIZE = 10;
  /**
   * Render a single beat to canvas
   * Converts SVG pictograph to canvas representation
   */
  async renderBeatToCanvas(beatData, size, options) {
    if (!beatData) {
      throw new Error("Beat data is required for rendering");
    }
    if (size <= 0) {
      throw new Error(`Invalid size: ${size}`);
    }
    try {
      const canvas = this.getCanvasFromPool(size, size);
      const ctx = canvas.getContext("2d");
      if (!ctx) {
        throw new Error("Failed to get 2D context from canvas");
      }
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, size, size);
      if (beatData.isBlank || !beatData.pictographData) {
        await this.renderEmptyBeat(ctx, beatData, size, options);
        return canvas;
      }
      await this.renderPictographToCanvas(ctx, beatData, size, options);
      this.applyPostProcessing(ctx, beatData, size, options);
      return canvas;
    } catch (error) {
      throw new Error(
        `Failed to render beat to canvas: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Render start position to canvas
   * Handles the special case of sequence start position
   */
  async renderStartPositionToCanvas(sequence, size, options) {
    if (!sequence) {
      throw new Error("Sequence data is required for start position rendering");
    }
    try {
      const canvas = this.getCanvasFromPool(size, size);
      const ctx = canvas.getContext("2d");
      if (!ctx) {
        throw new Error("Failed to get 2D context from canvas");
      }
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, size, size);
      if (sequence.startPosition) {
        await this.renderPictographToCanvas(
          ctx,
          { ...sequence.startPosition, beatNumber: 0 },
          size,
          options
        );
      } else {
        await this.renderDefaultStartPosition(ctx, size, options);
      }
      if (options.addBeatNumbers) {
        this.renderStartPositionLabel(ctx, size);
      }
      return canvas;
    } catch (error) {
      throw new Error(
        `Failed to render start position: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Batch render multiple beats
   * Optimized for rendering many beats efficiently
   */
  async renderBeatsToCanvases(beats, size, options) {
    if (!beats || beats.length === 0) {
      return [];
    }
    const canvases = [];
    try {
      const CHUNK_SIZE = 5;
      for (let i = 0; i < beats.length; i += CHUNK_SIZE) {
        const chunk = beats.slice(i, i + CHUNK_SIZE);
        const chunkCanvases = await Promise.all(
          chunk.map((beat) => this.renderBeatToCanvas(beat, size, options))
        );
        canvases.push(...chunkCanvases);
      }
      return canvases;
    } catch (error) {
      canvases.forEach((canvas) => this.returnCanvasToPool(canvas));
      throw new Error(
        `Batch rendering failed: ${error instanceof Error ? error.message : "Unknown error"}`
      );
    }
  }
  /**
   * Apply visibility settings to rendered beat
   * Matches desktop visibility logic
   */
  applyVisibilitySettings(canvas, options) {
    if (options.redVisible && options.blueVisible) {
      return canvas;
    }
    const filteredCanvas = this.getCanvasFromPool(canvas.width, canvas.height);
    const filteredCtx = filteredCanvas.getContext("2d");
    if (!filteredCtx) {
      throw new Error("Failed to get 2D context from filtered canvas");
    }
    filteredCtx.drawImage(canvas, 0, 0);
    this.applyColorFilters(filteredCtx, canvas.width, canvas.height, options);
    this.returnCanvasToPool(canvas);
    return filteredCanvas;
  }
  /**
   * Render pictograph data to canvas context
   * Core rendering logic that converts pictograph to canvas
   */
  async renderPictographToCanvas(ctx, beatData, size, options) {
    if (!beatData.pictographData) {
      return;
    }
    try {
      const svgElement = await this.createSVGFromPictographData(
        beatData,
        size,
        options
      );
      if (svgElement) {
        await this.drawSVGToCanvas(ctx, svgElement, size, size);
        return;
      }
      await this.renderPictographManually(ctx, beatData, size, options);
    } catch (error) {
      console.warn("Pictograph rendering failed, using fallback:", error);
      await this.renderFallbackBeat(ctx, beatData, size, options);
    }
  }
  /**
   * Create SVG element from pictograph data
   * Uses the injected pictograph service instead of creating components directly
   */
  async createSVGFromPictographData(beatData, size, _options) {
    try {
      if (!beatData.pictographData) {
        return null;
      }
      const svgElement = await this.pictographService.renderPictograph(
        beatData.pictographData
      );
      if (svgElement) {
        svgElement.setAttribute("width", size.toString());
        svgElement.setAttribute("height", size.toString());
        svgElement.setAttribute("viewBox", `0 0 ${size} ${size}`);
        return svgElement;
      }
      return null;
    } catch (error) {
      console.warn("Failed to create SVG from pictograph service:", error);
      return null;
    }
  }
  /**
   * Draw SVG element to canvas
   */
  async drawSVGToCanvas(ctx, svgElement, width, height) {
    return new Promise((resolve, reject) => {
      try {
        const svgData = new XMLSerializer().serializeToString(svgElement);
        const img = new Image();
        img.onload = () => {
          try {
            ctx.drawImage(img, 0, 0, width, height);
            resolve();
          } catch (error) {
            reject(error);
          }
        };
        img.onerror = () => {
          reject(new Error("Failed to load SVG as image"));
        };
        const svgBlob = new Blob([svgData], {
          type: "image/svg+xml;charset=utf-8"
        });
        const url = URL.createObjectURL(svgBlob);
        img.src = url;
        img.onload = () => {
          try {
            ctx.drawImage(img, 0, 0, width, height);
            URL.revokeObjectURL(url);
            resolve();
          } catch (error) {
            URL.revokeObjectURL(url);
            reject(error);
          }
        };
      } catch (error) {
        reject(error);
      }
    });
  }
  /**
   * Manual pictograph rendering (fallback method)
   */
  async renderPictographManually(ctx, beatData, size, options) {
    const pictograph = beatData.pictographData;
    if (!pictograph) {
      throw new Error("Pictograph data is required for rendering");
    }
    this.drawGrid(ctx, pictograph.gridData?.gridMode || GridMode.DIAMOND, size);
    if (pictograph.props) {
      if (options.blueVisible && pictograph.props.blue) {
        this.drawProp(ctx, pictograph.props.blue, "blue", size);
      }
      if (options.redVisible && pictograph.props.red) {
        this.drawProp(ctx, pictograph.props.red, "red", size);
      }
    }
    if (pictograph.arrows) {
      if (options.blueVisible && pictograph.arrows.blue) {
        this.drawArrow(ctx, pictograph.arrows.blue, "blue", size);
      }
      if (options.redVisible && pictograph.arrows.red) {
        this.drawArrow(ctx, pictograph.arrows.red, "red", size);
      }
    }
    if (pictograph.letter) {
      this.drawLetter(ctx, pictograph.letter, size);
    }
  }
  /**
   * Render empty beat (blank beat with just beat number)
   */
  async renderEmptyBeat(ctx, beatData, size, options) {
    this.drawGrid(ctx, GridMode.DIAMOND, size);
    if (options.addBeatNumbers && beatData.beatNumber > 0) {
      this.drawBeatNumber(ctx, beatData.beatNumber, size);
    }
  }
  /**
   * Render fallback beat when all else fails
   */
  async renderFallbackBeat(ctx, beatData, size, options) {
    ctx.strokeStyle = "#ccc";
    ctx.lineWidth = 2;
    ctx.strokeRect(10, 10, size - 20, size - 20);
    ctx.beginPath();
    ctx.moveTo(20, 20);
    ctx.lineTo(size - 20, size - 20);
    ctx.moveTo(size - 20, 20);
    ctx.lineTo(20, size - 20);
    ctx.stroke();
    if (options.addBeatNumbers) {
      this.drawBeatNumber(ctx, beatData.beatNumber, size);
    }
  }
  /**
   * Render default start position
   */
  async renderDefaultStartPosition(ctx, size, _options) {
    this.drawGrid(ctx, GridMode.DIAMOND, size);
    const centerX = size / 2;
    const centerY = size / 2;
    const radius = size * 0.1;
    ctx.fillStyle = "#10b981";
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fill();
  }
  /**
   * Draw simple grid pattern
   */
  drawGrid(ctx, gridMode, size) {
    ctx.strokeStyle = "#e5e7eb";
    ctx.lineWidth = 1;
    if (gridMode === GridMode.DIAMOND) {
      const centerX = size / 2;
      const centerY = size / 2;
      const radius = size * 0.4;
      ctx.beginPath();
      ctx.moveTo(centerX, centerY - radius);
      ctx.lineTo(centerX + radius, centerY);
      ctx.lineTo(centerX, centerY + radius);
      ctx.lineTo(centerX - radius, centerY);
      ctx.closePath();
      ctx.stroke();
    } else {
      const margin = size * 0.1;
      ctx.strokeRect(margin, margin, size - 2 * margin, size - 2 * margin);
    }
  }
  /**
   * Draw prop placeholder
   */
  drawProp(ctx, propData, color, size) {
    if (!propData) return;
    const centerX = size / 2;
    const centerY = size / 2;
    const radius = size * 0.05;
    ctx.fillStyle = color === MotionColor.BLUE ? "#3b82f6" : "#ef4444";
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.fill();
  }
  /**
   * Draw arrow placeholder
   */
  drawArrow(ctx, arrowData, color, size) {
    if (!arrowData) return;
    const centerX = size / 2;
    const centerY = size / 2;
    const length = size * 0.2;
    ctx.strokeStyle = color === "blue" ? "#3b82f6" : "#ef4444";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(centerX - length / 2, centerY);
    ctx.lineTo(centerX + length / 2, centerY);
    ctx.moveTo(centerX + length / 2 - 10, centerY - 5);
    ctx.lineTo(centerX + length / 2, centerY);
    ctx.lineTo(centerX + length / 2 - 10, centerY + 5);
    ctx.stroke();
  }
  /**
   * Draw letter text
   */
  drawLetter(ctx, letter, size) {
    ctx.fillStyle = "#374151";
    ctx.font = `${size * 0.2}px Arial, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(letter, size / 2, size / 2);
  }
  /**
   * Draw beat number
   */
  drawBeatNumber(ctx, beatNumber, size) {
    ctx.fillStyle = "#4b5563";
    ctx.font = `bold ${size * 0.15}px Arial, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    ctx.fillText(beatNumber.toString(), size / 2, size * 0.05);
  }
  /**
   * Render start position label
   */
  renderStartPositionLabel(ctx, size) {
    ctx.fillStyle = "#059669";
    ctx.font = `bold ${size * 0.12}px Arial, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    ctx.fillText("START", size / 2, size * 0.05);
  }
  /**
   * Apply post-processing effects
   */
  applyPostProcessing(ctx, beatData, size, options) {
    if (options.combinedGrids) {
      this.applyCombinedGrids(ctx, size);
    }
    if (beatData.blueReversal || beatData.redReversal) {
      this.drawReversalSymbols(ctx, beatData, size);
    }
  }
  /**
   * Apply combined grids overlay
   */
  applyCombinedGrids(ctx, size) {
    ctx.globalAlpha = 0.5;
    this.drawGrid(ctx, GridMode.DIAMOND, size);
    this.drawGrid(ctx, GridMode.BOX, size);
    ctx.globalAlpha = 1;
  }
  /**
   * Draw reversal symbols
   */
  drawReversalSymbols(ctx, beatData, size) {
    const symbolSize = size * 0.08;
    if (beatData.blueReversal) {
      ctx.fillStyle = "#3b82f6";
      ctx.fillRect(size - symbolSize - 5, 5, symbolSize, symbolSize);
    }
    if (beatData.redReversal) {
      ctx.fillStyle = "#ef4444";
      ctx.fillRect(
        size - symbolSize - 5,
        symbolSize + 10,
        symbolSize,
        symbolSize
      );
    }
  }
  /**
   * Apply color visibility filters
   */
  applyColorFilters(ctx, width, height, options) {
    if (!options.redVisible || !options.blueVisible) {
      console.warn("Color filtering not fully implemented yet");
    }
  }
  /**
   * Canvas pool management
   */
  getCanvasFromPool(width, height) {
    const canvas = this.canvasPool.pop() || document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    if (!ctx) {
      throw new Error("Failed to get 2D context from canvas");
    }
    ctx.clearRect(0, 0, width, height);
    return canvas;
  }
  returnCanvasToPool(canvas) {
    if (this.canvasPool.length < this.MAX_POOL_SIZE) {
      this.canvasPool.push(canvas);
    }
  }
  /**
   * Cleanup method to dispose of resources
   */
  dispose() {
    this.canvasPool.length = 0;
  }
}
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiQzovVEtBL3dlYi9zcmMvbGliL3NlcnZpY2VzL2ltcGxlbWVudGF0aW9ucy9pbWFnZS1leHBvcnQvQmVhdFJlbmRlcmluZ1NlcnZpY2UudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbIi8qKlxuICogQmVhdCBSZW5kZXJpbmcgU2VydmljZVxuICpcbiAqIENvbnZlcnRzIFRLQSBiZWF0cyBhbmQgcGljdG9ncmFwaHMgZnJvbSBTVkcgZm9ybWF0IHRvIENhbnZhcyBmb3IgaW1hZ2UgZXhwb3J0LlxuICogVGhpcyBzZXJ2aWNlIHByb3ZpZGVzIGZ1bmN0aW9uYWxpdHkgZXF1aXZhbGVudCB0byB0aGUgZGVza3RvcCBCZWF0RHJhd2VyIGFuZFxuICogSW1hZ2VFeHBvcnRCZWF0RmFjdG9yeSwgaGFuZGxpbmcgdGhlIGNvbXBsZXggdGFzayBvZiByZW5kZXJpbmcgYmVhdHMgZm9yIGV4cG9ydC5cbiAqXG4gKiBDcml0aWNhbDogTXVzdCBtYWludGFpbiB2aXN1YWwgZmlkZWxpdHkgd2hlbiBjb252ZXJ0aW5nIGZyb20gU1ZHIHRvIENhbnZhcy5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7XG4gIElCZWF0UmVuZGVyaW5nU2VydmljZSxcbiAgQmVhdFJlbmRlck9wdGlvbnMsXG59IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL2ltYWdlLWV4cG9ydC1pbnRlcmZhY2VzXCI7XG5pbXBvcnQgdHlwZSB7IEJlYXREYXRhLCBTZXF1ZW5jZURhdGEgfSBmcm9tIFwiLi4vLi4vaW50ZXJmYWNlcy9kb21haW4tdHlwZXNcIjtcbmltcG9ydCB0eXBlIHsgUHJvcERhdGEsIEFycm93RGF0YSB9IGZyb20gXCIkbGliL2RvbWFpblwiO1xuaW1wb3J0IHsgTW90aW9uQ29sb3IsIEdyaWRNb2RlIH0gZnJvbSBcIiRsaWIvZG9tYWluL2VudW1zXCI7XG5pbXBvcnQgdHlwZSB7IElQaWN0b2dyYXBoU2VydmljZSB9IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzL3BpY3RvZ3JhcGgtaW50ZXJmYWNlc1wiO1xuXG5leHBvcnQgY2xhc3MgQmVhdFJlbmRlcmluZ1NlcnZpY2UgaW1wbGVtZW50cyBJQmVhdFJlbmRlcmluZ1NlcnZpY2Uge1xuICAvLyBDYW52YXMgcG9vbCBmb3IgbWVtb3J5IGVmZmljaWVuY3lcbiAgcHJpdmF0ZSBjYW52YXNQb29sOiBIVE1MQ2FudmFzRWxlbWVudFtdID0gW107XG4gIHByaXZhdGUgcmVhZG9ubHkgTUFYX1BPT0xfU0laRSA9IDEwO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcGljdG9ncmFwaFNlcnZpY2U6IElQaWN0b2dyYXBoU2VydmljZSkge31cblxuICAvKipcbiAgICogUmVuZGVyIGEgc2luZ2xlIGJlYXQgdG8gY2FudmFzXG4gICAqIENvbnZlcnRzIFNWRyBwaWN0b2dyYXBoIHRvIGNhbnZhcyByZXByZXNlbnRhdGlvblxuICAgKi9cbiAgYXN5bmMgcmVuZGVyQmVhdFRvQ2FudmFzKFxuICAgIGJlYXREYXRhOiBCZWF0RGF0YSxcbiAgICBzaXplOiBudW1iZXIsXG4gICAgb3B0aW9uczogQmVhdFJlbmRlck9wdGlvbnNcbiAgKTogUHJvbWlzZTxIVE1MQ2FudmFzRWxlbWVudD4ge1xuICAgIGlmICghYmVhdERhdGEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkJlYXQgZGF0YSBpcyByZXF1aXJlZCBmb3IgcmVuZGVyaW5nXCIpO1xuICAgIH1cblxuICAgIGlmIChzaXplIDw9IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBzaXplOiAke3NpemV9YCk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENyZWF0ZSBjYW52YXMgZm9yIHRoaXMgYmVhdFxuICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5nZXRDYW52YXNGcm9tUG9vbChzaXplLCBzaXplKTtcbiAgICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XG4gICAgICBpZiAoIWN0eCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJGYWlsZWQgdG8gZ2V0IDJEIGNvbnRleHQgZnJvbSBjYW52YXNcIik7XG4gICAgICB9XG5cbiAgICAgIC8vIENsZWFyIGNhbnZhcyB3aXRoIHdoaXRlIGJhY2tncm91bmQgKG1hdGNoIGRlc2t0b3ApXG4gICAgICBjdHguZmlsbFN0eWxlID0gXCJ3aGl0ZVwiO1xuICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIHNpemUsIHNpemUpO1xuXG4gICAgICAvLyBJZiBiZWF0IGlzIGJsYW5rLCByZXR1cm4gY2FudmFzIHdpdGgganVzdCBiYWNrZ3JvdW5kXG4gICAgICBpZiAoYmVhdERhdGEuaXNCbGFuayB8fCAhYmVhdERhdGEucGljdG9ncmFwaERhdGEpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5yZW5kZXJFbXB0eUJlYXQoY3R4LCBiZWF0RGF0YSwgc2l6ZSwgb3B0aW9ucyk7XG4gICAgICAgIHJldHVybiBjYW52YXM7XG4gICAgICB9XG5cbiAgICAgIC8vIFJlbmRlciBwaWN0b2dyYXBoIHRvIGNhbnZhc1xuICAgICAgYXdhaXQgdGhpcy5yZW5kZXJQaWN0b2dyYXBoVG9DYW52YXMoY3R4LCBiZWF0RGF0YSwgc2l6ZSwgb3B0aW9ucyk7XG5cbiAgICAgIC8vIEFwcGx5IHBvc3QtcHJvY2Vzc2luZ1xuICAgICAgdGhpcy5hcHBseVBvc3RQcm9jZXNzaW5nKGN0eCwgYmVhdERhdGEsIHNpemUsIG9wdGlvbnMpO1xuXG4gICAgICByZXR1cm4gY2FudmFzO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBGYWlsZWQgdG8gcmVuZGVyIGJlYXQgdG8gY2FudmFzOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogXCJVbmtub3duIGVycm9yXCJ9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVuZGVyIHN0YXJ0IHBvc2l0aW9uIHRvIGNhbnZhc1xuICAgKiBIYW5kbGVzIHRoZSBzcGVjaWFsIGNhc2Ugb2Ygc2VxdWVuY2Ugc3RhcnQgcG9zaXRpb25cbiAgICovXG4gIGFzeW5jIHJlbmRlclN0YXJ0UG9zaXRpb25Ub0NhbnZhcyhcbiAgICBzZXF1ZW5jZTogU2VxdWVuY2VEYXRhLFxuICAgIHNpemU6IG51bWJlcixcbiAgICBvcHRpb25zOiBCZWF0UmVuZGVyT3B0aW9uc1xuICApOiBQcm9taXNlPEhUTUxDYW52YXNFbGVtZW50PiB7XG4gICAgaWYgKCFzZXF1ZW5jZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiU2VxdWVuY2UgZGF0YSBpcyByZXF1aXJlZCBmb3Igc3RhcnQgcG9zaXRpb24gcmVuZGVyaW5nXCIpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBjYW52YXMgPSB0aGlzLmdldENhbnZhc0Zyb21Qb29sKHNpemUsIHNpemUpO1xuICAgICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKTtcbiAgICAgIGlmICghY3R4KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkZhaWxlZCB0byBnZXQgMkQgY29udGV4dCBmcm9tIGNhbnZhc1wiKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2xlYXIgY2FudmFzIHdpdGggd2hpdGUgYmFja2dyb3VuZFxuICAgICAgY3R4LmZpbGxTdHlsZSA9IFwid2hpdGVcIjtcbiAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzaXplLCBzaXplKTtcblxuICAgICAgLy8gQ2hlY2sgaWYgc2VxdWVuY2UgaGFzIGV4cGxpY2l0IHN0YXJ0IHBvc2l0aW9uIGRhdGFcbiAgICAgIGlmIChzZXF1ZW5jZS5zdGFydFBvc2l0aW9uKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucmVuZGVyUGljdG9ncmFwaFRvQ2FudmFzKFxuICAgICAgICAgIGN0eCxcbiAgICAgICAgICB7IC4uLnNlcXVlbmNlLnN0YXJ0UG9zaXRpb24sIGJlYXROdW1iZXI6IDAgfSBhcyBCZWF0RGF0YSxcbiAgICAgICAgICBzaXplLFxuICAgICAgICAgIG9wdGlvbnNcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFJlbmRlciBkZWZhdWx0IHN0YXJ0IHBvc2l0aW9uXG4gICAgICAgIGF3YWl0IHRoaXMucmVuZGVyRGVmYXVsdFN0YXJ0UG9zaXRpb24oY3R4LCBzaXplLCBvcHRpb25zKTtcbiAgICAgIH1cblxuICAgICAgLy8gQWRkIFwiU1RBUlRcIiBsYWJlbCBpZiBiZWF0IG51bWJlcnMgYXJlIGVuYWJsZWRcbiAgICAgIGlmIChvcHRpb25zLmFkZEJlYXROdW1iZXJzKSB7XG4gICAgICAgIHRoaXMucmVuZGVyU3RhcnRQb3NpdGlvbkxhYmVsKGN0eCwgc2l6ZSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBjYW52YXM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEZhaWxlZCB0byByZW5kZXIgc3RhcnQgcG9zaXRpb246ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBcIlVua25vd24gZXJyb3JcIn1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBCYXRjaCByZW5kZXIgbXVsdGlwbGUgYmVhdHNcbiAgICogT3B0aW1pemVkIGZvciByZW5kZXJpbmcgbWFueSBiZWF0cyBlZmZpY2llbnRseVxuICAgKi9cbiAgYXN5bmMgcmVuZGVyQmVhdHNUb0NhbnZhc2VzKFxuICAgIGJlYXRzOiBCZWF0RGF0YVtdLFxuICAgIHNpemU6IG51bWJlcixcbiAgICBvcHRpb25zOiBCZWF0UmVuZGVyT3B0aW9uc1xuICApOiBQcm9taXNlPEhUTUxDYW52YXNFbGVtZW50W10+IHtcbiAgICBpZiAoIWJlYXRzIHx8IGJlYXRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIGNvbnN0IGNhbnZhc2VzOiBIVE1MQ2FudmFzRWxlbWVudFtdID0gW107XG5cbiAgICB0cnkge1xuICAgICAgLy8gUHJvY2VzcyBiZWF0cyBpbiBjaHVua3MgdG8gbWFuYWdlIG1lbW9yeVxuICAgICAgY29uc3QgQ0hVTktfU0laRSA9IDU7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJlYXRzLmxlbmd0aDsgaSArPSBDSFVOS19TSVpFKSB7XG4gICAgICAgIGNvbnN0IGNodW5rID0gYmVhdHMuc2xpY2UoaSwgaSArIENIVU5LX1NJWkUpO1xuICAgICAgICBjb25zdCBjaHVua0NhbnZhc2VzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgICAgY2h1bmsubWFwKChiZWF0KSA9PiB0aGlzLnJlbmRlckJlYXRUb0NhbnZhcyhiZWF0LCBzaXplLCBvcHRpb25zKSlcbiAgICAgICAgKTtcbiAgICAgICAgY2FudmFzZXMucHVzaCguLi5jaHVua0NhbnZhc2VzKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGNhbnZhc2VzO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBDbGVhbiB1cCBhbnkgY3JlYXRlZCBjYW52YXNlcyBvbiBlcnJvclxuICAgICAgY2FudmFzZXMuZm9yRWFjaCgoY2FudmFzKSA9PiB0aGlzLnJldHVybkNhbnZhc1RvUG9vbChjYW52YXMpKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEJhdGNoIHJlbmRlcmluZyBmYWlsZWQ6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBcIlVua25vd24gZXJyb3JcIn1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBseSB2aXNpYmlsaXR5IHNldHRpbmdzIHRvIHJlbmRlcmVkIGJlYXRcbiAgICogTWF0Y2hlcyBkZXNrdG9wIHZpc2liaWxpdHkgbG9naWNcbiAgICovXG4gIGFwcGx5VmlzaWJpbGl0eVNldHRpbmdzKFxuICAgIGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQsXG4gICAgb3B0aW9uczogQmVhdFJlbmRlck9wdGlvbnNcbiAgKTogSFRNTENhbnZhc0VsZW1lbnQge1xuICAgIGlmIChvcHRpb25zLnJlZFZpc2libGUgJiYgb3B0aW9ucy5ibHVlVmlzaWJsZSkge1xuICAgICAgLy8gQm90aCB2aXNpYmxlIC0gbm8gY2hhbmdlcyBuZWVkZWRcbiAgICAgIHJldHVybiBjYW52YXM7XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGEgbmV3IGNhbnZhcyBmb3IgZmlsdGVyZWQgcmVzdWx0XG4gICAgY29uc3QgZmlsdGVyZWRDYW52YXMgPSB0aGlzLmdldENhbnZhc0Zyb21Qb29sKGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XG4gICAgY29uc3QgZmlsdGVyZWRDdHggPSBmaWx0ZXJlZENhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XG4gICAgaWYgKCFmaWx0ZXJlZEN0eCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRmFpbGVkIHRvIGdldCAyRCBjb250ZXh0IGZyb20gZmlsdGVyZWQgY2FudmFzXCIpO1xuICAgIH1cblxuICAgIC8vIERyYXcgb3JpZ2luYWwgY2FudmFzXG4gICAgZmlsdGVyZWRDdHguZHJhd0ltYWdlKGNhbnZhcywgMCwgMCk7XG5cbiAgICAvLyBBcHBseSB2aXNpYmlsaXR5IGZpbHRlcnNcbiAgICB0aGlzLmFwcGx5Q29sb3JGaWx0ZXJzKGZpbHRlcmVkQ3R4LCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQsIG9wdGlvbnMpO1xuXG4gICAgLy8gUmV0dXJuIG9yaWdpbmFsIGNhbnZhcyB0byBwb29sXG4gICAgdGhpcy5yZXR1cm5DYW52YXNUb1Bvb2woY2FudmFzKTtcblxuICAgIHJldHVybiBmaWx0ZXJlZENhbnZhcztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW5kZXIgcGljdG9ncmFwaCBkYXRhIHRvIGNhbnZhcyBjb250ZXh0XG4gICAqIENvcmUgcmVuZGVyaW5nIGxvZ2ljIHRoYXQgY29udmVydHMgcGljdG9ncmFwaCB0byBjYW52YXNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgcmVuZGVyUGljdG9ncmFwaFRvQ2FudmFzKFxuICAgIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELFxuICAgIGJlYXREYXRhOiBCZWF0RGF0YSxcbiAgICBzaXplOiBudW1iZXIsXG4gICAgb3B0aW9uczogQmVhdFJlbmRlck9wdGlvbnNcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCFiZWF0RGF0YS5waWN0b2dyYXBoRGF0YSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBNZXRob2QgMTogVHJ5IHRvIHJlbmRlciB1c2luZyBleGlzdGluZyBQaWN0b2dyYXBoIGNvbXBvbmVudFxuICAgICAgY29uc3Qgc3ZnRWxlbWVudCA9IGF3YWl0IHRoaXMuY3JlYXRlU1ZHRnJvbVBpY3RvZ3JhcGhEYXRhKFxuICAgICAgICBiZWF0RGF0YSxcbiAgICAgICAgc2l6ZSxcbiAgICAgICAgb3B0aW9uc1xuICAgICAgKTtcbiAgICAgIGlmIChzdmdFbGVtZW50KSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZHJhd1NWR1RvQ2FudmFzKGN0eCwgc3ZnRWxlbWVudCwgc2l6ZSwgc2l6ZSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gTWV0aG9kIDI6IEZhbGxiYWNrIHRvIG1hbnVhbCByZW5kZXJpbmdcbiAgICAgIGF3YWl0IHRoaXMucmVuZGVyUGljdG9ncmFwaE1hbnVhbGx5KGN0eCwgYmVhdERhdGEsIHNpemUsIG9wdGlvbnMpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJQaWN0b2dyYXBoIHJlbmRlcmluZyBmYWlsZWQsIHVzaW5nIGZhbGxiYWNrOlwiLCBlcnJvcik7XG4gICAgICBhd2FpdCB0aGlzLnJlbmRlckZhbGxiYWNrQmVhdChjdHgsIGJlYXREYXRhLCBzaXplLCBvcHRpb25zKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIFNWRyBlbGVtZW50IGZyb20gcGljdG9ncmFwaCBkYXRhXG4gICAqIFVzZXMgdGhlIGluamVjdGVkIHBpY3RvZ3JhcGggc2VydmljZSBpbnN0ZWFkIG9mIGNyZWF0aW5nIGNvbXBvbmVudHMgZGlyZWN0bHlcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgY3JlYXRlU1ZHRnJvbVBpY3RvZ3JhcGhEYXRhKFxuICAgIGJlYXREYXRhOiBCZWF0RGF0YSxcbiAgICBzaXplOiBudW1iZXIsXG4gICAgX29wdGlvbnM6IEJlYXRSZW5kZXJPcHRpb25zXG4gICk6IFByb21pc2U8U1ZHRWxlbWVudCB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgaWYgKCFiZWF0RGF0YS5waWN0b2dyYXBoRGF0YSkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgLy8gVXNlIHRoZSBpbmplY3RlZCBwaWN0b2dyYXBoIHNlcnZpY2UgdG8gcmVuZGVyIHRoZSBwaWN0b2dyYXBoIHRvIFNWR1xuICAgICAgY29uc3Qgc3ZnRWxlbWVudCA9IGF3YWl0IHRoaXMucGljdG9ncmFwaFNlcnZpY2UucmVuZGVyUGljdG9ncmFwaChcbiAgICAgICAgYmVhdERhdGEucGljdG9ncmFwaERhdGFcbiAgICAgICk7XG5cbiAgICAgIGlmIChzdmdFbGVtZW50KSB7XG4gICAgICAgIC8vIFNldCBhcHByb3ByaWF0ZSBzaXplIGF0dHJpYnV0ZXMgb24gdGhlIFNWR1xuICAgICAgICBzdmdFbGVtZW50LnNldEF0dHJpYnV0ZShcIndpZHRoXCIsIHNpemUudG9TdHJpbmcoKSk7XG4gICAgICAgIHN2Z0VsZW1lbnQuc2V0QXR0cmlidXRlKFwiaGVpZ2h0XCIsIHNpemUudG9TdHJpbmcoKSk7XG4gICAgICAgIHN2Z0VsZW1lbnQuc2V0QXR0cmlidXRlKFwidmlld0JveFwiLCBgMCAwICR7c2l6ZX0gJHtzaXplfWApO1xuXG4gICAgICAgIHJldHVybiBzdmdFbGVtZW50O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKFwiRmFpbGVkIHRvIGNyZWF0ZSBTVkcgZnJvbSBwaWN0b2dyYXBoIHNlcnZpY2U6XCIsIGVycm9yKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEcmF3IFNWRyBlbGVtZW50IHRvIGNhbnZhc1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBkcmF3U1ZHVG9DYW52YXMoXG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsXG4gICAgc3ZnRWxlbWVudDogU1ZHRWxlbWVudCxcbiAgICB3aWR0aDogbnVtYmVyLFxuICAgIGhlaWdodDogbnVtYmVyXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICAvLyBTZXJpYWxpemUgU1ZHIHRvIHN0cmluZ1xuICAgICAgICBjb25zdCBzdmdEYXRhID0gbmV3IFhNTFNlcmlhbGl6ZXIoKS5zZXJpYWxpemVUb1N0cmluZyhzdmdFbGVtZW50KTtcblxuICAgICAgICAvLyBDcmVhdGUgaW1hZ2UgZnJvbSBTVkdcbiAgICAgICAgY29uc3QgaW1nID0gbmV3IEltYWdlKCk7XG5cbiAgICAgICAgaW1nLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDAsIDAsIHdpZHRoLCBoZWlnaHQpO1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBpbWcub25lcnJvciA9ICgpID0+IHtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKFwiRmFpbGVkIHRvIGxvYWQgU1ZHIGFzIGltYWdlXCIpKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBDb252ZXJ0IFNWRyB0byBkYXRhIFVSTFxuICAgICAgICBjb25zdCBzdmdCbG9iID0gbmV3IEJsb2IoW3N2Z0RhdGFdLCB7XG4gICAgICAgICAgdHlwZTogXCJpbWFnZS9zdmcreG1sO2NoYXJzZXQ9dXRmLThcIixcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoc3ZnQmxvYik7XG5cbiAgICAgICAgaW1nLnNyYyA9IHVybDtcblxuICAgICAgICAvLyBDbGVhbiB1cCBVUkwgYWZ0ZXIgaW1hZ2UgbG9hZHNcbiAgICAgICAgaW1nLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDAsIDAsIHdpZHRoLCBoZWlnaHQpO1xuICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpO1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7XG4gICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogTWFudWFsIHBpY3RvZ3JhcGggcmVuZGVyaW5nIChmYWxsYmFjayBtZXRob2QpXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHJlbmRlclBpY3RvZ3JhcGhNYW51YWxseShcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICBiZWF0RGF0YTogQmVhdERhdGEsXG4gICAgc2l6ZTogbnVtYmVyLFxuICAgIG9wdGlvbnM6IEJlYXRSZW5kZXJPcHRpb25zXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHBpY3RvZ3JhcGggPSBiZWF0RGF0YS5waWN0b2dyYXBoRGF0YTtcbiAgICBpZiAoIXBpY3RvZ3JhcGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlBpY3RvZ3JhcGggZGF0YSBpcyByZXF1aXJlZCBmb3IgcmVuZGVyaW5nXCIpO1xuICAgIH1cblxuICAgIC8vIERyYXcgZ3JpZCBiYWNrZ3JvdW5kXG4gICAgdGhpcy5kcmF3R3JpZChjdHgsIHBpY3RvZ3JhcGguZ3JpZERhdGE/LmdyaWRNb2RlIHx8IEdyaWRNb2RlLkRJQU1PTkQsIHNpemUpO1xuXG4gICAgLy8gRHJhdyBwcm9wcyBpZiB2aXNpYmxlXG4gICAgaWYgKHBpY3RvZ3JhcGgucHJvcHMpIHtcbiAgICAgIGlmIChvcHRpb25zLmJsdWVWaXNpYmxlICYmIHBpY3RvZ3JhcGgucHJvcHMuYmx1ZSkge1xuICAgICAgICB0aGlzLmRyYXdQcm9wKGN0eCwgcGljdG9ncmFwaC5wcm9wcy5ibHVlLCBcImJsdWVcIiwgc2l6ZSk7XG4gICAgICB9XG4gICAgICBpZiAob3B0aW9ucy5yZWRWaXNpYmxlICYmIHBpY3RvZ3JhcGgucHJvcHMucmVkKSB7XG4gICAgICAgIHRoaXMuZHJhd1Byb3AoY3R4LCBwaWN0b2dyYXBoLnByb3BzLnJlZCwgXCJyZWRcIiwgc2l6ZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gRHJhdyBhcnJvd3MgaWYgdmlzaWJsZVxuICAgIGlmIChwaWN0b2dyYXBoLmFycm93cykge1xuICAgICAgaWYgKG9wdGlvbnMuYmx1ZVZpc2libGUgJiYgcGljdG9ncmFwaC5hcnJvd3MuYmx1ZSkge1xuICAgICAgICB0aGlzLmRyYXdBcnJvdyhjdHgsIHBpY3RvZ3JhcGguYXJyb3dzLmJsdWUsIFwiYmx1ZVwiLCBzaXplKTtcbiAgICAgIH1cbiAgICAgIGlmIChvcHRpb25zLnJlZFZpc2libGUgJiYgcGljdG9ncmFwaC5hcnJvd3MucmVkKSB7XG4gICAgICAgIHRoaXMuZHJhd0Fycm93KGN0eCwgcGljdG9ncmFwaC5hcnJvd3MucmVkLCBcInJlZFwiLCBzaXplKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBEcmF3IGxldHRlciBpZiBwcmVzZW50XG4gICAgaWYgKHBpY3RvZ3JhcGgubGV0dGVyKSB7XG4gICAgICB0aGlzLmRyYXdMZXR0ZXIoY3R4LCBwaWN0b2dyYXBoLmxldHRlciwgc2l6ZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlbmRlciBlbXB0eSBiZWF0IChibGFuayBiZWF0IHdpdGgganVzdCBiZWF0IG51bWJlcilcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgcmVuZGVyRW1wdHlCZWF0KFxuICAgIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELFxuICAgIGJlYXREYXRhOiBCZWF0RGF0YSxcbiAgICBzaXplOiBudW1iZXIsXG4gICAgb3B0aW9uczogQmVhdFJlbmRlck9wdGlvbnNcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gRHJhdyBtaW5pbWFsIGdyaWRcbiAgICB0aGlzLmRyYXdHcmlkKGN0eCwgR3JpZE1vZGUuRElBTU9ORCwgc2l6ZSk7XG5cbiAgICAvLyBEcmF3IGJlYXQgbnVtYmVyIGlmIGVuYWJsZWRcbiAgICBpZiAob3B0aW9ucy5hZGRCZWF0TnVtYmVycyAmJiBiZWF0RGF0YS5iZWF0TnVtYmVyID4gMCkge1xuICAgICAgdGhpcy5kcmF3QmVhdE51bWJlcihjdHgsIGJlYXREYXRhLmJlYXROdW1iZXIsIHNpemUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZW5kZXIgZmFsbGJhY2sgYmVhdCB3aGVuIGFsbCBlbHNlIGZhaWxzXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHJlbmRlckZhbGxiYWNrQmVhdChcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICBiZWF0RGF0YTogQmVhdERhdGEsXG4gICAgc2l6ZTogbnVtYmVyLFxuICAgIG9wdGlvbnM6IEJlYXRSZW5kZXJPcHRpb25zXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIERyYXcgYmFzaWMgcGxhY2Vob2xkZXJcbiAgICBjdHguc3Ryb2tlU3R5bGUgPSBcIiNjY2NcIjtcbiAgICBjdHgubGluZVdpZHRoID0gMjtcbiAgICBjdHguc3Ryb2tlUmVjdCgxMCwgMTAsIHNpemUgLSAyMCwgc2l6ZSAtIDIwKTtcblxuICAgIC8vIERyYXcgWCB0byBpbmRpY2F0ZSBlcnJvclxuICAgIGN0eC5iZWdpblBhdGgoKTtcbiAgICBjdHgubW92ZVRvKDIwLCAyMCk7XG4gICAgY3R4LmxpbmVUbyhzaXplIC0gMjAsIHNpemUgLSAyMCk7XG4gICAgY3R4Lm1vdmVUbyhzaXplIC0gMjAsIDIwKTtcbiAgICBjdHgubGluZVRvKDIwLCBzaXplIC0gMjApO1xuICAgIGN0eC5zdHJva2UoKTtcblxuICAgIC8vIERyYXcgYmVhdCBudW1iZXJcbiAgICBpZiAob3B0aW9ucy5hZGRCZWF0TnVtYmVycykge1xuICAgICAgdGhpcy5kcmF3QmVhdE51bWJlcihjdHgsIGJlYXREYXRhLmJlYXROdW1iZXIsIHNpemUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZW5kZXIgZGVmYXVsdCBzdGFydCBwb3NpdGlvblxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyByZW5kZXJEZWZhdWx0U3RhcnRQb3NpdGlvbihcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICBzaXplOiBudW1iZXIsXG4gICAgX29wdGlvbnM6IEJlYXRSZW5kZXJPcHRpb25zXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIERyYXcgZ3JpZFxuICAgIHRoaXMuZHJhd0dyaWQoY3R4LCBHcmlkTW9kZS5ESUFNT05ELCBzaXplKTtcblxuICAgIC8vIERyYXcgY2VudGVyIGNpcmNsZSB0byBpbmRpY2F0ZSBzdGFydCBwb3NpdGlvblxuICAgIGNvbnN0IGNlbnRlclggPSBzaXplIC8gMjtcbiAgICBjb25zdCBjZW50ZXJZID0gc2l6ZSAvIDI7XG4gICAgY29uc3QgcmFkaXVzID0gc2l6ZSAqIDAuMTtcblxuICAgIGN0eC5maWxsU3R5bGUgPSBcIiMxMGI5ODFcIjsgLy8gR3JlZW4gY29sb3IgZm9yIHN0YXJ0XG4gICAgY3R4LmJlZ2luUGF0aCgpO1xuICAgIGN0eC5hcmMoY2VudGVyWCwgY2VudGVyWSwgcmFkaXVzLCAwLCAyICogTWF0aC5QSSk7XG4gICAgY3R4LmZpbGwoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEcmF3IHNpbXBsZSBncmlkIHBhdHRlcm5cbiAgICovXG4gIHByaXZhdGUgZHJhd0dyaWQoXG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsXG4gICAgZ3JpZE1vZGU6IHN0cmluZyxcbiAgICBzaXplOiBudW1iZXJcbiAgKTogdm9pZCB7XG4gICAgY3R4LnN0cm9rZVN0eWxlID0gXCIjZTVlN2ViXCI7XG4gICAgY3R4LmxpbmVXaWR0aCA9IDE7XG5cbiAgICBpZiAoZ3JpZE1vZGUgPT09IEdyaWRNb2RlLkRJQU1PTkQpIHtcbiAgICAgIC8vIERyYXcgZGlhbW9uZCBncmlkXG4gICAgICBjb25zdCBjZW50ZXJYID0gc2l6ZSAvIDI7XG4gICAgICBjb25zdCBjZW50ZXJZID0gc2l6ZSAvIDI7XG4gICAgICBjb25zdCByYWRpdXMgPSBzaXplICogMC40O1xuXG4gICAgICBjdHguYmVnaW5QYXRoKCk7XG4gICAgICBjdHgubW92ZVRvKGNlbnRlclgsIGNlbnRlclkgLSByYWRpdXMpO1xuICAgICAgY3R4LmxpbmVUbyhjZW50ZXJYICsgcmFkaXVzLCBjZW50ZXJZKTtcbiAgICAgIGN0eC5saW5lVG8oY2VudGVyWCwgY2VudGVyWSArIHJhZGl1cyk7XG4gICAgICBjdHgubGluZVRvKGNlbnRlclggLSByYWRpdXMsIGNlbnRlclkpO1xuICAgICAgY3R4LmNsb3NlUGF0aCgpO1xuICAgICAgY3R4LnN0cm9rZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBEcmF3IGJveCBncmlkXG4gICAgICBjb25zdCBtYXJnaW4gPSBzaXplICogMC4xO1xuICAgICAgY3R4LnN0cm9rZVJlY3QobWFyZ2luLCBtYXJnaW4sIHNpemUgLSAyICogbWFyZ2luLCBzaXplIC0gMiAqIG1hcmdpbik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERyYXcgcHJvcCBwbGFjZWhvbGRlclxuICAgKi9cbiAgcHJpdmF0ZSBkcmF3UHJvcChcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICBwcm9wRGF0YTogUHJvcERhdGEgfCBudWxsLFxuICAgIGNvbG9yOiBzdHJpbmcsXG4gICAgc2l6ZTogbnVtYmVyXG4gICk6IHZvaWQge1xuICAgIGlmICghcHJvcERhdGEpIHJldHVybjtcblxuICAgIGNvbnN0IGNlbnRlclggPSBzaXplIC8gMjtcbiAgICBjb25zdCBjZW50ZXJZID0gc2l6ZSAvIDI7XG4gICAgY29uc3QgcmFkaXVzID0gc2l6ZSAqIDAuMDU7XG5cbiAgICBjdHguZmlsbFN0eWxlID0gY29sb3IgPT09IE1vdGlvbkNvbG9yLkJMVUUgPyBcIiMzYjgyZjZcIiA6IFwiI2VmNDQ0NFwiO1xuICAgIGN0eC5iZWdpblBhdGgoKTtcbiAgICBjdHguYXJjKGNlbnRlclgsIGNlbnRlclksIHJhZGl1cywgMCwgMiAqIE1hdGguUEkpO1xuICAgIGN0eC5maWxsKCk7XG4gIH1cblxuICAvKipcbiAgICogRHJhdyBhcnJvdyBwbGFjZWhvbGRlclxuICAgKi9cbiAgcHJpdmF0ZSBkcmF3QXJyb3coXG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsXG4gICAgYXJyb3dEYXRhOiBBcnJvd0RhdGEgfCBudWxsLFxuICAgIGNvbG9yOiBzdHJpbmcsXG4gICAgc2l6ZTogbnVtYmVyXG4gICk6IHZvaWQge1xuICAgIGlmICghYXJyb3dEYXRhKSByZXR1cm47XG5cbiAgICBjb25zdCBjZW50ZXJYID0gc2l6ZSAvIDI7XG4gICAgY29uc3QgY2VudGVyWSA9IHNpemUgLyAyO1xuICAgIGNvbnN0IGxlbmd0aCA9IHNpemUgKiAwLjI7XG5cbiAgICBjdHguc3Ryb2tlU3R5bGUgPSBjb2xvciA9PT0gXCJibHVlXCIgPyBcIiMzYjgyZjZcIiA6IFwiI2VmNDQ0NFwiO1xuICAgIGN0eC5saW5lV2lkdGggPSAzO1xuXG4gICAgLy8gU2ltcGxlIGFycm93IHBvaW50aW5nIHJpZ2h0XG4gICAgY3R4LmJlZ2luUGF0aCgpO1xuICAgIGN0eC5tb3ZlVG8oY2VudGVyWCAtIGxlbmd0aCAvIDIsIGNlbnRlclkpO1xuICAgIGN0eC5saW5lVG8oY2VudGVyWCArIGxlbmd0aCAvIDIsIGNlbnRlclkpO1xuICAgIGN0eC5tb3ZlVG8oY2VudGVyWCArIGxlbmd0aCAvIDIgLSAxMCwgY2VudGVyWSAtIDUpO1xuICAgIGN0eC5saW5lVG8oY2VudGVyWCArIGxlbmd0aCAvIDIsIGNlbnRlclkpO1xuICAgIGN0eC5saW5lVG8oY2VudGVyWCArIGxlbmd0aCAvIDIgLSAxMCwgY2VudGVyWSArIDUpO1xuICAgIGN0eC5zdHJva2UoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEcmF3IGxldHRlciB0ZXh0XG4gICAqL1xuICBwcml2YXRlIGRyYXdMZXR0ZXIoXG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsXG4gICAgbGV0dGVyOiBzdHJpbmcsXG4gICAgc2l6ZTogbnVtYmVyXG4gICk6IHZvaWQge1xuICAgIGN0eC5maWxsU3R5bGUgPSBcIiMzNzQxNTFcIjtcbiAgICBjdHguZm9udCA9IGAke3NpemUgKiAwLjJ9cHggQXJpYWwsIHNhbnMtc2VyaWZgO1xuICAgIGN0eC50ZXh0QWxpZ24gPSBcImNlbnRlclwiO1xuICAgIGN0eC50ZXh0QmFzZWxpbmUgPSBcIm1pZGRsZVwiO1xuICAgIGN0eC5maWxsVGV4dChsZXR0ZXIsIHNpemUgLyAyLCBzaXplIC8gMik7XG4gIH1cblxuICAvKipcbiAgICogRHJhdyBiZWF0IG51bWJlclxuICAgKi9cbiAgcHJpdmF0ZSBkcmF3QmVhdE51bWJlcihcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICBiZWF0TnVtYmVyOiBudW1iZXIsXG4gICAgc2l6ZTogbnVtYmVyXG4gICk6IHZvaWQge1xuICAgIGN0eC5maWxsU3R5bGUgPSBcIiM0YjU1NjNcIjtcbiAgICBjdHguZm9udCA9IGBib2xkICR7c2l6ZSAqIDAuMTV9cHggQXJpYWwsIHNhbnMtc2VyaWZgO1xuICAgIGN0eC50ZXh0QWxpZ24gPSBcImNlbnRlclwiO1xuICAgIGN0eC50ZXh0QmFzZWxpbmUgPSBcInRvcFwiO1xuICAgIGN0eC5maWxsVGV4dChiZWF0TnVtYmVyLnRvU3RyaW5nKCksIHNpemUgLyAyLCBzaXplICogMC4wNSk7XG4gIH1cblxuICAvKipcbiAgICogUmVuZGVyIHN0YXJ0IHBvc2l0aW9uIGxhYmVsXG4gICAqL1xuICBwcml2YXRlIHJlbmRlclN0YXJ0UG9zaXRpb25MYWJlbChcbiAgICBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCxcbiAgICBzaXplOiBudW1iZXJcbiAgKTogdm9pZCB7XG4gICAgY3R4LmZpbGxTdHlsZSA9IFwiIzA1OTY2OVwiO1xuICAgIGN0eC5mb250ID0gYGJvbGQgJHtzaXplICogMC4xMn1weCBBcmlhbCwgc2Fucy1zZXJpZmA7XG4gICAgY3R4LnRleHRBbGlnbiA9IFwiY2VudGVyXCI7XG4gICAgY3R4LnRleHRCYXNlbGluZSA9IFwidG9wXCI7XG4gICAgY3R4LmZpbGxUZXh0KFwiU1RBUlRcIiwgc2l6ZSAvIDIsIHNpemUgKiAwLjA1KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBseSBwb3N0LXByb2Nlc3NpbmcgZWZmZWN0c1xuICAgKi9cbiAgcHJpdmF0ZSBhcHBseVBvc3RQcm9jZXNzaW5nKFxuICAgIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELFxuICAgIGJlYXREYXRhOiBCZWF0RGF0YSxcbiAgICBzaXplOiBudW1iZXIsXG4gICAgb3B0aW9uczogQmVhdFJlbmRlck9wdGlvbnNcbiAgKTogdm9pZCB7XG4gICAgLy8gQXBwbHkgY29tYmluZWQgZ3JpZHMgaWYgZW5hYmxlZFxuICAgIGlmIChvcHRpb25zLmNvbWJpbmVkR3JpZHMpIHtcbiAgICAgIHRoaXMuYXBwbHlDb21iaW5lZEdyaWRzKGN0eCwgc2l6ZSk7XG4gICAgfVxuXG4gICAgLy8gQXBwbHkgcmV2ZXJzYWwgc3ltYm9scyBpZiBuZWVkZWRcbiAgICBpZiAoYmVhdERhdGEuYmx1ZVJldmVyc2FsIHx8IGJlYXREYXRhLnJlZFJldmVyc2FsKSB7XG4gICAgICB0aGlzLmRyYXdSZXZlcnNhbFN5bWJvbHMoY3R4LCBiZWF0RGF0YSwgc2l6ZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEFwcGx5IGNvbWJpbmVkIGdyaWRzIG92ZXJsYXlcbiAgICovXG4gIHByaXZhdGUgYXBwbHlDb21iaW5lZEdyaWRzKFxuICAgIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELFxuICAgIHNpemU6IG51bWJlclxuICApOiB2b2lkIHtcbiAgICAvLyBEcmF3IGJvdGggZGlhbW9uZCBhbmQgYm94IGdyaWRzIHdpdGggc2xpZ2h0IHRyYW5zcGFyZW5jeVxuICAgIGN0eC5nbG9iYWxBbHBoYSA9IDAuNTtcbiAgICB0aGlzLmRyYXdHcmlkKGN0eCwgR3JpZE1vZGUuRElBTU9ORCwgc2l6ZSk7XG4gICAgdGhpcy5kcmF3R3JpZChjdHgsIEdyaWRNb2RlLkJPWCwgc2l6ZSk7XG4gICAgY3R4Lmdsb2JhbEFscGhhID0gMS4wO1xuICB9XG5cbiAgLyoqXG4gICAqIERyYXcgcmV2ZXJzYWwgc3ltYm9sc1xuICAgKi9cbiAgcHJpdmF0ZSBkcmF3UmV2ZXJzYWxTeW1ib2xzKFxuICAgIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELFxuICAgIGJlYXREYXRhOiBCZWF0RGF0YSxcbiAgICBzaXplOiBudW1iZXJcbiAgKTogdm9pZCB7XG4gICAgY29uc3Qgc3ltYm9sU2l6ZSA9IHNpemUgKiAwLjA4O1xuXG4gICAgaWYgKGJlYXREYXRhLmJsdWVSZXZlcnNhbCkge1xuICAgICAgY3R4LmZpbGxTdHlsZSA9IFwiIzNiODJmNlwiO1xuICAgICAgY3R4LmZpbGxSZWN0KHNpemUgLSBzeW1ib2xTaXplIC0gNSwgNSwgc3ltYm9sU2l6ZSwgc3ltYm9sU2l6ZSk7XG4gICAgfVxuXG4gICAgaWYgKGJlYXREYXRhLnJlZFJldmVyc2FsKSB7XG4gICAgICBjdHguZmlsbFN0eWxlID0gXCIjZWY0NDQ0XCI7XG4gICAgICBjdHguZmlsbFJlY3QoXG4gICAgICAgIHNpemUgLSBzeW1ib2xTaXplIC0gNSxcbiAgICAgICAgc3ltYm9sU2l6ZSArIDEwLFxuICAgICAgICBzeW1ib2xTaXplLFxuICAgICAgICBzeW1ib2xTaXplXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBseSBjb2xvciB2aXNpYmlsaXR5IGZpbHRlcnNcbiAgICovXG4gIHByaXZhdGUgYXBwbHlDb2xvckZpbHRlcnMoXG4gICAgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsXG4gICAgd2lkdGg6IG51bWJlcixcbiAgICBoZWlnaHQ6IG51bWJlcixcbiAgICBvcHRpb25zOiBCZWF0UmVuZGVyT3B0aW9uc1xuICApOiB2b2lkIHtcbiAgICBpZiAoIW9wdGlvbnMucmVkVmlzaWJsZSB8fCAhb3B0aW9ucy5ibHVlVmlzaWJsZSkge1xuICAgICAgLy8gVGhpcyBpcyBhIHNpbXBsaWZpZWQgYXBwcm9hY2ggLSBpbiBhIGZ1bGwgaW1wbGVtZW50YXRpb24sXG4gICAgICAvLyB3ZSB3b3VsZCBuZWVkIG1vcmUgc29waGlzdGljYXRlZCBjb2xvciBmaWx0ZXJpbmdcbiAgICAgIGNvbnNvbGUud2FybihcIkNvbG9yIGZpbHRlcmluZyBub3QgZnVsbHkgaW1wbGVtZW50ZWQgeWV0XCIpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDYW52YXMgcG9vbCBtYW5hZ2VtZW50XG4gICAqL1xuICBwcml2YXRlIGdldENhbnZhc0Zyb21Qb29sKHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKTogSFRNTENhbnZhc0VsZW1lbnQge1xuICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuY2FudmFzUG9vbC5wb3AoKSB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpO1xuICAgIGNhbnZhcy53aWR0aCA9IHdpZHRoO1xuICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7XG5cbiAgICAvLyBDbGVhciB0aGUgY2FudmFzXG4gICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKTtcbiAgICBpZiAoIWN0eCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRmFpbGVkIHRvIGdldCAyRCBjb250ZXh0IGZyb20gY2FudmFzXCIpO1xuICAgIH1cbiAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHdpZHRoLCBoZWlnaHQpO1xuXG4gICAgcmV0dXJuIGNhbnZhcztcbiAgfVxuXG4gIHByaXZhdGUgcmV0dXJuQ2FudmFzVG9Qb29sKGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jYW52YXNQb29sLmxlbmd0aCA8IHRoaXMuTUFYX1BPT0xfU0laRSkge1xuICAgICAgdGhpcy5jYW52YXNQb29sLnB1c2goY2FudmFzKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW51cCBtZXRob2QgdG8gZGlzcG9zZSBvZiByZXNvdXJjZXNcbiAgICovXG4gIGRpc3Bvc2UoKTogdm9pZCB7XG4gICAgdGhpcy5jYW52YXNQb29sLmxlbmd0aCA9IDA7XG4gIH1cbn1cbiJdLAogICJtYXBwaW5ncyI6ICJBQWdCQSxTQUFTLGFBQWEsZ0JBQWdCO0FBRy9CLGFBQU0scUJBQXNEO0FBQUEsRUFLakUsWUFBb0IsbUJBQXVDO0FBQXZDO0FBQUEsRUFBd0M7QUFBQTtBQUFBLEVBSHBELGFBQWtDLENBQUM7QUFBQSxFQUMxQixnQkFBZ0I7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBUWpDLE1BQU0sbUJBQ0osVUFDQSxNQUNBLFNBQzRCO0FBQzVCLFFBQUksQ0FBQyxVQUFVO0FBQ2IsWUFBTSxJQUFJLE1BQU0scUNBQXFDO0FBQUEsSUFDdkQ7QUFFQSxRQUFJLFFBQVEsR0FBRztBQUNiLFlBQU0sSUFBSSxNQUFNLGlCQUFpQixJQUFJLEVBQUU7QUFBQSxJQUN6QztBQUVBLFFBQUk7QUFFRixZQUFNLFNBQVMsS0FBSyxrQkFBa0IsTUFBTSxJQUFJO0FBQ2hELFlBQU0sTUFBTSxPQUFPLFdBQVcsSUFBSTtBQUNsQyxVQUFJLENBQUMsS0FBSztBQUNSLGNBQU0sSUFBSSxNQUFNLHNDQUFzQztBQUFBLE1BQ3hEO0FBR0EsVUFBSSxZQUFZO0FBQ2hCLFVBQUksU0FBUyxHQUFHLEdBQUcsTUFBTSxJQUFJO0FBRzdCLFVBQUksU0FBUyxXQUFXLENBQUMsU0FBUyxnQkFBZ0I7QUFDaEQsY0FBTSxLQUFLLGdCQUFnQixLQUFLLFVBQVUsTUFBTSxPQUFPO0FBQ3ZELGVBQU87QUFBQSxNQUNUO0FBR0EsWUFBTSxLQUFLLHlCQUF5QixLQUFLLFVBQVUsTUFBTSxPQUFPO0FBR2hFLFdBQUssb0JBQW9CLEtBQUssVUFBVSxNQUFNLE9BQU87QUFFckQsYUFBTztBQUFBLElBQ1QsU0FBUyxPQUFPO0FBQ2QsWUFBTSxJQUFJO0FBQUEsUUFDUixvQ0FBb0MsaUJBQWlCLFFBQVEsTUFBTSxVQUFVLGVBQWU7QUFBQSxNQUM5RjtBQUFBLElBQ0Y7QUFBQSxFQUNGO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQU1BLE1BQU0sNEJBQ0osVUFDQSxNQUNBLFNBQzRCO0FBQzVCLFFBQUksQ0FBQyxVQUFVO0FBQ2IsWUFBTSxJQUFJLE1BQU0sd0RBQXdEO0FBQUEsSUFDMUU7QUFFQSxRQUFJO0FBQ0YsWUFBTSxTQUFTLEtBQUssa0JBQWtCLE1BQU0sSUFBSTtBQUNoRCxZQUFNLE1BQU0sT0FBTyxXQUFXLElBQUk7QUFDbEMsVUFBSSxDQUFDLEtBQUs7QUFDUixjQUFNLElBQUksTUFBTSxzQ0FBc0M7QUFBQSxNQUN4RDtBQUdBLFVBQUksWUFBWTtBQUNoQixVQUFJLFNBQVMsR0FBRyxHQUFHLE1BQU0sSUFBSTtBQUc3QixVQUFJLFNBQVMsZUFBZTtBQUMxQixjQUFNLEtBQUs7QUFBQSxVQUNUO0FBQUEsVUFDQSxFQUFFLEdBQUcsU0FBUyxlQUFlLFlBQVksRUFBRTtBQUFBLFVBQzNDO0FBQUEsVUFDQTtBQUFBLFFBQ0Y7QUFBQSxNQUNGLE9BQU87QUFFTCxjQUFNLEtBQUssMkJBQTJCLEtBQUssTUFBTSxPQUFPO0FBQUEsTUFDMUQ7QUFHQSxVQUFJLFFBQVEsZ0JBQWdCO0FBQzFCLGFBQUsseUJBQXlCLEtBQUssSUFBSTtBQUFBLE1BQ3pDO0FBRUEsYUFBTztBQUFBLElBQ1QsU0FBUyxPQUFPO0FBQ2QsWUFBTSxJQUFJO0FBQUEsUUFDUixvQ0FBb0MsaUJBQWlCLFFBQVEsTUFBTSxVQUFVLGVBQWU7QUFBQSxNQUM5RjtBQUFBLElBQ0Y7QUFBQSxFQUNGO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQU1BLE1BQU0sc0JBQ0osT0FDQSxNQUNBLFNBQzhCO0FBQzlCLFFBQUksQ0FBQyxTQUFTLE1BQU0sV0FBVyxHQUFHO0FBQ2hDLGFBQU8sQ0FBQztBQUFBLElBQ1Y7QUFFQSxVQUFNLFdBQWdDLENBQUM7QUFFdkMsUUFBSTtBQUVGLFlBQU0sYUFBYTtBQUNuQixlQUFTLElBQUksR0FBRyxJQUFJLE1BQU0sUUFBUSxLQUFLLFlBQVk7QUFDakQsY0FBTSxRQUFRLE1BQU0sTUFBTSxHQUFHLElBQUksVUFBVTtBQUMzQyxjQUFNLGdCQUFnQixNQUFNLFFBQVE7QUFBQSxVQUNsQyxNQUFNLElBQUksQ0FBQyxTQUFTLEtBQUssbUJBQW1CLE1BQU0sTUFBTSxPQUFPLENBQUM7QUFBQSxRQUNsRTtBQUNBLGlCQUFTLEtBQUssR0FBRyxhQUFhO0FBQUEsTUFDaEM7QUFFQSxhQUFPO0FBQUEsSUFDVCxTQUFTLE9BQU87QUFFZCxlQUFTLFFBQVEsQ0FBQyxXQUFXLEtBQUssbUJBQW1CLE1BQU0sQ0FBQztBQUM1RCxZQUFNLElBQUk7QUFBQSxRQUNSLDJCQUEyQixpQkFBaUIsUUFBUSxNQUFNLFVBQVUsZUFBZTtBQUFBLE1BQ3JGO0FBQUEsSUFDRjtBQUFBLEVBQ0Y7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBTUEsd0JBQ0UsUUFDQSxTQUNtQjtBQUNuQixRQUFJLFFBQVEsY0FBYyxRQUFRLGFBQWE7QUFFN0MsYUFBTztBQUFBLElBQ1Q7QUFHQSxVQUFNLGlCQUFpQixLQUFLLGtCQUFrQixPQUFPLE9BQU8sT0FBTyxNQUFNO0FBQ3pFLFVBQU0sY0FBYyxlQUFlLFdBQVcsSUFBSTtBQUNsRCxRQUFJLENBQUMsYUFBYTtBQUNoQixZQUFNLElBQUksTUFBTSwrQ0FBK0M7QUFBQSxJQUNqRTtBQUdBLGdCQUFZLFVBQVUsUUFBUSxHQUFHLENBQUM7QUFHbEMsU0FBSyxrQkFBa0IsYUFBYSxPQUFPLE9BQU8sT0FBTyxRQUFRLE9BQU87QUFHeEUsU0FBSyxtQkFBbUIsTUFBTTtBQUU5QixXQUFPO0FBQUEsRUFDVDtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFNQSxNQUFjLHlCQUNaLEtBQ0EsVUFDQSxNQUNBLFNBQ2U7QUFDZixRQUFJLENBQUMsU0FBUyxnQkFBZ0I7QUFDNUI7QUFBQSxJQUNGO0FBRUEsUUFBSTtBQUVGLFlBQU0sYUFBYSxNQUFNLEtBQUs7QUFBQSxRQUM1QjtBQUFBLFFBQ0E7QUFBQSxRQUNBO0FBQUEsTUFDRjtBQUNBLFVBQUksWUFBWTtBQUNkLGNBQU0sS0FBSyxnQkFBZ0IsS0FBSyxZQUFZLE1BQU0sSUFBSTtBQUN0RDtBQUFBLE1BQ0Y7QUFHQSxZQUFNLEtBQUsseUJBQXlCLEtBQUssVUFBVSxNQUFNLE9BQU87QUFBQSxJQUNsRSxTQUFTLE9BQU87QUFDZCxjQUFRLEtBQUssZ0RBQWdELEtBQUs7QUFDbEUsWUFBTSxLQUFLLG1CQUFtQixLQUFLLFVBQVUsTUFBTSxPQUFPO0FBQUEsSUFDNUQ7QUFBQSxFQUNGO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQU1BLE1BQWMsNEJBQ1osVUFDQSxNQUNBLFVBQzRCO0FBQzVCLFFBQUk7QUFDRixVQUFJLENBQUMsU0FBUyxnQkFBZ0I7QUFDNUIsZUFBTztBQUFBLE1BQ1Q7QUFHQSxZQUFNLGFBQWEsTUFBTSxLQUFLLGtCQUFrQjtBQUFBLFFBQzlDLFNBQVM7QUFBQSxNQUNYO0FBRUEsVUFBSSxZQUFZO0FBRWQsbUJBQVcsYUFBYSxTQUFTLEtBQUssU0FBUyxDQUFDO0FBQ2hELG1CQUFXLGFBQWEsVUFBVSxLQUFLLFNBQVMsQ0FBQztBQUNqRCxtQkFBVyxhQUFhLFdBQVcsT0FBTyxJQUFJLElBQUksSUFBSSxFQUFFO0FBRXhELGVBQU87QUFBQSxNQUNUO0FBRUEsYUFBTztBQUFBLElBQ1QsU0FBUyxPQUFPO0FBQ2QsY0FBUSxLQUFLLGlEQUFpRCxLQUFLO0FBQ25FLGFBQU87QUFBQSxJQUNUO0FBQUEsRUFDRjtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS0EsTUFBYyxnQkFDWixLQUNBLFlBQ0EsT0FDQSxRQUNlO0FBQ2YsV0FBTyxJQUFJLFFBQVEsQ0FBQyxTQUFTLFdBQVc7QUFDdEMsVUFBSTtBQUVGLGNBQU0sVUFBVSxJQUFJLGNBQWMsRUFBRSxrQkFBa0IsVUFBVTtBQUdoRSxjQUFNLE1BQU0sSUFBSSxNQUFNO0FBRXRCLFlBQUksU0FBUyxNQUFNO0FBQ2pCLGNBQUk7QUFDRixnQkFBSSxVQUFVLEtBQUssR0FBRyxHQUFHLE9BQU8sTUFBTTtBQUN0QyxvQkFBUTtBQUFBLFVBQ1YsU0FBUyxPQUFPO0FBQ2QsbUJBQU8sS0FBSztBQUFBLFVBQ2Q7QUFBQSxRQUNGO0FBRUEsWUFBSSxVQUFVLE1BQU07QUFDbEIsaUJBQU8sSUFBSSxNQUFNLDZCQUE2QixDQUFDO0FBQUEsUUFDakQ7QUFHQSxjQUFNLFVBQVUsSUFBSSxLQUFLLENBQUMsT0FBTyxHQUFHO0FBQUEsVUFDbEMsTUFBTTtBQUFBLFFBQ1IsQ0FBQztBQUNELGNBQU0sTUFBTSxJQUFJLGdCQUFnQixPQUFPO0FBRXZDLFlBQUksTUFBTTtBQUdWLFlBQUksU0FBUyxNQUFNO0FBQ2pCLGNBQUk7QUFDRixnQkFBSSxVQUFVLEtBQUssR0FBRyxHQUFHLE9BQU8sTUFBTTtBQUN0QyxnQkFBSSxnQkFBZ0IsR0FBRztBQUN2QixvQkFBUTtBQUFBLFVBQ1YsU0FBUyxPQUFPO0FBQ2QsZ0JBQUksZ0JBQWdCLEdBQUc7QUFDdkIsbUJBQU8sS0FBSztBQUFBLFVBQ2Q7QUFBQSxRQUNGO0FBQUEsTUFDRixTQUFTLE9BQU87QUFDZCxlQUFPLEtBQUs7QUFBQSxNQUNkO0FBQUEsSUFDRixDQUFDO0FBQUEsRUFDSDtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS0EsTUFBYyx5QkFDWixLQUNBLFVBQ0EsTUFDQSxTQUNlO0FBQ2YsVUFBTSxhQUFhLFNBQVM7QUFDNUIsUUFBSSxDQUFDLFlBQVk7QUFDZixZQUFNLElBQUksTUFBTSwyQ0FBMkM7QUFBQSxJQUM3RDtBQUdBLFNBQUssU0FBUyxLQUFLLFdBQVcsVUFBVSxZQUFZLFNBQVMsU0FBUyxJQUFJO0FBRzFFLFFBQUksV0FBVyxPQUFPO0FBQ3BCLFVBQUksUUFBUSxlQUFlLFdBQVcsTUFBTSxNQUFNO0FBQ2hELGFBQUssU0FBUyxLQUFLLFdBQVcsTUFBTSxNQUFNLFFBQVEsSUFBSTtBQUFBLE1BQ3hEO0FBQ0EsVUFBSSxRQUFRLGNBQWMsV0FBVyxNQUFNLEtBQUs7QUFDOUMsYUFBSyxTQUFTLEtBQUssV0FBVyxNQUFNLEtBQUssT0FBTyxJQUFJO0FBQUEsTUFDdEQ7QUFBQSxJQUNGO0FBR0EsUUFBSSxXQUFXLFFBQVE7QUFDckIsVUFBSSxRQUFRLGVBQWUsV0FBVyxPQUFPLE1BQU07QUFDakQsYUFBSyxVQUFVLEtBQUssV0FBVyxPQUFPLE1BQU0sUUFBUSxJQUFJO0FBQUEsTUFDMUQ7QUFDQSxVQUFJLFFBQVEsY0FBYyxXQUFXLE9BQU8sS0FBSztBQUMvQyxhQUFLLFVBQVUsS0FBSyxXQUFXLE9BQU8sS0FBSyxPQUFPLElBQUk7QUFBQSxNQUN4RDtBQUFBLElBQ0Y7QUFHQSxRQUFJLFdBQVcsUUFBUTtBQUNyQixXQUFLLFdBQVcsS0FBSyxXQUFXLFFBQVEsSUFBSTtBQUFBLElBQzlDO0FBQUEsRUFDRjtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS0EsTUFBYyxnQkFDWixLQUNBLFVBQ0EsTUFDQSxTQUNlO0FBRWYsU0FBSyxTQUFTLEtBQUssU0FBUyxTQUFTLElBQUk7QUFHekMsUUFBSSxRQUFRLGtCQUFrQixTQUFTLGFBQWEsR0FBRztBQUNyRCxXQUFLLGVBQWUsS0FBSyxTQUFTLFlBQVksSUFBSTtBQUFBLElBQ3BEO0FBQUEsRUFDRjtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS0EsTUFBYyxtQkFDWixLQUNBLFVBQ0EsTUFDQSxTQUNlO0FBRWYsUUFBSSxjQUFjO0FBQ2xCLFFBQUksWUFBWTtBQUNoQixRQUFJLFdBQVcsSUFBSSxJQUFJLE9BQU8sSUFBSSxPQUFPLEVBQUU7QUFHM0MsUUFBSSxVQUFVO0FBQ2QsUUFBSSxPQUFPLElBQUksRUFBRTtBQUNqQixRQUFJLE9BQU8sT0FBTyxJQUFJLE9BQU8sRUFBRTtBQUMvQixRQUFJLE9BQU8sT0FBTyxJQUFJLEVBQUU7QUFDeEIsUUFBSSxPQUFPLElBQUksT0FBTyxFQUFFO0FBQ3hCLFFBQUksT0FBTztBQUdYLFFBQUksUUFBUSxnQkFBZ0I7QUFDMUIsV0FBSyxlQUFlLEtBQUssU0FBUyxZQUFZLElBQUk7QUFBQSxJQUNwRDtBQUFBLEVBQ0Y7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQUtBLE1BQWMsMkJBQ1osS0FDQSxNQUNBLFVBQ2U7QUFFZixTQUFLLFNBQVMsS0FBSyxTQUFTLFNBQVMsSUFBSTtBQUd6QyxVQUFNLFVBQVUsT0FBTztBQUN2QixVQUFNLFVBQVUsT0FBTztBQUN2QixVQUFNLFNBQVMsT0FBTztBQUV0QixRQUFJLFlBQVk7QUFDaEIsUUFBSSxVQUFVO0FBQ2QsUUFBSSxJQUFJLFNBQVMsU0FBUyxRQUFRLEdBQUcsSUFBSSxLQUFLLEVBQUU7QUFDaEQsUUFBSSxLQUFLO0FBQUEsRUFDWDtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS1EsU0FDTixLQUNBLFVBQ0EsTUFDTTtBQUNOLFFBQUksY0FBYztBQUNsQixRQUFJLFlBQVk7QUFFaEIsUUFBSSxhQUFhLFNBQVMsU0FBUztBQUVqQyxZQUFNLFVBQVUsT0FBTztBQUN2QixZQUFNLFVBQVUsT0FBTztBQUN2QixZQUFNLFNBQVMsT0FBTztBQUV0QixVQUFJLFVBQVU7QUFDZCxVQUFJLE9BQU8sU0FBUyxVQUFVLE1BQU07QUFDcEMsVUFBSSxPQUFPLFVBQVUsUUFBUSxPQUFPO0FBQ3BDLFVBQUksT0FBTyxTQUFTLFVBQVUsTUFBTTtBQUNwQyxVQUFJLE9BQU8sVUFBVSxRQUFRLE9BQU87QUFDcEMsVUFBSSxVQUFVO0FBQ2QsVUFBSSxPQUFPO0FBQUEsSUFDYixPQUFPO0FBRUwsWUFBTSxTQUFTLE9BQU87QUFDdEIsVUFBSSxXQUFXLFFBQVEsUUFBUSxPQUFPLElBQUksUUFBUSxPQUFPLElBQUksTUFBTTtBQUFBLElBQ3JFO0FBQUEsRUFDRjtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS1EsU0FDTixLQUNBLFVBQ0EsT0FDQSxNQUNNO0FBQ04sUUFBSSxDQUFDLFNBQVU7QUFFZixVQUFNLFVBQVUsT0FBTztBQUN2QixVQUFNLFVBQVUsT0FBTztBQUN2QixVQUFNLFNBQVMsT0FBTztBQUV0QixRQUFJLFlBQVksVUFBVSxZQUFZLE9BQU8sWUFBWTtBQUN6RCxRQUFJLFVBQVU7QUFDZCxRQUFJLElBQUksU0FBUyxTQUFTLFFBQVEsR0FBRyxJQUFJLEtBQUssRUFBRTtBQUNoRCxRQUFJLEtBQUs7QUFBQSxFQUNYO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLUSxVQUNOLEtBQ0EsV0FDQSxPQUNBLE1BQ007QUFDTixRQUFJLENBQUMsVUFBVztBQUVoQixVQUFNLFVBQVUsT0FBTztBQUN2QixVQUFNLFVBQVUsT0FBTztBQUN2QixVQUFNLFNBQVMsT0FBTztBQUV0QixRQUFJLGNBQWMsVUFBVSxTQUFTLFlBQVk7QUFDakQsUUFBSSxZQUFZO0FBR2hCLFFBQUksVUFBVTtBQUNkLFFBQUksT0FBTyxVQUFVLFNBQVMsR0FBRyxPQUFPO0FBQ3hDLFFBQUksT0FBTyxVQUFVLFNBQVMsR0FBRyxPQUFPO0FBQ3hDLFFBQUksT0FBTyxVQUFVLFNBQVMsSUFBSSxJQUFJLFVBQVUsQ0FBQztBQUNqRCxRQUFJLE9BQU8sVUFBVSxTQUFTLEdBQUcsT0FBTztBQUN4QyxRQUFJLE9BQU8sVUFBVSxTQUFTLElBQUksSUFBSSxVQUFVLENBQUM7QUFDakQsUUFBSSxPQUFPO0FBQUEsRUFDYjtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS1EsV0FDTixLQUNBLFFBQ0EsTUFDTTtBQUNOLFFBQUksWUFBWTtBQUNoQixRQUFJLE9BQU8sR0FBRyxPQUFPLEdBQUc7QUFDeEIsUUFBSSxZQUFZO0FBQ2hCLFFBQUksZUFBZTtBQUNuQixRQUFJLFNBQVMsUUFBUSxPQUFPLEdBQUcsT0FBTyxDQUFDO0FBQUEsRUFDekM7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQUtRLGVBQ04sS0FDQSxZQUNBLE1BQ007QUFDTixRQUFJLFlBQVk7QUFDaEIsUUFBSSxPQUFPLFFBQVEsT0FBTyxJQUFJO0FBQzlCLFFBQUksWUFBWTtBQUNoQixRQUFJLGVBQWU7QUFDbkIsUUFBSSxTQUFTLFdBQVcsU0FBUyxHQUFHLE9BQU8sR0FBRyxPQUFPLElBQUk7QUFBQSxFQUMzRDtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS1EseUJBQ04sS0FDQSxNQUNNO0FBQ04sUUFBSSxZQUFZO0FBQ2hCLFFBQUksT0FBTyxRQUFRLE9BQU8sSUFBSTtBQUM5QixRQUFJLFlBQVk7QUFDaEIsUUFBSSxlQUFlO0FBQ25CLFFBQUksU0FBUyxTQUFTLE9BQU8sR0FBRyxPQUFPLElBQUk7QUFBQSxFQUM3QztBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS1Esb0JBQ04sS0FDQSxVQUNBLE1BQ0EsU0FDTTtBQUVOLFFBQUksUUFBUSxlQUFlO0FBQ3pCLFdBQUssbUJBQW1CLEtBQUssSUFBSTtBQUFBLElBQ25DO0FBR0EsUUFBSSxTQUFTLGdCQUFnQixTQUFTLGFBQWE7QUFDakQsV0FBSyxvQkFBb0IsS0FBSyxVQUFVLElBQUk7QUFBQSxJQUM5QztBQUFBLEVBQ0Y7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQUtRLG1CQUNOLEtBQ0EsTUFDTTtBQUVOLFFBQUksY0FBYztBQUNsQixTQUFLLFNBQVMsS0FBSyxTQUFTLFNBQVMsSUFBSTtBQUN6QyxTQUFLLFNBQVMsS0FBSyxTQUFTLEtBQUssSUFBSTtBQUNyQyxRQUFJLGNBQWM7QUFBQSxFQUNwQjtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBS1Esb0JBQ04sS0FDQSxVQUNBLE1BQ007QUFDTixVQUFNLGFBQWEsT0FBTztBQUUxQixRQUFJLFNBQVMsY0FBYztBQUN6QixVQUFJLFlBQVk7QUFDaEIsVUFBSSxTQUFTLE9BQU8sYUFBYSxHQUFHLEdBQUcsWUFBWSxVQUFVO0FBQUEsSUFDL0Q7QUFFQSxRQUFJLFNBQVMsYUFBYTtBQUN4QixVQUFJLFlBQVk7QUFDaEIsVUFBSTtBQUFBLFFBQ0YsT0FBTyxhQUFhO0FBQUEsUUFDcEIsYUFBYTtBQUFBLFFBQ2I7QUFBQSxRQUNBO0FBQUEsTUFDRjtBQUFBLElBQ0Y7QUFBQSxFQUNGO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLUSxrQkFDTixLQUNBLE9BQ0EsUUFDQSxTQUNNO0FBQ04sUUFBSSxDQUFDLFFBQVEsY0FBYyxDQUFDLFFBQVEsYUFBYTtBQUcvQyxjQUFRLEtBQUssMkNBQTJDO0FBQUEsSUFDMUQ7QUFBQSxFQUNGO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFLUSxrQkFBa0IsT0FBZSxRQUFtQztBQUMxRSxVQUFNLFNBQVMsS0FBSyxXQUFXLElBQUksS0FBSyxTQUFTLGNBQWMsUUFBUTtBQUN2RSxXQUFPLFFBQVE7QUFDZixXQUFPLFNBQVM7QUFHaEIsVUFBTSxNQUFNLE9BQU8sV0FBVyxJQUFJO0FBQ2xDLFFBQUksQ0FBQyxLQUFLO0FBQ1IsWUFBTSxJQUFJLE1BQU0sc0NBQXNDO0FBQUEsSUFDeEQ7QUFDQSxRQUFJLFVBQVUsR0FBRyxHQUFHLE9BQU8sTUFBTTtBQUVqQyxXQUFPO0FBQUEsRUFDVDtBQUFBLEVBRVEsbUJBQW1CLFFBQWlDO0FBQzFELFFBQUksS0FBSyxXQUFXLFNBQVMsS0FBSyxlQUFlO0FBQy9DLFdBQUssV0FBVyxLQUFLLE1BQU07QUFBQSxJQUM3QjtBQUFBLEVBQ0Y7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQUtBLFVBQWdCO0FBQ2QsU0FBSyxXQUFXLFNBQVM7QUFBQSxFQUMzQjtBQUNGOyIsCiAgIm5hbWVzIjogW10KfQo=
