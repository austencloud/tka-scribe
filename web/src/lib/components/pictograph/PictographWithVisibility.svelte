<!--\nPictographWithVisibility.svelte - Enhanced Pictograph with Visibility Controls\n\nExtends the basic Pictograph component with sophisticated visibility controls\nmatching the legacy desktop app's behavior.\n-->\n<script lang=\"ts\">\n  import type { BeatData, PictographData } from \"$lib/domain\";\n  import { getVisibilityStateManager } from \"$lib/services/implementations/VisibilityStateManager\";\n  import { onMount } from \"svelte\";\n  import Pictograph from \"./Pictograph.svelte\";\n\n  interface Props {\n    /** Pictograph data to render */\n    pictographData?: PictographData | null;\n    /** Beat data (alternative to pictographData) */\n    beatData?: BeatData | null;\n    /** Click handler */\n    onClick?: () => void;\n    /** Debug mode */\n    debug?: boolean;\n    /** Animation duration for transitions */\n    animationDuration?: number;\n    /** Show loading indicator */\n    showLoadingIndicator?: boolean;\n    /** Beat number for display */\n    beatNumber?: number | null;\n    /** Is this a start position? */\n    isStartPosition?: boolean;\n    /** SVG dimensions */\n    width?: number;\n    height?: number;\n    /** Enable visibility controls (default: true) */\n    enableVisibility?: boolean;\n    /** Force show all elements (for visibility preview) */\n    forceShowAll?: boolean;\n  }\n\n  let {\n    pictographData = null,\n    beatData = null,\n    onClick,\n    debug = false,\n    beatNumber = null,\n    isStartPosition = false,\n    width = undefined,\n    height = undefined,\n    enableVisibility = true,\n    forceShowAll = false,\n  }: Props = $props();\n\n  // Visibility state manager\n  let visibilityManager = getVisibilityStateManager();\n  let visibilityUpdateCount = $state(0);\n\n  // Force re-render when visibility changes\n  function handleVisibilityChange() {\n    visibilityUpdateCount++;\n  }\n\n  onMount(() => {\n    if (enableVisibility) {\n      visibilityManager.registerObserver(handleVisibilityChange);\n      \n      return () => {\n        visibilityManager.unregisterObserver(handleVisibilityChange);\n      };\n    }\n  });\n\n  // Derived state - get effective pictograph data with visibility applied\n  const effectivePictographData = $derived(() => {\n    // Force reactivity by accessing visibilityUpdateCount\n    visibilityUpdateCount;\n    \n    const originalData = pictographData || beatData?.pictograph_data;\n    if (!originalData || !enableVisibility || forceShowAll) {\n      return originalData;\n    }\n\n    // Apply visibility filters\n    const filteredData = { ...originalData };\n\n    // Filter arrows based on motion visibility\n    if (filteredData.arrows) {\n      const newArrows: Record<string, any> = {};\n      \n      Object.entries(filteredData.arrows).forEach(([color, arrowData]) => {\n        if (arrowData && visibilityManager.getMotionVisibility(color as \"red\" | \"blue\")) {\n          newArrows[color] = arrowData;\n        }\n      });\n      \n      filteredData.arrows = newArrows;\n    }\n\n    // Filter props based on motion visibility\n    if (filteredData.props) {\n      const newProps: Record<string, any> = {};\n      \n      Object.entries(filteredData.props).forEach(([color, propData]) => {\n        if (propData && visibilityManager.getMotionVisibility(color as \"red\" | \"blue\")) {\n          newProps[color] = propData;\n        }\n      });\n      \n      filteredData.props = newProps;\n    }\n\n    // Filter letter based on TKA visibility\n    if (!visibilityManager.getGlyphVisibility(\"TKA\")) {\n      filteredData.letter = null;\n    }\n\n    return filteredData;\n  });\n\n  // Derived state - should show reversal indicators\n  const showReversals = $derived(() => {\n    if (!enableVisibility || forceShowAll) return true;\n    return visibilityManager.getGlyphVisibility(\"Reversals\");\n  });\n\n  // Derived state - should show positions\n  const showPositions = $derived(() => {\n    if (!enableVisibility || forceShowAll) return true;\n    return visibilityManager.getGlyphVisibility(\"Positions\");\n  });\n\n  // Derived state - should show VTG notation\n  const showVTG = $derived(() => {\n    if (!enableVisibility || forceShowAll) return true;\n    return visibilityManager.getGlyphVisibility(\"VTG\");\n  });\n\n  // Derived state - should show elemental notation\n  const showElemental = $derived(() => {\n    if (!enableVisibility || forceShowAll) return true;\n    return visibilityManager.getGlyphVisibility(\"Elemental\");\n  });\n\n  // Derived state - should show non-radial points\n  const showNonRadialPoints = $derived(() => {\n    if (!enableVisibility || forceShowAll) return true;\n    return visibilityManager.getNonRadialVisibility();\n  });\n</script>\n\n<!-- Enhanced Pictograph with Visibility Controls -->\n<div \n  class=\"pictograph-with-visibility\"\n  class:debug-mode={debug}\n  class:visibility-enabled={enableVisibility}\n  class:force-show-all={forceShowAll}\n>\n  <!-- Base Pictograph Component -->\n  <Pictograph\n    pictographData={effectivePictographData()}\n    {beatData}\n    {onClick}\n    {debug}\n    {beatNumber}\n    {isStartPosition}\n    {width}\n    {height}\n  />\n  \n  <!-- Visibility Indicators Overlay (for debugging) -->\n  {#if debug && enableVisibility}\n    <div class=\"visibility-debug-overlay\">\n      <div class=\"debug-info\">\n        <div class=\"debug-title\">Visibility State</div>\n        \n        <div class=\"debug-section\">\n          <div class=\"debug-label\">Motions:</div>\n          <div class=\"debug-value\">\n            Red: {visibilityManager.getMotionVisibility(\"red\") ? \"✓\" : \"✗\"}\n            Blue: {visibilityManager.getMotionVisibility(\"blue\") ? \"✓\" : \"✗\"}\n          </div>\n        </div>\n        \n        <div class=\"debug-section\">\n          <div class=\"debug-label\">Glyphs:</div>\n          <div class=\"debug-value\">\n            TKA: {visibilityManager.getGlyphVisibility(\"TKA\") ? \"✓\" : \"✗\"}\n            Rev: {visibilityManager.getGlyphVisibility(\"Reversals\") ? \"✓\" : \"✗\"}\n          </div>\n        </div>\n        \n        <div class=\"debug-section\">\n          <div class=\"debug-label\">Dependent:</div>\n          <div class=\"debug-value\">\n            Available: {visibilityManager.areAllMotionsVisible() ? \"YES\" : \"NO\"}\n          </div>\n        </div>\n      </div>\n    </div>\n  {/if}\n</div>\n\n<style>\n  .pictograph-with-visibility {\n    position: relative;\n    width: 100%;\n    height: 100%;\n  }\n  \n  .visibility-debug-overlay {\n    position: absolute;\n    top: 10px;\n    right: 10px;\n    background: rgba(0, 0, 0, 0.8);\n    color: white;\n    padding: 8px;\n    border-radius: 4px;\n    font-family: monospace;\n    font-size: 10px;\n    min-width: 150px;\n    z-index: 1000;\n  }\n  \n  .debug-title {\n    font-weight: bold;\n    margin-bottom: 6px;\n    border-bottom: 1px solid rgba(255, 255, 255, 0.3);\n    padding-bottom: 2px;\n  }\n  \n  .debug-section {\n    margin-bottom: 4px;\n  }\n  \n  .debug-label {\n    font-size: 9px;\n    opacity: 0.8;\n    margin-bottom: 1px;\n  }\n  \n  .debug-value {\n    font-size: 10px;\n    margin-left: 8px;\n  }\n  \n  /* Only show debug overlay in debug mode */\n  .pictograph-with-visibility:not(.debug-mode) .visibility-debug-overlay {\n    display: none;\n  }\n</style>"