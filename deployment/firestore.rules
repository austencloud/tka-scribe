rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user owns the document (based on userId field)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if the incoming data has the correct userId
    function hasValidUserId() {
      return isAuthenticated()
        && request.resource.data.userId == request.auth.uid;
    }

    // Check if user is an admin (supports both old isAdmin boolean and new role field)
    function isAdmin() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return isAuthenticated()
        && (userData.role == 'admin' || userData.isAdmin == true);
    }

    // Check if user is at least tester level
    function isTester() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return isAuthenticated()
        && (userData.role == 'admin' || userData.role == 'tester' || userData.isAdmin == true);
    }

    // Check if user is at least premium level
    function isPremium() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return isAuthenticated()
        && (userData.role == 'admin' || userData.role == 'tester' || userData.role == 'premium' || userData.isAdmin == true);
    }

    // ============================================================================
    // CONFIG COLLECTIONS
    // ============================================================================

    // Feature flags configuration - readable by all authenticated users, writable by admins only
    match /config/featureFlags {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ============================================================================
    // GAMIFICATION COLLECTIONS (Root Level)
    // ============================================================================

    // User Achievements - users can read/write their own achievements
    // SECURITY: userId field is required - no fallback for missing field
    match /userAchievements/{achievementId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if hasValidUserId();
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // User XP - users can read/write their own XP data
    // SECURITY: userId field is required - no fallback for missing field
    match /userXP/{xpId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if hasValidUserId();
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // XP Events - append-only log, users can only create events for themselves
    // SECURITY: userId field is required on create
    match /xpEvents/{eventId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if hasValidUserId();
      allow update, delete: if false; // Events are immutable
    }

    // Daily Challenges - global data, read-only for users (admin can write)
    match /dailyChallenges/{challengeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin(); // Only admin can create/update/delete challenges
    }

    // Weekly Challenges - global data, read-only for users (admin can write)
    match /weeklyChallenges/{challengeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Skill Progressions - global skill definitions (admin can write)
    match /skillProgressions/{skillId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Train Challenges - global training challenges (admin can write)
    match /trainChallenges/{challengeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Announcements - read by authenticated users, write by admins
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // User Challenge Progress - users can read/write their own progress
    // SECURITY: userId field is required - no fallback for missing field
    match /userChallengeProgress/{progressId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if hasValidUserId();
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // User Streaks - users can read/write their own streak data
    // SECURITY: userId field is required - no fallback for missing field
    match /userStreaks/{streakId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if hasValidUserId();
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // Achievement Notifications - users can only read/write their own notifications
    // SECURITY: userId field is required - no fallback for missing field
    match /achievementNotifications/{notificationId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if hasValidUserId();
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // ============================================================================
    // USER DATA COLLECTIONS
    // ============================================================================

    // -------------------------------------------------------------------------
    // INTENTIONAL PUBLIC READ ACCESS
    // -------------------------------------------------------------------------
    // The following collections use `allow read: if true` BY DESIGN.
    // This is NOT a security vulnerability - it's required for:
    //
    // 1. /users/{userId} - Public user profiles
    //    - Enables: Creator profiles, leaderboards, social features
    //    - Contains: Display name, avatar, public stats (XP, level, sequence count)
    //    - Sensitive data (email, settings) stored in protected subcollections
    //
    // 2. /users/{userId}/collections - Public collections
    //    - Enables: Sharing curated sequence collections
    //    - Privacy: isPublic flag controls visibility in UI
    //
    // 3. /users/{userId}/collections/{}/sequences - Sequences in collections
    //    - Enables: Viewing sequences in shared collections
    //    - Privacy: visibility field ("public"/"private") controls UI access
    //
    // 4. /sequences - Public sequences index
    //    - Enables: Discover page, search, gallery browsing
    //    - Only contains sequences users explicitly published
    //
    // 5. /collections - Public collections index
    //    - Enables: Browsing shared collections
    //
    // 6. /products - Subscription products catalog
    //    - Enables: Displaying pricing before auth
    //
    // SECURITY MODEL: Data separation, not access restriction
    // - Public data is stored in these public-readable collections
    // - Private data (messages, settings, drafts) uses auth-gated rules
    // -------------------------------------------------------------------------

    // User profiles - PUBLIC browsing allowed for everyone (even unauthenticated)
    // Users can only edit their own profile data
    match /users/{userId} {
      // ANYONE can read public profile data (no authentication required)
      // See above documentation for security rationale
      allow read: if true;

      // Users can only update their own profile
      allow create: if isOwner(userId);

      // Allow updates for:
      // 1. Owner updating their own profile
      // 2. Authenticated users incrementing/decrementing followerCount (for follow/unfollow)
      allow update: if isOwner(userId)
        || (isAuthenticated()
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followerCount'])
            && request.resource.data.followerCount == resource.data.followerCount + 1)
        || (isAuthenticated()
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followerCount'])
            && request.resource.data.followerCount == resource.data.followerCount - 1);

      // Users can delete their own profile, admins can delete any user (for testing)
      allow delete: if isOwner(userId) || isAdmin();

      // -------------------------------------------------------------------------
      // USER SETTINGS (Private - admin can read for impersonation preview)
      // -------------------------------------------------------------------------
      match /settings/{settingId} {
        // Admins can read any user's settings for impersonation/preview mode
        allow read: if isOwner(userId) || isAdmin();
        // Only the owner can write their own settings, admins can delete
        allow create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // -------------------------------------------------------------------------
      // USER TAGS (Private)
      // -------------------------------------------------------------------------
      match /tags/{tagId} {
        allow read, create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // -------------------------------------------------------------------------
      // USER GAMIFICATION SUBCOLLECTIONS (Private - admin can read for preview)
      // -------------------------------------------------------------------------

      // User achievements - PUBLIC read for creator profiles in Discover
      match /achievements/{achievementId} {
        // Anyone can read achievements (for viewing creator profiles)
        // Only owner can write, admins can delete
        allow read: if true;
        allow create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // User XP (single document or subcollection)
      match /xp/{xpId} {
        allow read, create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // XP events log (append-only for users, admins can delete for cleanup)
      match /xpEvents/{eventId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if false; // Events are immutable
        allow delete: if isAdmin(); // Admins can clean up
      }

      // Challenge progress
      match /challengeProgress/{progressId} {
        allow read, create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // User streak (single document or subcollection)
      match /streak/{streakId} {
        allow read, create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // User notifications
      match /notifications/{notificationId} {
        // Admins can read for impersonation/preview mode
        allow read: if isOwner(userId) || isAdmin();
        allow create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // Dismissed announcements - users can read/write their own dismissals
      match /dismissedAnnouncements/{announcementId} {
        allow read, create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // Create module sessions - users can read/write their own sessions
      match /sessions/{sessionId} {
        allow read, create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // -------------------------------------------------------------------------
      // ONBOARDING STATUS
      // -------------------------------------------------------------------------
      match /onboarding/{docId} {
        allow read, create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // -------------------------------------------------------------------------
      // SEQUENCE DRAFTS (Autosave)
      // -------------------------------------------------------------------------
      match /drafts/{draftId} {
        allow read, create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // -------------------------------------------------------------------------
      // SOCIAL SUBCOLLECTIONS (Following/Followers)
      // -------------------------------------------------------------------------
      // Users can read anyone's following/followers lists (public social graph)
      // Users can only write to their own following list

      // Following list - who this user follows
      match /following/{followedUserId} {
        // Anyone can read follow relationships (for "is following" checks)
        allow read: if isAuthenticated();
        // Only the owner can add/remove follows, admins can delete
        allow create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // Followers list - who follows this user
      match /followers/{followerUserId} {
        // Anyone can read follower lists
        allow read: if isAuthenticated();
        // Written via transaction when someone follows/unfollows
        // The follower (followerUserId) writes to the target user's followers list
        allow create: if isAuthenticated() && request.auth.uid == followerUserId;
        allow update: if false; // No updates needed
        allow delete: if (isAuthenticated() && request.auth.uid == followerUserId) || isAdmin();
      }

      // -------------------------------------------------------------------------
      // USER LIBRARY (Sequences)
      // -------------------------------------------------------------------------
      // Public sequences are readable by anyone, private only by owner

      match /sequences/{sequenceId} {
        // Public sequences can be read by anyone, private only by owner
        allow read: if resource.data.visibility == 'public' || isOwner(userId);
        // Only owner can create/update, admins can delete
        allow create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // Weekly challenge progress
      match /weeklyProgress/{progressId} {
        allow read, create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // Skill progression tracking
      match /skillProgress/{progressId} {
        allow read, create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }

      // Train challenge progress
      match /trainProgress/{progressId} {
        allow read, create, update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }
    }

    // ============================================================================
    // COLLECTIONS - User Collections for sequences, beats, etc.
    // ============================================================================

    // User Collections - PUBLIC browsing allowed for everyone
    match /users/{userId}/collections/{collectionId} {
      // ANYONE can read public collections (no authentication required)
      allow read: if true;

      // Only the owner can create/update/delete their collections
      allow create, update, delete: if isOwner(userId);
    }

    // Sequences within collections
    match /users/{userId}/collections/{collectionId}/sequences/{sequenceId} {
      // ANYONE can read public sequences (no authentication required)
      allow read: if true;

      // Only the owner can create/update/delete their sequences
      allow create, update, delete: if isOwner(userId);
    }

    // User-created sequences (if stored at root level)
    match /sequences/{sequenceId} {
      // ANYONE can read public sequences (no authentication required)
      allow read: if true;

      // Only the creator can modify their sequences
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // User collections metadata (if stored at root level)
    match /collections/{collectionId} {
      // ANYONE can read public collections (no authentication required)
      allow read: if true;

      // Only the creator can modify their collections
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // ============================================================================
    // MESSAGING COLLECTIONS
    // ============================================================================

    // Check if user is a participant in a conversation (or admin for preview mode)
    function isConversationParticipant(conversationId) {
      let conv = get(/databases/$(database)/documents/conversations/$(conversationId)).data;
      return isAuthenticated() && (request.auth.uid in conv.participants || isAdmin());
    }

    // Conversations - only participants can read/write
    // Admins can read any conversation for impersonation/preview mode
    match /conversations/{conversationId} {
      // Participants can read their conversations, admins can read any (for preview mode)
      allow read: if isAuthenticated()
        && (request.auth.uid in resource.data.participants || isAdmin());

      // Creating a conversation - user must be in participants list
      allow create: if isAuthenticated()
        && request.auth.uid in request.resource.data.participants
        && request.resource.data.participants.size() == 2;

      // Updating - only participants can update (for unread counts, lastMessage, etc.)
      allow update: if isAuthenticated()
        && request.auth.uid in resource.data.participants;

      // No deleting conversations (soft delete via flag if needed)
      allow delete: if false;

      // Messages subcollection - only participants can read/write
      match /messages/{messageId} {
        // Only participants of parent conversation can read messages
        allow read: if isConversationParticipant(conversationId);

        // Creating messages - must be sender and a participant
        allow create: if isConversationParticipant(conversationId)
          && request.resource.data.senderId == request.auth.uid;

        // Updating messages - only sender can edit (for edit/delete)
        allow update: if isConversationParticipant(conversationId)
          && resource.data.senderId == request.auth.uid;

        // No hard deleting messages (soft delete via isDeleted flag)
        allow delete: if false;
      }
    }

    // ============================================================================
    // STRIPE SUBSCRIPTION COLLECTIONS
    // Firebase Stripe Extension manages these collections
    // ============================================================================

    // Customer data - managed by Stripe extension
    match /customers/{uid} {
      // Users can only read their own customer data
      allow read: if isOwner(uid);
      // Extension writes this data via admin SDK (no client writes)
      allow write: if false;

      // Checkout sessions - created by client, processed by extension
      match /checkout_sessions/{sessionId} {
        allow read: if isOwner(uid);
        allow create: if isOwner(uid);
        allow update, delete: if false;
      }

      // Subscriptions - managed by extension webhooks
      match /subscriptions/{subscriptionId} {
        allow read: if isOwner(uid);
        allow write: if false;
      }

      // Payment methods - managed by extension
      match /payments/{paymentId} {
        allow read: if isOwner(uid);
        allow write: if false;
      }
    }

    // Products catalog - public read, admin write
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();

      // Price tiers for each product
      match /prices/{priceId} {
        allow read: if true;
        allow write: if isAdmin();
      }
    }

    // ============================================================================
    // PRESENCE TRACKING
    // ============================================================================

    // Presence collection - tracks user online status
    match /presence/{userId} {
      // Anyone authenticated can read presence (for showing online status)
      allow read: if isAuthenticated();
      // Users can write their own presence
      allow create, update: if isOwner(userId);
      // Users can delete their own, admins can delete any (for user cleanup)
      allow delete: if isOwner(userId) || isAdmin();
    }

    // ============================================================================
    // ACTIVITY LOGGING
    // ============================================================================

    // Activity log - users can read their own, admins can read all
    // Events are append-only (no update/delete by users, admins can delete for cleanup)
    match /users/{userId}/activityLog/{eventId} {
      // Users can read their own activity, admins can read anyone's
      allow read: if isOwner(userId) || isAdmin();

      // Only the owner can create events in their own log
      allow create: if isOwner(userId);

      // Events are immutable for users, but admins can delete for cleanup
      allow update: if false;
      allow delete: if isAdmin();
    }

    // ============================================================================
    // VERSIONS COLLECTION (Release Management)
    // ============================================================================

    // App versions - testers/admins can read, only admins can write
    match /versions/{versionId} {
      allow read: if isTester();
      allow write: if isAdmin();
    }

    // ============================================================================
    // FEEDBACK COLLECTION
    // ============================================================================

    // Feedback items - users can submit and read their own, testers/admins can manage all
    match /feedback/{feedbackId} {
      // Users can read their own feedback, testers/admins can read all
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isTester());

      // Any authenticated user can submit feedback (must set their own userId)
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      // Only testers/admins can update feedback (status changes, admin notes, etc.)
      allow update: if isTester();

      // Only admins can delete feedback
      allow delete: if isAdmin();

      // Subtasks subcollection
      match /subtasks/{subtaskId} {
        allow read: if isTester();
        allow write: if isTester();
      }
    }

    // ============================================================================
    // COLLABORATIVE VIDEOS
    // ============================================================================

    // Videos collection - for collaborative video uploads
    // Note: Public videos are readable by all authenticated users to support
    // browsing and discovery. Private video access requires collaborator status.
    match /videos/{videoId} {
      // Authenticated users can read any video
      // Privacy is enforced at query level (filter by visibility/collaboratorIds)
      allow read: if isAuthenticated();

      // Only creator can create
      allow create: if isAuthenticated()
        && request.resource.data.creatorId == request.auth.uid;

      // Creator can update, collaborators can update limited fields
      allow update: if isAuthenticated()
        && (resource.data.creatorId == request.auth.uid
            || request.auth.uid in resource.data.collaboratorIds);

      // Only creator can delete
      allow delete: if isAuthenticated()
        && resource.data.creatorId == request.auth.uid;
    }

    // ============================================================================
    // PUBLIC SEQUENCES INDEX
    // ============================================================================

    // Public sequences - denormalized for Discover page browsing
    match /publicSequences/{sequenceId} {
      // ANYONE can read public sequences (no authentication required)
      // See documentation at top of file for security rationale
      allow read: if true;

      // Only the owner can write (via sync from their private library)
      allow create, update: if isAuthenticated()
        && request.resource.data.ownerId == request.auth.uid;
      allow delete: if isAuthenticated()
        && resource.data.ownerId == request.auth.uid;
    }

    // ============================================================================
    // EXPLICIT DENY FOR UNMATCHED PATHS
    // Any collection not explicitly defined above is denied by default
    // ============================================================================

    // Firestore denies by default, but we make it explicit for clarity
    // If you need a new collection, add explicit rules above this comment
  }
}
