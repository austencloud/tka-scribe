<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Single Pictograph Test</title>
    <style>
      body {
        margin: 20px;
        font-family: Arial, sans-serif;
        background: #1a1a1a;
        color: white;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        background: #2a2a2a;
        border-radius: 8px;
      }
      h2 {
        margin-top: 0;
        color: #4caf50;
      }
      #svgContainer {
        background: white;
        padding: 20px;
        border-radius: 4px;
        display: inline-block;
      }
      canvas {
        border: 2px solid #4caf50;
        background: white;
        margin: 10px 0;
      }
      .info {
        background: #333;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        margin: 10px 0;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
      }
      button:hover {
        background: #45a049;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üî¨ Single Pictograph Rendering Test</h1>
      <p>
        Simple test to verify pictograph can render correctly as a standalone
        image.
      </p>

      <div class="test-section">
        <h2>Step 1: SVG Source</h2>
        <div id="svgContainer">
          <!-- SVG will be inserted here -->
        </div>
        <div class="info" id="svgInfo">Loading SVG...</div>
      </div>

      <div class="test-section">
        <h2>Step 2: Canvas Rendering</h2>
        <button onclick="renderToCanvas(950)">Render at 952px (Native)</button>
        <button onclick="renderToCanvas(475)">Render at 475px (50%)</button>
        <button onclick="renderToCanvas(300)">Render at 300px</button>
        <button onclick="renderToCanvas(120)">Render at 120px</button>
        <div id="canvasContainer"></div>
        <div class="info" id="canvasInfo">Click a button to render</div>
      </div>

      <div class="test-section">
        <h2>Step 3: Download Test</h2>
        <button onclick="downloadCanvasImage()">
          üíæ Download Current Canvas
        </button>
        <div class="info" id="downloadInfo">
          Render a canvas first, then download
        </div>
      </div>
    </div>

    <script>
      let currentCanvas = null;
      let svgElement = null;

      // Sample pictograph data - simple static position
      const samplePictograph = {
        id: "test-pictograph",
        blueMotion: {
          motionType: "static",
          startLoc: "n",
          endLoc: "n",
          propRotDir: "cw",
          startOriType: "in",
          endOriType: "in",
        },
        redMotion: {
          motionType: "static",
          startLoc: "s",
          endLoc: "s",
          propRotDir: "cw",
          startOriType: "in",
          endOriType: "in",
        },
        gridMode: "diamond",
        propType: "staff",
      };

      async function loadSVG() {
        try {
          // In real app, this would come from Pictograph.svelte
          // For now, create a minimal test SVG
          const svg = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "svg"
          );
          svg.setAttribute("viewBox", "0 0 950 950");
          svg.setAttribute("width", "950");
          svg.setAttribute("height", "950");

          // Add a simple test pattern
          const rect = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "rect"
          );
          rect.setAttribute("x", "0");
          rect.setAttribute("y", "0");
          rect.setAttribute("width", "950");
          rect.setAttribute("height", "950");
          rect.setAttribute("fill", "white");
          rect.setAttribute("stroke", "red");
          rect.setAttribute("stroke-width", "5");
          svg.appendChild(rect);

          // Add blue circle at top (to test if top gets clipped)
          const blueCircle = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "circle"
          );
          blueCircle.setAttribute("cx", "475");
          blueCircle.setAttribute("cy", "50");
          blueCircle.setAttribute("r", "40");
          blueCircle.setAttribute("fill", "blue");
          svg.appendChild(blueCircle);

          // Add red circle at bottom-right (THIS is what gets clipped!)
          const redCircle = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "circle"
          );
          redCircle.setAttribute("cx", "900");
          redCircle.setAttribute("cy", "900");
          redCircle.setAttribute("r", "40");
          redCircle.setAttribute("fill", "red");
          svg.appendChild(redCircle);

          // Add arrow pointing to bottom-right corner
          const arrow = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "path"
          );
          arrow.setAttribute(
            "d",
            "M 850 850 L 940 940 M 940 940 L 920 935 M 940 940 L 935 920"
          );
          arrow.setAttribute("stroke", "green");
          arrow.setAttribute("stroke-width", "10");
          arrow.setAttribute("fill", "none");
          svg.appendChild(arrow);

          // Add text labels at corners
          const addText = (text, x, y) => {
            const textEl = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "text"
            );
            textEl.setAttribute("x", x);
            textEl.setAttribute("y", y);
            textEl.setAttribute("font-size", "30");
            textEl.setAttribute("fill", "black");
            textEl.textContent = text;
            svg.appendChild(textEl);
          };

          addText("TOP-LEFT", 10, 30);
          addText("TOP-RIGHT", 800, 30);
          addText("BOTTOM-LEFT", 10, 940);
          addText("BOTTOM-RIGHT", 750, 940);

          svgElement = svg;
          document.getElementById("svgContainer").appendChild(svg);

          const bbox = svg.getBBox();
          document.getElementById("svgInfo").innerHTML = `
                    <strong>SVG Loaded</strong><br>
                    ViewBox: ${svg.getAttribute("viewBox")}<br>
                    BBox: x=${bbox.x}, y=${bbox.y}, width=${bbox.width}, height=${bbox.height}<br>
                    Actual Bounds: right=${bbox.x + bbox.width}, bottom=${bbox.y + bbox.height}
                `;
        } catch (error) {
          document.getElementById("svgInfo").innerHTML =
            `<strong>Error:</strong> ${error.message}`;
        }
      }

      async function renderToCanvas(size) {
        if (!svgElement) {
          alert("SVG not loaded yet!");
          return;
        }

        try {
          // Create canvas
          const canvas = document.createElement("canvas");
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext("2d");

          // Fill white background
          ctx.fillStyle = "white";
          ctx.fillRect(0, 0, size, size);

          // Convert SVG to data URL
          const svgString = new XMLSerializer().serializeToString(svgElement);
          const svgBlob = new Blob([svgString], {
            type: "image/svg+xml;charset=utf-8",
          });
          const url = URL.createObjectURL(svgBlob);

          // Create image and draw to canvas
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0, size, size);
            URL.revokeObjectURL(url);

            // Display canvas
            const container = document.getElementById("canvasContainer");
            container.innerHTML = "";
            container.appendChild(canvas);
            currentCanvas = canvas;

            document.getElementById("canvasInfo").innerHTML = `
                        <strong>Canvas Rendered</strong><br>
                        Size: ${size}x${size}px<br>
                        Scale Factor: ${(size / 950).toFixed(3)} (${((size / 950) * 100).toFixed(1)}%)<br>
                        <span style="color: ${size === 950 ? "#4CAF50" : size >= 475 ? "#FFA500" : "#FF5722"}">
                            ${
                              size === 950
                                ? "‚úÖ 1:1 Scale - No downscaling"
                                : size >= 475
                                  ? "‚ö†Ô∏è Moderate scaling"
                                  : "‚ùå Significant downscaling"
                            }
                        </span>
                    `;
          };
          img.onerror = (err) => {
            document.getElementById("canvasInfo").innerHTML =
              `<strong>Error:</strong> Failed to load image`;
          };
          img.src = url;
        } catch (error) {
          document.getElementById("canvasInfo").innerHTML =
            `<strong>Error:</strong> ${error.message}`;
        }
      }

      function downloadCanvasImage() {
        if (!currentCanvas) {
          alert("Please render to canvas first!");
          return;
        }

        try {
          currentCanvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `test-pictograph-${currentCanvas.width}px.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            document.getElementById("downloadInfo").innerHTML = `
                        <strong>Downloaded:</strong> test-pictograph-${currentCanvas.width}px.png<br>
                        <span style="color: #4CAF50">Check your downloads folder!</span>
                    `;
          }, "image/png");
        } catch (error) {
          document.getElementById("downloadInfo").innerHTML =
            `<strong>Error:</strong> ${error.message}`;
        }
      }

      // Load SVG on page load
      window.addEventListener("DOMContentLoaded", loadSVG);
    </script>
  </body>
</html>
